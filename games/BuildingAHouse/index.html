<!DOCTYPE html>

<html lang="en-us">

<meta charset="utf-8"/>
<meta http-equiv="Content-Type" content="text/html; charset=utf-8"/>
<title>Match 3</title>
<link rel="shortcut icon" href="TemplateData/favicon.ico"/>
<link rel="stylesheet" href="TemplateData/style.css"/>
<script type="text/javascript" src="./Web Audio Plugin/howler.min.js"></script>
<script type="text/javascript" src="./Web Audio Plugin/WebAudio.js"></script>
<script src="./sdk.js"></script>
<script src="./games/sdk/v2"></script>
<style>
      /* Убираем выделение по нажатию клавиш */
      canvas:focus {
        outline: none;
      }
      html, body {
        /* Убираем отступы */
        padding: 0;
        margin: 0;

        /* Отключаем скролл и лонгтап на IOS */
        overflow: hidden;
        -webkit-touch-callout:none;
        -webkit-user-select:none;
        -khtml-user-select:none;
        -moz-user-select:none;
        -ms-user-select:none;
        user-select:none;
        -webkit-tap-highlight-color:rgba(0,0,0,0);

        /* Ставим высоту на 100% */
        height: 100%;
      }
    </style>
</head>
<body>
<div id="unity-container" style="position: absolute; width: 100%; height: 100%; left: 0%;  top: 0%;">
<canvas id="unity-canvas" style="position: absolute; width: 100%; height: 100%"></canvas>
<div id="unity-loading-bar">
<div id="unity-logo"></div>
<div id="unity-progress-bar-empty">
<div id="unity-progress-bar-full"></div>
</div>
</div>
<div id="unity-warning"> </div>
</div>
<script>

      var container = document.querySelector("#unity-container");
      var canvas = document.querySelector("#unity-canvas");
      var loadingBar = document.querySelector("#unity-loading-bar");
      var progressBarFull = document.querySelector("#unity-progress-bar-full");
      var fullscreenButton = document.querySelector("#unity-fullscreen-button");
      var warningBanner = document.querySelector("#unity-warning");

      // Shows a temporary message banner/ribbon for a few seconds, or
      // a permanent error message on top of the canvas if type=='error'.
      // If type=='warning', a yellow highlight color is used.
      // Modify or remove this function to customize the visually presented
      // way that non-critical warnings and error messages are presented to the
      // user.
      function unityShowBanner(msg, type) {
        function updateBannerVisibility() {
          warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
        }
        var div = document.createElement('div');
        div.innerHTML = msg;
        warningBanner.appendChild(div);
        if (type == 'error') div.style = 'background: red; padding: 10px;';
        else {
          if (type == 'warning') div.style = 'background: yellow; padding: 10px;';
          setTimeout(function() {
            warningBanner.removeChild(div);
            updateBannerVisibility();
          }, 5000);
        }
        updateBannerVisibility();
      }
	  
	   // Проверяем устройство
      var isTouchDevice;

      if('ontouchstart' in window || navigator.maxTouchPoints > 0 || navigator.msMaxTouchPoints > 0 || /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)) {
        isTouchDevice = true;
      } else {
        isTouchDevice = false;
      }

      var buildUrl = "Build";
      var loaderUrl = buildUrl + "/HomeDesign.loader.js";
      var config = {
        dataUrl: buildUrl + "/HomeDesign.data.unityweb",
        frameworkUrl: buildUrl + "/HomeDesign.framework.js.unityweb",
        codeUrl: buildUrl + "/HomeDesign.wasm.unityweb",
        streamingAssetsUrl: "StreamingAssets",
        companyName: "FeniksDev",
        productName: "Home Design",
        productVersion: "0.0.0.1",
        showBanner: unityShowBanner,
      };

       // Фиксируем экран с игрой
      function updateAspectRatio() {
        var windowWidth = window.innerWidth;
        var windowHeight = window.innerHeight;
        var containerAspectRatio = 16 / 9;
        
        if (windowWidth / windowHeight > containerAspectRatio) {
          canvas.style.width = windowHeight * containerAspectRatio + "px";
          canvas.style.height = "100vh";
        } else {
          canvas.style.width = "100vw";
          canvas.style.height = windowWidth / containerAspectRatio + "px";
        }
		
		// Центрируем
        canvas.style.margin = "auto";
        canvas.style.top = "0";
        canvas.style.left = "0";
        canvas.style.bottom = "0";
        canvas.style.right = "0";
      }

      // By default Unity keeps WebGL canvas render target size matched with
      // the DOM size of the canvas element (scaled by window.devicePixelRatio)
      // Set this to false if you want to decouple this synchronization from
      // happening inside the engine, and you would instead like to size up
      // the canvas DOM size and WebGL render target sizes yourself.
      // config.matchWebGLToCanvasSize = false;

      if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
        container.className = "unity-mobile";
        // Avoid draining fillrate performance on mobile devices,
        // and default/override low DPI mode on mobile browsers.
       // config.devicePixelRatio = 1;
        } else {
            // Desktop style: Render the game canvas in a window that can be maximized to fullscreen:

            canvas.style.width = "100%";
            canvas.style.height = "100%";
        }
      loadingBar.style.display = "block";
	  canvas.addEventListener("touchstart", () => {window.focus()}); 
      canvas.addEventListener("pointerdown", () => {window.focus()}); 

      var script = document.createElement("script");
	   var unityI = null;
      script.src = loaderUrl;
      script.onload = () => {
        createUnityInstance(canvas, config, (progress) => {
          progressBarFull.style.width = 100 * progress + "%";
        }).then((unityInstance) => {
		  unityI = unityInstance;
          loadingBar.style.display = "none";
		  // Проверяем устройство и фиксируем экран, если включено
          if(isTouchDevice) {
            updateAspectRatio();
            window.addEventListener("resize", updateAspectRatio);
          } else {
            updateAspectRatio();
            window.addEventListener("resize", updateAspectRatio);
          }
        }).catch((message) => {
          alert(message);
        });
      };
      document.body.appendChild(script);

    </script>
<script>
      var player = null;
      //var sdk;
      var payments = null;
	  
	  YaGames.init({
        adv:{
          onAdvClose: wasShown =>{console.info('adv closed!');
        }
      }
      })
        .then(ysdk => {
            window.ysdk = ysdk;
            ysdk.adv.showFullscreenAdv({callbacks:{}});
			initPayments();
      });

      var lb;
	  
	  var payments = null;

        function initPayments(){

            ysdk.getPayments({ signed: true }).then(_payments => {
                // Покупки доступны.
                payments = _payments;
            }).catch(err => {
                // Покупки недоступны. Включите монетизацию в консоли разработчика.
                // Убедитесь, что на вкладке Покупки консоли разработчика присутствует таблица
                // хотя бы с одним внутриигровым товаром и надписью «Покупки разрешены».
            })
        }
		
		function checkPurсhases(){

            payments.getPurchases().then(purchases => purchases.forEach(consumePurchase));

			function consumePurchase(purchase) {
			   var purchaseTrue = { "id": purchase.productID, "success": true};
			   unityI.SendMessage("YandexSDK", "SetPurchased", JSON.stringify(purchaseTrue));
			   payments.consumePurchase(purchase.purchaseToken);
			   //console.log('checkPurсhases purchase.productID');
			   //console.log(purchase.productID);
				/*if (purchase.productID === 'gold500') {
					player.incrementStats({ gold: 500 }).then(() => {
							payments.consumePurchase(purchase.purchaseToken)
						});
				}*/
			}
			
			//console.log('SetPurchased false');
			var purchaseFalse = { "id": "", "success": false};
			unityI.SendMessage("YandexSDK", "SetPurchased", JSON.stringify(purchaseFalse));
		}
		
		const bodyType = document.querySelector('body');
		function setBackground(){

            let colors;
			colors = bodyType.style.background = '#333333';
        }
		
		function initPlayer(photoSize, _scopes) {
            return ysdk.getPlayer({ scopes: _scopes }).then(_player => {

                player = _player;

                var playerName = player.getName();
                var playerPhoto = player.getPhoto(photoSize);
				
				//console.log("player.getUniqueID()");
				//console.log(player.getUniqueID());

                if (!_scopes){
                    playerName = "anonymous";
                    playerPhoto = "null";
                }

                if (player.getMode() === 'lite') {
					 console.log('auth lite');
                    // ����� �� �����������
                    NotAuthorized();
                }
                else
                {
                    // ����� �����������
                    console.log('auth ok');
                    var authJson = { "playerAuth": "resolved", "playerName": playerName, "playerId": player.getUniqueID(), "playerPhoto": playerPhoto };
                    unityI.SendMessage('YandexSDK', 'SetAuthorization', JSON.stringify(authJson));
                }
            }).catch(err =>
            {
                // ������ ��� ������������� ������� Player
                console.log('auth err');
                NotAuthorized();
            });
        }

        function NotAuthorized()
        {
            console.log('auth failed');
            var authJson = { "playerAuth": "rejected", "playerName": "unauthorized", "playerId": player.getUniqueID(), "playerPhoto": "null" };
            unityI.SendMessage('YandexSDK', 'SetAuthorization', JSON.stringify(authJson));
        }
		
		function OpenAuthDialog(photoSize, scopes) {
            ysdk.auth.openAuthDialog().then(() => {
                initPlayer(photoSize, scopes);
            }).catch(() => {
                AuthorizationCheck(photoSize, scopes);
            });
        }
		
		function AuthorizationCheck(photoSize, scopes) {
            initPlayer(photoSize, scopes);
        }

		
		function tryPurchase(_id){
			   payments.purchase({ id: _id }).then(purchase => {
			   // Покупка успешно совершена
			   var purchaseTrue = { "id": _id, "success": true};
			   unityI.SendMessage("YandexSDK", "SetBuying", JSON.stringify(purchaseTrue));
			   window.focus();
			   payments.consumePurchase(purchase.purchaseToken);
			   //console.log('tryPurchase purchased');
		   }).catch(err => {
		       //console.log('tryPurchase error');
			   var purchaseFalse = { "id": _id, "success": false};		
			   unityI.SendMessage("YandexSDK", "SetBuying", JSON.stringify(purchaseFalse));
			   window.focus();
			})
        }
		
		function hideAds(){
			ysdk.adv.getBannerAdvStatus().then(({ stickyAdvIsShowing , reason }) => {
			if (stickyAdvIsShowing) {
				// реклама показывается
				ysdk.adv.hideBannerAdv();
			} else if(reason) {
				// реклама не показывается
			} 
			})
		}

		function showAds(){
			   ysdk.adv.getBannerAdvStatus().then(({ stickyAdvIsShowing , reason }) => {
				if (stickyAdvIsShowing) {
					
					// реклама показывается
				} else if(reason) {
					// реклама не показывается
					
					//ysdk.adv.showBannerAdv();
				} else {
				
					ysdk.adv.showBannerAdv()
				}
				})
        }		

    function GetLeaderBoard(){
      ysdk.getLeaderboards().then(_lb => lb = _lb);
            }

    function SetLeaderBoard(score){
      ysdk.getLeaderboards()
          .then(lb => {
            
            lb.setLeaderboardScore('Coins', score);});
        }

    function GetLeaderBoardEntries(){
      ysdk.getLeaderboards()
          .then(lb => {lb.getLeaderboardEntries('Coins', { quantityTop: 10, includeUser: true, quantityAround: 3 }).then(res =>
            {
              
              unityI.SendMessage('YandexSDK', 'BoardEntriesReady', JSON.stringify(res));});
            });
      }

     function getUserData(){
			if(player != null) {
			 console.log('player start');
				player.getData().then(stats =>{
				  
				  //GetLeaderBoard();
				  if (Object.keys(stats).length === 0){
				  //console.log("stats");
				  //console.log(stats);
				  unityI.SendMessage('YandexSDK', 'DataGetting', "");
				  }
				  else{
				   //console.log("stats");
				   //console.log(JSON.stringify(stats));
				   //console.log(stats);
           unityI.SendMessage('YandexSDK', 'DataGetting', "");
				 //  unityI.SendMessage('YandexSDK', 'DataGetting', JSON.stringify(stats));
				   //unityI.SendMessage('YandexSDK', 'DataGetting', stats);
				  }
			   });
		    }
			 //console.log('player end');
    }
	
	function getGlobalUserData(){
				return ysdk.getPlayer({ scopes: false }).then(_player => {

                player = _player;

                var playerName = player.getName();
				//console.log("player.getUniqueID()");
				//console.log(player.getUniqueID());
				
				if(player != null) {
					//console.log('player start');
					player.getData().then(stats =>{
					  
					  GetLeaderBoard();
					  if (Object.keys(stats).length === 0){
					  unityI.SendMessage('YandexSDK', 'DataGetting', "");
					  }
					  else{
					  //console.log("stats");
					   console.log(stats);
					   unityI.SendMessage('YandexSDK', 'DataGetting', JSON.stringify(stats));
					   //unityI.SendMessage('YandexSDK', 'DataGetting', stats);
					  }
			        });
		        }
            }).catch(err =>
            {
                // ������ ��� ������������� ������� Player
                console.log('auth err');
				console.log(err);
                NotAuthorized();
            });
    }

  function setUserData(_data){
	  if(player != null) {
		  // player.setData({data : _data, flush : true}).then(()=>{
		  // }).catch(()=>{console.log('unsaved')});
		  // console.log(_data);
	  }
    }

      function showFullscrenAd(){
        ysdk.adv.showFullscreenAdv({
          callbacks: {
            onClose: function(wasShown) {
			    unityI.SendMessage('YandexSDK', 'BannerShown');
			},
            onError: function(error) {
				unityI.SendMessage('YandexSDK', 'BannerShown');
			}
          }
        })
      }

     function showRewardedAd(id){
        ysdk.adv.showRewardedVideo({
        callbacks: {
            onOpen: () => {},
            onRewarded: () => {
                unityI.SendMessage('YandexSDK', 'RewardGetting');

			},
            onClose: () => {
				unityI.SendMessage('YandexSDK', 'ClosedAd');
			},
            onError: (e) => {
                //var data = {"id" : id, "error" : error};
                console.log('Error while open video ad:', e);
            }
          }
        })
      }
	  
	  function start(){
          var data = ysdk.environment;
		   
          unityI.SendMessage('YandexSDK','GettingLang',JSON.stringify(data));

          var data = ysdk.deviceInfo;
          unityI.SendMessage('YandexSDK','GettingDevice',JSON.stringify(data));
      }
	  
	  function rateGame(){
           ysdk.feedback.canReview()
			.then(({ value, reason }) => {
            if (value) {
                ysdk.feedback.requestReview()
                    .then(({ feedbackSent }) => {
						unityI.SendMessage('YandexSDK', 'CheckRateGetting', feedbackSent.toString());
                    })
            } else {
				unityI.SendMessage('YandexSDK', 'CheckRateGetting', value.toString());
            }
        })
		window.focus();
      }
	  
	  function checkRateGame(){
           ysdk.feedback.canReview()
			.then(({ value, reason }) => {
            unityI.SendMessage('YandexSDK', 'CheckRateGetting', value.toString());
        })
      }
    </script>
</body>
</html>
