(()=>{"use strict";var e,t={758:(e,t,i)=>{var s={};i.r(s),i.d(s,{aseprite:()=>u,audio:()=>p,image:()=>c,multiatlas:()=>f,spine:()=>d}),i(260),i(127);const n={boss_0:{color:16580093,frames:["knight-boss"],skins:[]},normal_0:{color:16580093,frames:["knight"],skins:["Skin1","Skin2","Skin3","Skin4","Skin5"]},boss_1:{color:16441113,frames:["skeleton-boss"],skins:[]},normal_1:{color:16441113,frames:["skeleton"],skins:["Skin1","Skin2","Skin3","Skin4","Skin5"]},boss_2:{color:2470122,frames:["wolf-boss"],skins:[]},normal_2:{color:2470122,frames:["wolf"],skins:["Skin1","Skin2","Skin3","Skin4","Skin5"]},boss_3:{color:4956761,frames:["goblin-boss"],skins:[]},normal_3:{color:4956761,frames:["goblin"],skins:["skin1","skin2","skin3","skin4","skin5"]}};function a(e){return Phaser.Math.FloorTo(e/1e3*10)}function r(e){return Phaser.Math.FloorTo(e/10*1e3)}class o{constructor(){this.state="pending",this.cancel=()=>{this._cancel=!0,this.state="canceled"},this.resolve=e=>{this._cancel||(this.state="done",this._resolve(e))},this.reject=e=>{this._cancel||(this.state="rejected",this._reject(e))},this._cancel=!1,this.promise=new Promise(((e,t)=>{this._resolve=e,this._reject=t}))}}function l(e){let t=`${e}`;return["K","M","B","T","QA","QI","SX","SP","O","N","D","AA","AB","AC"].forEach(((i,s)=>{const n=e/Number(`1${a=s+1,new Array(a).fill("000").join("")}`);var a;Phaser.Math.FloorTo(n)>=1&&(t=`${Number(Number(n).toFixed(2))}${i}`)})),t}class h extends Array{constructor(e,t=Function("i","return i;")){return super(),Array.from({length:e},((e,i)=>t(i)))}}const c={buttons:["again","again-press","attack","attack-press","attack-disabled","character","character-press","character-disabled","claim","claim-press","claim2","claim2-press","coins","coins-press","coins-disabled","exit","exit-press","freeze","freeze-press","help","help-press","left","left-new","left-press","meteor","meteor-press","ok","ok-press","right","right-new","right-press","sound-0","sound-0-press","sound-1","sound-1-press","upgrade","upgrade-press","upgrade-disabled","level-disabled","level-locked","timer","dot-off","dot-on","play-now","info","info-press","up-arrow","up-arrow-press","up-arrow-disabled"],characters:["enemy","freaze","hole","long","poison","short","damage","shadow"],projectiles:["freaze","long","poison","short","coin"],ui:["background","background-tile","boss_level","bottom_frame","castle_filler","castle_frame","clock-arrow","clock-body","coin","coin_frame","counter","current_level","enemy_filler","enemy_frame","defeat","frame_level","locked_level","reward-box","top_frame","training","unlocked_level","unlocked-board","upgrade/arrow","upgrade/board","upgrade/critical","upgrade/damage","upgrade/freeze","upgrade/level","upgrade/poison","upgrade/range","upgrade/speed","upgrade/splash","upgrade/player","upgrade/info","upgrade/first-on","upgrade/first-off","upgrade/last-on","upgrade/last-off","upgrade/weak-on","upgrade/weak-off","upgrade/strong-on","upgrade/strong-off","upgrade-price","victory","сastle","freaze-base/1","freaze-base/2","freaze-base/3","freaze-base/4","freaze-base/5","freaze-base/6","freaze-base/7","freaze-base/8","freaze-base/9","freaze-base/10","long-base/1","long-base/2","long-base/3","long-base/4","long-base/5","long-base/6","long-base/7","long-base/8","long-base/9","long-base/10","short-base/1","short-base/2","short-base/3","short-base/4","short-base/5","short-base/6","short-base/7","short-base/8","short-base/9","short-base/10","poison-base/1","poison-base/2","poison-base/3","poison-base/4","poison-base/5","poison-base/6","poison-base/7","poison-base/8","poison-base/9","poison-base/10","freaze/1","freaze/2","freaze/3","freaze/4","freaze/5","freaze/6","freaze/7","freaze/8","freaze/9","freaze/10","long/1","long/2","long/3","long/4","long/5","long/6","long/7","long/8","long/9","long/10","short/1","short/2","short/3","short/4","short/5","short/6","short/7","short/8","short/9","short/10","poison/1","poison/2","poison/3","poison/4","poison/5","poison/6","poison/7","poison/8","poison/9","poison/10","tutorial/body","tutorial/body-hand-1","tutorial/body-0","tutorial/body-1","tutorial/body-2","tutorial/body-3","tutorial/body-4","tutorial/body-5","tutorial/frame-freaze","tutorial/frame-long","tutorial/frame-poison","tutorial/frame-short","tutorial/frame-freeze","tutorial/frame-meteor","offline-board","upgrade-spawn","warning","hand","upgrade-spawner"]},d={towers:["long","poison","short","freaze"],goblins:["goblin","goblin-boss"],skeletons:["skeleton","skeleton-boss"],wolfs:["wolf","wolf-boss"],knights:["knight","knight-boss"]},u={tower:["merge","spawn","coins","attack","select","bullets"],enemy:["fireball","frost","splash","poof","hit-fx"],game:["trash"]},p={level:["fail.wav","win.wav","start.wav"],base_damage:["1.wav","2.wav","3.wav","4.wav"],button:["booster.wav","click.wav","freeze.wav","meteor.wav"],effect:["background.mp3","merge.wav","money.wav","spawn.wav","upgrade.wav","tower_sell.wav"]},f={},g=function(){return new Worker(i.p+"engine.js")},m=1390,y=427,v=695,b=new Phaser.Math.RandomDataGenerator(["1243"]),w=new class{constructor(){var e,t;this.event=new Phaser.Events.EventEmitter,this.enabled=(null===(e=window.GAMESNACKS)||void 0===e?void 0:e.isAudioEnabled())||!0,this.volume=Number(window.localStorage.getItem("merge-heroes-volume")||1),this.sound=new Map,this.timestamp=0,null===(t=window.GAMESNACKS)||void 0===t||t.subscribeToAudioUpdates((e=>{this.enabled=e,this.setVolume(this.volume)}))}init(e){this.manager=e;for(let e in p)for(let t in p[e]){const i=p[e][t];this.sound.set(`${e}-${i}`,this.manager.add(`${e}-${i}`));const s=this.sound.get(`${e}-${i}`);null==s||s.setVolume(this.getVolume()),["play","complete","looped","pause","resume","stop","mute","volume","detune","rate","seek","loop"].forEach((t=>{null==s||s.on(t,((...s)=>this.event.emit(`${t}-${e}-${i}`,s)))}))}}setVolume(e){this.volume=e,window.localStorage.setItem("merge-heroes-volume",`${e}`);const t=this.getVolume();[...this.sound.values()].forEach((e=>{e.setVolume(t)}))}getVolume(){return this.enabled?this.volume:0}play(e,t){var i;null===(i=this.sound.get(e))||void 0===i||i.play("",t)}playThrottle(e,t,i){var s;(new Date).getTime()<this.timestamp+t||(null===(s=this.sound.get(e))||void 0===s||s.play("",i),this.timestamp=(new Date).getTime())}pause(){[...this.sound.values()].forEach((e=>{e.pause()}))}resume(){[...this.sound.values()].forEach((e=>{e.resume()}))}},x=new Phaser.Events.EventEmitter,k={bitmaps:{}},_={isAudioEnabled:window.GAMESNACKS.isAudioEnabled,subscribeToAudioUpdates:window.GAMESNACKS.subscribeToAudioUpdates,sendScore:window.GAMESNACKS.sendScore,gameOver:window.GAMESNACKS.gameOver,levelComplete:window.GAMESNACKS.levelComplete,gameReady:window.GAMESNACKS.gameReady,beforeReward:()=>{},beforeBreak:()=>{},afterBreak:()=>{},adComplete:()=>{},adDismissed:()=>{},showAdFn:()=>{},clear:function(){this.beforeReward=()=>{},this.beforeBreak=()=>{},this.afterBreak=()=>{},this.adComplete=()=>{},this.adDismissed=()=>{}},timeout:function(){setTimeout((()=>{this.init()}),1e3)},adEnabled:!1,init:function(){this.timeout(),this.adEnabled||window.GAMESNACKS.rewardedAdOpportunity({beforeReward:e=>{this.adEnabled=!0,this.showAdFn=e,this.beforeReward()},beforeBreak:this.beforeBreak||new Function,afterBreak:this.afterBreak||new Function,adComplete:()=>{this.adEnabled=!1,this.adComplete(),this.clear()},adDismissed:()=>{this.adEnabled=!1,this.adDismissed()}})}},S=[["Uni_Sans_Heavy_17px",{fontFamily:"Uni_Sans_Heavy",fontSize:"17px",color:"#ffffff",stroke:"#000000",strokeThickness:4}],["Uni_Sans_Heavy_17px_red",{fontFamily:"Uni_Sans_Heavy",fontSize:"17px",color:"#F08080",stroke:"#000000",strokeThickness:4}],["Uni_Sans_Heavy_17px_green",{fontFamily:"Uni_Sans_Heavy",fontSize:"17px",color:"#2E8B57",stroke:"#000000",strokeThickness:4}],["Uni_Sans_Heavy_22px",{fontFamily:"Uni_Sans_Heavy",fontSize:"22px",color:"#ffffff",stroke:"#000000",strokeThickness:4}],["Uni_Sans_Heavy_34px",{fontFamily:"Uni_Sans_Heavy",fontSize:"34px",color:"#ffffff",stroke:"#000000",strokeThickness:4}],["Uni_Sans_Heavy_38px",{fontFamily:"Uni_Sans_Heavy",fontSize:"38px",color:"#ffffff",stroke:"#000000",strokeThickness:4}],["Uni_Sans_Heavy_44px",{fontFamily:"Uni_Sans_Heavy",fontSize:"44px",color:"#ffffff",stroke:"#000000",strokeThickness:4}],["Uni_Sans_Heavy_14px_red",{fontFamily:"Uni_Sans_Heavy",fontSize:"14px",color:"#FB6666",stroke:"#000000",strokeThickness:4}],["Uni_Sans_Heavy_24_green",{fontFamily:"Uni_Sans_Heavy",fontSize:"24px",stroke:"0xffffff",color:"#c3ff31",strokeThickness:4}],["Uni_Sans_Heavy_19_yellow",{fontFamily:"Uni_Sans_Heavy",fontSize:"19px",stroke:"0xffffff",color:"#F8E71C",strokeThickness:4}],["Uni_Sans_Heavy_28_brown",{fontFamily:"Uni_Sans_Heavy",fontSize:"28px",color:"#6f1f1c",resolution:1}],["Uni_Sans_Heavy_34_brown",{fontFamily:"Uni_Sans_Heavy",fontSize:"34px",color:"#6f1f1c",resolution:1}],["Uni_Sans_Heavy_28_green",{fontFamily:"Uni_Sans_Heavy",fontSize:"28px",color:"#4b9800",resolution:1}]];class O extends Phaser.Scene{constructor(){super({key:"Boot",pack:{files:[{type:"image",key:"loading-background",url:"assets/image/loading/background.png"},{type:"image",key:"loading-fill",url:"assets/image/loading/loading-fill.png"},{type:"image",key:"loading-fill-bk",url:"assets/image/loading/loading-fill-bk.png"},{type:"image",key:"loading-frame",url:"assets/image/loading/loading-frame.png"}]}})}preload(){var e;this.createBackground(),this.createLoaderBar();const t=[];for(let e in s)for(let i in s[e])for(let n in s[e][i])t.push([e,i,s[e][i][n]]);t.forEach((e=>{const[t,i,s]=e;if(!t||!i||!s)return;const n=`assets/${t}/${i}`,a=`${n}/${s}`;"image"===t&&this.load[t](`${i}-${s}`,`${a}.png`),"spine"===t&&this.load[t](s,`${a}.json`,[`${a}.atlas`],!1),"aseprite"===t&&this.load[t](`${i}-${s}`,`${a}.png`,`${a}.json`),"audio"===t&&this.load[t](`${i}-${s}`,[a]),"multiatlas"===t&&this.load[t](`${i}-${s}`,`${a}.json`,n)})),null===(e=document.getElementById("to_remove"))||void 0===e||e.remove()}init(){this.cameras.main.setBackgroundColor("rgba(0, 0, 0, 0)"),x.emit("resize")}create(){this.initFonts(),w.init(this.sound),this.initAsepriteAnimations(),this.time.delayedCall(50,(()=>{this.scene.launch("Game"),this.scene.bringToTop()}))}initFonts(){const e=this.plugins.get("rexcharactercacheplugin");new Map(S).forEach(((t,i)=>{const s=(e=>void 0===e||"string"!=typeof e?"#ffffff":e)(t.color),n=this.make.text({add:!1,style:Object.assign({},t,{color:s,testString:"回"})});"string"!=typeof t.color&&n.setFill(function(e,t){const i=e.height,s=Number(e.style.fontSize.replace("px","")),n=Math.floor(i/s)||1;if(t.length<2)return console.error("at least two colors are expected");const a=e.context.createLinearGradient(0,5,0,e.height);return new Array(n).fill("").forEach(((e,i)=>{t.forEach((e=>{a.addColorStop(1/n/100*e.percent+1/n*i,e.color)}))})),e.setFill(a),a}(n,t.color)),k.bitmaps[i]=e.add(this,{key:i,cellWidth:32,cellHeight:32,maxCharacterCount:32,textObject:n})}))}initAsepriteAnimations(){for(let e in u)u[e].forEach((t=>{this.anims.createFromAseprite(`${e}-${t}`)}))}createBackground(){this.add.sprite(y,v,"loading-background")}createLoaderBar(){const[e,t]=[y,545];this.add.sprite(e,t,"loading-fill-bk");const i=this.add.sprite(e,t,"loading-fill"),s=this.add.sprite(e,t,"loading-frame"),[n,a]=[s.width,s.height],r=this.add.rectangle(e-n/2,t,0,a,16777215,1).setOrigin(0,.5).setVisible(!1);i.mask=new Phaser.Display.Masks.BitmapMask(this,r),this.load.on("progress",(e=>{this.tweens.add({targets:[r],width:e*s.width,duration:200})}),this)}}const I=Phaser.Math.Between(-1e6,1e6),T=[[254,261],[626,328],[540,480],[311,444],[209,594],[630,673],[527,834],[296,797],[210,940],[564,999]],P=(()=>{const e=new Phaser.Curves.Path(T[0][0],T[0][1]);return T.forEach(((t,i)=>{i&&e.lineTo(t[0],t[1])})),e})(),D=[[241,351],[382,370],[519,395],[665,422],[188,501],[331,524],[469,548],[614,576],[241,697],[381,721],[516,743],[670,768],[191,850],[328,874],[473,902],[613,925],[332,1057],[471,1075]],C=622,A=1050,E={update:1,start:1,end:4,calcLevel:function(e,t){return e*this.end-this.end+t}},M={start:1,max:10,range:e=>.1*e+1,recharge:e=>1/(.1*e+1),critical:(e,t)=>"long"!==e?1:Phaser.Math.Between(0,100)<t?2:1,splash:(e,t,i)=>"short"!==e?0:t*(i/100)},$={freaze:{recharge:a(6e4),duration:a(1e4),counter:0,value:0},meteor:{recharge:a(9e4),duration:a(1e4),counter:0,value:0},coins:{recharge:a(3e5),duration:a(3e5),counter:0,value:2},attack:{recharge:a(3e5),duration:a(3e5),counter:0,value:1.25}},N={freaze:{recharge:$.freaze.recharge,duration:$.freaze.duration,getRecharge:function(e){const t=(e-1)/5;return this.recharge+this.duration*t}},meteor:{recharge:$.meteor.recharge,duration:$.meteor.duration,getRecharge:function(e){const t=(e-1)/5;return this.recharge+this.duration*t}},coins:{},attack:{}},z={start:{tick:0,coins:31,start_delay:a(1e3),level:E.start,stage:1},spawn:{enemy:{duration:a(8e3),getOverAllHP:function(e,t,i){const s=E.calcLevel(e.stage,e.level);i=(t=>{const i=e=>Math.max(1,Math.round(.8*e));return 4===e.level?i(4+t):i(Phaser.Math.Between(2+t,4+t))})(s);let n=1.3*i*400*s;return s<4&&(n*=.7),s>8&&(n*=1.5),4===e.level&&(n/=2),n},getReward:function(e){return.02*e},getAmount:function(e){const t=E.calcLevel(e.stage,e.level),i=e=>Math.max(1,Math.round(.8*e));return 4===e.level?i(4+t):Math.min(25,i(Phaser.Math.Between(2+t,4+t)))},getDamage:function(e){return e},amount_type:[8,2],boss_keys:["boss_0","boss_1","boss_2","boss_3"],normal_keys:["normal_0","normal_1","normal_2","normal_3"],boss_0:{lable:"short-boss",type:"boss_0",resistance:{},radius:25,calcSpeed:function(e){return.6*a(1e3*(45+E.calcLevel(e.stage,e.level)/2))*1.2}},boss_1:{lable:"freaze-boss",type:"boss_1",resistance:{},radius:25,calcSpeed:function(e){return.6*a(1e3*(45+E.calcLevel(e.stage,e.level)))*1.2}},boss_2:{lable:"long-boss",type:"boss_2",resistance:{},radius:25,calcSpeed:function(e){return.6*a(1e3*(45+E.calcLevel(e.stage,e.level)))*1.2}},boss_3:{lable:"poison-boss",type:"boss_3",resistance:{},radius:25,calcSpeed:function(e){return.6*a(1e3*(45+E.calcLevel(e.stage,e.level)))*1.2}},normal_0:{lable:"short",type:"normal_0",resistance:{freaze:1.5},radius:25,calcSpeed:function(e){return 1.2*a(1e3*(36+E.calcLevel(e.stage,e.level)))}},normal_1:{lable:"freaze",type:"normal_1",resistance:{short:1.5},radius:25,calcSpeed:function(e){return 1.2*a(1e3*(36+E.calcLevel(e.stage,e.level)))}},normal_2:{lable:"long",type:"normal_2",resistance:{poison:1.5},radius:25,calcSpeed:function(e){return 1.2*a(1e3*(36+E.calcLevel(e.stage,e.level)))}},normal_3:{lable:"poison",type:"normal_3",resistance:{long:1.5},radius:25,calcSpeed:function(e){return 1.2*a(1e3*(36+E.calcLevel(e.stage,e.level)))}}},tower:{levelUp:.05,merge:{damage:.05},price_upgrade:function(e){return 25*(e||1)*1.2*5},price:function(e,t){return 25*(e||1)*1.2},keys:["short","long","freaze","poison"],short:{lable:"short",type:"short",range:65,damage:100,splash:!0,ability:null,recharge:a(1500)},long:{lable:"long",type:"long",range:130,damage:100,splash:!1,ability:null,recharge:a(2e3)},freaze:{lable:"freaze",type:"freaze",range:130,damage:50,splash:!1,ability:"freaze",recharge:a(2e3)},poison:{lable:"poison",type:"poison",range:65,damage:40,splash:!1,ability:"poison",recharge:a(2e3)}},ability:{freaze:{key:"freaze",type:"static",state:"speed",value:2,mode:"multiply-overlay",duration:a(2e3)},poison:{key:"poison",type:"static",state:"health",value:.006,mode:"multiply-apply",duration:a(8e3)},extra_freaze:{key:"extra_freaze",type:"static",state:"speed",value:1e3,mode:"multiply-overlay",duration:$.freaze.duration}}},update:{tick:1,ability:1,level:E.update,stage:1,level_end:E.end,health:function(e){return 1e4*E.calcLevel(e.stage,e.level)},calcLevel:E.calcLevel,wave_delay:a(1500)},coins:{onLevelUp:function(e){return 1},onStageUp:function(e){return.1*e*.25},onEnemyDestroy:function(e,t){return e+t},upgradePrice:function(e){return new h(e-1).reduce(((e,t)=>2*e),200)},offlineReward:function(e,t){return(25*(t||1)*1.2*5+25*(t+1||1)*1.2*5)*((e=Math.min(12,e))/12)}},extra:$,extra_options:N,level:E,upgrade:M};class B{constructor(e){this.scene=e.scene,this.element=e,this._enabled=!0,this.delay=200,this.timeout=!1,this.events=new Map,this.events.set("click",(function(){})),this.events.set("over",(function(){})),this.events.set("out",(function(){})),this.events.set("enable",(function(){})),this.events.set("disable",(function(){})),e.setInteractive(),e.on("pointerdown",this.on_click_template.bind(this)),e.on("pointerover",this.on_over_template.bind(this)),e.on("pointerout",this.on_out_template.bind(this))}get enabled(){return this._enabled}setDelay(e){return this.delay=e,this}enable(){if(!this._enabled)return this._enabled=!0,this.events.get("enable")(this,this.element),this}disable(){if(this._enabled)return this._enabled=!1,this.events.get("disable")(this,this.element),this}click(e){return this.events.set("click",e),this}over(e){return this.events.set("over",e),this}out(e){return this.events.set("out",e),this}on(e,t){return this.events.set(e,t),this}emit(e){return this.events.get(e)(this,this.element),this}on_click_template(){this._enabled&&(this.timeout||(document.body.style.cursor="auto",this.timeout=!0,this.scene.time.delayedCall(this.delay,(()=>{this.timeout=!1})),this.events.get("click")(this,this.element)))}on_over_template(){this._enabled&&(this.timeout||(document.body.style.cursor="pointer",this.events.get("over")(this,this.element)))}on_out_template(){document.body.style.cursor="auto",this._enabled&&(this.timeout||this.events.get("out")(this,this.element))}}class F{constructor(e,t,i){this.events=new Phaser.Events.EventEmitter,this.initialized=!1,this.isPaused=!1,this.scene=e,this.onCreate=t,this.onUpdate=i,this.worker=new g,this.worker.onmessage=this.updated.bind(this),this.scene.physics.add.sprite(-854,-1390,"MISSING"),this.scene.physics.world.on(Phaser.Physics.Arcade.Events.WORLD_STEP,this.update.bind(this)),this.initEvents()}start(e){this.worker.postMessage({type:"start",data:e})}state(){return this._state}pause(){this.scene.physics.pause(),this.isPaused=!0}resume(){this.scene.physics.resume(),this.isPaused=!1}moveTower(e,t){this.worker.postMessage({type:"event",data:"player-move-tower",value:{from:e,to:t}})}removeTower(e){this.worker.postMessage({type:"event",data:"player-remove-tower",value:e})}holdTower(e,t){const i=t?"pause":"resume";this.worker.postMessage({type:"event",data:`player-${i}-tower`,value:e})}upgrade_towers(e,t){this.custom_update=t,this.worker.postMessage({type:"upgrade_towers",data:e})}upgrade_spawn(e){this.custom_update=e,this.worker.postMessage({type:"upgrade_spawn"})}askLevelReward(e=!1){this.emitEvent("player-level-reward"+(e?"2":""))}askOfflineReward(e=!1){this.emitEvent("player-offline-reward"+(e?"2":""))}towerPriorityChange(e,t){this.emitEvent("tower-priority-change",{type:e,state:t})}on(e,t){this.events.on(e,t)}once(e,t){this.events.once(e,t)}emitEvent(e,t){this.worker.postMessage({type:"event",data:e,value:t})}update(){this.initialized&&this.worker.postMessage({type:"update"})}updated(e){const t=e.data;switch(t.type){case"start":this.onCreate(t.data),this.initialized=!0;break;case"update":this.onUpdate(t.data);break;case"upgrade_towers":case"upgrade_spawn":return this.custom_update&&this.custom_update(t.data),void(this.custom_update=void 0)}this.manageEvents(t.data),this._state=t.data}manageEvents(e){if(!this._state)return this.events.emit("coins-start",e.game.coins,e),void this.events.emit("game-start",e.game,e);e.events&&e.events.length&&e.events.forEach((e=>{e.event.includes("@delayed-")?setTimeout((()=>{this.events.emit(e.event.replace("@delayed-",""),e.data)}),100):this.events.emit(e.event,e.data)})),e.game.coins!==this._state.game.coins&&this.events.emit("coins-update",e.game.coins,e),this.events.emit("game-update",e.game,e),e.game.coins!==this._state.game.coins&&this.save()}initEvents(){const e=e=>{this.worker.postMessage({type:"event",data:`player-purchase-${e}`})};this.on("buttons-freeze",(()=>e("freaze"))),this.on("buttons-meteor",(()=>e("meteor"))),this.on("buttons-tower",(()=>e("tower"))),this.on("buttons-coins",(()=>e("coins"))),this.on("buttons-attack",(()=>e("attack")))}save(){const e=Object.assign({timestamp:Date.now()},this._state);window.localStorage.setItem("merge-heroes-save",btoa(JSON.stringify(e)))}}class j extends Phaser.GameObjects.Container{constructor(e,t,i,s,n=!0){super(e,t,i),this.particles=e.particles,this.value=100,this.add(this.scene.add.image(0,0,s[1]).setTintFill(0,0,0,0));const a=this.scene.add.bitmapText(0,-10,"Uni_Sans_Heavy_17px").setOrigin(.5).setName("text");this.add(a),k.bitmaps.Uni_Sans_Heavy_17px.overrideBitmapText(a),a.setLetterSpacing(-4),this.bitmap=a,this.createFiller(s[1]),this.createFrame(s[0]),this.withEffect=n,e.add.existing(this)}set(e,t){e<0&&(e=0),e>100&&(e=100);const i=this.getByName("filler"),s=this.bounds.width/100*e;return e>this.value?(this.tween&&this.tween.stop(),i.width=s):this.tween=this.scene.tweens.add({targets:i,width:s,duration:250,onStop:()=>{i.width=s}}),this.value=e,void 0!==t&&(this.withEffect&&this.emitDamage(this.health-t),this.getByName("text").setText(`${l(Math.ceil(t))}`),this.health=t),this}fill(e){return this.getByName("filler").setTintFill(e,e,e,e),this}setFont(e){const t={normal:"Uni_Sans_Heavy_17px",red:"Uni_Sans_Heavy_17px_red",green:"Uni_Sans_Heavy_17px_green"};this.bitmap.setFont(t[e]),k.bitmaps[t[e]].overrideBitmapText(this.bitmap)}emitDamage(e){if(isNaN(e))return;if((e=Math.ceil(e))<=0)return;const{tx:t,ty:i}=this.getWorldTransformMatrix();this.particles.playRedDamage(t,i-20,e)}createFrame(e){const t=this.scene.add.image(0,0,e).setName("frame");this.add(t)}createFiller(e){const t=this.scene.add.image(0,0,e);this.bounds=t.getBounds();try{t.destroy()}catch(e){console.warn("HealthBar.ts => 62")}const i=this.scene.add.tileSprite(-this.bounds.width/2,0,this.bounds.width,this.bounds.height,e).setScale(.98).setOrigin(0,.5).setName("filler");this.add(i)}}class V extends Phaser.GameObjects.Particles.Particle{constructor(e){super(e),this.time=0,this.counter=0,this.update=(e,t,i)=>super.update(e,t,i)}}class L{constructor(e){const t=e.add.particles("projectiles-coin");t.setName("coins"),this.emmiter=t.createEmitter({on:!1,scale:.4,alpha:{start:1,end:.5},x:0,y:0,quantity:5,frequency:200,rotate:{min:-10,max:10},speed:50,lifespan:600,particleClass:V})}get emit(){return this.emmiter}}const R={red:16711680,green:65280,blue:255};class U extends Phaser.GameObjects.Container{constructor(e,t){super(e),this.inDestroyState=!1,this.spineScale=.85,this.color=void 0,this.group=t,this.add(e.add.circle(0,0,0,0,.05).setName("radius").setVisible(!1)),this.add(e.add.image(0,17,"characters-shadow"));const i=e.add.spine(0,20,"goblin").setSkinByName("skin1").setScale(this.spineScale).setName("spine");this.add(i);const s=new j(e,0,-45,["ui-enemy_frame","ui-enemy_filler"]).setName("health");this.add(s),this.setActive(!1),this.setVisible(!1),this.setDepth(5),this.initChangeData(),this.initFX()}create(e){if(this.name===e.id)return console.log("Enemy already exists",this),this.setActive(!0),this.setVisible(!0),void this.setAlpha(1);const t=this.defineType(e.type);this.getByName("health").set(e.health/(e.health_max/100),e.health).setY(e.type.includes("boss")?-55:-45),this.getByName("radius").setRadius(e.radius);const i=this.getByName("spine");i.setSkeleton(t.frame,this.scene.game.cache.json.get(t.frame)),i.timeScale=480/e.speed,i.setScale(this.spineScale,this.spineScale),t.skin&&i.setSkinByName(t.skin),i.play("Walk",!0),this.setPosition(T[0][0],T[0][1]),this.setActive(!0),this.setVisible(!0),this.setAlpha(1),this.setData(e),this.setName(e.id)}update(e){for(let t in e)this.getData(t)!==e[t]&&this.setData(t,e[t])}playDestroy(e=!1){return this.inDestroyState?Promise.resolve(!1):(this.setData("health",0),this.inDestroyState=!0,this.scene.time.delayedCall(150,(()=>{this.getByName("health").setVisible(!1)})),new Promise((t=>{const i=this.createSprite("enemy-poof","poof"),s=this.getByName("spine");this.add(i);const n=this.scene.tweens.add({targets:[s],alpha:0,duration:r(5)}),a=this.getData("health_max"),o=z.spawn.enemy.getReward(a);e||this.playCoinReward(o),i.once("animationcomplete",((e,i,a)=>{this.scene.time.delayedCall(50,(()=>{var e;null===(e=this.extra_anim)||void 0===e||e.destroy(),a.destroy(),n.stop(),s.setAlpha(1),this.inDestroyState=!1,this.setVisible(!1),this.getByName("health").setVisible(!0),t(!0)}))}))})))}startFrost(){var e;null===(e=this.extra_anim)||void 0===e||e.destroy(),this.extra_anim=this.createSprite("enemy-frost","frost-start"),this.color=R.blue,this.getByName("spine").setColor(this.color),this.add(this.extra_anim)}stopFrost(){const e=this.extra_anim;if(!(null==e?void 0:e.anims))return null==e||e.destroy(),void(this.extra_anim=void 0);null==e||e.play({key:"frost-end",repeat:0}),null==e||e.once("animationcomplete",(()=>{null==e||e.destroy(),this.color=void 0,this.getByName("spine").setColor(this.color),this.extra_anim=void 0}))}playMeteor(){const e=new o,t=this.scene.add.sprite(1e3,-1e3,"fireball").setAngle(45).setOrigin(.5,.8).play({key:"fireball",repeat:-1});return this.add(t),this.scene.tweens.add({targets:[t],x:0,y:0,duration:500,onComplete:()=>{e.resolve(1),this.scene.time.delayedCall(50,(()=>{t.setAngle(0),t.setOrigin(.5,.6),t.play({key:"splash",repeat:0}),t.once("animationcomplete",(()=>{try{t.destroy()}catch(e){console.warn("Enemy.ts => 176")}}))}))}}),e.promise}playHealth(e){const t=(e=>z.spawn.enemy[e].lable)(this.getData("type"));return"long"===e&&"poison"===t||"short"===e&&"freaze"===t||"poison"===e&&"long"===t||"freaze"===e&&"short"===t?this.healthAnimation():void 0}playFX(e){this.fx.play(`fx-${e}`)}healthAnimation(e="red",t=!0){const i=this.getByName("spine"),s=this.getByName("health");return this.scene.tweens.timeline({targets:[t?s:{angle:0}],duration:100,tweens:[{angle:-7},{angle:7},{angle:0}],onStart:()=>{i.setColor(R[e]),t&&s.setFont(e)},onComplete:()=>{i.setColor(this.color),t&&s.setFont("normal")}})}defineType(e){return{color:n[e].color,frame:b.pick(n[e].frames),skin:b.pick(n[e].skins)}}initChangeData(){this.on("changedata-health",((e,t)=>{var i;if(!this.active)return;const s=e.getData("health_max"),n=e.getByName("health");if(n.health===t)return;const a=Math.abs(t-n.health);n.set(t/(s/100),t);const r=this.healthAnimation("red",!1),o=null===(i=this.getData("debuff"))||void 0===i?void 0:i.get("health"),l=s*z.spawn.ability.poison.value;o&&a.toFixed(1)===l.toFixed(1)&&(r.stop(),this.healthAnimation("green"))})),this.on("changedata-radius",((e,t)=>{this.active&&this.getByName("radius").setRadius(t)})),this.on("changedata-pos",((e,t)=>{if(!this.active)return;const i=this.getByName("spine");t.x!==this.x&&(t.x>this.x&&i.scaleX<0?i.setScale(this.spineScale,this.spineScale):t.x<this.x&&i.scaleX>0&&i.setScale(-this.spineScale,this.spineScale)),this.scene.tweens.add({targets:[this],x:t.x,y:t.y,duration:100})})),this.on("changedata-t",((e,t)=>{if(!this.active)return;const i=this.getByName("spine"),s=t.toFixed(4).replace("0.","");t<1&&this.setDepth(Number(s)),1===t&&(i.timeScale=1,i.play("Attack",!0),this.setDepth(Math.pow(9,9)))})),this.on("changedata-speed",((e,t)=>{this.active&&(t||(t=40),this.getByName("spine").timeScale=480/t,Math.floor(t)>1e5?this.startFrost():this.extra_anim&&this.stopFrost())})),this.on("changedata-debuff",((e,t)=>{if(!this.active)return;const i=7389552,s=6336767,n=this.getByName("spine");t.get("health")||t.get("speed")?t.get("health")&&!t.get("speed")?(n.setColor(void 0),this.getByName("health").fill(i)):!t.get("health")&&t.get("speed")?(n.setColor(s),this.getByName("health").fill(void 0)):t.get("health")&&t.get("speed")&&(n.setColor(s),this.getByName("health").fill(i)):(n.setColor(void 0),this.getByName("health").fill(void 0))}))}createSprite(e,t){return this.scene.add.sprite(0,0,e).play({key:t,repeat:0}).setOrigin(.5,.65).setScale(.8)}playCoinReward(e){const t=this.scene.add.image(-15,-80,"ui-coin").setOrigin(1,.5).setAlpha(0),i=this.scene.add.bitmapText(-15,-75,"Uni_Sans_Heavy_19_yellow").setOrigin(0,.5).setAlpha(0);k.bitmaps.Uni_Sans_Heavy_19_yellow.overrideBitmapText(i),i.setLetterSpacing(-3),i.setText(`+${l(Math.floor(e))}`),this.add(t),this.add(i),this.scene.tweens.add({targets:[t,i],duration:200,alpha:1}),this.scene.tweens.timeline({targets:t,duration:750,ease:Phaser.Math.Easing.Bounce.InOut,tweens:[{scale:.7},{scale:.5},{scale:.6}]}),this.scene.tweens.add({targets:[i,t],delay:500,duration:500,y:"-=80"}),this.scene.tweens.add({targets:[i,t],delay:750,duration:250,alpha:0,onComplete:()=>{i.destroy(),t.destroy()}}),this.group.emit("coins-emit",this.x,this.y)}initFX(){this.fx={long:this.scene.add.sprite(0,0,"enemy-poof").setScale(.4).setVisible(!1),short:this.scene.add.sprite(0,0,"enemy-poof").setScale(.4).setVisible(!1),poison:this.scene.add.sprite(0,0,"enemy-hit-fx").setVisible(!1),freaze:this.scene.add.sprite(0,0,"enemy-hit-fx").setVisible(!1),play:function(e){const t=e.replace("fx-",""),i=this[t];"long"!==t&&"short"!==t||(e="poof"),i.setVisible(!0),i.play({key:e,repeat:0},!0),i.once("animationcomplete",(()=>{i.setVisible(!1)}))},stop:function(e){const t=this[e.replace("fx-","")];t.setVisible(!1),t.stop()}},this.add(this.fx.long),this.add(this.fx.short),this.add(this.fx.freaze),this.add(this.fx.poison)}}var H=function(e,t,i,s){return new(i||(i=Promise))((function(n,a){function r(e){try{l(s.next(e))}catch(e){a(e)}}function o(e){try{l(s.throw(e))}catch(e){a(e)}}function l(e){var t;e.done?n(e.value):(t=e.value,t instanceof i?t:new i((function(e){e(t)}))).then(r,o)}l((s=s.apply(e,t||[])).next())}))};class q extends Phaser.GameObjects.Group{constructor(e){super(e),this.engine=e.engine,this.bullets=e.particles,this.coins=new L(e),this.on("coins-emit",((e,t)=>{this.coins.emit.emitParticleAt(e,t,5)})),this.engine.events.on("ui-buttons-meteor",(()=>H(this,void 0,void 0,(function*(){this.engine.events.emit("buttons-meteor")})))),this.engine.events.on("game-success-meteor",(()=>H(this,void 0,void 0,(function*(){yield this.playMeteor(),this.scene.cameras.main.shake(500,.1,!0)}))))}update(e){const t=new Phaser.Structs.Set;e.enemys.forEach((e=>{let i=this.getEnemy(e.id);i||(i=this.createEnemy(e)),i.update(e),t.set(i)}));const i=e.events.filter((e=>"game-reward"===e.event))[0];this.children.difference(t).each((e=>{e.active&&e.playDestroy(Boolean(i&&!i.data.coins)).then((t=>{t&&this.killAndHide(e)}))}))}getEnemy(e){return new Phaser.Structs.Set(this.getMatching("name",e)).get("active",!0)}shoot(e,t){const i=this.getEnemy(e);if(!i)return;const s=i.getData("posF"),n=new Phaser.Math.Vector2(t.x,t.y),a=new Phaser.Math.Vector2(s.x,s.y);this.bullets.playBullet(n,a,t.type).then((()=>{i.playHealth(t.type),i.playFX(t.type)}))}createEnemy(e){let t=this.getFirstDead();return t||(t=new U(this.scene,this),this.add(t,!0)),t.create(e),t}playMeteor(){const e=this.getMatching("active",!0).map((e=>e.playMeteor()));return Promise.all(e)}}class W extends Phaser.GameObjects.Container{constructor(e,t,i,s){super(e,t,i,[]),this.id=s,this.pos={x:t,y:i},this.setName(`${s}`),this.add(this.scene.add.image(0,-10,"characters-hole").setOrigin(.5,.4).setName("image")),this.setData("id",this.id),this.setData("pos",this.pos),this.setData("geom",new Phaser.Geom.Circle(t,i,80))}setTexture(e){const t=this.getByName("image");"characters-hole"===e?(t.setVisible(!0),t.setOrigin(.5,.4),t.setTexture(e)):(t.setVisible(!1),t.setOrigin(.5,.5))}contains(e){return Phaser.Geom.Circle.ContainsPoint(this.getData("geom"),e)}}class K extends Phaser.GameObjects.Group{constructor(e){super(e),this.engine=e.engine,this.engine.events.on("hole-type",(e=>{this.getHole(e.id).setTexture(`characters-${e.type}`)}))}create(e){return e.game.holes.forEach(((e,t)=>{this.add(new W(this.scene,e[0],e[1],t),!0)})),this}getHole(e){return this.getMatching("name",String(e))[0]}getContains(e){let t=NaN;return this.children.each((i=>{isNaN(t)&&i.contains(e)&&(t=i.id)})),t}}new Phaser.Math.RandomDataGenerator([`${I}`]);const G=new Phaser.Events.EventEmitter;class J extends Phaser.GameObjects.Container{constructor(e,t){super(e),this.playBonusAttack=()=>{const e=this.getByName("attack-animation");e.setVisible(!0),e.play({key:"attack",repeat:-1})},this.playBonusCoins=()=>{const e=this.getByName("coins-animation");e.setVisible(!0),e.play({key:"coins",repeat:-1})},this.stopBonusAttack=()=>{const e=this.getByName("attack-animation");e.setVisible(!1),e.play({key:"attack",repeat:0})},this.stopBonusCoins=()=>{const e=this.getByName("coins-animation");e.setVisible(!1),e.play({key:"coins",repeat:0})},this.engine=t,this.add(e.add.circle(0,20,20,0,0).setName("range").setStrokeStyle(24,0,.2).setVisible(!1)),this.add(e.add.sprite(0,-25,"tower-attack").setOrigin(.5).setName("attack-animation").setVisible(!1)),this.add(e.add.image(0,10,"MISSING").setScale(.5).setName("base")),this.add(e.add.sprite(0,-25,"tower-coins").setOrigin(.5).setName("coins-animation").setVisible(!1)),this.add(this.createDamageText());const i=e.add.spine(0,25,"short").setName("spine");this.add(i);const s=e.add.bitmapText(0,35,"Uni_Sans_Heavy_38px").setName("level").setOrigin(.5);k.bitmaps.Uni_Sans_Heavy_38px.overrideBitmapText(s),s.setLetterSpacing(-3),s.setText("0"),this.add(s),this.initInteractive(),this.setActive(!1),this.setVisible(!1),this.initChangeData(),G.on("tower-attack-play",this.playBonusAttack),G.on("tower-attack-stop",this.stopBonusAttack),G.on("tower-coins-play",this.playBonusCoins),G.on("tower-coins-stop",this.stopBonusCoins),this.selectAnim=e.add.sprite(0,0,"tower-select").setVisible(!1),this.add(this.selectAnim),G.on("tower-select-start",(e=>{this.active&&this.getData("type")===e.type&&this.getData("level")===e.level&&this.getData("id")!==e.id&&(this.selectAnim.setVisible(!0),this.selectAnim.play({key:"select",repeat:-1}))})),G.on("tower-select-stop",(()=>{this.selectAnim.setVisible(!1),this.selectAnim.stop()}))}create(e){this.setData(e),this.setName(e.id),this.getByName("level").setText(String(e.level)),this.getByName("range").setRadius(e.range),this.getData("damage-text").setText(`${Math.floor(e.damage)}`);const t=this.getByName("spine");t.setSkeleton(e.type,this.scene.game.cache.json.get(e.type)),t.play("Attack/Idle",!0);const i=Math.min(9,Math.floor(+e.level/3))+1;t.setSkinByName(`Skin${i}`);const[s,n]=D[e.id];this.setPosition(s,n-10),this.setDepth(this.defineDepth(e.id)),this.getByName("base").setTexture(`ui-${e.type}-base/${e.rise}`),this.setActive(!0),this.setVisible(!0)}update(e){for(let t in e)this.getData(t)!==e[t]&&this.setData(t,e[t])}playShoot(){const e=this.getByName("spine");e.play("Attack/Attack",!1,!0),e.once("complete",(()=>{e.play("Attack/Idle",!0)}))}createDamageText(){const e=this.scene.add.image(0,-5,"characters-damage").setOrigin(1,.5).setScale(.8),t=this.scene.add.bitmapText(0,0,"Uni_Sans_Heavy_24_green").setOrigin(0,.5);return this.setData("damage-text",t),k.bitmaps.Uni_Sans_Heavy_24_green.overrideBitmapText(t),t.setLetterSpacing(-3),t.setText("0"),this.scene.add.container(0,-75,[e,t]).setName("damage-container").setVisible(!1)}initInteractive(){this.setInteractive(new Phaser.Geom.Rectangle(-50,-50,100,100),Phaser.Geom.Rectangle.Contains),this.scene.input.setDraggable(this),this.scene.input.on("drag",((e,t,i,s)=>{if(t!==this)return;const n=this.scene.cameras.main.width,a=this.scene.cameras.main.height,r=n/10,o=a/10;e.x>n-r||e.x<r||e.y>a-o||e.y<o||this.setPosition(i,s)})),this.scene.input.on("dragstart",((e,t)=>{if(t!==this)return;const i=this.getData("id");this.engine.holdTower(i,!0),this.getByName("range").setVisible(!0),this.getByName("damage-container").setVisible(!0),this.scene.events.emit("trash-show"),this.setDepth(Math.pow(9,10)+1),G.emit("tower-select-start",{type:this.getData("type"),level:this.getData("level"),id:this.getData("id")})})),this.scene.input.on("dragend",((e,t)=>{if(t!==this)return;const i=this.getData("id");this.engine.events.emit("move-tower",{id:i,x:this.x,y:this.y}),this.getByName("range").setVisible(!1),this.getByName("damage-container").setVisible(!1),this.scene.events.emit("trash-hide"),this.setDepth(this.defineDepth(i)),G.emit("tower-select-stop")}))}initChangeData(){this.on("changedata-level",(function(e,t){if(!e.active)return;e.getByName("level").setText(String(t));const i=Math.min(9,Math.floor(e.getData("level")/3))+1;e.getByName("spine").setSkinByName(`Skin${i}`)})),this.on("changedata-range",(function(e,t){e.active&&e.getByName("range").setRadius(t)})),this.on("changedata-type",(function(e,t){if(!e.active)return;const i=e.getByName("spine");i.setSkeleton(t,e.scene.game.cache.json.get(t)),i.play("Attack/Idle",!0);const s=Math.min(9,Math.floor(e.getData("level")/3))+1;i.setSkinByName(`Skin${s}`);const n=e.getData("rise");e.getByName("base").setTexture(`ui-${t}-base/${n}`),e.engine.events.emit("hole-type",{id:e.getData("id"),type:t})})),this.on("changedata-rise",(function(e,t){if(!e.active)return;const i=e.getData("type");e.getByName("base").setTexture(`ui-${i}-base/${t}`)})),this.on("changedata-damage",(function(e,t){if(!e.active)return;const i=e.getData("damage");e.getData("damage-text").setText(`${Math.floor(i)}`)})),this.engine.events.on("tower-upgrade",(e=>{e.id==this.getData("id")&&(window.navigator.vibrate(50),this.playDamage(e.damage),this.playMerge(),w.play("effect-merge.wav"))})),this.engine.events.on("tower-create",(e=>{if(e!=this.getData("id"))return;const t=this.scene.add.sprite(0,0,"tower-spawn").play({key:"spawn",repeat:0}).setDepth(Math.pow(9,10)+1).setOrigin(.5,.55);this.add(t),this.moveBelow(t,this.getByName("level")),w.play("effect-spawn.wav"),t.on("animationcomplete",(()=>{try{t.destroy()}catch(e){console.warn("Tower.ts => 235")}}))}))}defineDepth(e){return e<4?2e3:e<8?3650:e<12?6100:e<16?7950:1e4}playDamage(e){const t=this.scene.add.image(-15,-80,"characters-damage").setOrigin(1,.5).setAlpha(0),i=this.scene.add.bitmapText(-15,-75,"Uni_Sans_Heavy_24_green").setOrigin(0,.5).setAlpha(0);k.bitmaps.Uni_Sans_Heavy_24_green.overrideBitmapText(i),i.setLetterSpacing(-3),i.setText(`+${Math.floor(e)}`),this.add(t),this.add(i),this.scene.tweens.add({targets:[t,i],duration:200,alpha:1}),this.scene.tweens.timeline({targets:t,duration:500,tweens:[{scale:{from:0,to:1}},{scale:{from:1,to:.6}}]}).add({targets:[i,t],duration:200,alpha:0,y:"-=40",onComplete:()=>{i.destroy(),t.destroy()}})}playMerge(){const e=this.scene.add.sprite(0,0,"tower-merge").play({key:"merge",repeat:0}).setDepth(Math.pow(9,10)+1).setOrigin(.5,.55);this.add(e),this.moveBelow(e,this.getByName("level")),e.on("animationcomplete",(()=>{e.setVisible(!1),this.scene.time.delayedCall(100,(()=>{e.destroy()}))}))}}class X extends Phaser.GameObjects.Group{constructor(e){super(e),this.engine=e.engine,this.engine.events.on("move-tower",(e=>{this.engine.holdTower(e.id,!1);const t=this.getTower(e.id);this.engine.events.emit("hole-type",{id:t.getData("id"),type:"hole"}),this.killAndHide(t)})),this.engine.events.on("move-tower",(e=>{w.play("effect-tower_sell.wav")}))}update(e){const t=new Phaser.Structs.Set;e.towers.objects.forEach((i=>{let s=this.getTower(i[0]);s||(s=this.createTower(i[1]),e.game.extra.coins.counter&&G.emit("tower-coins-play"),e.game.extra.attack.counter&&G.emit("tower-attack-play")),s.update(i[1]),t.set(s)})),this.children.difference(t).each((e=>{e.active&&(this.engine.events.emit("hole-type",{id:e.getData("id"),type:"hole"}),this.killAndHide(e))}))}getTower(e){return new Phaser.Structs.Set(this.getMatching("name",e)).get("active",!0)}getTowerPos(e){const t=this.getTower(e);return{x:null==t?void 0:t.x,y:null==t?void 0:t.y,type:null==t?void 0:t.getData("type")}}playShoot(e){const t=this.getTower(e);t&&t.playShoot()}findTowers(e){const t=e.type,i=e.level,s=[];return this.children.each((e=>{e.getData("type")===t&&e.getData("level")===i&&e.active&&s.push(e)})),s}createTower(e){let t=this.getFirstDead();return t||(t=new J(this.scene,this.engine),this.add(t,!0)),t.create(e),this.engine.events.emit("hole-type",{id:e.id,type:e.type}),this.emit("create-tower",t.getData("type")),t}}class Y extends Phaser.GameObjects.Sprite{constructor(e,t){super(e,0,0,t),this.setName(t),this.setOrigin(.9,.5),this.setDepth(Math.pow(11,11)),this.destroy(),e.add.existing(this)}create(e,t,i){return this.setActive(!0),this.scene.time.delayedCall(Y.offsets[i].delay,(()=>{this.active&&this.setVisible(!0)})),this.setPosition(e+Y.offsets[i].x,t+Y.offsets[i].y),this.setScale(.7),this}moveTo(e,t,i){const s=Phaser.Math.Angle.Between(this.x,this.y,e,t),n=Phaser.Math.RadToDeg(s);return this.setAngle(n),new Promise((s=>{this.scene.tweens.add({targets:this,alpha:0,delay:600,duration:100}),this.scene.tweens.add({targets:this,x:e,y:t,delay:Y.offsets[i].delay,duration:700-Y.offsets[i].delay,onComplete:()=>{s(this)}})}))}destroy(){return this.setVisible(!1),this.setActive(!1),this.setPosition(0,0),this.setAlpha(1),this.setScale(1),this.setRotation(0),this}}Y.offsets={poison:{x:50,y:20,delay:200},freaze:{x:30,y:-40,delay:0},long:{x:30,y:-40,delay:200},short:{x:50,y:20,delay:250}};class Q{constructor(e){this.scene=e,this.bullets=e.add.group(),new h(8,(()=>this.createBullet())),this.redDamages=e.add.group(),new h(8,(()=>this.createRedDamage()))}playBullet(e,t,i){const s=this.getBullet();return s.create(e.x,e.y,i),s.play({key:i,repeat:-1}),s.moveTo(t.x,t.y,i).then((()=>(s.destroy(),!0)))}playRedDamage(e,t,i){const s=this.getRedDamage();s.setVisible(!0),s.setActive(!0),s.setAlpha(1),s.setPosition(e,t),s.setText(`-${i}`),this.scene.tweens.add({targets:[s],y:"-=25",alpha:0,duration:500,onComplete:()=>{s.setVisible(!1),s.setActive(!1)}})}getBullet(){let e=this.bullets.getFirstDead(!1,0,0);return e||(e=this.createBullet()),e}createBullet(){const e=new Y(this.scene,"tower-bullets");return this.bullets.add(e),e}getRedDamage(){let e=this.redDamages.getFirstDead(!1,0,0);return e||(e=this.createRedDamage()),e}createRedDamage(){const e=this.scene.add.bitmapText(0,-20,"Uni_Sans_Heavy_14px_red").setOrigin(.5).setDepth(Math.pow(12,12));return k.bitmaps.Uni_Sans_Heavy_14px_red.overrideBitmapText(e),this.redDamages.add(e),e.setLetterSpacing(-4),e.setText("-0"),e}}class Z extends Phaser.Scene{constructor(){super({key:"Game"}),this.create_game=e=>{this.holes=new K(this),this.towers=new X(this),this.enemys=new q(this),this.initEvents(),this.holes.create(e),this.towers.update(e),this.enemys.update(e),_.gameReady(),this.game.events.emit("need-resize"),x.emit("resize"),this.scene.get("Boot").scene.stop(),this.towers.on("create-tower",(e=>{this.smallTutorial(500,e)}))},this.update_game=e=>{this.towers.update(e),this.enemys.update(e)}}init(){this.engine=new F(this,this.create_game,this.update_game)}create(){this.add.image(422,692,"ui-background").setDepth(-2),this.scene.launch("UI",this),this.particles=new Q(this);const e=window.localStorage.getItem("merge-heroes-save");e?this.onSaveRestore(e)||(console.log("Save was corrupted, starting a new game"),this.newGame()):this.newGame(),this.add.image(190,265,"ui-counter").setScale(.9);const t=this.add.bitmapText(191,248,"Uni_Sans_Heavy_22px").setOrigin(.5);k.bitmaps.Uni_Sans_Heavy_22px.overrideBitmapText(t),t.setLetterSpacing(-4),t.setText("0"),this.engine.events.on("enemy-count",(e=>{t.setText(`${e.count}`)})),this.createTraining();const i=this.createTrash();i.set(100,100);const s=(e,t)=>{const s=Math.max(...t.enemys.map((e=>e.t)));s>.59&&this.smallTutorial(500,"freeze"),s>.77&&this.smallTutorial(500,"meteor");const n=Math.floor(e.health);i.value!==n&&(i.value<n?this.time.delayedCall(1500,(()=>{i.set(n,n)})):(i.set(n,n),100!==e.health&&(t.events.map((e=>e.event)).includes("game-reward")||(this.playDanger(),w.playThrottle(`base_damage-${b.between(1,4)}.wav`,600)))))};this.engine.events.on("game-start",s),this.engine.events.on("game-update",s),this.time.delayedCall(200,(()=>{this.game.events.emit("need-resize")})),w.play("effect-background.mp3",{loop:!0})}getHolePos(e){return this.holes.getContains(e)}playDanger(){if(this.danger_timeline&&1!==this.danger_timeline.totalProgress)return;const e=(e,t)=>{const i=t.alpha.toFixed(2);var s;(s=document.getElementById("danger"))&&s.style.opacity!==i&&s.style.setProperty("opacity",`${i}`)};this.danger_timeline=this.tweens.timeline({targets:[{alpha:0}],duration:500,tweens:[{alpha:1,onUpdate:e},{alpha:0,onUpdate:e}]})}initEvents(){let e;this.engine.events.on("enemy-hit",(e=>{const t=this.towers.getTowerPos(e.tower);t&&(this.towers.playShoot(e.tower),this.enemys.shoot(e.enemy,t))})),this.engine.events.on("move-tower",(t=>{let i=this.getHolePos(t);if(isNaN(i))return Phaser.Geom.Circle.ContainsPoint(new Phaser.Geom.Circle(C,A,50),t)?(this.engine.emitEvent("remove-tower",t.id),this.engine.removeTower(t.id)):void 0;this.engine.holdTower(i,!1),this.engine.moveTower(t.id,i),e&&e.stop()})),this.engine.events.on("game-reward",(e=>{this.time.delayedCall(1e3,(()=>{this.scene.launch("Reward",[this,e])}))})),this.engine.events.on("tower-create",(t=>{if(JSON.parse(localStorage.getItem("merge-heroes-tutorial")||"{}").handTowers)return;const i=this.towers.getTower(t);if(!i)return;const s=i.getData("type"),n=i.getData("level"),a=this.towers.findTowers({type:s,level:n});if(a.length<2)return;e&&e.stop();const r=this.add.image(0,0,"ui-hand").setScale(-1,-1);r.setDepth(Math.pow(100,100)),e=this.add.tween({targets:r,x:{from:a[1].x,to:a[0].x},y:{from:a[1].y+50,to:a[0].y+50},duration:1e3,ease:Phaser.Math.Easing.Cubic.InOut,repeat:-1,onStop:()=>{r.destroy()}})})),this.engine.events.on("tower-upgrade",(()=>{if(!e)return;e.stop();const t=JSON.parse(localStorage.getItem("merge-heroes-tutorial")||"{}");t.handTowers||(t.handTowers=!0,localStorage.setItem("merge-heroes-tutorial",JSON.stringify(t)))}))}onSaveRestore(e){try{var t=JSON.parse(atob(e));this.engine.start(t)}catch(e){return!1}return!t.timestamp||(Math.min((Date.now()-t.timestamp)/1e3/60/60,12)<3||(this.engine.once("enemy-count",(()=>{this.engine.emitEvent("player-count-offlinereward")})),this.engine.once("game-counted-offlinereward",(e=>{this.scene.launch("Reward_offline",[this,e])}))),!0)}createTraining(){const[e,t]=[195,1080],i=this.add.image(e,t-50,"ui-hand").setVisible(!1).setActive(!1);this.events.on("hand-show",(()=>{i.setVisible(!0).setActive(!0),i.setData("tween",this.tweens.add({targets:[i],y:"-=50",duration:400,yoyo:!0,repeat:-1}))})),this.events.on("hand-hide",(()=>{var e;i.setVisible(!1).setActive(!1),null===(e=i.getData("tween"))||void 0===e||e.stop();const t=JSON.parse(localStorage.getItem("merge-heroes-tutorial")||"{}");t.hand=!0,localStorage.setItem("merge-heroes-tutorial",JSON.stringify(t))}));const s=this.add.image(e,t,"ui-training").setScale(.9).setDepth(-1);new B(s).click((()=>{w.play("button-click.wav"),this.physics.pause(),this.scene.launch("Upgrade",[this,this.engine.state()]),this.events.emit("hand-hide")}));const n=this.add.image(e+35,t-50,"ui-warning").setVisible(!1);(e=>{this.engine.events.on("coins-start",e),this.engine.events.on("coins-update",e)})(((e,t)=>{const s=[];["freaze","poison","long","short"].forEach((e=>{const i=t.towers.levels[e];i>=10||s.push(z.coins.upgradePrice(i))}));const a=Math.min(...s);if(n.setVisible(s.length>0&&e>a),n.visible&&!i.visible){if(JSON.parse(localStorage.getItem("merge-heroes-tutorial")||"{}").hand)return;this.events.emit("hand-show")}}))}createTrash(){this.add.circle(C,A,50,4095,.5),this.add.image(C,A,"ui-сastle").setDepth(Math.pow(9,9));const e=this.add.sprite(C,A,"game-trash").setDepth(Math.pow(9,9)+1).play({key:"trash",repeat:-1}).setVisible(!1).setActive(!1);this.events.on("trash-show",(()=>e.setVisible(!0).setActive(!0))),this.events.on("trash-hide",(()=>e.setVisible(!1).setActive(!1)));const t=new j(this,C,1090,["ui-castle_frame","ui-castle_filler"],!1).fill(1507072).setDepth(Math.pow(9,9));return t.set(1,1),t.bitmap.y+=35,t}smallTutorial(e,t){const i=JSON.parse(localStorage.getItem("merge-heroes-tutorial")||"{}");i[t]||(i[t]=!0,localStorage.setItem("merge-heroes-tutorial",JSON.stringify(i)),this.time.delayedCall(e,(()=>{this.scene.pause(),this.scene.launch("SmallTutorial",[this,t])})))}newGame(){this.engine.start(),this.time.delayedCall(2500,(()=>{this.scene.launch("Help",[this])}))}}class ee extends Phaser.Scene{constructor(){super({key:"Help"}),this.max_list=5,this.buttons={},this.exit=()=>{const e=this.mainScene;setTimeout((()=>{this.setList(0),this.scene.stop(),setTimeout((()=>{e.scene.resume()}),10)}),10)}}init(e){this.mainScene=e[0]}create(){this.mainScene.scene.pause(),this.createShadow(),this.add.image(y,v,"ui-tutorial/body"),this.add.text(y,245,"TUTORIAL",{fontFamily:"Uni_Sans_Heavy",fontSize:"58px",color:"#f0c91b",stroke:"#232322",strokeThickness:6}).setOrigin(.5),this.add.text(167,1155,"v1.0.1",{fontFamily:"Uni_Sans_Heavy",fontSize:"28px",color:"#fff1ca"}),this.createButtons(),this.createLists(),this.setList(ee.list)}createShadow(){this.add.rectangle(y,v,3416,5560,0,.75).setInteractive()}createButtons(){this.buttons.exit=new B(this.add.image(694,200,"buttons-exit")).click((()=>{w.play("button-click.wav"),this.exit()})),this.buttons.left=new B(this.add.image(252,1140,"buttons-left")).click((()=>{w.play("button-click.wav"),this.slideList(-1)})),this.buttons.dot0=new B(this.add.image(ee.dots[0].x,ee.dots[0].y,"buttons-dot-off")).click((()=>{w.play("button-click.wav"),this.setList(0)})),this.buttons.dot1=new B(this.add.image(ee.dots[1].x,ee.dots[1].y,"buttons-dot-off")).click((()=>{w.play("button-click.wav"),this.setList(1)})),this.buttons.dot2=new B(this.add.image(ee.dots[2].x,ee.dots[2].y,"buttons-dot-off")).click((()=>{w.play("button-click.wav"),this.setList(2)})),this.buttons.dot3=new B(this.add.image(ee.dots[3].x,ee.dots[3].y,"buttons-dot-off")).click((()=>{w.play("button-click.wav"),this.setList(3)})),this.buttons.dot4=new B(this.add.image(ee.dots[4].x,ee.dots[4].y,"buttons-dot-off")).click((()=>{w.play("button-click.wav"),this.setList(4)})),this.buttons.dot4=new B(this.add.image(ee.dots[5].x,ee.dots[5].y,"buttons-dot-off")).click((()=>{w.play("button-click.wav"),this.setList(5)})),this.buttons.right=new B(this.add.image(602,1140,"buttons-right")).click((()=>{w.play("button-click.wav"),this.slideList(1)})),this.buttons.play_now=new B(this.add.image(y,ee.dots[2].y,"buttons-play-now").setDepth(3).setVisible(!1)).click((()=>{w.play("button-click.wav"),this.exit()}))}createLists(){this.lists=[],this.lists.push(this.add.container(0,0,[this.add.image(437,720,`ui-tutorial/body-${this.lists.length}`),this.add.image(527,925,"ui-tutorial/body-hand-1"),this.add.image(ee.dots[this.lists.length].x,ee.dots[this.lists.length].y,"buttons-dot-on"),this.add.text(y,395,"FOUR HERO TYPES ARE\nDEFENDING YOUR CASTLE.",ee.text_style).setOrigin(.5),this.add.text(y,1035,"BUY A RANDOM HERO!",ee.text_style).setOrigin(.5)]).setVisible(!1)),this.lists.push(this.add.container(0,0,[this.add.image(437,720,`ui-tutorial/body-${this.lists.length}`),this.add.image(ee.dots[this.lists.length].x,ee.dots[this.lists.length].y,"buttons-dot-on"),this.add.text(y,395,"MERGE HEROES TOGETHER\nTO CREATE STRONGER UNITS!",ee.text_style).setOrigin(.5)]).setVisible(!1)),this.lists.push(this.add.container(0,0,[this.add.image(417,720,`ui-tutorial/body-${this.lists.length}`),this.add.image(ee.dots[this.lists.length].x,ee.dots[this.lists.length].y,"buttons-dot-on"),this.add.text(y,395,"UPGRADE THE HERO SPAWNER\nTO GET HIGHER-LEVEL HEROES.",ee.text_style).setOrigin(.5)]).setVisible(!1)),this.lists.push(this.add.container(0,0,[this.add.image(422,760,`ui-tutorial/body-${this.lists.length}`),this.add.image(ee.dots[this.lists.length].x,ee.dots[this.lists.length].y,"buttons-dot-on"),this.add.text(y,365,"Use the right heroes\n to get a 50% damage bonus!",ee.text_style).setOrigin(.5)]).setVisible(!1)),this.lists.push(this.add.container(0,0,[this.add.image(y,v,`ui-tutorial/body-${this.lists.length}`),this.add.image(ee.dots[this.lists.length].x,ee.dots[this.lists.length].y,"buttons-dot-on")]).setVisible(!1)),this.lists.push(this.add.container(0,0,[this.add.image(397,760,`ui-tutorial/body-${this.lists.length}`),this.add.image(ee.dots[this.lists.length].x,ee.dots[this.lists.length].y,"buttons-dot-on"),this.add.text(y,395,"DESTROY HEROES YOU NO\nLONGER NEED.",ee.text_style).setOrigin(.5)]).setVisible(!1))}slideList(e){this.setList(ee.list+e)}setList(e){ee.list=e<0?this.max_list:e%(this.max_list+1),this.lists.forEach(((e,t)=>{e.setVisible(t===ee.list)})),Object.keys(this.buttons).forEach((e=>{this.buttons[e].element.setVisible("play_now"!==e)})),0===ee.list&&this.buttons.left.element.setVisible(!1),ee.list===this.max_list&&(this.buttons.right.element.setVisible(!1),this.buttons.play_now.element.setVisible(!0))}}ee.list=0,ee.text_style={fontFamily:"Uni_Sans_Heavy",fontSize:"28px",color:"#753514",align:"center"},ee.dots=[{x:327,y:1140},{x:367,y:1140},{x:407,y:1140},{x:447,y:1140},{x:487,y:1140},{x:527,y:1140}];class te extends Phaser.Scene{constructor(){super({key:"Reward"})}init(e){this.mainScene=e[0],this.reward=e[1]}create(){this.mainScene.scene.pause(),this.add.rectangle(y,v,3416,5560,0,.75).setInteractive(),this.add.image(y,875,"ui-reward-box").setVisible(this.reward.coins>1),this.add.image(327,890,"ui-coin").setVisible(this.reward.coins>1),this.reward_text=this.add.text(y,887,`${l(Math.floor(this.reward.coins))}`,{fontFamily:"Uni_Sans_Heavy",fontSize:"36px",stroke:"#000000",strokeThickness:4}).setOrigin(.5).setVisible(this.reward.coins>1),this.reward.coins>0?(_.levelComplete(this.reward.level-1),_.sendScore(this.reward.level-1),this.create_reward(),w.play("level-win.wav")):(_.gameOver(),this.create_lose(),w.play("level-fail.wav"))}create_reward(){if(this.add.image(y,468,"ui-victory"),this.add.text(y,765,`LEVEL ${this.reward.level-1} COMPLETE`,{fontFamily:"Uni_Sans_Heavy",fontSize:"36px",stroke:"#000000",strokeThickness:4,align:"center"}).setOrigin(.5),1===this.reward.coins)return this.create_part_win();if(2===this.reward.coins);else if(this.reward.level%4!=1)return this.create_part_win();let e;const t=this.create_part_win((()=>{this.mainScene.engine.askLevelReward(),_.clear()})),i=()=>{t.element.setPosition(317,1038).setScale(.8),e=new B(this.add.image(537,1038,"buttons-claim2").setScale(.8)).click(((e,t)=>{t.setTexture("buttons-claim2-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-claim2"),_.showAdFn()}))}))};_.adEnabled?i():_.beforeReward=i,_.beforeBreak=()=>{this.scene.pause(),w.pause()},_.adComplete=()=>{this.mainScene.engine.askLevelReward(!0),t.element.setPosition(y,1038),e&&e.element.destroy(),this.reward_text.setText(l(Math.floor(2*this.reward.coins)))},_.adDismissed=()=>{t.element.setPosition(y,1038),e&&e.element.destroy()},_.afterBreak=()=>{this.scene.resume(),w.resume()}}create_lose(){this.add.image(429,522,"ui-defeat"),this.add.text(y,765,`LEVEL ${this.reward.level} FAILED`,{fontFamily:"Uni_Sans_Heavy",fontSize:"36px",stroke:"#000000",strokeThickness:4,align:"center"}).setOrigin(.5),new B(this.add.image(y,1038,"buttons-again").setScale(.8)).click(((e,t)=>{t.setTexture("buttons-again-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-again"),this.exit()}))}))}create_part_win(e=new Function){return new B(this.add.image(y,1038,"buttons-claim").setScale(1)).click(((t,i)=>{i.setTexture("buttons-claim-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{i.setTexture("buttons-claim"),e(),this.exit()}))}))}exit(){const e=this.mainScene;setTimeout((()=>{this.scene.stop(),setTimeout((()=>{e.scene.resume()}),10)}),10)}}class ie extends Phaser.Scene{constructor(){super({key:"Reward_offline"})}init(e){this.mainScene=e[0],this.reward=e[1]}create(){this.mainScene.scene.pause(),this.add.rectangle(y,v,3416,5560,0,.75),this.add.image(y,700,"ui-offline-board"),this.add.image(327,885,"ui-coin"),new B(this.add.image(687,269,"buttons-exit"));const e=l(Math.floor(this.reward));this.add.text(y,885,`${e}`,{fontFamily:"Uni_Sans_Heavy",fontSize:"36px",stroke:"#000000",strokeThickness:4}).setOrigin(.5),this.create_reward()}create_reward(){let e;const t=new B(this.add.image(y,1038,"buttons-claim").setScale(.8)).click(((e,t)=>{t.setTexture("buttons-claim-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-claim"),this.mainScene.engine.askOfflineReward(),_.clear(),this.exit()}))})),i=()=>{t.element.setPosition(317,1038),e=new B(this.add.image(537,1038,"buttons-claim2").setScale(.8)).click(((e,t)=>{t.setTexture("buttons-claim2-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-claim2"),_.showAdFn()}))}))};_.adEnabled?i():_.beforeReward=i,_.beforeBreak=()=>{this.scene.pause(),w.pause()},_.adComplete=()=>{this.mainScene.engine.askOfflineReward(!0),this.exit()},_.adDismissed=()=>{t.element.setPosition(y,1038),e&&e.destroy()},_.afterBreak=()=>{this.scene.resume(),w.resume()}}exit(){const e=this.mainScene;setTimeout((()=>{this.scene.stop(),setTimeout((()=>{e.scene.resume()}),10)}),10)}}class se extends Phaser.Scene{constructor(){super({key:"SmallTutorial"}),this.exit=()=>{setTimeout((()=>{this.scene.stop(),setTimeout((()=>{this.parent.scene.resume()}),10)}),10)}}init(e){this.parent=e[0],this.type=e[1]}create(){this.add.rectangle(y,v,3416,4548,0,.75).setInteractive(),this.add.image(y,v,`ui-tutorial/frame-${this.type}`),new B(this.add.image(y,925,"buttons-ok").setScale(.8)).click((()=>this.exit())),new B(this.add.image(697,485,"buttons-exit")).click((()=>this.exit()))}}class ne{constructor(e,t,i,s){this.level=0,this.scene=e,this.frame=e.add.image(0,20,"ui-frame_level").setName("frame"),this.bounds=this.frame.getBounds(),this.container=new Phaser.GameObjects.Container(e,i,s,[this.frame]),this.create(),e.add.existing(this.container)}setLevel(e,t){this.level!==e&&(this.level=e,t-=1,this.container.list.forEach(((i,s)=>{"frame"!==i.name&&(e>s&&i.unlock(4*t+s),e===s&&i.current(4*t+e),e<s&&i.lock())})))}create(){const e=this.bounds.width/2-6,t=this.bounds.height/2-7;new Phaser.Geom.Line(-e,0,e,0).getPoints(8).forEach(((e,i)=>{if(!(i%2))return;const s=Math.floor(i/2)+1;this.container.add(new ae(this.scene,e.x,t,s))}))}}class ae extends Phaser.GameObjects.Container{constructor(e,t,i,s){super(e,t,i),this.isBoss=!(s%4);const n=this.isBoss?"ui-boss_level":"ui-unlocked_level";if(this.image=e.add.image(0,0,n),this.add(this.image),this.setScale(.9),this.isBoss)return this;this.text=e.add.bitmapText(0,5,"Uni_Sans_Heavy_22px").setOrigin(.5),k.bitmaps.Uni_Sans_Heavy_22px.overrideBitmapText(this.text),this.text.setLetterSpacing(-3),this.text.setText(`${s}`),this.add(this.text)}lock(){this.isBoss||(this.text.setVisible(!1),this.image.setTexture("ui-locked_level"))}unlock(e){this.isBoss||(this.text.setVisible(!0),this.text.setText(`${e}`),this.image.setTexture("ui-unlocked_level"))}current(e){this.isBoss||(this.text.setVisible(!0),this.text.setText(`${e}`),this.image.setTexture("ui-current_level"))}}class re extends Phaser.GameObjects.Container{constructor(e,t,i,s){super(e,t,i,[]),this.enabled=!0,this.event=new Phaser.Events.EventEmitter,this.data=new Phaser.Data.DataManager(this,this.event),this.create_button(s),this.create_timer(s),this.event.on("show-timer",(()=>this.enabled=!1)),this.event.on("hide-timer",(()=>this.enabled=!0))}click(e){return this.event.on("click",e),this}onShow(e){this.event.on("show-timer",e)}onHide(e){this.event.on("hide-timer",e)}setText(e){return this.event.emit("edit-timer",e),this}create_button(e){this.image=this.scene.add.image(0,0,e);const t=new B(this.image).click(((t,i)=>{this.enabled&&(w.play("button-click.wav"),i.setTexture(`${e}-press`),this.scene.time.delayedCall(100,(()=>{i.setTexture(e)})),this.event.emit("click"))}));this.event.on("enable",(()=>t.enable())),this.event.on("disable",(()=>t.disable())),this.add(this.image)}create_timer(e){const t=this.scene.add.container(0,0,[]).setVisible(!1);this.event.on("show-timer",(()=>t.setVisible(!0))),this.event.on("hide-timer",(()=>t.setVisible(!1))),t.add(this.scene.add.image(0,0,e).setTint(0).setAlpha(.3)),t.add(this.scene.add.image(-2,0,"buttons-timer")),t.add(this.scene.add.image(-2,0,"buttons-timer").setTint(0).setAlpha(.3)),t.add(this.scene.add.image(0,10,"ui-clock-body"));const i=this.scene.add.image(0,14,"ui-clock-arrow");let s;t.add(i.setOrigin(.8,.5)),this.event.on("show-timer",(()=>{s=this.scene.tweens.addCounter({from:0,to:360,duration:2e3,repeat:-1,onUpdate:(e,t)=>{i.setAngle(t.value)}})})),this.event.on("hide-timer",(()=>{null==s||s.stop()}));const n=this.scene.add.bitmapText(-1,-35,"Uni_Sans_Heavy_22px").setOrigin(.5);k.bitmaps.Uni_Sans_Heavy_22px.overrideBitmapText(n),n.setText("--:--"),n.setLetterSpacing(-2),t.add(n),this.event.on("edit-timer",(e=>{if(e===this.data.get("tick"))return;const i=r(e),s=this.format(i);n.setText(s),this.data.set("tick",e),e<=0&&t.visible&&this.event.emit("hide-timer"),e>0&&!t.visible&&this.event.emit("show-timer")})),this.add(t)}format(e){const t=~~((e=Math.floor(e/1e3))/60),i=e%60;return`${t<10?`0${t}`:t}:${i<10?`0${i}`:i}`}}class oe extends Phaser.Scene{constructor(){super({key:"UI"}),this.update_ui=e=>{const t=this.texts.get("level"),i=`${e.tower_level}`;(null==t?void 0:t.text)!==i&&(null==t||t.setText(i));const s=this.texts.get("price"),n=l(e.price);(null==s?void 0:s.text)!==n&&(null==s||s.setText(n));const a=this.texts.get("freaze");null==a||a.setText(e.extra.freaze.counter);const r=this.texts.get("meteor");null==r||r.setText(e.extra.meteor.counter);const o=this.texts.get("coins");null==o||o.setText(e.extra.coins.counter);const h=this.texts.get("attack");null==h||h.setText(e.extra.attack.counter);const c=this.bottom.getByName("tower_button").getByName("image");e.coins<=e.price?(c.setTexture("buttons-character-disabled"),c.setData("texture","buttons-character-disabled")):(c.setTexture("buttons-character"),c.setData("texture","buttons-character"))}}init(e){this.parent=e,this.engine=e.engine,this.texts=new Map,e.events.on("resume",(()=>{this.gamesnacks()}))}create(){const e=this.create_top_buttons(),t=this.create_bottom_buttons();this.engine.events.on("game-start",this.update_ui),this.engine.events.on("game-update",this.update_ui),this.time.delayedCall(500,(()=>{this.game.events.emit("need-resize")})),this.top=e,this.bottom=t,this.gamesnacks(),_.init()}create_top_buttons(){const e=this.add.container(0,0,[]);x.on("resize-after",(t=>{e.y=m*(1-t)/2}));const t=this.add.image(158,36,`buttons-sound-${w.getVolume()}`);new B(t).click(((e,t)=>{t.setTexture(`buttons-sound-${w.getVolume()}-press`),this.time.delayedCall(100,(()=>{w.play("button-click.wav"),w.setVolume(0===w.getVolume()?1:0),t.setTexture(`buttons-sound-${w.getVolume()}`)}))}));const i=this.add.image(220,36,"buttons-help");new B(i).click(((e,t)=>{t.setTexture("buttons-help-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-help")})),this.time.delayedCall(200,(()=>{this.scene.launch("Help",[this.parent])}))}));const s=this.add.image(552,34,"ui-coin").setOrigin(.3,.5),n=this.add.image(552,34,"ui-coin_frame").setOrigin(0,.5),a=this.add.bitmapText(585,39,"Uni_Sans_Heavy_22px").setOrigin(0,.5);k.bitmaps.Uni_Sans_Heavy_22px.overrideBitmapText(a),a.setLetterSpacing(-3),a.setText("0"),this.engine.events.on("coins-start",(e=>{a.setData("current",Math.floor(e)),a.setText(`${l(Math.floor(e))}`)})),this.engine.events.on("coins-update",(e=>{const t=a.getData("current"),i=Math.floor(e);a.setData("current",i),t>i?a.setText(`${l(i)}`):(w.play("effect-money.wav"),this.tweens.timeline({targets:[s],duration:500,ease:Phaser.Math.Easing.Bounce.InOut,tweens:[{scale:1.3},{scale:1}]}),this.tweens.addCounter({from:t,to:i,duration:500,onUpdate:(e,t)=>{a.setText(`${l(Math.floor(t.value))}`)}}))}));const r=new ne(this,1,407,15);return this.engine.events.on("game-start",(e=>{r.setLevel(e.level,e.stage)})),this.engine.events.on("game-update",(e=>{r.setLevel(e.level,e.stage)})),e.add([t,i,n,s,a,r.container]),e}create_bottom_buttons(){const e=this.add.container(427,m,[]);x.on("resize-after",(t=>{e.y=m-m*(1-t)/2}));const t=this.add.image(0,0,"ui-bottom_frame").setOrigin(.5,1);e.add(t);const i=this.create_freeze_button(e),s=this.create_meteor_button(e),{level:n,price:a}=this.create_tower_button(e),r=this.create_coins_button(e),o=this.create_attack_button(e);this.create_tower_upgrade(e);const l={freaze:i,meteor:s,level:n,price:a,coins:r,attack:o};return Object.keys(l).forEach((e=>{this.texts.set(e,l[e])})),e}create_freeze_button(e){const t=new re(this,-260,-65,"buttons-freeze");return t.click((()=>{this.parent.engine.events.emit("buttons-freeze"),w.play("button-click.wav"),this.time.delayedCall(200,(()=>w.play("button-freeze.wav")))})),e.add(t),t}create_meteor_button(e){const t=new re(this,-155,-65,"buttons-meteor");return t.click((()=>{this.parent.engine.events.emit("ui-buttons-meteor"),w.play("button-click.wav"),this.time.delayedCall(200,(()=>w.play("button-meteor.wav")))})),e.add(t),t}create_tower_button(e){const t=this.add.container(0,0,[]).setName("tower_button"),i=this.add.image(0,-75,"buttons-character").setName("image");i.setData("texture","buttons-character"),new B(i).click(((e,s)=>{var n;i.getData("texture").includes("disabled")||s.setTexture("buttons-character-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{s.setTexture(i.getData("texture"))})),this.parent.engine.events.emit("buttons-tower"),(n=t.getData("tutorial"))&&n.stop();const a=JSON.parse(localStorage.getItem("merge-heroes-tutorial")||"{}");a.spawn||(a.spawn=!0,localStorage.setItem("merge-heroes-tutorial",JSON.stringify(a)))}));const s=this.add.image(0,-125,"ui-hand").setVisible(!1).setActive(!1);JSON.parse(localStorage.getItem("merge-heroes-tutorial")||"{}").spawn||t.setData("tutorial",this.tweens.add({targets:[t],scale:{from:1,to:1.05},ease:Phaser.Math.Easing.Bounce.InOut,duration:400,repeat:-1,yoyo:!0,onStart:()=>{t.setData("tutorial2",this.tweens.add({targets:[s],y:"-=50",duration:400,repeat:-1,yoyo:!0,onStart:()=>{s.setVisible(!0),s.setActive(!0)},onStop:()=>{s.setVisible(!1),s.setActive(!1)}}))},onStop:()=>{t.getData("tutorial2").stop()}}));const n=this.add.bitmapText(0,-113,"Uni_Sans_Heavy_44px").setOrigin(.45,.5);k.bitmaps.Uni_Sans_Heavy_44px.overrideBitmapText(n),n.setLetterSpacing(-3),n.setText("0");const a=this.add.bitmapText(0,-23,"Uni_Sans_Heavy_22px").setOrigin(.45,.5);return k.bitmaps.Uni_Sans_Heavy_22px.overrideBitmapText(a),a.setLetterSpacing(-3),a.setText("0"),t.add([i,n,a,s]),e.add(t),{level:n,price:a}}create_tower_upgrade(e){const t=this.add.container(0,-330,[]).setScale(.75).setVisible(!1),i=this.add.image(0,0,"ui-upgrade-spawner").setScale(2),s=this.add.image(0,70,"ui-upgrade-price").setScale(.85),n=this.add.image(-77,70,"ui-coin"),a=this.add.image(40,-10,"ui-upgrade/arrow").setScale(.75);this.events.on("upgrade-lock-levels",(()=>{s.setPosition(0,20),n.setPosition(-77,20),a.setPosition(40,-46)})),this.events.on("upgrade-lock-money",(()=>{s.setPosition(0,70),n.setPosition(-77,70),a.setPosition(40,-10)})),this.events.on("upgrade-unlock",(()=>{s.setPosition(0,70),n.setPosition(-77,70),a.setPosition(40,-10)})),t.add([i,s,n,a]),this.create_tower_upgrade_buttons(e,t),this.create_tower_upgrade_text(t),e.add([t])}create_tower_upgrade_buttons(e,t){const i=this.add.text(2,159,"",{fontFamily:"Uni_Sans_Heavy",fontSize:"33px",color:"#ffffff"}).setOrigin(.5),s=new B(this.add.image(0,160,"buttons-upgrade")).on("click",((e,t)=>{t.setTexture("buttons-upgrade-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{e.enabled&&t.setTexture("buttons-upgrade")})),this.engine.upgrade_spawn((()=>{}))})).on("enable",((e,t)=>{t.setTexture("buttons-upgrade")})).on("disable",((e,t)=>{t.setTexture("buttons-level-disabled")})).on("lock",((e,t)=>{t.setTexture("buttons-level-locked")})),n=new B(this.add.image(200,-160,"buttons-exit")).click(((e,i)=>{i.setTexture("buttons-exit-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{i.setTexture("buttons-exit"),t.setVisible(!1)}))})),a=this.add.image(82,-125,"buttons-up-arrow").setData("lock",0),r=this.add.image(117,-155,"ui-warning").setVisible(!1);a.setData("run_tween",(()=>{a.setData("tween",this.tweens.add({targets:a,scale:{from:1,to:1.15},yoyo:!0,repeat:-1,ease:Phaser.Math.Easing.Bounce.InOut,duration:500,onStart:()=>{r.setVisible(!0)},onStop:()=>{r.setVisible(!1)}}))})),a.getData("run_tween")();const o=new B(a).click(((e,i)=>{e.enabled&&(i.getData("lock")||i.setTexture("buttons-up-arrow-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{i.getData("lock")||i.setTexture("buttons-up-arrow"),t.setVisible(!t.visible)})))})).on("unlock",((e,t)=>{t.setTexture("buttons-up-arrow"),t.setData("lock",0),a.getData("run_tween")()})).on("lock",((e,t)=>{t.setTexture("buttons-up-arrow-disabled"),t.setData("lock",1),t.getData("tween").stop()}));this.engine.events.on("game-update",(e=>{const{stage:t,level:n,tower_level:r}=e,l=z.spawn.tower.price_upgrade(r);return r>=z.level.calcLevel(t,n)/2?(i.setText("     LOCKED"),i.setVisible(!0),s.disable(),o.emit("lock"),void this.events.emit("upgrade-lock-levels")):l>e.coins?(i.setText("Upgrade"),i.setVisible(!0),s.disable(),o.emit("lock"),s.emit("lock"),void this.events.emit("upgrade-lock-money")):(s.enabled||(i.setVisible(!1),s.enable()),a.getData("lock")&&o.emit("unlock"),void this.events.emit("upgrade-unlock"))})),t.add([s.element,n.element,i]),e.add([o.element,r])}create_tower_upgrade_text(e){const t=this.add.bitmapText(-20,-6,"Uni_Sans_Heavy_28_brown").setOrigin(1,.5);k.bitmaps.Uni_Sans_Heavy_28_brown.overrideBitmapText(t);const i=this.add.bitmapText(110,-6,"Uni_Sans_Heavy_28_green").setOrigin(.5);k.bitmaps.Uni_Sans_Heavy_28_green.overrideBitmapText(i);const s=this.add.text(0,70,"",{fontFamily:"Uni_Sans_Heavy",fontSize:"28px",color:"#ffd97a"}).setOrigin(.5),n=this.add.bitmapText(0,80,"Uni_Sans_Heavy_28_brown").setOrigin(.5);k.bitmaps.Uni_Sans_Heavy_28_brown.overrideBitmapText(n),n.setText("Complete Level X"),this.engine.events.on("game-update",(e=>{t.setText(`LEVEL ${e.tower_level}`),i.setText(`${e.tower_level+1}`),n.setText("Complete Level "+2*e.tower_level);const a=z.spawn.tower.price_upgrade(e.tower_level);s.setText(l(a))})),this.events.on("upgrade-lock-levels",(()=>{n.setVisible(!0),t.setPosition(-20,-40),i.setPosition(110,-40),s.setPosition(0,20)})),this.events.on("upgrade-lock-money",(()=>{n.setVisible(!1),t.setPosition(-20,-6),i.setPosition(110,-6),s.setPosition(0,70)})),this.events.on("upgrade-unlock",(()=>{n.setVisible(!1),t.setPosition(-20,-6),i.setPosition(110,-6),s.setPosition(0,70)})),e.add([t,i,s,n])}create_coins_button(e){const t=new re(this,155,-65,"buttons-coins");return t.event.on("enable",(()=>t.image.setTexture("buttons-coins"))),t.event.on("disable",(()=>t.image.setTexture("buttons-coins-disabled"))),t.data.set("callback-click",(()=>{})),t.onShow((()=>{G.emit("tower-coins-play")})),t.onHide((()=>{G.emit("tower-coins-stop")})),t.event.on("success-click",(()=>{this.parent.engine.events.emit("buttons-coins"),this.time.delayedCall(200,(()=>w.play("button-booster.wav")))})),t.click((()=>{w.play("button-click.wav"),t.data.get("callback-click")()})),e.add(t),t}create_attack_button(e){const t=new re(this,260,-65,"buttons-attack");return t.event.on("enable",(()=>t.image.setTexture("buttons-attack"))),t.event.on("disable",(()=>t.image.setTexture("buttons-attack-disabled"))),t.data.set("callback-click",(()=>{})),t.onShow((()=>{G.emit("tower-attack-play")})),t.onHide((()=>{G.emit("tower-attack-stop")})),t.event.on("success-click",(()=>{this.parent.engine.events.emit("buttons-attack"),this.time.delayedCall(200,(()=>w.play("button-booster.wav")))})),t.click((()=>{w.play("button-click.wav"),t.data.get("callback-click")()})),e.add(t),t}create_debug(){const e=(e,t=!0)=>{const i=this.add.circle(e.x,e.y,10,16711680,1);i.setInteractive().setDepth(1e3),t&&i.setData("vector",e),this.input.setDraggable(i)};P.getPoints(1).forEach((t=>e(t))),D.forEach(((t,i)=>e({x:t[0],y:t[1]},!1))),this.input.on("dragstart",((e,t)=>t.setFillStyle(255))),this.input.on("dragend",((e,t,i,s)=>{t.setFillStyle(255),console.log(`[${Math.floor(e.upX)}, ${Math.floor(e.upY)}]`)})),this.input.on("drag",((e,t,i,s)=>{t.setPosition(i,s),t.data&&t.data.get("vector").set(i,s)}));const t=this.add.graphics();this.events.on("update",(()=>{t.clear(),t.lineStyle(2,16777215,1),P.draw(t,64)}))}create_fps(e){const t=this.add.bitmapText(407,38,"Uni_Sans_Heavy_24_green").setOrigin(.5).setDepth(101);k.bitmaps.Uni_Sans_Heavy_24_green.overrideBitmapText(t),e.add(t),this.events.on("render",(function(e,i){t.visible&&t.setText(`FPS: ${Math.max(Math.trunc(e.game.loop.actualFps),30)}`)}))}gamesnacks(){const e=this.texts.get("coins"),t=this.texts.get("attack"),i=()=>{e.event.emit("enable"),e.data.set("clicked",!1),e.data.set("callback-click",(()=>{e.data.set("clicked",!0),_.showAdFn()})),t.event.emit("enable"),t.data.set("clicked",!1),t.data.set("callback-click",(()=>{t.data.set("clicked",!0),_.showAdFn()}))};_.adEnabled?i():(e.event.emit("disable"),t.event.emit("disable"),_.beforeReward=i),_.beforeBreak=()=>{var e;null===(e=this.parent)||void 0===e||e.scene.pause(),w.pause()},_.adComplete=()=>{e.data.get("clicked")&&(e.data.set("clicked",!1),e.event.emit("success-click")),t.data.get("clicked")&&(t.data.set("clicked",!1),t.event.emit("success-click"))},_.adDismissed=()=>{e.event.emit("disable"),t.event.emit("disable")},_.afterBreak=()=>{var e;null===(e=this.parent)||void 0===e||e.scene.resume(),w.resume(),setTimeout((()=>function(e,t){function i(e,t){for(var i in t)e[i]=t[i];return e}var s={HTMLEvents:/^(?:load|unload|abort|error|select|change|submit|reset|focus|blur|resize|scroll)$/,MouseEvents:/^(?:click|dblclick|mouse(?:down|up|over|move|out))$/},n={pointerX:0,pointerY:0,button:0,ctrlKey:!1,altKey:!1,shiftKey:!1,metaKey:!1,bubbles:!0,cancelable:!0};!function(e,t){var a,r=i(n,arguments[2]||{}),o=null;for(var l in s)if(s[l].test(t)){o=l;break}if(!o)throw new SyntaxError("Only HTMLEvents and MouseEvents interfaces are supported");document.createEvent?(a=document.createEvent(o),"HTMLEvents"==o?a.initEvent(t,r.bubbles,r.cancelable):a.initMouseEvent(t,r.bubbles,r.cancelable,document.defaultView,r.button,r.pointerX,r.pointerY,r.pointerX,r.pointerY,r.ctrlKey,r.altKey,r.shiftKey,r.metaKey,r.button,e),e.dispatchEvent(a)):(r.clientX=r.pointerX,r.clientY=r.pointerY,a=i(document.createEventObject(),r),e.fireEvent("on"+t,a))}(e,"click")}(document.body)),100)}}}const le={lists:[{name:"Mage",type:"freaze",char:"ui-freaze/${level}",base:"ui-freaze-base/${rise}",params:["level","freeze","range","speed"]},{name:"Assassin",type:"poison",char:"ui-poison/${level}",base:"ui-poison-base/${rise}",params:["level","poison","range","speed"]},{name:"Archer",type:"long",char:"ui-long/${level}",base:"ui-long-base/${rise}",params:["level","critical","range","speed"]},{name:"Warrior",type:"short",char:"ui-short/${level}",base:"ui-short-base/${rise}",params:["level","splash","range","speed"]}]};class he extends Phaser.Scene{constructor(){super({key:"Upgrade"})}init(e){this.mainScene=e[0],this.state=e[1]}create(){this.add.rectangle(y,v,3416,5560,0,.3).setInteractive(),this.container=this.add.container(y,v,[]),this.container.add(this.add.image(0,0,"ui-upgrade/board")),this.create_logo(this.container),this.create_texts(this.container),this.create_priority(this.container),this.create_buttons(this.container),this.create_info(this.container),this.events.once(Phaser.Scenes.Events.SHUTDOWN,(()=>{this.events.off("list-in")}))}create_logo(e){const t=this.add.image(7,-110,"ui-freaze-base/1"),i=this.add.image(0,-188,"ui-freaze/1");e.add([t,i]);const s=e=>{const s=le.lists[e.to].type,n=this.state.towers.levels[s],a=(()=>{const e=this.state.towers.objects.map((e=>e[1].type===s?e[1].level:1));return Math.min(Math.floor(Math.max(...e)/3)+1,10)})();t.setVisible(!0),t.setTexture(le.lists[e.to].base.replace("${rise}",`${n}`)),i.setTexture(le.lists[e.to].char.replace("${level}",`${a}`))};s({from:he.list,to:he.list}),this.events.on("list-in",s)}create_texts(e){const t=this.add.text(10,-388.5,le.lists[he.list].name,he.fontTitle).setOrigin(.5);e.add(t),this.events.on("list-in",(e=>{t.setText(le.lists[e.to].name)})),e.add(this.create_line(110,0)),e.add(this.create_line(165,1)),e.add(this.create_line(220,2)),e.add(this.create_line(275,3)),e.add(this.create_price())}create_line(e,t){const i=le.lists[he.list].params[t],s=this.add.container(0,e,[]),n=this.add.image(-175,0,`ui-upgrade/${i}`).setScale(.5),a=this.add.bitmapText(-135,4,"Uni_Sans_Heavy_28_brown").setOrigin(0,.5),o=this.add.bitmapText(30,4,"Uni_Sans_Heavy_28_brown").setOrigin(.5);k.bitmaps.Uni_Sans_Heavy_28_brown.overrideBitmapText(a),k.bitmaps.Uni_Sans_Heavy_28_brown.overrideBitmapText(o);const l=this.add.image(105,0,"ui-upgrade/arrow").setScale(.7),h=this.add.bitmapText(175,4,"Uni_Sans_Heavy_28_green").setOrigin(.5);k.bitmaps.Uni_Sans_Heavy_28_green.overrideBitmapText(h),s.add([n,l,a,o,h]);const c=e=>{const i=le.lists[e.to].params[t];if(!i)return s.setVisible(!1);s.setVisible(!0),a.setText(i),n.setTexture(`ui-upgrade/${i}`);const l=le.lists[e.to].type,c=this.state.towers.levels[l];if("level"===i)return o.setText(`${this.state.towers.levels[l]}`),void h.setText(`${Math.min(10,this.state.towers.levels[l]+1)}`);if("damage"===i){const e=z.spawn.tower[l].damage;return o.setText(`${Math.ceil(e*(c/10+1))}`),void h.setText(`${Math.ceil(e*(Math.min(10,c+1)/10+1))}`)}if("speed"===i)return o.setText(89+11*c+"%"),void h.setText(89+11*Math.min(10,c+1)+"%");if("poison"===i){const e=z.spawn.ability.poison.duration,t=e/20;return o.setText(`${Number(r(e+t*c)/1e3).toFixed(1)}s`),void h.setText(`${Number(r(e+t*Math.min(10,c+1))/1e3).toFixed(1)}s`)}if("freeze"===i){const e=z.spawn.ability.freaze.duration,t=e/20;return o.setText(`${Number(r(e+t*c)/1e3).toFixed(1)}s`),void h.setText(`${Number(r(e+t*Math.min(10,c+1))/1e3).toFixed(1)}s`)}return"critical"===i||"splash"===i?(o.setText(1*c+"%"),void h.setText(1*Math.min(10,c+1)+"%")):"range"===i?(o.setText(89+11*c+"%"),void h.setText(89+11*Math.min(10,c+1)+"%")):void 0};return this.events.on("list-in",c),c({from:he.list,to:he.list}),i||s.setVisible(!1),s}create_priority(e){const t=this.add.container(0,0,[]),i=this.add.bitmapText(0,4,"Uni_Sans_Heavy_34_brown").setOrigin(.5);k.bitmaps.Uni_Sans_Heavy_34_brown.overrideBitmapText(i),i.setText("Attack Priority");const s=this.add.image(-175,50,"ui-upgrade/first-off"),n=this.add.image(-57,50,"ui-upgrade/last-off"),a=this.add.image(62,50,"ui-upgrade/strong-off"),r=this.add.image(180,50,"ui-upgrade/weak-off"),o=()=>{s.setTexture("ui-upgrade/first-off"),n.setTexture("ui-upgrade/last-off"),a.setTexture("ui-upgrade/strong-off"),r.setTexture("ui-upgrade/weak-off")};new B(s).click((()=>{o(),s.setTexture("ui-upgrade/first-on");const e=le.lists[he.list].type;this.mainScene.engine.towerPriorityChange(e,"first"),this.state.towers.priority[e]="first"})),new B(n).click((()=>{o(),n.setTexture("ui-upgrade/last-on");const e=le.lists[he.list].type;this.mainScene.engine.towerPriorityChange(e,"last"),this.state.towers.priority[e]="last"})),new B(a).click((()=>{o(),a.setTexture("ui-upgrade/strong-on");const e=le.lists[he.list].type;this.mainScene.engine.towerPriorityChange(e,"strong"),this.state.towers.priority[e]="strong"})),new B(r).click((()=>{o(),r.setTexture("ui-upgrade/weak-on");const e=le.lists[he.list].type;this.mainScene.engine.towerPriorityChange(e,"weak"),this.state.towers.priority[e]="weak"}));const l={first:s,last:n,strong:a,weak:r};this.events.on("list-in",(e=>{const i=le.lists[e.to].type;if(t.setVisible(""!==i),!t.visible)return;o();const s=this.state.towers.priority[i];l[s].setTexture(`ui-upgrade/${s}-on`)})),t.add([i,s,n,a,r]),e.add(t)}create_price(){const e=this.add.container(0,340,[]);e.add(this.add.image(0,0,"ui-upgrade-price")),e.add(this.add.image(-85,0,"ui-coin").setScale(1.2));const t=this.add.text(0,0,"0",he.fontPrice).setOrigin(.5),i=i=>{const s=le.lists[i.to].type,n=this.state.towers;e.setVisible(!0);const a=this.state.towers.levels[s],r=z.coins.upgradePrice(a);t.setText(l(r)),e.setVisible(!(n.levels[s]>=10))};return i({from:he.list,to:he.list}),this.events.on("list-in",i),e.add(t),e}create_info(e){this.info=this.add.container(0,0,[]).setVisible(!1),this.info.add(this.add.image(0,0,"ui-upgrade/info"));const t=this.add.image(266,-448.5,"buttons-exit");return this.info.add(t),G.on("info-visible",(e=>{this.info.setVisible(e)})),new B(t).click(((e,t)=>{t.setTexture("buttons-exit-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-exit"),G.emit("info-visible",!1)}))})),e.add(this.info),this.info}create_buttons(e){e.add(this.create_exit()),e.add(this.create_left()),e.add(this.create_right()),e.add(this.create_upgrade()),e.add(this.create_info_btn())}create_exit(){const e=this.add.image(266,-448.5,"buttons-exit");return new B(e).click(((e,t)=>{t.setTexture("buttons-exit-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-exit"),this.exit()}))})),e}create_left(){const e=this.add.image(-240,-140,"buttons-left-new");return new B(e).click(((e,t)=>{t.setTexture("buttons-left-new"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-left-new"),this.setList(he.list-1)}))})),e}create_right(){const e=this.add.image(244,-140,"buttons-right-new");return new B(e).click(((e,t)=>{t.setTexture("buttons-right-new"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-right-new"),this.setList(he.list+1)}))})),e}create_upgrade(){const e=this.add.image(0,436.5,"buttons-upgrade"),t=this.add.text(0,436.5,"",he.fontUpgrade).setOrigin(.5),i=new B(e).click(((e,t)=>{t.setTexture("buttons-upgrade-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-upgrade"),this.upgrade()}))}));return this.events.on("list-in",(s=>{const n=le.lists[s.to].type,a=this.state.towers,r=this.state.towers.levels[n],o=z.coins.upgradePrice(r);return a.levels[n]>=10?(e.setTexture("buttons-level-locked"),t.setText("MAX"),t.setVisible(!0),void i.disable()):o>this.state.game.coins?(e.setTexture("buttons-level-locked"),t.setText("Upgrade"),t.setVisible(!0),void i.disable()):(e.setTexture("buttons-upgrade"),t.setVisible(!1),void i.enable())})),this.events.emit("list-in",{from:he.list,to:he.list}),G.on("info-visible",(t=>{e.setVisible(!t)})),[e,t]}create_info_btn(){const e=this.add.image(230,-10,"buttons-info");return new B(e).click(((e,t)=>{t.setTexture("buttons-info-press"),w.play("button-click.wav"),this.time.delayedCall(100,(()=>{t.setTexture("buttons-info"),G.emit("info-visible",!0)}))})),e}setList(e){const t=he.list;he.list=e<0?3:e%4,this.rotate(t,he.list)}upgrade(){const e=le.lists[he.list].type;if(""===e)this.mainScene.engine.upgrade_spawn((e=>{if(this.state.game.coins===e.game.coins)return console.log("Not enough coins");this.state=e,this.events.emit("list-in",{from:he.list,to:he.list}),this.mainScene.engine.events.emit("coins-update",e.game.coins,e)}));else{if(this.state.towers.levels[e]>=10)return;this.mainScene.engine.upgrade_towers(e,(e=>{if(this.state.game.coins===e.game.coins)return console.log("Not enough coins");this.state=e,this.events.emit("list-in",{from:he.list,to:he.list}),w.play("effect-upgrade.wav"),this.mainScene.engine.events.emit("coins-update",e.game.coins,e)}))}}rotate(e,t){this.tweens.timeline({targets:[this.container],duration:100,tweens:[{angle:2,scaleX:0,onComplete:()=>{this.events.emit("list-out",{from:e,to:t})}},{angle:0,scaleX:1,onStart:()=>{this.events.emit("list-in",{from:e,to:t})}}]})}exit(){this.mainScene.physics.resume(),this.scene.stop()}}he.list=0,he.fontTitle={fontFamily:"Uni_Sans_Heavy",fontSize:"58px",color:"#f0c91b",stroke:"#232322",strokeThickness:6},he.fontPrice={fontFamily:"Uni_Sans_Heavy",fontSize:"28px",color:"#ffd97a"},he.fontUpgrade={fontFamily:"Uni_Sans_Heavy",fontSize:"28px",color:"#ffffff"};var ce=i(312);document.title+=" v1.0.1",function(){for(const e of[Array,String])Object.defineProperty(e.prototype,"at",{value:function(e){if((e=Math.trunc(e)||0)<0&&(e+=this.length),!(e<0||e>=this.length))return this[e]},writable:!0,enumerable:!1,configurable:!0})}(),function(){for(const e of[Array])Object.defineProperty(e.prototype,"flat",{value:function e(t){if(!(t=isNaN(t)?1:Number(t)))return Array.prototype.slice.call(this);let i=[];return Array.prototype.reduce.call(this,(function(s,n){return Array.isArray(n)?s.push.apply(s,e.call(n,t-1)):s.push(n),i=s,s}),[]),i},writable:!0,enumerable:!1,configurable:!0})}();const de={type:Phaser.WEBGL,transparent:!0,scale:{parent:"phaser-game",mode:Phaser.Scale.NONE},width:854,height:1137,scene:[O,Z,oe,he,te,ie,ee,se],physics:{default:"arcade",arcade:{debug:!1,gravity:{x:0,y:0},fps:10}},plugins:{scene:[{key:"SpinePlugin",plugin:window.SpinePlugin,mapping:"spine"}]},callbacks:{postBoot:function(e){const t=()=>{((e,t)=>{const i=window.innerWidth,s=window.innerHeight,{maxWidth:n,maxHeight:a,minWidth:r,minHeight:o,callback:l}=t,h=s*(n/o)*(r/n),c=i<h?i:h,d=(c<h?c/(r/o):s)/o;e.scale.setZoom(d);const u=n,p=Math.max(o+(h-c),a);e.scale.setGameSize(u,p);const f=+e.canvas.style.height.replace("px","");l&&l({offsetY:s>f?1:s/f,zoom:d,currentWidth:c,currentMinWidth:h})})(e,{maxWidth:854,maxHeight:m,minWidth:640,minHeight:1137,callback:e=>{const{offsetY:t,zoom:i,currentWidth:s,currentMinWidth:n}=e,a=(e,t,i)=>{var s;const n=null===(s=document.getElementById(e))||void 0===s?void 0:s.style;n.zoom=t,n.display=i?"":"none"};a("vertical_background",i,Boolean(s<n)),a("horizontal_background",i,!Boolean(s<n)),x.emit("resize-after",t)}})};t(),window.addEventListener("resize",t),window.addEventListener("orientationchange",t),x.on("resize",t)}},autoRound:!0,desynchronized:!0,inputActivePointers:1,inputGamepad:!1,inputKeyboard:!1,powerPreference:"high-performance",premultipliedAlpha:!0,saveDrawingBuffer:!0};window.addEventListener("load",(()=>{window.GAMESNACKS||(window.GAMESNACKS={isAudioEnabled:()=>!0,subscribeToAudioUpdates:()=>{},sendScore:()=>{},gameOver:()=>{},levelComplete:()=>{},gameReady:()=>{},rewardedAdOpportunity:()=>{}}),new Phaser.Game(de).plugins.install("rexcharactercacheplugin",ce)}))},312:function(e,t,i){e.exports=function(){function e(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function t(e,t){for(var i=0;i<t.length;i++){var s=t[i];s.enumerable=s.enumerable||!1,s.configurable=!0,"value"in s&&(s.writable=!0),Object.defineProperty(e,s.key,s)}}function s(e,i,s){return i&&t(e.prototype,i),s&&t(e,s),e}function n(e){return(n=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)})(e)}function a(e,t){return(a=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e})(e,t)}function r(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}(e)}var o={setEventEmitter:function(e,t){return void 0===t&&(t=Phaser.Events.EventEmitter),this._privateEE=!0===e||void 0===e,this._eventEmitter=this._privateEE?new t:e,this},destroyEventEmitter:function(){return this._eventEmitter&&this._privateEE&&this._eventEmitter.shutdown(),this},getEventEmitter:function(){return this._eventEmitter},on:function(){return this._eventEmitter&&this._eventEmitter.on.apply(this._eventEmitter,arguments),this},once:function(){return this._eventEmitter&&this._eventEmitter.once.apply(this._eventEmitter,arguments),this},off:function(){return this._eventEmitter&&this._eventEmitter.off.apply(this._eventEmitter,arguments),this},emit:function(e){return this._eventEmitter&&e&&this._eventEmitter.emit.apply(this._eventEmitter,arguments),this},addListener:function(){return this._eventEmitter&&this._eventEmitter.addListener.apply(this._eventEmitter,arguments),this},removeListener:function(){return this._eventEmitter&&this._eventEmitter.removeListener.apply(this._eventEmitter,arguments),this},removeAllListeners:function(){return this._eventEmitter&&this._eventEmitter.removeAllListeners.apply(this._eventEmitter,arguments),this},listenerCount:function(){return this._eventEmitter?this._eventEmitter.listenerCount.apply(this._eventEmitter,arguments):0},listeners:function(){return this._eventEmitter?this._eventEmitter.listeners.apply(this._eventEmitter,arguments):[]},eventNames:function(){return this._eventEmitter?this._eventEmitter.eventNames.apply(this._eventEmitter,arguments):[]}},l={draw:function(e,t,i){var s=this.getFrameIndex(e);if(-1===s&&(s=this.getFrameIndex(void 0)),-1===s)return console.warn("Does not have free space."),this;var n=this.getTopLeftPosition(s),a={width:this.cellWidth,height:this.cellHeight},r=this.context;return r.save(),r.translate(n.x,n.y),r.clearRect(0,0,a.width,a.height),i?t.call(i,this.canvas,r,a):t(this.canvas,r,a),r.restore(),this.texture.add(e,0,n.x,n.y,a.width,a.height),this.addFrameName(s,e),this},paste:function(e,t){var i=t.canvas;if(!i)return console.warn("Can't get canvas of game object."),this;var s,n,a=i.width,r=i.height;if(a<=this.cellWidth&&r<=this.cellHeight)s=a,n=r;else{var o=Math.max(a/this.cellWidth,r/this.cellHeight);s=a/o,n=r/o}return this.draw(e,(function(e,t,a){t.drawImage(i,0,0,s,n),a.width=s,a.height=n})),this},addEmptyFrame:function(e,t,i){return void 0===t&&(t=this.cellWidth),void 0===i&&(i=this.cellHeight),this.draw(e,(function(e,s,n){n.width=t,n.height=i})),this},addToBitmapFont:function(){var e=this.texture.key,t=this.bitmapFontCache.get(e);t||(t={data:{retroFont:!0,font:e,size:this.cellWidth,lineHeight:this.cellHeight,chars:{}},texture:e,frame:null},this.bitmapFontCache.add(e,t));for(var i=t.data.chars,s=this.frameNames,n=0,a=s.length;n<a;n++){var r=s[n];if(void 0!==r){var o=this.texture.get(r),l=o.cutX,h=o.cutY,c=o.cutWidth,d=o.cutHeight;i[r.charCodeAt(0)]={x:l,y:h,width:c,height:d,centerX:l+c/2,centerY:h+d/2,xOffset:0,yOffset:0,xAdvance:c,data:{},kerning:{},u0:o.u0,v0:o.v0,u1:o.u1,v1:o.v1}}}return this}},h=Phaser.Utils.Objects.IsPlainObject,c=Phaser.Utils.Objects.GetValue,d=function(){function t(i,s,n,a,r,o,l){if(e(this,t),h(s)){var d=s;s=c(d,"key"),n=c(d,"width"),a=c(d,"height"),r=c(d,"cellWidth"),o=c(d,"cellHeight"),l=c(d,"fillColor")}if(void 0===n&&(n=4096),void 0===a&&(a=4096),void 0===r&&(r=64),void 0===o&&(o=64),this.texture=i.sys.textures.createCanvas(s,n,a),this.canvas=this.texture.getCanvas(),this.context=this.texture.getContext(),this.bitmapFontCache=i.sys.cache.bitmapFont,void 0!==l){var u=this.context;u.fillStyle=l,u.fillRect(0,0,this.canvas.width,this.canvas.height)}this.key=s,this.width=n,this.height=a,this.cellWidth=r,this.cellHeight=o,this.columnCount=Math.floor(n/r),this.rowCount=Math.floor(a/o),this.totalCount=this.columnCount*this.rowCount,this.frameNames=Array(this.totalCount);for(var p=0,f=this.frameNames.length;p<f;p++)this.frameNames[p]=void 0}return s(t,[{key:"destroy",value:function(){this.texture=void 0,this.canvas=void 0,this.context=void 0,this.frameNames=void 0,this.bitmapFontCache=void 0}},{key:"getFrameIndex",value:function(e){return this.frameNames.indexOf(e)}},{key:"hasFrameName",value:function(e){return-1!==this.getFrameIndex(e)}},{key:"addFrameName",value:function(e,t){return this.frameNames[e]=t,this}},{key:"isFull",get:function(){return-1===this.getFrameIndex(void 0)}},{key:"getTopLeftPosition",value:function(e,t){void 0===t&&(t={});var i=e%this.columnCount,s=Math.floor(e/this.rowCount);return t.x=i*this.cellWidth,t.y=s*this.cellHeight,t}},{key:"updateTexture",value:function(){return this.texture.refresh(),this}},{key:"remove",value:function(e){var t=this.getFrameIndex(e);return-1===t||(this.addFrameName(t,void 0),this.texture.remove(e)),this}},{key:"clear",value:function(){for(var e,t=this.frameNames.length;e<t;e++){var i=this.frameNames[e];void 0!==i&&(this.addFrameName(index,void 0),this.texture.remove(i))}return this}}]),t}();Object.assign(d.prototype,l);var u=Phaser.Utils.Objects.GetValue,p=void 0!==i.g?i.g:"undefined"!=typeof self?self:"undefined"!=typeof window?window:{};"function"==typeof p.setTimeout&&setTimeout,"function"==typeof p.clearTimeout&&clearTimeout,new Date;var f="undefined"!=typeof globalThis?globalThis:"undefined"!=typeof window?window:void 0!==i.g?i.g:"undefined"!=typeof self?self:{};function g(e,t){return e(t={exports:{}},t.exports),t.exports}function m(e,t){var i=w(t,"exclude",void 0),s=w(t,"lock",void 0),n=w(t,"freq",!1),a={alive:!0};return void 0!==i&&("string"==typeof i&&(i=i.split()),a.character={$nin:i}),void 0!==s&&(a.lock=s),n?e.chain().find(a).simplesort("freq",{desc:!0}).data():e.chain().find(a).data()}var y=g((function(e,t){e.exports=function(){function e(e,t){if(this.app="loki",this.options=t||{},void 0!==e&&(this.app=e),this.catalog=null,!this.checkAvailability())throw new Error("indexedDB does not seem to be supported for your environment")}function t(e){this.db=null,this.initializeLokiCatalog(e)}return e.prototype.closeDatabase=function(){this.catalog&&this.catalog.db&&(this.catalog.db.close(),this.catalog.db=null)},e.prototype.checkAvailability=function(){return!("undefined"==typeof indexedDB||!indexedDB)},e.prototype.loadKey=e.prototype.loadDatabase=function(e,i){var s=this.app,n=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKey(s,e,(function(e){if("function"==typeof i){if(0===e.id)return void i(null);i(e.val)}else console.log(e.val)})):this.catalog=new t((function(t){n.catalog=t,n.loadDatabase(e,i)}))},e.prototype.saveKey=e.prototype.saveDatabase=function(e,i,s){var n=this.app,a=this;function r(e){e&&!0===e.success?s(null):s(new Error("Error saving database")),a.options.closeAfterSave&&a.closeDatabase()}null!==this.catalog&&null!==this.catalog.db?this.catalog.setAppKey(n,e,i,r):this.catalog=new t((function(t){a.saveDatabase(e,i,r)}))},e.prototype.deleteKey=e.prototype.deleteDatabase=function(e,i){var s=this.app,n=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKey(s,e,(function(e){var t=e.id;0!==t?n.catalog.deleteAppKey(t,i):"function"==typeof i&&i({success:!0})})):this.catalog=new t((function(t){n.catalog=t,n.deleteDatabase(e,i)}))},e.prototype.deleteDatabasePartitions=function(e){var t=this;this.getDatabaseList((function(i){i.forEach((function(i){i.startsWith(e)&&t.deleteDatabase(i)}))}))},e.prototype.getKeyList=e.prototype.getDatabaseList=function(e){var i=this.app,s=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAppKeys(i,(function(t){for(var i=[],s=0;s<t.length;s++)i.push(t[s].key);"function"==typeof e?e(i):i.forEach((function(e){console.log(e)}))})):this.catalog=new t((function(t){s.catalog=t,s.getDatabaseList(e)}))},e.prototype.getCatalogSummary=function(e){this.app;var i=this;null!==this.catalog&&null!==this.catalog.db?this.catalog.getAllKeys((function(t){for(var i,s,n,a,r,o=[],l=0;l<t.length;l++)n=(i=t[l]).app||"",a=i.key||"",r=i.val||"",s=2*n.length+2*a.length+r.length+1,o.push({app:i.app,key:i.key,size:s});"function"==typeof e?e(o):o.forEach((function(e){console.log(e)}))})):this.catalog=new t((function(t){i.catalog=t,i.getCatalogSummary(e)}))},t.prototype.initializeLokiCatalog=function(e){var t=indexedDB.open("LokiCatalog",1),i=this;t.onupgradeneeded=function(e){var t=e.target.result;if(t.objectStoreNames.contains("LokiAKV")&&t.deleteObjectStore("LokiAKV"),!t.objectStoreNames.contains("LokiAKV")){var i=t.createObjectStore("LokiAKV",{keyPath:"id",autoIncrement:!0});i.createIndex("app","app",{unique:!1}),i.createIndex("key","key",{unique:!1}),i.createIndex("appkey","appkey",{unique:!0})}},t.onsuccess=function(t){i.db=t.target.result,"function"==typeof e&&e(i)},t.onerror=function(e){throw e}},t.prototype.getAppKey=function(e,t,i){var s=e+","+t,n=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("appkey").get(s);n.onsuccess=function(e){return function(t){var i=t.target.result;null==i&&(i={id:0,success:!1}),"function"==typeof e?e(i):console.log(i)}}(i),n.onerror=function(e){return function(t){if("function"!=typeof e)throw t;e({id:0,success:!1})}}(i)},t.prototype.getAppKeyById=function(e,t,i){this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").get(e).onsuccess=function(e,t){return function(i){"function"==typeof t?t(i.target.result,e):console.log(i.target.result)}}(i,t)},t.prototype.setAppKey=function(e,t,i,s){var n=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV"),a=n.index("appkey"),r=e+","+t,o=a.get(r);o.onsuccess=function(a){var r=a.target.result;null==r?r={app:e,key:t,appkey:e+","+t,val:i}:r.val=i;var l=n.put(r);l.onerror=function(e){return function(t){"function"==typeof e?e({success:!1}):(console.error("LokiCatalog.setAppKey (set) onerror"),console.error(o.error))}}(s),l.onsuccess=function(e){return function(t){"function"==typeof e&&e({success:!0})}}(s)},o.onerror=function(e){return function(t){"function"==typeof e?e({success:!1}):(console.error("LokiCatalog.setAppKey (get) onerror"),console.error(o.error))}}(s)},t.prototype.deleteAppKey=function(e,t){var i=this.db.transaction(["LokiAKV"],"readwrite").objectStore("LokiAKV").delete(e);i.onsuccess=function(e){return function(t){"function"==typeof e&&e({success:!0})}}(t),i.onerror=function(e){return function(t){"function"==typeof e?e({success:!1}):(console.error("LokiCatalog.deleteAppKey raised onerror"),console.error(i.error))}}(t)},t.prototype.getAppKeys=function(e,t){var i=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").index("app"),s=IDBKeyRange.only(e),n=i.openCursor(s);n.onsuccess=function(e,t){return function(i){var s=i.target.result;if(s){var n=s.value;e.push(n),s.continue()}else"function"==typeof t?t(e):console.log(e)}}([],t),n.onerror=function(e){return function(t){"function"==typeof e?e(null):(console.error("LokiCatalog.getAppKeys raised onerror"),console.error(t))}}(t)},t.prototype.getAllKeys=function(e){var t=this.db.transaction(["LokiAKV"],"readonly").objectStore("LokiAKV").openCursor();t.onsuccess=function(e,t){return function(i){var s=i.target.result;if(s){var n=s.value;e.push(n),s.continue()}else"function"==typeof t?t(e):console.log(e)}}([],e),t.onerror=function(e){return function(t){"function"==typeof e&&e(null)}}(e)},e}()})),v={},b=g((function(e,t){e.exports=function(){var e=Object.prototype.hasOwnProperty;function t(e){var s,n;if(Array.isArray(e)){for(n=0;n<e.length;n++)t(e[n]);i(e)}else if(null!==e&&"object"==typeof e){for(s in e)e.hasOwnProperty(s)&&t(e[s]);i(e)}}function i(e){Object.isFrozen(e)||Object.freeze(e)}function s(e){return Object.isFrozen(e)?m(e,"shallow"):e}var n={copyProperties:function(e,t){var i;for(i in e)t[i]=e[i]},resolveTransformObject:function(e,t,i){var s,a;if("number"!=typeof i&&(i=0),10<=++i)return e;for(s in e)"string"==typeof e[s]&&0===e[s].indexOf("[%lktxp]")?(a=e[s].substring(8),t.hasOwnProperty(a)&&(e[s]=t[a])):"object"==typeof e[s]&&(e[s]=n.resolveTransformObject(e[s],t,i));return e},resolveTransformParams:function(e,t){var i,s,a=[];if(void 0===t)return e;for(i=0;i<e.length;i++)s=m(e[i],"shallow-recurse-objects"),a.push(n.resolveTransformObject(s,t));return a},getIn:function(e,t,i){if(null!=e){if(!i)return e[t];if("string"==typeof t&&(t=t.split(".")),!Array.isArray(t))throw new Error("path must be a string or array. Found "+typeof t);for(var s=0,n=t.length;null!=e&&s<n;)e=e[t[s++]];return s&&s==n?e:void 0}}},a={aeq:r,lt:o,gt:l};function r(e,t){var i,s,n,a;if(e===t)return!0;if(!e||!t||!0===e||!0===t||e!=e||t!=t){switch(e){case void 0:case null:n=1;break;case!1:n=3;break;case!0:n=4;break;case"":n=5;break;default:n=e==e?9:0}switch(t){case void 0:case null:a=1;break;case!1:a=3;break;case!0:a=4;break;case"":a=5;break;default:a=t==t?9:0}if(9!==n||9!==a)return n===a}return i=Number(e),s=Number(t),i==i||s==s?i===s:(i=e.toString())==(s=t.toString())}function o(e,t,i){var s,n,a,r;if(!e||!t||!0===e||!0===t||e!=e||t!=t){switch(e){case void 0:case null:a=1;break;case!1:a=3;break;case!0:a=4;break;case"":a=5;break;default:a=e==e?9:0}switch(t){case void 0:case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=t==t?9:0}if(9!==a||9!==r)return a===r?i:a<r}return s=Number(e),n=Number(t),s==s&&n==n?s<n||!(n<s)&&i:s==s&&n!=n||(n!=n||s==s)&&(e<t||!(t<e)&&(e==t?i:(s=e.toString())<(n=t.toString())||s==n&&i))}function l(e,t,i){var s,n,a,r;if(!e||!t||!0===e||!0===t||e!=e||t!=t){switch(e){case void 0:case null:a=1;break;case!1:a=3;break;case!0:a=4;break;case"":a=5;break;default:a=e==e?9:0}switch(t){case void 0:case null:r=1;break;case!1:r=3;break;case!0:r=4;break;case"":r=5;break;default:r=t==t?9:0}if(9!==a||9!==r)return a===r?i:r<a}return s=Number(e),n=Number(t),s==s&&n==n?n<s||!(s<n)&&i:(s!=s||n==n)&&(n==n&&s!=s||t<e||!(e<t)&&(e==t?i:(s=e.toString(),(n=t.toString())<s||s==n&&i)))}function h(e,t,i){return a.aeq(e,t)?0:a.lt(e,t,!1)?i?1:-1:a.gt(e,t,!1)?i?-1:1:0}function c(e,t,i,s,n,a){var r,o=a||0,l=t[o],h=!1;if("object"==typeof e&&l in e&&(r=e[l]),o+1>=t.length)h=i(r,s,n);else if(Array.isArray(r))for(var d=0,u=r.length;d<u&&!0!==(h=c(r[d],t,i,s,n,o+1));d+=1);else h=c(r,t,i,s,n,o+1);return h}function d(t){return"string"==typeof t||Array.isArray(t)?function(e){return-1!==t.indexOf(e)}:"object"==typeof t&&null!==t?function(i){return e.call(t,i)}:null}function u(t,i,s){for(var n in i)if(e.call(i,n))return p[n](t,i[n],s);return!1}var p={$eq:function(e,t){return e===t},$aeq:function(e,t){return e==t},$ne:function(e,t){return t!=t?e==e:e!==t},$dteq:function(e,t){return a.aeq(e,t)},$gt:function(e,t){return a.gt(e,t,!1)},$gte:function(e,t){return a.gt(e,t,!0)},$lt:function(e,t){return a.lt(e,t,!1)},$lte:function(e,t){return a.lt(e,t,!0)},$jgt:function(e,t){return t<e},$jgte:function(e,t){return t<=e},$jlt:function(e,t){return e<t},$jlte:function(e,t){return e<=t},$between:function(e,t){return null!=e&&a.gt(e,t[0],!0)&&a.lt(e,t[1],!0)},$jbetween:function(e,t){return null!=e&&e>=t[0]&&e<=t[1]},$in:function(e,t){return-1!==t.indexOf(e)},$inSet:function(e,t){return t.has(e)},$nin:function(e,t){return-1===t.indexOf(e)},$keyin:function(e,t){return e in t},$nkeyin:function(e,t){return!(e in t)},$definedin:function(e,t){return void 0!==t[e]},$undefinedin:function(e,t){return void 0===t[e]},$regex:function(e,t){return t.test(e)},$containsString:function(e,t){return"string"==typeof e&&-1!==e.indexOf(t)},$containsNone:function(e,t){return!p.$containsAny(e,t)},$containsAny:function(e,t){var i=d(e);return null!==i&&(Array.isArray(t)?t.some(i):i(t))},$contains:function(e,t){var i=d(e);return null!==i&&(Array.isArray(t)?t.every(i):i(t))},$elemMatch:function(e,t){return!!Array.isArray(e)&&e.some((function(e){return Object.keys(t).every((function(i){var s=t[i];return"object"==typeof s&&s||(s={$eq:s}),-1!==i.indexOf(".")?c(e,i.split("."),u,t[i],e):u(e[i],s,e)}))}))},$type:function(e,t,i){var s=typeof e;return"object"===s&&(Array.isArray(e)?s="array":e instanceof Date&&(s="date")),"object"!=typeof t?s===t:u(s,t,i)},$finite:function(e,t){return t===isFinite(e)},$size:function(e,t,i){return!!Array.isArray(e)&&("object"!=typeof t?e.length===t:u(e.length,t,i))},$len:function(e,t,i){return"string"==typeof e&&("object"!=typeof t?e.length===t:u(e.length,t,i))},$where:function(e,t){return!0===t(e)},$not:function(e,t,i){return!u(e,t,i)},$and:function(e,t,i){for(var s=0,n=t.length;s<n;s+=1)if(!u(e,t[s],i))return!1;return!0},$or:function(e,t,i){for(var s=0,n=t.length;s<n;s+=1)if(u(e,t[s],i))return!0;return!1},$exists:function(e,t){return t?void 0!==e:void 0===e}};["$eq","$aeq","$ne","$dteq","$gt","$gte","$lt","$lte","$jgt","$jgte","$jlt","$jlte","$type"].forEach((function(e){var t=p[e];p["$"+e]=function(e,i,s){if("string"==typeof i)return t(e,s[i]);if("function"==typeof i)return t(e,i(s));throw new Error("Invalid argument to $$ matcher")}}));var g={$eq:p.$eq,$aeq:!0,$dteq:!0,$gt:!0,$gte:!0,$lt:!0,$lte:!0,$in:!0,$between:!0};function m(e,t){if(null==e)return null;var i;switch(t||"parse-stringify"){case"parse-stringify":i=JSON.parse(JSON.stringify(e));break;case"jquery-extend-deep":i=jQuery.extend(!0,{},e);break;case"shallow":i=Object.create(e.constructor.prototype),Object.keys(e).map((function(t){i[t]=e[t]}));break;case"shallow-assign":i=Object.create(e.constructor.prototype),Object.assign(i,e);break;case"shallow-recurse-objects":i=m(e,"shallow"),Object.keys(e).forEach((function(t){"object"==typeof e[t]&&"Object"===e[t].constructor.name?i[t]=m(e[t],"shallow-recurse-objects"):Array.isArray(e[t])&&(i[t]=function(e,t){for(var i=[],s=0,n=e.length;s<n;s++)i[s]=m(e[s],t);return i}(e[t],"shallow-recurse-objects"))}))}return i}function b(){try{return window&&void 0!==window.localStorage&&null!==window.localStorage}catch(e){return}}function w(){}function x(e,t){this.filename=e||"loki.db",this.collections=[],this.databaseVersion=1.5,this.engineVersion=1.5,this.autosave=!1,this.autosaveInterval=5e3,this.autosaveHandle=null,this.throttledSaves=!0,this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,this.throttledSavePending=!1,this.throttledCallbacks=[],this.verbose=!(!t||!t.hasOwnProperty("verbose"))&&t.verbose,this.events={init:[],loaded:[],flushChanges:[],close:[],changes:[],warning:[]},t&&t.hasOwnProperty("env")?this.ENV=t.env:this.ENV=void 0!==f&&(f.android||f.NSObject)?"NATIVESCRIPT":"undefined"==typeof window||void 0!==f&&f.window&&void 0!=={}?"NODEJS":"undefined"==typeof document?"CORDOVA":-1!==document.URL.indexOf("http://")||-1!==document.URL.indexOf("https://")?"BROWSER":"CORDOVA","undefined"===this.ENV&&(this.ENV="NODEJS"),this.configureOptions(t,!0),this.on("init",this.clearChanges)}function k(e){this.hashStore={},this.options=e||{},this.options.hasOwnProperty("asyncResponses")||(this.options.asyncResponses=!1),this.options.hasOwnProperty("asyncTimeout")||(this.options.asyncTimeout=50)}function _(e,t){if(this.mode="reference",this.adapter=null,this.options=t||{},this.dbref=null,this.dbname="",this.pageIterator={},!e)throw new Error("LokiPartitioningAdapter requires a (non-reference mode) adapter on construction");if("reference"===e.mode)throw new Error("LokiPartitioningAdapter cannot be instantiated with a reference mode adapter");this.adapter=e,this.options.hasOwnProperty("paging")||(this.options.paging=!1),this.options.hasOwnProperty("pageSize")||(this.options.pageSize=26214400),this.options.hasOwnProperty("delimiter")||(this.options.delimiter="$<\n")}function S(){try{this.fs=v}catch(e){this.fs=null}}function O(){}function I(e,t){return this.collection=e,this.filteredrows=[],this.filterInitialized=!1,this}function T(e,t,i){this.collection=e,this.name=t,this.rebuildPending=!1,this.options=i||{},this.options.hasOwnProperty("persistent")||(this.options.persistent=!1),this.options.hasOwnProperty("sortPriority")||(this.options.sortPriority="passive"),this.options.hasOwnProperty("minRebuildInterval")||(this.options.minRebuildInterval=1),this.resultset=new I(e),this.resultdata=[],this.resultsdirty=!1,this.cachedresultset=null,this.filterPipeline=[],this.collection.disableFreeze||Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,this.sortDirty=!1,this.events={rebuild:[],filter:[],sort:[]}}function P(t,i){this.name=t,this.data=[],this.idIndex=null,this.binaryIndices={},this.constraints={unique:{},exact:{}},this.uniqueNames=[],this.transforms={},this.objType=t,this.dirty=!0,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null;var s=this;(i=i||{}).hasOwnProperty("unique")&&(Array.isArray(i.unique)||(i.unique=[i.unique]),i.unique.forEach((function(e){s.uniqueNames.push(e)}))),i.hasOwnProperty("exact")&&i.exact.forEach((function(e){s.constraints.exact[e]=new j(e)})),this.adaptiveBinaryIndices=!i.hasOwnProperty("adaptiveBinaryIndices")||i.adaptiveBinaryIndices,this.transactional=!!i.hasOwnProperty("transactional")&&i.transactional,this.cloneObjects=!!i.hasOwnProperty("clone")&&i.clone,this.cloneMethod=i.hasOwnProperty("cloneMethod")?i.cloneMethod:"parse-stringify",this.asyncListeners=!!i.hasOwnProperty("asyncListeners")&&i.asyncListeners,this.disableMeta=!!i.hasOwnProperty("disableMeta")&&i.disableMeta,this.disableChangesApi=!i.hasOwnProperty("disableChangesApi")||i.disableChangesApi,this.disableDeltaChangesApi=!i.hasOwnProperty("disableDeltaChangesApi")||i.disableDeltaChangesApi,this.disableChangesApi&&(this.disableDeltaChangesApi=!0),this.autoupdate=!!i.hasOwnProperty("autoupdate")&&i.autoupdate,this.serializableIndices=!i.hasOwnProperty("serializableIndices")||i.serializableIndices,this.disableFreeze=!i.hasOwnProperty("disableFreeze")||i.disableFreeze,this.ttl={age:null,ttlInterval:null,daemon:null},this.setTTL(i.ttl||-1,i.ttlInterval),this.maxId=0,this.DynamicViews=[],this.events={insert:[],update:[],"pre-insert":[],"pre-update":[],close:[],flushbuffer:[],error:[],delete:[],warning:[]},this.changes=[],this.dirtyIds=[];var n=[];if(i&&i.indices)if("[object Array]"===Object.prototype.toString.call(i.indices))n=i.indices;else{if("string"!=typeof i.indices)throw new TypeError("Indices needs to be a string or an array of strings");n=[i.indices]}for(var a=0;a<n.length;a++)this.ensureIndex(n[a]);function r(e,t){var i=null!==t&&"object"==typeof t?Object.keys(t):null;if(i&&i.length&&["string","boolean","number"].indexOf(typeof t)<0){for(var n={},a=0;a<i.length;a++){var o=i[a];if(t.hasOwnProperty(o))if(!e.hasOwnProperty(o)||0<=s.uniqueNames.indexOf(o)||"$loki"==o||"meta"==o)n[o]=t[o];else{var l=r(e[o],t[o]);void 0!==l&&l!={}&&(n[o]=l)}}return 0===Object.keys(n).length?void 0:n}return e===t?void 0:t}function o(){s.changes=[]}this.observerCallback=function(t){var i="function"==typeof Set?new Set:[];i.add||(i.add=function(e){return-1===this.indexOf(e)&&this.push(e),this}),t.forEach((function(e){i.add(e.object)})),i.forEach((function(t){if(!e.call(t,"$loki"))return s.removeAutoUpdateObserver(t);try{s.update(t)}catch(t){}}))},this.getChangeDelta=function(e,t){return t?r(t,e):JSON.parse(JSON.stringify(e))},this.getObjectDelta=r,this.getChanges=function(){return s.changes},this.flushChanges=o,this.setChangesApi=function(e){s.disableChangesApi=!e,e||(s.disableDeltaChangesApi=!1)},this.on("delete",(function(e){s.disableChangesApi||s.createChange(s.name,"R",e)})),this.on("warning",(function(e){s.lokiConsoleWrapper.warn(e)})),o()}function D(e){return-1!==e.indexOf(".")}function C(e){return parseFloat(e,10)}function A(e,t){return e+t}function E(e,t){return e-t}function M(e){return e.reduce(A,0)/e.length}function $(e,t,i){if(!1===i)return e[t];for(var s=t.split("."),n=e;0<s.length;)n=n[s.shift()];return n}function N(e,t,i){for(var s,n,a=0,r=e.length;a<r;){if(n=a+r>>1,0===(s=i.apply(null,[t,e[n]])))return{found:!0,index:n};s<0?r=n:a=1+n}return{found:!1,index:r}}function z(e){return function(t,i){return N(t,i,e)}}function B(){}function F(e){this.field=e,this.keyMap=Object.create(null),this.lokiMap=Object.create(null)}function j(e){this.index=Object.create(null),this.field=e}return w.prototype.events={},w.prototype.asyncListeners=!1,w.prototype.on=function(e,t){var i=this;return Array.isArray(e)?e.forEach((function(e){i.on(e,t)})):(this.events[e]||(this.events[e]=[])).push(t),t},w.prototype.emit=function(e){var t,i=this;if(!e||!this.events[e])throw new Error("No event "+e+" defined");this.events[e].length&&(t=Array.prototype.slice.call(arguments,1),this.events[e].forEach((function(e){i.asyncListeners?setTimeout((function(){e.apply(i,t)}),1):e.apply(i,t)})))},w.prototype.addListener=w.prototype.on,w.prototype.removeListener=function(e,t){var i=this;if(Array.isArray(e))e.forEach((function(e){i.removeListener(e,t)}));else if(this.events[e]){var s=this.events[e];s.splice(s.indexOf(t),1)}},((x.prototype=new w).constructor=x).prototype.getIndexedAdapter=function(){return y},x.prototype.configureOptions=function(e,t){var i={fs:S,localStorage:O,memory:k};if(this.options={},this.persistenceMethod=null,this.persistenceAdapter=null,void 0!==e){if(this.options=e,this.options.hasOwnProperty("persistenceMethod")&&"function"==typeof i[e.persistenceMethod]&&(this.persistenceMethod=e.persistenceMethod,this.persistenceAdapter=new i[e.persistenceMethod]),this.options.hasOwnProperty("adapter")&&(this.persistenceMethod="adapter",this.persistenceAdapter=e.adapter,this.options.adapter=null,this.isIncremental="incremental"===this.persistenceAdapter.mode),e.autoload&&t){var s=this;setTimeout((function(){s.loadDatabase(e,e.autoloadCallback)}),1)}this.options.hasOwnProperty("autosaveInterval")&&(this.autosaveDisable(),this.autosaveInterval=parseInt(this.options.autosaveInterval,10)),this.options.hasOwnProperty("autosave")&&this.options.autosave&&(this.autosaveDisable(),this.autosave=!0,this.options.hasOwnProperty("autosaveCallback")?this.autosaveEnable(e,e.autosaveCallback):this.autosaveEnable()),this.options.hasOwnProperty("throttledSaves")&&(this.throttledSaves=this.options.throttledSaves)}this.options.hasOwnProperty("serializationMethod")||(this.options.serializationMethod="normal"),this.options.hasOwnProperty("destructureDelimiter")||(this.options.destructureDelimiter="$<\n"),null===this.persistenceAdapter&&(this.persistenceMethod={NODEJS:"fs",BROWSER:"localStorage",CORDOVA:"localStorage",MEMORY:"memory"}[this.ENV],this.persistenceMethod&&(this.persistenceAdapter=new i[this.persistenceMethod]))},x.prototype.copy=function(e){var t,i,s=new x(this.filename,{env:"NA"});if(e=e||{},s.loadJSONObject(this,{retainDirtyFlags:!0}),e.hasOwnProperty("removeNonSerializable")&&!0===e.removeNonSerializable)for(s.autosaveHandle=null,s.persistenceAdapter=null,t=s.collections.length,i=0;i<t;i++)s.collections[i].constraints=null,s.collections[i].ttl=null;return s},x.prototype.addCollection=function(e,t){var i,s=this.collections.length;if(t&&!0===t.disableMeta){if(!1===t.disableChangesApi)throw new Error("disableMeta option cannot be passed as true when disableChangesApi is passed as false");if(!1===t.disableDeltaChangesApi)throw new Error("disableMeta option cannot be passed as true when disableDeltaChangesApi is passed as false");if("number"==typeof t.ttl&&0<t.ttl)throw new Error("disableMeta option cannot be passed as true when ttl is enabled")}for(i=0;i<s;i+=1)if(this.collections[i].name===e)return this.collections[i];var n=new P(e,t);return n.isIncremental=this.isIncremental,this.collections.push(n),this.verbose&&(n.lokiConsoleWrapper=console),n},x.prototype.loadCollection=function(e){if(!e.name)throw new Error("Collection must have a name property to be loaded");this.collections.push(e)},x.prototype.getCollection=function(e){var t,i=this.collections.length;for(t=0;t<i;t+=1)if(this.collections[t].name===e)return this.collections[t];return this.emit("warning","collection "+e+" not found"),null},x.prototype.renameCollection=function(e,t){var i=this.getCollection(e);return i&&(i.name=t),i},x.prototype.listCollections=function(){for(var e=this.collections.length,t=[];e--;)t.push({name:this.collections[e].name,type:this.collections[e].objType,count:this.collections[e].data.length});return t},x.prototype.removeCollection=function(e){var t,i=this.collections.length;for(t=0;t<i;t+=1)if(this.collections[t].name===e){var s=new P(e,{}),n=this.collections[t];for(var a in n)n.hasOwnProperty(a)&&s.hasOwnProperty(a)&&(n[a]=s[a]);return void this.collections.splice(t,1)}},x.prototype.getName=function(){return this.name},x.prototype.serializeReplacer=function(e,t){switch(e){case"autosaveHandle":case"persistenceAdapter":case"constraints":case"ttl":case"lokiConsoleWrapper":return null;case"throttledSavePending":case"throttledCallbacks":return;default:return t}},x.prototype.toJson=x.prototype.serialize=function(e){switch((e=e||{}).hasOwnProperty("serializationMethod")||(e.serializationMethod=this.options.serializationMethod),e.serializationMethod){case"normal":default:return JSON.stringify(this,this.serializeReplacer);case"pretty":return JSON.stringify(this,this.serializeReplacer,2);case"destructured":return this.serializeDestructured()}},x.prototype.serializeDestructured=function(e){var t,i,s,n,a,r=[];if((e=e||{}).hasOwnProperty("partitioned")||(e.partitioned=!1),e.hasOwnProperty("delimited")||(e.delimited=!0),e.hasOwnProperty("delimiter")||(e.delimiter=this.options.destructureDelimiter),!0===e.partitioned&&e.hasOwnProperty("partition")&&0<=e.partition)return this.serializeCollection({delimited:e.delimited,delimiter:e.delimiter,collectionIndex:e.partition});for((a=new x(this.filename)).loadJSONObject(this),t=0;t<a.collections.length;t++)a.collections[t].data=[];if(!0===e.partitioned&&-1===e.partition)return a.serialize({serializationMethod:"normal"});for(r.push(a.serialize({serializationMethod:"normal"})),a=null,t=0;t<this.collections.length;t++)if(s=this.serializeCollection({delimited:e.delimited,delimiter:e.delimiter,collectionIndex:t}),!1===e.partitioned&&!1===e.delimited){if(!Array.isArray(s))throw new Error("a nondelimited, non partitioned collection serialization did not return an expected array");for(n=s.length,i=0;i<n;i++)r.push(s[i]),s[i]=null;r.push("")}else r.push(s);return e.partitioned?(e.delimited,r):e.delimited?(r.push(""),r.join(e.delimiter)):(r.push(""),r)},x.prototype.serializeCollection=function(e){var t,i,s=[];if((e=e||{}).hasOwnProperty("delimited")||(e.delimited=!0),!e.hasOwnProperty("collectionIndex"))throw new Error("serializeCollection called without 'collectionIndex' option");for(t=this.collections[e.collectionIndex].data.length,s=[],i=0;i<t;i++)s.push(JSON.stringify(this.collections[e.collectionIndex].data[i]));return e.delimited?(s.push(""),s.join(e.delimiter)):s},x.prototype.deserializeDestructured=function(e,t){var i,s,n,a=[],r=0,o=1,l=!1;if((t=t||{}).hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.partitioned){if(t.hasOwnProperty("partition"))return-1===t.partition?i=JSON.parse(e[0]):this.deserializeCollection(e[t.partition+1],t);for(s=(i=JSON.parse(e[0])).collections.length,r=0;r<s;r++)i.collections[r].data=this.deserializeCollection(e[r+1],t);return i}if(t.delimited){if(a=e.split(t.delimiter),e=null,0===a.length)return null}else a=e;for(s=(i=JSON.parse(a[0])).collections.length,a[0]=null;!l;)""===a[o]?++r>s&&(l=!0):(n=JSON.parse(a[o]),i.collections[r].data.push(n)),a[o++]=null;return i},x.prototype.deserializeCollection=function(e,t){var i,s,n=[];for((t=t||{}).hasOwnProperty("partitioned")||(t.partitioned=!1),t.hasOwnProperty("delimited")||(t.delimited=!0),t.hasOwnProperty("delimiter")||(t.delimiter=this.options.destructureDelimiter),t.delimited?(n=e.split(t.delimiter)).pop():n=e,s=n.length,i=0;i<s;i++)n[i]=JSON.parse(n[i]);return n},x.prototype.loadJSON=function(e,t){var i;if(0===e.length)i={};else switch(this.options.serializationMethod){case"normal":case"pretty":default:i=JSON.parse(e);break;case"destructured":i=this.deserializeDestructured(e)}this.loadJSONObject(i,t)},x.prototype.loadJSONObject=function(e,i){var s,a,r,o,l,h,c=0,d=e.collections?e.collections.length:0;function u(e){var t,s=i[e.name];return s.proto?(t=s.inflate||n.copyProperties,function(e){var i=new s.proto;return t(e,i),i}):s.inflate}for(this.name=e.name,e.hasOwnProperty("throttledSaves")&&i&&!i.hasOwnProperty("throttledSaves")&&(this.throttledSaves=e.throttledSaves),this.collections=[];c<d;c+=1){if(s=e.collections[c],(a=this.addCollection(s.name,{disableChangesApi:s.disableChangesApi,disableDeltaChangesApi:s.disableDeltaChangesApi,disableMeta:s.disableMeta,disableFreeze:!s.hasOwnProperty("disableFreeze")||s.disableFreeze})).adaptiveBinaryIndices=!!s.hasOwnProperty("adaptiveBinaryIndices")&&!0===s.adaptiveBinaryIndices,a.transactional=s.transactional,a.asyncListeners=s.asyncListeners,a.cloneObjects=s.cloneObjects,a.cloneMethod=s.cloneMethod||"parse-stringify",a.autoupdate=s.autoupdate,a.changes=s.changes,a.dirtyIds=s.dirtyIds||[],i&&!0===i.retainDirtyFlags?a.dirty=s.dirty:a.dirty=!1,r=s.data.length,o=0,i&&i.hasOwnProperty(s.name))for(l=u(s);o<r;o++)h=l(s.data[o]),a.data[o]=h,a.addAutoUpdateObserver(h),a.disableFreeze||t(a.data[o]);else for(;o<r;o++)a.data[o]=s.data[o],a.addAutoUpdateObserver(a.data[o]),a.disableFreeze||t(a.data[o]);if(a.maxId=void 0===s.maxId?0:s.maxId,void 0!==s.binaryIndices&&(a.binaryIndices=s.binaryIndices),void 0!==s.transforms&&(a.transforms=s.transforms),a.uniqueNames=[],s.hasOwnProperty("uniqueNames")&&(a.uniqueNames=s.uniqueNames),void 0!==s.DynamicViews){for(var p=0;p<s.DynamicViews.length;p++){var f=s.DynamicViews[p],g=a.addDynamicView(f.name,f.options);g.resultdata=f.resultdata,g.resultsdirty=f.resultsdirty,g.filterPipeline=f.filterPipeline,g.sortCriteriaSimple=f.sortCriteriaSimple,g.sortCriteria=f.sortCriteria,g.sortFunction=null,g.sortDirty=f.sortDirty,a.disableFreeze||(t(g.filterPipeline),g.sortCriteriaSimple?t(g.sortCriteriaSimple):g.sortCriteria&&t(g.sortCriteria)),g.resultset.filteredrows=f.resultset.filteredrows,g.resultset.filterInitialized=f.resultset.filterInitialized,g.rematerialize({removeWhereFilters:!0})}e.databaseVersion<1.5&&(a.ensureAllIndexes(!0),a.dirty=!0)}}},x.prototype.close=function(e){this.autosave&&(this.autosaveDisable(),this.autosaveDirty()&&(this.saveDatabase(e),e=void 0)),e&&this.on("close",e),this.emit("close")},x.prototype.generateChangesNotification=function(e){function t(e){return e.name}var i=[],s=e||this.collections.map(t);return this.collections.forEach((function(e){-1!==s.indexOf(t(e))&&(i=i.concat(e.getChanges()))})),i},x.prototype.serializeChanges=function(e){return JSON.stringify(this.generateChangesNotification(e))},x.prototype.clearChanges=function(){this.collections.forEach((function(e){e.flushChanges&&e.flushChanges()}))},k.prototype.loadDatabase=function(e,t){var i=this;this.options.asyncResponses?setTimeout((function(){i.hashStore.hasOwnProperty(e)?t(i.hashStore[e].value):t(null)}),this.options.asyncTimeout):this.hashStore.hasOwnProperty(e)?t(this.hashStore[e].value):t(null)},k.prototype.saveDatabase=function(e,t,i){var s,n=this;this.options.asyncResponses?setTimeout((function(){s=n.hashStore.hasOwnProperty(e)?n.hashStore[e].savecount:0,n.hashStore[e]={savecount:s+1,lastsave:new Date,value:t},i()}),this.options.asyncTimeout):(s=this.hashStore.hasOwnProperty(e)?this.hashStore[e].savecount:0,this.hashStore[e]={savecount:s+1,lastsave:new Date,value:t},i())},k.prototype.deleteDatabase=function(e,t){this.hashStore.hasOwnProperty(e)&&delete this.hashStore[e],"function"==typeof t&&t()},_.prototype.loadDatabase=function(e,t){var i=this;this.dbname=e,this.dbref=new x(e),this.adapter.loadDatabase(e,(function(e){if(e){"string"!=typeof e&&t(new Error("LokiPartitioningAdapter received an unexpected response from inner adapter loadDatabase()"));var s=JSON.parse(e);i.dbref.loadJSONObject(s),s=null,i.dbref.collections.length,0!==i.dbref.collections.length?(i.pageIterator={collection:0,pageIndex:0},i.loadNextPartition(0,(function(){t(i.dbref)}))):t(i.dbref)}else t(e)}))},_.prototype.loadNextPartition=function(e,t){var i=this.dbname+"."+e,s=this;if(!0===this.options.paging)return this.pageIterator.pageIndex=0,void this.loadNextPage(t);this.adapter.loadDatabase(i,(function(i){var n=s.dbref.deserializeCollection(i,{delimited:!0,collectionIndex:e});s.dbref.collections[e].data=n,++e<s.dbref.collections.length?s.loadNextPartition(e,t):t()}))},_.prototype.loadNextPage=function(e){var t=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,i=this;this.adapter.loadDatabase(t,(function(t){var s=t.split(i.options.delimiter);t="";var n,a=s.length,r=""===s[a-1];for(r&&(s.pop(),""===s[(a=s.length)-1]&&1===a&&(s.pop(),a=s.length)),n=0;n<a;n++)i.dbref.collections[i.pageIterator.collection].data.push(JSON.parse(s[n])),s[n]=null;s=[],r?++i.pageIterator.collection<i.dbref.collections.length?i.loadNextPartition(i.pageIterator.collection,e):e():(i.pageIterator.pageIndex++,i.loadNextPage(e))}))},_.prototype.exportDatabase=function(e,t,i){var s,n=t.collections.length;for(this.dbref=t,this.dbname=e,this.dirtyPartitions=[-1],s=0;s<n;s++)t.collections[s].dirty&&this.dirtyPartitions.push(s);this.saveNextPartition((function(e){i(e)}))},_.prototype.saveNextPartition=function(e){var t=this,i=this.dirtyPartitions.shift(),s=this.dbname+(-1===i?"":"."+i);if(this.options.paging&&-1!==i)return this.pageIterator={collection:i,docIndex:0,pageIndex:0},void this.saveNextPage((function(i){0===t.dirtyPartitions.length?e(i):t.saveNextPartition(e)}));var n=this.dbref.serializeDestructured({partitioned:!0,delimited:!0,partition:i});this.adapter.saveDatabase(s,n,(function(i){i?e(i):0===t.dirtyPartitions.length?e(null):t.saveNextPartition(e)}))},_.prototype.saveNextPage=function(e){var t=this,i=this.dbref.collections[this.pageIterator.collection],s=this.dbname+"."+this.pageIterator.collection+"."+this.pageIterator.pageIndex,n=0,a=i.data.length,r=this.options.delimiter.length,o="",l="",h=!1,c=!1,d=function(i){l="",i&&e(i),h?e(null):(t.pageIterator.pageIndex++,t.saveNextPage(e))};for(0===i.data.length&&(h=!0);;)if(h||(o=JSON.stringify(i.data[this.pageIterator.docIndex]),l+=o,n+=o.length,++this.pageIterator.docIndex>=a&&(h=!0)),n>=this.options.pageSize&&(c=!0),c&&!h||(l+=this.options.delimiter,n+=r),h||c)return void this.adapter.saveDatabase(s,l,d)},S.prototype.loadDatabase=function(e,t){var i=this;this.fs.stat(e,(function(s,n){!s&&n.isFile()?i.fs.readFile(e,{encoding:"utf8"},(function(e,i){t(e?new Error(e):i)})):t(null)}))},S.prototype.saveDatabase=function(e,t,i){var s=this,n=e+"~";this.fs.writeFile(n,t,(function(t){t?i(new Error(t)):s.fs.rename(n,e,i)}))},S.prototype.deleteDatabase=function(e,t){this.fs.unlink(e,(function(e){e?t(new Error(e)):t()}))},O.prototype.loadDatabase=function(e,t){b()?t(localStorage.getItem(e)):t(new Error("localStorage is not available"))},O.prototype.saveDatabase=function(e,t,i){b()?(localStorage.setItem(e,t),i(null)):i(new Error("localStorage is not available"))},O.prototype.deleteDatabase=function(e,t){b()?(localStorage.removeItem(e),t(null)):t(new Error("localStorage is not available"))},x.prototype.throttledSaveDrain=function(e,t){var i=this,s=(new Date).getTime();if(this.throttledSaves||e(!0),(t=t||{}).hasOwnProperty("recursiveWait")||(t.recursiveWait=!0),t.hasOwnProperty("recursiveWaitLimit")||(t.recursiveWaitLimit=!1),t.hasOwnProperty("recursiveWaitLimitDuration")||(t.recursiveWaitLimitDuration=2e3),t.hasOwnProperty("started")||(t.started=(new Date).getTime()),this.throttledSaves&&this.throttledSavePending){if(!t.recursiveWait)return void this.throttledCallbacks.push(e);this.throttledCallbacks.push((function(){return i.throttledSavePending?t.recursiveWaitLimit&&s-t.started>t.recursiveWaitLimitDuration?void e(!1):void i.throttledSaveDrain(e,t):void e(!0)}))}else e(!0)},x.prototype.loadDatabaseInternal=function(e,t){var i=t||function(e,t){if(e)throw e},s=this;null!==this.persistenceAdapter?this.persistenceAdapter.loadDatabase(this.filename,(function(t){if("string"==typeof t){var n=!1;try{s.loadJSON(t,e||{}),n=!0}catch(t){i(t)}n&&(i(null),s.emit("loaded","database "+s.filename+" loaded"))}else{if(!t)return i(null),void s.emit("loaded","empty database "+s.filename+" loaded");if(t instanceof Error)return void i(t);if("object"==typeof t)return s.loadJSONObject(t,e||{}),i(null),void s.emit("loaded","database "+s.filename+" loaded");i("unexpected adapter response : "+t)}})):i(new Error("persistenceAdapter not configured"))},x.prototype.loadDatabase=function(e,t){var i=this;this.throttledSaves?this.throttledSaveDrain((function(s){if(s)return i.throttledSavePending=!0,void i.loadDatabaseInternal(e,(function(e){0===i.throttledCallbacks.length?i.throttledSavePending=!1:i.saveDatabase(),"function"==typeof t&&t(e)}));"function"==typeof t&&t(new Error("Unable to pause save throttling long enough to read database"))}),e):this.loadDatabaseInternal(e,t)},x.prototype.saveDatabaseInternal=function(e){var t,i=e||function(e){if(e)throw e},s=this;this.persistenceAdapter?"incremental"===this.persistenceAdapter.mode?(this.ignoreAutosave=!0,this.persistenceAdapter.saveDatabase(this.filename,(function(){if(s.ignoreAutosave=!1,!t){var e=s.copy({removeNonSerializable:!0});return t=s.collections.map((function(e){return[e.dirty,e.dirtyIds]})),s.collections.forEach((function(e){e.dirty=!1,e.dirtyIds=[]})),e}i(new Error("adapter error - getLokiCopy called more than once"))}),(function(e){s.ignoreAutosave=!1,e&&t&&s.collections.forEach((function(e,i){var s=t[i];e.dirty=e.dirty||s[0],e.dirtyIds=e.dirtyIds.concat(s[1])})),i(e)}))):"reference"===this.persistenceAdapter.mode&&"function"==typeof this.persistenceAdapter.exportDatabase?this.persistenceAdapter.exportDatabase(this.filename,this.copy({removeNonSerializable:!0}),(function(e){s.autosaveClearFlags(),i(e)})):(this.autosaveClearFlags(),this.persistenceAdapter.saveDatabase(this.filename,this.serialize(),(function(e){i(e)}))):i(new Error("persistenceAdapter not configured"))},x.prototype.save=x.prototype.saveDatabase=function(e){if(this.throttledSaves)if(this.throttledSavePending)this.throttledCallbacks.push(e);else{var t=this.throttledCallbacks;this.throttledCallbacks=[],t.unshift(e),this.throttledSavePending=!0;var i=this;this.saveDatabaseInternal((function(e){i.throttledSavePending=!1,t.forEach((function(t){"function"==typeof t&&setTimeout((function(){t(e)}),1)})),0<i.throttledCallbacks.length&&i.saveDatabase()}))}else this.saveDatabaseInternal(e)},x.prototype.deleteDatabase=function(e,t){var i=t||function(e,t){if(e)throw e};"function"!=typeof e||t||(i=e),null!==this.persistenceAdapter?this.persistenceAdapter.deleteDatabase(this.filename,(function(e){i(e)})):i(new Error("persistenceAdapter not configured"))},x.prototype.autosaveDirty=function(){for(var e=0;e<this.collections.length;e++)if(this.collections[e].dirty)return!0;return!1},x.prototype.autosaveClearFlags=function(){for(var e=0;e<this.collections.length;e++)this.collections[e].dirty=!1},x.prototype.autosaveEnable=function(e,t){this.autosave=!0;var i=5e3,s=this;void 0!==this.autosaveInterval&&null!==this.autosaveInterval&&(i=this.autosaveInterval),this.autosaveHandle=setInterval((function(){s.autosaveDirty()&&!s.ignoreAutosave&&s.saveDatabase(t)}),i)},x.prototype.autosaveDisable=function(){void 0!==this.autosaveHandle&&null!==this.autosaveHandle&&(clearInterval(this.autosaveHandle),this.autosaveHandle=null)},I.prototype.reset=function(){return 0<this.filteredrows.length&&(this.filteredrows=[]),this.filterInitialized=!1,this},I.prototype.toJSON=function(){var e=this.copy();return e.collection=null,e},I.prototype.limit=function(e){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var t=new I(this.collection);return t.filteredrows=this.filteredrows.slice(0,e),t.filterInitialized=!0,t},I.prototype.offset=function(e){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var t=new I(this.collection);return t.filteredrows=this.filteredrows.slice(e),t.filterInitialized=!0,t},I.prototype.branch=I.prototype.copy=function(){var e=new I(this.collection);return 0<this.filteredrows.length&&(e.filteredrows=this.filteredrows.slice()),e.filterInitialized=this.filterInitialized,e},I.prototype.transform=function(e,t){var i,s,a=this;if("string"==typeof e&&this.collection.transforms.hasOwnProperty(e)&&(e=this.collection.transforms[e]),"object"!=typeof e||!Array.isArray(e))throw new Error("Invalid transform");for(void 0!==t&&(e=n.resolveTransformParams(e,t)),i=0;i<e.length;i++)switch((s=e[i]).type){case"find":a.find(s.value);break;case"where":a.where(s.value);break;case"simplesort":a.simplesort(s.property,s.desc||s.options);break;case"compoundsort":a.compoundsort(s.value);break;case"sort":a.sort(s.value);break;case"limit":a=a.limit(s.value);break;case"offset":a=a.offset(s.value);break;case"map":a=a.map(s.value,s.dataOptions);break;case"eqJoin":a=a.eqJoin(s.joinData,s.leftJoinKey,s.rightJoinKey,s.mapFun,s.dataOptions);break;case"mapReduce":a=a.mapReduce(s.mapFunction,s.reduceFunction);break;case"update":a.update(s.value);break;case"remove":a.remove()}return a},I.prototype.sort=function(e){this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var t=function(e,t){return function(i,s){return e(t[i],t[s])}}(e,this.collection.data);return this.filteredrows.sort(t),this},I.prototype.simplesort=function(e,t){var i,s=10,a=this.collection.data.length,r=this.filteredrows.length,o=this.collection.binaryIndices.hasOwnProperty(e);if(void 0!==t&&!1!==t||(t={desc:!1}),!0===t&&(t={desc:!0}),0===r){if(this.filterInitialized)return this;if(this.collection.binaryIndices.hasOwnProperty(e))return this.collection.ensureIndex(e),this.filteredrows=this.collection.binaryIndices[e].values.slice(0),t.desc&&this.filteredrows.reverse(),this;this.filteredrows=this.collection.prepareFullDocIndex()}else if(!t.disableIndexIntersect&&o&&(i=a/r,t.useJavascriptSorting&&(s=6),i<=s||t.forceIndexIntersect)){var l,c=this.filteredrows,d={};for(l=0;l<r;l++)d[c[l]]=!0;var u=this.collection.binaryIndices[e].values;return this.filteredrows=u.filter((function(e){return d[e]})),t.desc&&this.filteredrows.reverse(),this}if(t.useJavascriptSorting)return this.sort((function(t,i){return t[e]===i[e]?0:t[e]>i[e]?1:t[e]<i[e]?-1:void 0}));var p=function(e,t,i){var s,a,r;return function(o,l){return a=~e.indexOf(".")?(r=e.split("."),s=n.getIn(i[o],r,!0),n.getIn(i[l],r,!0)):(s=i[o][e],i[l][e]),h(s,a,t)}}(e,t.desc,this.collection.data);return this.filteredrows.sort(p),this},I.prototype.compoundsort=function(e){if(0===e.length)throw new Error("Invalid call to compoundsort, need at least one property");var t;if(1===e.length)return t=e[0],Array.isArray(t)?this.simplesort(t[0],t[1]):this.simplesort(t,!1);for(var i=0,s=e.length;i<s;i+=1)t=e[i],Array.isArray(t)||(e[i]=[t,!1]);this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());var a=function(e,t){return function(i,s){return function(e,t,i){for(var s,a,r,o,l,c=0,d=0,u=e.length;d<u;d++)if(o=~(a=(s=e[d])[0]).indexOf(".")?(l=a.split("."),r=n.getIn(t,l,!0),n.getIn(i,l,!0)):(r=t[a],i[a]),0!==(c=h(r,o,s[1])))return c;return 0}(e,t[i],t[s])}}(e,this.collection.data);return this.filteredrows.sort(a),this},I.prototype.$or=I.prototype.findOr=function(e){var t=null,i=0,s=0,n=[],a=[],r=0;this.count();for(var o=0,l=e.length;o<l;o++)for(s=(t=this.branch().find(e[o]).filteredrows).length,i=0;i<s;i++)void 0===a[r=t[i]]&&(a[r]=!0,n.push(r));return this.filteredrows=n,this.filterInitialized=!0,this},I.prototype.$and=I.prototype.findAnd=function(e){for(var t=0,i=e.length;t<i;t++){if(0===this.count())return this;this.find(e[t])}return this},I.prototype.find=function(t,i){if(0===this.collection.data.length)return this.filteredrows=[],this.filterInitialized=!0,this;var s,a,r,o,l,h,d,u=t||"getAll",f=!1,m=[],y=[],v=null;if(i=i||!1,"object"==typeof u){for(s in u)(o={})[s]=u[s],y.push(o),e.call(u,s)&&(r=u[a=s]);if(1<y.length)return this.find({$and:y},i)}if(!a||"getAll"===u)return i&&(this.filterInitialized?this.filteredrows=this.filteredrows.slice(0,1):(this.filteredrows=0<this.collection.data.length?[0]:[],this.filterInitialized=!0)),this;if("$and"===a||"$or"===a)return this[a](r),i&&1<this.filteredrows.length&&(this.filteredrows=this.filteredrows.slice(0,1)),this;if(null===r||"object"!=typeof r||r instanceof Date)l="$eq",h=r;else{if("object"!=typeof r)throw new Error("Do not know what you want to do.");for(d in r)if(e.call(r,d)){h=r[l=d];break}}"$regex"!==l&&"object"!=typeof h||(h=function e(t,i){if("$regex"===t)Array.isArray(i)?i=new RegExp(i[0],i[1]):i instanceof RegExp||(i=new RegExp(i));else if("object"==typeof i)for(var s in i)"$regex"!==s&&"object"!=typeof i[s]||(i[s]=e(s,i[s]));return i}(l,h));var b=-1!==a.indexOf(".");!this.filterInitialized&&this.collection.binaryIndices[a]&&g[l]&&(!0!==this.collection.adaptiveBinaryIndices&&this.collection.ensureIndex(a),f=!0,v=this.collection.binaryIndices[a]),!f&&"$in"===l&&Array.isArray(h)&&"undefined"!=typeof Set&&(h=new Set(h),l="$inSet");var w,x,k=p[l],_=this.collection.data,S=0,O=0,I=0;if(this.filterInitialized){if(O=(w=this.filteredrows).length,b){for(a=a.split("."),S=0;S<O;S++)if(c(x=_[I=w[S]],a,k,h,x)&&(m.push(I),i))return this.filteredrows=m,this}else for(S=0;S<O;S++)if(k((x=_[I=w[S]])[a],h,x)&&(m.push(I),i))return this.filteredrows=m,this}else if(f){var T=this.collection.calculateRange(l,a,h);if("$in"!==l){for(S=T[0];S<=T[1];S++)if(!0!==g[l]){if(g[l](n.getIn(_[v.values[S]],a,b),h)&&(m.push(v.values[S]),i))return this.filteredrows=m,this.filterInitialized=!0,this}else if(m.push(v.values[S]),i)return this.filteredrows=m,this.filterInitialized=!0,this}else for(S=0,O=T.length;S<O;S++)if(m.push(v.values[T[S]]),i)return this.filteredrows=m,this.filterInitialized=!0,this}else if(O=_.length,b){for(a=a.split("."),S=0;S<O;S++)if(c(x=_[S],a,k,h,x)&&(m.push(S),i))return this.filteredrows=m,this.filterInitialized=!0,this}else for(S=0;S<O;S++)if(k((x=_[S])[a],h,x)&&(m.push(S),i))return this.filteredrows=m,this.filterInitialized=!0,this;return this.filteredrows=m,this.filterInitialized=!0,this},I.prototype.where=function(e){var t,i=[];if("function"!=typeof e)throw new TypeError("Argument is not a stored view or a function");t=e;try{if(this.filterInitialized){for(var s=this.filteredrows.length;s--;)!0===t(this.collection.data[this.filteredrows[s]])&&i.push(this.filteredrows[s]);return this.filteredrows=i,this}for(var n=this.collection.data.length;n--;)!0===t(this.collection.data[n])&&i.push(n);return this.filteredrows=i,this.filterInitialized=!0,this}catch(e){throw e}},I.prototype.count=function(){return this.filterInitialized?this.filteredrows.length:this.collection.count()},I.prototype.data=function(e){var t,i,s,n,a=[],r=this.collection.data;if((e=e||{}).removeMeta&&!e.forceClones&&(e.forceClones=!0,e.forceCloneMethod=e.forceCloneMethod||"shallow"),!this.collection.disableDeltaChangesApi&&this.collection.disableFreeze&&(e.forceClones=!0,e.forceCloneMethod="parse-stringify"),!this.filterInitialized){if(0===this.filteredrows.length){if(this.collection.cloneObjects||e.forceClones){for(i=r.length,n=e.forceCloneMethod||this.collection.cloneMethod,s=0;s<i;s++)t=m(r[s],n),e.removeMeta&&(delete t.$loki,delete t.meta),a.push(t);return a}return r.slice()}this.filterInitialized=!0}var o=this.filteredrows;if(i=o.length,this.collection.cloneObjects||e.forceClones)for(n=e.forceCloneMethod||this.collection.cloneMethod,s=0;s<i;s++)t=m(r[o[s]],n),e.removeMeta&&(delete t.$loki,delete t.meta),a.push(t);else for(s=0;s<i;s++)a.push(r[o[s]]);return a},I.prototype.update=function(e){if("function"!=typeof e)throw new TypeError("Argument is not a function");this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex());for(var t,i=this.filteredrows.length,s=this.collection.data,n=0;n<i;n++)this.disableFreeze&&!this.collection.cloneObjects&&this.collection.disableDeltaChangesApi?(e(s[this.filteredrows[n]]),this.collection.update(s[this.filteredrows[n]])):(e(t=m(s[this.filteredrows[n]],this.collection.cloneMethod)),this.collection.update(t));return this},I.prototype.remove=function(){return this.filterInitialized||0!==this.filteredrows.length||(this.filteredrows=this.collection.prepareFullDocIndex()),this.collection.removeBatchByPositions(this.filteredrows),this.filteredrows=[],this},I.prototype.mapReduce=function(e,t){try{return t(this.data().map(e))}catch(e){throw e}},I.prototype.eqJoin=function(e,t,i,s,n){var a,r,o,l,h=[],c=[],d="function"==typeof t,u="function"==typeof i,p={};if(a=(l=this.data(n)).length,e instanceof P)h=e.chain().data(n);else if(e instanceof I)h=e.data(n);else{if(!Array.isArray(e))throw new TypeError("joinData needs to be an array or result set");h=e}r=h.length;for(var f=0;f<r;f++)p[o=u?i(h[f]):h[f][i]]=h[f];s=s||function(e,t){return{left:e,right:t}};for(var g=0;g<a;g++)o=d?t(l[g]):l[g][t],c.push(s(l[g],p[o]||{}));return this.collection=new P("joinData"),this.collection.insert(c),this.filteredrows=[],this.filterInitialized=!1,this},I.prototype.map=function(e,t){var i=this.data(t).map(e);return this.collection=new P("mappedData"),this.collection.insert(i),this.filteredrows=[],this.filterInitialized=!1,this},((T.prototype=new w).constructor=T).prototype.getSort=function(){return this.sortFunction||this.sortCriteria||this.sortCriteriaSimple},T.prototype.rematerialize=function(e){var t,i,s;e=e||{},this.resultdata=[],this.resultsdirty=!0,this.resultset=new I(this.collection),(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple)&&(this.sortDirty=!0);var n=Object.isFrozen(this.filterPipeline);if(e.hasOwnProperty("removeWhereFilters"))for(n&&(this.filterPipeline=this.filterPipeline.slice()),i=t=this.filterPipeline.length;i--;)"where"===this.filterPipeline[i].type&&(i!==this.filterPipeline.length-1&&(this.filterPipeline[i]=this.filterPipeline[this.filterPipeline.length-1]),this.filterPipeline.length--);var a=this.filterPipeline;for(this.filterPipeline=[],t=a.length,s=0;s<t;s++)this.applyFind(a[s].val,a[s].uid);return n&&Object.freeze(this.filterPipeline),this.data(),this.emit("rebuild",this),this},T.prototype.branchResultset=function(e,t){var i=this.resultset.branch();return void 0===e?i:i.transform(e,t)},T.prototype.toJSON=function(){var e=new T(this.collection,this.name,this.options);return e.resultset=this.resultset,e.resultdata=[],e.resultsdirty=!0,e.filterPipeline=this.filterPipeline,e.sortFunction=this.sortFunction,e.sortCriteria=this.sortCriteria,e.sortCriteriaSimple=this.sortCriteriaSimple||null,e.sortDirty=this.sortDirty,e.collection=null,e},T.prototype.removeFilters=function(e){e=e||{},this.rebuildPending=!1,this.resultset.reset(),this.resultdata=[],this.resultsdirty=!0,this.cachedresultset=null;var t=Object.isFrozen(this.filterPipeline),i=0<this.filterPipeline.length;this.filterPipeline=[],t&&Object.freeze(this.filterPipeline),this.sortFunction=null,this.sortCriteria=null,this.sortCriteriaSimple=null,!(this.sortDirty=!1)===e.queueSortPhase&&this.queueSortPhase(),i&&this.emit("filter")},T.prototype.applySort=function(e){return this.sortFunction=e,this.sortCriteria=null,this.sortCriteriaSimple=null,this.queueSortPhase(),this.emit("sort"),this},T.prototype.applySimpleSort=function(e,i){return this.sortCriteriaSimple={propname:e,options:i||!1},this.collection.disableFreeze||t(this.sortCriteriaSimple),this.sortCriteria=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},T.prototype.applySortCriteria=function(e){return this.sortCriteria=e,this.collection.disableFreeze||t(this.sortCriteria),this.sortCriteriaSimple=null,this.sortFunction=null,this.queueSortPhase(),this.emit("sort"),this},T.prototype.startTransaction=function(){return this.cachedresultset=this.resultset.copy(),this},T.prototype.commit=function(){return this.cachedresultset=null,this},T.prototype.rollback=function(){return this.resultset=this.cachedresultset,this.options.persistent&&(this.resultdata=this.resultset.data(),this.emit("rebuild",this)),this},T.prototype._indexOfFilterWithId=function(e){if("string"==typeof e||"number"==typeof e)for(var t=0,i=this.filterPipeline.length;t<i;t+=1)if(e===this.filterPipeline[t].uid)return t;return-1},T.prototype._addFilter=function(e){var i=Object.isFrozen(this.filterPipeline);i&&(this.filterPipeline=this.filterPipeline.slice()),this.collection.disableFreeze||t(e),this.filterPipeline.push(e),i&&Object.freeze(this.filterPipeline),this.resultset[e.type](e.val)},T.prototype.reapplyFilters=function(){this.resultset.reset(),this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0);var e=this.filterPipeline,t=Object.isFrozen(e);this.filterPipeline=[];for(var i=0,s=e.length;i<s;i+=1)this._addFilter(e[i]);return t&&Object.freeze(this.filterPipeline),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},T.prototype.applyFilter=function(e){var t=this._indexOfFilterWithId(e.uid);if(0<=t){var s=Object.isFrozen(this.filterPipeline);return s&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline[t]=e,s&&(i(e),Object.freeze(this.filterPipeline)),this.reapplyFilters()}return this.cachedresultset=null,this.options.persistent&&(this.resultdata=[],this.resultsdirty=!0),this._addFilter(e),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent(),this.emit("filter"),this},T.prototype.applyFind=function(e,t){return this.applyFilter({type:"find",val:e,uid:t}),this},T.prototype.applyWhere=function(e,t){return this.applyFilter({type:"where",val:e,uid:t}),this},T.prototype.removeFilter=function(e){var t=this._indexOfFilterWithId(e);if(t<0)throw new Error("Dynamic view does not contain a filter with ID: "+e);var i=Object.isFrozen(this.filterPipeline);return i&&(this.filterPipeline=this.filterPipeline.slice()),this.filterPipeline.splice(t,1),i&&Object.freeze(this.filterPipeline),this.reapplyFilters(),this},T.prototype.count=function(){return this.resultsdirty&&(this.resultdata=this.resultset.data()),this.resultset.count()},T.prototype.data=function(e){return(this.sortDirty||this.resultsdirty)&&this.performSortPhase({suppressRebuildEvent:!0}),this.options.persistent?this.resultdata:this.resultset.data(e)},T.prototype.queueRebuildEvent=function(){if(!this.rebuildPending){this.rebuildPending=!0;var e=this;setTimeout((function(){e.rebuildPending&&(e.rebuildPending=!1,e.emit("rebuild",e))}),this.options.minRebuildInterval)}},T.prototype.queueSortPhase=function(){if(!this.sortDirty){this.sortDirty=!0;var e=this;"active"===this.options.sortPriority?setTimeout((function(){e.performSortPhase()}),this.options.minRebuildInterval):this.queueRebuildEvent()}},T.prototype.performSortPhase=function(e){(this.sortDirty||this.resultsdirty)&&(e=e||{},this.sortDirty&&(this.sortFunction?this.resultset.sort(this.sortFunction):this.sortCriteria?this.resultset.compoundsort(this.sortCriteria):this.sortCriteriaSimple&&this.resultset.simplesort(this.sortCriteriaSimple.propname,this.sortCriteriaSimple.options),this.sortDirty=!1),this.options.persistent&&(this.resultdata=this.resultset.data(),this.resultsdirty=!1),e.suppressRebuildEvent||this.emit("rebuild",this))},T.prototype.evaluateDocument=function(e,t){if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var i,s=this.resultset.filteredrows,n=t?-1:s.indexOf(+e),a=s.length,r=new I(this.collection);r.filteredrows=[e],r.filterInitialized=!0;for(var o=0,l=this.filterPipeline.length;o<l;o++)r[(i=this.filterPipeline[o]).type](i.val);var h=0===r.filteredrows.length?-1:0;return-1!==n||-1!=h?-1===n&&-1!=h?(s.push(e),this.options.persistent&&this.resultdata.push(this.collection.data[e]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==n&&-1==h?(n<a-1?(s.splice(n,1),this.options.persistent&&this.resultdata.splice(n,1)):(s.length=a-1,this.options.persistent&&(this.resultdata.length=a-1)),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):-1!==n&&-1!=h?(this.options.persistent&&(this.resultdata[n]=this.collection.data[e]),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent())):void 0:void 0},T.prototype.removeDocument=function(e){var t,i,s,n={},a={},r=[],o=this.resultset,l=this.resultset.filteredrows,h=l.length;if(!this.resultset.filterInitialized)return this.options.persistent&&(this.resultdata=this.resultset.data()),void(this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());for(Array.isArray(e)||(e=[e]),s=e.length,i=0;i<s;i++)n[e[i]]=!0;for(t=0;t<h;t++)n[l[t]]&&(a[t]=!0);0<Object.keys(a).length&&(this.resultset.filteredrows=this.resultset.filteredrows.filter((function(e,t){return!a[t]})),this.options.persistent&&(this.resultdata=this.resultdata.filter((function(e,t){return!a[t]}))),this.sortFunction||this.sortCriteria||this.sortCriteriaSimple?this.queueSortPhase():this.queueRebuildEvent());var c=function(e){return function(t){return t<o.filteredrows[e]}};for(h=o.filteredrows.length,t=0;t<h;t++)r=e.filter(c(t)),o.filteredrows[t]-=r.length},T.prototype.mapReduce=function(e,t){try{return t(this.data().map(e))}catch(e){throw e}},((P.prototype=new w).contructor=P).prototype.createChange=function(e,t,i,s){this.changes.push({name:e,operation:t,obj:"U"!=t||this.disableDeltaChangesApi?JSON.parse(JSON.stringify(i)):this.getChangeDelta(i,s)})},P.prototype.insertMeta=function(e){var t,i;if(!this.disableMeta&&e)if(Array.isArray(e))for(t=e.length,i=0;i<t;i++)e[i].hasOwnProperty("meta")||(e[i].meta={}),e[i].meta.created=(new Date).getTime(),e[i].meta.revision=0;else e.meta||(e.meta={}),e.meta.created=(new Date).getTime(),e.meta.revision=0},P.prototype.updateMeta=function(e){return this.disableMeta||!e||(this.disableFreeze||((e=s(e)).meta=s(e.meta)),e.meta.updated=(new Date).getTime(),e.meta.revision+=1),e},P.prototype.createInsertChange=function(e){this.createChange(this.name,"I",e)},P.prototype.createUpdateChange=function(e,t){this.createChange(this.name,"U",e,t)},P.prototype.insertMetaWithChange=function(e){this.insertMeta(e),this.createInsertChange(e)},P.prototype.updateMetaWithChange=function(e,t,i){return e=this.updateMeta(e,i),this.createUpdateChange(e,t),e},P.prototype.lokiConsoleWrapper={log:function(){},warn:function(){},error:function(){}},P.prototype.addAutoUpdateObserver=function(e){this.autoupdate&&"function"==typeof Object.observe&&Object.observe(e,this.observerCallback,["add","update","delete","reconfigure","setPrototype"])},P.prototype.removeAutoUpdateObserver=function(e){this.autoupdate&&"function"==typeof Object.observe&&Object.unobserve(e,this.observerCallback)},P.prototype.addTransform=function(e,t){if(this.transforms.hasOwnProperty(e))throw new Error("a transform by that name already exists");this.transforms[e]=t},P.prototype.getTransform=function(e){return this.transforms[e]},P.prototype.setTransform=function(e,t){this.transforms[e]=t},P.prototype.removeTransform=function(e){delete this.transforms[e]},P.prototype.byExample=function(e){var t,i,s;for(t in s=[],e)e.hasOwnProperty(t)&&s.push(((i={})[t]=e[t],i));return{$and:s}},P.prototype.findObject=function(e){return this.findOne(this.byExample(e))},P.prototype.findObjects=function(e){return this.find(this.byExample(e))},P.prototype.ttlDaemonFuncGen=function(){var e=this,t=this.ttl.age;return function(){var i=Date.now();e.chain().where((function(e){var s=e.meta.updated||e.meta.created;return t<i-s})).remove()}},P.prototype.setTTL=function(e,t){e<0?clearInterval(this.ttl.daemon):(this.ttl.age=e,this.ttl.ttlInterval=t,this.ttl.daemon=setInterval(this.ttlDaemonFuncGen(),t))},P.prototype.prepareFullDocIndex=function(){for(var e=this.data.length,t=new Array(e),i=0;i<e;i+=1)t[i]=i;return t},P.prototype.configureOptions=function(e){(e=e||{}).hasOwnProperty("adaptiveBinaryIndices")&&(this.adaptiveBinaryIndices=e.adaptiveBinaryIndices,this.adaptiveBinaryIndices&&this.ensureAllIndexes())},P.prototype.ensureIndex=function(e,t){if(void 0===t&&(t=!1),null==e)throw new Error("Attempting to set index without an associated property");if((!this.binaryIndices[e]||t||this.binaryIndices[e].dirty)&&(!0!==this.adaptiveBinaryIndices||!this.binaryIndices.hasOwnProperty(e)||t)){var i={name:e,dirty:!0,values:this.prepareFullDocIndex()};this.binaryIndices[e]=i;var s=function(e,t){var i,s,r=!!~e.indexOf(".")&&e.split(".");return function(o,l){if(s=r?(i=n.getIn(t[o],r,!0),n.getIn(t[l],r,!0)):(i=t[o][e],t[l][e]),i!==s){if(a.lt(i,s,!1))return-1;if(a.gt(i,s,!1))return 1}return 0}}(e,this.data);i.values.sort(s),i.dirty=!1,this.dirty=!0}},P.prototype.checkAllIndexes=function(t){var i,s=this.binaryIndices,n=[];for(i in s)e.call(s,i)&&(this.checkIndex(i,t)||n.push(i));return n},P.prototype.checkIndex=function(e,t){(t=t||{}).randomSamplingFactor&&!1!==t.randomSampling&&(t.randomSampling=!0),t.randomSamplingFactor=t.randomSamplingFactor||.1,(t.randomSamplingFactor<0||1<t.randomSamplingFactor)&&(t.randomSamplingFactor=.1);var i,s,a,r,o,l=!0;if(!this.binaryIndices.hasOwnProperty(e))throw new Error("called checkIndex on property without an index: "+e);if(this.adaptiveBinaryIndices||this.ensureIndex(e),(r=(o=this.binaryIndices[e].values).length)!==this.data.length)return t.repair&&this.ensureIndex(e,!0),!1;if(0===r)return!0;var h=-1!==e.indexOf(".");if(1===r)l=0===o[0];else if(t.randomSampling){if(p.$lte(n.getIn(this.data[o[0]],e,h),n.getIn(this.data[o[1]],e,h))||(l=!1),p.$lte(n.getIn(this.data[o[r-2]],e,h),n.getIn(this.data[o[r-1]],e,h))||(l=!1),l)for(s=Math.floor((r-1)*t.randomSamplingFactor),i=0;i<s-1;i++)if(a=Math.floor(Math.random()*(r-1)),!p.$lte(n.getIn(this.data[o[a]],e,h),n.getIn(this.data[o[a+1]],e,h))){l=!1;break}}else for(i=0;i<r-1;i++)if(!p.$lte(n.getIn(this.data[o[i]],e,h),n.getIn(this.data[o[i+1]],e,h))){l=!1;break}return!l&&t.repair&&this.ensureIndex(e,!0),l},P.prototype.getBinaryIndexValues=function(e){var t,i=this.binaryIndices[e].values,s=[];for(t=0;t<i.length;t++)s.push(n.getIn(this.data[i[t]],e,!0));return s},P.prototype.getUniqueIndex=function(e,t){var i=this.constraints.unique[e];return!i&&t?this.ensureUniqueIndex(e):i},P.prototype.ensureUniqueIndex=function(e){var t=this.constraints.unique[e];return t||-1==this.uniqueNames.indexOf(e)&&this.uniqueNames.push(e),this.constraints.unique[e]=t=new F(e),this.data.forEach((function(e){t.set(e)})),t},P.prototype.ensureAllIndexes=function(t){var i,s=this.binaryIndices;for(i in s)e.call(s,i)&&this.ensureIndex(i,t)},P.prototype.flagBinaryIndexesDirty=function(){var t,i=this.binaryIndices;for(t in i)e.call(i,t)&&(i[t].dirty=!0)},P.prototype.flagBinaryIndexDirty=function(e){this.binaryIndices[e]&&(this.binaryIndices[e].dirty=!0)},P.prototype.count=function(e){return e?this.chain().find(e).filteredrows.length:this.data.length},P.prototype.ensureId=function(){if(!this.idIndex){for(var e=this.data,t=0,i=e.length,s=new Array(i);t<i;t++)s[t]=e[t].$loki;this.idIndex=s}},P.prototype.ensureIdAsync=function(e){this.async((function(){this.ensureId()}),e)},P.prototype.addDynamicView=function(e,t){var i=new T(this,e,t);return this.DynamicViews.push(i),i},P.prototype.removeDynamicView=function(e){this.DynamicViews=this.DynamicViews.filter((function(t){return t.name!==e}))},P.prototype.getDynamicView=function(e){for(var t=0;t<this.DynamicViews.length;t++)if(this.DynamicViews[t].name===e)return this.DynamicViews[t];return null},P.prototype.findAndUpdate=function(e,t){"function"==typeof e?this.updateWhere(e,t):this.chain().find(e).update(t)},P.prototype.findAndRemove=function(e){this.chain().find(e).remove()},P.prototype.insert=function(e,t){if(!Array.isArray(e))return this.insertOne(e);var i,s=[],n=t&&!this.cloneObjects&&this.adaptiveBinaryIndices&&0<Object.keys(this.binaryIndices).length;n&&(this.adaptiveBinaryIndices=!1);try{this.emit("pre-insert",e);for(var a=0,r=e.length;a<r;a++){if(!(i=this.insertOne(e[a],!0)))return;s.push(i)}}finally{n&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}return this.emit("insert",s),1===(s=this.cloneObjects?m(s,this.cloneMethod):s).length?s[0]:s},P.prototype.insertOne=function(e,i){var n,a=null;if("object"!=typeof e?a=new TypeError("Document needs to be an object"):null===e&&(a=new TypeError("Object cannot be null")),null!==a)throw this.emit("error",a),a;var r=this.cloneObjects?m(e,this.cloneMethod):e;if(this.disableFreeze||(r=s(r)),this.disableMeta||(void 0===r.meta?r.meta={revision:0,created:0}:this.disableFreeze||(r.meta=s(r.meta))),i||this.emit("pre-insert",r),this.add(r))return this.disableChangesApi?this.insertMeta(r):this.insertMetaWithChange(r),this.disableFreeze||t(r),n=this.cloneObjects?m(r,this.cloneMethod):r,i||this.emit("insert",n),this.addAutoUpdateObserver(n),n},P.prototype.clear=function(e){var t=this;e=e||{},this.data=[],this.idIndex=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedData=null,this.maxId=0,this.DynamicViews=[],this.dirty=!0,this.constraints={unique:{},exact:{}},!0===e.removeIndices?(this.binaryIndices={},this.uniqueNames=[]):Object.keys(this.binaryIndices).forEach((function(e){t.binaryIndices[e].dirty=!1,t.binaryIndices[e].values=[]}))},P.prototype.update=function(i){var s,n,a;if(Array.isArray(i)){a=i.length,(s=!this.cloneObjects&&this.adaptiveBinaryIndices&&0<Object.keys(this.binaryIndices).length)&&(this.adaptiveBinaryIndices=!1);try{for(n=0;n<a;n+=1)this.update(i[n])}finally{s&&(this.ensureAllIndexes(),this.adaptiveBinaryIndices=!0)}}else{if(!e.call(i,"$loki"))throw new Error("Trying to update unsynced document. Please save the document first by using insert() or addMany()");try{this.startTransaction();var r,o,l,h,c,d=this.get(i.$loki,!0),u=this;if(!d)throw new Error("Trying to update a document not in collection.");r=d[0],l=d[1],o=this.cloneObjects||!this.disableDeltaChangesApi&&this.disableFreeze?m(i,this.cloneMethod):i,this.emit("pre-update",i),this.uniqueNames.forEach((function(e){u.getUniqueIndex(e,!0).update(r,o)})),(this.data[l]=o)!==i&&this.addAutoUpdateObserver(i);for(var p=0;p<this.DynamicViews.length;p++)this.DynamicViews[p].evaluateDocument(l,!1);if(this.adaptiveBinaryIndices){var f=this.binaryIndices;for(h in f)this.adaptiveBinaryIndexUpdate(l,h)}else this.flagBinaryIndexesDirty();return this.idIndex[l]=o.$loki,this.isIncremental&&this.dirtyIds.push(o.$loki),this.commit(),this.dirty=!0,o=this.disableChangesApi?this.updateMeta(o):this.updateMetaWithChange(o,r),this.disableFreeze||t(o),c=this.cloneObjects?m(o,this.cloneMethod):o,this.emit("update",c,r),c}catch(i){throw this.rollback(),this.lokiConsoleWrapper.error(i.message),this.emit("error",i),i}}},P.prototype.add=function(e){if("object"!=typeof e)throw new TypeError("Object being added needs to be an object");if(void 0!==e.$loki)throw new Error("Document is already in collection, please use update()");try{this.startTransaction(),this.maxId++,isNaN(this.maxId)&&(this.maxId=this.data[this.data.length-1].$loki+1);var t=this.maxId;e.$loki=t,this.disableMeta||(e.meta.version=0);for(var i=0,s=this.uniqueNames.length;i<s;i++)this.getUniqueIndex(this.uniqueNames[i],!0).set(e);this.idIndex&&this.idIndex.push(t),this.isIncremental&&this.dirtyIds.push(t),this.data.push(e);var n=this.data.length-1,a=this.DynamicViews.length;for(i=0;i<a;i++)this.DynamicViews[i].evaluateDocument(n,!0);if(this.adaptiveBinaryIndices){var r=this.binaryIndices;for(var o in r)this.adaptiveBinaryIndexInsert(n,o)}else this.flagBinaryIndexesDirty();return this.commit(),this.dirty=!0,this.cloneObjects?m(e,this.cloneMethod):e}catch(e){throw this.rollback(),this.lokiConsoleWrapper.error(e.message),this.emit("error",e),e}},P.prototype.updateWhere=function(e,t){var i,s=this.where(e),n=0;try{for(;n<s.length;n++)i=t(s[n]),this.update(i)}catch(e){this.rollback(),this.lokiConsoleWrapper.error(e.message)}},P.prototype.removeWhere=function(e){var t;"function"==typeof e?(t=this.data.filter(e),this.remove(t)):this.chain().find(e).remove()},P.prototype.removeDataOnly=function(){this.remove(this.data.slice())},P.prototype.removeBatchByPositions=function(e){var t,i,s,n,a=e.length,r={},o=Object.keys(this.binaryIndices).length,l=Object.keys(this.constraints.unique).length,h=this.adaptiveBinaryIndices&&0<Object.keys(this.binaryIndices).length,c=this;try{for(this.startTransaction(),this.ensureId(),s=0;s<a;s++)r[this.idIndex[e[s]]]=!0;if(0<(t=this.DynamicViews.length)||0<o||0<l){if(0<t)for(i=0;i<t;i++)this.DynamicViews[i].removeDocument(e);if(this.adaptiveBinaryIndices&&!h){var d,u=this.binaryIndices;for(d in u)this.adaptiveBinaryIndexRemove(e,d)}else this.flagBinaryIndexesDirty();l&&this.uniqueNames.forEach((function(t){var i=c.getUniqueIndex(t);if(i)for(s=0;s<a;s++)null!==(n=c.data[e[s]])[t]&&void 0!==n[t]&&i.remove(n[t])}))}if(!this.disableChangesApi||1<this.events.delete.length)for(s=0;s<a;s++)this.emit("delete",this.data[e[s]]);if(this.data=this.data.filter((function(e){return!r[e.$loki]})),this.isIncremental)for(s=0;s<a;s++)this.dirtyIds.push(this.idIndex[e[s]]);this.idIndex=this.idIndex.filter((function(e){return!r[e]})),this.adaptiveBinaryIndices&&h&&(this.adaptiveBinaryIndices=!1,this.ensureAllIndexes(!0),this.adaptiveBinaryIndices=!0),this.commit(),this.dirty=!0}catch(t){return this.rollback(),h&&(this.adaptiveBinaryIndices=!0),this.lokiConsoleWrapper.error(t.message),this.emit("error",t),null}},P.prototype.removeBatch=function(e){var t,i=e.length,s=this.data.length,n={},a=[];for(t=0;t<s;t++)n[this.data[t].$loki]=t;for(t=0;t<i;t++)"object"==typeof e[t]?a.push(n[e[t].$loki]):a.push(n[e[t]]);this.removeBatchByPositions(a)},P.prototype.remove=function(t){if("number"==typeof t&&(t=this.get(t)),"object"!=typeof t)throw new Error("Parameter is not an object");if(Array.isArray(t))this.removeBatch(t);else{if(!e.call(t,"$loki"))throw new Error("Object is not a document stored in the collection");try{this.startTransaction();var n=this.get(t.$loki,!0),a=n[1],r=this;this.uniqueNames.forEach((function(e){if(null!==t[e]&&void 0!==t[e]){var i=r.getUniqueIndex(e);i&&i.remove(t[e])}}));for(var o=0;o<this.DynamicViews.length;o++)this.DynamicViews[o].removeDocument(a);if(this.adaptiveBinaryIndices){var l,h=this.binaryIndices;for(l in h)this.adaptiveBinaryIndexRemove(a,l)}else this.flagBinaryIndexesDirty();return this.data.splice(a,1),this.removeAutoUpdateObserver(t),this.idIndex.splice(a,1),this.isIncremental&&this.dirtyIds.push(t.$loki),this.commit(),this.dirty=!0,this.emit("delete",n[0]),this.disableFreeze||(t=s(t)),delete t.$loki,delete t.meta,this.disableFreeze||i(t),t}catch(n){return this.rollback(),this.lokiConsoleWrapper.error(n.message),this.emit("error",n),null}}},P.prototype.get=function(e,t){this.idIndex||this.ensureId();var i=t||!1,s=this.idIndex,n=s.length-1,a=0,r=a+n>>1;if(e="number"==typeof e?e:parseInt(e,10),isNaN(e))throw new TypeError("Passed id is not an integer");for(;s[a]<s[n];)s[r=a+n>>1]<e?a=r+1:n=r;return n===a&&s[a]===e?i?[this.data[a],a]:this.data[a]:null},P.prototype.getBinaryIndexPosition=function(e,t){var i=n.getIn(this.data[e],t,!0),s=this.binaryIndices[t].values,a=this.calculateRange("$eq",t,i);if(0===a[0]&&-1===a[1])return null;for(var r=a[0],o=a[1],l=r;l<=o;l++)if(s[l]===e)return l;return null},P.prototype.adaptiveBinaryIndexInsert=function(e,t){var i=-1!==t.indexOf("."),s=this.binaryIndices[t].values,a=n.getIn(this.data[e],t,i);!0===this.serializableIndices&&a instanceof Date&&(this.data[e][t]=a.getTime(),a=n.getIn(this.data[e],t));var r=0===s.length?0:this.calculateRangeStart(t,a,!0,i);this.binaryIndices[t].values.splice(r,0,e)},P.prototype.adaptiveBinaryIndexUpdate=function(e,t){var i,s=this.binaryIndices[t].values,n=s.length;for(i=0;i<n&&s[i]!==e;i++);this.binaryIndices[t].values.splice(i,1),this.adaptiveBinaryIndexInsert(e,t)},P.prototype.adaptiveBinaryIndexRemove=function(e,t,i){var s,n,a,r,o,l,h,c=this.binaryIndices[t],d={};if(Array.isArray(e)){if(1!==(r=e.length)){for(a=0;a<r;a++)d[e[a]]=!0;if(c.values=c.values.filter((function(e){return!d[e]})),!0===i)return;var u=e.slice();for(u.sort((function(e,t){return e-t})),s=c.values.length,n=0;n<s;n++){for(o=c.values[n],a=l=0;a<r&&o>u[a];a++)l++;c.values[n]-=l}return}e=e[0]}if(null===(h=this.getBinaryIndexPosition(e,t)))return null;if(c.values.splice(h,1),!0!==i)for(s=c.values.length,n=0;n<s;n++)c.values[n]>e&&c.values[n]--},P.prototype.calculateRangeStart=function(e,t,i,s){var r=this.data,o=this.binaryIndices[e].values,l=0,h=o.length-1,c=0;if(0===o.length)return-1;for(n.getIn(r[o[l]],e,s),n.getIn(r[o[h]],e,s);l<h;)c=l+h>>1,a.lt(n.getIn(r[o[c]],e,s),t,!1)?l=c+1:h=c;var d=l;return a.aeq(t,n.getIn(r[o[d]],e,s))?d:a.lt(t,n.getIn(r[o[d]],e,s),!1)?i?d:d-1:i?d+1:d},P.prototype.calculateRangeEnd=function(e,t,i){var s=this.data,r=this.binaryIndices[e].values,o=0,l=r.length-1,h=0;if(0===r.length)return-1;for(n.getIn(s[r[o]],e,i),n.getIn(s[r[l]],e,i);o<l;)h=o+l>>1,a.lt(t,n.getIn(s[r[h]],e,i),!1)?l=h:o=h+1;var c=l;return a.aeq(t,n.getIn(s[r[c]],e,i))?c:a.gt(t,n.getIn(s[r[c]],e,i),!1)?c+1:a.aeq(t,n.getIn(s[r[c-1]],e,i))?c-1:c},P.prototype.calculateRange=function(e,t,i){var s,r,o,l=this.data,h=this.binaryIndices[t].values,c=h.length-1;if(0===l.length)return[0,-1];var d=-1!==t.indexOf("."),u=n.getIn(l[h[0]],t,d),p=n.getIn(l[h[c]],t,d);switch(e){case"$eq":case"$aeq":case"$dteq":if(a.lt(i,u,!1)||a.gt(i,p,!1))return[0,-1];break;case"$gt":if(a.gt(i,p,!0))return[0,-1];if(a.gt(u,i,!1))return[0,c];break;case"$gte":if(a.gt(i,p,!1))return[0,-1];if(a.gt(u,i,!0))return[0,c];break;case"$lt":if(a.lt(i,u,!0))return[0,-1];if(a.lt(p,i,!1))return[0,c];break;case"$lte":if(a.lt(i,u,!1))return[0,-1];if(a.lt(p,i,!0))return[0,c];break;case"$between":return a.gt(i[0],p,!1)||a.lt(i[1],u,!1)?[0,-1]:((s=this.calculateRangeStart(t,i[0],!1,d))<0&&s++,c<(o=this.calculateRangeEnd(t,i[1],d))&&o--,a.gt(n.getIn(l[h[s]],t,d),i[0],!0)||s++,a.lt(n.getIn(l[h[o]],t,d),i[1],!0)||o--,o<s?[0,-1]:[s,o]);case"$in":for(var f=[],g=[],m=0,y=i.length;m<y;m++)for(var v=this.calculateRange("$eq",t,i[m]),b=v[0];b<=v[1];b++)void 0===f[b]&&(f[b]=!0,g.push(b));return g}switch(e){case"$eq":case"$aeq":case"$dteq":case"$gte":case"$lt":s=this.calculateRangeStart(t,i,!1,d),r=n.getIn(l[h[s]],t,d)}switch(e){case"$eq":case"$aeq":case"$dteq":case"$lte":case"$gt":o=this.calculateRangeEnd(t,i,d),n.getIn(l[h[o]],t,d)}switch(e){case"$eq":case"$aeq":case"$dteq":return a.aeq(r,i)?[s,o]:[0,-1];case"$gt":return a.aeq(n.getIn(l[h[o]],t,d),i)?[o+1,c]:[o,c];case"$gte":return a.aeq(n.getIn(l[h[s]],t,d),i)?[s,c]:[s+1,c];case"$lt":return a.aeq(n.getIn(l[h[s]],t,d),i)?[0,s-1]:[0,s];case"$lte":return a.aeq(n.getIn(l[h[o]],t,d),i)?[0,o]:[0,o-1];default:return[0,l.length-1]}},P.prototype.by=function(e,t){var i;if(void 0===t)return i=this,function(t){return i.by(e,t)};var s=this.getUniqueIndex(e,!0).get(t);return this.cloneObjects?m(s,this.cloneMethod):s},P.prototype.findOne=function(e){e=e||{};var t=this.chain().find(e,!0).data();return Array.isArray(t)&&0===t.length?null:this.cloneObjects?m(t[0],this.cloneMethod):t[0]},P.prototype.chain=function(e,t){var i=new I(this);return void 0===e?i:i.transform(e,t)},P.prototype.find=function(e){return this.chain().find(e).data()},P.prototype.findOneUnindexed=function(e,t){for(var i=this.data.length;i--;)if(n.getIn(this.data[i],e,!0)===t)return this.data[i];return null},P.prototype.startTransaction=function(){if(this.transactional){this.cachedData=m(this.data,this.cloneMethod),this.cachedIndex=this.idIndex,this.cachedBinaryIndex=this.binaryIndices,this.cachedDirtyIds=this.dirtyIds;for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].startTransaction()}},P.prototype.commit=function(){if(this.transactional){this.cachedData=null,this.cachedIndex=null,this.cachedBinaryIndex=null,this.cachedDirtyIds=null;for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].commit()}},P.prototype.rollback=function(){if(this.transactional){null!==this.cachedData&&null!==this.cachedIndex&&(this.data=this.cachedData,this.idIndex=this.cachedIndex,this.binaryIndices=this.cachedBinaryIndex,this.dirtyIds=this.cachedDirtyIds);for(var e=0;e<this.DynamicViews.length;e++)this.DynamicViews[e].rollback()}},P.prototype.async=function(e,t){setTimeout((function(){if("function"!=typeof e)throw new TypeError("Argument passed for async execution is not a function");e(),t()}),0)},P.prototype.where=function(e){return this.chain().where(e).data()},P.prototype.mapReduce=function(e,t){try{return t(this.data.map(e))}catch(e){throw e}},P.prototype.eqJoin=function(e,t,i,s,n){return new I(this).eqJoin(e,t,i,s,n)},P.prototype.stages={},P.prototype.getStage=function(e){return this.stages[e]||(this.stages[e]={}),this.stages[e]},P.prototype.commitLog=[],P.prototype.stage=function(e,t){var i=JSON.parse(JSON.stringify(t));return this.getStage(e)[t.$loki]=i},P.prototype.commitStage=function(e,t){var i,s=this.getStage(e),n=(new Date).getTime();for(i in s)this.update(s[i]),this.commitLog.push({timestamp:n,message:t,data:JSON.parse(JSON.stringify(s[i]))});this.stages[e]={}},P.prototype.no_op=function(){},P.prototype.extract=function(e){for(var t=0,i=this.data.length,s=D(e),n=[];t<i;t+=1)n.push($(this.data[t],e,s));return n},P.prototype.max=function(e){return Math.max.apply(null,this.extract(e))},P.prototype.min=function(e){return Math.min.apply(null,this.extract(e))},P.prototype.maxRecord=function(e){for(var t,i=0,s=this.data.length,n=D(e),a={index:0,value:void 0};i<s;i+=1)(void 0===t||t<$(this.data[i],e,n))&&(t=$(this.data[i],e,n),a.index=this.data[i].$loki);return a.value=t,a},P.prototype.minRecord=function(e){for(var t,i=0,s=this.data.length,n=D(e),a={index:0,value:void 0};i<s;i+=1)(void 0===t||t>$(this.data[i],e,n))&&(t=$(this.data[i],e,n),a.index=this.data[i].$loki);return a.value=t,a},P.prototype.extractNumerical=function(e){return this.extract(e).map(C).filter(Number).filter((function(e){return!isNaN(e)}))},P.prototype.avg=function(e){return M(this.extractNumerical(e))},P.prototype.stdDev=function(e){return function(e){var t=M(e),i=M(e.map((function(e){var i=e-t;return i*i})));return Math.sqrt(i)}(this.extractNumerical(e))},P.prototype.mode=function(e){var t,i,s,n={},a=this.extract(e);for(i in a.forEach((function(e){n[e]?n[e]+=1:n[e]=1})),n)t?t<n[i]&&(s=i):t=n[s=i];return s},P.prototype.median=function(e){var t=this.extractNumerical(e);t.sort(E);var i=Math.floor(t.length/2);return t.length%2?t[i]:(t[i-1]+t[i])/2},B.prototype={keys:[],values:[],sort:function(e,t){return e<t?-1:t<e?1:0},setSort:function(e){this.bs=new z(e)},bs:function(){return new z(this.sort)},set:function(e,t){var i=this.bs(this.keys,e);i.found?this.values[i.index]=t:(this.keys.splice(i.index,0,e),this.values.splice(i.index,0,t))},get:function(e){return this.values[N(this.keys,e,this.sort).index]}},F.prototype.keyMap={},F.prototype.lokiMap={},F.prototype.set=function(e){var t=e[this.field];if(null!=t){if(this.keyMap[t])throw new Error("Duplicate key for property "+this.field+": "+t);this.keyMap[t]=e,this.lokiMap[e.$loki]=t}},F.prototype.get=function(e){return this.keyMap[e]},F.prototype.byId=function(e){return this.keyMap[this.lokiMap[e]]},F.prototype.update=function(e,t){if(this.lokiMap[e.$loki]!==t[this.field]){var i=this.lokiMap[e.$loki];this.set(t),this.keyMap[i]=void 0}else this.keyMap[e[this.field]]=t},F.prototype.remove=function(e){var t=this.keyMap[e];if(null==t)throw new Error("Key is not in unique index: "+this.field);this.keyMap[e]=void 0,this.lokiMap[t.$loki]=void 0},F.prototype.clear=function(){this.keyMap=Object.create(null),this.lokiMap=Object.create(null)},j.prototype={set:function(e,t){this.index[e]?this.index[e].push(t):this.index[e]=[t]},remove:function(e,t){var i=this.index[e];for(var s in i)i[s]==t&&i.splice(s,1);i.length<1&&(this.index[e]=void 0)},get:function(e){return this.index[e]},clear:function(e){this.index={}}},x.deepFreeze=t,x.freeze=i,x.unFreeze=s,x.LokiOps=p,x.Collection=P,x.DynamicView=T,x.Resultset=I,x.KeyValueStore=B,x.LokiMemoryAdapter=k,x.LokiPartitioningAdapter=_,x.LokiLocalStorageAdapter=O,x.LokiFsAdapter=S,x.persistenceAdapters={fs:S,localStorage:O},x.aeq=r,x.lt=o,x.gt=l,x.Comparators=a,x}()})),w=Phaser.Utils.Objects.GetValue,x={load:function(e,t){Array.isArray(e)&&(e=e.join("")),void 0===t&&(t=!1);for(var i,s,n,a=[],r=[],o=this.frameManager.totalCount,l=m(this.characterCollection).length,h=[],c=0,d=e.length;c<d;c++)if("\n"!==(g=e.charAt(c))){var u=(s=g,(n=void 0)===(n=(i=this.characterCollection).by("character",s))&&(n={character:s,freq:0,alive:!1,lock:!1},i.insert(n)),n);this.freqMode&&u.freq++,u.lock=t,u.alive||(a.push(g),l<o?(u.alive=!0,l++,this.inCacheCount++):h.push(u)),this.characterCollection.update(u)}if(0<h.length){var p=m(this.characterCollection,{exclude:e,lock:!1,freq:this.freqMode});for(c=0,d=h.length;c<d;c++){u=h[c];var f=p.pop();f?(f.alive=!1,this.characterCollection.update(f),u.alive=!0,this.characterCollection.update(u),r.push(f.character)):console.warn("Character cache full, can't add '".concat(u.character,"' character."))}}for(c=0,d=r.length;c<d;c++)this.emit("remove",g,this.textObject),this.frameManager.remove(r[c]);for(c=0,d=a.length;c<d;c++){var g=a[c];this.emit("add",g,this.textObject),this.textObject.setText(g),this.frameManager.paste(g,this.textObject)}return 0<a.length&&this.frameManager.updateTexture().addToBitmapFont(),this},unlock:function(){for(var e=this.characterCollection.find({lock:!0}),t=0,i=e.length;t<i;t++)e[t].lock=!1;return this},getAllData:function(){return e=this.characterCollection,w(undefined,"freq",!0)?e.chain().simplesort("freq",{desc:!0}).data():e.chain().data();var e},clear:function(){return this.characterCollection.clear(),this.frameManager.clear().addToBitmapFont(),this}};Object.assign(x,{overrideBitmapText:function(e){var t=this,i=e.setText;return e.setText=function(s,n){return t.load(s,n),i.call(e,s),e},e}});var k=Phaser.Utils.Objects.GetValue,_=function(){function t(i,s){e(this,t);var n,a,r,o,l,h,c,p,f=k(s,"eventEmitter",void 0),g=k(s,"EventEmitterClass",void 0);this.setEventEmitter(f,g),this.freqMode=k(s,"freqMode",!0),this.frameManager=(n=i,r=u(a=s,"key"),o=u(a,"cellWidth",32),l=u(a,"cellHeight",32),h=u(a,"maxCharacterCount",4096),c=Math.ceil(Math.sqrt(h)),new d(n,r,o*c,l*c,o,l)),this.frameManager.addToBitmapFont(),this.key=this.frameManager.key,this.cellWidth=this.frameManager.cellWidth,this.cellHeight=this.frameManager.cellHeight,this.characterCollection=(void 0===p&&(p=new b("characters.db",{env:"BROWSER"})),p.addCollection("characters",{disableMeta:!0,unique:["character"],indices:["character","freq","alive","lock"]}));var m=k(s,"textObject");m&&this.bindTextObject(m),this.inCacheCount=0,this.load(k(s,"content",""))}return s(t,[{key:"shutdown",value:function(){this.destroyEventEmitter(),this.frameManager.destroy(),this.characterCollection=void 0,this.textObject&&this.textObject.destroy()}},{key:"destroy",value:function(){this.shutdown()}},{key:"bindTextObject",value:function(e){return this.textObject=e,this}}]),t}();return Object.assign(_.prototype,o,x),function(){!function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&a(e,t)}(i,Phaser.Plugins.BasePlugin);var t=function(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var i,s=n(e);if(t){var a=n(this).constructor;i=Reflect.construct(s,arguments,a)}else i=s.apply(this,arguments);return r(this,i)}}(i);function i(s){return e(this,i),t.call(this,s)}return s(i,[{key:"start",value:function(){this.game.events.on("destroy",this.destroy,this)}},{key:"add",value:function(e,t){return new _(e,t)}}]),i}()}()}},i={};function s(e){var n=i[e];if(void 0!==n)return n.exports;var a=i[e]={exports:{}};return t[e].call(a.exports,a,a.exports,s),a.exports}s.m=t,e=[],s.O=(t,i,n,a)=>{if(!i){var r=1/0;for(c=0;c<e.length;c++){for(var[i,n,a]=e[c],o=!0,l=0;l<i.length;l++)(!1&a||r>=a)&&Object.keys(s.O).every((e=>s.O[e](i[l])))?i.splice(l--,1):(o=!1,a<r&&(r=a));if(o){e.splice(c--,1);var h=n();void 0!==h&&(t=h)}}return t}a=a||0;for(var c=e.length;c>0&&e[c-1][2]>a;c--)e[c]=e[c-1];e[c]=[i,n,a]},s.d=(e,t)=>{for(var i in t)s.o(t,i)&&!s.o(e,i)&&Object.defineProperty(e,i,{enumerable:!0,get:t[i]})},s.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),s.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),s.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{var e;s.g.importScripts&&(e=s.g.location+"");var t=s.g.document;if(!e&&t&&(t.currentScript&&(e=t.currentScript.src),!e)){var i=t.getElementsByTagName("script");i.length&&(e=i[i.length-1].src)}if(!e)throw new Error("Automatic publicPath is not supported in this browser");e=e.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),s.p=e})(),(()=>{var e={179:0};s.O.j=t=>0===e[t];var t=(t,i)=>{var n,a,[r,o,l]=i,h=0;if(r.some((t=>0!==e[t]))){for(n in o)s.o(o,n)&&(s.m[n]=o[n]);if(l)var c=l(s)}for(t&&t(i);h<r.length;h++)a=r[h],s.o(e,a)&&e[a]&&e[a][0](),e[a]=0;return s.O(c)},i=self.webpackChunkmerge_heroes=self.webpackChunkmerge_heroes||[];i.forEach(t.bind(null,0)),i.push=t.bind(null,i.push.bind(i))})();var n=s.O(void 0,[216],(()=>s(758)));n=s.O(n)})();