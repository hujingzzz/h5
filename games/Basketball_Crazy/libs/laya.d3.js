!function(F,q,o){o.un,o.uns;var y=o.static,S=o.class,d=o.getset,N=o.__newvec,m=laya.resource.BaseTexture,O=laya.utils.Browser,a=laya.webgl.utils.Buffer,v=laya.webgl.BufferStateBase,W=laya.utils.Byte,b=laya.utils.ClassUtils,e=laya.layagl.CommandEncoder,w=laya.components.Component,s=o.Config,D=laya.resource.Context,t=(laya.events.Event,laya.events.EventDispatcher),U=laya.utils.Handler,J=(laya.webgl.utils.InlcudeFile,laya.layagl.LayaGL),V=laya.layagl.LayaGLRunner,uq=laya.net.Loader,n=laya.net.LoaderManager,G=laya.maths.MathUtil,Q=laya.display.Node,C=laya.maths.Point,M=laya.renders.Render,u=(laya.resource.RenderTexture2D,laya.resource.Resource),l=laya.utils.RunDriver,f=(laya.webgl.shader.Shader,laya.webgl.utils.ShaderCompile),p=laya.webgl.utils.ShaderNode,T=laya.display.Sprite,r=laya.utils.Stat,c=laya.webgl.submit.Submit,_=laya.webgl.submit.SubmitKey,Y=laya.resource.Texture2D,Z=(laya.utils.Timer,laya.net.URL),A=laya.webgl.WebGL,E=laya.webgl.WebGLContext;o.interface("laya.d3.core.IClone"),o.interface("laya.d3.graphics.IVertex"),o.interface("laya.d3.core.scene.IOctreeObject");var x=function(){function e(q,Q,m,a,w){var e;void 0===q&&(q=0),void 0===Q&&(Q=0),void 0===m&&(m=0),void 0===a&&(a=1),(e=w||new Float32Array(4))[0]=q,e[1]=Q,e[2]=m,e[3]=a,this.elements=e;}
S(e,"laya.d3.math.Native.ConchQuaternion");var q=e.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.scaling=function(q,Q){var m=Q.elements,a=this.elements;m[0]=a[0]*q,m[1]=a[1]*q,m[2]=a[2]*q,m[3]=a[3]*q;},q.normalize=function(q){e._normalizeArray(this.elements,q.elements);},q.length=function(){var q=this.elements,Q=q[0],m=q[1],a=q[2],w=q[3];return Math.sqrt(Q*Q+m*m+a*a+w*w);},q.rotateX=function(q,Q){var m=Q.elements,a=this.elements;q*=.5;var w=a[0],e=a[1],F=a[2],W=a[3],s=Math.sin(q),D=Math.cos(q);m[0]=w*D+W*s,m[1]=e*D+F*s,m[2]=F*D-e*s,m[3]=W*D-w*s;},q.rotateY=function(q,Q){var m=Q.elements,a=this.elements;q*=.5;var w=a[0],e=a[1],F=a[2],W=a[3],s=Math.sin(q),D=Math.cos(q);m[0]=w*D-F*s,m[1]=e*D+W*s,m[2]=F*D+w*s,m[3]=W*D-e*s;},q.rotateZ=function(q,Q){var m=Q.elements,a=this.elements;q*=.5;var w=a[0],e=a[1],F=a[2],W=a[3],s=Math.sin(q),D=Math.cos(q);m[0]=w*D+e*s,m[1]=e*D-w*s,m[2]=F*D+W*s,m[3]=W*D-F*s;},q.getYawPitchRoll=function(q){L.transformQuat(L.ForwardRH,this,e.TEMPVector31),L.transformQuat(L.Up,this,e.TEMPVector32);var Q=e.TEMPVector32.elements;e.angleTo(L.ZERO,e.TEMPVector31,e.TEMPVector33);var m=e.TEMPVector33.elements;m[0]==Math.PI/2?(m[1]=e.arcTanAngle(Q[2],Q[0]),m[2]=0):m[0]==-Math.PI/2?(m[1]=e.arcTanAngle(-Q[2],-Q[0]),m[2]=0):(kQ.createRotationY(-m[1],e.TEMPMatrix0),kQ.createRotationX(-m[0],e.TEMPMatrix1),L.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),L.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),m[2]=e.arcTanAngle(Q[1],-Q[0])),m[1]<=-Math.PI&&(m[1]=Math.PI),m[2]<=-Math.PI&&(m[2]=Math.PI),m[1]>=Math.PI&&m[2]>=Math.PI&&(m[1]=0,m[2]=0,m[0]=Math.PI-m[0]);var a=q.elements;a[0]=m[1],a[1]=m[0],a[2]=m[2];},q.invert=function(q){var Q=q.elements,m=this.elements,a=m[0],w=m[1],e=m[2],F=m[3],W=a*a+w*w+e*e+F*F,s=W?1/W:0;Q[0]=-a*s,Q[1]=-w*s,Q[2]=-e*s,Q[3]=F*s;},q.identity=function(){var q=this.elements;q[0]=0,q[1]=0,q[2]=0,q[3]=1;},q.fromArray=function(q,Q){void 0===Q&&(Q=0),this.elements[0]=q[Q+0],this.elements[1]=q[Q+1],this.elements[2]=q[Q+2],this.elements[3]=q[Q+3];},q.cloneTo=function(q){var Q,m,a;if((m=this.elements)!==(a=q.elements))
for(Q=0;Q<4;++Q)a[Q]=m[Q];},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q.equals=function(q){var Q=this.elements,m=q.elements;return qq.nearEqual(Q[0],m[0])&&qq.nearEqual(Q[1],m[1])&&qq.nearEqual(Q[2],m[2])&&qq.nearEqual(Q[3],m[3]);},q.lengthSquared=function(){var q=this.elements[0],Q=this.elements[1],m=this.elements[2],a=this.elements[3];return q*q+Q*Q+m*m+a*a;},d(0,q,"x",function(){return this.elements[0];},function(q){this.elements[0]=q;}),d(0,q,"y",function(){return this.elements[1];},function(q){this.elements[1]=q;}),d(0,q,"z",function(){return this.elements[2];},function(q){this.elements[2]=q;}),d(0,q,"w",function(){return this.elements[3];},function(q){this.elements[3]=q;}),e._dotArray=function(q,Q){return q[0]*Q[0]+q[1]*Q[1]+q[2]*Q[2]+q[3]*Q[3];},e._normalizeArray=function(q,Q){var m=q[0],a=q[1],w=q[2],e=q[3],F=m*m+a*a+w*w+e*e;0<F&&(F=1/Math.sqrt(F),Q[0]=m*F,Q[1]=a*F,Q[2]=w*F,Q[3]=e*F);},e._lerpArray=function(q,Q,m,a){var w=1-m;0<=e._dotArray(q,Q)?(a[0]=w*q[0]+m*Q[0],a[1]=w*q[1]+m*Q[1],a[2]=w*q[2]+m*Q[2],a[3]=w*q[3]+m*Q[3]):(a[0]=w*q[0]-m*Q[0],a[1]=w*q[1]-m*Q[1],a[2]=w*q[2]-m*Q[2],a[3]=w*q[3]-m*Q[3]),e._normalizeArray(a,a);},e.createFromYawPitchRoll=function(q,Q,m,a){var w=.5*m,e=.5*Q,F=.5*q,W=Math.sin(w),s=Math.cos(w),D=Math.sin(e),d=Math.cos(e),v=Math.sin(F),y=Math.cos(F),S=a.elements;S[0]=y*D*s+v*d*W,S[1]=v*d*s-y*D*W,S[2]=y*d*W-v*D*s,S[3]=y*d*s+v*D*W;},e.multiply=function(q,Q,m){var a=q.elements,w=Q.elements,e=m.elements,F=a[0],W=a[1],s=a[2],D=a[3],d=w[0],v=w[1],y=w[2],S=w[3],t=W*y-s*v,o=s*d-F*y,b=F*v-W*d,U=F*d+W*v+s*y;e[0]=F*S+d*D+t,e[1]=W*S+v*D+o,e[2]=s*S+y*D+b,e[3]=D*S-U;},e.arcTanAngle=function(q,Q){return 0==q?1==Q?Math.PI/2:-Math.PI/2:0<q?Math.atan(Q/q):q<0?0<Q?Math.atan(Q/q)+Math.PI:Math.atan(Q/q)-Math.PI:0;},e.angleTo=function(q,Q,m){L.subtract(Q,q,e.TEMPVector30),L.normalize(e.TEMPVector30,e.TEMPVector30),m.elements[0]=Math.asin(e.TEMPVector30.y),m.elements[1]=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x);},e.createFromAxisAngle=function(q,Q,m){var a=m.elements,w=q.elements;Q*=.5;var e=Math.sin(Q);a[0]=e*w[0],a[1]=e*w[1],a[2]=e*w[2],a[3]=Math.cos(Q);},e.createFromMatrix3x3=function(q,Q){var m,a=Q.elements,w=q.elements,e=w[0]+w[4]+w[8];if(0<e)m=Math.sqrt(e+1),a[3]=.5*m,m=.5/m,a[0]=(w[5]-w[7])*m,a[1]=(w[6]-w[2])*m,a[2]=(w[1]-w[3])*m;else{var F=0;w[4]>w[0]&&(F=1),w[8]>w[3*F+F]&&(F=2);var W=(F+1)%3,s=(F+2)%3;m=Math.sqrt(w[3*F+F]-w[3*W+W]-w[3*s+s]+1),a[F]=.5*m,m=.5/m,a[3]=(w[3*W+s]-w[3*s+W])*m,a[W]=(w[3*W+F]+w[3*F+W])*m,a[s]=(w[3*s+F]+w[3*F+s])*m;}},e.createFromMatrix4x4=function(q,Q){var m,a,w=q.elements,e=Q.elements,F=w[0]+w[5]+w[10];0<F?(m=Math.sqrt(F+1),e[3]=.5*m,m=.5/m,e[0]=(w[6]-w[9])*m,e[1]=(w[8]-w[2])*m,e[2]=(w[1]-w[4])*m):w[0]>=w[5]&&w[0]>=w[10]?(a=.5/(m=Math.sqrt(1+w[0]-w[5]-w[10])),e[0]=.5*m,e[1]=(w[1]+w[4])*a,e[2]=(w[2]+w[8])*a,e[3]=(w[6]-w[9])*a):w[5]>w[10]?(a=.5/(m=Math.sqrt(1+w[5]-w[0]-w[10])),e[0]=(w[4]+w[1])*a,e[1]=.5*m,e[2]=(w[9]+w[6])*a,e[3]=(w[8]-w[2])*a):(a=.5/(m=Math.sqrt(1+w[10]-w[0]-w[5])),e[0]=(w[8]+w[2])*a,e[1]=(w[9]+w[6])*a,e[2]=.5*m,e[3]=(w[1]-w[4])*a);},e.slerp=function(q,Q,m,a){var w,e,F,W,s,D=q.elements,d=Q.elements,v=a.elements,y=D[0],S=D[1],t=D[2],o=D[3],b=d[0],U=d[1],J=d[2],V=d[3];return(e=y*b+S*U+t*J+o*V)<0&&(e=-e,b=-b,U=-U,J=-J,V=-V),s=1e-6<1-e?(w=Math.acos(e),F=Math.sin(w),W=Math.sin((1-m)*w)/F,Math.sin(m*w)/F):(W=1-m,m),v[0]=W*y+s*b,v[1]=W*S+s*U,v[2]=W*t+s*J,v[3]=W*o+s*V,v;},e.lerp=function(q,Q,m,a){e._lerpArray(q.elements,Q.elements,m,a.elements);},e.add=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=w[0]+e[0],a[1]=w[1]+e[1],a[2]=w[2]+e[2],a[3]=w[3]+e[3];},e.dot=function(q,Q){return e._dotArray(q.elements,Q.elements);},e.rotationLookAt=function(q,Q,m){e.lookAt(L.ZERO,q,Q,m);},e.lookAt=function(q,Q,m,a){xQ.lookAt(q,Q,m,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,a);},e.invert=function(q,Q){var m=q.elements,a=Q.elements,w=q.lengthSquared();qq.isZero(w)||(w=1/w,a[0]=-m[0]*w,a[1]=-m[1]*w,a[2]=-m[2]*w,a[3]=m[3]*w);},e.rotationMatrix=function(q,Q){var m=q.elements,a=m[0],w=m[1],e=m[2],F=m[3],W=m[4],s=m[5],D=m[6],d=m[7],v=m[8],y=Q.elements,S=NaN,t=NaN,o=a+W+v;0<o?(S=Math.sqrt(o+1),y[3]=.5*S,S=.5/S,y[0]=(s-d)*S,y[1]=(D-e)*S,y[2]=(w-F)*S):y[3]=W<=a&&v<=a?(t=.5/(S=Math.sqrt(1+a-W-v)),y[0]=.5*S,y[1]=(w+F)*t,y[2]=(e+D)*t,(s-d)*t):v<W?(t=.5/(S=Math.sqrt(1+W-a-v)),y[0]=(F+w)*t,y[1]=.5*S,y[2]=(d+s)*t,(D-e)*t):(t=.5/(S=Math.sqrt(1+v-a-W)),y[0]=(D+e)*t,y[1]=(d+s)*t,y[2]=.5*S,(w-F)*t);},e.DEFAULT=new e(),y(e,["TEMPVector30",function(){return this.TEMPVector30=new L();},"TEMPVector31",function(){return this.TEMPVector31=new L();},"TEMPVector32",function(){return this.TEMPVector32=new L();},"TEMPVector33",function(){return this.TEMPVector33=new L();},"TEMPMatrix0",function(){return this.TEMPMatrix0=new kQ();},"TEMPMatrix1",function(){return this.TEMPMatrix1=new kQ();},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new xQ();},"NAN",function(){return this.NAN=new e(NaN,NaN,NaN,NaN);}]),e;}(),B=function(){function q(q,Q,m,a){this.elements=null,void 0===q&&(q=0),void 0===Q&&(Q=0),void 0===m&&(m=0),void 0===a&&(a=0);var w=this.elements=new Float32Array(4);w[0]=q,w[1]=Q,w[2]=m,w[3]=a;}
S(q,"laya.d3.math.Native.ConchVector4");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.fromArray=function(q,Q){void 0===Q&&(Q=0),this.elements[0]=q[Q+0],this.elements[1]=q[Q+1],this.elements[2]=q[Q+2],this.elements[3]=q[Q+3];},Q.cloneTo=function(q){var Q=q.elements,m=this.elements;Q[0]=m[0],Q[1]=m[1],Q[2]=m[2],Q[3]=m[3];},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},Q.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);},Q.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;},d(0,Q,"x",function(){return this.elements[0];},function(q){this.elements[0]=q;}),d(0,Q,"y",function(){return this.elements[1];},function(q){this.elements[1]=q;}),d(0,Q,"z",function(){return this.elements[2];},function(q){this.elements[2]=q;}),d(0,Q,"w",function(){return this.elements[3];},function(q){this.elements[3]=q;}),q.lerp=function(q,Q,m,a){var w=a.elements,e=q.elements,F=Q.elements,W=e[0],s=e[1],D=e[2],d=e[3];w[0]=W+m*(F[0]-W),w[1]=s+m*(F[1]-s),w[2]=D+m*(F[2]-D),w[3]=d+m*(F[3]-d);},q.transformByM4x4=function(q,Q,m){var a=q.elements,w=a[0],e=a[1],F=a[2],W=a[3],s=Q.elements,D=m.elements;D[0]=w*s[0]+e*s[4]+F*s[8]+W*s[12],D[1]=w*s[1]+e*s[5]+F*s[9]+W*s[13],D[2]=w*s[2]+e*s[6]+F*s[10]+W*s[14],D[3]=w*s[3]+e*s[7]+F*s[11]+W*s[15];},q.equals=function(q,Q){var m=q.elements,a=Q.elements;return qq.nearEqual(Math.abs(m[0]),Math.abs(a[0]))&&qq.nearEqual(Math.abs(m[1]),Math.abs(a[1]))&&qq.nearEqual(Math.abs(m[2]),Math.abs(a[2]))&&qq.nearEqual(Math.abs(m[3]),Math.abs(a[3]));},q.normalize=function(q,Q){var m=q.elements,a=Q.elements,w=q.length();0<w&&(a[0]=m[0]*w,a[1]=m[1]*w,a[2]=m[2]*w,a[3]=m[3]*w);},q.add=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=w[0]+e[0],a[1]=w[1]+e[1],a[2]=w[2]+e[2],a[3]=w[3]+e[3];},q.subtract=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=w[0]-e[0],a[1]=w[1]-e[1],a[2]=w[2]-e[2],a[3]=w[3]-e[3];},q.multiply=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=w[0]*e[0],a[1]=w[1]*e[1],a[2]=w[2]*e[2],a[3]=w[3]*e[3];},q.scale=function(q,Q,m){var a=m.elements,w=q.elements;a[0]=w[0]*Q,a[1]=w[1]*Q,a[2]=w[2]*Q,a[3]=w[3]*Q;},q.Clamp=function(q,Q,m,a){var w=q.elements,e=w[0],F=w[1],W=w[2],s=w[3],D=Q.elements,d=D[0],v=D[1],y=D[2],S=D[3],t=m.elements,o=t[0],b=t[1],U=t[2],J=t[3],V=a.elements;e=(e=o<e?o:e)<d?d:e,F=(F=b<F?b:F)<v?v:F,W=(W=U<W?U:W)<y?y:W,s=(s=J<s?J:s)<S?S:s,V[0]=e,V[1]=F,V[2]=W,V[3]=s;},q.distanceSquared=function(q,Q){var m=q.elements,a=Q.elements,w=m[0]-a[0],e=m[1]-a[1],F=m[2]-a[2],W=m[3]-a[3];return w*w+e*e+F*F+W*W;},q.distance=function(q,Q){var m=q.elements,a=Q.elements,w=m[0]-a[0],e=m[1]-a[1],F=m[2]-a[2],W=m[3]-a[3];return Math.sqrt(w*w+e*e+F*F+W*W);},q.dot=function(q,Q){var m=q.elements,a=Q.elements;return m[0]*a[0]+m[1]*a[1]+m[2]*a[2]+m[3]*a[3];},q.min=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=Math.min(w[0],e[0]),a[1]=Math.min(w[1],e[1]),a[2]=Math.min(w[2],e[2]),a[3]=Math.min(w[3],e[3]);},q.max=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=Math.max(w[0],e[0]),a[1]=Math.max(w[1],e[1]),a[2]=Math.max(w[2],e[2]),a[3]=Math.max(w[3],e[3]);},y(q,["ZERO",function(){return this.ZERO=new q();},"ONE",function(){return this.ONE=new q(1,1,1,1);},"UnitX",function(){return this.UnitX=new q(1,0,0,0);},"UnitY",function(){return this.UnitY=new q(0,1,0,0);},"UnitZ",function(){return this.UnitZ=new q(0,0,1,0);},"UnitW",function(){return this.UnitW=new q(0,0,0,1);}]),q;}(),L=function(){function F(q,Q,m,a){var w;this.elements=null,void 0===q&&(q=0),void 0===Q&&(Q=0),void 0===m&&(m=0),w=a||new Float32Array(3),(this.elements=w)[0]=q,w[1]=Q,w[2]=m;}
S(F,"laya.d3.math.Native.ConchVector3");var q=F.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.setValue=function(q,Q,m){this.elements[0]=q,this.elements[1]=Q,this.elements[2]=m;},q.fromArray=function(q,Q){void 0===Q&&(Q=0),this.elements[0]=q[Q+0],this.elements[1]=q[Q+1],this.elements[2]=q[Q+2];},q.cloneTo=function(q){var Q=q.elements,m=this.elements;Q[0]=m[0],Q[1]=m[1],Q[2]=m[2];},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q.toDefault=function(){this.elements[0]=0,this.elements[1]=0,this.elements[2]=0;},d(0,q,"x",function(){return this.elements[0];},function(q){this.elements[0]=q;}),d(0,q,"y",function(){return this.elements[1];},function(q){this.elements[1]=q;}),d(0,q,"z",function(){return this.elements[2];},function(q){this.elements[2]=q;}),F.distanceSquared=function(q,Q){var m=q.elements,a=Q.elements,w=m[0]-a[0],e=m[1]-a[1],F=m[2]-a[2];return w*w+e*e+F*F;},F.distance=function(q,Q){var m=q.elements,a=Q.elements,w=m[0]-a[0],e=m[1]-a[1],F=m[2]-a[2];return Math.sqrt(w*w+e*e+F*F);},F.min=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=Math.min(w[0],e[0]),a[1]=Math.min(w[1],e[1]),a[2]=Math.min(w[2],e[2]);},F.max=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=Math.max(w[0],e[0]),a[1]=Math.max(w[1],e[1]),a[2]=Math.max(w[2],e[2]);},F.transformQuat=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements,F=w[0],W=w[1],s=w[2],D=e[0],d=e[1],v=e[2],y=e[3],S=y*F+d*s-v*W,t=y*W+v*F-D*s,o=y*s+D*W-d*F,b=-D*F-d*W-v*s;a[0]=S*y+b* -D+t* -v-o* -d,a[1]=t*y+b* -d+o* -D-S* -v,a[2]=o*y+b* -v+S* -d-t* -D;},F.scalarLength=function(q){var Q=q.elements,m=Q[0],a=Q[1],w=Q[2];return Math.sqrt(m*m+a*a+w*w);},F.scalarLengthSquared=function(q){var Q=q.elements,m=Q[0],a=Q[1],w=Q[2];return m*m+a*a+w*w;},F.normalize=function(q,Q){var m=q.elements,a=Q.elements,w=m[0],e=m[1],F=m[2],W=w*w+e*e+F*F;0<W&&(W=1/Math.sqrt(W),a[0]=m[0]*W,a[1]=m[1]*W,a[2]=m[2]*W);},F.multiply=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=w[0]*e[0],a[1]=w[1]*e[1],a[2]=w[2]*e[2];},F.scale=function(q,Q,m){var a=m.elements,w=q.elements;a[0]=w[0]*Q,a[1]=w[1]*Q,a[2]=w[2]*Q;},F.lerp=function(q,Q,m,a){var w=a.elements,e=q.elements,F=Q.elements,W=e[0],s=e[1],D=e[2];w[0]=W+m*(F[0]-W),w[1]=s+m*(F[1]-s),w[2]=D+m*(F[2]-D);},F.transformV3ToV3=function(q,Q,m){var a=F._tempVector4;F.transformV3ToV4(q,Q,a);var w=a.elements,e=m.elements;e[0]=w[0],e[1]=w[1],e[2]=w[2];},F.transformV3ToV4=function(q,Q,m){var a=q.elements,w=a[0],e=a[1],F=a[2],W=Q.elements,s=m.elements;s[0]=w*W[0]+e*W[4]+F*W[8]+W[12],s[1]=w*W[1]+e*W[5]+F*W[9]+W[13],s[2]=w*W[2]+e*W[6]+F*W[10]+W[14],s[3]=w*W[3]+e*W[7]+F*W[11]+W[15];},F.TransformNormal=function(q,Q,m){var a=q.elements,w=a[0],e=a[1],F=a[2],W=Q.elements,s=m.elements;s[0]=w*W[0]+e*W[4]+F*W[8],s[1]=w*W[1]+e*W[5]+F*W[9],s[2]=w*W[2]+e*W[6]+F*W[10];},F.transformCoordinate=function(q,Q,m){var a=q.elements,w=a[0],e=a[1],F=a[2],W=Q.elements,s=w*W[3]+e*W[7]+F*W[11]+W[15],D=m.elements;D[0]=w*W[0]+e*W[4]+F*W[8]+W[12]/s,D[1]=w*W[1]+e*W[5]+F*W[9]+W[13]/s,D[2]=w*W[2]+e*W[6]+F*W[10]+W[14]/s;},F.Clamp=function(q,Q,m,a){var w=q.elements,e=w[0],F=w[1],W=w[2],s=Q.elements,D=s[0],d=s[1],v=s[2],y=m.elements,S=y[0],t=y[1],o=y[2],b=a.elements;e=(e=S<e?S:e)<D?D:e,F=(F=t<F?t:F)<d?d:F,W=(W=o<W?o:W)<v?v:W,b[0]=e,b[1]=F,b[2]=W;},F.add=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=w[0]+e[0],a[1]=w[1]+e[1],a[2]=w[2]+e[2];},F.subtract=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements;a[0]=w[0]-e[0],a[1]=w[1]-e[1],a[2]=w[2]-e[2];},F.cross=function(q,Q,m){var a=q.elements,w=Q.elements,e=m.elements,F=a[0],W=a[1],s=a[2],D=w[0],d=w[1],v=w[2];e[0]=W*v-s*d,e[1]=s*D-F*v,e[2]=F*d-W*D;},F.dot=function(q,Q){var m=q.elements,a=Q.elements;return m[0]*a[0]+m[1]*a[1]+m[2]*a[2];},F.equals=function(q,Q){var m=q.elements,a=Q.elements;return qq.nearEqual(m[0],a[0])&&qq.nearEqual(m[1],a[1])&&qq.nearEqual(m[2],a[2]);},F.ZERO=new F(0,0,0),F.ONE=new F(1,1,1),F.NegativeUnitX=new F(-1,0,0),F.UnitX=new F(1,0,0),F.UnitY=new F(0,1,0),F.UnitZ=new F(0,0,1),F.ForwardRH=new F(0,0,-1),F.ForwardLH=new F(0,0,1),F.Up=new F(0,1,0),F.NAN=new F(NaN,NaN,NaN),y(F,["_tempVector4",function(){return this._tempVector4=new B();}]),F;}(),fq=function(){function q(q){this._color=null,this.enbale=!1,this._color=q;}
S(q,"laya.d3.core.particleShuriKen.module.ColorOverLifetime");var Q=q.prototype;return Q.cloneTo=function(q){var Q=q;this._color.cloneTo(Q._color),Q.enbale=this.enbale;},Q.clone=function(){var q;switch(this._color.type){case 0:q=Tq.createByConstant(this._color.constant.clone());break;case 1:q=Tq.createByGradient(this._color.gradient.clone());break;case 2:q=Tq.createByRandomTwoConstant(this._color.constantMin.clone(),this._color.constantMax.clone());break;case 3:q=Tq.createByRandomTwoGradient(this._color.gradientMin.clone(),this._color.gradientMax.clone());}
var Q=new this.constructor(q);return Q.enbale=this.enbale,Q;},d(0,Q,"color",function(){return this._color;}),q;}(),K=function(){function q(){this.enable=!1,this.randomDirection=!1;}
S(q,"laya.d3.core.particleShuriKen.module.shape.BaseShape");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q._getShapeBoundBox=function(q){throw new Error("BaseShape: must override it.");},Q._getSpeedBoundBox=function(q){throw new Error("BaseShape: must override it.");},Q.generatePositionAndDirection=function(q,Q,m,a){throw new Error("BaseShape: must override it.");},Q._calculateProceduralBounds=function(q,Q,m){this._getShapeBoundBox(q);var a=q.min,w=q.max;_q.multiply(a,Q,a),_q.multiply(w,Q,w);var e=new GQ(new _q(),new _q());this.randomDirection?(e.min=new _q(-1,-1,-1),e.max=new _q(1,1,1)):this._getSpeedBoundBox(e);var F=new GQ(new _q(),new _q()),W=F.min,s=F.max;_q.scale(e.min,m.y,W),_q.scale(e.max,m.y,s),_q.add(q.min,W,W),_q.add(q.max,s,s),_q.min(q.min,W,q.min),_q.max(q.max,W,q.max);var D=new GQ(new _q(),new _q()),d=D.min,v=D.max;_q.scale(e.min,m.x,d),_q.scale(e.max,m.x,v),_q.min(D.min,v,W),_q.max(D.min,v,s),_q.min(q.min,W,q.min),_q.max(q.max,W,q.max);},Q.cloneTo=function(q){q.enable=this.enable;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q;}(),k=function(){function Q(){this._attatched=!1,this._indexInCompound=-1,this._compoundParent=null,this._attatchedCollisionObject=null,this._referenceCount=0,this.needsCustomCollisionCallback=!1,this._scale=new _q(1,1,1),this._centerMatrix=new kQ(),this._localOffset=new _q(0,0,0),this._localRotation=new eq(0,0,0,1);}
S(Q,"laya.d3.physics.shape.ColliderShape");var q=Q.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q._setScale=function(q){this._compoundParent?this.updateLocalTransformations():(Q._nativeScale.setValue(q.x,q.y,q.z),this._nativeShape.setLocalScaling(Q._nativeScale));},q._addReference=function(){this._referenceCount++;},q._removeReference=function(){this._referenceCount--;},q.updateLocalTransformations=function(){if(this._compoundParent){var q=Q._tempVector30;_q.multiply(this.localOffset,this._scale,q),Q._createAffineTransformation(q,this.localRotation,this._centerMatrix.elements);}else Q._createAffineTransformation(this.localOffset,this.localRotation,this._centerMatrix.elements);},q.cloneTo=function(q){var Q=q;this._localOffset.cloneTo(Q.localOffset),this._localRotation.cloneTo(Q.localRotation),Q.localOffset=Q.localOffset,Q.localRotation=Q.localRotation;},q.clone=function(){return null;},q.destroy=function(){this._nativeShape&&(R._physics3D.destroy(this._nativeShape),this._nativeShape=null);},d(0,q,"type",function(){return this._type;}),d(0,q,"localOffset",function(){return this._localOffset;},function(q){this._localOffset=q,this._compoundParent&&this._compoundParent._updateChildTransform(this);}),d(0,q,"localRotation",function(){return this._localRotation;},function(q){this._localRotation=q,this._compoundParent&&this._compoundParent._updateChildTransform(this);}),Q._creatShape=function(q){var Q;switch(q.type){case"BoxColliderShape":var m=q.size;Q=m?new sm(m[0],m[1],m[2]):new sm();break;case"SphereColliderShape":Q=new qm(q.radius);break;case"CapsuleColliderShape":Q=new wm(q.radius,q.height,q.orientation);break;case"MeshColliderShape":var a=new lm();q.mesh&&(a.mesh=uq.getRes(q.mesh)),Q=a;break;case"ConeColliderShape":Q=new _m(q.radius,q.height,q.orientation);break;case"CylinderColliderShape":Q=new om(q.radius,q.height,q.orientation);break;default:throw"unknown shape type.";}
if(q.center){var w=Q.localOffset;w.fromArray(q.center),Q.localOffset=w;}
return Q;},Q._createAffineTransformation=function(q,Q,m){var a=Q.x,w=Q.y,e=Q.z,F=Q.w,W=a+a,s=w+w,D=e+e,d=a*W,v=a*s,y=a*D,S=w*s,t=w*D,o=e*D,b=F*W,U=F*s,J=F*D;m[0]=1-(S+o),m[1]=v+J,m[2]=y-U,m[3]=0,m[4]=v-J,m[5]=1-(d+o),m[6]=t+b,m[7]=0,m[8]=y+U,m[9]=t-b,m[10]=1-(d+S),m[11]=0,m[12]=q.x,m[13]=q.y,m[14]=q.z,m[15]=1;},Q.SHAPEORIENTATION_UPX=0,Q.SHAPEORIENTATION_UPY=1,Q.SHAPEORIENTATION_UPZ=2,Q.SHAPETYPES_BOX=0,Q.SHAPETYPES_SPHERE=1,Q.SHAPETYPES_CYLINDER=2,Q.SHAPETYPES_CAPSULE=3,Q.SHAPETYPES_CONVEXHULL=4,Q.SHAPETYPES_COMPOUND=5,Q.SHAPETYPES_STATICPLANE=6,Q.SHAPETYPES_CONE=7,y(Q,["_tempVector30",function(){return this._tempVector30=new _q();},"_nativeScale",function(){return this._nativeScale=new R._physics3D.btVector3(1,1,1);},"_nativeVector30",function(){return this._nativeVector30=new R._physics3D.btVector3(0,0,0);},"_nativQuaternion0",function(){return this._nativQuaternion0=new R._physics3D.btQuaternion(0,0,0,1);},"_nativeTransform0",function(){return this._nativeTransform0=new R._physics3D.btTransform();}]),Q;}(),R=function(){function B(){}
return S(B,"Laya3D"),d(1,B,"enbalePhysics",function(){return B._enbalePhysics;}),B._cancelLoadByUrl=function(q){o.loader.cancelLoadByUrl(q),B._innerFirstLevelLoaderManager.cancelLoadByUrl(q),B._innerSecondLevelLoaderManager.cancelLoadByUrl(q),B._innerThirdLevelLoaderManager.cancelLoadByUrl(q),B._innerFourthLevelLoaderManager.cancelLoadByUrl(q);},B._changeWebGLSize=function(q,Q){A.onStageResize(q,Q),H.clientWidth=q,H.clientHeight=Q;},B.__init__=function(q,Q,m){if(s.isAntialias=m.isAntialias,s.isAlpha=m.isAlpha,s.premultipliedAlpha=m.premultipliedAlpha,s.isStencil=m.isStencil,A.enable()){l.changeWebGLSize=B._changeWebGLSize,M.is3DMode=!0,o.init(q,Q),M.supportWebGLPlusRendering||(J.instance=A.mainContext,J.instance.createCommandEncoder=function(q,Q,m){return void 0===q&&(q=128),void 0===Q&&(Q=64),void 0===m&&(m=!1),new e(this,q,Q,m);}),B.enableNative3D(),Mm.__init__(),Im.__init__(),Ua.__init__(),la.__init__(),Oa.__init__(),Ym.__init__(),da.__init__(),ea.__init__(),Sa.__init__(),ma.__init__(),Pm.__init__(),na.__init__(),Qa.__init__(),Wa.__init__(),sa.__init__(),Fa.__init__(),va.__init__(),Da.__init__(),kq.__init__(),aa.defaultMaterial.lock=!0,da.defaultMaterial.lock=!0,Wa.defaultMaterial.lock=!0,ea.defaultMaterial.lock=!0,Sa.defaultMaterial.lock=!0,Pm.defaultMaterial.lock=!0,Fa.defaultMaterial.lock=!0,Qa.defaultMaterial.lock=!0,ma.defaultMaterial.lock=!0,ya.defaultMaterial.lock=!0,sa.defaultMaterial.lock=!0,Y.__init__(),ba.__init__(),Cm.__init__(),rm.__init__(),xm.__init__(),pQ.__init__(),NQ.__init__(),nq.__init__();var a=n.createMap;a.lh=["HIERARCHY",Mm._parse],a.ls=["HIERARCHY",gm._parse],a.lm=["MESH",Gm._parse],a.lmat=["MATERIAL",Ym._parse],a.ltc=["TEXTURECUBE",ba._parse],a.jpg=["TEXTURE2D",Y._parse],a.jpeg=["TEXTURE2D",Y._parse],a.bmp=["TEXTURE2D",Y._parse],a.gif=["TEXTURE2D",Y._parse],a.png=["TEXTURE2D",Y._parse],a.dds=["TEXTURE2D",Y._parse],a.ktx=["TEXTURE2D",Y._parse],a.pvr=["TEXTURE2D",Y._parse],a.lani=["ANIMATIONCLIP",km._parse],a.lav=["AVATAR",Lm._parse],a.thdata=["TERRAINHEIGHTDATA",Km._pharse];var w=uq.parserMap;w.HIERARCHY=B._loadHierarchy,w.MESH=B._loadMesh,w.MATERIAL=B._loadMaterial,w.TEXTURECUBE=B._loadTextureCube,w.TEXTURE2D=B._loadTexture2D,w.ANIMATIONCLIP=B._loadAnimationClip,w.AVATAR=B._loadAvatar,B._innerFirstLevelLoaderManager.on("error",null,B._eventLoadManagerError),B._innerSecondLevelLoaderManager.on("error",null,B._eventLoadManagerError),B._innerThirdLevelLoaderManager.on("error",null,B._eventLoadManagerError),B._innerFourthLevelLoaderManager.on("error",null,B._eventLoadManagerError);}else alert("Laya3D init error,must support webGL!");},B.enableNative3D=function(){if(M.isConchApp){J=F.LayaGLContext;var q=Fq,Q=Rm,m=Lm,a=NQ,w=jm;if(M.supportWebGLPlusRendering&&(q.prototype._initData=q.prototype._initDataForNative,q.prototype.setBool=q.prototype.setBoolForNative,q.prototype.getBool=q.prototype.getBoolForNative,q.prototype.setInt=q.prototype.setIntForNative,q.prototype.getInt=q.prototype.getIntForNative,q.prototype.setNumber=q.prototype.setNumberForNative,q.prototype.getNumber=q.prototype.getNumberForNative,q.prototype.setVector=q.prototype.setVectorForNative,q.prototype.getVector=q.prototype.getVectorForNative,q.prototype.setVector2=q.prototype.setVector2ForNative,q.prototype.getVector2=q.prototype.getVector2ForNative,q.prototype.setVector3=q.prototype.setVector3ForNative,q.prototype.getVector3=q.prototype.getVector3ForNative,q.prototype.setQuaternion=q.prototype.setQuaternionForNative,q.prototype.getQuaternion=q.prototype.getQuaternionForNative,q.prototype.setMatrix4x4=q.prototype.setMatrix4x4ForNative,q.prototype.getMatrix4x4=q.prototype.getMatrix4x4ForNative,q.prototype.setBuffer=q.prototype.setBufferForNative,q.prototype.getBuffer=q.prototype.getBufferForNative,q.prototype.setTexture=q.prototype.setTextureForNative,q.prototype.getTexture=q.prototype.getTextureForNative,q.prototype.setAttribute=q.prototype.setAttributeForNative,q.prototype.getAttribute=q.prototype.getAttributeForNative,q.prototype.cloneTo=q.prototype.cloneToForNative,q.prototype.getData=q.prototype.getDataForNative,Q.prototype._uniformMatrix2fv=Q.prototype._uniformMatrix2fvForNative,Q.prototype._uniformMatrix3fv=Q.prototype._uniformMatrix3fvForNative,Q.prototype._uniformMatrix4fv=Q.prototype._uniformMatrix4fvForNative,w.prototype._renderUpdateWithCamera=w.prototype._renderUpdateWithCameraForNative),M.supportWebGLPlusCulling&&(a.renderObjectCulling=NQ.renderObjectCullingNative),M.supportWebGLPlusAnimation){m.prototype._cloneDatasToAnimator=m.prototype._cloneDatasToAnimatorNative,bm=F.conchFloatKeyframe,cm=F.conchFloatArrayKeyframe,Am=F.conchFloatArrayKeyframe,OQ=F.conchKeyframeNode,Iq=F.conchKeyframeNodeList;var e=km;e.prototype._evaluateClipDatasRealTime=e.prototype._evaluateClipDatasRealTimeForNative;}}
A.shaderHighPrecision=!1,J.instance.getShaderPrecisionFormat(35632,36338).precision?A.shaderHighPrecision=!0:A.shaderHighPrecision=!1;},B.formatRelativePath=function(q,Q){var m;if(m=q+Q,"."===Q.charAt(0)){for(var a=m.split("/"),w=0,e=a.length;w<e;w++)
if(".."==a[w]){var F=w-1;0<F&&".."!==a[F]&&(a.splice(F,2),w-=2);}
m=a.join("/");}
return m;},B._endLoad=function(q,Q,m){if(m)
for(var a=0,w=m.length;a<w;a++){var e=uq.getRes(m[a]);e&&e._removeReference();}
q.endLoad(Q);},B._eventLoadManagerError=function(q){o.loader.event("error",q);},B._addHierarchyInnerUrls=function(q,Q,m,a,w,e,F,W){var s=B.formatRelativePath(a,w);return m&&(s+=m),q.push({url:s,type:e,constructParams:F,propertyParams:W}),Q.push(s),s;},B._getSprite3DHierarchyInnerUrls=function(q,Q,m,a,w,e,F,W){var s=0,D=0,d=q.props;switch(q.type){case"Scene3D":var v=d.lightmaps;for(s=0,D=v.length;s<D;s++){var y=v[s];y.path=B._addHierarchyInnerUrls(w,e,F,W,y.path,"TEXTURE2D",y.constructParams,y.propertyParams);}
var S=d.reflectionTexture;if(S&&(d.reflectionTexture=B._addHierarchyInnerUrls(a,e,F,W,S,"TEXTURECUBE")),d.sky){var t=d.sky.material;t&&(t.path=B._addHierarchyInnerUrls(m,e,F,W,t.path,"MATERIAL"));}
break;case"Camera":var o=d.skyboxMaterial;o&&(o.path=B._addHierarchyInnerUrls(m,e,F,W,o.path,"MATERIAL"));break;case"TrailSprite3D":case"MeshSprite3D":case"SkinnedMeshSprite3D":var b=d.meshPath;b&&(d.meshPath=B._addHierarchyInnerUrls(Q,e,F,W,b,"MESH"));var U=d.materials;if(U)
for(s=0,D=U.length;s<D;s++)U[s].path=B._addHierarchyInnerUrls(m,e,F,W,U[s].path,"MATERIAL");break;case"ShuriKenParticle3D":var J=d.meshPath;J&&(d.meshPath=B._addHierarchyInnerUrls(Q,e,F,W,J,"MESH")),d.material.path=B._addHierarchyInnerUrls(m,e,F,W,d.material.path,"MATERIAL");break;case"Terrain":B._addHierarchyInnerUrls(w,e,F,W,d.dataPath,"TERRAIN");}
var V=q.components;if(V)
for(var n=0,O=V.length;n<O;n++){var C=V[n];switch(C.type){case"Animator":C.avatarPath;var l=C.avatar;l&&(l.path=B._addHierarchyInnerUrls(w,e,F,W,l.path,"AVATAR"));var u=C.clipPaths;if(u)
for(s=0,D=u.length;s<D;s++)u[s]=B._addHierarchyInnerUrls(w,e,F,W,u[s],"ANIMATIONCLIP");else{var f=C.layers;for(s=0;s<f.length;s++)
for(var p=f[s].states,T=0,c=p.length;T<c;T++){var r=p[T].clipPath;r&&(p[T].clipPath=B._addHierarchyInnerUrls(w,e,F,W,r,"ANIMATIONCLIP"));}}
break;case"PhysicsCollider":case"Rigidbody3D":case"CharacterController":var _=C.shapes;for(s=0;s<_.length;s++){var Z=_[s];if("MeshColliderShape"===Z.type){var A=Z.mesh;A&&(Z.mesh=B._addHierarchyInnerUrls(Q,e,F,W,A,"MESH"));}}}}
var E=q.child;for(s=0,D=E.length;s<D;s++)B._getSprite3DHierarchyInnerUrls(E[s],Q,m,a,w,e,F,W);},B._loadHierarchy=function(q){q.on("loaded",null,B._onHierarchylhLoaded,[q]),q.load(q.url,"json",!1,null,!0);},B._onHierarchylhLoaded=function(q,Q){var m=q.url,a=Rq.getURLVerion(m),w=Z.getPath(m),e=[],F=[],W=[],s=[],D=[];B._getSprite3DHierarchyInnerUrls(Q.data,e,F,W,s,D,a,w);var d=e.length+F.length+s.length,v=d+1,y=1/v;if(B._onProcessChange(q,0,y,1),0<s.length){var S=d/v,t=U.create(null,B._onProcessChange,[q,y,S],!1);B._innerFourthLevelLoaderManager._create(s,!1,U.create(null,B._onHierarchyInnerForthLevResouLoaded,[q,t,Q,D,e,F,W,y+S*s.length,S]),t,null,null,null,1,!0);}else B._onHierarchyInnerForthLevResouLoaded(q,null,Q,D,e,F,W,y,S);},B._onHierarchyInnerForthLevResouLoaded=function(q,Q,m,a,w,e,F,W,s){if(Q&&Q.recover(),0<F.length){var D=U.create(null,B._onProcessChange,[q,W,s],!1);B._innerThirdLevelLoaderManager._create(F,!1,U.create(null,B._onHierarchyInnerThirdLevResouLoaded,[q,D,m,a,w,e,W+s*e.length,s]),Q,null,null,null,1,!0);}else B._onHierarchyInnerThirdLevResouLoaded(q,null,m,a,w,e,W,s);},B._onHierarchyInnerThirdLevResouLoaded=function(q,Q,m,a,w,e,F,W){if(Q&&Q.recover(),0<e.length){var s=U.create(null,B._onProcessChange,[q,F,W],!1);B._innerSecondLevelLoaderManager._create(e,!1,U.create(null,B._onHierarchyInnerSecondLevResouLoaded,[q,s,m,a,w,F+W*e.length,W]),Q,null,null,null,1,!0);}else B._onHierarchyInnerSecondLevResouLoaded(q,null,m,a,w,F,W);},B._onHierarchyInnerSecondLevResouLoaded=function(q,Q,m,a,w,e,F){if(Q&&Q.recover(),0<w.length){var W=U.create(null,B._onProcessChange,[q,e,F],!1);B._innerFirstLevelLoaderManager._create(w,!1,U.create(null,B._onHierarchyInnerFirstLevResouLoaded,[q,W,m,a]),Q,null,null,null,1,!0);}else B._onHierarchyInnerFirstLevResouLoaded(q,null,m,a);},B._onHierarchyInnerFirstLevResouLoaded=function(q,Q,m,a){Q&&Q.recover(),q._cache=q._createCache;var w="Scene3D"===m.data.type?gm._parse(m,q._propertyParams,q._constructParams):Mm._parse(m,q._propertyParams,q._constructParams);B._endLoad(q,w,a);},B._loadMesh=function(q){q.on("loaded",null,B._onMeshLmLoaded,[q]),q.load(q.url,"arraybuffer",!1,null,!0);},B._onMeshLmLoaded=function(q,Q){q._cache=q._createCache;var m=Gm._parse(Q,q._propertyParams,q._constructParams);B._endLoad(q,m);},B._loadMaterial=function(q){q.on("loaded",null,B._onMaterilLmatLoaded,[q]),q.load(q.url,"json",!1,null,!0);},B._onMaterilLmatLoaded=function(q,Q){var m,a=q.url,w=Rq.getURLVerion(a),e=Z.getPath(a),F=[],W=[];Q.customProps;switch(Q.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var s=0,D=0,d=Q.props.textures;if(d)
for(s=0,D=d.length;s<D;s++){var v=d[s],y=v.path;y&&(m=B.formatRelativePath(e,y),w&&(m+=w),F.push({url:m,constructParams:v.constructParams,propertyParams:v.propertyParams}),W.push(m),v.path=m);}
break;default:throw new Error("Laya3D:unkonwn version.");}
var S=F.length,t=S+1,o=1/t;if(B._onProcessChange(q,0,o,1),0<S){var b=U.create(null,B._onProcessChange,[q,o,S/t],!1);B._innerFourthLevelLoaderManager._create(F,!1,U.create(null,B._onMateialTexturesLoaded,[q,b,Q,W]),b,null,null,null,1,!0);}else B._onMateialTexturesLoaded(q,null,Q,null);},B._onMateialTexturesLoaded=function(q,Q,m,a){q._cache=q._createCache;var w=Ym._parse(m,q._propertyParams,q._constructParams);B._endLoad(q,w,a),Q&&Q.recover();},B._loadAvatar=function(m){m.on("loaded",null,function(q){m._cache=m._createCache;var Q=Lm._parse(q,m._propertyParams,m._constructParams);B._endLoad(m,Q);}),m.load(m.url,"json",!1,null,!0);},B._loadAnimationClip=function(m){m.on("loaded",null,function(q){m._cache=m._createCache;var Q=km._parse(q,m._propertyParams,m._constructParams);B._endLoad(m,Q);}),m.load(m.url,"arraybuffer",!1,null,!0);},B._loadTexture2D=function(m){var q,Q=m.url,a=Q.lastIndexOf(".")+1,w=Q.indexOf("?"),e=-1==w?Q.length:w;switch(Q.substr(a,e-a)){case"jpg":case"jpeg":case"bmp":case"gif":case"png":q="nativeimage";break;case"dds":case"ktx":case"pvr":q="arraybuffer";}
m.on("loaded",null,function(q){m._cache=m._createCache;var Q=Y._parse(q,m._propertyParams,m._constructParams);B._endLoad(m,Q);}),m.load(m.url,q,!1,null,!0);},B._loadTextureCube=function(q){q.on("loaded",null,B._onTextureCubeLtcLoaded,[q]),q.load(q.url,"json",!1,null,!0);},B._onTextureCubeLtcLoaded=function(q,Q){var m=Z.getPath(q.url),a=[B.formatRelativePath(m,Q.front),B.formatRelativePath(m,Q.back),B.formatRelativePath(m,Q.left),B.formatRelativePath(m,Q.right),B.formatRelativePath(m,Q.up),B.formatRelativePath(m,Q.down)];B._onProcessChange(q,0,1/7,1);var w=U.create(null,B._onProcessChange,[q,1/7,6/7],!1);B._innerFourthLevelLoaderManager.load(a,U.create(null,B._onTextureCubeImagesLoaded,[q,a,w]),w,"nativeimage");},B._onTextureCubeImagesLoaded=function(q,Q,m){for(var a=new Array(6),w=0;w<6;w++)a[w]=uq.getRes(Q[w]);q._cache=q._createCache;var e=ba._parse(a,q._propertyParams,q._constructParams);for(m.recover(),w=0;w<6;w++)uq.clearRes(Q[w]);B._endLoad(q,e);},B._onProcessChange=function(q,Q,m,a){(a=Q+a*m)<1&&q.event("progress",a);},B.init=function(q,Q,m,a){if(!B._isInit){B._isInit=!0,(m=m||dQ._default).cloneTo(B._config),B._editerEnvironment=B._config._editerEnvironment;var w=F.Physics3D;null==w?(B._enbalePhysics=!1,B.__init__(q,Q,B._config),a&&a.run()):(B._enbalePhysics=!0,w(1024*B._config.defaultPhysicsMemory*1024).then(function(){B.__init__(q,Q,B._config),a&&a.run();}));}},B.HIERARCHY="HIERARCHY",B.MESH="MESH",B.MATERIAL="MATERIAL",B.TEXTURE2D="TEXTURE2D",B.TEXTURECUBE="TEXTURECUBE",B.ANIMATIONCLIP="ANIMATIONCLIP",B.AVATAR="AVATAR",B.TERRAINHEIGHTDATA="TERRAINHEIGHTDATA",B.TERRAINRES="TERRAIN",B._isInit=!1,B._enbalePhysics=!1,B._editerEnvironment=!1,y(B,["_innerFirstLevelLoaderManager",function(){return this._innerFirstLevelLoaderManager=new n();},"_innerSecondLevelLoaderManager",function(){return this._innerSecondLevelLoaderManager=new n();},"_innerThirdLevelLoaderManager",function(){return this._innerThirdLevelLoaderManager=new n();},"_innerFourthLevelLoaderManager",function(){return this._innerFourthLevelLoaderManager=new n();},"_physics3D",function(){return this._physics3D=F.Physics3D;},"_config",function(){return this._config=new dQ();},"physicsSettings",function(){return this.physicsSettings=new Qq();}]),B;}(),pq=function(){function a(){this._type=0,this._constant=0,this._overTime=null,this._constantMin=0,this._constantMax=0,this._overTimeMin=null,this._overTimeMax=null;}
S(a,"laya.d3.core.particleShuriKen.module.FrameOverTime");var q=a.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.cloneTo=function(q){var Q=q;Q._type=this._type,Q._constant=this._constant,this._overTime.cloneTo(Q._overTime),Q._constantMin=this._constantMin,Q._constantMax=this._constantMax,this._overTimeMin.cloneTo(Q._overTimeMin),this._overTimeMax.cloneTo(Q._overTimeMax);},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,q,"frameOverTimeData",function(){return this._overTime;}),d(0,q,"constant",function(){return this._constant;}),d(0,q,"type",function(){return this._type;}),d(0,q,"frameOverTimeDataMin",function(){return this._overTimeMin;}),d(0,q,"constantMin",function(){return this._constantMin;}),d(0,q,"frameOverTimeDataMax",function(){return this._overTimeMax;}),d(0,q,"constantMax",function(){return this._constantMax;}),a.createByConstant=function(q){var Q=new a();return Q._type=0,Q._constant=q,Q;},a.createByOverTime=function(q){var Q=new a();return Q._type=1,Q._overTime=q,Q;},a.createByRandomTwoConstant=function(q,Q){var m=new a();return m._type=2,m._constantMin=q,m._constantMax=Q,m;},a.createByRandomTwoOverTime=function(q,Q){var m=new a();return m._type=3,m._overTimeMin=q,m._overTimeMax=Q,m;},a;}(),z=function(){function q(){this.cull=0,this.blend=0,this.srcBlend=0,this.dstBlend=0,this.srcBlendRGB=0,this.dstBlendRGB=0,this.srcBlendAlpha=0,this.dstBlendAlpha=0,this.blendConstColor=null,this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=0,this.depthWrite=!1,this.cull=2,this.blend=0,this.srcBlend=1,this.dstBlend=0,this.srcBlendRGB=1,this.dstBlendRGB=0,this.srcBlendAlpha=1,this.dstBlendAlpha=0,this.blendConstColor=new rq(1,1,1,1),this.blendEquation=0,this.blendEquationRGB=0,this.blendEquationAlpha=0,this.depthTest=515,this.depthWrite=!0;}
S(q,"laya.d3.core.material.RenderState");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.cloneTo=function(q){var Q=q;Q.cull=this.cull,Q.blend=this.blend,Q.srcBlend=this.srcBlend,Q.dstBlend=this.dstBlend,Q.srcBlendRGB=this.srcBlendRGB,Q.dstBlendRGB=this.dstBlendRGB,Q.srcBlendAlpha=this.srcBlendAlpha,Q.dstBlendAlpha=this.dstBlendAlpha,this.blendConstColor.cloneTo(Q.blendConstColor),Q.blendEquation=this.blendEquation,Q.blendEquationRGB=this.blendEquationRGB,Q.blendEquationAlpha=this.blendEquationAlpha,Q.depthTest=this.depthTest,Q.depthWrite=this.depthWrite;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q.CULL_NONE=0,q.CULL_FRONT=1,q.CULL_BACK=2,q.BLEND_DISABLE=0,q.BLEND_ENABLE_ALL=1,q.BLEND_ENABLE_SEPERATE=2,q.BLENDPARAM_ZERO=0,q.BLENDPARAM_ONE=1,q.BLENDPARAM_SRC_COLOR=768,q.BLENDPARAM_ONE_MINUS_SRC_COLOR=769,q.BLENDPARAM_DST_COLOR=774,q.BLENDPARAM_ONE_MINUS_DST_COLOR=775,q.BLENDPARAM_SRC_ALPHA=770,q.BLENDPARAM_ONE_MINUS_SRC_ALPHA=771,q.BLENDPARAM_DST_ALPHA=772,q.BLENDPARAM_ONE_MINUS_DST_ALPHA=773,q.BLENDPARAM_SRC_ALPHA_SATURATE=776,q.BLENDEQUATION_ADD=0,q.BLENDEQUATION_SUBTRACT=1,q.BLENDEQUATION_REVERSE_SUBTRACT=2,q.DEPTHTEST_OFF=0,q.DEPTHTEST_NEVER=512,q.DEPTHTEST_LESS=513,q.DEPTHTEST_EQUAL=514,q.DEPTHTEST_LEQUAL=515,q.DEPTHTEST_GREATER=516,q.DEPTHTEST_NOTEQUAL=517,q.DEPTHTEST_GEQUAL=518,q.DEPTHTEST_ALWAYS=519,q;}(),i=function(){function q(q,Q){this.origin=null,this.direction=null,this.origin=q,this.direction=Q;}
return S(q,"laya.d3.math.Ray"),q;}(),$=function(){function q(){this._idCounter=0,this.colliderA=null,this.colliderB=null,this.distance=0,this.normal=new _q(),this.positionOnA=new _q(),this.positionOnB=new _q(),this._id=++this._idCounter;}
return S(q,"laya.d3.physics.ContactPoint"),q;}(),j=function(){function W(){this._initBatchSprites=[],this._staticBatches={},this._batchRenderElementPoolIndex=0,this._batchRenderElementPool=[];}
S(W,"laya.d3.graphics.StaticBatchManager");var q=W.prototype;return q._partition=function(q,Q,m){for(var a=q[Math.floor((m+Q)/2)];Q<=m;){for(;this._compare(q[Q],a)<0;)Q++;for(;0<this._compare(q[m],a);)m--;if(Q<m){var w=q[Q];q[Q]=q[m],q[m]=w,Q++,m--;}else if(Q===m){Q++;break;}}
return Q;},q._quickSort=function(q,Q,m){if(1<q.length){var a=this._partition(q,Q,m),w=a-1;Q<w&&this._quickSort(q,Q,w),a<m&&this._quickSort(q,a,m);}},q._compare=function(q,Q){throw"StaticBatch:must override this function.";},q._initStaticBatchs=function(q){throw"StaticBatch:must override this function.";},q._getBatchRenderElementFromPool=function(){throw"StaticBatch:must override this function.";},q._addBatchSprite=function(q){this._initBatchSprites.push(q);},q._clear=function(){this._batchRenderElementPoolIndex=0;},q._garbageCollection=function(){throw"StaticBatchManager: must override it.";},q.dispose=function(){this._staticBatches=null;},W._registerManager=function(q){W._managers.push(q);},W._addToStaticBatchQueue=function(q,Q){q instanceof laya.d3.core.RenderableSprite3D&&q.isStatic&&Q.push(q);for(var m=0,a=q.numChildren;m<a;m++)W._addToStaticBatchQueue(q._children[m],Q);},W.combine=function(q,Q){Q||(Q=[],q&&W._addToStaticBatchQueue(q,Q));var m=Q.length;if(0<m){for(var a=0;a<m;a++){var w=Q[a];w.isStatic&&w._addToInitStaticBatchManager();}
for(var e=0,F=W._managers.length;e<F;e++){W._managers[e]._initStaticBatchs(q);}}},W._managers=[],W;}(),h=function(){function q(){}
S(q,"laya.d3.core.render.command.Command");var Q=q.prototype;return Q.run=function(){},Q.recover=function(){},q;}(),H=function(){function q(){}
return S(q,"laya.d3.core.render.RenderContext3D"),q.clientWidth=0,q.clientHeight=0,y(q,["_instance",function(){return this._instance=new q();}]),q;}(),g=(function(){function q(){}
S(q,"laya.d3.core.GradientMode"),q.Blend=0,q.Fixed=1;}(),function(){function q(){this.length=0,this.elements=[];}
return S(q,"laya.d3.component.SingletonList"),q.prototype._add=function(q){this.length===this.elements.length?this.elements.push(q):this.elements[this.length]=q;},q;}()),I=function(){function Q(){this._batchRenderElementPool=[];}
S(Q,"laya.d3.graphics.DynamicBatchManager");var q=Q.prototype;return q._clear=function(){this._batchRenderElementPoolIndex=0;},q._getBatchRenderElementFromPool=function(){throw"StaticBatch:must override this function.";},q.dispose=function(){},Q._registerManager=function(q){Q._managers.push(q);},Q._managers=[],Q;}(),P=(function(){function q(){this._damping=NaN,this._impulseClamp=NaN,this._tau=NaN,this._pivotInA=new _q(),this._pivotInB=new _q();}
S(q,"laya.d3.physics.constraints.Point2PointConstraint");var Q=q.prototype;d(0,Q,"pivotInA",function(){return this._pivotInA;},function(q){this._pivotInA=q;}),d(0,Q,"pivotInB",function(){return this._pivotInB;},function(q){this._pivotInB=q;}),d(0,Q,"damping",function(){return this._damping;},function(q){this._damping=q;}),d(0,Q,"impulseClamp",function(){return this._impulseClamp;},function(q){this._impulseClamp=q;}),d(0,Q,"tau",function(){return this._tau;},function(q){this._tau=q;});}(),function(){function q(){this._destroyed=!1;}
S(q,"laya.d3.core.GeometryElement");var Q=q.prototype;return o.imps(Q,{"laya.resource.IDestroy":!0}),Q._getType=function(){throw"GeometryElement:must override it.";},Q._prepareRender=function(q){return!0;},Q._render=function(q){throw"GeometryElement:must override it.";},Q.destroy=function(){this._destroyed||(this._destroyed=!0);},d(0,Q,"destroyed",function(){return this._destroyed;}),q._typeCounter=0,q;}()),X=function(){function q(q,Q){this._position=null,this._textureCoordinate0=null,this._position=q,this._textureCoordinate0=Q;}
S(q,"laya.d3.graphics.Vertex.VertexPositionTexture0");var Q=q.prototype;return o.imps(Q,{"laya.d3.graphics.IVertex":!0}),d(0,Q,"position",function(){return this._position;}),d(0,Q,"textureCoordinate0",function(){return this._textureCoordinate0;}),d(0,Q,"vertexDeclaration",function(){return q._vertexDeclaration;}),d(1,q,"vertexDeclaration",function(){return q._vertexDeclaration;}),y(q,["_vertexDeclaration",function(){return this._vertexDeclaration=new tQ(20,[new Gq(0,"vector3",0),new Gq(12,"vector2",2)]);}]),q;}(),qq=function(){function m(){}
return S(m,"laya.d3.math.MathUtils3D"),m.isZero=function(q){return Math.abs(q)<m.zeroTolerance;},m.nearEqual=function(q,Q){return!!m.isZero(q-Q);},m.fastInvSqrt=function(q){return m.isZero(q)?q:1/Math.sqrt(q);},y(m,["zeroTolerance",function(){return this.zeroTolerance=1e-6;},"MaxValue",function(){return this.MaxValue=3.40282347e38;},"MinValue",function(){return this.MinValue=-3.40282347e38;}]),m;}(),Tq=function(){function a(){this._type=0,this._constant=null,this._constantMin=null,this._constantMax=null,this._gradient=null,this._gradientMin=null,this._gradientMax=null;}
S(a,"laya.d3.core.particleShuriKen.module.GradientColor");var q=a.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.cloneTo=function(q){var Q=q;Q._type=this._type,this._constant.cloneTo(Q._constant),this._constantMin.cloneTo(Q._constantMin),this._constantMax.cloneTo(Q._constantMax),this._gradient.cloneTo(Q._gradient),this._gradientMin.cloneTo(Q._gradientMin),this._gradientMax.cloneTo(Q._gradientMax);},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,q,"gradient",function(){return this._gradient;}),d(0,q,"constant",function(){return this._constant;}),d(0,q,"type",function(){return this._type;}),d(0,q,"gradientMin",function(){return this._gradientMin;}),d(0,q,"constantMin",function(){return this._constantMin;}),d(0,q,"gradientMax",function(){return this._gradientMax;}),d(0,q,"constantMax",function(){return this._constantMax;}),a.createByConstant=function(q){var Q=new a();return Q._type=0,Q._constant=q,Q;},a.createByGradient=function(q){var Q=new a();return Q._type=1,Q._gradient=q,Q;},a.createByRandomTwoConstant=function(q,Q){var m=new a();return m._type=2,m._constantMin=q,m._constantMax=Q,m;},a.createByRandomTwoGradient=function(q,Q){var m=new a();return m._type=3,m._gradientMin=q,m._gradientMax=Q,m;},a;}(),Qq=(function(){function q(q,Q){this._width=0,this._height=0,this._width=q,this._height=Q;}
S(q,"laya.d3.utils.Size");var Q=q.prototype;d(0,Q,"width",function(){return-1===this._width?H.clientWidth:this._width;}),d(0,Q,"height",function(){return-1===this._height?H.clientHeight:this._height;}),d(1,q,"fullScreen",function(){return new q(-1,-1);});}(),function(){function q(){this.flags=0,this.maxSubSteps=1,this.fixedTimeStep=1/60;}
return S(q,"laya.d3.physics.PhysicsSettings"),q;}()),mq=function(){function U(q,Q){this.normal=null,this.distance=NaN,void 0===Q&&(Q=0),this.normal=q,this.distance=Q;}
return S(U,"laya.d3.math.Plane"),U.prototype.normalize=function(){var q=this.normal.x,Q=this.normal.y,m=this.normal.z,a=1/Math.sqrt(q*q+Q*Q+m*m);this.normal.x=q*a,this.normal.y=Q*a,this.normal.z=m*a,this.distance*=a;},U.createPlaneBy3P=function(q,Q,m){var a=Q.x-q.x,w=Q.y-q.y,e=Q.z-q.z,F=m.x-q.x,W=m.y-q.y,s=m.z-q.z,D=w*s-e*W,d=e*F-a*s,v=a*W-w*F,y=1/Math.sqrt(D*D+d*d+v*v),S=D*y,t=d*y,o=v*y;U._TEMPVec3.x=S,U._TEMPVec3.y=t,U._TEMPVec3.z=o;var b=-(S*q.x+t*q.y+o*q.z);return new U(U._TEMPVec3,b);},U.PlaneIntersectionType_Back=0,U.PlaneIntersectionType_Front=1,U.PlaneIntersectionType_Intersecting=2,y(U,["_TEMPVec3",function(){return this._TEMPVec3=new _q();}]),U;}(),aq=function(){function q(){this.ambientColor=null,this.diffuseColor=null,this.specularColor=null;}
return S(q,"laya.d3.terrain.unit.MaterialInfo"),q;}(),wq=function(){function Q(q,Q){this._mode=0,this._maxColorRGBKeysCount=0,this._maxColorAlphaKeysCount=0,this._colorRGBKeysCount=0,this._colorAlphaKeysCount=0,this._alphaElements=null,this._rgbElements=null,this._maxColorRGBKeysCount=q,this._maxColorAlphaKeysCount=Q,this._rgbElements=new Float32Array(4*q),this._alphaElements=new Float32Array(2*Q);}
S(Q,"laya.d3.core.Gradient");var q=Q.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.addColorRGB=function(q,Q){if(this._colorRGBKeysCount<this._maxColorRGBKeysCount){var m=4*this._colorRGBKeysCount;this._rgbElements[m]=q,this._rgbElements[m+1]=Q.r,this._rgbElements[m+2]=Q.g,this._rgbElements[m+3]=Q.b,this._colorRGBKeysCount++;}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorRGBKeysCount);},q.addColorAlpha=function(q,Q){if(this._colorAlphaKeysCount<this._maxColorAlphaKeysCount){var m=2*this._colorAlphaKeysCount;this._alphaElements[m]=q,this._alphaElements[m+1]=Q,this._colorAlphaKeysCount++;}else console.warn("Gradient:warning:data count must lessEqual than "+this._maxColorAlphaKeysCount);},q.updateColorRGB=function(q,Q,m){if(q<this._colorRGBKeysCount){var a=4*q;this._rgbElements[a]=Q,this._rgbElements[a+1]=m.r,this._rgbElements[a+2]=m.g,this._rgbElements[a+3]=m.b;}else console.warn("Gradient:warning:index must lessEqual than colorRGBKeysCount:"+this._colorRGBKeysCount);},q.updateColorAlpha=function(q,Q,m){if(q<this._colorAlphaKeysCount){var a=2*q;this._alphaElements[a]=Q,this._alphaElements[a+1]=m;}else console.warn("Gradient:warning:index must lessEqual than colorAlphaKeysCount:"+this._colorAlphaKeysCount);},q.cloneTo=function(q){var Q=q,m=0,a=0;Q._colorAlphaKeysCount=this._colorAlphaKeysCount;var w=Q._alphaElements;for(w.length=this._alphaElements.length,m=0,a=this._alphaElements.length;m<a;m++)w[m]=this._alphaElements[m];Q._colorRGBKeysCount=this._colorRGBKeysCount;var e=Q._rgbElements;for(e.length=this._rgbElements.length,m=0,a=this._rgbElements.length;m<a;m++)e[m]=this._rgbElements[m];},q.clone=function(){var q=new Q(this._maxColorRGBKeysCount,this._maxColorAlphaKeysCount);return this.cloneTo(q),q;},d(0,q,"colorRGBKeysCount",function(){return this._colorRGBKeysCount/4;}),d(0,q,"mode",function(){return this._mode;},function(q){this._mode=q;}),d(0,q,"colorAlphaKeysCount",function(){return this._colorAlphaKeysCount/2;}),d(0,q,"maxColorRGBKeysCount",function(){return this._maxColorRGBKeysCount;}),d(0,q,"maxColorAlphaKeysCount",function(){return this._maxColorAlphaKeysCount;}),Q;}(),eq=function(){function e(q,Q,m,a,w){void 0===q&&(q=0),void 0===Q&&(Q=0),void 0===m&&(m=0),void 0===a&&(a=1),this.x=q,this.y=Q,this.z=m,this.w=a;}
S(e,"laya.d3.math.Quaternion");var q=e.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.scaling=function(q,Q){Q.x=this.x*q,Q.y=this.y*q,Q.z=this.z*q,Q.w=this.w*q;},q.normalize=function(q){var Q=this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;0<Q&&(Q=1/Math.sqrt(Q),q.x=this.x*Q,q.y=this.y*Q,q.z=this.z*Q,q.w=this.w*Q);},q.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);},q.rotateX=function(q,Q){q*=.5;var m=this.x,a=this.y,w=this.z,e=this.w,F=Math.sin(q),W=Math.cos(q);Q.x=m*W+e*F,Q.y=a*W+w*F,Q.z=w*W-a*F,Q.w=e*W-m*F;},q.rotateY=function(q,Q){q*=.5;var m=this.x,a=this.y,w=this.z,e=this.w,F=Math.sin(q),W=Math.cos(q);Q.x=m*W-w*F,Q.y=a*W+e*F,Q.z=w*W+m*F,Q.w=e*W-a*F;},q.rotateZ=function(q,Q){q*=.5;var m=this.x,a=this.y,w=this.z,e=this.w,F=Math.sin(q),W=Math.cos(q);Q.x=m*W+a*F,Q.y=a*W-m*F,Q.z=w*W+e*F,Q.w=e*W-w*F;},q.getYawPitchRoll=function(q){_q.transformQuat(_q._ForwardRH,this,e.TEMPVector31),_q.transformQuat(_q._Up,this,e.TEMPVector32);var Q=e.TEMPVector32;e.angleTo(_q._ZERO,e.TEMPVector31,e.TEMPVector33);var m=e.TEMPVector33;m.x==Math.PI/2?(m.y=e.arcTanAngle(Q.z,Q.x),m.z=0):m.x==-Math.PI/2?(m.y=e.arcTanAngle(-Q.z,-Q.x),m.z=0):(kQ.createRotationY(-m.y,e.TEMPMatrix0),kQ.createRotationX(-m.x,e.TEMPMatrix1),_q.transformCoordinate(e.TEMPVector32,e.TEMPMatrix0,e.TEMPVector32),_q.transformCoordinate(e.TEMPVector32,e.TEMPMatrix1,e.TEMPVector32),m.z=e.arcTanAngle(Q.y,-Q.x)),m.y<=-Math.PI&&(m.y=Math.PI),m.z<=-Math.PI&&(m.z=Math.PI),m.y>=Math.PI&&m.z>=Math.PI&&(m.y=0,m.z=0,m.x=Math.PI-m.x);var a=q;a.x=m.y,a.y=m.x,a.z=m.z;},q.invert=function(q){var Q=this.x,m=this.y,a=this.z,w=this.w,e=Q*Q+m*m+a*a+w*w,F=e?1/e:0;q.x=-Q*F,q.y=-m*F,q.z=-a*F,q.w=w*F;},q.identity=function(){this.x=0,this.y=0,this.z=0,this.w=1;},q.fromArray=function(q,Q){void 0===Q&&(Q=0),this.x=q[Q+0],this.y=q[Q+1],this.z=q[Q+2],this.w=q[Q+3];},q.cloneTo=function(q){this!==q&&(q.x=this.x,q.y=this.y,q.z=this.z,q.w=this.w);},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q.equals=function(q){return qq.nearEqual(this.x,q.x)&&qq.nearEqual(this.y,q.y)&&qq.nearEqual(this.z,q.z)&&qq.nearEqual(this.w,q.w);},q.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;},q.forNativeElement=function(q){q?(this.elements=q,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),Zq.rewriteNumProperty(this,"x",0),Zq.rewriteNumProperty(this,"y",1),Zq.rewriteNumProperty(this,"z",2),Zq.rewriteNumProperty(this,"w",3);},e.createFromYawPitchRoll=function(q,Q,m,a){var w=.5*m,e=.5*Q,F=.5*q,W=Math.sin(w),s=Math.cos(w),D=Math.sin(e),d=Math.cos(e),v=Math.sin(F),y=Math.cos(F);a.x=y*D*s+v*d*W,a.y=v*d*s-y*D*W,a.z=y*d*W-v*D*s,a.w=y*d*s+v*D*W;},e.multiply=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=q.w,W=Q.x,s=Q.y,D=Q.z,d=Q.w,v=w*D-e*s,y=e*W-a*D,S=a*s-w*W,t=a*W+w*s+e*D;m.x=a*d+W*F+v,m.y=w*d+s*F+y,m.z=e*d+D*F+S,m.w=F*d-t;},e.arcTanAngle=function(q,Q){return 0==q?1==Q?Math.PI/2:-Math.PI/2:0<q?Math.atan(Q/q):q<0?0<Q?Math.atan(Q/q)+Math.PI:Math.atan(Q/q)-Math.PI:0;},e.angleTo=function(q,Q,m){_q.subtract(Q,q,e.TEMPVector30),_q.normalize(e.TEMPVector30,e.TEMPVector30),m.x=Math.asin(e.TEMPVector30.y),m.y=e.arcTanAngle(-e.TEMPVector30.z,-e.TEMPVector30.x);},e.createFromAxisAngle=function(q,Q,m){Q*=.5;var a=Math.sin(Q);m.x=a*q.x,m.y=a*q.y,m.z=a*q.z,m.w=Math.cos(Q);},e.createFromMatrix4x4=function(q,Q){var m,a,w=q.elements,e=w[0]+w[5]+w[10];0<e?(m=Math.sqrt(e+1),Q.w=.5*m,m=.5/m,Q.x=(w[6]-w[9])*m,Q.y=(w[8]-w[2])*m,Q.z=(w[1]-w[4])*m):w[0]>=w[5]&&w[0]>=w[10]?(a=.5/(m=Math.sqrt(1+w[0]-w[5]-w[10])),Q.x=.5*m,Q.y=(w[1]+w[4])*a,Q.z=(w[2]+w[8])*a,Q.w=(w[6]-w[9])*a):w[5]>w[10]?(a=.5/(m=Math.sqrt(1+w[5]-w[0]-w[10])),Q.x=(w[4]+w[1])*a,Q.y=.5*m,Q.z=(w[9]+w[6])*a,Q.w=(w[8]-w[2])*a):(a=.5/(m=Math.sqrt(1+w[10]-w[0]-w[5])),Q.x=(w[8]+w[2])*a,Q.y=(w[9]+w[6])*a,Q.z=.5*m,Q.w=(w[1]-w[4])*a);},e.slerp=function(q,Q,m,a){var w,e,F,W,s,D=q.x,d=q.y,v=q.z,y=q.w,S=Q.x,t=Q.y,o=Q.z,b=Q.w;return(e=D*S+d*t+v*o+y*b)<0&&(e=-e,S=-S,t=-t,o=-o,b=-b),s=1e-6<1-e?(w=Math.acos(e),F=Math.sin(w),W=Math.sin((1-m)*w)/F,Math.sin(m*w)/F):(W=1-m,m),a.x=W*D+s*S,a.y=W*d+s*t,a.z=W*v+s*o,a.w=W*y+s*b,a;},e.lerp=function(q,Q,m,a){var w=1-m;0<=e.dot(q,Q)?(a.x=w*q.x+m*Q.x,a.y=w*q.y+m*Q.y,a.z=w*q.z+m*Q.z,a.w=w*q.w+m*Q.w):(a.x=w*q.x-m*Q.x,a.y=w*q.y-m*Q.y,a.z=w*q.z-m*Q.z,a.w=w*q.w-m*Q.w),a.normalize(a);},e.add=function(q,Q,m){m.x=q.x+Q.x,m.y=q.y+Q.y,m.z=q.z+Q.z,m.w=q.w+Q.w;},e.dot=function(q,Q){return q.x*Q.x+q.y*Q.y+q.z*Q.z+q.w*Q.w;},e.rotationLookAt=function(q,Q,m){e.lookAt(_q._ZERO,q,Q,m);},e.lookAt=function(q,Q,m,a){xQ.lookAt(q,Q,m,e._tempMatrix3x3),e.rotationMatrix(e._tempMatrix3x3,a);},e.invert=function(q,Q){var m=q.lengthSquared();qq.isZero(m)||(m=1/m,Q.x=-q.x*m,Q.y=-q.y*m,Q.z=-q.z*m,Q.w=q.w*m);},e.rotationMatrix=function(q,Q){var m=q.elements,a=m[0],w=m[1],e=m[2],F=m[3],W=m[4],s=m[5],D=m[6],d=m[7],v=m[8],y=NaN,S=NaN,t=a+W+v;0<t?(y=Math.sqrt(t+1),Q.w=.5*y,y=.5/y,Q.x=(s-d)*y,Q.y=(D-e)*y,Q.z=(w-F)*y):Q.w=W<=a&&v<=a?(S=.5/(y=Math.sqrt(1+a-W-v)),Q.x=.5*y,Q.y=(w+F)*S,Q.z=(e+D)*S,(s-d)*S):v<W?(S=.5/(y=Math.sqrt(1+W-a-v)),Q.x=(F+w)*S,Q.y=.5*y,Q.z=(d+s)*S,(D-e)*S):(S=.5/(y=Math.sqrt(1+v-a-W)),Q.x=(D+e)*S,Q.y=(d+s)*S,Q.z=.5*y,(w-F)*S);},e.DEFAULT=new e(),y(e,["TEMPVector30",function(){return this.TEMPVector30=new _q();},"TEMPVector31",function(){return this.TEMPVector31=new _q();},"TEMPVector32",function(){return this.TEMPVector32=new _q();},"TEMPVector33",function(){return this.TEMPVector33=new _q();},"TEMPMatrix0",function(){return this.TEMPMatrix0=new kQ();},"TEMPMatrix1",function(){return this.TEMPMatrix1=new kQ();},"_tempMatrix3x3",function(){return this._tempMatrix3x3=new xQ();},"NAN",function(){return this.NAN=new e(NaN,NaN,NaN,NaN);}]),e;}(),Fq=function(){function a(q){this._ownerResource=null,this._data=null,this._int32Data=null,this._float32Data=null,this._nativeArray=null,this._frameCount=0,this._runtimeCopyValues=[],this._ownerResource=q,this._initData();}
S(a,"laya.d3.shader.ShaderData");var q=a.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q._initData=function(){this._data=new Object();},q.getData=function(){return this._data;},q.getBool=function(q){return this._data[q];},q.setBool=function(q,Q){this._data[q]=Q;},q.getInt=function(q){return this._data[q];},q.setInt=function(q,Q){this._data[q]=Q;},q.getNumber=function(q){return this._data[q];},q.setNumber=function(q,Q){this._data[q]=Q;},q.getVector2=function(q){return this._data[q];},q.setVector2=function(q,Q){this._data[q]=Q;},q.getVector3=function(q){return this._data[q];},q.setVector3=function(q,Q){this._data[q]=Q;},q.getVector=function(q){return this._data[q];},q.setVector=function(q,Q){this._data[q]=Q;},q.getQuaternion=function(q){return this._data[q];},q.setQuaternion=function(q,Q){this._data[q]=Q;},q.getMatrix4x4=function(q){return this._data[q];},q.setMatrix4x4=function(q,Q){this._data[q]=Q;},q.getBuffer=function(q){return this._data[q];},q.setBuffer=function(q,Q){this._data[q]=Q;},q.setTexture=function(q,Q){var m=this._data[q];this._data[q]=Q,this._ownerResource&&0<this._ownerResource.referenceCount&&(m&&m._removeReference(),Q&&Q._addReference());},q.getTexture=function(q){return this._data[q];},q.setAttribute=function(q,Q){this._data[q]=Q;},q.getAttribute=function(q){return this._data[q];},q.getLength=function(){return this._data.length;},q.setLength=function(q){this._data.length=q;},q.cloneTo=function(q){var Q=q._data;for(var m in this._data){var a=this._data[m];if(null!=a)
if("number"==typeof a)Q[m]=a;else if("number"==typeof a&&Math.floor(a)==a)Q[m]=a;else if("boolean"==typeof a)Q[m]=a;else if(a instanceof laya.d3.math.Vector2){var w=Q[m]||(Q[m]=new Zq());a.cloneTo(w),Q[m]=w;}else if(a instanceof laya.d3.math.Vector3){var e=Q[m]||(Q[m]=new _q());a.cloneTo(e),Q[m]=e;}else if(a instanceof laya.d3.math.Vector4){var F=Q[m]||(Q[m]=new rq());a.cloneTo(F),Q[m]=F;}else if(a instanceof laya.d3.math.Matrix4x4){var W=Q[m]||(Q[m]=new kQ());a.cloneTo(W),Q[m]=W;}else a instanceof laya.resource.BaseTexture&&(Q[m]=a);}},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q.cloneToForNative=function(q){var Q=q;0<this._int32Data.length-Q._int32Data.length&&Q.needRenewArrayBufferForNative(this._int32Data.length),Q._int32Data.set(this._int32Data,0);var m=Q._nativeArray,a=this._nativeArray.length;m.length=a;for(var w=0;w<a;w++){var e=this._nativeArray[w];if(e)
if("number"==typeof e)m[w]=e,Q.setNumber(w,e);else if("number"==typeof e&&Math.floor(e)==e)m[w]=e,Q.setInt(w,e);else if("boolean"==typeof e)m[w]=e,Q.setBool(w,e);else if(e instanceof laya.d3.math.Vector2){var F=m[w]||(m[w]=new Zq());e.cloneTo(F),m[w]=F,Q.setVector2(w,F);}else if(e instanceof laya.d3.math.Vector3){var W=m[w]||(m[w]=new _q());e.cloneTo(W),m[w]=W,Q.setVector3(w,W);}else if(e instanceof laya.d3.math.Vector4){var s=m[w]||(m[w]=new rq());e.cloneTo(s),m[w]=s,Q.setVector(w,s);}else if(e instanceof laya.d3.math.Matrix4x4){var D=m[w]||(m[w]=new kQ());e.cloneTo(D),m[w]=D,Q.setMatrix4x4(w,D);}else e instanceof laya.resource.BaseTexture&&(m[w]=e,Q.setTexture(w,e));}},q._initDataForNative=function(){this._frameCount=-1,this._runtimeCopyValues.length=0,this._nativeArray=[],this._data=new ArrayBuffer(32),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),J.createArrayBufferRef(this._data,0,!0);},q.needRenewArrayBufferForNative=function(q){if(q>=this._int32Data.length){var Q=4*(q+1),m=this._int32Data,a=this._data.conchRef,w=this._data._ptrID;this._data=new ArrayBuffer(Q),this._int32Data=new Int32Array(this._data),this._float32Data=new Float32Array(this._data),this._data.conchRef=a,this._data._ptrID=w,m&&this._int32Data.set(m,0),conch.updateArrayBufferRef(this._data._ptrID,a.isSyncToRender(),this._data);}},q.getDataForNative=function(){return this._nativeArray;},q.getIntForNative=function(q){return this._int32Data[q];},q.setIntForNative=function(q,Q){this.needRenewArrayBufferForNative(q),this._int32Data[q]=Q,this._nativeArray[q]=Q;},q.getBoolForNative=function(q){return 1==this._int32Data[q];},q.setBoolForNative=function(q,Q){this.needRenewArrayBufferForNative(q),this._int32Data[q]=Q,this._nativeArray[q]=Q;},q.getNumberForNative=function(q){return this._float32Data[q];},q.setNumberForNative=function(q,Q){this.needRenewArrayBufferForNative(q),this._float32Data[q]=Q,this._nativeArray[q]=Q;},q.getMatrix4x4ForNative=function(q){return this._nativeArray[q];},q.setMatrix4x4ForNative=function(q,Q){this.needRenewArrayBufferForNative(q),this._nativeArray[q]=Q;var m=this.setReferenceForNative(Q.elements);this._int32Data[q]=m;},q.getVectorForNative=function(q){return this._nativeArray[q];},q.setVectorForNative=function(q,Q){this.needRenewArrayBufferForNative(q),(this._nativeArray[q]=Q).elements||Q.forNativeElement();var m=this.setReferenceForNative(Q.elements);this._int32Data[q]=m;},q.getVector2ForNative=function(q){return this._nativeArray[q];},q.setVector2ForNative=function(q,Q){this.needRenewArrayBufferForNative(q),(this._nativeArray[q]=Q).elements||Q.forNativeElement();var m=this.setReferenceForNative(Q.elements);this._int32Data[q]=m;},q.getVector3ForNative=function(q){return this._nativeArray[q];},q.setVector3ForNative=function(q,Q){this.needRenewArrayBufferForNative(q),(this._nativeArray[q]=Q).elements||Q.forNativeElement();var m=this.setReferenceForNative(Q.elements);this._int32Data[q]=m;},q.getQuaternionForNative=function(q){return this._nativeArray[q];},q.setQuaternionForNative=function(q,Q){this.needRenewArrayBufferForNative(q),(this._nativeArray[q]=Q).elements||Q.forNativeElement();var m=this.setReferenceForNative(Q.elements);this._int32Data[q]=m;},q.getBufferForNative=function(q){return this._nativeArray[q];},q.setBufferForNative=function(q,Q){this.needRenewArrayBufferForNative(q),this._nativeArray[q]=Q;var m=this.setReferenceForNative(Q);this._int32Data[q]=m;},q.getAttributeForNative=function(q){return this._nativeArray[q];},q.setAttributeForNative=function(q,Q){(this._nativeArray[q]=Q)._ptrID||J.createArrayBufferRef(Q,0,!0),J.syncBufferToRenderThread(Q),this._int32Data[q]=Q._ptrID;},q.getTextureForNative=function(q){return this._nativeArray[q];},q.setTextureForNative=function(q,Q){if(Q){this.needRenewArrayBufferForNative(q);var m=this._nativeArray[q];this._nativeArray[q]=Q,this._int32Data[q]=Q._glTexture.id,this._ownerResource&&0<this._ownerResource.referenceCount&&(m&&m._removeReference(),Q&&Q._addReference());}},q.setReferenceForNative=function(q){this.clearRuntimeCopyArray();var Q=0,m=0;return a._SET_RUNTIME_VALUE_MODE_REFERENCE_?(J.createArrayBufferRefs(q,0,!0,0),Q=0,m=q.getPtrID(Q)):(J.createArrayBufferRefs(q,0,!0,1),Q=q.getRefNum()-1,m=q.getPtrID(Q),this._runtimeCopyValues.push({obj:q,refID:Q,ptrID:m})),J.syncBufferToRenderThread(q,Q),m;},q.clearRuntimeCopyArray=function(){var q=J.getFrameCount();if(this._frameCount!=q){this._frameCount=q;for(var Q=0,m=this._runtimeCopyValues.length;Q<m;Q++){this._runtimeCopyValues[Q].obj.clearRefNum();}
this._runtimeCopyValues.length=0;}},a.setRuntimeValueMode=function(q){a._SET_RUNTIME_VALUE_MODE_REFERENCE_=q;},a._SET_RUNTIME_VALUE_MODE_REFERENCE_=!0,a;}(),Wq=function(){function C(){this._boundingSphere=null,this._boundingBox=null,this._sizeOfY=null,this._currentLODLevel=0,this._lastDistanceToEye=NaN,this._originalBoundingSphere=null,this._originalBoundingBox=null,this._originalBoundingBoxCorners=null,this._bUseStrip=!1,this._gridSize=NaN,this._beginGridX=0,this._beginGridZ=0,this._LODError=null,C.__init__(),this._currentLODLevel=0;}
S(C,"laya.d3.terrain.TerrainLeaf");var q=C.prototype;return q.calcVertextNorml=function(q,Q,m,a,w,e){var F=0,W=0;W=-1*C.getHeightFromTerrainHeightData(q-1,Q-1,m,a,w),W+=-1*C.getHeightFromTerrainHeightData(q-1,Q,m,a,w),W+=-1*C.getHeightFromTerrainHeightData(q-1,Q+1,m,a,w),W+=1*C.getHeightFromTerrainHeightData(q+1,Q-1,m,a,w),W+=1*C.getHeightFromTerrainHeightData(q+1,Q,m,a,w),W+=1*C.getHeightFromTerrainHeightData(q+1,Q+1,m,a,w),F=-1*C.getHeightFromTerrainHeightData(q-1,Q-1,m,a,w),F+=-1*C.getHeightFromTerrainHeightData(q,Q-1,m,a,w),F+=-1*C.getHeightFromTerrainHeightData(q+1,Q-1,m,a,w),F+=1*C.getHeightFromTerrainHeightData(q-1,Q+1,m,a,w),F+=1*C.getHeightFromTerrainHeightData(q,Q+1,m,a,w),F+=1*C.getHeightFromTerrainHeightData(q+1,Q+1,m,a,w),e.x=-W,e.y=6,e.z=-F,_q.normalize(e,e);},q.calcVertextNormlUV=function(q,Q,m,a,w){w.x=q/m,w.y=Q/a,w.z=Q/a;},q.calcVertextBuffer=function(q,Q,m,a,w,e,F,W,s,D,d,v){if(1==v&&!C.__ADAPT_MATRIX__){C.__ADAPT_MATRIX__=new kQ();var y=new kQ();kQ.createRotationY(Math.PI,C.__ADAPT_MATRIX__),kQ.createTranslate(new _q(0,0,(d-1)*w),y),kQ.multiply(y,C.__ADAPT_MATRIX__,C.__ADAPT_MATRIX__),C.__ADAPT_MATRIX_INV__=new kQ(),C.__ADAPT_MATRIX__.invert(C.__ADAPT_MATRIX_INV__);}
this._gridSize=w,this._beginGridX=q*C.CHUNK_GRID_NUM+m,this._beginGridZ=Q*C.CHUNK_GRID_NUM+a;for(var S=F*W,t=2147483647,o=-2147483648,b=new _q(),U=0,J=C.LEAF_GRID_NUM+1;U<J;U++)
for(var V=0,n=C.LEAF_GRID_NUM+1;V<n;V++)C.__VECTOR3__.x=(this._beginGridX+V)*this._gridSize,C.__VECTOR3__.z=(this._beginGridZ+U)*this._gridSize,C.__VECTOR3__.y=s[(this._beginGridZ+U)*D+(this._beginGridX+V)],t=C.__VECTOR3__.y<t?C.__VECTOR3__.y:t,o=C.__VECTOR3__.y>o?C.__VECTOR3__.y:o,C.__ADAPT_MATRIX__&&_q.transformV3ToV3(C.__VECTOR3__,C.__ADAPT_MATRIX__,C.__VECTOR3__),e[S]=C.__VECTOR3__.x,e[++S]=C.__VECTOR3__.y,e[++S]=C.__VECTOR3__.z,S++,this.calcVertextNormlUV(this._beginGridX+V,this._beginGridZ+U,D,d,b),e[S]=b.x,e[++S]=b.y,e[++S]=b.z,e[++S]=(m+V)/C.CHUNK_GRID_NUM,e[++S]=(a+U)/C.CHUNK_GRID_NUM,e[++S]=this._beginGridX+V,e[++S]=this._beginGridZ+U,S++;this._sizeOfY=new Zq(t-1,o+1),this.calcLODErrors(s,D,d),this.calcOriginalBoudingBoxAndSphere();},q.calcSkirtVertextBuffer=function(q,Q,m,a,w,e,F,W,s,D,d){this._gridSize=w,this._beginGridX=q*C.CHUNK_GRID_NUM+m,this._beginGridZ=Q*C.CHUNK_GRID_NUM+a;var v=F*W,y=0,S=0,t=C.LEAF_GRID_NUM+1,o=new _q(),b=0,U=0;for(y=0;y<2;y++)
for(S=0;S<t;S++)C.__VECTOR3__.x=(this._beginGridX+S)*this._gridSize,C.__VECTOR3__.y=1==y?s[this._beginGridZ*D+(this._beginGridX+S)]:-this._gridSize,C.__VECTOR3__.z=(this._beginGridZ+0)*this._gridSize,C.__ADAPT_MATRIX__&&_q.transformV3ToV3(C.__VECTOR3__,C.__ADAPT_MATRIX__,C.__VECTOR3__),e[v]=C.__VECTOR3__.x,e[++v]=C.__VECTOR3__.y,e[++v]=C.__VECTOR3__.z,v++,b=0==y?this._beginGridZ-1:this._beginGridZ,this.calcVertextNormlUV(this._beginGridX+S,b,D,d,o),e[v]=o.x,e[++v]=o.y,e[++v]=o.z,e[++v]=(m+S)/C.CHUNK_GRID_NUM,e[++v]=(a+0)/C.CHUNK_GRID_NUM,e[++v]=this._beginGridX+S,e[++v]=b,v++;for(y=0;y<2;y++)
for(S=0;S<t;S++)C.__VECTOR3__.x=(this._beginGridX+S)*this._gridSize,C.__VECTOR3__.y=0==y?s[(this._beginGridZ+C.LEAF_GRID_NUM)*D+(this._beginGridX+S)]:-this._gridSize,C.__VECTOR3__.z=(this._beginGridZ+C.LEAF_GRID_NUM)*this._gridSize,C.__ADAPT_MATRIX__&&_q.transformV3ToV3(C.__VECTOR3__,C.__ADAPT_MATRIX__,C.__VECTOR3__),e[v]=C.__VECTOR3__.x,e[++v]=C.__VECTOR3__.y,e[++v]=C.__VECTOR3__.z,v++,b=0==y?this._beginGridZ+C.LEAF_GRID_NUM:this._beginGridZ+C.LEAF_GRID_NUM+1,this.calcVertextNormlUV(this._beginGridX+S,b,D,d,o),e[v]=o.x,e[++v]=o.y,e[++v]=o.z,e[++v]=(m+S)/C.CHUNK_GRID_NUM,e[++v]=(a+C.LEAF_GRID_NUM)/C.CHUNK_GRID_NUM,e[++v]=this._beginGridX+S,e[++v]=b,v++;for(y=0;y<2;y++)
for(S=0;S<t;S++)C.__VECTOR3__.x=(this._beginGridX+0)*this._gridSize,C.__VECTOR3__.y=0==y?s[(this._beginGridZ+S)*D+(this._beginGridX+0)]:-this._gridSize,C.__VECTOR3__.z=(this._beginGridZ+S)*this._gridSize,C.__ADAPT_MATRIX__&&_q.transformV3ToV3(C.__VECTOR3__,C.__ADAPT_MATRIX__,C.__VECTOR3__),e[v]=C.__VECTOR3__.x,e[++v]=C.__VECTOR3__.y,e[++v]=C.__VECTOR3__.z,v++,U=0==y?this._beginGridX:this._beginGridX-1,this.calcVertextNormlUV(U,this._beginGridZ+S,D,d,o),e[v]=o.x,e[++v]=o.y,e[++v]=o.z,e[++v]=(m+0)/C.CHUNK_GRID_NUM,e[++v]=(a+S)/C.CHUNK_GRID_NUM,e[++v]=U,e[++v]=this._beginGridZ+S,v++;for(y=0;y<2;y++)
for(S=0;S<t;S++)C.__VECTOR3__.x=(this._beginGridX+C.LEAF_GRID_NUM)*this._gridSize,C.__VECTOR3__.y=1==y?s[(this._beginGridZ+S)*D+(this._beginGridX+C.LEAF_GRID_NUM)]:-this._gridSize,C.__VECTOR3__.z=(this._beginGridZ+S)*this._gridSize,C.__ADAPT_MATRIX__&&_q.transformV3ToV3(C.__VECTOR3__,C.__ADAPT_MATRIX__,C.__VECTOR3__),e[v]=C.__VECTOR3__.x,e[++v]=C.__VECTOR3__.y,e[++v]=C.__VECTOR3__.z,v++,U=0==y?this._beginGridX+C.LEAF_GRID_NUM+1:this._beginGridX+C.LEAF_GRID_NUM,this.calcVertextNormlUV(U,this._beginGridZ+S,D,d,o),e[v]=o.x,e[++v]=o.y,e[++v]=o.z,e[++v]=(m+C.LEAF_GRID_NUM)/C.CHUNK_GRID_NUM,e[++v]=(a+S)/C.CHUNK_GRID_NUM,e[++v]=U,e[++v]=this._beginGridZ+S,v++;},q.calcOriginalBoudingBoxAndSphere=function(){var q=new _q(this._beginGridX*this._gridSize,this._sizeOfY.x,this._beginGridZ*this._gridSize),Q=new _q((this._beginGridX+C.LEAF_GRID_NUM)*this._gridSize,this._sizeOfY.y,(this._beginGridZ+C.LEAF_GRID_NUM)*this._gridSize);C.__ADAPT_MATRIX__&&(_q.transformV3ToV3(q,C.__ADAPT_MATRIX__,q),_q.transformV3ToV3(Q,C.__ADAPT_MATRIX__,Q)),this._originalBoundingBox=new GQ(q,Q);var m=new _q();_q.subtract(Q,q,m),_q.scale(m,.5,m);var a=new _q();_q.add(q,m,a),this._originalBoundingSphere=new Jq(a,_q.scalarLength(m)),this._originalBoundingBoxCorners=N(8,null),this._originalBoundingBox.getCorners(this._originalBoundingBoxCorners),this._boundingBox=new GQ(new _q(-.5,-.5,-.5),new _q(.5,.5,.5)),this._boundingSphere=new Jq(new _q(0,0,0),1);},q.calcLeafBoudingBox=function(q){for(var Q=0;Q<8;Q++)_q.transformCoordinate(this._originalBoundingBoxCorners[Q],q,iQ._tempBoundBoxCorners[Q]);GQ.createfromPoints(iQ._tempBoundBoxCorners,this._boundingBox);},q.calcLeafBoudingSphere=function(q,Q){_q.transformCoordinate(this._originalBoundingSphere.center,q,this._boundingSphere.center),this._boundingSphere.radius=this._originalBoundingSphere.radius*Q;},q.calcLODErrors=function(q,Q,m){this._LODError=new Float32Array(C._maxLODLevel+1);for(var a=1,w=0,e=C._maxLODLevel+1;w<e;w++){for(var F=0,W=0,s=C.LEAF_GRID_NUM;W<s;W+=a)
for(var D=0,d=C.LEAF_GRID_NUM;D<d;D+=a)
for(var v=q[(this._beginGridZ+W)*Q+(this._beginGridX+D)],y=q[(this._beginGridZ+W)*Q+(this._beginGridX+D)+a],S=q[(this._beginGridZ+W+a)*Q+(this._beginGridX+D)],t=q[(this._beginGridZ+W+a)*Q+(this._beginGridX+D)+a],o=0;o<a;o++)
for(var b=o/a,U=0;U<a;U++){var J=U/a,V=q[(this._beginGridZ+W+o)*Q+(this._beginGridX+D)+U],n=J+b<=1?v+(y-v)*J+(S-v)*b:t+(S-t)*(1-J)+(y-t)*(1-b),O=Math.abs(n-V);F=Math.max(F,O);}
a*=2,this._LODError[w]=F;}},q.determineLod=function(q,Q,m,a){var w=_q.distance(q,this._boundingSphere.center),e=C._maxLODLevel;if(!a){if(this._lastDistanceToEye==w)return this._currentLODLevel;this._lastDistanceToEye>w&&(e=this._currentLODLevel);}
for(var F=e;1<=F;F--)
if(qa.LOD_DISTANCE_FACTOR*this._LODError[F]/w*Q<m){this._currentLODLevel=F;break;}
return this._lastDistanceToEye=w,this._currentLODLevel;},C.__init__=function(){if(!C._bInit){var q=C.CHUNK_GRID_NUM/C.LEAF_GRID_NUM*(C.CHUNK_GRID_NUM/C.LEAF_GRID_NUM);C._planeLODIndex=N(q);var Q=0,m=0,a=0,w=0,e=0,F=0,W=null,s=null;for(Q=0;Q<q;Q++)C._planeLODIndex[Q]=new Array(C._maxLODLevel+1);for(Q=0,w=C._maxLODLevel+1;Q<w;Q++)C._planeLODIndex[0][Q]=C.calcPlaneLODIndex(Q);for(Q=1;Q<q;Q++)
for(F=Q*C.LEAF_PLANE_VERTEXT_COUNT,m=0,e=C._maxLODLevel+1;m<e;m++){for(W=C._planeLODIndex[0][m],s=new Uint16Array(W.length),a=0;a<W.length;a++)s[a]=W[a]+F;C._planeLODIndex[Q][m]=s;}
for(C._skirtLODIndex=N(q),Q=0;Q<q;Q++)C._skirtLODIndex[Q]=new Array(C._maxLODLevel+1);for(Q=0,w=C._maxLODLevel+1;Q<w;Q++)C._skirtLODIndex[0][Q]=C.calcSkirtLODIndex(Q);for(Q=1;Q<q;Q++)
for(F=Q*C.LEAF_SKIRT_VERTEXT_COUNT,m=0,e=C._maxLODLevel+1;m<e;m++){for(W=C._skirtLODIndex[0][m],s=new Uint16Array(W.length),a=0;a<W.length;a++)s[a]=W[a]+F;C._skirtLODIndex[Q][m]=s;}
C._bInit=!0;}},C.getPlaneLODIndex=function(q,Q){return C._planeLODIndex[q][Q];},C.getSkirtLODIndex=function(q,Q){return C._skirtLODIndex[q][Q];},C.calcPlaneLODIndex=function(q){C._maxLODLevel<q&&(q=C._maxLODLevel);var Q=C.LEAF_GRID_NUM+1,m=0,a=null,w=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,q);a=new Uint16Array(w*w*6);for(var e=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/w,F=0;F<C.LEAF_GRID_NUM;F+=e)
for(var W=0;W<C.LEAF_GRID_NUM;W+=e)a[m]=(F+e)*Q+W,a[++m]=F*Q+W,a[++m]=F*Q+W+e,a[++m]=F*Q+W+e,a[++m]=(F+e)*Q+W+e,a[++m]=(F+e)*Q+W,m++;return a;},C.calcSkirtLODIndex=function(q){C._maxLODLevel<q&&(q=C._maxLODLevel);var Q=C.CHUNK_GRID_NUM/C.LEAF_GRID_NUM*(C.CHUNK_GRID_NUM/C.LEAF_GRID_NUM)*C.LEAF_PLANE_VERTEXT_COUNT,m=C.LEAF_GRID_NUM+1,a=0,w=null,e=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/Math.pow(2,q);w=new Uint16Array(4*e*6);for(var F=laya.d3.terrain.TerrainLeaf.LEAF_GRID_NUM/e,W=0;W<4;W++){for(var s=0;s<C.LEAF_GRID_NUM;s+=F)w[a]=Q+m+s,w[++a]=Q+s,w[++a]=Q+s+F,w[++a]=Q+s+F,w[++a]=Q+m+s+F,w[++a]=Q+m+s,a++;Q+=2*m;}
return w;},C.getHeightFromTerrainHeightData=function(q,Q,m,a,w){return m[(Q=w<=(Q=Q<0?0:Q)?w-1:Q)*a+(q=a<=(q=q<0?0:q)?a-1:q)];},C.CHUNK_GRID_NUM=64,C.LEAF_GRID_NUM=32,C.__ADAPT_MATRIX__=null,C.__ADAPT_MATRIX_INV__=null,C._planeLODIndex=null,C._skirtLODIndex=null,C._bInit=!1,y(C,["LEAF_PLANE_VERTEXT_COUNT",function(){return this.LEAF_PLANE_VERTEXT_COUNT=(C.LEAF_GRID_NUM+1)*(C.LEAF_GRID_NUM+1);},"LEAF_SKIRT_VERTEXT_COUNT",function(){return this.LEAF_SKIRT_VERTEXT_COUNT=2*(C.LEAF_GRID_NUM+1)*4;},"LEAF_VERTEXT_COUNT",function(){return this.LEAF_VERTEXT_COUNT=C.LEAF_PLANE_VERTEXT_COUNT+C.LEAF_SKIRT_VERTEXT_COUNT;},"LEAF_PLANE_MAX_INDEX_COUNT",function(){return this.LEAF_PLANE_MAX_INDEX_COUNT=C.LEAF_GRID_NUM*C.LEAF_GRID_NUM*6;},"LEAF_SKIRT_MAX_INDEX_COUNT",function(){return this.LEAF_SKIRT_MAX_INDEX_COUNT=4*C.LEAF_GRID_NUM*6;},"LEAF_MAX_INDEX_COUNT",function(){return this.LEAF_MAX_INDEX_COUNT=C.LEAF_PLANE_MAX_INDEX_COUNT+C.LEAF_SKIRT_MAX_INDEX_COUNT;},"__VECTOR3__",function(){return this.__VECTOR3__=new _q();},"_maxLODLevel",function(){return this._maxLODLevel=Math.log2(C.LEAF_GRID_NUM);}]),C;}(),sq=function(){function q(){}
return S(q,"laya.d3.graphics.Vertex.VertexShuriKenParticle"),q.PARTICLE_CORNERTEXTURECOORDINATE0=0,q.PARTICLE_POSITION0=1,q.PARTICLE_COLOR0=2,q.PARTICLE_TEXTURECOORDINATE0=3,q.PARTICLE_SHAPEPOSITIONSTARTLIFETIME=4,q.PARTICLE_DIRECTIONTIME=5,q.PARTICLE_STARTCOLOR0=6,q.PARTICLE_ENDCOLOR0=7,q.PARTICLE_STARTSIZE=8,q.PARTICLE_STARTROTATION=9,q.PARTICLE_STARTSPEED=10,q.PARTICLE_RANDOM0=11,q.PARTICLE_RANDOM1=12,q.PARTICLE_SIMULATIONWORLDPOSTION=13,q.PARTICLE_SIMULATIONWORLDROTATION=14,q;}(),cq=function(){function q(q){this._size=null,this.enbale=!1,this._size=q;}
S(q,"laya.d3.core.particleShuriKen.module.SizeOverLifetime");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.cloneTo=function(q){var Q=q;this._size.cloneTo(Q._size),Q.enbale=this.enbale;},Q.clone=function(){var q;switch(this._size.type){case 0:q=this._size.separateAxes?JQ.createByGradientSeparate(this._size.gradientX.clone(),this._size.gradientY.clone(),this._size.gradientZ.clone()):JQ.createByGradient(this._size.gradient.clone());break;case 1:q=this._size.separateAxes?JQ.createByRandomTwoConstantSeparate(this._size.constantMinSeparate.clone(),this._size.constantMaxSeparate.clone()):JQ.createByRandomTwoConstant(this._size.constantMin,this._size.constantMax);break;case 2:q=this._size.separateAxes?JQ.createByRandomTwoGradientSeparate(this._size.gradientXMin.clone(),this._size.gradientYMin.clone(),this._size.gradientZMin.clone(),this._size.gradientXMax.clone(),this._size.gradientYMax.clone(),this._size.gradientZMax.clone()):JQ.createByRandomTwoGradient(this._size.gradientMin.clone(),this._size.gradientMax.clone());}
var Q=new this.constructor(q);return Q.enbale=this.enbale,Q;},d(0,Q,"size",function(){return this._size;}),q;}(),Dq=function(){function q(){this.time=NaN;}
S(q,"laya.d3.core.Keyframe");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.cloneTo=function(q){q.time=this.time;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q;}(),rq=function(){function q(q,Q,m,a){this.x=NaN,this.y=NaN,this.z=NaN,this.w=NaN,void 0===q&&(q=0),void 0===Q&&(Q=0),void 0===m&&(m=0),void 0===a&&(a=0),this.x=q,this.y=Q,this.z=m,this.w=a;}
S(q,"laya.d3.math.Vector4");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.setValue=function(q,Q,m,a){this.x=q,this.y=Q,this.z=m,this.w=a;},Q.fromArray=function(q,Q){void 0===Q&&(Q=0),this.x=q[Q+0],this.y=q[Q+1],this.z=q[Q+2],this.w=q[Q+3];},Q.cloneTo=function(q){var Q=q;Q.x=this.x,Q.y=this.y,Q.z=this.z,Q.w=this.w;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},Q.length=function(){return Math.sqrt(this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w);},Q.lengthSquared=function(){return this.x*this.x+this.y*this.y+this.z*this.z+this.w*this.w;},Q.forNativeElement=function(q){q?(this.elements=q,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z,this.elements[3]=this.w):this.elements=new Float32Array([this.x,this.y,this.z,this.w]),Zq.rewriteNumProperty(this,"x",0),Zq.rewriteNumProperty(this,"y",1),Zq.rewriteNumProperty(this,"z",2),Zq.rewriteNumProperty(this,"w",3);},q.lerp=function(q,Q,m,a){var w=q.x,e=q.y,F=q.z,W=q.w;a.x=w+m*(Q.x-w),a.y=e+m*(Q.y-e),a.z=F+m*(Q.z-F),a.w=W+m*(Q.w-W);},q.transformByM4x4=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=q.w,W=Q.elements;m.x=a*W[0]+w*W[4]+e*W[8]+F*W[12],m.y=a*W[1]+w*W[5]+e*W[9]+F*W[13],m.z=a*W[2]+w*W[6]+e*W[10]+F*W[14],m.w=a*W[3]+w*W[7]+e*W[11]+F*W[15];},q.equals=function(q,Q){return qq.nearEqual(Math.abs(q.x),Math.abs(Q.x))&&qq.nearEqual(Math.abs(q.y),Math.abs(Q.y))&&qq.nearEqual(Math.abs(q.z),Math.abs(Q.z))&&qq.nearEqual(Math.abs(q.w),Math.abs(Q.w));},q.normalize=function(q,Q){var m=q.length();0<m&&(Q.x=q.x*m,Q.y=q.y*m,Q.z=q.z*m,Q.w=q.w*m);},q.add=function(q,Q,m){m.x=q.x+Q.x,m.y=q.y+Q.y,m.z=q.z+Q.z,m.w=q.w+Q.w;},q.subtract=function(q,Q,m){m.x=q.x-Q.x,m.y=q.y-Q.y,m.z=q.z-Q.z,m.w=q.w-Q.w;},q.multiply=function(q,Q,m){m.x=q.x*Q.x,m.y=q.y*Q.y,m.z=q.z*Q.z,m.w=q.w*Q.w;},q.scale=function(q,Q,m){m.x=q.x*Q,m.y=q.y*Q,m.z=q.z*Q,m.w=q.w*Q;},q.Clamp=function(q,Q,m,a){var w=q.x,e=q.y,F=q.z,W=q.w,s=Q.x,D=Q.y,d=Q.z,v=Q.w,y=m.x,S=m.y,t=m.z,o=m.w;w=(w=y<w?y:w)<s?s:w,e=(e=S<e?S:e)<D?D:e,F=(F=t<F?t:F)<d?d:F,W=(W=o<W?o:W)<v?v:W,a.x=w,a.y=e,a.z=F,a.w=W;},q.distanceSquared=function(q,Q){var m=q.x-Q.x,a=q.y-Q.y,w=q.z-Q.z,e=q.w-Q.w;return m*m+a*a+w*w+e*e;},q.distance=function(q,Q){var m=q.x-Q.x,a=q.y-Q.y,w=q.z-Q.z,e=q.w-Q.w;return Math.sqrt(m*m+a*a+w*w+e*e);},q.dot=function(q,Q){return q.x*Q.x+q.y*Q.y+q.z*Q.z+q.w*Q.w;},q.min=function(q,Q,m){m.x=Math.min(q.x,Q.x),m.y=Math.min(q.y,Q.y),m.z=Math.min(q.z,Q.z),m.w=Math.min(q.w,Q.w);},q.max=function(q,Q,m){m.x=Math.max(q.x,Q.x),m.y=Math.max(q.y,Q.y),m.z=Math.max(q.z,Q.z),m.w=Math.max(q.w,Q.w);},y(q,["ZERO",function(){return this.ZERO=new q();},"ONE",function(){return this.ONE=new q(1,1,1,1);},"UnitX",function(){return this.UnitX=new q(1,0,0,0);},"UnitY",function(){return this.UnitY=new q(0,1,0,0);},"UnitZ",function(){return this.UnitZ=new q(0,0,1,0);},"UnitW",function(){return this.UnitW=new q(0,0,0,1);}]),q;}(),dq=function(){function q(q){if(this._counter=0,this.defines={},q)
for(var Q in this._counter=q._counter,q.defines)this.defines[Q]=q.defines[Q];}
return S(q,"laya.d3.shader.ShaderDefines"),q.prototype.registerDefine=function(q){var Q=Math.pow(2,this._counter++);return this.defines[Q]=q,Q;},q;}(),_q=function(){function w(q,Q,m,a){this.x=NaN,this.y=NaN,this.z=NaN,void 0===q&&(q=0),void 0===Q&&(Q=0),void 0===m&&(m=0),this.x=q,this.y=Q,this.z=m;}
S(w,"laya.d3.math.Vector3");var q=w.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.setValue=function(q,Q,m){this.x=q,this.y=Q,this.z=m;},q.fromArray=function(q,Q){void 0===Q&&(Q=0),this.x=q[Q+0],this.y=q[Q+1],this.z=q[Q+2];},q.cloneTo=function(q){var Q=q;Q.x=this.x,Q.y=this.y,Q.z=this.z;},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q.toDefault=function(){this.x=0,this.y=0,this.z=0;},q.forNativeElement=function(q){q?(this.elements=q,this.elements[0]=this.x,this.elements[1]=this.y,this.elements[2]=this.z):this.elements=new Float32Array([this.x,this.y,this.z]),Zq.rewriteNumProperty(this,"x",0),Zq.rewriteNumProperty(this,"y",1),Zq.rewriteNumProperty(this,"z",2);},w.distanceSquared=function(q,Q){var m=q.x-Q.x,a=q.y-Q.y,w=q.z-Q.z;return m*m+a*a+w*w;},w.distance=function(q,Q){var m=q.x-Q.x,a=q.y-Q.y,w=q.z-Q.z;return Math.sqrt(m*m+a*a+w*w);},w.min=function(q,Q,m){m.x=Math.min(q.x,Q.x),m.y=Math.min(q.y,Q.y),m.z=Math.min(q.z,Q.z);},w.max=function(q,Q,m){m.x=Math.max(q.x,Q.x),m.y=Math.max(q.y,Q.y),m.z=Math.max(q.z,Q.z);},w.transformQuat=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=Q.x,W=Q.y,s=Q.z,D=Q.w,d=D*a+W*e-s*w,v=D*w+s*a-F*e,y=D*e+F*w-W*a,S=-F*a-W*w-s*e;m.x=d*D+S* -F+v* -s-y* -W,m.y=v*D+S* -W+y* -F-d* -s,m.z=y*D+S* -s+d* -W-v* -F;},w.scalarLength=function(q){var Q=q.x,m=q.y,a=q.z;return Math.sqrt(Q*Q+m*m+a*a);},w.scalarLengthSquared=function(q){var Q=q.x,m=q.y,a=q.z;return Q*Q+m*m+a*a;},w.normalize=function(q,Q){var m=q.x,a=q.y,w=q.z,e=m*m+a*a+w*w;0<e&&(e=1/Math.sqrt(e),Q.x=q.x*e,Q.y=q.y*e,Q.z=q.z*e);},w.multiply=function(q,Q,m){m.x=q.x*Q.x,m.y=q.y*Q.y,m.z=q.z*Q.z;},w.scale=function(q,Q,m){m.x=q.x*Q,m.y=q.y*Q,m.z=q.z*Q;},w.lerp=function(q,Q,m,a){var w=q.x,e=q.y,F=q.z;a.x=w+m*(Q.x-w),a.y=e+m*(Q.y-e),a.z=F+m*(Q.z-F);},w.transformV3ToV3=function(q,Q,m){var a=w._tempVector4;w.transformV3ToV4(q,Q,a),m.x=a.x,m.y=a.y,m.z=a.z;},w.transformV3ToV4=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=Q.elements;m.x=a*F[0]+w*F[4]+e*F[8]+F[12],m.y=a*F[1]+w*F[5]+e*F[9]+F[13],m.z=a*F[2]+w*F[6]+e*F[10]+F[14],m.w=a*F[3]+w*F[7]+e*F[11]+F[15];},w.TransformNormal=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=Q.elements;m.x=a*F[0]+w*F[4]+e*F[8],m.y=a*F[1]+w*F[5]+e*F[9],m.z=a*F[2]+w*F[6]+e*F[10];},w.transformCoordinate=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=Q.elements,W=a*F[3]+w*F[7]+e*F[11]+F[15];m.x=a*F[0]+w*F[4]+e*F[8]+F[12]/W,m.y=a*F[1]+w*F[5]+e*F[9]+F[13]/W,m.z=a*F[2]+w*F[6]+e*F[10]+F[14]/W;},w.Clamp=function(q,Q,m,a){var w=q.x,e=q.y,F=q.z,W=Q.x,s=Q.y,D=Q.z,d=m.x,v=m.y,y=m.z;w=(w=d<w?d:w)<W?W:w,e=(e=v<e?v:e)<s?s:e,F=(F=y<F?y:F)<D?D:F,a.x=w,a.y=e,a.z=F;},w.add=function(q,Q,m){m.x=q.x+Q.x,m.y=q.y+Q.y,m.z=q.z+Q.z;},w.subtract=function(q,Q,m){m.x=q.x-Q.x,m.y=q.y-Q.y,m.z=q.z-Q.z;},w.cross=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=Q.x,W=Q.y,s=Q.z;m.x=w*s-e*W,m.y=e*F-a*s,m.z=a*W-w*F;},w.dot=function(q,Q){return q.x*Q.x+q.y*Q.y+q.z*Q.z;},w.equals=function(q,Q){return qq.nearEqual(q.x,Q.x)&&qq.nearEqual(q.y,Q.y)&&qq.nearEqual(q.z,Q.z);},w._ZERO=new w(0,0,0),w._ONE=new w(1,1,1),w._NegativeUnitX=new w(-1,0,0),w._UnitX=new w(1,0,0),w._UnitY=new w(0,1,0),w._UnitZ=new w(0,0,1),w._ForwardRH=new w(0,0,-1),w._ForwardLH=new w(0,0,1),w._Up=new w(0,1,0),y(w,["_tempVector4",function(){return this._tempVector4=new rq();}]),w;}(),Zq=function(){function Q(q,Q){this.x=NaN,this.y=NaN,void 0===q&&(q=0),void 0===Q&&(Q=0),this.x=q,this.y=Q;}
S(Q,"laya.d3.math.Vector2");var q=Q.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.setValue=function(q,Q){this.x=q,this.y=Q;},q.fromArray=function(q,Q){void 0===Q&&(Q=0),this.x=q[Q+0],this.y=q[Q+1];},q.cloneTo=function(q){var Q=q;Q.x=this.x,Q.y=this.y;},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q.forNativeElement=function(q){q?(this.elements=q,this.elements[0]=this.x,this.elements[1]=this.y):this.elements=new Float32Array([this.x,this.y]),Q.rewriteNumProperty(this,"x",0),Q.rewriteNumProperty(this,"y",1);},Q.scale=function(q,Q,m){m.x=q.x*Q,m.y=q.y*Q;},Q.dot=function(q,Q){return q.x*Q.x+q.y*Q.y;},Q.normalize=function(q,Q){var m=q.x,a=q.y,w=m*m+a*a;0<w&&(w=1/Math.sqrt(w),Q.x=m*w,Q.y=a*w);},Q.scalarLength=function(q){var Q=q.x,m=q.y;return Math.sqrt(Q*Q+m*m);},Q.rewriteNumProperty=function(q,Q,m){Object.defineProperty(q,Q,{get:function(){return this.elements[m];},set:function(q){this.elements[m]=q;}});},y(Q,["ZERO",function(){return this.ZERO=new Q(0,0);},"ONE",function(){return this.ONE=new Q(1,1);}]),Q;}(),vq=function(){function q(){}
S(q,"laya.d3.component.AnimatorPlayState");var Q=q.prototype;return Q._resetPlayState=function(q){this._finish=!1,this._startPlayTime=q,this._elapsedTime=q,this._playEventIndex=0,this._lastIsFront=!0;},Q._cloneTo=function(q){q._finish=this._finish,q._startPlayTime=this._startPlayTime,q._elapsedTime=this._elapsedTime,q._playEventIndex=this._playEventIndex,q._lastIsFront=this._lastIsFront;},d(0,Q,"normalizedTime",function(){return this._normalizedTime;}),d(0,Q,"duration",function(){return this._duration;}),q;}(),Aq=function(){function q(q){this._velocity=null,this.enbale=!1,this.space=0,this._velocity=q;}
S(q,"laya.d3.core.particleShuriKen.module.VelocityOverLifetime");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.cloneTo=function(q){var Q=q;this._velocity.cloneTo(Q._velocity),Q.enbale=this.enbale,Q.space=this.space;},Q.clone=function(){var q;switch(this._velocity.type){case 0:q=CQ.createByConstant(this._velocity.constant.clone());break;case 1:q=CQ.createByGradient(this._velocity.gradientX.clone(),this._velocity.gradientY.clone(),this._velocity.gradientZ.clone());break;case 2:q=CQ.createByRandomTwoConstant(this._velocity.constantMin.clone(),this._velocity.constantMax.clone());break;case 3:q=CQ.createByRandomTwoGradient(this._velocity.gradientXMin.clone(),this._velocity.gradientYMin.clone(),this._velocity.gradientZMin.clone(),this._velocity.gradientXMax.clone(),this._velocity.gradientYMax.clone(),this._velocity.gradientZMax.clone());}
var Q=new this.constructor(q);return Q.enbale=this.enbale,Q.space=this.space,Q;},d(0,Q,"velocity",function(){return this._velocity;}),q;}(),yq=function(){function q(){}
return S(q,"laya.d3.loaders.MeshReader"),q.read=function(q,Q,m){var a=new W(q);a.pos=0;var w=a.readUTFString();switch(w){case"LAYAMODEL:0301":case"LAYAMODEL:0400":case"LAYAMODEL:0401":oq.parse(a,w,Q,m);break;case"LAYAMODEL:05":case"LAYAMODEL:COMPRESSION_05":Sq.parse(a,w,Q,m);break;default:throw new Error("MeshReader: unknown mesh version.");}
Q._setSubMeshes(m);},q;}(),Sq=(function(){function q(){}
S(q,"laya.d3.core.scene.SceneManager");}(),function(){function q(){}
S(q,"laya.d3.math.ContainmentType"),q.Disjoint=0,q.Contains=1,q.Intersects=2;}(),function(){function B(){}
return S(B,"laya.d3.loaders.LoadModelV05"),B.parse=function(q,Q,m,a){B._mesh=m,B._subMeshes=a,B._version=Q,B._readData=q,B.READ_DATA(),B.READ_BLOCK(),B.READ_STRINGS();for(var w=0,e=B._BLOCK.count;w<e;w++){B._readData.pos=B._BLOCK.blockStarts[w];var F=B._readData.getUint16(),W=B._strings[F],s=B["READ_"+W];if(null==s)throw new Error("model file err,no this function:"+F+" "+W);s.call(null);}
B._mesh._bindPoseIndices=new Uint16Array(B._bindPoseIndices),B._bindPoseIndices.length=0,B._strings.length=0,B._readData=null,B._version=null,B._mesh=null,B._subMeshes=null;},B._readString=function(){return B._strings[B._readData.getUint16()];},B.READ_DATA=function(){B._DATA.offset=B._readData.getUint32(),B._DATA.size=B._readData.getUint32();},B.READ_BLOCK=function(){for(var q=B._BLOCK.count=B._readData.getUint16(),Q=B._BLOCK.blockStarts=[],m=B._BLOCK.blockLengths=[],a=0;a<q;a++)Q.push(B._readData.getUint32()),m.push(B._readData.getUint32());},B.READ_STRINGS=function(){var q=B._readData.getUint32(),Q=B._readData.getUint16(),m=B._readData.pos;B._readData.pos=q+B._DATA.offset;for(var a=0;a<Q;a++)B._strings[a]=B._readData.readUTFString();B._readData.pos=m;},B.READ_MESH=function(){var q=0,Q=0,m=(B._readString(),B._readData.__getBuffer()),a=B._readData.getInt16(),w=B._DATA.offset;for(q=0;q<a;q++){var e=w+B._readData.getUint32(),F=B._readData.getUint32(),W=B._readString(),s=bq.getVertexDeclaration(W,!1),D=s.vertexStride,d=new ArrayBuffer(D*F),v=new Float32Array(d),y=W.split(","),S=y.length;switch(B._version){case"LAYAMODEL:05":v=new Float32Array(m.slice(e,e+F*D));break;case"LAYAMODEL:COMPRESSION_05":var t=B._readData.pos;v=new Float32Array(d);var o=new Uint8Array(d);B._readData.pos=e;for(var b=0;b<F;b++)
for(var U=0,J=b*D,V=0;V<S;V++)switch(y[V]){case"POSITION":v[U=J/4]=nq.convertToNumber(B._readData.getUint16()),v[U+1]=nq.convertToNumber(B._readData.getUint16()),v[U+2]=nq.convertToNumber(B._readData.getUint16()),J+=12;break;case"NORMAL":v[U=J/4]=B._readData.getUint8()/127.5-1,v[U+1]=B._readData.getUint8()/127.5-1,v[U+2]=B._readData.getUint8()/127.5-1,J+=12;break;case"COLOR":v[U=J/4]=B._readData.getUint8()/255,v[U+1]=B._readData.getUint8()/255,v[U+2]=B._readData.getUint8()/255,v[U+3]=B._readData.getUint8()/255,J+=16;break;case"UV":case"UV1":v[U=J/4]=nq.convertToNumber(B._readData.getUint16()),v[U+1]=nq.convertToNumber(B._readData.getUint16()),J+=8;break;case"BLENDWEIGHT":v[U=J/4]=B._readData.getUint8()/255,v[U+1]=B._readData.getUint8()/255,v[U+2]=B._readData.getUint8()/255,v[U+3]=B._readData.getUint8()/255,J+=16;break;case"BLENDINDICES":o[J]=B._readData.getUint8(),o[J+1]=B._readData.getUint8(),o[J+2]=B._readData.getUint8(),o[J+3]=B._readData.getUint8(),J+=4;break;case"TANGENT":v[U=J/4]=B._readData.getUint8()/127.5-1,v[U+1]=B._readData.getUint8()/127.5-1,v[U+2]=B._readData.getUint8()/127.5-1,v[U+3]=B._readData.getUint8()/127.5-1,J+=16;}
B._readData.pos=t;}
var n=new HQ(d.byteLength,35044,!0);n.vertexDeclaration=s,n.setData(v),B._mesh._vertexBuffers.push(n),B._mesh._vertexCount+=n.vertexCount,Q+=4*v.length;}
var O=w+B._readData.getUint32(),C=B._readData.getUint32(),l=new Uint16Array(m.slice(O,O+C)),u=new gQ("ushort",C/2,35044,!0);u.setData(l),B._mesh._indexBuffer=u,B._mesh._setBuffer(B._mesh._vertexBuffers,u),Q+=2*u.indexCount,B._mesh._setCPUMemory(Q),B._mesh._setGPUMemory(Q);var f=B._mesh._boneNames=[],p=B._readData.getUint16();for(f.length=p,q=0;q<p;q++)f[q]=B._strings[B._readData.getUint16()];var T=B._readData.getUint32(),c=B._readData.getUint32(),r=new Float32Array(m.slice(w+T,w+T+c)),_=r.length,Z=_/16,A=B._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*_);for(B._mesh._inverseBindPoses=N(Z),q=0;q<_;q+=16){var E=new kQ(r[q+0],r[q+1],r[q+2],r[q+3],r[q+4],r[q+5],r[q+6],r[q+7],r[q+8],r[q+9],r[q+10],r[q+11],r[q+12],r[q+13],r[q+14],r[q+15],new Float32Array(A,4*q,16));B._mesh._inverseBindPoses[q/16]=E;}
return!0;},B.READ_SUBMESH=function(){var q=B._readData.__getBuffer(),Q=new em(B._mesh),m=B._readData.getInt16(),a=B._readData.getUint32(),w=B._readData.getUint32(),e=B._mesh._indexBuffer;Q._indexBuffer=e,Q._indexStart=a,Q._indexCount=w,Q._indices=new Uint16Array(e.getData().buffer,2*a,w);var F=B._mesh._vertexBuffers[m];Q._vertexBuffer=F;var W=B._DATA.offset,s=Q._subIndexBufferStart,D=Q._subIndexBufferCount,d=Q._boneIndicesList,v=B._readData.getUint16();s.length=v,D.length=v,d.length=v;for(var y=B._mesh._skinDataPathMarks,S=B._bindPoseIndices,t=B._subMeshes.length,o=0;o<v;o++){s[o]=B._readData.getUint32(),D[o]=B._readData.getUint32();for(var b=B._readData.getUint32(),U=B._readData.getUint32(),J=d[o]=new Uint16Array(q.slice(W+b,W+b+U)),V=0,n=J.length;V<n;V++){var O=J[V],C=S.indexOf(O);-
1===C?(J[V]=S.length,S.push(O),y.push([t,o,V])):J[V]=C;}}
return B._subMeshes.push(Q),!0;},B._strings=[],B._readData=null,B._version=null,B._mesh=null,B._subMeshes=null,B._bindPoseIndices=[],y(B,["_BLOCK",function(){return this._BLOCK={count:0};},"_DATA",function(){return this._DATA={offset:0,size:0};}]),B;}()),tq=function(){function q(q,Q,m,a){this.r=NaN,this.g=NaN,this.b=NaN,this.a=NaN,void 0===q&&(q=1),void 0===Q&&(Q=1),void 0===m&&(m=1),void 0===a&&(a=1),this.r=q,this.g=Q,this.b=m,this.a=a;}
S(q,"laya.d3.math.Color");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.toLinear=function(q){q.r=Rq.gammaToLinearSpace(this.r),q.g=Rq.gammaToLinearSpace(this.g),q.b=Rq.gammaToLinearSpace(this.b);},Q.toGamma=function(q){q.r=Rq.linearToGammaSpace(this.r),q.g=Rq.linearToGammaSpace(this.g),q.b=Rq.linearToGammaSpace(this.b);},Q.cloneTo=function(q){var Q=q;Q.r=this.r,Q.g=this.g,Q.b=this.b,Q.a=this.a;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},Q.forNativeElement=function(q){q?(this.elements=q,this.elements[0]=this.r,this.elements[1]=this.g,this.elements[2]=this.b,this.elements[3]=this.a):this.elements=new Float32Array([this.r,this.g,this.b,this.a]),Zq.rewriteNumProperty(this,"r",0),Zq.rewriteNumProperty(this,"g",1),Zq.rewriteNumProperty(this,"b",2),Zq.rewriteNumProperty(this,"a",3);},y(q,["RED",function(){return this.RED=new q(1,0,0,1);},"GREEN",function(){return this.GREEN=new q(0,1,0,1);},"BLUE",function(){return this.BLUE=new q(0,0,1,1);},"CYAN",function(){return this.CYAN=new q(0,1,1,1);},"YELLOW",function(){return this.YELLOW=new q(1,.92,.016,1);},"MAGENTA",function(){return this.MAGENTA=new q(1,0,1,1);},"GRAY",function(){return this.GRAY=new q(.5,.5,.5,1);},"WHITE",function(){return this.WHITE=new q(1,1,1,1);},"BLACK",function(){return this.BLACK=new q(0,0,0,1);}]),q;}(),oq=function(){function u(){}
return S(u,"laya.d3.loaders.LoadModelV04"),u.parse=function(q,Q,m,a){u._mesh=m,u._subMeshes=a,u._version=Q,u._readData=q,u.READ_DATA(),u.READ_BLOCK(),u.READ_STRINGS();for(var w=0,e=u._BLOCK.count;w<e;w++){u._readData.pos=u._BLOCK.blockStarts[w];var F=u._readData.getUint16(),W=u._strings[F],s=u["READ_"+W];if(null==s)throw new Error("model file err,no this function:"+F+" "+W);s.call(null);}
u._mesh._bindPoseIndices=new Uint16Array(u._bindPoseIndices),u._bindPoseIndices.length=0,u._strings.length=0,u._readData=null,u._version=null,u._mesh=null,u._subMeshes=null;},u._readString=function(){return u._strings[u._readData.getUint16()];},u.READ_DATA=function(){u._DATA.offset=u._readData.getUint32(),u._DATA.size=u._readData.getUint32();},u.READ_BLOCK=function(){for(var q=u._BLOCK.count=u._readData.getUint16(),Q=u._BLOCK.blockStarts=[],m=u._BLOCK.blockLengths=[],a=0;a<q;a++)Q.push(u._readData.getUint32()),m.push(u._readData.getUint32());},u.READ_STRINGS=function(){var q=u._readData.getUint32(),Q=u._readData.getUint16(),m=u._readData.pos;u._readData.pos=q+u._DATA.offset;for(var a=0;a<Q;a++)u._strings[a]=u._readData.readUTFString();u._readData.pos=m;},u.READ_MESH=function(){u._readString();var q=u._readData.__getBuffer(),Q=0,m=0,a=u._readData.getInt16(),w=u._DATA.offset;for(Q=0;Q<a;Q++){var e,F=w+u._readData.getUint32(),W=u._readData.getUint32(),s=new Float32Array(q.slice(F,F+W)),D=u._readString();switch(u._version){case"LAYAMODEL:0301":case"LAYAMODEL:0400":e=bq.getVertexDeclaration(D);break;case"LAYAMODEL:0401":e=bq.getVertexDeclaration(D,!1);break;default:throw new Error("LoadModelV03: unknown version.");}
if(!e)throw new Error("LoadModelV03: unknown vertexDeclaration.");var d=new HQ(4*s.length,35044,!0);d.vertexDeclaration=e,d.setData(s),u._mesh._vertexBuffers.push(d),u._mesh._vertexCount+=d.vertexCount,m+=4*s.length;}
var v=w+u._readData.getUint32(),y=u._readData.getUint32(),S=new Uint16Array(q.slice(v,v+y)),t=new gQ("ushort",y/2,35044,!0);t.setData(S),m+=2*(u._mesh._indexBuffer=t).indexCount,u._mesh._setBuffer(u._mesh._vertexBuffers,t),u._mesh._setCPUMemory(m),u._mesh._setGPUMemory(m);var o=u._mesh._boneNames=[],b=u._readData.getUint16();for(o.length=b,Q=0;Q<b;Q++)o[Q]=u._strings[u._readData.getUint16()];u._readData.pos+=8;var U=u._readData.getUint32(),J=u._readData.getUint32(),V=new Float32Array(q.slice(w+U,w+U+J)),n=V.length,O=n/16,C=u._mesh._inverseBindPosesBuffer=new ArrayBuffer(4*n);for(u._mesh._inverseBindPoses=N(O),Q=0;Q<n;Q+=16){var l=new kQ(V[Q+0],V[Q+1],V[Q+2],V[Q+3],V[Q+4],V[Q+5],V[Q+6],V[Q+7],V[Q+8],V[Q+9],V[Q+10],V[Q+11],V[Q+12],V[Q+13],V[Q+14],V[Q+15],new Float32Array(C,4*Q,16));u._mesh._inverseBindPoses[Q/16]=l;}
return!0;},u.READ_SUBMESH=function(){var q=u._readData.__getBuffer(),Q=new em(u._mesh),m=u._readData.getInt16();u._readData.getUint32(),u._readData.getUint32();var a=u._readData.getUint32(),w=u._readData.getUint32(),e=u._mesh._indexBuffer;Q._indexBuffer=e,Q._indexStart=a,Q._indexCount=w,Q._indices=new Uint16Array(e.getData().buffer,2*a,w);var F=u._mesh._vertexBuffers[m];Q._vertexBuffer=F;var W=u._DATA.offset,s=Q._subIndexBufferStart,D=Q._subIndexBufferCount,d=Q._boneIndicesList,v=u._readData.getUint16();s.length=v,D.length=v,d.length=v;for(var y=u._mesh._skinDataPathMarks,S=u._bindPoseIndices,t=u._subMeshes.length,o=0;o<v;o++){s[o]=u._readData.getUint32(),D[o]=u._readData.getUint32();for(var b=u._readData.getUint32(),U=u._readData.getUint32(),J=d[o]=new Uint16Array(q.slice(W+b,W+b+U)),V=0,n=J.length;V<n;V++){var O=J[V],C=S.indexOf(O);-
1===C?(J[V]=S.length,S.push(O),y.push([t,o,V])):J[V]=C;}}
return u._subMeshes.push(Q),!0;},u._strings=[],u._readData=null,u._version=null,u._mesh=null,u._subMeshes=null,u._bindPoseIndices=[],y(u,["_BLOCK",function(){return this._BLOCK={count:0};},"_DATA",function(){return this._DATA={offset:0,size:0};}]),u;}(),bq=function(){function D(){}
return S(D,"laya.d3.graphics.Vertex.VertexMesh"),D.getVertexDeclaration=function(q,Q){void 0===Q&&(Q=!0);var m=D._vertexDeclarationMap[q+(Q?"_0":"_1")];if(!m){for(var a=q.split(","),w=0,e=[],F=0,W=a.length;F<W;F++){var s;switch(a[F]){case"POSITION":s=new Gq(w,"vector3",0),w+=12;break;case"NORMAL":s=new Gq(w,"vector3",3),w+=12;break;case"COLOR":s=new Gq(w,"vector4",1),w+=16;break;case"UV":s=new Gq(w,"vector2",2),w+=8;break;case"UV1":s=new Gq(w,"vector2",7),w+=8;break;case"BLENDWEIGHT":s=new Gq(w,"vector4",6),w+=16;break;case"BLENDINDICES":Q?(s=new Gq(w,"vector4",5),w+=16):(s=new Gq(w,"byte4",5),w+=4);break;case"TANGENT":s=new Gq(w,"vector4",4),w+=16;break;default:throw"VertexMesh: unknown vertex flag.";}
e.push(s);}
m=new tQ(w,e),D._vertexDeclarationMap[q+(Q?"_0":"_1")]=m;}
return m;},D.MESH_POSITION0=0,D.MESH_COLOR0=1,D.MESH_TEXTURECOORDINATE0=2,D.MESH_NORMAL0=3,D.MESH_TANGENT0=4,D.MESH_BLENDINDICES0=5,D.MESH_BLENDWEIGHT0=6,D.MESH_TEXTURECOORDINATE1=7,D.MESH_WORLDMATRIX_ROW0=8,D.MESH_WORLDMATRIX_ROW1=9,D.MESH_WORLDMATRIX_ROW2=10,D.MESH_WORLDMATRIX_ROW3=11,D.MESH_MVPMATRIX_ROW0=12,D.MESH_MVPMATRIX_ROW1=13,D.MESH_MVPMATRIX_ROW2=14,D.MESH_MVPMATRIX_ROW3=15,D._vertexDeclarationMap={},y(D,["instanceWorldMatrixDeclaration",function(){return this.instanceWorldMatrixDeclaration=new tQ(64,[new Gq(0,"vector4",8),new Gq(16,"vector4",9),new Gq(32,"vector4",10),new Gq(48,"vector4",11)]);},"instanceMVPMatrixDeclaration",function(){return this.instanceMVPMatrixDeclaration=new tQ(64,[new Gq(0,"vector4",12),new Gq(16,"vector4",13),new Gq(32,"vector4",14),new Gq(48,"vector4",15)]);}]),D;}(),Uq=function(){function q(){this._destroyed=!1,this._emissionRate=0,this._bursts=null,this.enbale=!1,this._destroyed=!1,this.emissionRate=10,this._bursts=[];}
S(q,"laya.d3.core.particleShuriKen.module.Emission");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0,"laya.resource.IDestroy":!0}),Q.destroy=function(){this._bursts=null,this._destroyed=!0;},Q.getBurstsCount=function(){return this._bursts.length;},Q.getBurstByIndex=function(q){return this._bursts[q];},Q.addBurst=function(q){var Q=this._bursts.length;if(0<Q)
for(var m=0;m<Q;m++)this._bursts[m].time>q.time&&this._bursts.splice(m,0,q);this._bursts.push(q);},Q.removeBurst=function(q){var Q=this._bursts.indexOf(q);-
1!==Q&&this._bursts.splice(Q,1);},Q.removeBurstByIndex=function(q){this._bursts.splice(q,1);},Q.clearBurst=function(){this._bursts.length=0;},Q.cloneTo=function(q){var Q=q,m=Q._bursts;m.length=this._bursts.length;for(var a=0,w=this._bursts.length;a<w;a++){var e=m[a];e?this._bursts[a].cloneTo(e):m[a]=this._bursts[a].clone();}
Q._emissionRate=this._emissionRate,Q.enbale=this.enbale;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,Q,"destroyed",function(){return this._destroyed;}),d(0,Q,"emissionRate",function(){return this._emissionRate;},function(q){if(q<0)throw new Error("ParticleBaseShape:emissionRate value must large or equal than 0.");this._emissionRate=q;}),q;}(),Jq=function(){function d(q,Q){this.center=null,this.radius=NaN,this.center=q,this.radius=Q;}
S(d,"laya.d3.math.BoundSphere");var q=d.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.toDefault=function(){this.center.toDefault(),this.radius=0;},q.intersectsRayDistance=function(q){return YQ.intersectsRayAndSphereRD(q,this);},q.intersectsRayPoint=function(q,Q){return YQ.intersectsRayAndSphereRP(q,this,Q);},q.cloneTo=function(q){var Q=q;this.center.cloneTo(Q.center),Q.radius=this.radius;},q.clone=function(){var q=new this.constructor(new _q(),new _q());return this.cloneTo(q),q;},d.createFromSubPoints=function(q,Q,m,a){if(null==q)throw new Error("points");if(Q<0||Q>=q.length)throw new Error("start"+Q+"Must be in the range [0, "+(q.length-1)+"]");if(m<0||Q+m>q.length)throw new Error("count"+m+"Must be in the range <= "+q.length+"}");var w=Q+m,e=d._tempVector3;e.x=0,e.y=0,e.z=0;for(var F=Q;F<w;++F)_q.add(q[F],e,e);var W=a.center;_q.scale(e,1/m,W);var s=0;for(F=Q;F<w;++F){var D=_q.distanceSquared(W,q[F]);s<D&&(s=D);}
a.radius=Math.sqrt(s);},d.createfromPoints=function(q,Q){if(null==q)throw new Error("points");d.createFromSubPoints(q,0,q.length,Q);},y(d,["_tempVector3",function(){return this._tempVector3=new _q();}]),d;}(),Vq=function(){function q(){this.renderType=0;}
S(q,"laya.d3.core.render.RenderElement");var Q=q.prototype;return Q.setTransform=function(q){this._transform=q;},Q.setGeometry=function(q){this._geometry=q;},Q.addToOpaqueRenderQueue=function(q,Q){Q.elements.push(this);},Q.addToTransparentRenderQueue=function(q,Q){Q.elements.push(this),Q.lastTransparentBatched=!1,Q.lastTransparentRenderElement=this;},Q._render=function(q,Q,m,a){var w,e,F,W=pa._updateMark,s=q.scene,D=q.camera,d=this._transform,v=this._geometry,y=W!==(q.renderElement=this).render._updateMark||this.renderType!==this.render._updateRenderType;if(y&&(this.render._renderUpdate(q,d),this.render._renderUpdateWithCamera(q,d),this.render._updateMark=W,this.render._updateRenderType=this.renderType),v._prepareRender(q)){var S,t=this.material._shader.getSubShaderAt(0);if(m)
if(a){var o=t.getFlag(a);if(!o)return;for(var b=m._subShaders,U=0,J=b.length;U<J;U++){var V=b[U];if(o===V.getFlag(a)){S=V._passes;break;}}
if(!S)return;}else S=m.getSubShaderAt(0)._passes;else S=t._passes;for(var n=0,O=S.length;n<O;n++){var C=q.shader=S[n].withCompile(s._defineDatas.value&~this.material._disablePublicDefineDatas.value,this.render._defineDatas.value,this.material._defineDatas.value),l=C.bind(),u=W!==C._uploadMark,f=C._uploadScene!==s||u;(f||l)&&(C.uploadUniforms(C._sceneUniformParamsMap,s._shaderValues,f),C._uploadScene=s);var p=C._uploadRender!==this.render||C._uploadRenderType!==this.renderType||u;(p||l)&&(C.uploadUniforms(C._spriteUniformParamsMap,this.render._shaderValues,p),C._uploadRender=this.render,C._uploadRenderType=this.renderType);var T=C._uploadCamera!==D||u;(T||l)&&(C.uploadUniforms(C._cameraUniformParamsMap,D._shaderValues,T),C._uploadCamera=D);var c=C._uploadMaterial!==this.material||u;(c||l)&&(C.uploadUniforms(C._materialUniformParamsMap,this.material._shaderValues,c),C._uploadMaterial=this.material);var r=this.material._shaderValues;w!==this.material||e!==C?(C.uploadRenderStateBlendDepth(r),C.uploadRenderStateFrontFace(r,Q,d),w=this.material,e=C,F=this.render):F!==this.render&&(C.uploadRenderStateFrontFace(r,Q,d),F=this.render),v._render(q),C._uploadMark=W;}}
y&&0!==this.renderType&&this.render._revertBatchRenderUpdate(q),pa._updateMark++;},Q.destroy=function(){this._transform=null,this._geometry=null,this.material=null,this.render=null;},q.RENDERTYPE_NORMAL=0,q.RENDERTYPE_STATICBATCH=1,q.RENDERTYPE_INSTANCEBATCH=2,q.RENDERTYPE_VERTEXBATCH=3,q;}(),nq=function(){function a(){}
return S(a,"laya.d3.math.HalfFloatUtils"),a.__init__=function(){for(var q=0;q<256;++q){var Q=q-127;a._shiftTable[256|q]=Q<-27?(a._baseTable[0|q]=0,a._baseTable[256|q]=32768,a._shiftTable[0|q]=24):Q<-14?(a._baseTable[0|q]=1024>>-Q-14,a._baseTable[256|q]=1024>>-Q-14|32768,a._shiftTable[0|q]=-Q-1,-Q-1):Q<=15?(a._baseTable[0|q]=Q+15<<10,a._baseTable[256|q]=Q+15<<10|32768,a._shiftTable[0|q]=13):Q<128?(a._baseTable[0|q]=31744,a._baseTable[256|q]=64512,a._shiftTable[0|q]=24):(a._baseTable[0|q]=31744,a._baseTable[256|q]=64512,a._shiftTable[0|q]=13);}
for(a._mantissaTable[0]=0,q=1;q<1024;++q){var m=q<<13;for(Q=0;0==(8388608&m);)Q-=8388608,m<<=1;m&=-8388609,Q+=947912704,a._mantissaTable[q]=m|Q;}
for(q=1024;q<2048;++q)a._mantissaTable[q]=939524096+(q-1024<<13);for(a._exponentTable[0]=0,q=1;q<31;++q)a._exponentTable[q]=q<<23;for(a._exponentTable[31]=1199570944,a._exponentTable[32]=2147483648,q=33;q<63;++q)a._exponentTable[q]=2147483648+(q-32<<23);for(a._exponentTable[63]=3347054592,a._offsetTable[0]=0,q=1;q<64;++q)a._offsetTable[q]=32===q?0:1024;},a.roundToFloat16Bits=function(q){a._floatView[0]=q;var Q=a._uint32View[0],m=Q>>23&511;return a._baseTable[m]+((8388607&Q)>>a._shiftTable[m]);},a.convertToNumber=function(q){var Q=q>>10;return a._uint32View[0]=a._mantissaTable[a._offsetTable[Q]+(1023&q)]+a._exponentTable[Q],a._floatView[0];},y(a,["_buffer",function(){return this._buffer=new ArrayBuffer(4);},"_floatView",function(){return this._floatView=new Float32Array(a._buffer);},"_uint32View",function(){return this._uint32View=new Uint32Array(a._buffer);},"_baseTable",function(){return this._baseTable=new Uint32Array(512);},"_shiftTable",function(){return this._shiftTable=new Uint32Array(512);},"_mantissaTable",function(){return this._mantissaTable=new Uint32Array(2048);},"_exponentTable",function(){return this._exponentTable=new Uint32Array(64);},"_offsetTable",function(){return this._offsetTable=new Uint32Array(64);}]),a;}(),Oq=function(){function q(){this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null;}
return S(q,"laya.d3.resource.models.SkyMesh"),q.prototype._render=function(q){},q;}(),Eq=function(){function q(q,Q){this._frame=null,this._startFrame=null,this.tiles=null,this.type=0,this.randomRow=!1,this.rowIndex=0,this.cycles=0,this.enableUVChannels=0,this.enable=!1,this.tiles=new Zq(1,1),this.type=0,this.randomRow=!0,this.rowIndex=0,this.cycles=1,this.enableUVChannels=1,this._frame=q,this._startFrame=Q;}
S(q,"laya.d3.core.particleShuriKen.module.TextureSheetAnimation");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.cloneTo=function(q){var Q=q;this.tiles.cloneTo(Q.tiles),Q.type=this.type,Q.randomRow=this.randomRow,this._frame.cloneTo(Q._frame),this._startFrame.cloneTo(Q._startFrame),Q.cycles=this.cycles,Q.enableUVChannels=this.enableUVChannels,Q.enable=this.enable;},Q.clone=function(){var q,Q;switch(this._frame.type){case 0:q=pq.createByConstant(this._frame.constant);break;case 1:q=pq.createByOverTime(this._frame.frameOverTimeData.clone());break;case 2:q=pq.createByRandomTwoConstant(this._frame.constantMin,this._frame.constantMax);break;case 3:q=pq.createByRandomTwoOverTime(this._frame.frameOverTimeDataMin.clone(),this._frame.frameOverTimeDataMax.clone());}
switch(this._startFrame.type){case 0:Q=uQ.createByConstant(this._startFrame.constant);break;case 1:Q=uQ.createByRandomTwoConstant(this._startFrame.constantMin,this._startFrame.constantMax);}
var m=new this.constructor(q,Q);return this.tiles.cloneTo(m.tiles),m.type=this.type,m.randomRow=this.randomRow,m.cycles=this.cycles,m.enableUVChannels=this.enableUVChannels,m.enable=this.enable,m;},d(0,Q,"frame",function(){return this._frame;}),d(0,Q,"startFrame",function(){return this._startFrame;}),q;}(),Cq=function(){function q(){}
return S(q,"laya.d3.resource.TextureGenerator"),q.lightAttenTexture=function(q,Q,m,a,w,e){var F=q/m,W=1/(1+25*F);.64<=F&&(1<F?W=0:W*=1-(F-.64)/.36),e[w]=Math.floor(255*W+.5);},q.haloTexture=function(q,Q,m,a,w,e){var F=(q-(m>>=1))/m,W=(Q-(a>>=1))/a,s=F*F+W*W;1<s&&(s=1),e[w]=Math.floor(255*(1-s)+.5);},q._generateTexture2D=function(q,Q,m,a){var w=0,e=0;switch(q.format){case 0:e=3;break;case 1:e=4;break;case 2:e=1;break;default:throw"GeneratedTexture._generateTexture: unkonw texture format.";}
for(var F=new Uint8Array(Q*m*e),W=0;W<m;W++)
for(var s=0;s<Q;s++)a(s,W,Q,m,w,F),w+=e;q.setPixels(F);},q;}(),Bq=function(){function w(q,Q,m,a){this._attributeMap=null,this._uniformMap=null,this._enableInstancing=!1,this._subShaders=[],this._name=q,this._attributeMap=Q,this._uniformMap=m,this._enableInstancing=a;}
S(w,"laya.d3.shader.Shader3D");var q=w.prototype;return q.addSubShader=function(q){this._subShaders.push(q),q._owner=this;},q.getSubShaderAt=function(q){return this._subShaders[q];},w.propertyNameToID=function(q){if(null!=w._propertyNameMap[q])return w._propertyNameMap[q];var Q=w._propertyNameCounter++;return w._propertyNameMap[q]=Q;},w.addInclude=function(q,Q){f.addInclude(q,Q);},w.registerPublicDefine=function(q){var Q=Math.pow(2,w._publicCounter++);return w._globleDefines[Q]=q,Q;},w.compileShader=function(q,Q,m,a,w,e){var F=laya.d3.shader.Shader3D.find(q);if(F){var W=F.getSubShaderAt(Q);if(W){var s=W._passes[m];s?A.shaderHighPrecision?s.withCompile(a,w,e):s.withCompile(a-laya.d3.shader.Shader3D.SHADERDEFINE_HIGHPRECISION,w,e):console.warn("Shader3D: unknown passIndex.");}else console.warn("Shader3D: unknown subShaderIndex.");}else console.warn("Shader3D: unknown shader name.");},w.add=function(q,Q,m,a){return void 0===a&&(a=!1),laya.d3.shader.Shader3D._preCompileShader[q]=new w(q,Q,m,a);},w.find=function(q){return laya.d3.shader.Shader3D._preCompileShader[q];},w.RENDER_STATE_CULL=0,w.RENDER_STATE_BLEND=1,w.RENDER_STATE_BLEND_SRC=2,w.RENDER_STATE_BLEND_DST=3,w.RENDER_STATE_BLEND_SRC_RGB=4,w.RENDER_STATE_BLEND_DST_RGB=5,w.RENDER_STATE_BLEND_SRC_ALPHA=6,w.RENDER_STATE_BLEND_DST_ALPHA=7,w.RENDER_STATE_BLEND_CONST_COLOR=8,w.RENDER_STATE_BLEND_EQUATION=9,w.RENDER_STATE_BLEND_EQUATION_RGB=10,w.RENDER_STATE_BLEND_EQUATION_ALPHA=11,w.RENDER_STATE_DEPTH_TEST=12,w.RENDER_STATE_DEPTH_WRITE=13,w.PERIOD_CUSTOM=0,w.PERIOD_MATERIAL=1,w.PERIOD_SPRITE=2,w.PERIOD_CAMERA=3,w.PERIOD_SCENE=4,w.SHADERDEFINE_HIGHPRECISION=0,w._propertyNameCounter=0,w._propertyNameMap={},w._publicCounter=0,w._globleDefines=[],w._preCompileShader={},w.debugMode=!1,w;}(),lq=function(){function q(q){this._temp=new Uint32Array(1),this.seeds=new Uint32Array(4),this.seeds[0]=q,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1;}
S(q,"laya.d3.math.Rand");var Q=q.prototype;return Q.getUint=function(){return this._temp[0]=this.seeds[0]^this.seeds[0]<<11,this.seeds[0]=this.seeds[1],this.seeds[1]=this.seeds[2],this.seeds[2]=this.seeds[3],this.seeds[3]=this.seeds[3]^this.seeds[3]>>>19^this._temp[0]^this._temp[0]>>>8,this.seeds[3];},Q.getFloat=function(){return this.getUint(),(8388607&this.seeds[3])*(1/8388607);},Q.getSignedFloat=function(){return 2*this.getFloat()-1;},d(0,Q,"seed",function(){return this.seeds[0];},function(q){this.seeds[0]=q,this.seeds[1]=1812433253*this.seeds[0]+1,this.seeds[2]=1812433253*this.seeds[1]+1,this.seeds[3]=1812433253*this.seeds[2]+1;}),q.getFloatFromInt=function(q){return 1/8388607*(8388607&q);},q.getByteFromInt=function(q){return(8388607&q)>>>15;},q;}(),Nq=function(){function J(){this._currentPSSM=-1,this._shadowMapCount=3,this._maxDistance=200,this._ratioOfDistance=1/this._shadowMapCount,this._statesDirty=!0,this._shadowMapTextureSize=1024,this._scene=null,this._PCFType=0,this._shaderValueLightVP=null,this._spiltDistance=new Array(4),this._globalParallelLightDir=new _q(0,-1,0),this._boundingSphere=new Array(4),this._boundingBox=new Array(4),this._frustumPos=new Array(16),this._uniformDistance=new Array(4),this._logDistance=new Array(4),this._dimension=new Array(4),this._tempLookAt3=new _q(),this._tempLookAt4=new rq(),this._tempValue=new rq(),this._tempPos=new _q(),this._tempLightUp=new _q(),this._tempMin=new rq(),this._tempMax=new rq(),this._tempMatrix44=new kQ(),this._splitFrustumCulling=new EQ(kQ.DEFAULT),this._tempScaleMatrix44=new kQ(),this._shadowPCFOffset=new Zq(1/1024,1/1024),this._shaderValueDistance=new rq(),this.cameras=[],this._shaderValueVPs=[];var q=0;for(q=0;q<this._spiltDistance.length;q++)this._spiltDistance[q]=0;for(q=0;q<this._dimension.length;q++)this._dimension[q]=new Zq();for(q=0;q<this._frustumPos.length;q++)this._frustumPos[q]=new _q();for(q=0;q<this._boundingBox.length;q++)this._boundingBox[q]=new GQ(new _q(),new _q());for(q=0;q<this._boundingSphere.length;q++)this._boundingSphere[q]=new Jq(new _q(),0);kQ.createScaling(new _q(.5,.5,1),this._tempScaleMatrix44),this._tempScaleMatrix44.elements[12]=.5,this._tempScaleMatrix44.elements[13]=.5;}
S(J,"laya.d3.shadowMap.ParallelSplitShadowMap");var q=J.prototype;return q.setInfo=function(q,Q,m,a,w,e){3<w&&(this._shadowMapCount=3),this._scene=q,this._maxDistance=Q,this.shadowMapCount=w,this._globalParallelLightDir=m,this._ratioOfDistance=1/this._shadowMapCount;for(var F=0;F<this._spiltDistance.length;F++)this._spiltDistance[F]=0;this._shadowMapTextureSize=a,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this.setPCFType(e),this._statesDirty=!0;},q.setPCFType=function(q){this._PCFType=q;var Q=this._scene._defineDatas;switch(this._PCFType){case 0:Q.add(gm.SHADERDEFINE_SHADOW_PCF_NO),Q.remove(gm.SHADERDEFINE_SHADOW_PCF1),Q.remove(gm.SHADERDEFINE_SHADOW_PCF2),Q.remove(gm.SHADERDEFINE_SHADOW_PCF3);break;case 1:Q.add(gm.SHADERDEFINE_SHADOW_PCF1),Q.remove(gm.SHADERDEFINE_SHADOW_PCF_NO),Q.remove(gm.SHADERDEFINE_SHADOW_PCF2),Q.remove(gm.SHADERDEFINE_SHADOW_PCF3);break;case 2:Q.add(gm.SHADERDEFINE_SHADOW_PCF2),Q.remove(gm.SHADERDEFINE_SHADOW_PCF_NO),Q.remove(gm.SHADERDEFINE_SHADOW_PCF1),Q.remove(gm.SHADERDEFINE_SHADOW_PCF3);break;case 3:Q.add(gm.SHADERDEFINE_SHADOW_PCF3),Q.remove(gm.SHADERDEFINE_SHADOW_PCF_NO),Q.remove(gm.SHADERDEFINE_SHADOW_PCF1),Q.remove(gm.SHADERDEFINE_SHADOW_PCF2);}},q.getPCFType=function(){return this._PCFType;},q.setFarDistance=function(q){this._maxDistance!=q&&(this._maxDistance=q,this._statesDirty=!0);},q.getFarDistance=function(){return this._maxDistance;},q._beginSampler=function(q,Q){if(q<0||q>this._shadowMapCount)throw new Error("ParallelSplitShadowMap: beginSample invalid index");this._currentPSSM=q,this._update(Q);},q.endSampler=function(q){this._currentPSSM=-1;},q._calcAllLightCameraInfo=function(q){if(1===this._shadowMapCount)this._beginSampler(0,q),this.endSampler(q);else
for(var Q=0,m=this._shadowMapCount+1;Q<m;Q++)this._beginSampler(Q,q),this.endSampler(q);},q._recalculate=function(q,Q,m){this._calcSplitDistance(q),this._calcBoundingBox(Q,m),this._rebuildRenderInfo();},q._update=function(q){var Q=q.nearPlane,m=q.fieldOfView,a=q.aspectRatio;(this._statesDirty||this.lastNearPlane!==Q||this.lastFieldOfView!==m||this.lastAspectRatio!==a)&&(this._recalculate(Q,m,a),this._uploadShaderValue(),this._statesDirty=!1,this.lastNearPlane=Q,this.lastFieldOfView=m,this.lastAspectRatio=a),this._calcLightViewProject(q);},q._uploadShaderValue=function(){var q=this._scene._defineDatas;switch(this._shadowMapCount){case 1:q.add(gm.SHADERDEFINE_SHADOW_PSSM1),q.remove(gm.SHADERDEFINE_SHADOW_PSSM2),q.remove(gm.SHADERDEFINE_SHADOW_PSSM3);break;case 2:q.add(gm.SHADERDEFINE_SHADOW_PSSM2),q.remove(gm.SHADERDEFINE_SHADOW_PSSM1),q.remove(gm.SHADERDEFINE_SHADOW_PSSM3);break;case 3:q.add(gm.SHADERDEFINE_SHADOW_PSSM3),q.remove(gm.SHADERDEFINE_SHADOW_PSSM1),q.remove(gm.SHADERDEFINE_SHADOW_PSSM2);}
var Q=this._scene._shaderValues;switch(Q.setVector(gm.SHADOWDISTANCE,this._shaderValueDistance),Q.setBuffer(gm.SHADOWLIGHTVIEWPROJECT,this._shaderValueLightVP),Q.setVector2(gm.SHADOWMAPPCFOFFSET,this._shadowPCFOffset),this._shadowMapCount){case 3:Q.setTexture(gm.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget),Q.setTexture(gm.SHADOWMAPTEXTURE2,this.cameras[2].renderTarget),Q.setTexture(gm.SHADOWMAPTEXTURE3,this.cameras[3].renderTarget);break;case 2:Q.setTexture(gm.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget),Q.setTexture(gm.SHADOWMAPTEXTURE2,this.cameras[2].renderTarget);break;case 1:Q.setTexture(gm.SHADOWMAPTEXTURE1,this.cameras[1].renderTarget);}},q._calcSplitDistance=function(q){var Q=this._maxDistance,m=1/this._shadowMapCount,a=0;for(a=0;a<=this._shadowMapCount;a++)this._uniformDistance[a]=q+(Q-q)*a*m;var w=Q/q;for(a=0;a<=this._shadowMapCount;a++){var e=Math.pow(w,a*m);this._logDistance[a]=q*e;}
for(a=0;a<=this._shadowMapCount;a++)this._spiltDistance[a]=this._uniformDistance[a]*this._ratioOfDistance+this._logDistance[a]*(1-this._ratioOfDistance);this._shaderValueDistance.x=this._spiltDistance[1],this._shaderValueDistance.y=this._spiltDistance[2],this._shaderValueDistance.z=this._spiltDistance[3],this._shaderValueDistance.w=0;},q._calcBoundingBox=function(q,Q){var m,a,w,e,F=3.1415926*q/180,W=Math.tan(F/2),s=NaN,D=NaN,d=NaN,v=0;for(v=0;v<=this._shadowMapCount;v++){D=(s=(d=this._spiltDistance[v])*W)*Q;var y=this._frustumPos[4*v+0];y.x=-D,y.y=-s,y.z=-d,(y=this._frustumPos[4*v+1]).x=D,y.y=-s,y.z=-d,(y=this._frustumPos[4*v+2]).x=-D,y.y=s,y.z=-d,(y=this._frustumPos[4*v+3]).x=D,y.y=s,y.z=-d,(y=this._dimension[v]).x=D,y.y=s;}
for(v=1;v<=this._shadowMapCount;v++)m=this._dimension[v],(a=this._boundingBox[v].min).x=-m.x,a.y=-m.y,a.z=-this._spiltDistance[v],(w=this._boundingBox[v].max).x=m.x,w.y=m.y,w.z=-this._spiltDistance[v-1],(e=this._boundingSphere[v].center).x=.5*(a.x+w.x),e.y=.5*(a.y+w.y),e.z=.5*(a.z+w.z),this._boundingSphere[v].radius=.5*Math.sqrt(Math.pow(w.x-a.x,2)+Math.pow(w.y-a.y,2)+Math.pow(w.z-a.z,2));a=this._boundingBox[0].min,m=this._dimension[this._shadowMapCount],a.x=-m.x,a.y=-m.y,a.z=-this._spiltDistance[this._shadowMapCount],(w=this._boundingBox[0].max).x=m.x,w.y=m.y,w.z=-this._spiltDistance[0],(e=this._boundingSphere[0].center).x=.5*(a.x+w.x),e.y=.5*(a.y+w.y),e.z=.5*(a.z+w.z),this._boundingSphere[0].radius=.5*Math.sqrt(Math.pow(w.x-a.x,2)+Math.pow(w.y-a.y,2)+Math.pow(w.z-a.z,2));},q.calcSplitFrustum=function(q){0<this._currentPSSM?kQ.createPerspective(3.1416*q.fieldOfView/180,q.aspectRatio,this._spiltDistance[this._currentPSSM-1],this._spiltDistance[this._currentPSSM],this._tempMatrix44):kQ.createPerspective(3.1416*q.fieldOfView/180,q.aspectRatio,this._spiltDistance[0],this._spiltDistance[this._shadowMapCount],this._tempMatrix44),kQ.multiply(this._tempMatrix44,q.viewMatrix,this._tempMatrix44),this._splitFrustumCulling.matrix=this._tempMatrix44;},q._rebuildRenderInfo=function(){var q=this._shadowMapCount+1,Q=0;for(this.cameras.length=q,Q=0;Q<q;Q++){if(!this.cameras[Q]){var m=new pa();m.name="lightCamera"+Q,m.clearColor=new rq(1,1,1,1),this.cameras[Q]=m;}
var a=this.cameras[Q].renderTarget;null!=a&&a.width==this._shadowMapTextureSize&&a.height==this._shadowMapTextureSize||(a&&a.destroy(),(a=new oa(this._shadowMapTextureSize,this._shadowMapTextureSize,1,0)).filterMode=0,this.cameras[Q].renderTarget=a);}},q._calcLightViewProject=function(q){var Q=this._boundingSphere[this._currentPSSM],m=q.transform.worldMatrix;Q.radius;Q.center.cloneTo(this._tempLookAt3),_q.transformV3ToV4(this._tempLookAt3,m,this._tempLookAt4);var a=this._tempLookAt3,w=this._tempLookAt4;a.x=w.x,a.y=w.y,a.z=w.z;var e=this._tempLightUp;q.transform.worldMatrix.getForward(J._tempVector30);var F=J._tempVector30;e.x=F.x,e.y=1,e.z=F.z,_q.normalize(this._tempLightUp,this._tempLightUp),_q.scale(this._globalParallelLightDir,4*Q.radius,this._tempPos),_q.subtract(this._tempLookAt3,this._tempPos,this._tempPos);var W=this.cameras[this._currentPSSM];W.transform.position=this._tempPos,W.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1);var s=this._tempMax,D=this._tempMin;s.x=s.y=s.z=-1e5,s.w=1,D.x=D.y=D.z=1e5,D.w=1,kQ.multiply(W.viewMatrix,m,this._tempMatrix44);var d=this._tempValue,v=[];v.length=8,this._boundingBox[this._currentPSSM].getCorners(v);for(var y=0;y<8;y++){var S=v[y];d.x=S.x,d.y=S.y,d.z=S.z,d.w=1,rq.transformByM4x4(this._tempValue,this._tempMatrix44,this._tempValue),D.x=d.x<D.x?d.x:D.x,D.y=d.y<D.y?d.y:D.y,D.z=d.z<D.z?d.z:D.z,s.x=d.x>s.x?d.x:s.x,s.y=d.y>s.y?d.y:s.y,s.z=d.z>s.z?d.z:s.z;}
rq.add(this._tempMax,this._tempMin,this._tempValue),d.x*=.5,d.y*=.5,d.z*=.5,d.w=1,rq.transformByM4x4(this._tempValue,W.transform.worldMatrix,this._tempValue);var t=Math.abs(-this._tempMax.z),o=t>this._maxDistance?t:this._maxDistance;_q.scale(this._globalParallelLightDir,o,this._tempPos);var b=this._tempPos;b.x=d.x-b.x,b.y=d.y-b.y,b.z=d.z-b.z,W.transform.position=this._tempPos,W.transform.lookAt(this._tempLookAt3,this._tempLightUp,!1),kQ.createOrthoOffCenter(D.x,s.x,D.y,s.y,1,o+.5*(s.z-D.z),W.projectionMatrix);var U=W.projectionViewMatrix;J.multiplyMatrixOutFloat32Array(this._tempScaleMatrix44,U,this._shaderValueVPs[this._currentPSSM]),this._scene._shaderValues.setBuffer(gm.SHADOWLIGHTVIEWPROJECT,this._shaderValueLightVP);},q.setShadowMapTextureSize=function(q){q!==this._shadowMapTextureSize&&(this._shadowMapTextureSize=q,this._shadowPCFOffset.x=1/this._shadowMapTextureSize,this._shadowPCFOffset.y=1/this._shadowMapTextureSize,this._statesDirty=!0);},q.disposeAllRenderTarget=function(){for(var q=0,Q=this._shadowMapCount+1;q<Q;q++)this.cameras[q].renderTarget&&(this.cameras[q].renderTarget.destroy(),this.cameras[q].renderTarget=null);},d(0,q,"shadowMapCount",function(){return this._shadowMapCount;},function(q){if(q=(q=0<q?q:1)<=3?q:3,this._shadowMapCount!=q){this._shadowMapCount=q,this._ratioOfDistance=1/this._shadowMapCount,this._statesDirty=!0,this._shaderValueLightVP=new Float32Array(16*q),this._shaderValueVPs.length=q;for(var Q=0;Q<q;Q++)this._shaderValueVPs[Q]=new Float32Array(this._shaderValueLightVP.buffer,64*Q);}}),J.multiplyMatrixOutFloat32Array=function(q,Q,m){var a,w,e,F,W,s,D;for(w=q.elements,e=Q.elements,a=0;a<4;a++)F=w[a],W=w[a+4],s=w[a+8],D=w[a+12],m[a]=F*e[0]+W*e[1]+s*e[2]+D*e[3],m[a+4]=F*e[4]+W*e[5]+s*e[6]+D*e[7],m[a+8]=F*e[8]+W*e[9]+s*e[10]+D*e[11],m[a+12]=F*e[12]+W*e[13]+s*e[14]+D*e[15];},J.MAX_PSSM_COUNT=3,y(J,["_tempVector30",function(){return this._tempVector30=new _q();}]),J;}(),Mq=(function(){function _(){}
S(_,"laya.d3.resource.models.PrimitiveMesh"),_._createMesh=function(q,Q,m){var a=new Gm(),w=new em(a),e=new HQ(4*Q.length,35044,!0);e.vertexDeclaration=q,e.setData(Q),a._vertexBuffers.push(e),a._vertexCount+=e.vertexCount;var F=new gQ("ushort",m.length,35044,!0);F.setData(m),a._indexBuffer=F;var W=N(1,null);W[0]=e,a._setBuffer(W,F),w._vertexBuffer=e,w._indexBuffer=F,w._indexStart=0,w._indexCount=F.indexCount;var s=w._subIndexBufferStart,D=w._subIndexBufferCount,d=w._boneIndicesList;s.length=1,D.length=1,d.length=1,D[s[0]=0]=F.indexCount;var v=[];v.push(w),a._setSubMeshes(v);var y=e._byteLength+F._byteLength;return a._setCPUMemory(y),a._setGPUMemory(y),a;},_.createBox=function(q,Q,m){void 0===q&&(q=1),void 0===Q&&(Q=1),void 0===m&&(m=1);var a=bq.getVertexDeclaration("POSITION,NORMAL,UV"),w=q/2,e=Q/2,F=m/2,W=new Float32Array([-w,e,-F,0,1,0,0,0,w,e,-F,0,1,0,1,0,w,e,F,0,1,0,1,1,-w,e,F,0,1,0,0,1,-w,-e,-F,0,-1,0,0,1,w,-e,-F,0,-1,0,1,1,w,-e,F,0,-1,0,1,0,-w,-e,F,0,-1,0,0,0,-w,e,-F,-1,0,0,0,0,-w,e,F,-1,0,0,1,0,-w,-e,F,-1,0,0,1,1,-w,-e,-F,-1,0,0,0,1,w,e,-F,1,0,0,1,0,w,e,F,1,0,0,0,0,w,-e,F,1,0,0,0,1,w,-e,-F,1,0,0,1,1,-w,e,F,0,0,1,0,0,w,e,F,0,0,1,1,0,w,-e,F,0,0,1,1,1,-w,-e,F,0,0,1,0,1,-w,e,-F,0,0,-1,1,0,w,e,-F,0,0,-1,0,0,w,-e,-F,0,0,-1,0,1,-w,-e,-F,0,0,-1,1,1]),s=new Uint16Array([0,1,2,2,3,0,4,7,6,6,5,4,8,9,10,10,11,8,12,15,14,14,13,12,16,17,18,18,19,16,20,23,22,22,21,20]);return _._createMesh(a,W,s);},_.createCapsule=function(q,Q,m,a){void 0===q&&(q=.5),void 0===Q&&(Q=2),void 0===m&&(m=16),void 0===a&&(a=32);var w=(m+1)*(a+1)*2+2*(a+1),e=3*m*(a+1)*2*2+2*a*3,F=bq.getVertexDeclaration("POSITION,NORMAL,UV"),W=F.vertexStride/4,s=new Float32Array(w*W),D=new Uint16Array(e),d=Math.PI/2/m,v=2*Math.PI/a,y=Q/2-q,S=0,t=0,o=0,b=0,U=0,J=0,V=0,n=0;for(V=0;V<=m;V++)
for(n=0;n<=a;n++)S=q*Math.cos(V*d)*Math.cos(n*v+Math.PI),t=q*Math.sin(V*d),o=q*Math.cos(V*d)*Math.sin(n*v+Math.PI),s[b++]=S,s[b++]=t+y,s[b++]=o,s[b++]=S,s[b++]=t,s[b++]=o,s[b++]=1-n/a,s[b++]=(1-V/m)*(Math.PI*q/2/(Q+Math.PI*q)),V<m&&(D[U++]=V*(a+1)+n+(a+1),D[U++]=V*(a+1)+n,D[U++]=V*(a+1)+n+1,D[U++]=V*(a+1)+n+a,D[U++]=V*(a+1)+n,D[U++]=V*(a+1)+n+(a+1));for(J+=(m+1)*(a+1),V=0;V<=m;V++)
for(n=0;n<=a;n++)S=q*Math.cos(V*d)*Math.cos(n*v+Math.PI),t=q*Math.sin(-V*d),o=q*Math.cos(V*d)*Math.sin(n*v+Math.PI),s[b++]=S,s[b++]=t-y,s[b++]=o,s[b++]=S,s[b++]=t,s[b++]=o,s[b++]=1-n/a,s[b++]=(V/m*(Math.PI*q/2)+(Q+Math.PI*q/2))/(Q+Math.PI*q),V<m&&(D[U++]=J+V*(a+1)+n,D[U++]=J+V*(a+1)+n+(a+1),D[U++]=J+V*(a+1)+n+1,D[U++]=J+V*(a+1)+n,D[U++]=J+V*(a+1)+n+a,D[U++]=J+V*(a+1)+n+(a+1));for(J+=(m+1)*(a+1),n=0;n<=a;n++)S=q*Math.cos(n*v+Math.PI),t=y,o=q*Math.sin(n*v+Math.PI),s[b++]=S,s[b+8*(a+1)-1]=S,s[b++]=t,s[b+8*(a+1)-1]=-t,s[b++]=o,s[b+8*(a+1)-1]=o,s[b++]=S,s[b+8*(a+1)-1]=S,s[b++]=0,s[b+8*(a+1)-1]=0,s[b++]=o,s[b+8*(a+1)-1]=o,s[b++]=1-1*n/a,s[b+8*(a+1)-1]=1-1*n/a,s[b++]=Math.PI*q/2/(Q+Math.PI*q),s[b+8*(a+1)-1]=(Math.PI*q/2+Q)/(Q+Math.PI*q);for(n=0;n<a;n++)D[U++]=n+J+(a+1),D[U++]=n+J+1,D[U++]=n+J,D[U++]=n+J+(a+1),D[U++]=n+J+(a+1)+1,D[U++]=n+J+1;return J+=2*(a+1),_._createMesh(F,s,D);},_.createCone=function(q,Q,m){void 0===q&&(q=.5),void 0===Q&&(Q=1),void 0===m&&(m=32);for(var a=m+1+1+2*(m+1),w=6*m+3*m,e=bq.getVertexDeclaration("POSITION,NORMAL,UV"),F=e.vertexStride/4,W=new Float32Array(a*F),s=new Uint16Array(w),D=2*Math.PI/m,d=Q/2,v=0,y=0,S=0,t=0,o=0,b=new _q(),U=new _q(0,-1,0),J=new _q(0,d,0),V=new _q(),n=new _q(),O=new eq(),C=new _q(),l=NaN,u=0,f=0,p=0;p<=m;p++)v=p*D,S=Math.cos(v+Math.PI)*q,t=d,o=Math.sin(v+Math.PI)*q,W[u++]=0,W[u+8*(m+1)-1]=S,W[u++]=t,W[u+8*(m+1)-1]=-t,W[u++]=0,W[u+8*(m+1)-1]=o,b.x=S,b.y=0,b.z=o,V.x=S,V.y=-t,V.z=o,_q.subtract(V,J,n),_q.normalize(n,n),l=Math.acos(_q.dot(U,n)),_q.cross(U,n,C),_q.normalize(C,C),eq.createFromAxisAngle(C,l,O),_q.normalize(b,b),_q.transformQuat(b,O,b),_q.normalize(b,b),W[u++]=b.x,W[u+8*(m+1)-1]=b.x,W[u++]=b.y,W[u+8*(m+1)-1]=b.y,W[u++]=b.z,W[u+8*(m+1)-1]=b.z,W[u++]=1-1*p/m,W[u+8*(m+1)-1]=1-1*p/m,W[u++]=0,W[u+8*(m+1)-1]=1;u+=8*(m+1);for(var T=0;T<m;T++)s[f++]=T+y+(m+1),s[f++]=T+y+1,s[f++]=T+y,s[f++]=T+y+(m+1),s[f++]=T+y+(m+1)+1,s[f++]=T+y+1;y+=2*(m+1);for(var c=0;c<=m;c++)0===c&&(W[u++]=0,W[u++]=-d,W[u++]=0,W[u++]=0,W[u++]=-1,W[u++]=0,W[u++]=.5,W[u++]=.5),v=c*D,S=Math.cos(v+Math.PI)*q,t=-d,o=Math.sin(v+Math.PI)*q,W[u++]=S,W[u++]=t,W[u++]=o,W[u++]=0,W[u++]=-1,W[u++]=0,W[u++]=.5+.5*Math.cos(v),W[u++]=.5+.5*Math.sin(v);for(var r=0;r<m;r++)s[f++]=0+y,s[f++]=r+2+y,s[f++]=r+1+y;return y+=m+1+1,_._createMesh(e,W,s);},_.createCylinder=function(q,Q,m){void 0===q&&(q=.5),void 0===Q&&(Q=2),void 0===m&&(m=32);for(var a=m+1+1+2*(m+1)+(m+1+1),w=3*m+6*m+3*m,e=bq.getVertexDeclaration("POSITION,NORMAL,UV"),F=e.vertexStride/4,W=new Float32Array(a*F),s=new Uint16Array(w),D=2*Math.PI/m,d=Q/2,v=0,y=0,S=0,t=0,o=0,b=0,U=0,J=0;J<=m;J++)0===J&&(W[b++]=0,W[b++]=d,W[b++]=0,W[b++]=0,W[b++]=1,W[b++]=0,W[b++]=.5,W[b++]=.5),v=J*D,S=Math.cos(v)*q,t=d,o=Math.sin(v)*q,W[b++]=S,W[b++]=t,W[b++]=o,W[b++]=0,W[b++]=1,W[b++]=0,W[b++]=.5+.5*Math.cos(v),W[b++]=.5+.5*Math.sin(v);for(var V=0;V<m;V++)s[U++]=0,s[U++]=V+1,s[U++]=V+2;y+=m+1+1;for(var n=0;n<=m;n++)v=n*D,S=Math.cos(v+Math.PI)*q,t=d,o=Math.sin(v+Math.PI)*q,W[b++]=S,W[b+8*(m+1)-1]=S,W[b++]=t,W[b+8*(m+1)-1]=-t,W[b++]=o,W[b+8*(m+1)-1]=o,W[b++]=S,W[b+8*(m+1)-1]=S,W[b++]=0,W[b+8*(m+1)-1]=0,W[b++]=o,W[b+8*(m+1)-1]=o,W[b++]=1-1*n/m,W[b+8*(m+1)-1]=1-1*n/m,W[b++]=0,W[b+8*(m+1)-1]=1;b+=8*(m+1);for(var O=0;O<m;O++)s[U++]=O+y+(m+1),s[U++]=O+y+1,s[U++]=O+y,s[U++]=O+y+(m+1),s[U++]=O+y+(m+1)+1,s[U++]=O+y+1;y+=2*(m+1);for(var C=0;C<=m;C++)0===C&&(W[b++]=0,W[b++]=-d,W[b++]=0,W[b++]=0,W[b++]=-1,W[b++]=0,W[b++]=.5,W[b++]=.5),v=C*D,S=Math.cos(v+Math.PI)*q,t=-d,o=Math.sin(v+Math.PI)*q,W[b++]=S,W[b++]=t,W[b++]=o,W[b++]=0,W[b++]=-1,W[b++]=0,W[b++]=.5+.5*Math.cos(v),W[b++]=.5+.5*Math.sin(v);for(var l=0;l<m;l++)s[U++]=0+y,s[U++]=l+2+y,s[U++]=l+1+y;return y+=m+1+1,_._createMesh(e,W,s);},_.createPlane=function(q,Q,m,a){void 0===q&&(q=10),void 0===Q&&(Q=10),void 0===m&&(m=10),void 0===a&&(a=10);for(var w=(m+1)*(a+1),e=new Uint16Array(m*a*2*3),F=bq.getVertexDeclaration("POSITION,NORMAL,UV"),W=F.vertexStride/4,s=new Float32Array(w*W),D=q/2,d=Q/2,v=q/m,y=Q/a,S=0,t=0;t<=a;t++)
for(var o=0;o<=m;o++)s[S++]=o*v-D,s[S++]=0,s[S++]=t*y-d,s[S++]=0,s[S++]=1,s[S++]=0,s[S++]=1*o/m,s[S++]=1*t/a;var b=0;for(t=0;t<a;t++)
for(o=0;o<m;o++)e[b++]=(t+1)*(m+1)+o,e[b++]=t*(m+1)+o,e[b++]=(t+1)*(m+1)+o+1,e[b++]=t*(m+1)+o,e[b++]=t*(m+1)+o+1,e[b++]=(t+1)*(m+1)+o+1;return _._createMesh(F,s,e);},_.createQuad=function(q,Q){void 0===q&&(q=1),void 0===Q&&(Q=1);var m=bq.getVertexDeclaration("POSITION,NORMAL,UV"),a=(m.vertexStride,q/2),w=Q/2,e=new Float32Array([-a,w,0,0,0,1,0,0,a,w,0,0,0,1,1,0,-a,-w,0,0,0,1,0,1,a,-w,0,0,0,1,1,1]),F=new Uint16Array([0,1,2,3,2,1]);return _._createMesh(m,e,F);},_.createSphere=function(q,Q,m){void 0===q&&(q=.5),void 0===Q&&(Q=32),void 0===m&&(m=32);for(var a=(Q+1)*(m+1),w=3*Q*(m+1)*2,e=new Uint16Array(w),F=bq.getVertexDeclaration("POSITION,NORMAL,UV"),W=F.vertexStride/4,s=new Float32Array(a*W),D=Math.PI/Q,d=2*Math.PI/m,v=0,y=w=a=0;y<Q+1;y++)
for(var S=Math.sin(y*D),t=Math.cos(y*D),o=0;o<m+1;o++){var b=S*Math.sin(o*d+1*Math.PI/2),U=S*Math.cos(o*d+1*Math.PI/2);s[a+0]=b*q,s[a+1]=t*q,s[a+2]=U*q,s[a+3]=b,s[a+4]=t,s[a+5]=U,s[a+6]=o/m,s[a+7]=y/Q,a+=W,y!=Q-1&&(e[w++]=v+(m+1),e[w++]=v,e[w++]=v+1,e[w++]=v+m,e[w++]=v,e[w++]=v+(m+1),v++);}
return _._createMesh(F,s,e);};}(),function(){function q(){}
return S(q,"laya.d3.core.render.PostProcessEffect"),q.prototype.render=function(q){},q;}()),Yq=function(){function B(){}
return S(B,"laya.d3.animation.AnimationClipParser04"),B.READ_DATA=function(){B._DATA.offset=B._reader.getUint32(),B._DATA.size=B._reader.getUint32();},B.READ_BLOCK=function(){for(var q=B._BLOCK.count=B._reader.getUint16(),Q=B._BLOCK.blockStarts=[],m=B._BLOCK.blockLengths=[],a=0;a<q;a++)Q.push(B._reader.getUint32()),m.push(B._reader.getUint32());},B.READ_STRINGS=function(){var q=B._reader.getUint32(),Q=B._reader.getUint16(),m=B._reader.pos;B._reader.pos=q+B._DATA.offset;for(var a=0;a<Q;a++)B._strings[a]=B._reader.readUTFString();B._reader.pos=m;},B.parse=function(q,Q,m){B._animationClip=q,B._reader=Q,B._version=m,B.READ_DATA(),B.READ_BLOCK(),B.READ_STRINGS();for(var a=0,w=B._BLOCK.count;a<w;a++){var e=Q.getUint16(),F=B._strings[e],W=B["READ_"+F];if(null==W)throw new Error("model file err,no this function:"+e+" "+F);W.call(null);}
B._version=null,B._reader=null,B._animationClip=null;},B.READ_ANIMATIONS=function(){var q,Q=0,m=0,a=B._reader,w=(a.__getBuffer(),[]),e=a.getUint16();for(w.length=e,Q=0;Q<e;Q++)w[Q]=a.getFloat32();var F=B._animationClip;F.name=B._strings[a.getUint16()];var W=F._duration=a.getFloat32();F.islooping=!!a.getByte(),F._frameRate=a.getInt16();var s=a.getInt16(),D=F._nodes;D.count=s;var d=F._nodesMap={},v=F._nodesDic={};for(Q=0;Q<s;Q++){q=new OQ(),D.setNodeByIndex(Q,q),q._indexInList=Q;var y=q.type=a.getUint8(),S=a.getUint16();for(q._setOwnerPathCount(S),m=0;m<S;m++)q._setOwnerPathByIndex(m,B._strings[a.getUint16()]);var t=q._joinOwnerPath("/"),o=d[t];o||(d[t]=o=[]),o.push(q),q.propertyOwner=B._strings[a.getUint16()];var b=a.getUint16();for(q._setPropertyCount(b),m=0;m<b;m++)q._setPropertyByIndex(m,B._strings[a.getUint16()]);var U=t+"."+q.propertyOwner+"."+q._joinProperty(".");(v[U]=q).fullPath=U;var J=a.getUint16();q._setKeyframeCount(J);switch(y){case 0:break;case 1:case 3:case 4:q.data=M.supportWebGLPlusAnimation?new L():new _q();break;case 2:q.data=M.supportWebGLPlusAnimation?new x():new eq();break;default:throw"AnimationClipParser04:unknown type.";}
switch(B._version){case"LAYAANIMATION:04":for(m=0;m<J;m++)switch(y){case 0:var V=new bm();q._setKeyframeByIndex(m,V),V.time=w[a.getUint16()],V.inTangent=a.getFloat32(),V.outTangent=a.getFloat32(),V.value=a.getFloat32();break;case 1:case 3:case 4:var n=new cm();if(q._setKeyframeByIndex(m,n),n.time=w[a.getUint16()],M.supportWebGLPlusAnimation){for(var O=n.data=new Float32Array(9),C=0;C<3;C++)O[C]=a.getFloat32();for(C=0;C<3;C++)O[3+C]=a.getFloat32();for(C=0;C<3;C++)O[6+C]=a.getFloat32();}else{var l=n.inTangent,u=n.outTangent,f=n.value;l.x=a.getFloat32(),l.y=a.getFloat32(),l.z=a.getFloat32(),u.x=a.getFloat32(),u.y=a.getFloat32(),u.z=a.getFloat32(),f.x=a.getFloat32(),f.y=a.getFloat32(),f.z=a.getFloat32();}
break;case 2:var p=new Am();if(q._setKeyframeByIndex(m,p),p.time=w[a.getUint16()],M.supportWebGLPlusAnimation){for(O=p.data=new Float32Array(12),C=0;C<4;C++)O[C]=a.getFloat32();for(C=0;C<4;C++)O[4+C]=a.getFloat32();for(C=0;C<4;C++)O[8+C]=a.getFloat32();}else{var T=p.inTangent,c=p.outTangent,r=p.value;T.x=a.getFloat32(),T.y=a.getFloat32(),T.z=a.getFloat32(),T.w=a.getFloat32(),c.x=a.getFloat32(),c.y=a.getFloat32(),c.z=a.getFloat32(),c.w=a.getFloat32(),r.x=a.getFloat32(),r.y=a.getFloat32(),r.z=a.getFloat32(),r.w=a.getFloat32();}
break;default:throw"AnimationClipParser04:unknown type.";}
break;case"LAYAANIMATION:COMPRESSION_04":for(m=0;m<J;m++)switch(y){case 0:V=new bm(),q._setKeyframeByIndex(m,V),V.time=w[a.getUint16()],V.inTangent=nq.convertToNumber(a.getUint16()),V.outTangent=nq.convertToNumber(a.getUint16()),V.value=nq.convertToNumber(a.getUint16());break;case 1:case 3:case 4:if(n=new cm(),q._setKeyframeByIndex(m,n),n.time=w[a.getUint16()],M.supportWebGLPlusAnimation){for(O=n.data=new Float32Array(9),C=0;C<3;C++)O[C]=nq.convertToNumber(a.getUint16());for(C=0;C<3;C++)O[3+C]=nq.convertToNumber(a.getUint16());for(C=0;C<3;C++)O[6+C]=nq.convertToNumber(a.getUint16());}else l=n.inTangent,u=n.outTangent,f=n.value,l.x=nq.convertToNumber(a.getUint16()),l.y=nq.convertToNumber(a.getUint16()),l.z=nq.convertToNumber(a.getUint16()),u.x=nq.convertToNumber(a.getUint16()),u.y=nq.convertToNumber(a.getUint16()),u.z=nq.convertToNumber(a.getUint16()),f.x=nq.convertToNumber(a.getUint16()),f.y=nq.convertToNumber(a.getUint16()),f.z=nq.convertToNumber(a.getUint16());break;case 2:if(p=new Am(),q._setKeyframeByIndex(m,p),p.time=w[a.getUint16()],M.supportWebGLPlusAnimation){for(O=p.data=new Float32Array(12),C=0;C<4;C++)O[C]=nq.convertToNumber(a.getUint16());for(C=0;C<4;C++)O[4+C]=nq.convertToNumber(a.getUint16());for(C=0;C<4;C++)O[8+C]=nq.convertToNumber(a.getUint16());}else T=p.inTangent,c=p.outTangent,r=p.value,T.x=nq.convertToNumber(a.getUint16()),T.y=nq.convertToNumber(a.getUint16()),T.z=nq.convertToNumber(a.getUint16()),T.w=nq.convertToNumber(a.getUint16()),c.x=nq.convertToNumber(a.getUint16()),c.y=nq.convertToNumber(a.getUint16()),c.z=nq.convertToNumber(a.getUint16()),c.w=nq.convertToNumber(a.getUint16()),r.x=nq.convertToNumber(a.getUint16()),r.y=nq.convertToNumber(a.getUint16()),r.z=nq.convertToNumber(a.getUint16()),r.w=nq.convertToNumber(a.getUint16());break;default:throw"AnimationClipParser04:unknown type.";}}}
var _=a.getUint16();for(Q=0;Q<_;Q++){var Z,A=new aQ();A.time=Math.min(W,a.getFloat32()),A.eventName=B._strings[a.getUint16()];var E=a.getUint16();for(0<E&&(A.params=Z=[]),m=0;m<E;m++){switch(a.getByte()){case 0:Z.push(!!a.getByte());break;case 1:Z.push(a.getInt32());break;case 2:Z.push(a.getFloat32());break;case 3:Z.push(B._strings[a.getUint16()]);break;default:throw new Error("unknown type.");}}
F.addEvent(A);}},B._animationClip=null,B._reader=null,B._strings=[],B._version=null,y(B,["_BLOCK",function(){return this._BLOCK={count:0};},"_DATA",function(){return this._DATA={offset:0,size:0};}]),B;}(),xq=function(){function B(){}
return S(B,"laya.d3.animation.AnimationClipParser03"),B.READ_DATA=function(){B._DATA.offset=B._reader.getUint32(),B._DATA.size=B._reader.getUint32();},B.READ_BLOCK=function(){for(var q=B._BLOCK.count=B._reader.getUint16(),Q=B._BLOCK.blockStarts=[],m=B._BLOCK.blockLengths=[],a=0;a<q;a++)Q.push(B._reader.getUint32()),m.push(B._reader.getUint32());},B.READ_STRINGS=function(){var q=B._reader.getUint32(),Q=B._reader.getUint16(),m=B._reader.pos;B._reader.pos=q+B._DATA.offset;for(var a=0;a<Q;a++)B._strings[a]=B._reader.readUTFString();B._reader.pos=m;},B.parse=function(q,Q){B._animationClip=q;(B._reader=Q).__getBuffer();B.READ_DATA(),B.READ_BLOCK(),B.READ_STRINGS();for(var m=0,a=B._BLOCK.count;m<a;m++){var w=Q.getUint16(),e=B._strings[w],F=B["READ_"+e];if(null==F)throw new Error("model file err,no this function:"+w+" "+e);F.call(null);}},B.READ_ANIMATIONS=function(){var q,Q=0,m=0,a=B._reader,w=(a.__getBuffer(),[]),e=a.getUint16();for(w.length=e,Q=0;Q<e;Q++)w[Q]=a.getFloat32();var F=B._animationClip;F.name=B._strings[a.getUint16()];var W=F._duration=a.getFloat32();F.islooping=!!a.getByte(),F._frameRate=a.getInt16();var s=a.getInt16(),D=F._nodes;D.count=s;var d=F._nodesMap={},v=F._nodesDic={};for(Q=0;Q<s;Q++){q=new OQ(),D.setNodeByIndex(Q,q),q._indexInList=Q;var y=q.type=a.getUint8(),S=a.getUint16();for(q._setOwnerPathCount(S),m=0;m<S;m++)q._setOwnerPathByIndex(m,B._strings[a.getUint16()]);var t=q._joinOwnerPath("/"),o=d[t];o||(d[t]=o=[]),o.push(q),q.propertyOwner=B._strings[a.getUint16()];var b=a.getUint16();for(q._setPropertyCount(b),m=0;m<b;m++)q._setPropertyByIndex(m,B._strings[a.getUint16()]);var U=t+"."+q.propertyOwner+"."+q._joinProperty(".");(v[U]=q).fullPath=U;var J=a.getUint16();q._setKeyframeCount(J);switch(y){case 0:break;case 1:case 3:case 4:q.data=M.supportWebGLPlusAnimation?new L():new _q();break;case 2:q.data=M.supportWebGLPlusAnimation?new x():new eq();break;default:throw"AnimationClipParser03:unknown type.";}
for(m=0;m<J;m++)switch(y){case 0:var V=new bm();q._setKeyframeByIndex(m,V),V.time=w[a.getUint16()],V.inTangent=a.getFloat32(),V.outTangent=a.getFloat32(),V.value=a.getFloat32();break;case 1:case 3:case 4:var n=new cm();if(q._setKeyframeByIndex(m,n),n.time=w[a.getUint16()],M.supportWebGLPlusAnimation){for(var O=n.data=new Float32Array(9),C=0;C<3;C++)O[C]=a.getFloat32();for(C=0;C<3;C++)O[3+C]=a.getFloat32();for(C=0;C<3;C++)O[6+C]=a.getFloat32();}else{var l=n.inTangent,u=n.outTangent,f=n.value;l.x=a.getFloat32(),l.y=a.getFloat32(),l.z=a.getFloat32(),u.x=a.getFloat32(),u.y=a.getFloat32(),u.z=a.getFloat32(),f.x=a.getFloat32(),f.y=a.getFloat32(),f.z=a.getFloat32();}
break;case 2:var p=new Am();if(q._setKeyframeByIndex(m,p),p.time=w[a.getUint16()],M.supportWebGLPlusAnimation){for(O=p.data=new Float32Array(12),C=0;C<4;C++)O[C]=a.getFloat32();for(C=0;C<4;C++)O[4+C]=a.getFloat32();for(C=0;C<4;C++)O[8+C]=a.getFloat32();}else{var T=p.inTangent,c=p.outTangent,r=p.value;T.x=a.getFloat32(),T.y=a.getFloat32(),T.z=a.getFloat32(),T.w=a.getFloat32(),c.x=a.getFloat32(),c.y=a.getFloat32(),c.z=a.getFloat32(),c.w=a.getFloat32(),r.x=a.getFloat32(),r.y=a.getFloat32(),r.z=a.getFloat32(),r.w=a.getFloat32();}
break;default:throw"AnimationClipParser03:unknown type.";}}
var _=a.getUint16();for(Q=0;Q<_;Q++){var Z,A=new aQ();A.time=Math.min(W,a.getFloat32()),A.eventName=B._strings[a.getUint16()];var E=a.getUint16();for(0<E&&(A.params=Z=[]),m=0;m<E;m++){switch(a.getByte()){case 0:Z.push(!!a.getByte());break;case 1:Z.push(a.getInt32());break;case 2:Z.push(a.getFloat32());break;case 3:Z.push(B._strings[a.getUint16()]);break;default:throw new Error("unknown type.");}}
F.addEvent(A);}},B._animationClip=null,B._reader=null,B._strings=[],y(B,["_BLOCK",function(){return this._BLOCK={count:0};},"_DATA",function(){return this._DATA={offset:0,size:0};}]),B;}(),Lq=function(){function q(){this.value=0;}
S(q,"laya.d3.shader.DefineDatas");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.add=function(q){this.value|=q;},Q.remove=function(q){this.value&=~q;},Q.has=function(q){return 0<(this.value&q);},Q.cloneTo=function(q){q.value=this.value;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q;}(),Gq=function(){function q(q,Q,m){this.offset=0,this.elementFormat=null,this.elementUsage=0,this.offset=q,this.elementFormat=Q,this.elementUsage=m;}
return S(q,"laya.d3.graphics.VertexElement"),q;}(),Kq=function(){function M(q,Q,m,a){this._datas=null,this._w=0,this._h=0,this._minHeight=NaN,this._maxHeight=NaN,this._datas=[],this._w=q,this._h=Q,this._minHeight=m,this._maxHeight=a;}
S(M,"laya.d3.core.HeightMap");var q=M.prototype;return q._inBounds=function(q,Q){return 0<=q&&q<this._h&&0<=Q&&Q<this._w;},q.getHeight=function(q,Q){return this._inBounds(q,Q)?this._datas[q][Q]:NaN;},d(0,q,"width",function(){return this._w;}),d(0,q,"height",function(){return this._h;}),d(0,q,"maxHeight",function(){return this._maxHeight;}),d(0,q,"minHeight",function(){return this._minHeight;}),M.creatFromMesh=function(q,Q,m,a){for(var w=[],e=[],F=q.subMeshCount,W=0;W<F;W++){for(var s=q._getSubMesh(W),D=s._vertexBuffer,d=D.getData(),v=[],y=0;y<d.length;y+=D.vertexDeclaration.vertexStride/4){var S=new _q(d[y+0],d[y+1],d[y+2]);v.push(S);}
w.push(v);var t=s._indexBuffer;e.push(t.getData());}
var o=q.bounds,b=o.getMin().x,U=o.getMin().z,J=o.getMax().x,V=o.getMax().z,n=o.getMin().y,O=o.getMax().y,C=J-b,l=V-U,u=a.x=C/(Q-1),f=a.y=l/(m-1),p=new M(Q,m,n,O),T=M._tempRay,c=T.direction;c.x=0,c.y=-1,c.z=0;var r=O+.1;T.origin.y=r;for(var _=0;_<m;_++){var Z=U+_*f;p._datas[_]=[];for(var A=0;A<Q;A++){var E=b+A*u,B=T.origin;B.x=E,B.z=Z;var N=M._getPosition(T,w,e);p._datas[_][A]=N===Number.MAX_VALUE?NaN:r-N;}}
return p;},M.createFromImage=function(q,Q,m){for(var a=q.width,w=q.height,e=new M(a,w,Q,m),F=(m-Q)/254,W=q.getPixels(),s=0,D=0;D<w;D++)
for(var d=e._datas[D]=[],v=0;v<a;v++){var y=W[s++],S=W[s++],t=W[s++],o=W[s++];d[v]=255==y&&255==S&&255==t&&255==o?NaN:(y+S+t)/3*F+Q;}
return e;},M._getPosition=function(q,Q,m){for(var a=Number.MAX_VALUE,w=0;w<Q.length;w++)
for(var e=Q[w],F=m[w],W=0;W<F.length;W+=3){var s=e[F[W+0]],D=e[F[W+1]],d=e[F[W+2]],v=vQ.rayIntersectsTriangle(q,s,D,d);!isNaN(v)&&v<a&&(a=v);}
return a;},y(M,["_tempRay",function(){return this._tempRay=new i(new _q(),new _q());}]),M;}(),kq=function(){function D(){}
return S(D,"laya.d3.shader.ShaderInit3D"),D.__init__=function(){var q,Q;(D._rangeAttenTex=Rq._buildTexture2D(1024,1,2,Cq.lightAttenTexture)).wrapModeU=1,D._rangeAttenTex.wrapModeV=1,D._rangeAttenTex.lock=!0,Bq.SHADERDEFINE_HIGHPRECISION=Bq.registerPublicDefine("HIGHPRECISION"),gm.SHADERDEFINE_FOG=Bq.registerPublicDefine("FOG"),gm.SHADERDEFINE_DIRECTIONLIGHT=Bq.registerPublicDefine("DIRECTIONLIGHT"),gm.SHADERDEFINE_POINTLIGHT=Bq.registerPublicDefine("POINTLIGHT"),gm.SHADERDEFINE_SPOTLIGHT=Bq.registerPublicDefine("SPOTLIGHT"),gm.SHADERDEFINE_CAST_SHADOW=Bq.registerPublicDefine("CASTSHADOW"),gm.SHADERDEFINE_SHADOW_PSSM1=Bq.registerPublicDefine("SHADOWMAP_PSSM1"),gm.SHADERDEFINE_SHADOW_PSSM2=Bq.registerPublicDefine("SHADOWMAP_PSSM2"),gm.SHADERDEFINE_SHADOW_PSSM3=Bq.registerPublicDefine("SHADOWMAP_PSSM3"),gm.SHADERDEFINE_SHADOW_PCF_NO=Bq.registerPublicDefine("SHADOWMAP_PCF_NO"),gm.SHADERDEFINE_SHADOW_PCF1=Bq.registerPublicDefine("SHADOWMAP_PCF1"),gm.SHADERDEFINE_SHADOW_PCF2=Bq.registerPublicDefine("SHADOWMAP_PCF2"),gm.SHADERDEFINE_SHADOW_PCF3=Bq.registerPublicDefine("SHADOWMAP_PCF3"),gm.SHADERDEFINE_REFLECTMAP=Bq.registerPublicDefine("REFLECTMAP"),Bq.addInclude("Lighting.glsl","\nstruct DirectionLight {\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nstruct PointLight {\n\tvec3 Color;\n\tvec3 Position;\n\tfloat Range;\n};\n\nstruct SpotLight {\n\tvec3 Color;\n\tvec3 Position;\n\tvec3 Direction;\n\tfloat Spot;\n\tfloat Range;\n};\n\n// Laya中使用衰减纹理\nfloat LayaAttenuation(in vec3 L,in float invLightRadius) {\n\tfloat fRatio = clamp(length(L) * invLightRadius,0.0,1.0);\n\tfRatio *= fRatio;\n\treturn 1.0 / (1.0 + 25.0 * fRatio)* clamp(4.0*(1.0 - fRatio),0.0,1.0); //fade to black as if 4 pixel texture\n}\n\n// Same as Just Cause 2 and Crysis 2 (you can read GPU Pro 1 book for more information)\nfloat BasicAttenuation(in vec3 L,in float invLightRadius) {\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = clamp(1.0 - dot(distance, distance),0.0,1.0); // Equals float attenuation = saturate(1.0f - dot(L, L) / (lightRadius *  lightRadius));\n\treturn attenuation * attenuation;\n}\n\n// Inspired on http://fools.slindev.com/viewtopic.php?f=11&t=21&view=unread#unread\nfloat NaturalAttenuation(in vec3 L,in float invLightRadius) {\n\tfloat attenuationFactor = 30.0;\n\tvec3 distance = L * invLightRadius;\n\tfloat attenuation = dot(distance, distance); // Equals float attenuation = dot(L, L) / (lightRadius *  lightRadius);\n\tattenuation = 1.0 / (attenuation * attenuationFactor + 1.0);\n\t// Second we move down the function therewith it reaches zero at abscissa 1:\n\tattenuationFactor = 1.0 / (attenuationFactor + 1.0); //attenuationFactor contains now the value we have to subtract\n\tattenuation = max(attenuation - attenuationFactor, 0.0); // The max fixes a bug.\n\t// Finally we expand the equation along the y-axis so that it starts with a function value of 1 again.\n\tattenuation /= 1.0 - attenuationFactor;\n\treturn attenuation;\n}\n\nvoid LayaAirBlinnPhongLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir,in vec3 lightColor, in vec3 lightVec,out vec3 diffuseColor,out vec3 specularColor) {\n\tmediump vec3 h = normalize(viewDir-lightVec);\n\tlowp float ln = max (0.0, dot (-lightVec,normal));\n\tfloat nh = max (0.0, dot (h,normal));\n\tdiffuseColor=lightColor * ln;\n\tspecularColor=lightColor *specColor*pow (nh, specColorIntensity*128.0) * gloss;\n}\n\nvoid LayaAirBlinnPhongDiectionLight (in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in DirectionLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec=normalize(light.Direction);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec,diffuseColor,specularColor);\n}\n\nvoid LayaAirBlinnPhongPointLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in PointLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range )\n\t//\treturn;\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,lightVec/length(lightVec),diffuseColor,specularColor);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.Range);\n\tdiffuseColor *= attenuate;\n\tspecularColor*= attenuate;\n}\n\nvoid LayaAirBlinnPhongSpotLight (in vec3 pos,in vec3 specColor,in float specColorIntensity,in vec3 normal,in vec3 gloss, in vec3 viewDir, in SpotLight light,out vec3 diffuseColor,out vec3 specularColor) {\n\tvec3 lightVec =  pos-light.Position;\n\t//if( length(lightVec) > light.Range)\n\t//\treturn;\n\n\tvec3 normalLightVec=lightVec/length(lightVec);\n\tLayaAirBlinnPhongLight(specColor,specColorIntensity,normal,gloss,viewDir,light.Color,normalLightVec,diffuseColor,specularColor);\n\tvec2 cosAngles=cos(vec2(light.Spot,light.Spot*0.5)*0.5);//ConeAttenuation\n\tfloat dl=dot(normalize(light.Direction),normalLightVec);\n\tdl*=smoothstep(cosAngles[0],cosAngles[1],dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.Range)*dl;\n\tdiffuseColor *=attenuate;\n\tspecularColor *=attenuate;\n}\n\nvec3 NormalSampleToWorldSpace(vec3 normalMapSample, vec3 unitNormal, vec3 tangent,vec3 binormal) {\n\tvec3 normalT =vec3(2.0*normalMapSample.x - 1.0,1.0-2.0*normalMapSample.y,2.0*normalMapSample.z - 1.0);\n\n\t// Build orthonormal basis.\n\tvec3 N = normalize(unitNormal);\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN*normalT;\n\n\treturn bumpedNormal;\n}\n\nvec3 NormalSampleToWorldSpace1(vec4 normalMapSample, vec3 tangent, vec3 binormal, vec3 unitNormal) {\n\tvec3 normalT;\n\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\n\tvec3 T = normalize(tangent);\n\tvec3 B = normalize(binormal);\n\tvec3 N = normalize(unitNormal);\n\tmat3 TBN = mat3(T, B, N);\n\n\t// Transform from tangent space to world space.\n\tvec3 bumpedNormal = TBN * normalize(normalT);\n\n\treturn bumpedNormal;\n}\n\nvec3 DecodeLightmap(vec4 color) {\n\treturn color.rgb*color.a*5.0;\n}\n\nvec2 TransformUV(vec2 texcoord,vec4 tilingOffset) {\n\tvec2 transTexcoord=vec2(texcoord.x,texcoord.y-1.0)*tilingOffset.xy+vec2(tilingOffset.z,-tilingOffset.w);\n\ttransTexcoord.y+=1.0;\n\treturn transTexcoord;\n}\n\nvec4 remapGLPositionZ(vec4 position) {\n\tposition.z=position.z * 2.0 - position.w;\n\treturn position;\n}\n\nmat3 inverse(mat3 m) {\n  float a00 = m[0][0], a01 = m[0][1], a02 = m[0][2];\n  float a10 = m[1][0], a11 = m[1][1], a12 = m[1][2];\n  float a20 = m[2][0], a21 = m[2][1], a22 = m[2][2];\n\n  float b01 = a22 * a11 - a12 * a21;\n  float b11 = -a22 * a10 + a12 * a20;\n  float b21 = a21 * a10 - a11 * a20;\n\n  float det = a00 * b01 + a01 * b11 + a02 * b21;\n\n  return mat3(b01, (-a22 * a01 + a02 * a21), (a12 * a01 - a02 * a11),\n              b11, (a22 * a00 - a02 * a20), (-a12 * a00 + a02 * a10),\n              b21, (-a21 * a00 + a01 * a20), (a11 * a00 - a01 * a10)) / det;\n}\n\n"),Bq.addInclude("ShadowHelper.glsl","uniform sampler2D u_shadowMap1;\nuniform sampler2D u_shadowMap2;\nuniform sampler2D u_shadowMap3;\nuniform vec2\t  u_shadowPCFoffset;\nuniform vec4     u_shadowPSSMDistance;\nvec4 packDepth(const in float depth)\n{\n\tconst vec4 bitShift = vec4(256.0*256.0*256.0, 256.0*256.0, 256.0, 1.0);\n\tconst vec4 bitMask\t= vec4(0.0, 1.0/256.0, 1.0/256.0, 1.0/256.0);\n\tvec4 res = mod(depth*bitShift*vec4(255), vec4(256))/vec4(255);\n\tres -= res.xxyz * bitMask;\n\treturn res;\n}\nfloat unpackDepth(const in vec4 rgbaDepth)\n{\n\tconst vec4 bitShift = vec4(1.0/(256.0*256.0*256.0), 1.0/(256.0*256.0), 1.0/256.0, 1.0);\n\tfloat depth = dot(rgbaDepth, bitShift);\n\treturn depth;\n}\nfloat tex2DPCF( sampler2D shadowMap,vec2 texcoord,vec2 invsize,float zRef )\n{\n\tvec2 texelpos =texcoord / invsize;\n\tvec2 lerps = fract( texelpos );\n\tfloat sourcevals[4];\n\tsourcevals[0] = float( unpackDepth(texture2D(shadowMap,texcoord)) > zRef );\n\tsourcevals[1] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x,0))) > zRef );\n\tsourcevals[2] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(0,invsize.y))) > zRef );\n\tsourcevals[3] = float( unpackDepth(texture2D(shadowMap,texcoord + vec2(invsize.x, invsize.y) )) > zRef );\n\treturn mix( mix(sourcevals[0],sourcevals[2],lerps.y),mix(sourcevals[1],sourcevals[3],lerps.y),lerps.x );\n}\nfloat getShadowPSSM3( sampler2D shadowMap1,sampler2D shadowMap2,sampler2D shadowMap3,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\tnPSNum += int(posViewZ>pssmDistance.z);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\telse if( nPSNum == 2 )\n\t{\n\t\tlightVP = lightShadowVP[3];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t} \n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap3,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 2 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap3,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM2( sampler2D shadowMap1,sampler2D shadowMap2,mat4 lightShadowVP[4],vec4 pssmDistance,vec2 shadowPCFOffset,vec3 worldPos,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tint nPSNum = int(posViewZ>pssmDistance.x);\n\tnPSNum += int(posViewZ>pssmDistance.y);\n\t//真SB,webgl不支持在PS中直接访问数组\n\tmat4 lightVP;\n\tif( nPSNum == 0 )\n\t{\n\t\tlightVP = lightShadowVP[1];\n\t}\n\telse if( nPSNum == 1 )\n\t{\n\t\tlightVP = lightShadowVP[2];\n\t}\n\tvec4 vLightMVPPos = lightVP * vec4(worldPos,1.0);\n\t//为了效率，在CPU计算/2.0 + 0.5\n\t//vec3 vText = (vLightMVPPos.xyz / vLightMVPPos.w)/2.0 + 0.5;\n\tvec3 vText = vLightMVPPos.xyz / vLightMVPPos.w;\n\tfloat fMyZ = vText.z - zBias;\n\t/*\n\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\tbool bInFrustum = all( bInFrustumVec );\n\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\tbool bFrustumTest = all( bFrustumTestVec );\n\tif ( bFrustumTest ) \n\t*/\n\tif( fMyZ <= 1.0 )\n\t{\n\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,\tfMyZ );\n\t\t\tvalue = value/4.0;\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF2\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap2,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tvec4 color = texture2D( shadowMap2,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n\t\t}\n#endif\n#ifdef SHADOWMAP_PCF_NO\n\t\tvec4 color;\n\t\tif ( nPSNum == 0 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap1,vText.xy );\n\t\t}\n\t\telse if( nPSNum == 1 )\n\t\t{\n\t\t\tcolor = texture2D( shadowMap2,vText.xy );\n\t\t}\n\t\tzdepth = unpackDepth(color);\n\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t}\n\treturn value;\n}\nfloat getShadowPSSM1( sampler2D shadowMap1,vec4 lightMVPPos,vec4 pssmDistance,vec2 shadowPCFOffset,float posViewZ,float zBias )\n{\n\tfloat value = 1.0;\n\tif( posViewZ < pssmDistance.x )\n\t{\n\t\tvec3 vText = lightMVPPos.xyz / lightMVPPos.w;\n\t\tfloat fMyZ = vText.z - zBias;\n\t\t/*\n\t\tbvec4 bInFrustumVec = bvec4 ( vText.x >= 0.0, vText.x <= 1.0, vText.y >= 0.0, vText.y <= 1.0 );\n\t\tbool bInFrustum = all( bInFrustumVec );\n\t\tbvec2 bFrustumTestVec = bvec2( bInFrustum, fMyZ <= 1.0 );\n\t\tbool bFrustumTest = all( bFrustumTestVec );\n\t\t*/\n\t\tif ( fMyZ <= 1.0 ) \n\t\t{\n\t\t\tfloat zdepth=0.0;\n#ifdef SHADOWMAP_PCF3\n\t\t\tvalue =  tex2DPCF( shadowMap1, vText.xy,shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.xy),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(shadowPCFOffset.x,0),shadowPCFOffset,fMyZ );\n\t\t\tvalue += tex2DPCF( shadowMap1, vText.xy+vec2(0,shadowPCFOffset.y),shadowPCFOffset,fMyZ );\n\t\t\tvalue = value/4.0;\n#endif\n#ifdef SHADOWMAP_PCF2\t\t\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF1\n\t\t\tvalue = tex2DPCF( shadowMap1,vText.xy,shadowPCFOffset,fMyZ);\n#endif\n#ifdef SHADOWMAP_PCF_NO\t\t\n\t\t\tvec4 color = texture2D( shadowMap1,vText.xy );\n\t\t\tzdepth = unpackDepth(color);\n\t\t\tvalue = float(fMyZ < zdepth);\n#endif\n\t\t}\n\t}\n\treturn value;\n}"),Bq.addInclude("BRDF.glsl","struct LayaGI\n{\n\tvec3 diffuse;\n\tvec3 specular;\n};\n\nvec4 LayaAirBRDF(in vec3 diffuseColor, in vec3 specularColor, in float oneMinusReflectivity, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\n{\n\tfloat perceptualRoughness = SmoothnessToPerceptualRoughness(smoothness);\n\tvec3 halfDir = SafeNormalize(viewDir - lightDir);\n\t\n\tfloat nv = abs(dot(normal, viewDir));\n\t\n\tfloat nl = clamp(dot(normal,   -lightDir),  0.0, 1.0);\n\tfloat nh = clamp(dot(normal,     halfDir),  0.0, 1.0);\n\tfloat lv = clamp(dot(lightDir,   viewDir),  0.0, 1.0);\n\tfloat lh = clamp(dot(lightDir,  -halfDir),  0.0, 1.0);\n\t\n\tfloat diffuseTerm = DisneyDiffuse(nv, nl, lh, perceptualRoughness) * nl;\n\t\n\tfloat roughness = PerceptualRoughnessToRoughness(perceptualRoughness);\n\t\n\t//#if UNITY_BRDF_GGX\n\tfloat V = SmithJointGGXVisibilityTerm(nl, nv, roughness);\n\tfloat D = GGXTerm(nh, roughness);\n\t\n\tfloat specularTerm = V * D * PI;\n\t\n\tspecularTerm = sqrt(max(0.0001, specularTerm));\n\tspecularTerm = max(0.0, specularTerm * nl);\n\t\n\tfloat surfaceReduction = 1.0 - 0.28 * roughness * perceptualRoughness;\n\tfloat grazingTerm = clamp(smoothness + (1.0 - oneMinusReflectivity), 0.0, 1.0);\n\t\n\tvec4 color;\n\tcolor.rgb = diffuseColor * (gi.diffuse + lightColor * diffuseTerm) \n\t\t\t  + specularTerm * lightColor * FresnelTerm (specularColor, lh)\n\t\t\t  + surfaceReduction * gi.specular * FresnelLerp(specularColor, vec3(grazingTerm), nv);\n\t\n\treturn color;\n}"),Bq.addInclude("PBRUtils.glsl","struct DirectionLight\n{\n\tvec3 Color;\n\tvec3 Direction;\n};\n\nstruct PointLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tfloat Range;\n};\n\nstruct SpotLight\n{\n\tvec3 Color;\n\tvec3 Position;\n\tvec3 Direction;\n\tfloat SpotAngle;\n\tfloat Range;\n};\n\nvec3 UnpackScaleNormal(in vec2 uv0)\n{\n\t#ifdef NORMALTEXTURE\n\t\tvec3 normalT;\n\t\tvec4 normalMapSample = texture2D(u_NormalTexture, uv0);\n\t\tnormalT.x = 2.0 * normalMapSample.x - 1.0;\n\t\tnormalT.y = 1.0 - 2.0 * normalMapSample.y;\n\t\tnormalT.xy *= u_normalScale;\n\t\tnormalT.z = sqrt(1.0 - clamp(dot(normalT.xy, normalT.xy), 0.0, 1.0));\n\t\t\n\t\tvec3 T = normalize(v_Tangent);\n\t\tvec3 B = normalize(v_Binormal);\n\t\tvec3 N = normalize(v_Normal);\n\t\tmat3 TBN = mat3(T, B, N);\n\t\t\n\t\tvec3 bumpedNormal = TBN * normalize(normalT);\n\t\treturn bumpedNormal;\n\t#else\n\t\treturn normalize(v_Normal);\n\t#endif\n}\n\nvec4 DielectricSpecularColor = vec4(0.220916301, 0.220916301, 0.220916301, 1.0 - 0.220916301);\n\nfloat PI = 3.14159265359;\n\nvec3 FresnelTerm (in vec3 F0, in float cosA)\n{\n\treturn F0 + (vec3(1.0) - F0) * pow(1.0 - cosA, 5.0);\n}\n\nvec3 FresnelLerp (in vec3 F0, in vec3 F90, float cosA)\n{\n    float t = pow(1.0 - cosA, 5.0);\n    return mix(F0, F90, t);\n}\n\nfloat PerceptualRoughnessToRoughness(in float perceptualRoughness)\n{\n\treturn perceptualRoughness * perceptualRoughness;\n}\n\nfloat PerceptualRoughnessToSpecularPower(in float perceptualRoughness)\n{\n\tfloat m = PerceptualRoughnessToRoughness(perceptualRoughness);\n\tfloat sq = max(0.0001, m * m);\n\tfloat n = (2.0 / sq) - 2.0;\n\tn = max(n, 0.0001);\n\treturn n;\n}\n\nfloat RoughnessToPerceptualRoughness(in float roughness)\n{\n\treturn sqrt(roughness);\n}\n\nfloat SmoothnessToRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness) * (1.0 - smoothness);\n}\n\nfloat SmoothnessToPerceptualRoughness(in float smoothness)\n{\n\treturn (1.0 - smoothness);\n}\n\nvec3 SafeNormalize(in vec3 inVec)\n{\n\tfloat dp3 = max(0.001,dot(inVec,inVec));\n\treturn inVec * (1.0 / sqrt(dp3));\n}\n\nfloat DisneyDiffuse(in float NdotV, in float NdotL, in float LdotH, in float perceptualRoughness)\n{\n\tfloat fd90 = 0.5 + 2.0 * LdotH * LdotH * perceptualRoughness;\n\tfloat lightScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotL,5.0));\n\tfloat viewScatter\t= (1.0 + (fd90 - 1.0) * pow(1.0 - NdotV,5.0));\n\n\treturn lightScatter * viewScatter;\n}\n\nfloat SmithJointGGXVisibilityTerm (float NdotL, float NdotV, float roughness)\n{\n\tfloat a = roughness;\n\tfloat lambdaV = NdotL * (NdotV * (1.0 - a) + a);\n\tfloat lambdaL = NdotV * (NdotL * (1.0 - a) + a);\n\n\treturn 0.5 / (lambdaV + lambdaL + 0.00001);\n}\n\nfloat GGXTerm (float NdotH, float roughness)\n{\n\tfloat a2 = roughness * roughness;\n\tfloat d = (NdotH * a2 - NdotH) * NdotH + 1.0;\n\treturn 0.31830988618 * a2 / (d * d + 0.0000001);\n}\n\nfloat OneMinusReflectivityFromMetallic(in float metallic)\n{\n\tfloat oneMinusDielectricSpec = DielectricSpecularColor.a;\n\treturn oneMinusDielectricSpec - metallic * oneMinusDielectricSpec;\n}\n\nfloat SpecularStrength(vec3 specular)\n{\n    //(SHADER_TARGET < 30)return specular.r; \n    return max (max (specular.r, specular.g), specular.b);\n}\n\nvec3 DiffuseAndSpecularFromMetallic(in vec3 diffuseColor, in float metallic, out vec3 specularColor, out float oneMinusReflectivity)\n{\n\tspecularColor = mix(DielectricSpecularColor.rgb, diffuseColor, metallic);\n\toneMinusReflectivity = OneMinusReflectivityFromMetallic(metallic);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec3 EnergyConservationBetweenDiffuseAndSpecular(in vec3 diffuseColor, in vec3 specularColor, out float oneMinusReflectivity)\n{\n\toneMinusReflectivity = 1.0 - SpecularStrength(specularColor);\n\treturn diffuseColor * oneMinusReflectivity;\n}\n\nvec4 Occlusion(in vec2 uv0){\n\t#ifdef OCCLUSIONTEXTURE\n\t\tvec4 occlusionTextureColor = texture2D(u_OcclusionTexture, uv0);\n\t\tfloat occ = occlusionTextureColor.g;\n\t\tfloat oneMinusT = 1.0 - u_occlusionStrength;\n\t\tfloat lerpOneTo = oneMinusT + occ * u_occlusionStrength;\n\t\treturn occlusionTextureColor * lerpOneTo;\n\t#else\n\t\treturn vec4(1.0);\n\t#endif\n}\n\nvec2 ParallaxOffset(in vec3 viewDir){\n\t#ifdef PARALLAXTEXTURE\n\t\tfloat h = texture2D(u_ParallaxTexture, v_Texcoord0).g;\n\t\th = h * u_parallaxScale - u_parallaxScale / 2.0;\n\t\tvec3 v = viewDir;\n\t\tv.z += 0.42;\n\t\tvec2 offset = h * (v.xy / v.z);\n\t\treturn v_Texcoord0 + offset;\n\t#else\n\t\treturn v_Texcoord0;\n\t#endif\n}\n\nvec3 ReflectCubeMap(in vec3 viewDir, in vec3 normal){\n\t#ifdef REFLECTMAP\n\t\tvec3 incident = -viewDir;\n\t\tvec3 reflectionVector = reflect(incident, normal);\n\t\tvec3 reflectionColor = textureCube(u_ReflectTexture, vec3(-reflectionVector.x, reflectionVector.yz)).rgb;\n\t\treturn reflectionColor * u_ReflectIntensity;\n\t#else\n\t\treturn vec3(0.0);\n\t#endif\n}\n\nfloat LayaAttenuation(in vec3 L, in float invLightRadius)\n{\n\tfloat fRatio = clamp(length(L) * invLightRadius, 0.0, 1.0);\n\tfRatio *= fRatio;\n\treturn 1.0 / (1.0 + 25.0 * fRatio) * clamp(4.0*(1.0 - fRatio), 0.0, 1.0); //fade to black as if 4 pixel texture\n}\n\nvec3 LayaPreMultiplyAlpha(vec3 diffColor, float alpha, float oneMinusReflectivity, out float outModifiedAlpha)\n{\n\t#ifdef ALPHAPREMULTIPLY\n\t\tdiffColor *= alpha;\n\t\toutModifiedAlpha = 1.0 - oneMinusReflectivity + alpha * oneMinusReflectivity;\n\t#else\n\t\toutModifiedAlpha = alpha;\n\t#endif\n\treturn diffColor;\n}\n\n"),Bq.addInclude("PBRStandardLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRStandardLight(in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\n{\n\tfloat oneMinusReflectivity;\n\tvec3 diffuseColor;\n\tvec3 specularColor;\n\tfloat alpha;\n\t\n\tdiffuseColor = DiffuseAndSpecularFromMetallic (albedoColor.rgb, metallic, specularColor, oneMinusReflectivity);\n\t\n\tdiffuseColor = LayaPreMultiplyAlpha(diffuseColor, albedoColor.a, oneMinusReflectivity, alpha);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\tcolor.a = alpha;\n\treturn color;\n}\n\nvec4 PBRStandardDiectionLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in LayaGI gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec4 PBRStandardPointLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in PointLight light, in vec3 pos, in LayaGI gi)\n{\n\tvec3 lightCoord = (u_PointLightMatrix * vec4(pos, 1.0)).xyz;\n\tfloat distance = dot(lightCoord, lightCoord);\n\tfloat attenuate = texture2D(u_RangeTexture, vec2(distance)).w;\n\tvec3 lightVec = normalize(pos - light.Position);\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n}\n\nvec4 PBRStandardSpotLight (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\n{\n\tvec3 lightVec =  pos - light.Position;\n\tvec3 normalLightVec = normalize(lightVec);\n\tvec2 cosAngles = cos(vec2(light.SpotAngle, light.SpotAngle*0.5) * 0.5);//ConeAttenuation\n\tfloat dl = dot(normalize(light.Direction), normalLightVec);\n\tdl *= smoothstep(cosAngles[0], cosAngles[1], dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.Range) * dl;\n\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n}\n\n//vec4 PBRStandardSpotLight1 (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\n//{\n//\tvec4 lightCoord = u_SpotLightMatrix * vec4(pos, 1.0);\n//\t\n//\tfloat distance = dot(lightCoord, lightCoord);\n//\tfloat attenuate = (lightCoord.z < 0.0) ? texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\n//\t//float attenuate = (lightCoord.z < 0.0) ? texture2D(u_AngleTexture, vec2(lightCoord.x / lightCoord.w + 0.5, lightCoord.y / lightCoord.w + 0.5)).r * texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\n//\t//vec2 _uv = vec2(pos.x * 180.0/(2.0 * pos.z) + 0.5, pos.y * 180.0/(2.0 * pos.z) + 0.5);\n//\tvec3 lightVec = normalize(pos - light.Position);\n//\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n//}\n\nvec2 MetallicGloss(in float albedoTextureAlpha, in vec2 uv0)\n{\n\tvec2 mg;\n\t\n\t#ifdef METALLICGLOSSTEXTURE\n\t\tvec4 metallicGlossTextureColor = texture2D(u_MetallicGlossTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tmg.r = metallicGlossTextureColor.r;\n\t\t\tmg.g = albedoTextureAlpha;\n\t\t#else\n\t\t    mg = metallicGlossTextureColor.ra;\n\t\t#endif\n\t\tmg.g *= u_smoothnessScale;\n\t#else\n\t\tmg.r = u_metallic;\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tmg.g = albedoTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tmg.g = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n\treturn mg;\n}\n\n'),Bq.addInclude("PBRSpecularLighting.glsl",'#include "PBRUtils.glsl"\n#include "BRDF.glsl"\n\nvec4 PBRSpecularLight(in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in vec3 lightDir, in vec3 lightColor, in LayaGI gi)\n{\n\tfloat oneMinusReflectivity;\n\tvec3 diffuseColor;\n\tfloat alpha;\n\t\n\tdiffuseColor = EnergyConservationBetweenDiffuseAndSpecular (albedoColor.rgb, specularColor, oneMinusReflectivity);\n\t\n\tdiffuseColor = LayaPreMultiplyAlpha(diffuseColor, albedoColor.a, oneMinusReflectivity, alpha);\n\t\n\tvec4 color = LayaAirBRDF(diffuseColor, specularColor, oneMinusReflectivity, smoothness, normal, viewDir, lightDir, lightColor, gi);\n\tcolor.a = alpha;\n\treturn color;\n}\n\nvec4 PBRSpecularDiectionLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in DirectionLight light, in LayaGI gi)\n{\n\tvec3 lightVec = normalize(light.Direction);\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi);\n}\n\nvec4 PBRSpecularPointLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in PointLight light, in vec3 pos, in LayaGI gi)\n{\n\tvec3 lightCoord = (u_PointLightMatrix * vec4(pos, 1.0)).xyz;\n\tfloat distance = dot(lightCoord, lightCoord);\n\tfloat attenuate = texture2D(u_RangeTexture, vec2(distance)).w;\n\tvec3 lightVec = normalize(pos - light.Position);\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n}\n\nvec4 PBRSpecularSpotLight (in vec4 albedoColor, in vec3 specularColor, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\n{\n\tvec3 lightVec =  pos - light.Position;\n\tvec3 normalLightVec = normalize(lightVec);\n\tvec2 cosAngles = cos(vec2(light.SpotAngle, light.SpotAngle*0.5) * 0.5);//ConeAttenuation\n\tfloat dl = dot(normalize(light.Direction), normalLightVec);\n\tdl *= smoothstep(cosAngles[0], cosAngles[1], dl);\n\tfloat attenuate = LayaAttenuation(lightVec, 1.0/light.Range) * dl;\n\treturn PBRSpecularLight(albedoColor, specularColor, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n}\n\n//vec4 PBRStandardSpotLight1 (in vec4 albedoColor, in float metallic, in float smoothness, in vec3 normal, in vec3 viewDir, in SpotLight light, in vec3 pos, in LayaGI gi)\n//{\n//\tvec4 lightCoord = u_SpotLightMatrix * vec4(pos, 1.0);\n//\t\n//\tfloat distance = dot(lightCoord, lightCoord);\n//\tfloat attenuate = (lightCoord.z < 0.0) ? texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\n//\t//float attenuate = (lightCoord.z < 0.0) ? texture2D(u_AngleTexture, vec2(lightCoord.x / lightCoord.w + 0.5, lightCoord.y / lightCoord.w + 0.5)).r * texture2D(u_RangeTexture, vec2(distance)).w : 0.0;\n//\t//vec2 _uv = vec2(pos.x * 180.0/(2.0 * pos.z) + 0.5, pos.y * 180.0/(2.0 * pos.z) + 0.5);\n//\tvec3 lightVec = normalize(pos - light.Position);\n//\treturn PBRStandardLight(albedoColor, metallic, smoothness, normal, viewDir, lightVec, light.Color, gi) * attenuate;\n//}\n\nvec4 SpecularGloss(float albedoTextureAlpha, in vec2 uv0)\n{\n    vec4 sg;\n\t\n\t#ifdef SPECULARTEXTURE\n\t\tvec4 specularTextureColor = texture2D(u_SpecularTexture, uv0);\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tsg.rgb = specularTextureColor.rgb;\n\t\t\tsg.a = albedoTextureAlpha;\n\t\t#else\n\t\t\tsg = specularTextureColor;\n\t\t#endif\n\t\tsg.a *= u_smoothnessScale;\n\t#else\n\t\tsg.rgb = u_SpecularColor.rgb;\n\t\t#ifdef SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA\n\t\t\tsg.a = albedoTextureAlpha * u_smoothnessScale;\n\t\t#else\n\t\t\tsg.a = u_smoothness;\n\t\t#endif\n\t#endif\n\t\n    return sg;\n}\n\n'),Bq.addInclude("Colors.glsl",'#include "StdLib.glsl";\n\n#define EPSILON 1.0e-4\n\n// Quadratic color thresholding\n// curve = (threshold - knee, knee * 2, 0.25 / knee)\nmediump vec4 quadraticThreshold(mediump vec4 color, mediump float threshold, mediump vec3 curve) {\n\t// Pixel brightness\n\tmediump float br = max3(color.r, color.g, color.b);\n\n\t// Under-threshold part: quadratic curve\n\tmediump float rq = clamp(br - curve.x, 0.0, curve.y);\n\trq = curve.z * rq * rq;\n\n\t// Combine and apply the brightness response curve.\n\tcolor *= max(rq, br - threshold) / max(br, EPSILON);\n\n\treturn color;\n}\n\n//\n// sRGB transfer functions\n// Fast path ref: http://chilliant.blogspot.com.au/2012/08/srgb-approximations-for-hlsl.html?m=1\n//\nmediump vec3 SRGBToLinear(mediump vec3 c) {\n\t#ifdef USE_VERY_FAST_SRGB\n\t\treturn c * c;\n\t#elif defined(USE_FAST_SRGB)\n\t\treturn c * (c * (c * 0.305306011 + 0.682171111) + 0.012522878);\n\t#else\n\t\tmediump vec3 linearRGBLo = c / 12.92;\n\t\tmediump vec3 power=vec3(2.4, 2.4, 2.4);\n\t\tmediump vec3 linearRGBHi = positivePow((c + 0.055) / 1.055, power);\n\t\tmediump vec3 linearRGB =vec3((c.r<=0.04045) ? linearRGBLo.r : linearRGBHi.r,(c.g<=0.04045) ? linearRGBLo.g : linearRGBHi.g,(c.b<=0.04045) ? linearRGBLo.b : linearRGBHi.b);\n\t\treturn linearRGB;\n\t#endif\n}\n\nmediump vec3 LinearToSRGB(mediump vec3 c) {\n\t#ifdef USE_VERY_FAST_SRGB\n\t\treturn sqrt(c);\n\t#elif defined(USE_FAST_SRGB)\n\t\treturn max(1.055 * PositivePow(c, 0.416666667) - 0.055, 0.0);\n\t#else\n\t\tmediump vec3 sRGBLo = c * 12.92;\n\t\tmediump vec3 power=vec3(1.0 / 2.4, 1.0 / 2.4, 1.0 / 2.4);\n\t\tmediump vec3 sRGBHi = (positivePow(c, power) * 1.055) - 0.055;\n\t\tmediump vec3 sRGB =vec3((c.r<=0.0031308) ? sRGBLo.r : sRGBHi.r,(c.g<=0.0031308) ? sRGBLo.g : sRGBHi.g,(c.b<=0.0031308) ? sRGBLo.b : sRGBHi.b);\n\t\treturn sRGB;\n\t#endif\n}'),Bq.addInclude("Sampling.glsl","// Better, temporally stable box filtering\n// [Jimenez14] http://goo.gl/eomGso\n// . . . . . . .\n// . A . B . C .\n// . . D . E . .\n// . F . G . H .\n// . . I . J . .\n// . K . L . M .\n// . . . . . . .\nmediump vec4 downsampleBox13Tap(sampler2D tex, vec2 uv, vec2 texelSize)\n{\n    mediump vec4 A = texture2D(tex, uv + texelSize * vec2(-1.0, -1.0));\n    mediump vec4 B = texture2D(tex, uv + texelSize * vec2( 0.0, -1.0));\n    mediump vec4 C = texture2D(tex, uv + texelSize * vec2( 1.0, -1.0));\n    mediump vec4 D = texture2D(tex, uv + texelSize * vec2(-0.5, -0.5));\n    mediump vec4 E = texture2D(tex, uv + texelSize * vec2( 0.5, -0.5));\n    mediump vec4 F = texture2D(tex, uv + texelSize * vec2(-1.0,  0.0));\n    mediump vec4 G = texture2D(tex, uv);\n    mediump vec4 H = texture2D(tex, uv + texelSize * vec2( 1.0,  0.0));\n    mediump vec4 I = texture2D(tex, uv + texelSize * vec2(-0.5,  0.5));\n    mediump vec4 J = texture2D(tex, uv + texelSize * vec2( 0.5,  0.5));\n    mediump vec4 K = texture2D(tex, uv + texelSize * vec2(-1.0,  1.0));\n    mediump vec4 L = texture2D(tex, uv + texelSize * vec2( 0.0,  1.0));\n    mediump vec4 M = texture2D(tex, uv + texelSize * vec2( 1.0,  1.0));\n\n\tmediump vec2 scale= vec2(0.5, 0.125);\n    mediump vec2 div = (1.0 / 4.0) * scale;\n\n    mediump vec4 o = (D + E + I + J) * div.x;\n    o += (A + B + G + F) * div.y;\n    o += (B + C + H + G) * div.y;\n    o += (F + G + L + K) * div.y;\n    o += (G + H + M + L) * div.y;\n\n    return o;\n}\n\n// Standard box filtering\nmediump vec4 downsampleBox4Tap(sampler2D tex, vec2 uv, vec2 texelSize)\n{\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0);\n\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.xw);\n    s += texture2D(tex, uv + d.zw);\n\n    return s * (1.0 / 4.0);\n}\n\n// 9-tap bilinear upsampler (tent filter)\n// . . . . . . .\n// . 1 . 2 . 1 .\n// . . . . . . .\n// . 2 . 4 . 2 .\n// . . . . . . .\n// . 1 . 2 . 1 .\n// . . . . . . .\nmediump vec4 upsampleTent(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\n{\n    vec4 d = texelSize.xyxy * vec4(1.0, 1.0, -1.0, 0.0) * sampleScale;\n\n    mediump vec4 s =  texture2D(tex, uv - d.xy);\n    s += texture2D(tex, uv - d.wy) * 2.0;\n    s += texture2D(tex, uv - d.zy);\n\n    s += texture2D(tex, uv + d.zw) * 2.0;\n    s += texture2D(tex, uv) * 4.0;\n    s += texture2D(tex,\tuv + d.xw) * 2.0;\n\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.wy) * 2.0;\n    s += texture2D(tex, uv + d.xy);\n\n    return s * (1.0 / 16.0);\n}\n\n// Standard box filtering\nmediump vec4 upsampleBox(sampler2D tex, vec2 uv, vec2 texelSize, vec4 sampleScale)\n{\n    vec4 d = texelSize.xyxy * vec4(-1.0, -1.0, 1.0, 1.0) * (sampleScale * 0.5);\n\n    mediump vec4 s =  texture2D(tex, uv + d.xy);\n    s += texture2D(tex, uv + d.zy);\n    s += texture2D(tex, uv + d.xw);\n    s += texture2D(tex, uv + d.zw);\n\n    return s * (1.0 / 4.0);\n}"),Bq.addInclude("StdLib.glsl","#define HALF_MAX       65504.0 // (2 - 2^-10) * 2^15\n\n#define FLT_EPSILON    1.192092896e-07 // Smallest positive number, such that 1.0 + FLT_EPSILON != 1.0\n\nmediump vec4 safeHDR(mediump vec4 c)\n{\n    return min(c, HALF_MAX);\n}\n\nfloat max3(float a, float b, float c)\n{\n    return max(max(a, b), c);\n}\n\nvec3 positivePow(vec3 base, vec3 power)\n{\n    return pow(max(abs(base), vec3(FLT_EPSILON, FLT_EPSILON, FLT_EPSILON)), power);\n}");var m={a_Position:0,a_Color:1,a_Normal:3,a_Texcoord0:2,a_Texcoord1:7,a_BoneWeights:6,a_BoneIndices:5,a_Tangent0:4,a_MvpMatrix:12,a_WorldMat:8},a={u_Bones:0,u_DiffuseTexture:1,u_SpecularTexture:1,u_NormalTexture:1,u_AlphaTestValue:1,u_DiffuseColor:1,u_MaterialSpecular:1,u_Shininess:1,u_TilingOffset:1,u_WorldMat:2,u_MvpMatrix:2,u_LightmapScaleOffset:2,u_LightMap:2,u_CameraPos:3,u_ReflectTexture:4,u_ReflectIntensity:4,u_FogStart:4,u_FogRange:4,u_FogColor:4,"u_DirectionLight.Color":4,"u_DirectionLight.Direction":4,"u_PointLight.Position":4,"u_PointLight.Range":4,"u_PointLight.Color":4,"u_SpotLight.Position":4,"u_SpotLight.Direction":4,"u_SpotLight.Range":4,"u_SpotLight.Spot":4,"u_SpotLight.Color":4,u_AmbientColor:4,u_shadowMap1:4,u_shadowMap2:4,u_shadowMap3:4,u_shadowPSSMDistance:4,u_lightShadowVP:4,u_shadowPCFoffset:4},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13};q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_MvpMatrix;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))||(defined(LIGHTMAP)&&defined(UV))\n\tattribute vec2 a_Texcoord0;\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#if defined(LIGHTMAP)&&defined(UV1)\n\tattribute vec2 a_Texcoord1;\n#endif\n\n#ifdef LIGHTMAP\n\tuniform vec4 u_LightmapScaleOffset;\n\tvarying vec2 v_LightMapUV;\n#endif\n\n#ifdef COLOR\n\tattribute vec4 a_Color;\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal; \n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_ViewDir; \n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\tattribute vec4 a_Tangent0;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\t#ifdef GPU_INSTANCE\n\t\tattribute mat4 a_WorldMat;\n\t#else\n\t\tuniform mat4 u_WorldMat;\n\t#endif\n\tvarying vec3 v_PositionWorld;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n  varying vec4 v_lightMVPPos;\n  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvoid main_castShadow()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tposition=skinTransform*a_Position;\n\t#else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = a_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t\n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tposition=skinTransform*a_Position;\n\t#else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = a_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\t\tmat4 worldMat;\n\t\t#ifdef GPU_INSTANCE\n\t\t\tworldMat = a_WorldMat;\n\t\t#else\n\t\t\tworldMat = u_WorldMat;\n\t\t#endif\n\t#endif\n\t\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tmat3 worldInvMat;\n\t\t#ifdef BONE\n\t\t\tworldInvMat=inverse(mat3(worldMat*skinTransform));\n\t\t#else\n\t\t\tworldInvMat=inverse(mat3(worldMat));\n\t\t#endif  \n\t\tv_Normal=a_Normal*worldInvMat;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tv_Tangent=a_Tangent0.xyz*worldInvMat;\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t\t#endif\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\t\tv_PositionWorld=(worldMat*position).xyz;\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\n\t#endif\n\n\t#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t\t#else\n\t\t\tv_Texcoord0=a_Texcoord0;\n\t\t#endif\n\t#endif\n\n\t#ifdef LIGHTMAP\n\t\t#ifdef SCALEOFFSETLIGHTINGMAPUV\n\t\t\t#ifdef UV1\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord1.x,1.0-a_Texcoord1.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t\t#else\n\t\t\t\tv_LightMapUV=vec2(a_Texcoord0.x,1.0-a_Texcoord0.y)*u_LightmapScaleOffset.xy+u_LightmapScaleOffset.zw;\n\t\t\t#endif \n\t\t\tv_LightMapUV.y=1.0-v_LightMapUV.y;\n\t\t#else\n\t\t\t#ifdef UV1\n\t\t\t\tv_LightMapUV=a_Texcoord1;\n\t\t\t#else\n\t\t\t\tv_LightMapUV=a_Texcoord0;\n\t\t\t#endif \n\t\t#endif \n\t#endif\n\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tv_Color=a_Color;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',Q='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nuniform vec4 u_DiffuseColor;\n\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\tvarying vec4 v_Color;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvarying vec3 v_ViewDir; \n#endif\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef DIFFUSEMAP\n\tuniform sampler2D u_DiffuseTexture;\n#endif\n\n\n\n#if defined(DIFFUSEMAP)||((defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&(defined(SPECULARMAP)||defined(NORMALMAP)))\n\tvarying vec2 v_Texcoord0;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform sampler2D u_LightMap;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tuniform vec3 u_MaterialSpecular;\n\tuniform float u_Shininess;\n\t#ifdef SPECULARMAP \n\t\tuniform sampler2D u_SpecularTexture;\n\t#endif\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\tvarying vec3 v_Normal;\n#endif\n\n#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\tuniform sampler2D u_NormalTexture;\n\tvarying vec3 v_Tangent;\n\tvarying vec3 v_Binormal;\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\nuniform vec3 u_AmbientColor;\n\n\n#if defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#include "ShadowHelper.glsl"\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\nvoid main_castShadow()\n{\n\t//gl_FragColor=vec4(v_posViewZ,0.0,0.0,1.0);\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_DiffuseTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\nvoid main_normal()\n{\n\tvec3 globalDiffuse=u_AmbientColor;\n\t#ifdef LIGHTMAP\t\n\t\tglobalDiffuse += DecodeLightmap(texture2D(u_LightMap, v_LightMapUV));\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 normal;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))&&defined(NORMALMAP)\n\t\t\tvec3 normalMapSample = texture2D(u_NormalTexture, v_Texcoord0).rgb;\n\t\t\tnormal = normalize(NormalSampleToWorldSpace(normalMapSample, v_Normal, v_Tangent,v_Binormal));\n\t\t#else\n\t\t\tnormal = normalize(v_Normal);\n\t\t#endif\n\t\tvec3 viewDir= normalize(v_ViewDir);\n\t#endif\n\t\n\tvec4 mainColor=u_DiffuseColor;\n\t#ifdef DIFFUSEMAP\n\t\tvec4 difTexColor=texture2D(u_DiffuseTexture, v_Texcoord0);\n\t\tmainColor=mainColor*difTexColor;\n\t#endif \n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tmainColor=mainColor*v_Color;\n\t#endif \n    \n\t#ifdef ALPHATEST\n\t\tif(mainColor.a<u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\t\n\tvec3 diffuse = vec3(0.0);\n\tvec3 specular= vec3(0.0);\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tvec3 dif,spe;\n\t\t#ifdef SPECULARMAP\n\t\t\tvec3 gloss=texture2D(u_SpecularTexture, v_Texcoord0).rgb;\n\t\t#else\n\t\t\t#ifdef DIFFUSEMAP\n\t\t\t\tvec3 gloss=vec3(difTexColor.a);\n\t\t\t#else\n\t\t\t\tvec3 gloss=vec3(1.0);\n\t\t\t#endif\n\t\t#endif\n\t#endif\n\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tLayaAirBlinnPhongDiectionLight(u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_DirectionLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tLayaAirBlinnPhongPointLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_PointLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t#ifdef SPOTLIGHT\n\t\tLayaAirBlinnPhongSpotLight(v_PositionWorld,u_MaterialSpecular,u_Shininess,normal,gloss,viewDir,u_SpotLight,dif,spe);\n\t\tdiffuse+=dif;\n\t\tspecular+=spe;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3(u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2(u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1(u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse*shadowValue),mainColor.a);\n\t#else\n\t\tgl_FragColor =vec4(mainColor.rgb*(globalDiffuse + diffuse),mainColor.a);\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\t#ifdef RECEIVESHADOW\n\t\t\tgl_FragColor.rgb+=specular*shadowValue;\n\t\t#else\n\t\t\tgl_FragColor.rgb+=specular;\n\t\t#endif\n\t#endif\n\t  \n\t#ifdef FOG\n\t\tfloat lerpFact=clamp((1.0/gl_FragCoord.w-u_FogStart)/u_FogRange,0.0,1.0);\n\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n';var e=Bq.add("BLINNPHONG",!0),F=new FQ(m,a,la.shaderDefines,da.shaderDefines);e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_Position:0,a_Color:1},a={u_MvpMatrix:2,u_Color:1},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13},q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform vec4 u_Color;\nattribute vec4 a_Color;\nvarying vec4 v_Color;\n\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n\tv_Color=a_Color*u_Color;\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',Q="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec4 v_Color;\nuniform vec4 u_Color;\n\nvoid main()\n{\n  gl_FragColor = v_Color * u_Color; \n}\n\n",e=Bq.add("LineShader"),F=new FQ(m,a),e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_Position:0,a_Normal:3,a_Tangent0:4,a_Texcoord0:2,a_BoneWeights:6,a_BoneIndices:5,a_MvpMatrix:12,a_WorldMat:8},a={u_Bones:0,u_MvpMatrix:2,u_WorldMat:2,u_CameraPos:3,u_AlphaTestValue:1,u_AlbedoColor:1,u_EmissionColor:1,u_AlbedoTexture:1,u_NormalTexture:1,u_ParallaxTexture:1,u_MetallicGlossTexture:1,u_OcclusionTexture:1,u_EmissionTexture:1,u_metallic:1,u_smoothness:1,u_smoothnessScale:1,u_occlusionStrength:1,u_normalScale:1,u_parallaxScale:1,u_TilingOffset:1,"u_DirectionLight.Direction":4,"u_DirectionLight.Color":4,u_PointLightMatrix:4,"u_PointLight.Position":4,"u_PointLight.Range":4,"u_PointLight.Color":4,"u_SpotLight.Position":4,"u_SpotLight.Direction":4,"u_SpotLight.Range":4,"u_SpotLight.SpotAngle":4,"u_SpotLight.Color":4,u_RangeTexture:4,u_ReflectTexture:4,u_ReflectIntensity:4,u_AmbientColor:4,u_shadowMap1:4,u_shadowMap2:4,u_shadowMap3:4,u_shadowPSSMDistance:4,u_lightShadowVP:4,u_shadowPCFoffset:4,u_FogStart:4,u_FogRange:4,u_FogColor:4},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13},q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_MvpMatrix;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_WorldMat;\n#endif\n\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tposition=skinTransform*a_Position;\n\t#else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = a_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tposition=skinTransform*a_Position;\n\t#else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = a_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\t\tmat4 worldMat;\n\t\t#ifdef GPU_INSTANCE\n\t\t\tworldMat = a_WorldMat;\n\t\t#else\n\t\t\tworldMat = u_WorldMat;\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tmat3 worldInvMat;\n\t\t#ifdef BONE\n\t\t\tworldInvMat=inverse(mat3(worldMat*skinTransform));\n\t\t#else\n\t\t\tworldInvMat=inverse(mat3(worldMat));\n\t\t#endif  \n\t\tv_Normal=a_Normal*worldInvMat;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))\n\t\t\tv_Tangent=a_Tangent0.xyz*worldInvMat;\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t\t#endif\n\t#endif\n\t\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\t\tv_PositionWorld=(worldMat*position).xyz;\n\t#endif\n\t\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\n\t#endif\n\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t#else\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',Q='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\nuniform vec3 u_AmbientColor;\nuniform vec4 u_AlbedoColor;\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n#ifdef METALLICGLOSSTEXTURE\n\tuniform sampler2D u_MetallicGlossTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n#ifdef REFLECTMAP\n\tuniform samplerCube u_ReflectTexture;\n\tuniform float u_ReflectIntensity;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\nuniform sampler2D u_RangeTexture;\n//uniform sampler2D u_AngleTexture;\nuniform mat4 u_PointLightMatrix;\n//uniform mat4 u_SpotLightMatrix;\n\n#include "PBRStandardLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_AlbedoTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec2 mg;\n\tvec4 albedoColor;\n\t#ifdef ALBEDOTEXTURE\n\t\tvec4 abledoTextureColor = texture2D(u_AlbedoTexture, uv0);\n\t\talbedoColor = abledoTextureColor * u_AlbedoColor;\n\t\tmg = MetallicGloss(abledoTextureColor.a, uv0);\n\t#else\n\t\talbedoColor = u_AlbedoColor;\n\t\tmg = MetallicGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(albedoColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tvec3 normal = UnpackScaleNormal(uv0);\n  \n\tLayaGI gi;\n\tgi.diffuse = u_AmbientColor * Occlusion(uv0).rgb;\n\tgi.specular = ReflectCubeMap(viewDir, normal);\n  \n\tvec4 color = vec4(0.0);\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tcolor += PBRStandardDiectionLight(albedoColor, mg.r, mg.g, normal, viewDir, u_DirectionLight, gi);\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tcolor.a = 0.0;\n\t\tcolor += PBRStandardPointLight(albedoColor, mg.r, mg.g, normal, viewDir, u_PointLight, v_PositionWorld, gi);\n\t#endif\n\t\n\t#ifdef SPOTLIGHT\n\t\tcolor.a = 0.0;\n\t\tcolor += PBRStandardSpotLight(albedoColor, mg.r, mg.g, normal, viewDir, u_SpotLight, v_PositionWorld, gi);\n\t#endif\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}',e=Bq.add("PBRStandard",!0),F=new FQ(m,a,la.shaderDefines,ea.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_Position:0,a_Normal:3,a_Tangent0:4,a_Texcoord0:2,a_BoneWeights:6,a_BoneIndices:5,a_MvpMatrix:12,a_WorldMat:8},a={u_Bones:0,u_MvpMatrix:2,u_WorldMat:2,u_CameraPos:3,u_AlphaTestValue:1,u_AlbedoColor:1,u_SpecularColor:1,u_EmissionColor:1,u_AlbedoTexture:1,u_NormalTexture:1,u_ParallaxTexture:1,u_SpecularTexture:1,u_OcclusionTexture:1,u_EmissionTexture:1,u_smoothness:1,u_smoothnessScale:1,u_occlusionStrength:1,u_normalScale:1,u_parallaxScale:1,u_TilingOffset:1,"u_DirectionLight.Direction":4,"u_DirectionLight.Color":4,u_PointLightMatrix:4,"u_PointLight.Position":4,"u_PointLight.Range":4,"u_PointLight.Color":4,"u_SpotLight.Position":4,"u_SpotLight.Direction":4,"u_SpotLight.Range":4,"u_SpotLight.SpotAngle":4,"u_SpotLight.Color":4,u_RangeTexture:4,u_ReflectTexture:4,u_ReflectIntensity:4,u_AmbientColor:4,u_shadowMap1:4,u_shadowMap2:4,u_shadowMap3:4,u_shadowPSSMDistance:4,u_lightShadowVP:4,u_shadowPCFoffset:4,u_FogStart:4,u_FogRange:4,u_FogColor:4},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13},q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\nattribute vec2 a_Texcoord0;\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_MvpMatrix;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_WorldMat;\n#else\n\tuniform mat4 u_WorldMat;\n#endif\nuniform vec3 u_CameraPos;\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n  #ifdef SHADOWMAP_PSSM1 \n\t  varying vec4 v_lightMVPPos;\n\t  uniform mat4 u_lightShadowVP[4];\n  #endif\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main_castShadow()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tposition=skinTransform*a_Position;\n\t#else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = a_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t \n\t//TODO没考虑UV动画呢\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tv_Texcoord0 = a_Texcoord0;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n\tv_posViewZ = gl_Position.z;\n}\n\nvoid main_normal()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tposition=skinTransform*a_Position;\n\t#else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = a_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\t\tmat4 worldMat;\n\t\t#ifdef GPU_INSTANCE\n\t\t\tworldMat = a_WorldMat;\n\t\t#else\n\t\t\tworldMat = u_WorldMat;\n\t\t#endif\n\t#endif\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tmat3 worldInvMat;\n\t\t#ifdef BONE\n\t\t\tworldInvMat=inverse(mat3(worldMat*skinTransform));\n\t\t#else\n\t\t\tworldInvMat=inverse(mat3(worldMat));\n\t\t#endif  \n\t\tv_Normal=a_Normal*worldInvMat;\n\t\t#if (defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT))\n\t\t\tv_Tangent=a_Tangent0.xyz*worldInvMat;\n\t\t\tv_Binormal=cross(v_Normal,v_Tangent)*a_Tangent0.w;\n\t\t#endif\n\t#endif\n\t\n\t\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(RECEIVESHADOW)\n\t\tv_PositionWorld=(worldMat*position).xyz;\n\t#endif\n\t\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_ViewDir=u_CameraPos-v_PositionWorld;\n\t#endif\n\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t#else\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n  \n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1 \n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif\n}',Q='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nvarying vec2 v_Texcoord0;\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec3 v_PositionWorld;\n\nuniform vec3 u_AmbientColor;\nuniform vec4 u_AlbedoColor;\nuniform vec4 u_SpecularColor;\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n#ifdef SPECULARTEXTURE\n\tuniform sampler2D u_SpecularTexture;\n#endif\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n\tuniform float u_normalScale;\n#endif\n#ifdef PARALLAXTEXTURE\n\tuniform sampler2D u_ParallaxTexture;\n\tuniform float u_parallaxScale;\n#endif\n#ifdef OCCLUSIONTEXTURE\n\tuniform sampler2D u_OcclusionTexture;\n\tuniform float u_occlusionStrength;\n#endif\n#ifdef EMISSION\n\t#ifdef EMISSIONTEXTURE\n\t\tuniform sampler2D u_EmissionTexture;\n\t#endif\n\tuniform vec4 u_EmissionColor;\n#endif\n#ifdef REFLECTMAP\n\tuniform samplerCube u_ReflectTexture;\n\tuniform float u_ReflectIntensity;\n#endif\n\nuniform float u_AlphaTestValue;\nuniform float u_metallic;\nuniform float u_smoothness;\nuniform float u_smoothnessScale;\n\nuniform sampler2D u_RangeTexture;\n//uniform sampler2D u_AngleTexture;\nuniform mat4 u_PointLightMatrix;\n//uniform mat4 u_SpotLightMatrix;\n\n#include "PBRSpecularLighting.glsl"\n#include "ShadowHelper.glsl"\n\nvarying float v_posViewZ;\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\nvoid main_castShadow()\n{\n\tgl_FragColor=packDepth(v_posViewZ);\n\t#if defined(DIFFUSEMAP)&&defined(ALPHATEST)\n\t\tfloat alpha = texture2D(u_AlbedoTexture,v_Texcoord0).w;\n\t\tif( alpha < u_AlphaTestValue )\n\t\t{\n\t\t\tdiscard;\n\t\t}\n\t#endif\n}\n\nvoid main_normal()\n{\t\n\tvec3 viewDir = normalize(v_ViewDir);\n\t\n\tvec2 uv0 = ParallaxOffset(viewDir);\n\t\n\tvec4 sg;\n\tvec4 albedoColor;\n\t#ifdef ALBEDOTEXTURE\n\t\tvec4 albedoTextureColor = texture2D(u_AlbedoTexture, uv0);\n\t\talbedoColor = albedoTextureColor * u_AlbedoColor;\n\t\tsg = SpecularGloss(albedoTextureColor.a, uv0);\n\t#else\n\t\talbedoColor = u_AlbedoColor;\n\t\tsg = SpecularGloss(1.0, uv0);\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(albedoColor.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n  \n\tvec3 normal = UnpackScaleNormal(uv0);\n\t\n\tLayaGI gi;\n\tgi.diffuse = u_AmbientColor * Occlusion(uv0).rgb;\n\tgi.specular = ReflectCubeMap(viewDir, normal);\n\t\n\t//float a = (sg.r+sg.g+sg.b) / 3.0;\n  \n\tvec4 color = vec4(0.0);\n\t\n\t#ifdef DIRECTIONLIGHT\n\t\tcolor += PBRSpecularDiectionLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_DirectionLight, gi);\n\t#endif\n \n\t#ifdef POINTLIGHT\n\t\tcolor.a = 0.0;\n\t\tcolor += PBRSpecularPointLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_PointLight, v_PositionWorld, gi);\n\t#endif\n\t\n\t#ifdef SPOTLIGHT\n\t\tcolor.a = 0.0;\n\t\tcolor += PBRSpecularSpotLight(albedoColor, sg.rgb, sg.a, normal, viewDir, u_SpotLight, v_PositionWorld, gi);\n\t#endif\n\t\n\t#ifdef EMISSION\n\t\tvec4 emissionColor = u_EmissionColor;\n\t\t#ifdef EMISSIONTEXTURE\n\t\t\temissionColor *=  texture2D(u_EmissionTexture, uv0);\n\t\t#endif\n\t\tcolor.rgb += emissionColor.rgb;\n\t#endif\n\t\n\t#ifdef RECEIVESHADOW\n\t\tfloat shadowValue = 1.0;\n\t\t#ifdef SHADOWMAP_PSSM3\n\t\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif\n\t\t#ifdef SHADOWMAP_PSSM2\n\t\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t\t#endif \n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t\t#endif\n\t\tgl_FragColor = vec4(color.rgb * shadowValue, color.a);\n\t#else\n\t\tgl_FragColor = color;\n\t#endif\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t#endif\n}\n\nvoid main()\n{\n\t#ifdef CASTSHADOW\t\t\n\t\tmain_castShadow();\n\t#else\n\t\tmain_normal();\n\t#endif  \n}\n\n',e=Bq.add("PBRSpecular",!0),F=new FQ(m,a,la.shaderDefines,Sa.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_Position:0,a_Color:1,a_Texcoord0:2,a_BoneWeights:6,a_BoneIndices:5,a_MvpMatrix:12},a={u_Bones:0,u_AlbedoTexture:1,u_AlbedoColor:1,u_TilingOffset:1,u_AlphaTestValue:1,u_MvpMatrix:2,u_FogStart:4,u_FogRange:4,u_FogColor:4},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13},q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\n\nattribute vec2 a_Texcoord0;\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_MvpMatrix;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\nattribute vec4 a_Color;\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main() {\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tposition=skinTransform*a_Position;\n\t#else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = a_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t#else\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tv_Color = a_Color;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',Q="#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\tvarying vec4 v_Color;\n#endif\n\n#ifdef ALBEDOTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n\tvarying vec2 v_Texcoord0;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef ALPHATEST\n\tuniform float u_AlphaTestValue;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\nvoid main()\n{\n\tvec4 color =  u_AlbedoColor;\n\t#ifdef ALBEDOTEXTURE\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t#if defined(COLOR)&&defined(ENABLEVERTEXCOLOR)\n\t\tcolor *= v_Color;\n\t#endif\n\t\n\t#ifdef ALPHATEST\n\t\tif(color.a < u_AlphaTestValue)\n\t\t\tdiscard;\n\t#endif\n\t\n\tgl_FragColor = color;\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t\t#endif\n\t#endif\n\t\n}\n\n",e=Bq.add("Unlit",!0),F=new FQ(m,a,la.shaderDefines,Pm.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_Position:0,a_Texcoord0:2,a_BoneWeights:6,a_BoneIndices:5,a_MvpMatrix:12},a={u_Bones:0,u_AlbedoTexture:1,u_AlbedoColor:1,u_TilingOffset:1,u_AlphaTestValue:1,u_MvpMatrix:2,u_FogStart:4,u_FogRange:4,u_FogColor:4},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13},q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec4 a_Color;\nattribute vec2 a_Texcoord0;\n\n#ifdef GPU_INSTANCE\n\tattribute mat4 a_MvpMatrix;\n#else\n\tuniform mat4 u_MvpMatrix;\n#endif\n\nvarying vec4 v_Color;\nvarying vec2 v_Texcoord0;\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\n#ifdef BONE\n\tconst int c_MaxBoneCount = 24;\n\tattribute vec4 a_BoneIndices;\n\tattribute vec4 a_BoneWeights;\n\tuniform mat4 u_Bones[c_MaxBoneCount];\n#endif\n\nvoid main()\n{\n\tvec4 position;\n\t#ifdef BONE\n\t\tmat4 skinTransform = u_Bones[int(a_BoneIndices.x)] * a_BoneWeights.x;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.y)] * a_BoneWeights.y;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.z)] * a_BoneWeights.z;\n\t\tskinTransform += u_Bones[int(a_BoneIndices.w)] * a_BoneWeights.w;\n\t\tposition=skinTransform*a_Position;\n\t#else\n\t\tposition=a_Position;\n\t#endif\n\t#ifdef GPU_INSTANCE\n\t\tgl_Position = a_MvpMatrix * position;\n\t#else\n\t\tgl_Position = u_MvpMatrix * position;\n\t#endif\n\t\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0=TransformUV(a_Texcoord0,u_TilingOffset);\n\t#else\n\t\tv_Texcoord0=a_Texcoord0;\n\t#endif\n\t\t\n\tv_Color = a_Color;\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',Q="#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#ifdef COLOR\n\tvarying vec4 v_Color;\n#endif\nvarying vec2 v_Texcoord0;\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_AlbedoTexture;\n#endif\n\nuniform vec4 u_AlbedoColor;\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\nvoid main()\n{\n\tvec4 color =  2.0 * u_AlbedoColor;\n\t#ifdef COLOR\n\t\tcolor *= v_Color;\n\t#endif\n\t#ifdef MAINTEXTURE\n\t\tcolor *= texture2D(u_AlbedoTexture, v_Texcoord0);\n\t#endif\n\t\n\tgl_FragColor = color;\n\t\n\t#ifdef FOG\n\t\tfloat lerpFact = clamp((1.0 / gl_FragCoord.w - u_FogStart) / u_FogRange, 0.0, 1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, vec3(0.0), lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb = mix(gl_FragColor.rgb, u_FogColor, lerpFact);\n\t\t#endif\n\t#endif\n}\n\n",e=Bq.add("Effect",!0),F=new FQ(m,a,la.shaderDefines,Wa.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_CornerTextureCoordinate:0,a_MeshPosition:1,a_MeshColor:2,a_MeshTextureCoordinate:3,a_ShapePositionStartLifeTime:4,a_DirectionTime:5,a_StartColor:6,a_EndColor:7,a_StartSize:8,a_StartRotation0:9,a_StartSpeed:10,a_Random0:11,a_Random1:12,a_SimulationWorldPostion:13,a_SimulationWorldRotation:14},a={u_Tintcolor:1,u_TilingOffset:1,u_texture:1,u_WorldPosition:2,u_WorldRotation:2,u_PositionScale:2,u_SizeScale:2,u_ScalingMode:2,u_Gravity:2,u_ThreeDStartRotation:2,u_StretchedBillboardLengthScale:2,u_StretchedBillboardSpeedScale:2,u_SimulationSpace:2,u_CurrentTime:2,u_ColorOverLifeGradientAlphas:2,u_ColorOverLifeGradientColors:2,u_MaxColorOverLifeGradientAlphas:2,u_MaxColorOverLifeGradientColors:2,u_VOLVelocityConst:2,u_VOLVelocityGradientX:2,u_VOLVelocityGradientY:2,u_VOLVelocityGradientZ:2,u_VOLVelocityConstMax:2,u_VOLVelocityGradientMaxX:2,u_VOLVelocityGradientMaxY:2,u_VOLVelocityGradientMaxZ:2,u_VOLSpaceType:2,u_SOLSizeGradient:2,u_SOLSizeGradientX:2,u_SOLSizeGradientY:2,u_SOLSizeGradientZ:2,u_SOLSizeGradientMax:2,u_SOLSizeGradientMaxX:2,u_SOLSizeGradientMaxY:2,u_SOLSizeGradientMaxZ:2,u_ROLAngularVelocityConst:2,u_ROLAngularVelocityConstSeprarate:2,u_ROLAngularVelocityGradient:2,u_ROLAngularVelocityGradientX:2,u_ROLAngularVelocityGradientY:2,u_ROLAngularVelocityGradientZ:2,u_ROLAngularVelocityConstMax:2,u_ROLAngularVelocityConstMaxSeprarate:2,u_ROLAngularVelocityGradientMax:2,u_ROLAngularVelocityGradientMaxX:2,u_ROLAngularVelocityGradientMaxY:2,u_ROLAngularVelocityGradientMaxZ:2,u_ROLAngularVelocityGradientMaxW:2,u_TSACycles:2,u_TSASubUVLength:2,u_TSAGradientUVs:2,u_TSAMaxGradientUVs:2,u_CameraPos:3,u_CameraDirection:3,u_CameraUp:3,u_View:3,u_Projection:3,u_FogStart:4,u_FogRange:4,u_FogColor:4},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13},q='#include "Lighting.glsl";\n\n#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\n#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\tattribute vec4 a_CornerTextureCoordinate;\n#endif\n#ifdef RENDERMODE_MESH\n\tattribute vec3 a_MeshPosition;\n\tattribute vec4 a_MeshColor;\n\tattribute vec2 a_MeshTextureCoordinate;\n\tvarying vec4 v_MeshColor;\n#endif\n\nattribute vec4 a_ShapePositionStartLifeTime;\nattribute vec4 a_DirectionTime;\nattribute vec4 a_StartColor;\nattribute vec3 a_StartSize;\nattribute vec3 a_StartRotation0;\nattribute float a_StartSpeed;\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n  attribute vec4 a_Random0;\n#endif\n#if defined(TEXTURESHEETANIMATIONRANDOMCURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  attribute vec4 a_Random1;\n#endif\nattribute vec3 a_SimulationWorldPostion;\nattribute vec4 a_SimulationWorldRotation;\n\nvarying float v_Discard;\nvarying vec4 v_Color;\n#ifdef DIFFUSEMAP\n\tvarying vec2 v_TextureCoordinate;\n#endif\n\nuniform float u_CurrentTime;\nuniform vec3 u_Gravity;\n\nuniform vec3 u_WorldPosition;\nuniform vec4 u_WorldRotation;\nuniform bool u_ThreeDStartRotation;\nuniform int u_ScalingMode;\nuniform vec3 u_PositionScale;\nuniform vec3 u_SizeScale;\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\n#ifdef STRETCHEDBILLBOARD\n\tuniform vec3 u_CameraPosition;\n#endif\nuniform vec3 u_CameraDirection;//TODO:只有几种广告牌模式需要用\nuniform vec3 u_CameraUp;\n\nuniform  float u_StretchedBillboardLengthScale;\nuniform  float u_StretchedBillboardSpeedScale;\nuniform int u_SimulationSpace;\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  int  u_VOLSpaceType;\n#endif\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)\n  uniform  vec3 u_VOLVelocityConst;\n#endif\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n  uniform  vec2 u_VOLVelocityGradientX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientZ[4];//x为key,y为速度\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n  uniform  vec3 u_VOLVelocityConstMax;\n#endif\n#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n  uniform  vec2 u_VOLVelocityGradientMaxX[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxY[4];//x为key,y为速度\n  uniform  vec2 u_VOLVelocityGradientMaxZ[4];//x为key,y为速度\n#endif\n\n#ifdef COLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n#ifdef RANDOMCOLOROVERLIFETIME\n  uniform  vec4 u_ColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_ColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n  uniform  vec4 u_MaxColorOverLifeGradientColors[4];//x为key,yzw为Color\n  uniform  vec2 u_MaxColorOverLifeGradientAlphas[4];//x为key,y为Alpha\n#endif\n\n\n#if defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMERANDOMCURVES)\n  uniform  vec2 u_SOLSizeGradient[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVES\n  uniform  vec2 u_SOLSizeGradientMax[4];//x为key,y为尺寸\n#endif\n#if defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\n  uniform  vec2 u_SOLSizeGradientX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientZ[4];//x为key,y为尺寸\n#endif\n#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n  uniform  vec2 u_SOLSizeGradientMaxX[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxY[4];//x为key,y为尺寸\n  uniform  vec2 u_SOLSizeGradientMaxZ[4];//x为key,y为尺寸\n#endif\n\n\n#ifdef ROTATIONOVERLIFETIME\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  float u_ROLAngularVelocityConst;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  float u_ROLAngularVelocityConstMax;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradient[4];//x为key,y为旋转\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMax[4];//x为key,y为旋转\n  #endif\n#endif\n#ifdef ROTATIONOVERLIFETIMESEPERATE\n  #if defined(ROTATIONOVERLIFETIMECONSTANT)||defined(ROTATIONOVERLIFETIMERANDOMCONSTANTS)\n    uniform  vec3 u_ROLAngularVelocityConstSeprarate;\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n    uniform  vec3 u_ROLAngularVelocityConstMaxSeprarate;\n  #endif\n  #if defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\n    uniform  vec2 u_ROLAngularVelocityGradientX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientZ[4];\n  #endif\n  #ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n    uniform  vec2 u_ROLAngularVelocityGradientMaxX[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxY[4];\n    uniform  vec2 u_ROLAngularVelocityGradientMaxZ[4];\n\tuniform  vec2 u_ROLAngularVelocityGradientMaxW[4];\n  #endif\n#endif\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\n  uniform  float u_TSACycles;\n  uniform  vec2 u_TSASubUVLength;\n  uniform  vec2 u_TSAGradientUVs[4];//x为key,y为frame\n#endif\n#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n  uniform  vec2 u_TSAMaxGradientUVs[4];//x为key,y为frame\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef TILINGOFFSET\n\tuniform vec4 u_TilingOffset;\n#endif\n\nvec3 rotationByEuler(in vec3 vector,in vec3 rot)\n{\n\tfloat halfRoll = rot.z * 0.5;\n    float halfPitch = rot.x * 0.5;\n\tfloat halfYaw = rot.y * 0.5;\n\n\tfloat sinRoll = sin(halfRoll);\n\tfloat cosRoll = cos(halfRoll);\n\tfloat sinPitch = sin(halfPitch);\n\tfloat cosPitch = cos(halfPitch);\n\tfloat sinYaw = sin(halfYaw);\n\tfloat cosYaw = cos(halfYaw);\n\n\tfloat quaX = (cosYaw * sinPitch * cosRoll) + (sinYaw * cosPitch * sinRoll);\n\tfloat quaY = (sinYaw * cosPitch * cosRoll) - (cosYaw * sinPitch * sinRoll);\n\tfloat quaZ = (cosYaw * cosPitch * sinRoll) - (sinYaw * sinPitch * cosRoll);\n\tfloat quaW = (cosYaw * cosPitch * cosRoll) + (sinYaw * sinPitch * sinRoll);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\n//假定axis已经归一化\nvec3 rotationByAxis(in vec3 vector,in vec3 axis, in float angle)\n{\n\tfloat halfAngle = angle * 0.5;\n\tfloat sin = sin(halfAngle);\n\t\n\tfloat quaX = axis.x * sin;\n\tfloat quaY = axis.y * sin;\n\tfloat quaZ = axis.z * sin;\n\tfloat quaW = cos(halfAngle);\n\t\n\t//vec4 q=vec4(quaX,quaY,quaZ,quaW);\n\t//vec3 temp = cross(q.xyz, vector) + q.w * vector;\n\t//return (cross(temp, -q.xyz) + dot(q.xyz,vector) * q.xyz + q.w * temp);\n\t\n\tfloat x = quaX + quaX;\n    float y = quaY + quaY;\n    float z = quaZ + quaZ;\n    float wx = quaW * x;\n    float wy = quaW * y;\n    float wz = quaW * z;\n\tfloat xx = quaX * x;\n    float xy = quaX * y;\n\tfloat xz = quaX * z;\n    float yy = quaY * y;\n    float yz = quaY * z;\n    float zz = quaZ * z;\n\n    return vec3(((vector.x * ((1.0 - yy) - zz)) + (vector.y * (xy - wz))) + (vector.z * (xz + wy)),\n                ((vector.x * (xy + wz)) + (vector.y * ((1.0 - xx) - zz))) + (vector.z * (yz - wx)),\n                ((vector.x * (xz - wy)) + (vector.y * (yz + wx))) + (vector.z * ((1.0 - xx) - yy)));\n\t\n}\n\nvec3 rotationByQuaternions(in vec3 v,in vec4 q) \n{\n\treturn v + 2.0 * cross(q.xyz, cross(q.xyz, v) + q.w * v);\n}\n\n \n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(SIZEOVERLIFETIMECURVE)||defined(SIZEOVERLIFETIMECURVESEPERATE)||defined(SIZEOVERLIFETIMERANDOMCURVES)||defined(SIZEOVERLIFETIMERANDOMCURVESSEPERATE)\nfloat getCurValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat curValue;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\tcurValue=mix(lastGradientNumber.y,gradientNumber.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn curValue;\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)||defined(ROTATIONOVERLIFETIMECURVE)||defined(ROTATIONOVERLIFETIMERANDOMCURVES)\nfloat getTotalValueFromGradientFloat(in vec2 gradientNumbers[4],in float normalizedAge)\n{\n\tfloat totalValue=0.0;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientNumber=gradientNumbers[i];\n\t\tfloat key=gradientNumber.x;\n\t\tvec2 lastGradientNumber=gradientNumbers[i-1];\n\t\tfloat lastValue=lastGradientNumber.y;\n\t\t\n\t\tif(key>=normalizedAge){\n\t\t\tfloat lastKey=lastGradientNumber.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\ttotalValue+=(lastValue+mix(lastValue,gradientNumber.y,age))/2.0*a_ShapePositionStartLifeTime.w*(normalizedAge-lastKey);\n\t\t\tbreak;\n\t\t}\n\t\telse{\n\t\t\ttotalValue+=(lastValue+gradientNumber.y)/2.0*a_ShapePositionStartLifeTime.w*(key-lastGradientNumber.x);\n\t\t}\n\t}\n\treturn totalValue;\n}\n#endif\n\n#if defined(COLOROVERLIFETIME)||defined(RANDOMCOLOROVERLIFETIME)\nvec4 getColorFromGradient(in vec2 gradientAlphas[4],in vec4 gradientColors[4],in float normalizedAge)\n{\n\tvec4 overTimeColor;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientAlpha=gradientAlphas[i];\n\t\tfloat alphaKey=gradientAlpha.x;\n\t\tif(alphaKey>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientAlpha=gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey=lastGradientAlpha.x;\n\t\t\tfloat age=(normalizedAge-lastAlphaKey)/(alphaKey-lastAlphaKey);\n\t\t\toverTimeColor.a=mix(lastGradientAlpha.y,gradientAlpha.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\t\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec4 gradientColor=gradientColors[i];\n\t\tfloat colorKey=gradientColor.x;\n\t\tif(colorKey>=normalizedAge)\n\t\t{\n\t\t\tvec4 lastGradientColor=gradientColors[i-1];\n\t\t\tfloat lastColorKey=lastGradientColor.x;\n\t\t\tfloat age=(normalizedAge-lastColorKey)/(colorKey-lastColorKey);\n\t\t\toverTimeColor.rgb=mix(gradientColors[i-1].yzw,gradientColor.yzw,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn overTimeColor;\n}\n#endif\n\n\n#if defined(TEXTURESHEETANIMATIONCURVE)||defined(TEXTURESHEETANIMATIONRANDOMCURVE)\nfloat getFrameFromGradient(in vec2 gradientFrames[4],in float normalizedAge)\n{\n\tfloat overTimeFrame;\n\tfor(int i=1;i<4;i++)\n\t{\n\t\tvec2 gradientFrame=gradientFrames[i];\n\t\tfloat key=gradientFrame.x;\n\t\tif(key>=normalizedAge)\n\t\t{\n\t\t\tvec2 lastGradientFrame=gradientFrames[i-1];\n\t\t\tfloat lastKey=lastGradientFrame.x;\n\t\t\tfloat age=(normalizedAge-lastKey)/(key-lastKey);\n\t\t\toverTimeFrame=mix(lastGradientFrame.y,gradientFrame.y,age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn floor(overTimeFrame);\n}\n#endif\n\n#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\nvec3 computeParticleLifeVelocity(in float normalizedAge)\n{\n  vec3 outLifeVelocity;\n  #ifdef VELOCITYOVERLIFETIMECONSTANT\n\t outLifeVelocity=u_VOLVelocityConst; \n  #endif\n  #ifdef VELOCITYOVERLIFETIMECURVE\n     outLifeVelocity= vec3(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t outLifeVelocity=mix(u_VOLVelocityConst,u_VOLVelocityConstMax,vec3(a_Random1.y,a_Random1.z,a_Random1.w)); \n  #endif\n  #ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n     outLifeVelocity=vec3(mix(getCurValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y),\n\t                 mix(getCurValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z),\n\t\t\t\t\t mix(getCurValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getCurValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n  #endif\n\t\t\t\t\t\n  return outLifeVelocity;\n} \n#endif\n\nvec3 computeParticlePosition(in vec3 startVelocity, in vec3 lifeVelocity,in float age,in float normalizedAge,vec3 gravityVelocity,vec4 worldRotation)\n{\n   vec3 startPosition;\n   vec3 lifePosition;\n   #if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t#ifdef VELOCITYOVERLIFETIMECONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMECURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge));\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCONSTANT\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=lifeVelocity*age;\n\t#endif\n\t#ifdef VELOCITYOVERLIFETIMERANDOMCURVE\n\t\t  startPosition=startVelocity*age;\n\t\t  lifePosition=vec3(mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxX,normalizedAge),a_Random1.y)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxY,normalizedAge),a_Random1.z)\n\t      ,mix(getTotalValueFromGradientFloat(u_VOLVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_VOLVelocityGradientMaxZ,normalizedAge),a_Random1.w));\n\t#endif\n\t\n\tvec3 finalPosition;\n\tif(u_VOLSpaceType==0){\n\t  if(u_ScalingMode!=2)\n\t   finalPosition =rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition),worldRotation);\n\t  else\n\t   finalPosition =rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition+lifePosition,worldRotation);\n\t}\n\telse{\n\t  if(u_ScalingMode!=2)\n\t    finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation)+lifePosition;\n\t  else\n\t    finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation)+lifePosition;\n\t}\n  #else\n\t startPosition=startVelocity*age;\n\t vec3 finalPosition;\n\t if(u_ScalingMode!=2)\n\t   finalPosition = rotationByQuaternions(u_PositionScale*(a_ShapePositionStartLifeTime.xyz+startPosition),worldRotation);\n\t else\n\t   finalPosition = rotationByQuaternions(u_PositionScale*a_ShapePositionStartLifeTime.xyz+startPosition,worldRotation);\n  #endif\n  \n  if(u_SimulationSpace==0)\n    finalPosition=finalPosition+a_SimulationWorldPostion;\n  else if(u_SimulationSpace==1) \n    finalPosition=finalPosition+u_WorldPosition;\n  \n  finalPosition+=0.5*gravityVelocity*age;\n \n  return  finalPosition;\n}\n\n\nvec4 computeParticleColor(in vec4 color,in float normalizedAge)\n{\n\t#ifdef COLOROVERLIFETIME\n\t  color*=getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge);\n\t#endif\n\t\n\t#ifdef RANDOMCOLOROVERLIFETIME\n\t  color*=mix(getColorFromGradient(u_ColorOverLifeGradientAlphas,u_ColorOverLifeGradientColors,normalizedAge),getColorFromGradient(u_MaxColorOverLifeGradientAlphas,u_MaxColorOverLifeGradientColors,normalizedAge),a_Random0.y);\n\t#endif\n\n    return color;\n}\n\nvec2 computeParticleSizeBillbard(in vec2 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec2(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec2(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n\n#ifdef RENDERMODE_MESH\nvec3 computeParticleSizeMesh(in vec3 size,in float normalizedAge)\n{\n\t#ifdef SIZEOVERLIFETIMECURVE\n\t\tsize*=getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge);\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVES\n\t    size*=mix(getCurValueFromGradientFloat(u_SOLSizeGradient,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMax,normalizedAge),a_Random0.z); \n\t#endif\n\t#ifdef SIZEOVERLIFETIMECURVESEPERATE\n\t\tsize*=vec3(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge));\n\t#endif\n\t#ifdef SIZEOVERLIFETIMERANDOMCURVESSEPERATE\n\t    size*=vec3(mix(getCurValueFromGradientFloat(u_SOLSizeGradientX,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxX,normalizedAge),a_Random0.z)\n\t    ,mix(getCurValueFromGradientFloat(u_SOLSizeGradientY,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxY,normalizedAge),a_Random0.z)\n\t\t,mix(getCurValueFromGradientFloat(u_SOLSizeGradientZ,normalizedAge),getCurValueFromGradientFloat(u_SOLSizeGradientMaxZ,normalizedAge),a_Random0.z));\n\t#endif\n\treturn size;\n}\n#endif\n\nfloat computeParticleRotationFloat(in float rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConstSeprarate.z*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConstSeprarate.z,u_ROLAngularVelocityConstMaxSeprarate.z,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n\n#if defined(RENDERMODE_MESH)&&(defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE))\nvec3 computeParticleRotationVec3(in vec3 rotation,in float age,in float normalizedAge)\n{ \n\t#ifdef ROTATIONOVERLIFETIME\n\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tfloat ageRot=u_ROLAngularVelocityConst*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge);\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tfloat ageRot=mix(u_ROLAngularVelocityConst,u_ROLAngularVelocityConstMax,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradient,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMax,normalizedAge),a_Random0.w);\n\t\t#endif\n\t#endif\n\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t#ifdef ROTATIONOVERLIFETIMECONSTANT\n\t\t\tvec3 ageRot=u_ROLAngularVelocityConstSeprarate*age;\n\t        rotation+=ageRot;\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMECURVE\n\t\t\trotation+=vec3(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge));\n\t\t#endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCONSTANTS\n\t\t\tvec3 ageRot=mix(u_ROLAngularVelocityConstSeprarate,u_ROLAngularVelocityConstMaxSeprarate,a_Random0.w)*age;\n\t        rotation+=ageRot;\n\t    #endif\n\t\t#ifdef ROTATIONOVERLIFETIMERANDOMCURVES\n\t\t\trotation+=vec3(mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientX,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxX,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientY,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxY,normalizedAge),a_Random0.w)\n\t        ,mix(getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientZ,normalizedAge),getTotalValueFromGradientFloat(u_ROLAngularVelocityGradientMaxZ,normalizedAge),a_Random0.w));\n\t\t#endif\n\t#endif\n\treturn rotation;\n}\n#endif\n\nvec2 computeParticleUV(in vec2 uv,in float normalizedAge)\n{ \n\t#ifdef TEXTURESHEETANIMATIONCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat frame=getFrameFromGradient(u_TSAGradientUVs,cycleNormalizedAge-floor(cycleNormalizedAge));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\t#ifdef TEXTURESHEETANIMATIONRANDOMCURVE\n\t\tfloat cycleNormalizedAge=normalizedAge*u_TSACycles;\n\t\tfloat uvNormalizedAge=cycleNormalizedAge-floor(cycleNormalizedAge);\n\t    float frame=floor(mix(getFrameFromGradient(u_TSAGradientUVs,uvNormalizedAge),getFrameFromGradient(u_TSAMaxGradientUVs,uvNormalizedAge),a_Random1.x));\n\t\tfloat totalULength=frame*u_TSASubUVLength.x;\n\t\tfloat floorTotalULength=floor(totalULength);\n\t    uv.x+=totalULength-floorTotalULength;\n\t\tuv.y+=floorTotalULength*u_TSASubUVLength.y;\n    #endif\n\treturn uv;\n}\n\nvoid main()\n{\n\tfloat age = u_CurrentTime - a_DirectionTime.w;\n\tfloat normalizedAge = age/a_ShapePositionStartLifeTime.w;\n\tvec3 lifeVelocity;\n\tif(normalizedAge<1.0){ \n\tvec3 startVelocity=a_DirectionTime.xyz*a_StartSpeed;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t\tlifeVelocity= computeParticleLifeVelocity(normalizedAge);//计算粒子生命周期速度\n\t#endif \n\tvec3 gravityVelocity=u_Gravity*age;\n\t\n\tvec4 worldRotation;\n\tif(u_SimulationSpace==0)\n\t\tworldRotation=a_SimulationWorldRotation;\n\telse\n\t\tworldRotation=u_WorldRotation;\n\t\n\tvec3 center=computeParticlePosition(startVelocity, lifeVelocity, age, normalizedAge,gravityVelocity,worldRotation);//计算粒子位置\n   \n   \n   #ifdef SPHERHBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        vec3 cameraUpVector =normalize(u_CameraUp);//TODO:是否外面归一化\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n        vec3 upVector = normalize(cross(sideVector,u_CameraDirection));\n\t    corner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z,age,normalizedAge));\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,rotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\tfloat c = cos(rot);\n\t\t\t\tfloat s = sin(rot);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter += u_SizeScale.xzy*rotationByEuler(corner.x*sideVector+corner.y*upVector,a_StartRotation0);\n\t\t\t}\n\t\t\telse{\n\t\t\t\tfloat c = cos(a_StartRotation0.x);\n\t\t\t\tfloat s = sin(a_StartRotation0.x);\n\t\t\t\tmat2 rotation= mat2(c, -s, s, c);\n\t\t\t\tcorner=rotation*corner;\n\t\t\t\tcenter += u_SizeScale.xzy*(corner.x*sideVector+corner.y*upVector);\n\t\t\t}\n\t\t#endif\n   #endif\n   \n   #ifdef STRETCHEDBILLBOARD\n\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n\tvec3 velocity;\n\t#if defined(VELOCITYOVERLIFETIMECONSTANT)||defined(VELOCITYOVERLIFETIMECURVE)||defined(VELOCITYOVERLIFETIMERANDOMCONSTANT)||defined(VELOCITYOVERLIFETIMERANDOMCURVE)\n\t    if(u_VOLSpaceType==0)\n\t\t  velocity=rotationByQuaternions(u_SizeScale*(startVelocity+lifeVelocity),worldRotation)+gravityVelocity;\n\t    else\n\t\t  velocity=rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+lifeVelocity+gravityVelocity;\n    #else\n\t    velocity= rotationByQuaternions(u_SizeScale*startVelocity,worldRotation)+gravityVelocity;\n    #endif\t\n\t\tvec3 cameraUpVector = normalize(velocity);\n\t\tvec3 direction = normalize(center-u_CameraPosition);\n        vec3 sideVector = normalize(cross(direction,normalize(velocity)));\n\t\t\n\t\tsideVector=u_SizeScale.xzy*sideVector;\n\t\tcameraUpVector=length(vec3(u_SizeScale.x,0.0,0.0))*cameraUpVector;\n\t\t\n\t    vec2 size=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n\t\t\n\t    const mat2 rotaionZHalfPI=mat2(0.0, -1.0, 1.0, 0.0);\n\t    corner=rotaionZHalfPI*corner;\n\t    corner.y=corner.y-abs(corner.y);\n\t\t\n\t    float speed=length(velocity);//TODO:\n\t    center +=sign(u_SizeScale.x)*(sign(u_StretchedBillboardLengthScale)*size.x*corner.x*sideVector+(speed*u_StretchedBillboardSpeedScale+size.y*u_StretchedBillboardLengthScale)*corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef HORIZONTALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector=vec3(0.0,0.0,1.0);\n\t    const vec3 sideVector = vec3(-1.0,0.0,0.0);\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef VERTICALBILLBOARD\n\t\tvec2 corner=a_CornerTextureCoordinate.xy;//Billboard模式z轴无效\n        const vec3 cameraUpVector =vec3(0.0,1.0,0.0);\n        vec3 sideVector = normalize(cross(u_CameraDirection,cameraUpVector));\n\t\t\n\t\tfloat rot = computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n        float c = cos(rot);\n        float s = sin(rot);\n        mat2 rotation= mat2(c, -s, s, c);\n\t    corner=rotation*corner*cos(0.78539816339744830961566084581988);//TODO:临时缩小cos45,不确定U3D原因\n\t\tcorner*=computeParticleSizeBillbard(a_StartSize.xy,normalizedAge);\n        center +=u_SizeScale.xzy*(corner.x*sideVector+ corner.y*cameraUpVector);\n   #endif\n   \n   #ifdef RENDERMODE_MESH\n\t    vec3 size=computeParticleSizeMesh(a_StartSize,normalizedAge);\n\t\t#if defined(ROTATIONOVERLIFETIME)||defined(ROTATIONOVERLIFETIMESEPERATE)\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tvec3 rotation=vec3(a_StartRotation0.xy,computeParticleRotationFloat(a_StartRotation0.z, age,normalizedAge));\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,rotation),worldRotation);\n\t\t\t}\n\t\t\telse{\n\t\t\t\t#ifdef ROTATIONOVERLIFETIME\n\t\t\t\t\tfloat angle=computeParticleRotationFloat(a_StartRotation0.x, age,normalizedAge);\n\t\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),angle),worldRotation));//已验证\n\t\t\t\t\t}\n\t\t\t\t\telse{\n\t\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\t\tcenter+= u_SizeScale.xzy*(rotationByQuaternions(rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),angle),worldRotation));\n\t\t\t\t\t\t#else\n\t\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\t\tcenter+=rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle);//已验证\n\t\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\t\tcenter+=rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),angle),worldRotation);//已验证\n\t\t\t\t\t\t#endif\n\t\t\t\t\t}\n\t\t\t\t#endif\n\t\t\t\t#ifdef ROTATIONOVERLIFETIMESEPERATE\n\t\t\t\t\t//TODO:是否应合并if(u_ThreeDStartRotation)分支代码,待测试\n\t\t\t\t\tvec3 angle=computeParticleRotationVec3(vec3(0.0,0.0,-a_StartRotation0.x), age,normalizedAge);\n\t\t\t\t\tcenter+= (rotationByQuaternions(rotationByEuler(u_SizeScale*a_MeshPosition*size,vec3(angle.x,angle.y,angle.z)),worldRotation));//已验证\n\t\t\t\t#endif\t\t\n\t\t\t}\n\t\t#else\n\t\t\tif(u_ThreeDStartRotation){\n\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByEuler(a_MeshPosition*size,a_StartRotation0),worldRotation);//已验证\n\t\t\t}\n\t\t\telse{\n\t\t\t\tif(a_ShapePositionStartLifeTime.x!=0.0||a_ShapePositionStartLifeTime.y!=0.0){\n\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x);\n\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\tcenter+= (rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,normalize(cross(vec3(0.0,0.0,1.0),vec3(a_ShapePositionStartLifeTime.xy,0.0))),a_StartRotation0.x),worldRotation));//已验证\n\t\t\t\t}\n\t\t\t\telse{\n\t\t\t\t\t#ifdef SHAPE\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,-1.0,0.0),a_StartRotation0.x),worldRotation);\t\n\t\t\t\t\t#else\n\t\t\t\t\t\tif(u_SimulationSpace==0)\n\t\t\t\t\t\t\tcenter+= rotationByAxis(u_SizeScale*a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x);\n\t\t\t\t\t\telse if(u_SimulationSpace==1)\n\t\t\t\t\t\t\tcenter+= rotationByQuaternions(u_SizeScale*rotationByAxis(a_MeshPosition*size,vec3(0.0,0.0,-1.0),a_StartRotation0.x),worldRotation);//已验证\n\t\t\t\t\t#endif\n\t\t\t\t}\n\t\t\t}\n\t\t#endif\n\t\tv_MeshColor=a_MeshColor;\n   #endif\n   \n    gl_Position=u_Projection*u_View*vec4(center,1.0);\n    v_Color = computeParticleColor(a_StartColor, normalizedAge);\n\t#ifdef DIFFUSEMAP\n\t\t#if defined(SPHERHBILLBOARD)||defined(STRETCHEDBILLBOARD)||defined(HORIZONTALBILLBOARD)||defined(VERTICALBILLBOARD)\n\t\t\tv_TextureCoordinate =computeParticleUV(a_CornerTextureCoordinate.zw, normalizedAge);\n\t\t#endif\n\t\t#ifdef RENDERMODE_MESH\n\t\t\tv_TextureCoordinate =computeParticleUV(a_MeshTextureCoordinate, normalizedAge);\n\t\t#endif\n\t\t\n\t\t#ifdef TILINGOFFSET\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y)*u_TilingOffset.xy+vec2(u_TilingOffset.z,-u_TilingOffset.w);//需要特殊处理\n\t\t\tv_TextureCoordinate=vec2(v_TextureCoordinate.x,1.0-v_TextureCoordinate.y);//需要特殊处理\n\t\t#endif\n\t#endif\n    v_Discard=0.0;\n\t  \n\t#ifdef FOG\n\t\tv_PositionWorld=center;\n\t#endif\n   }\n   else\n\t{\n\t\tv_Discard=1.0;\n\t}\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n\n',Q="#ifdef HIGHPRECISION\n  precision highp float;\n#else\n  precision mediump float;\n#endif\n\nvarying float v_Discard;\nvarying vec4 v_Color;\nvarying vec2 v_TextureCoordinate;\nuniform sampler2D u_texture;\nuniform vec4 u_Tintcolor;\n\n#ifdef RENDERMODE_MESH\n\tvarying vec4 v_MeshColor;\n#endif\n\n#ifdef FOG\n\tvarying vec3 v_PositionWorld;\n\tuniform vec3 u_CameraPosition;\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\t#ifdef ADDTIVEFOG\n\t#else\n\t\tuniform vec3 u_FogColor;\n\t#endif\n#endif\n\n\nvoid main()\n{\t\n\t#ifdef RENDERMODE_MESH\n\t\tgl_FragColor=v_MeshColor;\n\t#else\n\t\tgl_FragColor=vec4(1.0);\t\n\t#endif\n\t\t\n\t#ifdef DIFFUSEMAP\n\t\tif(v_Discard!=0.0)\n\t\t\tdiscard;\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=texture2D(u_texture,v_TextureCoordinate)*v_Color;\n\t\t#endif\n\t#else\n\t\t#ifdef TINTCOLOR\n\t\t\tgl_FragColor*=u_Tintcolor*2.0*v_Color;\n\t\t#else\n\t\t\tgl_FragColor*=v_Color;\n\t\t#endif\n\t#endif\n\t\n\t#ifdef FOG\n\t\tvec3 toEye=u_CameraPosition-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t\t\n\t\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\t\t#ifdef ADDTIVEFOG\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,vec3(0.0,0.0,0.0),lerpFact);\n\t\t#else\n\t\t\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n\t\t#endif\n\t#endif\n}",e=Bq.add("PARTICLESHURIKEN"),F=new FQ(m,a,Oa.shaderDefines,Fa.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_Position:0},a={u_TintColor:1,u_Exposure:1,u_Rotation:1,u_CubeTexture:1,u_MvpMatrix:3},q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nuniform mat4 u_MvpMatrix;\nuniform float u_Rotation;\nvarying vec3 v_Texcoord;\n\n\nvec4 rotateAroundYInDegrees (vec4 vertex, float degrees)\n{\n\tfloat angle = degrees * 3.141593 / 180.0;\n\tfloat sina=sin(angle);\n\tfloat cosa=cos(angle);\n\tmat2 m = mat2(cosa, -sina, sina, cosa);\n\treturn vec4(m*vertex.xz, vertex.yw).xzyw;\n}\n\t\t\nvoid main()\n{\n\tvec4 position=rotateAroundYInDegrees(a_Position,u_Rotation);\n\tgl_Position = (u_MvpMatrix*position).xyww;\n\tv_Texcoord=vec3(-a_Position.x,a_Position.yz);//转换坐标系\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n',Q="#ifdef HIGHPRECISION\nprecision highp float;\n#else\nprecision mediump float;\n#endif\n\nvarying vec3 v_Texcoord;\n\nuniform samplerCube u_CubeTexture;\nuniform float u_Exposure;\nuniform vec4 u_TintColor;\n\n\nvoid main()\n{\t\n\tvec3 color=textureCube(u_CubeTexture, v_Texcoord).rgb*u_TintColor.rgb*u_Exposure*2.0;\n\tgl_FragColor=vec4(color,1.0);\n}\n\n",e=Bq.add("SkyBox"),F=new FQ(m,a),e.addSubShader(F),F.addShaderPass(q,Q),m={a_Position:0},a={u_SunSize:1,u_SunSizeConvergence:1,u_AtmosphereThickness:1,u_SkyTint:1,u_GroundTint:1,u_Exposure:1,u_MvpMatrix:3,"u_DirectionLight.Direction":4,"u_DirectionLight.Color":4},q="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include \"Lighting.glsl\";\n\n#define OUTER_RADIUS 1.025\n#define RAYLEIGH (mix(0.0, 0.0025, pow(u_AtmosphereThickness,2.5)))// Rayleigh constant Rayleigh为夜空光和极光亮度单位\n#define MIE 0.0010             // Mie constant 米氏散射\n#define SUN_BRIGHTNESS 20.0    // Sun brightness\n#define MAX_SCATTER 50.0 // Maximum scattering value, to prevent math overflows on Adrenos\n\nconst float SKY_GROUND_THRESHOLD = 0.02;\nconst float outerRadius = OUTER_RADIUS;\nconst float outerRadius2 = OUTER_RADIUS*OUTER_RADIUS;\nconst float innerRadius = 1.0;\nconst float innerRadius2 = 1.0;\nconst float cameraHeight = 0.0001;\n\nconst float HDSundiskIntensityFactor = 15.0;\nconst float simpleSundiskIntensityFactor = 27.0;\n\nconst float sunScale = 400.0 * SUN_BRIGHTNESS;\nconst float kmESun = MIE * SUN_BRIGHTNESS;\nconst float km4PI = MIE * 4.0 * 3.14159265;\nconst float scale = 1.0 / (OUTER_RADIUS - 1.0);\nconst float scaleDepth = 0.25;\nconst float scaleOverScaleDepth = (1.0 / (OUTER_RADIUS - 1.0)) / 0.25;\nconst float samples = 2.0; // THIS IS UNROLLED MANUALLY, DON'T TOUCH\n\n// RGB wavelengths        .35 (.62=158), .43 (.68=174), .525 (.75=190)\nconst vec3 c_DefaultScatteringWavelength = vec3(0.65, 0.57, 0.475);//默认散射波长\nconst vec3 c_VariableRangeForScatteringWavelength = vec3(0.15, 0.15, 0.15);//散射播放的可变范围\n\nattribute vec4 a_Position;\n\nuniform mat4 u_MvpMatrix;\nuniform vec3 u_SkyTint;\nuniform vec3 u_GroundTint;\nuniform float u_Exposure;\nuniform float u_AtmosphereThickness;\nuniform DirectionLight u_DirectionLight;\n\nvarying vec3 v_GroundColor;\nvarying vec3 v_SkyColor;\n\n#ifdef SUN_HIGH_QUALITY\n\tvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\n\tvarying vec3 v_RayDir;\n#else\n\tvarying float v_SkyGroundFactor;\n#endif\n\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\tvarying vec3 v_SunColor;\n#endif\n\n// Calculates the Rayleigh phase function\nfloat getRayleighPhase(vec3 light, vec3 ray) \n{\n\tfloat eyeCos = dot(light, ray);\n\treturn 0.75 + 0.75*eyeCos*eyeCos;\n}\n\nfloat scaleAngle(float inCos)\n{\n\tfloat x = 1.0 - inCos;\n\treturn 0.25 * exp(-0.00287 + x*(0.459 + x*(3.83 + x*(-6.80 + x*5.25))));\n}\n\n\nvoid main () {\n\tgl_Position = (u_MvpMatrix*a_Position).xyww;\n\n\tvec3 skyTintInGammaSpace = u_SkyTint;//支持非GAMMA空间后要调整\n\tvec3 scatteringWavelength = mix(c_DefaultScatteringWavelength-c_VariableRangeForScatteringWavelength,c_DefaultScatteringWavelength+c_VariableRangeForScatteringWavelength,vec3(1.0) - skyTintInGammaSpace); // using Tint in sRGB+ gamma allows for more visually linear interpolation and to keep (0.5) at (128, gray in sRGB) point\n\tvec3 invWavelength = 1.0 / pow(scatteringWavelength, vec3(4.0));\n\n\tfloat krESun = RAYLEIGH * SUN_BRIGHTNESS;\n\tfloat kr4PI = RAYLEIGH * 4.0 * 3.14159265;\n\n\tvec3 cameraPos = vec3(0.0,innerRadius + cameraHeight,0.0); // The camera's current position\n\n\t// Get the ray from the camera to the vertex and its length (which is the far point of the ray passing through the atmosphere)\n\tvec3 eyeRay = normalize(a_Position.xyz);\n\n\tfloat far = 0.0;\n\tvec3 cIn, cOut;\n\tif (eyeRay.y >= 0.0) {// Sky\n\t\t// Calculate the length of the \"atmosphere\"\n\t\tfar = sqrt(outerRadius2 + innerRadius2 * eyeRay.y * eyeRay.y - innerRadius2) - innerRadius * eyeRay.y;\n\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\n\t\tfloat height = innerRadius + cameraHeight;\n\t\tfloat depth = exp(scaleOverScaleDepth * -cameraHeight);\n\t\tfloat startAngle = dot(eyeRay, cameraPos) / height;\n\t\tfloat startOffset = depth*scaleAngle(startAngle);\n\n\t\t// Initialize the scattering loop variables\n\t\tfloat sampleLength = far / samples;\n\t\tfloat scaledLength = sampleLength * scale;\n\t\tvec3 sampleRay = eyeRay * sampleLength;\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\n\n\t\tvec3 frontColor = vec3(0.0);\n\t\t//unrolling this manually to avoid some platform for loop slow\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat lightAngle = dot(-u_DirectionLight.Direction, samplePoint) / height;\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat lightAngle = dot(-u_DirectionLight.Direction, samplePoint) / height;\n\t\t\tfloat cameraAngle = dot(eyeRay, samplePoint) / height;\n\t\t\tfloat scatter = (startOffset + depth*(scaleAngle(lightAngle) - scaleAngle(cameraAngle)));\n\t\t\tvec3 attenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\n\t\t// Finally, scale the Mie and Rayleigh colors and set up the varying variables for the pixel shader\n\t\tcIn = frontColor * (invWavelength * krESun);\n\t\tcOut = frontColor * kmESun;\n\t} else {// Ground\n\t\tfar = (-cameraHeight) / (min(-0.001, eyeRay.y));\n\t\tvec3 pos = cameraPos + far * eyeRay;\n\n\t\t// Calculate the ray's starting position, then calculate its scattering offset\n\t\tfloat depth = exp((-cameraHeight) * (1.0/scaleDepth));\n\t\tfloat cameraAngle = dot(-eyeRay, pos);\n\t\tfloat lightAngle = dot(-u_DirectionLight.Direction, pos);\n\t\tfloat cameraScale = scaleAngle(cameraAngle);\n\t\tfloat lightScale = scaleAngle(lightAngle);\n\t\tfloat cameraOffset = depth*cameraScale;\n\t\tfloat temp = lightScale + cameraScale;\n\n\t\t// Initialize the scattering loop variables\n\t\tfloat sampleLength = far / samples;\n\t\tfloat scaledLength = sampleLength * scale;\n\t\tvec3 sampleRay = eyeRay * sampleLength;\n\t\tvec3 samplePoint = cameraPos + sampleRay * 0.5;\n\n\t\t// Now loop through the sample rays\n\t\tvec3 frontColor = vec3(0.0, 0.0, 0.0);\n\t\tvec3 attenuate;\n\n\t\t// Loop removed because we kept hitting SM2.0 temp variable limits. Doesn't affect the image too much.\n\t\t{\n\t\t\tfloat height = length(samplePoint);\n\t\t\tfloat depth = exp(scaleOverScaleDepth * (innerRadius - height));\n\t\t\tfloat scatter = depth*temp - cameraOffset;\n\t\t\tattenuate = exp(-clamp(scatter, 0.0, MAX_SCATTER) * (invWavelength * kr4PI + km4PI));\n\t\t\tfrontColor += attenuate * (depth * scaledLength);\n\t\t\tsamplePoint += sampleRay;\n\t\t}\n\n\t\tcIn = frontColor * (invWavelength * krESun + kmESun);\n\t\tcOut = clamp(attenuate, 0.0, 1.0);\n\t}\n\n\t#ifdef SUN_HIGH_QUALITY\n\t\tv_Vertex = -a_Position.xyz;\n\t#elif defined(SUN_SIMPLE) \n\t\tv_RayDir = -eyeRay;\n\t#else\n\t\tv_SkyGroundFactor = -eyeRay.y / SKY_GROUND_THRESHOLD;\n\t#endif\n\n\t// if we want to calculate color in vprog:\n\t// in case of linear: multiply by _Exposure in here (even in case of lerp it will be common multiplier, so we can skip mul in fshader)\n\tv_GroundColor = u_Exposure * (cIn + u_GroundTint*u_GroundTint * cOut);//u_GroundColor*u_GroundColor is gamma space convert to linear space\n\tv_SkyColor    = u_Exposure * (cIn * getRayleighPhase(-u_DirectionLight.Direction, -eyeRay));\n\n\t\n\t// The sun should have a stable intensity in its course in the sky. Moreover it should match the highlight of a purely specular material.\n\t// This matching was done using the Unity3D standard shader BRDF1 on the 5/31/2017\n\t// Finally we want the sun to be always bright even in LDR thus the normalization of the lightColor for low intensity.\n\tfloat lightColorIntensity = clamp(length(u_DirectionLight.Color), 0.25, 1.0);\n\n\t#ifdef SUN_HIGH_QUALITY \n\t\tv_SunColor = HDSundiskIntensityFactor * clamp(cOut,0.0,1.0) * u_DirectionLight.Color / lightColorIntensity;\n\t#elif defined(SUN_SIMPLE) \n\t\tv_SunColor = simpleSundiskIntensityFactor * clamp(cOut * sunScale,0.0,1.0) * u_DirectionLight.Color / lightColorIntensity;\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n",Q='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\nconst float MIE_G = -0.990;\nconst float MIE_G2 = 0.9801;\nconst float SKY_GROUND_THRESHOLD = 0.02;\n\nuniform float u_SunSize;\nuniform float u_SunSizeConvergence;\nuniform DirectionLight u_DirectionLight;\n\n\nvarying vec3 v_GroundColor;\nvarying vec3 v_SkyColor;\n\n\n#ifdef SUN_HIGH_QUALITY\n\tvarying vec3 v_Vertex;\n#elif defined(SUN_SIMPLE)\n\tvarying vec3 v_RayDir;\n#else\n\tvarying float v_SkyGroundFactor;\n#endif\n\n#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\tvarying vec3 v_SunColor;\n#endif\n\n// Calculates the Mie phase function\nfloat getMiePhase(float eyeCos, float eyeCos2) {\n\tfloat temp = 1.0 + MIE_G2 - 2.0 * MIE_G * eyeCos;\n\ttemp = pow(temp, pow(u_SunSize,0.65) * 10.0);\n\ttemp = max(temp,1.0e-4); // prevent division by zero, esp. in half precision\n\ttemp = 1.5 * ((1.0 - MIE_G2) / (2.0 + MIE_G2)) * (1.0 + eyeCos2) / temp;\n\treturn temp;\n}\n\n// Calculates the sun shape\nfloat calcSunAttenuation(vec3 lightPos, vec3 ray) {\n\t#ifdef SUN_HIGH_QUALITY\n\t\tfloat focusedEyeCos = pow(clamp(dot(lightPos, ray),0.0,1.0), u_SunSizeConvergence);\n\t\treturn getMiePhase(-focusedEyeCos, focusedEyeCos * focusedEyeCos);\n\t#else //SUN_SIMPLE\n\t\tvec3 delta = lightPos - ray;\n\t\tfloat dist = length(delta);\n\t\tfloat spot = 1.0 - smoothstep(0.0, u_SunSize, dist);\n\t\treturn spot * spot;\n\t#endif\n}\n\nvoid main() {\n\t// if y > 1 [eyeRay.y < -SKY_GROUND_THRESHOLD] - ground\n\t// if y >= 0 and < 1 [eyeRay.y <= 0 and > -SKY_GROUND_THRESHOLD] - horizon\n\t// if y < 0 [eyeRay.y > 0] - sky\n\tvec3 col = vec3(0.0, 0.0, 0.0);\n\n\t#ifdef SUN_HIGH_QUALITY\n\t\tvec3 ray = normalize(v_Vertex);\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\n\t#elif defined(SUN_SIMPLE) \n\t\tvec3 ray = v_RayDir;\n\t\tfloat y = ray.y / SKY_GROUND_THRESHOLD;\t\n\t#else\n\t\tfloat y = v_SkyGroundFactor;\n\t#endif\n\n\t// if we did precalculate color in vprog: just do lerp between them\n\tcol = mix(v_SkyColor, v_GroundColor, clamp(y,0.0,1.0));\n\n\t#if defined(SUN_HIGH_QUALITY)||defined(SUN_SIMPLE)\n\t\tif (y < 0.0)\n\t\t\tcol += v_SunColor * calcSunAttenuation(-u_DirectionLight.Direction, -ray);\n\t#endif\n\n\tcol = sqrt(col);//linear space convert to gamma space\n\tgl_FragColor=vec4(col,1.0);\n}\n\n',e=Bq.add("SkyBoxProcedural"),F=new FQ(m,a,null,ma.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q),m={a_Position:0,a_Normal:3,a_Texcoord0:2},a={u_MvpMatrix:2,u_WorldMat:2,u_CameraPos:3,u_LightmapScaleOffset:2,u_LightMap:2,u_SplatAlphaTexture:1,u_DiffuseTexture1:1,u_DiffuseTexture2:1,u_DiffuseTexture3:1,u_DiffuseTexture4:1,u_DiffuseTexture5:1,u_DiffuseScaleOffset1:1,u_DiffuseScaleOffset2:1,u_DiffuseScaleOffset3:1,u_DiffuseScaleOffset4:1,u_DiffuseScaleOffset5:1,u_FogStart:4,u_FogRange:4,u_FogColor:4,"u_DirectionLight.Direction":4,"u_DirectionLight.Color":4,"u_PointLight.Position":4,"u_PointLight.Range":4,"u_PointLight.Attenuation":4,"u_PointLight.Color":4,"u_SpotLight.Position":4,"u_SpotLight.Direction":4,"u_SpotLight.Range":4,"u_SpotLight.Spot":4,"u_SpotLight.Color":4,u_AmbientColor:4,u_shadowMap1:4,u_shadowMap2:4,u_shadowMap3:4,u_shadowPSSMDistance:4,u_lightShadowVP:4,u_shadowPCFoffset:4},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13},q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec2 a_Texcoord0;\n\nuniform mat4 u_MvpMatrix;\n\nvarying vec2 v_Texcoord0;\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(LIGHTMAP)\n\tattribute vec3 a_Normal;\n\tvarying vec3 v_Normal;\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\tuniform mat4 u_WorldMat;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef LIGHTMAP\n\tvarying vec2 v_LightMapUV;\n\tuniform vec4 u_LightmapScaleOffset;\n#endif\n\n#ifdef RECEIVESHADOW\n\tvarying float v_posViewZ;\n\t#ifdef SHADOWMAP_PSSM1 \n\t\tvarying vec4 v_lightMVPPos;\n\t\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n#endif\n\nvoid main()\n{\n\tgl_Position = u_MvpMatrix * a_Position;\n  \n\tv_Texcoord0 = a_Texcoord0;\n  \n\t#ifdef LIGHTMAP\n\t\tv_LightMapUV = vec2(a_Texcoord0.x, 1.0 - a_Texcoord0.y) * u_LightmapScaleOffset.xy + u_LightmapScaleOffset.zw;\n\t\tv_LightMapUV.y = 1.0 - v_LightMapUV.y;\n\t#endif\n  \n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t\tv_Normal = a_Normal;\n\t#endif\n\n\t#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)||(defined(RECEIVESHADOW)&&defined(SHADOWMAP_PSSM1))\n\t\tv_PositionWorld=(u_WorldMat*a_Position).xyz;\n\t#endif\n\n\t#ifdef RECEIVESHADOW\n\t\tv_posViewZ = gl_Position.w;\n\t\t#ifdef SHADOWMAP_PSSM1\n\t\t\tv_lightMVPPos = u_lightShadowVP[0] * vec4(v_PositionWorld,1.0);\n\t\t#endif\n\t#endif\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',Q='#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Lighting.glsl";\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tuniform vec3 u_CameraPos;\n\tvarying vec3 v_Normal;\n\tvarying vec3 v_PositionWorld;\n#endif\n\n#ifdef FOG\n\tuniform float u_FogStart;\n\tuniform float u_FogRange;\n\tuniform vec3 u_FogColor;\n#endif\n\n\n#ifdef DIRECTIONLIGHT\n\tuniform DirectionLight u_DirectionLight;\n#endif\n\n#ifdef POINTLIGHT\n\tuniform PointLight u_PointLight;\n#endif\n\n#ifdef SPOTLIGHT\n\tuniform SpotLight u_SpotLight;\n#endif\n\n#include "ShadowHelper.glsl"\n#ifdef RECEIVESHADOW\n\t#if defined(SHADOWMAP_PSSM2)||defined(SHADOWMAP_PSSM3)\n\tuniform mat4 u_lightShadowVP[4];\n\t#endif\n\t#ifdef SHADOWMAP_PSSM1 \n\tvarying vec4 v_lightMVPPos;\n\t#endif\n#endif\nvarying float v_posViewZ;\n\nuniform vec3 u_AmbientColor;\n\nuniform sampler2D u_SplatAlphaTexture;\n\nuniform sampler2D u_DiffuseTexture1;\nuniform sampler2D u_DiffuseTexture2;\nuniform sampler2D u_DiffuseTexture3;\nuniform sampler2D u_DiffuseTexture4;\nuniform sampler2D u_DiffuseTexture5;\n\nuniform vec4 u_DiffuseScaleOffset1;\nuniform vec4 u_DiffuseScaleOffset2;\nuniform vec4 u_DiffuseScaleOffset3;\nuniform vec4 u_DiffuseScaleOffset4;\nuniform vec4 u_DiffuseScaleOffset5;\n\nvarying vec2 v_Texcoord0;\n\n#ifdef LIGHTMAP\n\tuniform sampler2D u_LightMap;\n\tvarying vec2 v_LightMapUV;\n#endif\n\nvoid main()\n{\n\tvec4 splatAlpha = vec4(1.0);\n\t#ifdef ExtendTerrain_DETAIL_NUM1\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r;\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM2\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r + color2.xyz * (1.0 - splatAlpha.r);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM3\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * (1.0 - splatAlpha.r - splatAlpha.g);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM4\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b);\n\t#endif\n\t#ifdef ExtendTerrain_DETAIL_NUM5\n\t\tsplatAlpha = texture2D(u_SplatAlphaTexture, v_Texcoord0);\n\t\tvec4 color1 = texture2D(u_DiffuseTexture1, v_Texcoord0 * u_DiffuseScaleOffset1.xy);\n\t\tvec4 color2 = texture2D(u_DiffuseTexture2, v_Texcoord0 * u_DiffuseScaleOffset2.xy);\n\t\tvec4 color3 = texture2D(u_DiffuseTexture3, v_Texcoord0 * u_DiffuseScaleOffset3.xy);\n\t\tvec4 color4 = texture2D(u_DiffuseTexture4, v_Texcoord0 * u_DiffuseScaleOffset4.xy);\n\t\tvec4 color5 = texture2D(u_DiffuseTexture5, v_Texcoord0 * u_DiffuseScaleOffset5.xy);\n\t\tgl_FragColor.xyz = color1.xyz * splatAlpha.r  + color2.xyz * splatAlpha.g + color3.xyz * splatAlpha.b + color4.xyz * splatAlpha.a + color5.xyz * (1.0 - splatAlpha.r - splatAlpha.g - splatAlpha.b - splatAlpha.a);\n\t#endif\n\t\tgl_FragColor.w = splatAlpha.a;\n\t\t\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n    vec3 normal = v_Normal;\n\tvec3 dif, spe;\n#endif\n\nvec3 diffuse = vec3(0.0);\nvec3 specular= vec3(0.0);\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)||defined(FOG)\n\tvec3 toEye;\n\t#ifdef FOG\n\t\ttoEye=u_CameraPos-v_PositionWorld;\n\t\tfloat toEyeLength=length(toEye);\n\t\ttoEye/=toEyeLength;\n\t#else\n\t\ttoEye=normalize(u_CameraPos-v_PositionWorld);\n\t#endif\n#endif\n\n#ifdef DIRECTIONLIGHT\n\tLayaAirBlinnPhongDiectionLight(vec3(0.0), 1.0, normal, vec3(1.0), toEye,u_DirectionLight, dif, spe);\n\tdiffuse+=dif;\n\tspecular+=spe;\n#endif\n \n#ifdef POINTLIGHT\n\tLayaAirBlinnPhongPointLight(v_PositionWorld, vec3(0.0), 1.0, normal, vec3(1.0), toEye, u_PointLight, dif, spe);\n\tdiffuse+=dif;\n\tspecular+=spe;\n#endif\n\n#ifdef SPOTLIGHT\n\tLayaAirBlinnPhongSpotLight(v_PositionWorld, vec3(0.0), 1.0, normal, vec3(1.0), toEye, u_SpotLight, dif, spe);\n\tdiffuse+=dif;\n\tspecular+=spe;\n#endif\n\nvec3 globalDiffuse = u_AmbientColor;\n#ifdef LIGHTMAP\n\tglobalDiffuse += DecodeLightmap(texture2D(u_LightMap, v_LightMapUV));\n#endif\n\n#ifdef RECEIVESHADOW\n\tfloat shadowValue = 1.0;\n\t#ifdef SHADOWMAP_PSSM3\n\t\tshadowValue = getShadowPSSM3( u_shadowMap1,u_shadowMap2,u_shadowMap3,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif\n\t#ifdef SHADOWMAP_PSSM2\n\t\tshadowValue = getShadowPSSM2( u_shadowMap1,u_shadowMap2,u_lightShadowVP,u_shadowPSSMDistance,u_shadowPCFoffset,v_PositionWorld,v_posViewZ,0.001);\n\t#endif \n\t#ifdef SHADOWMAP_PSSM1\n\t\tshadowValue = getShadowPSSM1( u_shadowMap1,v_lightMVPPos,u_shadowPSSMDistance,u_shadowPCFoffset,v_posViewZ,0.001);\n\t#endif\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse) * shadowValue, gl_FragColor.a);\n#else\n\tgl_FragColor = vec4(gl_FragColor.rgb * (globalDiffuse + diffuse), gl_FragColor.a);\n#endif\n\n#if defined(DIRECTIONLIGHT)||defined(POINTLIGHT)||defined(SPOTLIGHT)\n\t#ifdef RECEIVESHADOW\n\t\tgl_FragColor.rgb += specular * shadowValue;\n\t#else\n\t\tgl_FragColor.rgb += specular;\n\t#endif\n#endif\n\n#ifdef FOG\n\tfloat lerpFact=clamp((toEyeLength-u_FogStart)/u_FogRange,0.0,1.0);\n\tgl_FragColor.rgb=mix(gl_FragColor.rgb,u_FogColor,lerpFact);\n#endif\n}\n\n\n\n\n\n',e=Bq.add("ExtendTerrain"),F=new FQ(m,a,Im.shaderDefines,Da.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_Position:0,a_OffsetVector:1,a_Texcoord0X:4,a_Texcoord0Y:3,a_BirthTime:2},a={u_MvpMatrix:2,u_View:3,u_Projection:3,u_TilingOffset:1,u_MainTexture:1,u_MainColor:1,u_CurTime:2,u_LifeTime:2,u_WidthCurve:2,u_WidthCurveKeyLength:2,u_GradientColorkey:2,u_GradientAlphakey:2},w={s_Cull:0,s_Blend:1,s_BlendSrc:2,s_BlendDst:3,s_DepthTest:12,s_DepthWrite:13},q='#include "Lighting.glsl";\n\nattribute vec3 a_Position;\nattribute vec3 a_OffsetVector;\nattribute vec4 a_Color;\nattribute float a_Texcoord0X;\nattribute float a_Texcoord0Y;\nattribute float a_BirthTime;\n\nuniform mat4 u_View;\nuniform mat4 u_Projection;\n\nuniform vec4 u_TilingOffset;\n\nuniform float u_CurTime;\nuniform float u_LifeTime;\nuniform vec4 u_WidthCurve[10];\nuniform int u_WidthCurveKeyLength;\n\nuniform vec4 u_GradientColorkey[10];\nuniform vec2 u_GradientAlphakey[10];\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nfloat hermiteInterpolate(float t, float outTangent, float inTangent, float duration, float value1, float value2)\n{\n\tfloat t2 = t * t;\n\tfloat t3 = t2 * t;\n\tfloat a = 2.0 * t3 - 3.0 * t2 + 1.0;\n\tfloat b = t3 - 2.0 * t2 + t;\n\tfloat c = t3 - t2;\n\tfloat d = -2.0 * t3 + 3.0 * t2;\n\treturn a * value1 + b * outTangent * duration + c * inTangent * duration + d * value2;\n}\n\nfloat getCurWidth(in float normalizeTime)\n{\n\tfloat width;\n\tif(normalizeTime == 0.0){\n\t\twidth=u_WidthCurve[0].w;\n\t}\n\telse if(normalizeTime >= 1.0){\n\t\twidth=u_WidthCurve[u_WidthCurveKeyLength - 1].w;\n\t}\n\telse{\n\t\tfor(int i = 0; i < 10; i ++ )\n\t\t{\n\t\t\tif(normalizeTime == u_WidthCurve[i].x){\n\t\t\t\twidth=u_WidthCurve[i].w;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\t\n\t\t\tvec4 lastFrame = u_WidthCurve[i];\n\t\t\tvec4 nextFrame = u_WidthCurve[i + 1];\n\t\t\tif(normalizeTime > lastFrame.x && normalizeTime < nextFrame.x)\n\t\t\t{\n\t\t\t\tfloat duration = nextFrame.x - lastFrame.x;\n\t\t\t\tfloat t = (normalizeTime - lastFrame.x) / duration;\n\t\t\t\tfloat outTangent = lastFrame.z;\n\t\t\t\tfloat inTangent = nextFrame.y;\n\t\t\t\tfloat value1 = lastFrame.w;\n\t\t\t\tfloat value2 = nextFrame.w;\n\t\t\t\twidth=hermiteInterpolate(t, outTangent, inTangent, duration, value1, value2);\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\treturn width;\n}\t\n\nvec4 getColorFromGradientByBlend(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tfloat colorKey = gradientColor.x;\n\t\tif(colorKey >= normalizeTime)\n\t\t{\n\t\t\tvec4 lastGradientColor = gradientColors[i-1];\n\t\t\tfloat lastColorKey = lastGradientColor.x;\n\t\t\tfloat age = (normalizeTime - lastColorKey) / (colorKey - lastColorKey);\n\t\t\tcolor.rgb = mix(gradientColors[i-1].yzw, gradientColor.yzw, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tfloat alphaKey = gradientAlpha.x;\n\t\tif(alphaKey >= normalizeTime)\n\t\t{\n\t\t\tvec2 lastGradientAlpha = gradientAlphas[i-1];\n\t\t\tfloat lastAlphaKey = lastGradientAlpha.x;\n\t\t\tfloat age = (normalizeTime - lastAlphaKey) / (alphaKey - lastAlphaKey);\n\t\t\tcolor.a = mix(lastGradientAlpha.y, gradientAlpha.y, age);\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvec4 getColorFromGradientByFixed(in vec4 gradientColors[10], in vec2 gradientAlphas[10], in float normalizeTime)\n{\n\tvec4 color;\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec4 gradientColor = gradientColors[i];\n\t\tif(gradientColor.w >= normalizeTime)\n\t\t{\n\t\t\tcolor.rgb = gradientColor.xyz;\n\t\t\tbreak;\n\t\t}\n\t}\n\tfor(int i = 1; i < 10; i++)\n\t{\n\t\tvec2 gradientAlpha = gradientAlphas[i];\n\t\tif(gradientAlpha.y >= normalizeTime)\n\t\t{\n\t\t\tcolor.a = gradientAlpha.x;\n\t\t\tbreak;\n\t\t}\n\t}\n\treturn color;\n}\n\nvoid main()\n{\n\tfloat normalizeTime = (u_CurTime - a_BirthTime) / u_LifeTime;\n\t\n\t#ifdef TILINGOFFSET\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, 1.0 - a_Texcoord0Y) * u_TilingOffset.xy + u_TilingOffset.zw;\n\t#else\n\t\tv_Texcoord0 = vec2(a_Texcoord0X, a_Texcoord0Y);\n\t#endif\n\t\n\t#ifdef GRADIENTMODE_BLEND\n\t\tv_Color = getColorFromGradientByBlend(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#else\n\t\tv_Color = getColorFromGradientByFixed(u_GradientColorkey, u_GradientAlphakey, normalizeTime);\n\t#endif\n\t\n\tgl_Position = u_Projection * u_View * vec4(a_Position + a_OffsetVector * getCurWidth(normalizeTime),1.0);\n\tgl_Position=remapGLPositionZ(gl_Position);\n}\n',Q="#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_MainTexture;\nuniform vec4 u_MainColor;\n\nvarying vec2 v_Texcoord0;\nvarying vec4 v_Color;\n\nvoid main()\n{\t\n\tvec4 color = 2.0 * u_MainColor * v_Color;\n\t#ifdef MAINTEXTURE\n\t\tvec4 mainTextureColor = texture2D(u_MainTexture, v_Texcoord0);\n\t\tcolor *= mainTextureColor;\n\t#endif\n\tgl_FragColor = color;\n}\n\n",e=Bq.add("Trail"),F=new FQ(m,a,na.shaderDefines,Qa.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q,w),m={a_Position:0,a_Normal:3,a_Tangent0:4},a={u_MvpMatrix:2,u_WorldMat:2,u_CameraPos:3,u_Time:4,u_MainTexture:1,u_NormalTexture:1,u_HorizonColor:1,u_WaveScale:1,u_WaveSpeed:1},q='#include "Lighting.glsl";\n\nattribute vec4 a_Position;\nattribute vec3 a_Normal;\nattribute vec4 a_Tangent0;\n\nuniform mat4 u_MvpMatrix;\nuniform mat4 u_WorldMat;\nuniform vec3 u_CameraPos;\nuniform float u_WaveScale;\nuniform vec4 u_WaveSpeed;\nuniform float u_Time;\n\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\nvoid main()\n{\n\tvec4 positionWorld = u_WorldMat * a_Position;\n\tvec4 position = u_MvpMatrix * a_Position;\n\t\n\tvec4 temp = vec4(positionWorld.x, positionWorld.z, positionWorld.x, positionWorld.z) * u_WaveScale + u_WaveSpeed * u_WaveScale * u_Time;\n\t\n\tv_Texcoord0 = temp.xy * vec2(0.4, 0.45);\n\tv_Texcoord1 = temp.wz;\n\t\n\tmat3 worldMat = mat3(u_WorldMat);\n\tv_Normal = worldMat * a_Normal;\n\tv_Tangent = worldMat * a_Tangent0.xyz;\n\tv_Binormal = cross(v_Normal, v_Tangent) * a_Tangent0.w;\n\t\n\tv_ViewDir = u_CameraPos - positionWorld.xyz;\n\tgl_Position = position;\n\tgl_Position=remapGLPositionZ(gl_Position);\n}',Q='#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#ifdef MAINTEXTURE\n\tuniform sampler2D u_MainTexture;\n#endif\n\n#ifdef NORMALTEXTURE\n\tuniform sampler2D u_NormalTexture;\n#endif\n\nuniform vec4 u_HorizonColor;\n\nvarying vec3 v_Normal;\nvarying vec3 v_Tangent;\nvarying vec3 v_Binormal;\nvarying vec3 v_ViewDir;\nvarying vec2 v_Texcoord0;\nvarying vec2 v_Texcoord1;\n\n#include "Lighting.glsl"\n\nvoid main()\n{\n\tvec4 bumpColor1 = texture2D(u_NormalTexture, v_Texcoord0);\n\tvec4 bumpColor2 = texture2D(u_NormalTexture, v_Texcoord1);\n\t\n\tvec3 normal1 = NormalSampleToWorldSpace1(bumpColor1, v_Tangent, v_Binormal, v_Normal);\n\tvec3 normal2 = NormalSampleToWorldSpace1(bumpColor2, v_Tangent, v_Binormal, v_Normal);\n\t\n\tvec3 normal = normalize((normal1 + normal2) * 0.5);\n\tvec3 viewDir = normalize(v_ViewDir);\n\tfloat fresnel = dot(viewDir, normal);\n\t\n\tvec4 waterColor = texture2D(u_MainTexture, vec2(fresnel, fresnel));\n\t\n\tvec4 color;\n\tcolor.rgb = mix(waterColor.rgb, u_HorizonColor.rgb, vec3(waterColor.a));\n\tcolor.a = u_HorizonColor.a;\n\t\n\tgl_FragColor = color;\n}\n\n',e=Bq.add("WaterPrimary"),F=new FQ(m,a,null,sa.shaderDefines),e.addSubShader(F),F.addShaderPass(q,Q),m={a_PositionTexcoord:0},a={u_ScreenTexture:1},q='#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}',Q="#ifdef FSHIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\nuniform sampler2D u_ScreenTexture;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_FragColor = texture2D(u_ScreenTexture, v_Texcoord0);\n}\n\n",e=Bq.add("ScreenQuad"),F=new FQ(m,a,null,null),e.addSubShader(F);var W=F.addShaderPass(q,Q),s=W.renderState;s.depthTest=519,s.depthWrite=!1,s.cull=0,m={a_PositionTexcoord:s.blend=0},a={u_MainTex:1,u_BloomTex:1,u_AutoExposureTex:1,u_MainTex_TexelSize:1,u_SampleScale:1,u_Threshold:1,u_Params:1},e=Bq.add("PostProcessBloom",m,a),F=new FQ(null,null,null,null),e.addSubShader(F),(s=(W=F.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}','#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_AutoExposureTex;\nuniform vec4 u_MainTex_TexelSize;\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\nuniform vec4 u_Params; // x: clamp, yzw: unused\n\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\n\tcolor *= autoExposure;\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\n\treturn color;\n}\n\nvoid fragPrefilter13() {\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\n}\n\nvoid main() {\n\tfragPrefilter13();\n}')).renderState).depthTest=519,s.depthWrite=!1,s.cull=0,s.blend=0,F=new FQ(null,null,null,null),e.addSubShader(F),(s=(W=F.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}','#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_AutoExposureTex;\nuniform vec4 u_MainTex_TexelSize;\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\nuniform vec4 u_Params; // x: clamp, yzw: unused\n\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\n\tcolor *= autoExposure;\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\n\treturn color;\n}\n\nvoid fragPrefilter4() {\n\tmediump vec4 color = downsampleBox4Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\n}\n\nvoid main() {\n\tfragPrefilter4();\n}')).renderState).depthTest=519,s.depthWrite=!1,s.cull=0,s.blend=0,F=new FQ(null,null,null,null),e.addSubShader(F),(s=(W=F.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}','#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform vec4 u_MainTex_TexelSize;\n\nvoid fragDownsample13() {\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = color;\n}\n\nvoid main() {\n\tfragDownsample13();\n}')).renderState).depthTest=519,s.depthWrite=!1,s.cull=0,s.blend=0,F=new FQ(null,null,null,null),e.addSubShader(F),(s=(W=F.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}','#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform vec4 u_MainTex_TexelSize;\nuniform float u_SampleScale;\n\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\n\treturn bloom + color;\n}\n\nvoid fragUpsampleTent() {\n\tmediump vec4 bloom = UpsampleTent(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, u_SampleScale);\n\tgl_FragColor = combine(bloom, v_Texcoord0);\n}\n\nvoid main() {\n\tfragUpsampleTent();\n}')).renderState).depthTest=519,s.depthWrite=!1,s.cull=0,s.blend=0,F=new FQ(null,null,null,null),e.addSubShader(F),(s=(W=F.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}','#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform vec4 u_MainTex_TexelSize;\nuniform float u_SampleScale;\n\nmediump vec4 combine(mediump vec4 bloom, vec2 uv) {\n\tmediump vec4 color = texture2D(u_BloomTex, uv);\n\treturn bloom + color;\n}\n\nvoid fragUpsampleBox() {\n\tmediump vec4 bloom = upsampleBox(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy, vec4(u_SampleScale));\n\tgl_FragColor = combine(bloom, v_Texcoord0);\n}\n\nvoid main() {\n\tfragUpsampleBox();\n}')).renderState).depthTest=519,s.depthWrite=!1,s.cull=0,s.blend=0,F=new FQ(null,null,null,null),e.addSubShader(F),(s=(W=F.addShaderPass('#include "Lighting.glsl";\n\nattribute vec4 a_PositionTexcoord;\nvarying vec2 v_Texcoord0;\n\nvoid main() {\n\tgl_Position = vec4(a_PositionTexcoord.xy, 0.0, 1.0);\n\tv_Texcoord0 = a_PositionTexcoord.zw;\n\tgl_Position = remapGLPositionZ(gl_Position);\n}','#ifdef HIGHPRECISION\n\tprecision highp float;\n#else\n\tprecision mediump float;\n#endif\n\n#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_AutoExposureTex;\nuniform vec4 u_MainTex_TexelSize;\nuniform vec4 u_Threshold; // x: threshold value (linear), y: threshold - knee, z: knee * 2, w: 0.25 / knee\nuniform vec4 u_Params; // x: clamp, yzw: unused\n\nmediump vec4 prefilter(mediump vec4 color, vec2 uv) {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, uv).r;\n\tcolor *= autoExposure;\n\tcolor = min(vec4(u_Params.x), color); // clamp to max\n\tcolor = quadraticThreshold(color, u_Threshold.x, u_Threshold.yzw);\n\treturn color;\n}\n\nvoid fragPrefilter13() {\n\tmediump vec4 color = downsampleBox13Tap(u_MainTex, v_Texcoord0, u_MainTex_TexelSize.xy);\n\tgl_FragColor = prefilter(safeHDR(color), v_Texcoord0);\n}\n\nvoid main() {\n\tfragPrefilter13();\n}')).renderState).depthTest=519,s.depthWrite=!1,s.cull=0,m={a_PositionTexcoord:s.blend=0},a={u_MainTex:1,u_BloomTex:1,u_AutoExposureTex:1,u_Bloom_DirtTex:1,u_BloomTex_TexelSize:1,u_Bloom_Settings:1,u_Bloom_Color:1},e=Bq.add("PostProcessComposite",m,a),F=new FQ(null,null,null,pQ.shaderDefines),e.addSubShader(F),(s=(W=F.addShaderPass("attribute vec4 a_Position;\nvarying vec2 v_Texcoord0;\n\nvec2 TransformTriangleVertexToUV(vec2 vertex)\n{\n    vec2 uv = (vertex + 1.0) * 0.5;\n    return uv;\n}\n\nvoid main() {\n\tgl_Position =vec4(a_Position.xy, 0.0, 1.0);\n\tv_Texcoord0=TransformTriangleVertexToUV(a_Position.xy);\n\tgl_Position=remapGLPositionZ(gl_Position);\n}",'#include "Colors.glsl";\n#include "Sampling.glsl";\n\nvarying vec2 v_Texcoord0;\n\nuniform sampler2D u_MainTex;\nuniform sampler2D u_BloomTex;\n\nuniform sampler2D u_AutoExposureTex;\nuniform sampler2D u_Bloom_DirtTex;\nuniform vec4 u_BloomTex_TexelSize;\nuniform vec4 u_Bloom_DirtTileOffset; // xy: tiling, zw: offset\nuniform mediump vec3 u_Bloom_Settings;// x: sampleScale, y: intensity, z: dirt intensity\nuniform mediump vec3 u_Bloom_Color;\n\nvoid main() {\n\tmediump float autoExposure = texture2D(u_AutoExposureTex, v_Texcoord0).r;\n\tmediump vec4 color=vec4(0.0)\n\tcolor = texture2D(u_MainTex, v_Texcoord0);\n\t\n\tcolor = SRGBToLinear(color);\n\tcolor.rgb *= autoExposure;\n\t\n\t#if BLOOM || BLOOM_LOW\n\t{\n\t\t#if BLOOM\n\t\t\tmediump vec4 bloom = UpsampleTent(_BloomTex, uvDistorted, _BloomTex_TexelSize.xy, _Bloom_Settings.x);\n\t\t#else\n\t\t\tmediump vec4 bloom = UpsampleBox(_BloomTex, uvDistorted, _BloomTex_TexelSize.xy, _Bloom_Settings.x);\n\t\t#endif\n\n\t\t// UVs should be Distort(uv * _Bloom_DirtTileOffset.xy + _Bloom_DirtTileOffset.zw)\n\t\t// but considering we use a cover-style scale on the dirt texture the difference\n\t\t// isn\'t massive so we chose to save a few ALUs here instead in case lens distortion\n\t\t// is active\n\t\tmediump vec4 dirt = mediump vec4(SAMPLE_TEXTURE2D(_Bloom_DirtTex, sampler_Bloom_DirtTex, uvDistorted * _Bloom_DirtTileOffset.xy + _Bloom_DirtTileOffset.zw).rgb, 0.0);\n\n\t\t// Additive bloom (artist friendly)\n\t\tbloom *= _Bloom_Settings.y;\n\t\tdirt *= _Bloom_Settings.z;\n\t\tcolor += bloom * half4(_Bloom_Color, 1.0);\n\t\tcolor += dirt * bloom;\n\t}\n\t#endif\n\t\n\thalf4 output = color;\n\toutput = LinearToSRGB(output);\n\t//output.rgb = Dither(output.rgb, v_Texcoord0);//TODO:\n}')).renderState).depthTest=519,s.depthWrite=!1,s.cull=0,s.blend=0;},D._rangeAttenTex=null,D;}(),Rq=function(){function A(){}
return S(A,"laya.d3.utils.Utils3D"),A._convertToLayaVec3=function(q,Q,m){Q.x=m?-q.x():q.x(),Q.y=q.y(),Q.z=q.z();},A._convertToBulletVec3=function(q,Q,m){Q.setValue(m?-q.x:q.x,q.y,q.z);},A._rotationTransformScaleSkinAnimation=function(q,Q,m,a,w,e,F,W,s,D,d,v){var y,S,t,o,b,U=A._tempArray16_0,J=A._tempArray16_1,V=A._tempArray16_2,n=a+a,O=w+w,C=e+e,l=a*n,u=w*n,f=w*O,p=e*n,T=e*O,c=e*C,r=F*n,_=F*O,Z=F*C;for(U[15]=1,U[0]=1-f-c,U[1]=u+Z,U[2]=p-_,U[4]=u-Z,U[5]=1-l-c,U[6]=T+r,U[8]=p+_,U[9]=T-r,U[10]=1-l-f,J[15]=1,J[0]=W,J[5]=s,J[10]=D,y=0;y<4;y++)S=U[y],t=U[y+4],o=U[y+8],b=U[y+12],V[y]=S,V[y+4]=t,V[y+8]=o,V[y+12]=S*q+t*Q+o*m+b;for(y=0;y<4;y++)S=V[y],t=V[y+4],o=V[y+8],b=V[y+12],d[y+v]=S*J[0]+t*J[1]+o*J[2]+b*J[3],d[y+v+4]=S*J[4]+t*J[5]+o*J[6]+b*J[7],d[y+v+8]=S*J[8]+t*J[9]+o*J[10]+b*J[11],d[y+v+12]=S*J[12]+t*J[13]+o*J[14]+b*J[15];},A._createSceneByJsonForMaker=function(q,Q,m){var a=A._createNodeByJsonForMaker(q,Q,m);return A._addComponentByJsonForMaker(q,Q,m),a;},A._createNodeByJsonForMaker=function(q,Q,m){var a;switch(q.type){case"Scene3D":a=new gm();break;case"Sprite3D":a=new Mm();break;case"MeshSprite3D":a=new Ua(),Q&&Q.push(a);break;case"SkinnedMeshSprite3D":a=new la();break;case"ShuriKenParticle3D":a=new Oa();break;case"Terrain":a=new qa();break;case"Camera":a=new pa();break;case"DirectionLight":a=new Va();break;case"PointLight":a=new ua();break;case"SpotLight":a=new Ja();break;case"TrailSprite3D":a=new na();break;default:var w=b.getClass(q.props.runtime);a=new w();}
var e=q.child;if(e)
for(var F=0,W=e.length;F<W;F++){var s=A._createNodeByJsonForMaker(e[F],Q,m);a.addChild(s);}
var D=q.compId;a.compId=D,a._parse(q.props,null),m&&(m._idMap[D]=a),A._compIdToNode[D]=a;var d=q.components;if(d)
for(var v=0,y=d.length;v<y;v++){var S=d[v];if(!(w=O.window.Laya[S.type]))w=O.window,S.type.split(".").forEach(function(q){w=w[q];});if("function"==typeof w){var t=new w();m&&(m._idMap[S.compId]=t,console.log(S.compId));}else console.warn("Utils3D:Unkown component type.");}
return a;},A._addComponentByJsonForMaker=function(q,Q,m){var a=q.compId,w=A._compIdToNode[a],e=q.child;if(e)
for(var F=0,W=e.length;F<W;F++)A._addComponentByJsonForMaker(e[F],Q,m);var s=q.components;if(s)
for(var D=0,d=s.length;D<d;D++){var v=s[D];if(!(S=O.window.Laya[v.type])){var y=v.type.split("."),S=O.window;y.forEach(function(q){S=S[q];});}
if("function"==typeof S){var t=m._idMap[v.compId];w.addComponentIntance(t),t._parse(v);}else console.warn("Utils3D:Unkown component type.");}},A._createSprite3DInstance=function(q,Q,m){var a;switch(q.type){case"Scene3D":a=new gm();break;case"Sprite3D":a=new Mm();break;case"MeshSprite3D":a=new Ua(),m&&m.push(a);break;case"SkinnedMeshSprite3D":a=new la();break;case"ShuriKenParticle3D":a=new Oa();break;case"Terrain":a=new qa();break;case"Camera":a=new pa();break;case"DirectionLight":a=new Va();break;case"PointLight":a=new ua();break;case"SpotLight":a=new Ja();break;case"TrailSprite3D":a=new na();break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.");}
var w=q.child;if(w)
for(var e=0,F=w.length;e<F;e++){var W=A._createSprite3DInstance(w[e],Q,m);a.addChild(W);}
return Q[q.instanceID]=a;},A._createComponentInstance=function(q,Q){var m=Q[q.instanceID];m._parse(q.props,Q);var a=q.child;if(a)
for(var w=0,e=a.length;w<e;w++)A._createComponentInstance(a[w],Q);var F=q.components;if(F)
for(var W=0,s=F.length;W<s;W++){var D=F[W],d=O.window.Laya[D.type];if(!d){var v=D.type.split(".");d=O.window,v.forEach(function(q){d=d[q];});}
if("function"==typeof d)m.addComponent(d)._parse(D);else console.warn("Unkown component type.");}},A._createNodeByJson02=function(q,Q){var m={},a=A._createSprite3DInstance(q,m,Q);return A._createComponentInstance(q,m),a;},A._computeBoneAndAnimationDatasByBindPoseMatrxix=function(q,Q,m,a,w,e){var F,W,s=0,D=0,d=q.length;for(F=0;F<d;s+=q[F].keyframeWidth,D+=16,F++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(Q[s+0],Q[s+1],Q[s+2],Q[s+3],Q[s+4],Q[s+5],Q[s+6],Q[s+7],Q[s+8],Q[s+9],a,D),0!=F&&(W=16*q[F].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(a,W,a,D,a,D));var v=m.length;for(F=0;F<v;F++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(a,16*e[F],m[F],w,16*F);},A._computeAnimationDatasByArrayAndMatrixFast=function(q,Q,m,a){for(var w=0,e=q.length;w<e;w++)laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(Q,16*a[w],q[w],m,16*w);},A._computeBoneAndAnimationDatasByBindPoseMatrxixOld=function(q,Q,m,a,w){var e,F,W=0,s=0,D=q.length;for(e=0;e<D;W+=q[e].keyframeWidth,s+=16,e++)laya.d3.utils.Utils3D._rotationTransformScaleSkinAnimation(Q[W+7],Q[W+8],Q[W+9],Q[W+3],Q[W+4],Q[W+5],Q[W+6],Q[W+0],Q[W+1],Q[W+2],a,s),0!=e&&(F=16*q[e].parentIndex,laya.d3.utils.Utils3D.mulMatrixByArray(a,F,a,s,a,s));var d=m.length;for(e=0;e<d;e++){var v=16*e;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(a,v,m[e],w,v);}},A._computeAnimationDatasByArrayAndMatrixFastOld=function(q,Q,m){for(var a=q.length,w=0;w<a;w++){var e=16*w;laya.d3.utils.Utils3D.mulMatrixByArrayAndMatrixFast(Q,e,q[w],m,e);}},A._computeRootAnimationData=function(q,Q,m){for(var a=0,w=0,e=0,F=q.length;a<F;w+=q[a].keyframeWidth,e+=16,a++)laya.d3.utils.Utils3D.createAffineTransformationArray(Q[w+0],Q[w+1],Q[w+2],Q[w+3],Q[w+4],Q[w+5],Q[w+6],Q[w+7],Q[w+8],Q[w+9],m,e);},A.transformVector3ArrayByQuat=function(q,Q,m,a,w){var e=q[Q],F=q[Q+1],W=q[Q+2],s=m.x,D=m.y,d=m.z,v=m.w,y=v*e+D*W-d*F,S=v*F+d*e-s*W,t=v*W+s*F-D*e,o=-s*e-D*F-d*W;a[w]=y*v+o* -s+S* -d-t* -D,a[w+1]=S*v+o* -D+t* -s-y* -d,a[w+2]=t*v+o* -d+y* -D-S* -s;},A.mulMatrixByArray=function(q,Q,m,a,w,e){var F,W,s,D,d;if(w===m){for(m=A._tempArray16_3,F=0;F<16;++F)m[F]=w[e+F];a=0;}
for(F=0;F<4;F++)W=q[Q+F],s=q[Q+F+4],D=q[Q+F+8],d=q[Q+F+12],w[e+F]=W*m[a+0]+s*m[a+1]+D*m[a+2]+d*m[a+3],w[e+F+4]=W*m[a+4]+s*m[a+5]+D*m[a+6]+d*m[a+7],w[e+F+8]=W*m[a+8]+s*m[a+9]+D*m[a+10]+d*m[a+11],w[e+F+12]=W*m[a+12]+s*m[a+13]+D*m[a+14]+d*m[a+15];},A.mulMatrixByArrayFast=function(q,Q,m,a,w,e){var F,W,s,D,d;for(F=0;F<4;F++)W=q[Q+F],s=q[Q+F+4],D=q[Q+F+8],d=q[Q+F+12],w[e+F]=W*m[a+0]+s*m[a+1]+D*m[a+2]+d*m[a+3],w[e+F+4]=W*m[a+4]+s*m[a+5]+D*m[a+6]+d*m[a+7],w[e+F+8]=W*m[a+8]+s*m[a+9]+D*m[a+10]+d*m[a+11],w[e+F+12]=W*m[a+12]+s*m[a+13]+D*m[a+14]+d*m[a+15];},A.mulMatrixByArrayAndMatrixFast=function(q,Q,m,a,w){var e,F,W,s,D,d=m.elements,v=d[0],y=d[1],S=d[2],t=d[3],o=d[4],b=d[5],U=d[6],J=d[7],V=d[8],n=d[9],O=d[10],C=d[11],l=d[12],u=d[13],f=d[14],p=d[15],T=Q,c=Q+4,r=Q+8,_=Q+12,Z=w,A=w+4,E=w+8,B=w+12;for(e=0;e<4;e++)F=q[T+e],W=q[c+e],s=q[r+e],D=q[_+e],a[Z+e]=F*v+W*y+s*S+D*t,a[A+e]=F*o+W*b+s*U+D*J,a[E+e]=F*V+W*n+s*O+D*C,a[B+e]=F*l+W*u+s*f+D*p;},A.createAffineTransformationArray=function(q,Q,m,a,w,e,F,W,s,D,d,v){var y=a+a,S=w+w,t=e+e,o=a*y,b=a*S,U=a*t,J=w*S,V=w*t,n=e*t,O=F*y,C=F*S,l=F*t;d[v+0]=(1-(J+n))*W,d[v+1]=(b+l)*W,d[v+2]=(U-C)*W,d[v+3]=0,d[v+4]=(b-l)*s,d[v+5]=(1-(o+n))*s,d[v+6]=(V+O)*s,d[v+7]=0,d[v+8]=(U+C)*D,d[v+9]=(V-O)*D,d[v+10]=(1-(o+J))*D,d[v+11]=0,d[v+12]=q,d[v+13]=Q,d[v+14]=m,d[v+15]=1;},A.transformVector3ArrayToVector3ArrayCoordinate=function(q,Q,m,a,w){var e=q[Q+0],F=q[Q+1],W=q[Q+2],s=m.elements,D=e*s[3]+F*s[7]+W*s[11]+s[15];a[w]=e*s[0]+F*s[4]+W*s[8]+s[12]/D,a[w+1]=e*s[1]+F*s[5]+W*s[9]+s[13]/D,a[w+2]=e*s[2]+F*s[6]+W*s[10]+s[14]/D;},A.transformLightingMapTexcoordArray=function(q,Q,m,a,w){a[w+0]=q[Q+0]*m.x+m.z,a[w+1]=1-((1-q[Q+1])*m.y+m.w);},A.getURLVerion=function(q){var Q=q.indexOf("?");return 0<=Q?q.substr(Q):null;},A._createAffineTransformationArray=function(q,Q,m,a){var w=Q.x,e=Q.y,F=Q.z,W=Q.w,s=w+w,D=e+e,d=F+F,v=w*s,y=w*D,S=w*d,t=e*D,o=e*d,b=F*d,U=W*s,J=W*D,V=W*d,n=m.x,O=m.y,C=m.z;a[0]=(1-(t+b))*n,a[1]=(y+V)*n,a[2]=(S-J)*n,a[3]=0,a[4]=(y-V)*O,a[5]=(1-(v+b))*O,a[6]=(o+U)*O,a[7]=0,a[8]=(S+J)*C,a[9]=(o-U)*C,a[10]=(1-(v+t))*C,a[11]=0,a[12]=q.x,a[13]=q.y,a[14]=q.z,a[15]=1;},A._mulMatrixArray=function(q,Q,m,a){var w,e,F,W,s,D=Q.elements,d=D[0],v=D[1],y=D[2],S=D[3],t=D[4],o=D[5],b=D[6],U=D[7],J=D[8],V=D[9],n=D[10],O=D[11],C=D[12],l=D[13],u=D[14],f=D[15],p=a,T=a+4,c=a+8,r=a+12;for(w=0;w<4;w++)e=q[w],F=q[w+4],W=q[w+8],s=q[w+12],m[p+w]=e*d+F*v+W*y+s*S,m[T+w]=e*t+F*o+W*b+s*U,m[c+w]=e*J+F*V+W*n+s*O,m[r+w]=e*C+F*l+W*u+s*f;},A.arcTanAngle=function(q,Q){return 0==q?1==Q?Math.PI/2:-Math.PI/2:0<q?Math.atan(Q/q):q<0?0<Q?Math.atan(Q/q)+Math.PI:Math.atan(Q/q)-Math.PI:0;},A.angleTo=function(q,Q,m){_q.subtract(Q,q,eq.TEMPVector30),_q.normalize(eq.TEMPVector30,eq.TEMPVector30),m.x=Math.asin(eq.TEMPVector30.y),m.y=A.arcTanAngle(-eq.TEMPVector30.z,-eq.TEMPVector30.x);},A.transformQuat=function(q,Q,m){var a=Q,w=q.x,e=q.y,F=q.z,W=a[0],s=a[1],D=a[2],d=a[3],v=d*w+s*F-D*e,y=d*e+D*w-W*F,S=d*F+W*e-s*w,t=-W*w-s*e-D*F;m.x=v*d+t* -W+y* -D-S* -s,m.y=y*d+t* -s+S* -W-v* -D,m.z=S*d+t* -D+v* -s-y* -W;},A.quaternionWeight=function(q,Q,m){m.x=q.x*Q,m.y=q.y*Q,m.z=q.z*Q,m.w=q.w;},A.quaternionConjugate=function(q,Q){Q.x=-q.x,Q.y=-q.y,Q.z=-q.z,Q.w=q.w;},A.scaleWeight=function(q,Q,m){var a=q.x,w=q.y,e=q.z;m.x=0<a?Math.pow(Math.abs(a),Q):-Math.pow(Math.abs(a),Q),m.y=0<w?Math.pow(Math.abs(w),Q):-Math.pow(Math.abs(w),Q),m.z=0<e?Math.pow(Math.abs(e),Q):-Math.pow(Math.abs(e),Q);},A.scaleBlend=function(q,Q,m,a){var w=A._tempVector3_0,e=A._tempVector3_1;A.scaleWeight(q,1-m,w),A.scaleWeight(Q,m,e);var F=.5<m?Q:q;a.x=0<F.x?Math.abs(w.x*e.x):-Math.abs(w.x*e.x),a.y=0<F.y?Math.abs(w.y*e.y):-Math.abs(w.y*e.y),a.z=0<F.z?Math.abs(w.z*e.z):-Math.abs(w.z*e.z);},A.gammaToLinearSpace=function(q){return q<=.04045?q/12.92:q<1?Math.pow((q+.055)/1.055,2.4):Math.pow(q,2.4);},A.linearToGammaSpace=function(q){return q<=0?0:q<=.0031308?12.92*q:q<=1?1.055*Math.pow(q,.41666)-.055:Math.pow(q,.41666);},A.matrix4x4MultiplyFFF=function(q,Q,m){var a,w,e,F,W;if(m===Q)
for(Q=new Float32Array(16),a=0;a<16;++a)Q[a]=m[a];var s=Q[0],D=Q[1],d=Q[2],v=Q[3],y=Q[4],S=Q[5],t=Q[6],o=Q[7],b=Q[8],U=Q[9],J=Q[10],V=Q[11],n=Q[12],O=Q[13],C=Q[14],l=Q[15];for(a=0;a<4;a++)w=q[a],e=q[a+4],F=q[a+8],W=q[a+12],m[a]=w*s+e*D+F*d+W*v,m[a+4]=w*y+e*S+F*t+W*o,m[a+8]=w*b+e*U+F*J+W*V,m[a+12]=w*n+e*O+F*C+W*l;},A.matrix4x4MultiplyFFFForNative=function(q,Q,m){J.instance.matrix4x4Multiply(q,Q,m);},A.matrix4x4MultiplyMFM=function(q,Q,m){A.matrix4x4MultiplyFFF(q.elements,Q,m.elements);},A._buildTexture2D=function(q,Q,m,a,w){void 0===w&&(w=!1);var e=new Y(q,Q,m,w,!0);return e.anisoLevel=1,e.filterMode=0,Cq._generateTexture2D(e,q,Q,a),e;},A._drawBound=function(q,Q,m){q.lineCount+12>q.maxLineCount&&(q.maxLineCount+=12);var a=A._tempVector3_0,w=A._tempVector3_1,e=Q.min,F=Q.max;a.setValue(e.x,e.y,e.z),w.setValue(F.x,e.y,e.z),q.addLine(a,w,m,m),a.setValue(e.x,e.y,e.z),w.setValue(e.x,e.y,F.z),q.addLine(a,w,m,m),a.setValue(F.x,e.y,e.z),w.setValue(F.x,e.y,F.z),q.addLine(a,w,m,m),a.setValue(e.x,e.y,F.z),w.setValue(F.x,e.y,F.z),q.addLine(a,w,m,m),a.setValue(e.x,e.y,e.z),w.setValue(e.x,F.y,e.z),q.addLine(a,w,m,m),a.setValue(e.x,e.y,F.z),w.setValue(e.x,F.y,F.z),q.addLine(a,w,m,m),a.setValue(F.x,e.y,e.z),w.setValue(F.x,F.y,e.z),q.addLine(a,w,m,m),a.setValue(F.x,e.y,F.z),w.setValue(F.x,F.y,F.z),q.addLine(a,w,m,m),a.setValue(e.x,F.y,e.z),w.setValue(F.x,F.y,e.z),q.addLine(a,w,m,m),a.setValue(e.x,F.y,e.z),w.setValue(e.x,F.y,F.z),q.addLine(a,w,m,m),a.setValue(F.x,F.y,e.z),w.setValue(F.x,F.y,F.z),q.addLine(a,w,m,m),a.setValue(e.x,F.y,F.z),w.setValue(F.x,F.y,F.z),q.addLine(a,w,m,m);},A._getHierarchyPath=function(q,Q,m){m.length=0;for(var a=Q;a!==q;){var w=a._parent;if(!w)return null;m.push(w.getChildIndex(a)),a=w;}
return m;},A._getNodeByHierarchyPath=function(q,Q){for(var m=q,a=Q.length-1;0<=a;a--)m=m.getChildAt(Q[a]);return m;},A._createNodeByJson=function(q,Q){var m;switch(q.type){case"Scene3D":m=new gm();break;case"Sprite3D":m=new Mm();break;case"MeshSprite3D":m=new Ua(),Q&&Q.push(m);break;case"SkinnedMeshSprite3D":m=new la();break;case"ShuriKenParticle3D":m=new Oa();break;case"Terrain":m=new qa();break;case"Camera":m=new pa();break;case"DirectionLight":m=new Va();break;case"PointLight":m=new ua();break;case"SpotLight":m=new Ja();break;case"TrailSprite3D":m=new na();break;default:throw new Error("Utils3D:unidentified class type in (.lh) file.");}
var a=q.child;if(a)
for(var w=0,e=a.length;w<e;w++){var F=A._createNodeByJson(a[w],Q);m.addChild(F);}
var W=q.components;if(W)
for(var s=0,D=W.length;s<D;s++){var d=W[s];if(!(y=O.window.Laya[d.type])){var v=d.type.split("."),y=O.window;v.forEach(function(q){y=y[q];});}
if("function"==typeof y)m.addComponent(y)._parse(d);else console.warn("Unkown component type.");}
return m._parse(q.props,null),m;},A._tempArray16_0=new Float32Array(16),A._tempArray16_1=new Float32Array(16),A._tempArray16_2=new Float32Array(16),A._tempArray16_3=new Float32Array(16),y(A,["_tempVector3_0",function(){return this._tempVector3_0=new _q();},"_tempVector3_1",function(){return this._tempVector3_1=new _q();},"_tempVector3_2",function(){return this._tempVector3_2=new _q();},"_tempColor0",function(){return this._tempColor0=new tq();},"_compIdToNode",function(){return this._compIdToNode=new Object();}]),A;}(),zq=function(){function q(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8);}
S(q,"laya.d3.core.particleShuriKen.module.GradientDataNumber");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.add=function(q,Q){this._currentLength<8?(6===this._currentLength&&1!==q&&(q=1,console.log("GradientDataNumber warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=q,this._elements[this._currentLength++]=Q):console.log("GradientDataNumber warning:data count must lessEqual than 4");},Q.getKeyByIndex=function(q){return this._elements[2*q];},Q.getValueByIndex=function(q){return this._elements[2*q+1];},Q.getAverageValue=function(){for(var q=0,Q=this._currentLength-2;q<Q;q+=2){this._elements[q+1];this._elements[q+3],this._elements[q+2]-this._elements[q];}
return 0;},Q.cloneTo=function(q){var Q=q;Q._currentLength=this._currentLength;var m=Q._elements;m.length=this._elements.length;for(var a=0,w=this._elements.length;a<w;a++)m[a]=this._elements[a];},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,Q,"gradientCount",function(){return this._currentLength/2;}),q;}(),iq=function(){function q(){}
return S(q,"laya.d3.core.pixelLine.PixelLineVertex"),d(0,q.prototype,"vertexDeclaration",function(){return q._vertexDeclaration;}),d(1,q,"vertexDeclaration",function(){return q._vertexDeclaration;}),y(q,["_vertexDeclaration",function(){return this._vertexDeclaration=new tQ(28,[new Gq(0,"vector3",0),new Gq(12,"vector4",1)]);}]),q;}(),$q=function(){function q(){this._hitResultsPoolIndex=0,this._contactPonintsPoolIndex=0,this._collisions={},this._hitResultsPool=[],this._contactPointsPool=[],this._collisionsPool=[];}
S(q,"laya.d3.physics.CollisionTool");var Q=q.prototype;return Q.getHitResult=function(){var q=this._hitResultsPool[this._hitResultsPoolIndex++];return q||(q=new UQ(),this._hitResultsPool.push(q)),q;},Q.recoverAllHitResultsPool=function(){this._hitResultsPoolIndex=0;},Q.getContactPoints=function(){var q=this._contactPointsPool[this._contactPonintsPoolIndex++];return q||(q=new $(),this._contactPointsPool.push(q)),q;},Q.recoverAllContactPointsPool=function(){this._contactPonintsPoolIndex=0;},Q.getCollision=function(q,Q){var m,a=q.id,w=Q.id,e=this._collisions[a];return e&&(m=e[w]),m||(e||(e={},this._collisions[a]=e),(m=0===this._collisionsPool.length?new SQ():this._collisionsPool.pop())._colliderA=q,m._colliderB=Q,e[w]=m),m;},Q.recoverCollision=function(q){var Q=q._colliderA.id,m=q._colliderB.id;this._collisions[Q][m]=null,this._collisionsPool.push(q);},Q.garbageCollection=function(){for(var q in this._hitResultsPoolIndex=0,this._hitResultsPool.length=0,this._contactPonintsPoolIndex=0,this._contactPointsPool.length=0,this._collisionsPool.length=0,this._collisionsPool){var Q=this._collisionsPool[q],m=!0;for(var a in Q)Q[a]?m=!1:delete Q[a];m&&delete this._collisionsPool[q];}},q;}(),jq=function(){function b(){this._scene=null,this._eventList=[],this._multiTouchEnabled=!0,this._mouseTouch=new wQ(),this._touchPool=[],this._touches=new Dm();}
S(b,"laya.d3.Input3D");var q=b.prototype;return q.__init__=function(q,Q){this._scene=Q;var m=this._eventList;q.oncontextmenu=function(q){return!1;},q.addEventListener("mousedown",function(q){q.preventDefault(),m.push(q);}),q.addEventListener("mouseup",function(q){q.preventDefault(),m.push(q);},!0),q.addEventListener("mousemove",function(q){q.preventDefault(),m.push(q);},!0),q.addEventListener("touchstart",function(q){q.preventDefault(),m.push(q);}),q.addEventListener("touchend",function(q){q.preventDefault(),m.push(q);},!0),q.addEventListener("touchmove",function(q){q.preventDefault(),m.push(q);},!0),q.addEventListener("touchcancel",function(q){m.push(q);},!0);},q.touchCount=function(){return this._touches.length;},q._getTouch=function(q){var Q=this._touchPool[q];return Q||(Q=new yQ(),(this._touchPool[q]=Q)._identifier=q),Q;},q._mouseTouchDown=function(){var q=this._mouseTouch,Q=q.sprite;if(q._pressedSprite=Q,q._pressedLoopCount=r.loopCount,Q){var m=Q._scripts;if(m)
for(var a=0,w=m.length;a<w;a++)m[a].onMouseDown();}},q._mouseTouchUp=function(){var q=0,Q=0,m=this._mouseTouch,a=m._pressedSprite;m._pressedSprite=null,m._pressedLoopCount=-1;var w=m.sprite;if(w&&w===a){var e=w._scripts;if(e)
for(q=0,Q=e.length;q<Q;q++)e[q].onMouseClick();}
if(a){var F=a._scripts;if(F)
for(q=0,Q=F.length;q<Q;q++)F[q].onMouseUp();}},q._mouseTouchRayCast=function(q){var Q=b._tempHitResult0,m=b._tempVector20,a=b._tempRay0;Q.succeeded=!1;var w=this._mouseTouch.mousePositionX,e=this._mouseTouch.mousePositionY;m.x=w,m.y=e;for(var F=q.length-1;0<=F;F--){var W=q[F],s=W.viewport;if(m.x>=s.x&&m.y>=s.y&&m.x<=s.width&&m.y<=s.height)
if(W.viewportPointToRay(m,a),this._scene._physicsSimulation.rayCast(a,Q)||0===W.clearFlag||1===W.clearFlag)break;}
var D=this._mouseTouch,d=D.sprite;if(Q.succeeded){var v=Q.collider.owner,y=(D.sprite=v)._scripts;if(d!==v&&y)
for(var S=0,t=y.length;S<t;S++)y[S].onMouseEnter();}else D.sprite=null;if(d&&d!==v){var o=d._scripts;if(o)
for(S=0,t=o.length;S<t;S++)o[S].onMouseOut();}},q._changeTouches=function(q,Q){for(var m=0,a=0,w=this._touches.length,e=0,F=q.length;e<F;e++){var W=q[e],s=W.identifier;if(this._multiTouchEnabled||0===s){var D=this._getTouch(s),d=D._position,v=b._tempPoint;v.setTo(W.pageX,W.pageY),o.stage._canvasTransform.invertTransformPoint(v);var y=v.x,S=v.y;switch(Q){case 0:this._touches.add(D),m+=y,a+=S;break;case 1:this._touches.remove(D),m-=y,a-=S;break;case 2:m=y-d.x,a=S-d.y;}
d.x=y,d.y=S;}}
var t=this._touches.length;this._mouseTouch.mousePositionY=0===t?this._mouseTouch.mousePositionX=0:(this._mouseTouch.mousePositionX=(this._mouseTouch.mousePositionX*w+m)/t,(this._mouseTouch.mousePositionY*w+a)/t);},q._update=function(){var q,Q=0,m=0,a=0;q=this._eventList.length;var w=this._scene._cameraPool;if(0<q){for(Q=0;Q<q;Q++){var e=this._eventList[Q];switch(e.type){case"mousedown":this._mouseTouchDown();break;case"mouseup":this._mouseTouchUp();break;case"mousemove":var F=b._tempPoint;F.setTo(e.pageX,e.pageY),o.stage._canvasTransform.invertTransformPoint(F),this._mouseTouch.mousePositionX=F.x,this._mouseTouch.mousePositionY=F.y,this._mouseTouchRayCast(w);break;case"touchstart":var W=this._touches.length;this._changeTouches(e.changedTouches,0),this._mouseTouchRayCast(w),0===W&&this._mouseTouchDown();break;case"touchend":case"touchcancel":this._changeTouches(e.changedTouches,1),0===this._touches.length&&this._mouseTouchUp();break;case"touchmove":this._changeTouches(e.changedTouches,2),this._mouseTouchRayCast(w);break;default:throw"Input3D:unkonwn event type.";}}
this._eventList.length=0;}
var s=this._mouseTouch,D=s._pressedSprite;if(D&&r.loopCount>s._pressedLoopCount){var d=D._scripts;if(d)
for(m=0,a=d.length;m<a;m++)d[m].onMouseDrag();}
var v=s.sprite;if(v){var y=v._scripts;if(y)
for(m=0,a=y.length;m<a;m++)y[m].onMouseOver();}},q.getTouch=function(q){return q<this._touches.length?this._touches.elements[q]:null;},d(0,q,"multiTouchEnabled",function(){return this._multiTouchEnabled;},function(q){this._multiTouchEnabled=q;}),y(b,["_tempPoint",function(){return this._tempPoint=new C();},"_tempVector20",function(){return this._tempVector20=new Zq();},"_tempRay0",function(){return this._tempRay0=new i(new _q(),new _q());},"_tempHitResult0",function(){return this._tempHitResult0=new UQ();}]),b;}(),hq=function(){function L(){}
return S(L,"laya.d3.core.particleShuriKen.ShurikenParticleData"),L._getStartLifetimeFromGradient=function(q,Q){for(var m=1,a=q.gradientCount;m<a;m++){var w=q.getKeyByIndex(m);if(Q<=w){var e=q.getKeyByIndex(m-1),F=(Q-e)/(w-e);return G.lerp(q.getValueByIndex(m-1),q.getValueByIndex(m),F);}}
throw new Error("ShurikenParticleData: can't get value foam startLifeTimeGradient.");},L._randomInvertRoationArray=function(q,Q,m,a,w){var e=NaN;a?(a.seed=w[6],e=a.getFloat(),w[6]=a.seed):e=Math.random(),Q.z=e<m?(Q.x=-q.x,Q.y=-q.y,-q.z):(Q.x=q.x,Q.y=q.y,q.z);},L._randomInvertRoation=function(q,Q,m,a){var w=NaN;return m?(m.seed=a[6],w=m.getFloat(),a[6]=m.seed):w=Math.random(),w<Q&&(q=-q),q;},L.create=function(q,Q,m){var a=q.autoRandomSeed,w=q._rand,e=q._randomSeeds;switch(q.startColorType){case 0:var F=q.startColorConstant;L.startColor.x=F.x,L.startColor.y=F.y,L.startColor.z=F.z,L.startColor.w=F.w;break;case 2:a?rq.lerp(q.startColorConstantMin,q.startColorConstantMax,Math.random(),L.startColor):(w.seed=e[3],rq.lerp(q.startColorConstantMin,q.startColorConstantMax,w.getFloat(),L.startColor),e[3]=w.seed);}
var W=q.colorOverLifetime;if(W&&W.enbale){var s=W.color;switch(s.type){case 0:L.startColor.x=L.startColor.x*s.constant.x,L.startColor.y=L.startColor.y*s.constant.y,L.startColor.z=L.startColor.z*s.constant.z,L.startColor.w=L.startColor.w*s.constant.w;break;case 2:var D=NaN;a?D=Math.random():(w.seed=e[10],D=w.getFloat(),e[10]=w.seed);var d=s.constantMin,v=s.constantMax;L.startColor.x=L.startColor.x*G.lerp(d.x,v.x,D),L.startColor.y=L.startColor.y*G.lerp(d.y,v.y,D),L.startColor.z=L.startColor.z*G.lerp(d.z,v.z,D),L.startColor.w=L.startColor.w*G.lerp(d.w,v.w,D);}}
var y=L.startSize;switch(q.startSizeType){case 0:if(q.threeDStartSize){var S=q.startSizeConstantSeparate;y[0]=S.x,y[1]=S.y,y[2]=S.z;}else y[0]=y[1]=y[2]=q.startSizeConstant;break;case 2:if(q.threeDStartSize){var t=q.startSizeConstantMinSeparate,o=q.startSizeConstantMaxSeparate;a?(y[0]=G.lerp(t.x,o.x,Math.random()),y[1]=G.lerp(t.y,o.y,Math.random()),y[2]=G.lerp(t.z,o.z,Math.random())):(w.seed=e[4],y[0]=G.lerp(t.x,o.x,w.getFloat()),y[1]=G.lerp(t.y,o.y,w.getFloat()),y[2]=G.lerp(t.z,o.z,w.getFloat()),e[4]=w.seed);}else a?y[0]=y[1]=y[2]=G.lerp(q.startSizeConstantMin,q.startSizeConstantMax,Math.random()):(w.seed=e[4],y[0]=y[1]=y[2]=G.lerp(q.startSizeConstantMin,q.startSizeConstantMax,w.getFloat()),e[4]=w.seed);}
var b=q.sizeOverLifetime;if(b&&b.enbale&&1===b.size.type){var U=b.size;if(U.separateAxes)a?(y[0]=y[0]*G.lerp(U.constantMinSeparate.x,U.constantMaxSeparate.x,Math.random()),y[1]=y[1]*G.lerp(U.constantMinSeparate.y,U.constantMaxSeparate.y,Math.random()),y[2]=y[2]*G.lerp(U.constantMinSeparate.z,U.constantMaxSeparate.z,Math.random())):(w.seed=e[11],y[0]=y[0]*G.lerp(U.constantMinSeparate.x,U.constantMaxSeparate.x,w.getFloat()),y[1]=y[1]*G.lerp(U.constantMinSeparate.y,U.constantMaxSeparate.y,w.getFloat()),y[2]=y[2]*G.lerp(U.constantMinSeparate.z,U.constantMaxSeparate.z,w.getFloat()),e[11]=w.seed);else{var J=NaN;a?J=G.lerp(U.constantMin,U.constantMax,Math.random()):(w.seed=e[11],J=G.lerp(U.constantMin,U.constantMax,w.getFloat()),e[11]=w.seed),y[0]=y[0]*J,y[1]=y[1]*J,y[2]=y[2]*J;}}
var V=Q.renderMode;if(1!==V)switch(q.startRotationType){case 0:if(q.threeDStartRotation){var n=q.startRotationConstantSeparate,O=L._tempVector30;L._randomInvertRoationArray(n,O,q.randomizeRotationDirection,a?null:w,e),L.startRotation[0]=O.x,L.startRotation[1]=O.y,L.startRotation[2]=4!==V?-O.z:O.z;}else L.startRotation[0]=L._randomInvertRoation(q.startRotationConstant,q.randomizeRotationDirection,a?null:w,e),L.startRotation[1]=0,L.startRotation[2]=0;break;case 2:if(q.threeDStartRotation){var C=q.startRotationConstantMinSeparate,l=q.startRotationConstantMaxSeparate,u=L._tempVector30;a?(u.x=G.lerp(C.x,l.x,Math.random()),u.y=G.lerp(C.y,l.y,Math.random()),u.z=G.lerp(C.z,l.z,Math.random())):(w.seed=e[5],u.x=G.lerp(C.x,l.x,w.getFloat()),u.y=G.lerp(C.y,l.y,w.getFloat()),u.z=G.lerp(C.z,l.z,w.getFloat()),e[5]=w.seed),L._randomInvertRoationArray(u,u,q.randomizeRotationDirection,a?null:w,e),L.startRotation[0]=u.x,L.startRotation[1]=u.y,L.startRotation[2]=4!==V?-u.z:u.z;}else a?L.startRotation[0]=L._randomInvertRoation(G.lerp(q.startRotationConstantMin,q.startRotationConstantMax,Math.random()),q.randomizeRotationDirection,a?null:w,e):(w.seed=e[5],L.startRotation[0]=L._randomInvertRoation(G.lerp(q.startRotationConstantMin,q.startRotationConstantMax,w.getFloat()),q.randomizeRotationDirection,a?null:w,e),e[5]=w.seed);}
switch(q.startLifetimeType){case 0:L.startLifeTime=q.startLifetimeConstant;break;case 1:L.startLifeTime=L._getStartLifetimeFromGradient(q.startLifeTimeGradient,q.emissionTime);break;case 2:a?L.startLifeTime=G.lerp(q.startLifetimeConstantMin,q.startLifetimeConstantMax,Math.random()):(w.seed=e[7],L.startLifeTime=G.lerp(q.startLifetimeConstantMin,q.startLifetimeConstantMax,w.getFloat()),e[7]=w.seed);break;case 3:var f=q.emissionTime;a?L.startLifeTime=G.lerp(L._getStartLifetimeFromGradient(q.startLifeTimeGradientMin,f),L._getStartLifetimeFromGradient(q.startLifeTimeGradientMax,f),Math.random()):(w.seed=e[7],L.startLifeTime=G.lerp(L._getStartLifetimeFromGradient(q.startLifeTimeGradientMin,f),L._getStartLifetimeFromGradient(q.startLifeTimeGradientMax,f),w.getFloat()),e[7]=w.seed);}
switch(q.startSpeedType){case 0:L.startSpeed=q.startSpeedConstant;break;case 2:a?L.startSpeed=G.lerp(q.startSpeedConstantMin,q.startSpeedConstantMax,Math.random()):(w.seed=e[8],L.startSpeed=G.lerp(q.startSpeedConstantMin,q.startSpeedConstantMax,w.getFloat()),e[8]=w.seed);}
var p=q.textureSheetAnimation;if(p&&p.enable){var T=p.tiles,c=T.x,r=T.y,_=1/c,Z=1/r,A=0,E=p.startFrame;switch(E.type){case 0:A=E.constant;break;case 1:a?A=G.lerp(E.constantMin,E.constantMax,Math.random()):(w.seed=e[14],A=G.lerp(E.constantMin,E.constantMax,w.getFloat()),e[14]=w.seed);}
var B=p.frame;switch(B.type){case 0:A+=B.constant;break;case 2:a?A+=G.lerp(B.constantMin,B.constantMax,Math.random()):(w.seed=e[15],A+=G.lerp(B.constantMin,B.constantMax,w.getFloat()),e[15]=w.seed);}
var N=0;switch(p.type){case 0:N=Math.floor(A/c);break;case 1:p.randomRow?a?N=Math.floor(Math.random()*r):(w.seed=e[13],N=Math.floor(w.getFloat()*r),e[13]=w.seed):N=p.rowIndex;}
var M=Math.floor(A%c);(L.startUVInfo=L.startUVInfo)[0]=_,L.startUVInfo[1]=Z,L.startUVInfo[2]=M*_,L.startUVInfo[3]=N*Z;}else(L.startUVInfo=L.startUVInfo)[0]=1,L.startUVInfo[1]=1,L.startUVInfo[2]=0,L.startUVInfo[3]=0;switch(q.simulationSpace){case 0:var Y=m.position;L.simulationWorldPostion[0]=Y.x,L.simulationWorldPostion[1]=Y.y,L.simulationWorldPostion[2]=Y.z;var x=m.rotation;L.simulationWorldRotation[0]=x.x,L.simulationWorldRotation[1]=x.y,L.simulationWorldRotation[2]=x.z,L.simulationWorldRotation[3]=x.w;break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.");}},L.startLifeTime=NaN,L.startSpeed=NaN,y(L,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempQuaternion",function(){return this._tempQuaternion=new eq();},"startColor",function(){return this.startColor=new rq();},"startSize",function(){return this.startSize=new Float32Array(3);},"startRotation",function(){return this.startRotation=new Float32Array(3);},"startUVInfo",function(){return this.startUVInfo=new Float32Array(4);},"simulationWorldPostion",function(){return this.simulationWorldPostion=new Float32Array(3);},"simulationWorldRotation",function(){return this.simulationWorldRotation=new Float32Array(4);}]),L;}(),Hq=function(){function v(q,Q,m,a){this._octree=null,this._parent=null,this._children=null,this._isContaion=!1,this.baseLength=0,this._bounds=new GQ(new _q(),new _q()),this._objects=[],this.center=new _q(),this._setValues(q,Q,m,a);}
S(v,"laya.d3.core.scene.BoundsOctreeNode");var q=v.prototype;return q._setValues=function(q,Q,m,a){this._octree=q,this._parent=Q,this.baseLength=m,a.cloneTo(this.center);var w=this._bounds.min,e=this._bounds.max,F=q._looseness*m/2;w.setValue(a.x-F,a.y-F,a.z-F),e.setValue(a.x+F,a.y+F,a.z+F);},q._getChildBound=function(q){if(null!=this._children&&this._children[q])return this._children[q]._bounds;var Q=this.baseLength/4,m=this.baseLength/2*this._octree._looseness/2,a=v._tempBoundBox,w=a.min,e=a.max;switch(q){case 0:w.x=this.center.x-Q-m,w.y=this.center.y+Q-m,w.z=this.center.z-Q-m,e.x=this.center.x-Q+m,e.y=this.center.y+Q+m,e.z=this.center.z-Q+m;break;case 1:w.x=this.center.x+Q-m,w.y=this.center.y+Q-m,w.z=this.center.z-Q-m,e.x=this.center.x+Q+m,e.y=this.center.y+Q+m,e.z=this.center.z-Q+m;break;case 2:w.x=this.center.x-Q-m,w.y=this.center.y+Q-m,w.z=this.center.z+Q-m,e.x=this.center.x-Q+m,e.y=this.center.y+Q+m,e.z=this.center.z+Q+m;break;case 3:w.x=this.center.x+Q-m,w.y=this.center.y+Q-m,w.z=this.center.z+Q-m,e.x=this.center.x+Q+m,e.y=this.center.y+Q+m,e.z=this.center.z+Q+m;break;case 4:w.x=this.center.x-Q-m,w.y=this.center.y-Q-m,w.z=this.center.z-Q-m,e.x=this.center.x-Q+m,e.y=this.center.y-Q+m,e.z=this.center.z-Q+m;break;case 5:w.x=this.center.x+Q-m,w.y=this.center.y-Q-m,w.z=this.center.z-Q-m,e.x=this.center.x+Q+m,e.y=this.center.y-Q+m,e.z=this.center.z-Q+m;break;case 6:w.x=this.center.x-Q-m,w.y=this.center.y-Q-m,w.z=this.center.z+Q-m,e.x=this.center.x-Q+m,e.y=this.center.y-Q+m,e.z=this.center.z+Q+m;break;case 7:w.x=this.center.x+Q-m,w.y=this.center.y-Q-m,w.z=this.center.z+Q-m,e.x=this.center.x+Q+m,e.y=this.center.y-Q+m,e.z=this.center.z+Q+m;}
return a;},q._getChildCenter=function(q){if(null!=this._children)return this._children[q].center;var Q=this.baseLength/4,m=v._tempVector30;switch(q){case 0:m.x=this.center.x-Q,m.y=this.center.y+Q,m.z=this.center.z-Q;break;case 1:m.x=this.center.x+Q,m.y=this.center.y+Q,m.z=this.center.z-Q;break;case 2:m.x=this.center.x-Q,m.y=this.center.y+Q,m.z=this.center.z+Q;break;case 3:m.x=this.center.x+Q,m.y=this.center.y+Q,m.z=this.center.z+Q;break;case 4:m.x=this.center.x-Q,m.y=this.center.y-Q,m.z=this.center.z-Q;break;case 5:m.x=this.center.x+Q,m.y=this.center.y-Q,m.z=this.center.z-Q;break;case 6:m.x=this.center.x-Q,m.y=this.center.y-Q,m.z=this.center.z+Q;break;case 7:m.x=this.center.x+Q,m.y=this.center.y-Q,m.z=this.center.z+Q;}
return m;},q._getChild=function(q){var Q=this.baseLength/4;switch(this._children||(this._children=N(8,null)),q){case 0:return this._children[0]||(this._children[0]=new v(this._octree,this,this.baseLength/2,new _q(this.center.x+ -Q,this.center.y+Q,this.center.z-Q)));case 1:return this._children[1]||(this._children[1]=new v(this._octree,this,this.baseLength/2,new _q(this.center.x+Q,this.center.y+Q,this.center.z-Q)));case 2:return this._children[2]||(this._children[2]=new v(this._octree,this,this.baseLength/2,new _q(this.center.x-Q,this.center.y+Q,this.center.z+Q)));case 3:return this._children[3]||(this._children[3]=new v(this._octree,this,this.baseLength/2,new _q(this.center.x+Q,this.center.y+Q,this.center.z+Q)));case 4:return this._children[4]||(this._children[4]=new v(this._octree,this,this.baseLength/2,new _q(this.center.x-Q,this.center.y-Q,this.center.z-Q)));case 5:return this._children[5]||(this._children[5]=new v(this._octree,this,this.baseLength/2,new _q(this.center.x+Q,this.center.y-Q,this.center.z-Q)));case 6:return this._children[6]||(this._children[6]=new v(this._octree,this,this.baseLength/2,new _q(this.center.x-Q,this.center.y-Q,this.center.z+Q)));case 7:return this._children[7]||(this._children[7]=new v(this._octree,this,this.baseLength/2,new _q(this.center.x+Q,this.center.y-Q,this.center.z+Q)));default:throw"BoundsOctreeNode: unknown index.";}},q._shouldMerge=function(){for(var q=this._objects.length,Q=0;Q<8;Q++){var m=this._children[Q];if(m){if(null!=m._children)return!1;q+=m._objects.length;}}
return q<=8;},q._mergeChildren=function(){for(var q=0;q<8;q++){var Q=this._children[q];if(Q){Q._parent=null;for(var m=Q._objects,a=m.length-1;0<=a;a--){var w=m[a];this._objects.push(w),w._setOctreeNode(this);}}}
this._children=null;},q._merge=function(){if(null===this._children){var q=this._parent;q&&q._shouldMerge()&&(q._mergeChildren(),q._merge());}},q._checkAddNode=function(q){if(null==this._children){if(this._objects.length<8||this.baseLength/2<this._octree._minSize)return this;for(var Q=this._objects.length-1;0<=Q;Q--){var m=this._objects[Q],a=this._bestFitChild(m.bounds.getCenter());v._encapsulates(this._getChildBound(a),m.bounds._getBoundBox())&&(this._objects.splice(this._objects.indexOf(m),1),this._getChild(a)._add(m));}}
var w=this._bestFitChild(q.bounds.getCenter());return v._encapsulates(this._getChildBound(w),q.bounds._getBoundBox())?this._getChild(w)._checkAddNode(q):this;},q._add=function(q){var Q=this._checkAddNode(q);Q._objects.push(q),q._setOctreeNode(Q);},q._remove=function(q){var Q=this._objects.indexOf(q);this._objects.splice(Q,1),q._setOctreeNode(null),this._merge();},q._addUp=function(q){return 1===YQ.boxContainsBox(this._bounds,q.bounds._getBoundBox())?(this._add(q),!0):!!this._parent&&this._parent._addUp(q);},q._getCollidingWithFrustum=function(q,Q,m,a){if(m){var w=Q.containsBoundBox(this._bounds);if(r.octreeNodeCulling++,0===w)return;m=2===w;}
this._isContaion=!m;for(var e=q.camera,F=q.scene,W=0,s=this._objects.length;W<s;W++){var D=this._objects[W];if(e._isLayerVisible(D._owner.layer)&&D._enable){if(m&&(r.frustumCulling++,!D._needRender(Q)))continue;D._distanceForSort=_q.distance(D.bounds.getCenter(),a);for(var d=D._renderElements,v=0,y=d.length;v<y;v++){var S=d[v],t=F._getRenderQueue(S.material.renderQueue);t.isTransparent?S.addToTransparentRenderQueue(q,t):S.addToOpaqueRenderQueue(q,t);}}}
if(null!=this._children)
for(W=0;W<8;W++){var o=this._children[W];o&&o._getCollidingWithFrustum(q,Q,m,a);}},q._getCollidingWithBoundBox=function(q,Q,m){if(Q){var a=YQ.boxContainsBox(this._bounds,q);if(0===a)return;Q=2===a;}
if(Q)
for(var w=0,e=this._objects.length;w<e;w++){var F=this._objects[w];YQ.intersectsBoxAndBox(F.bounds._getBoundBox(),q)&&m.push(F);}
if(null!=this._children)
for(w=0;w<8;w++){this._children[w]._getCollidingWithBoundBox(q,Q,m);}},q._bestFitChild=function(q){return(q.x<=this.center.x?0:1)+(q.y>=this.center.y?0:4)+(q.z<=this.center.z?0:2);},q._update=function(q){if(1===YQ.boxContainsBox(this._bounds,q.bounds._getBoundBox())){var Q=this._checkAddNode(q);if(Q!==q._getOctreeNode()){Q._objects.push(q),q._setOctreeNode(Q);var m=this._objects.indexOf(q);this._objects.splice(m,1),this._merge();}
return!0;}
if(this._parent){var a=this._parent._addUp(q);return a&&(m=this._objects.indexOf(q),this._objects.splice(m,1),this._merge()),a;}
return!1;},q.add=function(q){return!!v._encapsulates(this._bounds,q.bounds._getBoundBox())&&(this._add(q),!0);},q.remove=function(q){return q._getOctreeNode()===this&&(this._remove(q),!0);},q.update=function(q){return q._getOctreeNode()===this&&this._update(q);},q.shrinkIfPossible=function(q){if(this.baseLength<2*q)return this;for(var Q=-1,m=0,a=this._objects.length;m<a;m++){var w=this._objects[m],e=this._bestFitChild(w.bounds.getCenter());if(0!=m&&e!=Q)return this;var F=this._getChildBound(e);if(!v._encapsulates(F,w.bounds._getBoundBox()))return this;0==m&&(Q=e);}
if(null==this._children){if(-1!=Q){var W=this._getChildCenter(Q);this._setValues(this._octree,null,this.baseLength/2,W);}
return this;}
var s=!1;for(m=0,a=this._children.length;m<a;m++){var D=this._children[m];if(D&&D.hasAnyObjects()){if(s)return this;if(0<=Q&&Q!=m)return this;s=!0,Q=m;}}
if(-1==Q)return this;var d=this._children[Q];return d._parent=null,d;},q.hasAnyObjects=function(){if(0<this._objects.length)return!0;if(null!=this._children)
for(var q=0;q<8;q++){var Q=this._children[q];if(Q&&Q.hasAnyObjects())return!0;}
return!1;},q.getCollidingWithBoundBox=function(q,Q){this._getCollidingWithBoundBox(q,!0,Q);},q.getCollidingWithRay=function(q,Q,m){void 0===m&&(m=Number.MAX_VALUE);var a=YQ.intersectsRayAndBoxRD(q,this._bounds);if(!(-1==a||m<a)){for(var w=0,e=this._objects.length;w<e;w++){var F=this._objects[w];-
1!==(a=YQ.intersectsRayAndBoxRD(q,F.bounds._getBoundBox()))&&a<=m&&Q.push(F);}
if(null!=this._children)
for(w=0;w<8;w++){this._children[w].getCollidingWithRay(q,Q,m);}}},q.getCollidingWithFrustum=function(q){var Q=q.camera.transform.position,m=q.camera.boundFrustum;this._getCollidingWithFrustum(q,m,!0,Q);},q.isCollidingWithBoundBox=function(q){if(!YQ.intersectsBoxAndBox(this._bounds,q))return!1;for(var Q=0,m=this._objects.length;Q<m;Q++){var a=this._objects[Q];if(YQ.intersectsBoxAndBox(a.bounds._getBoundBox(),q))return!0;}
if(null!=this._children)
for(Q=0;Q<8;Q++){if(this._children[Q].isCollidingWithBoundBox(q))return!0;}
return!1;},q.isCollidingWithRay=function(q,Q){void 0===Q&&(Q=Number.MAX_VALUE);var m=YQ.intersectsRayAndBoxRD(q,this._bounds);if(-1==m||Q<m)return!1;for(var a=0,w=this._objects.length;a<w;a++){var e=this._objects[a];if(-1!==(m=YQ.intersectsRayAndBoxRD(q,e.bounds._getBoundBox()))&&m<=Q)return!0;}
if(null!=this._children)
for(a=0;a<8;a++){if(this._children[a].isCollidingWithRay(q,Q))return!0;}
return!1;},q.getBound=function(){return this._bounds;},q.drawAllBounds=function(q,Q,m){if(null!==this._children||0!=this._objects.length){Q++;var a=v._tempColor0;if(this._isContaion)a.r=0,a.g=0,a.b=1;else{var w=m?Q/m:0;a.r=1-w,a.g=w,a.b=0;}
if(a.a=.3,Rq._drawBound(q,this._bounds,a),null!=this._children)
for(var e=0;e<8;e++){var F=this._children[e];F&&F.drawAllBounds(q,Q,m);}}},q.drawAllObjects=function(q,Q,m){Q++;var a=v._tempColor0;if(this._isContaion)a.r=0,a.g=0,a.b=1;else{var w=m?Q/m:0;a.r=1-w,a.g=w,a.b=0;}
a.a=1;for(var e=0,F=this._objects.length;e<F;e++)Rq._drawBound(q,this._objects[e].bounds._getBoundBox(),a);if(null!=this._children)
for(e=0;e<8;e++){var W=this._children[e];W&&W.drawAllObjects(q,Q,m);}},v._encapsulates=function(q,Q){return 1==YQ.boxContainsBox(q,Q);},v._NUM_OBJECTS_ALLOWED=8,y(v,["_tempVector3",function(){return this._tempVector3=new _q();},"_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();},"_tempColor0",function(){return this._tempColor0=new tq();},"_tempBoundBox",function(){return this._tempBoundBox=new GQ(new _q(),new _q());}]),v;}(),gq=(function(){function q(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(12);}
S(q,"laya.d3.core.particleShuriKen.module.GradientDataVector2");var Q=q.prototype;o.imps(Q,{"laya.d3.core.IClone":!0}),Q.add=function(q,Q){this._currentLength<8?(6===this._currentLength&&1!==q&&(q=1,console.log("GradientDataVector2 warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=q,this._elements[this._currentLength++]=Q.x,this._elements[this._currentLength++]=Q.y):console.log("GradientDataVector2 warning:data count must lessEqual than 4");},Q.cloneTo=function(q){var Q=q;Q._currentLength=this._currentLength;var m=Q._elements;m.length=this._elements.length;for(var a=0,w=this._elements.length;a<w;a++)m[a]=this._elements[a];},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,Q,"gradientCount",function(){return this._currentLength/3;});}(),function(){function q(q,Q,m,a){this._position=null,this._normal=null,this._textureCoord0=null,this._textureCoord1=null,this._position=q,this._normal=Q,this._textureCoord0=m,this._textureCoord1=a;}
S(q,"laya.d3.graphics.Vertex.VertexPositionTerrain");var Q=q.prototype;return o.imps(Q,{"laya.d3.graphics.IVertex":!0}),d(0,Q,"normal",function(){return this._normal;}),d(0,Q,"position",function(){return this._position;}),d(0,Q,"textureCoord0",function(){return this._textureCoord0;}),d(0,Q,"textureCoord1",function(){return this._textureCoord1;}),d(0,Q,"vertexDeclaration",function(){return q._vertexDeclaration;}),d(1,q,"vertexDeclaration",function(){return q._vertexDeclaration;}),q.TERRAIN_POSITION0=0,q.TERRAIN_NORMAL0=1,q.TERRAIN_TEXTURECOORDINATE0=2,q.TERRAIN_TEXTURECOORDINATE1=3,y(q,["_vertexDeclaration",function(){return this._vertexDeclaration=new tQ(40,[new Gq(0,"vector3",0),new Gq(12,"vector3",1),new Gq(24,"vector2",2),new Gq(32,"vector2",3)]);}]),q;}()),Iq=function(){function q(){this._nodes=[];}
S(q,"laya.d3.animation.KeyframeNodeList");var Q=q.prototype;return Q.getNodeByIndex=function(q){return this._nodes[q];},Q.setNodeByIndex=function(q,Q){this._nodes[q]=Q;},d(0,Q,"count",function(){return this._nodes.length;},function(q){this._nodes.length=q;}),q;}(),Pq=function(){function a(q,Q,m,a){this._initialSize=NaN,this._rootNode=null,this._looseness=NaN,this._minSize=NaN,this.count=0,this._motionObjects=new Jm(),q<m&&(console.warn("Minimum node size must be at least as big as the initial world size. Was: "+m+" Adjusted to: "+q),m=q),this._initialSize=q,this._minSize=m,this._looseness=Math.min(Math.max(a,1),2),this._rootNode=new Hq(this,null,q,Q);}
S(a,"laya.d3.core.scene.BoundsOctree");var q=a.prototype;return q._getMaxDepth=function(q,Q){Q++;var m=q._children;if(null!=m)
for(var a=Q,w=0,e=m.length;w<e;w++){var F=m[w];F&&(Q=Math.max(this._getMaxDepth(F,a),Q));}
return Q;},q._grow=function(q){var Q=0<=q.x?1:-1,m=0<=q.y?1:-1,a=0<=q.z?1:-1,w=this._rootNode,e=this._rootNode.baseLength/2,F=2*this._rootNode.baseLength,W=this._rootNode.center,s=new _q(W.x+Q*e,W.y+m*e,W.z+a*e);if(this._rootNode=new Hq(this,null,F,s),w.hasAnyObjects()){for(var D=this._rootNode._bestFitChild(w.center),d=N(8,null),v=0;v<8;v++)v==D&&(w._parent=this._rootNode,d[v]=w);this._rootNode._children=d;}},q.add=function(q){for(var Q=0;!this._rootNode.add(q);){var m=a._tempVector30;if(_q.subtract(q.bounds.getCenter(),this._rootNode.center,m),this._grow(m),20<++Q)throw"Aborted Add operation as it seemed to be going on forever ("+(Q-1)+") attempts at growing the octree.";}
this.count++;},q.remove=function(q){var Q=q._getOctreeNode().remove(q);return Q&&this.count--,Q;},q.update=function(q){var Q=0,m=q._getOctreeNode();if(m){for(;!m._update(q);)
if(this._grow(q.bounds.getCenter()),20<++Q)throw"Aborted Add operation as it seemed to be going on forever ("+(Q-1)+") attempts at growing the octree.";return!0;}
return!1;},q.shrinkRootIfPossible=function(){this._rootNode=this._rootNode.shrinkIfPossible(this._initialSize);},q.addMotionObject=function(q){this._motionObjects.add(q);},q.removeMotionObject=function(q){this._motionObjects.remove(q);},q.updateMotionObjects=function(){for(var q=this._motionObjects.elements,Q=0,m=this._motionObjects.length;Q<m;Q++){var a=q[Q];this.update(a),a._setIndexInMotionList(-1);}
this._motionObjects.length=0;},q.isCollidingWithBoundBox=function(q){return this._rootNode.isCollidingWithBoundBox(q);},q.isCollidingWithRay=function(q,Q){return void 0===Q&&(Q=Number.MAX_VALUE),this._rootNode.isCollidingWithRay(q,Q);},q.getCollidingWithBoundBox=function(q,Q){this._rootNode.getCollidingWithBoundBox(q,Q);},q.getCollidingWithRay=function(q,Q,m){void 0===m&&(m=Number.MAX_VALUE),this._rootNode.getCollidingWithRay(q,Q,m);},q.getCollidingWithFrustum=function(q){this._rootNode.getCollidingWithFrustum(q);},q.getMaxBounds=function(){return this._rootNode.getBound();},q.drawAllBounds=function(q){var Q=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllBounds(q,-1,Q);},q.drawAllObjects=function(q){var Q=this._getMaxDepth(this._rootNode,-1);this._rootNode.drawAllObjects(q,-1,Q);},y(a,["_tempVector30",function(){return this._tempVector30=new _q();}]),a;}(),Xq=function(){function q(q){this._owner=null,this._sharedMesh=null,this._owner=q;}
S(q,"laya.d3.core.MeshFilter");var Q=q.prototype;return Q._getMeshDefine=function(q){for(var Q=0,m=0,a=q._subMeshCount;m<a;m++)
for(var w=q._getSubMesh(m)._vertexBuffer._vertexDeclaration.vertexElements,e=0,F=w.length;e<F;e++){switch(w[e].elementUsage){case 1:Q|=Ua.SHADERDEFINE_COLOR;break;case 2:Q|=Ua.SHADERDEFINE_UV0;break;case 7:Q|=Ua.SHADERDEFINE_UV1;}}
return Q;},Q.destroy=function(){this._owner=null,this._sharedMesh&&(this._sharedMesh._removeReference(),this._sharedMesh=null);},d(0,Q,"sharedMesh",function(){return this._sharedMesh;},function(q){if(this._sharedMesh!==q){var Q=this._owner._render._defineDatas,m=this._sharedMesh;m&&(m._removeReference(),Q.remove(this._getMeshDefine(m))),q._addReference(),this._sharedMesh=q,Q.add(this._getMeshDefine(q)),this._owner._render._changeRenderObjectsByMesh(q);}
this._owner._render._onMeshChange(q);}),q;}(),qQ=function(){function q(q){this._minVertexDistance=NaN,this._widthMultiplier=NaN,this._time=NaN,this._widthCurve=null,this._colorGradient=null,this._textureMode=0,this._trialGeometry=null,this._totalLength=0,this._owner=null,this._curtime=0,this._trailRenderElementIndex=0,this._lastPosition=new _q(),this.alignment=0,this._owner=q,this._initDefaultData(),this.addRenderElement();}
S(q,"laya.d3.core.trail.TrailFilter");var Q=q.prototype;return Q.addRenderElement=function(){var q=this._owner._render,Q=q._renderElements,m=q.sharedMaterials[0];m||(m=Qa.defaultMaterial);var a=new Vq();a.setTransform(this._owner._transform),a.render=q,a.material=m,this._trialGeometry=new ym(this),a.setGeometry(this._trialGeometry),Q.push(a);},Q._update=function(q){var Q=this._owner._render;this._curtime+=q.scene.timer._delta/1e3,Q._shaderValues.setNumber(na.CURTIME,this._curtime);var m=this._owner.transform.position,a=Q._renderElements[0]._geometry;a._updateDisappear(),a._updateTrail(q.camera,this._lastPosition,m),a._updateVertexBufferUV(),m.cloneTo(this._lastPosition);},Q._initDefaultData=function(){this.time=5,this.minVertexDistance=.1,this.widthMultiplier=1,this.textureMode=0;var q=[],Q=new bm();Q.time=0,Q.inTangent=0,Q.outTangent=0,Q.value=1,q.push(Q);var m=new bm();m.time=1,m.inTangent=0,m.outTangent=0,m.value=1,q.push(m),this.widthCurve=q;var a=new wq(2,2);a.mode=0,a.addColorRGB(0,tq.WHITE),a.addColorRGB(1,tq.WHITE),a.addColorAlpha(0,1),a.addColorAlpha(1,1),this.colorGradient=a;},Q.destroy=function(){this._trialGeometry.destroy(),this._trialGeometry=null,this._widthCurve=null,this._colorGradient=null;},d(0,Q,"widthMultiplier",function(){return this._widthMultiplier;},function(q){this._widthMultiplier=q;}),d(0,Q,"time",function(){return this._time;},function(q){this._time=q,this._owner._render._shaderValues.setNumber(na.LIFETIME,q);}),d(0,Q,"widthCurve",function(){return this._widthCurve;},function(q){this._widthCurve=q;var Q,m=new Float32Array(4*q.length),a=0,w=0;for(a=0,Q=q.length;a<Q;a++)m[w++]=q[a].time,m[w++]=q[a].inTangent,m[w++]=q[a].outTangent,m[w++]=q[a].value;this._owner._render._shaderValues.setBuffer(na.WIDTHCURVE,m),this._owner._render._shaderValues.setInt(na.WIDTHCURVEKEYLENGTH,q.length);}),d(0,Q,"minVertexDistance",function(){return this._minVertexDistance;},function(q){this._minVertexDistance=q;}),d(0,Q,"colorGradient",function(){return this._colorGradient;},function(q){this._colorGradient=q,this._owner._render._shaderValues.setBuffer(na.GRADIENTCOLORKEY,q._rgbElements),this._owner._render._shaderValues.setBuffer(na.GRADIENTALPHAKEY,q._alphaElements),0==q.mode?this._owner._render._defineDatas.add(na.SHADERDEFINE_GRADIENTMODE_BLEND):this._owner._render._defineDatas.remove(na.SHADERDEFINE_GRADIENTMODE_BLEND);}),d(0,Q,"textureMode",function(){return this._textureMode;},function(q){this._textureMode=q;}),q.ALIGNMENT_VIEW=0,q.ALIGNMENT_TRANSFORM_Z=1,q;}(),QQ=function(){function q(){}
S(q,"laya.d3.core.trail.VertexTrail");var Q=q.prototype;return o.imps(Q,{"laya.d3.graphics.IVertex":!0}),d(0,Q,"vertexDeclaration",function(){return q._vertexDeclaration1;}),d(1,q,"vertexDeclaration1",function(){return q._vertexDeclaration1;}),d(1,q,"vertexDeclaration2",function(){return q._vertexDeclaration2;}),q.TRAIL_POSITION0=0,q.TRAIL_OFFSETVECTOR=1,q.TRAIL_TIME0=2,q.TRAIL_TEXTURECOORDINATE0Y=3,q.TRAIL_TEXTURECOORDINATE0X=4,y(q,["_vertexDeclaration1",function(){return this._vertexDeclaration1=new tQ(32,[new Gq(0,"vector3",0),new Gq(12,"vector3",1),new Gq(24,"single",2),new Gq(28,"single",3)]);},"_vertexDeclaration2",function(){return this._vertexDeclaration2=new tQ(4,[new Gq(0,"single",4)]);}]),q;}(),mQ=function(){function q(q,Q,m){this._time=NaN,this._minCount=0,this._maxCount=0,this._time=q,this._minCount=Q,this._maxCount=m;}
S(q,"laya.d3.core.particleShuriKen.module.Burst");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.cloneTo=function(q){var Q=q;Q._time=this._time,Q._minCount=this._minCount,Q._maxCount=this._maxCount;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,Q,"time",function(){return this._time;}),d(0,Q,"minCount",function(){return this._minCount;}),d(0,Q,"maxCount",function(){return this._maxCount;}),q;}(),aQ=function(){function q(){this.time=NaN,this.eventName=null,this.params=null;}
return S(q,"laya.d3.animation.AnimationEvent"),q;}(),wQ=(function(){function q(){this._nativeConstraint=null,this._simulation=null,this.rigidbodyA=null,this.rigidbodyB=null;}
S(q,"laya.d3.physics.Constraint3D");}(),function(){function q(){this._pressedSprite=null,this._pressedLoopCount=-1,this.sprite=null,this.mousePositionX=0,this.mousePositionY=0;}
return S(q,"laya.d3.MouseTouch"),q;}()),eQ=function(){function q(){this._currentLength=0,this._elements=null,this._elements=new Float32Array(8);}
S(q,"laya.d3.core.particleShuriKen.module.GradientDataInt");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.add=function(q,Q){this._currentLength<8?(6===this._currentLength&&1!==q&&(q=1,console.log("Warning:the forth key is  be force set to 1.")),this._elements[this._currentLength++]=q,this._elements[this._currentLength++]=Q):console.log("Warning:data count must lessEqual than 4");},Q.cloneTo=function(q){var Q=q;Q._currentLength=this._currentLength;var m=Q._elements;m.length=this._elements.length;for(var a=0,w=this._elements.length;a<w;a++)m[a]=this._elements[a];},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,Q,"gradientCount",function(){return this._currentLength/2;}),q;}(),FQ=function(){function q(q,Q,m,a){this._attributeMap=null,this._uniformMap=null,this._publicDefines=null,this._publicDefinesMap=null,this._spriteDefines=null,this._spriteDefinesMap=null,this._materialDefines=null,this._materialDefinesMap=null,this._owner=null,this._flags={},this._passes=[],this._publicDefines=[],this._publicDefinesMap={},this._spriteDefines=[],this._spriteDefinesMap={},this._materialDefines=[],this._materialDefinesMap={},this._addDefines(this._publicDefines,this._publicDefinesMap,Bq._globleDefines),m&&this._addDefines(this._spriteDefines,this._spriteDefinesMap,m.defines),a&&this._addDefines(this._materialDefines,this._materialDefinesMap,a.defines),this._attributeMap=q,this._uniformMap=Q;}
S(q,"laya.d3.shader.SubShader");var Q=q.prototype;return Q._addDefines=function(q,Q,m){for(var a in m){var w=m[a],e=parseInt(a);Q[q[e]=w]=e;}},Q.getMaterialDefineByName=function(q){return this._materialDefinesMap[q];},Q.setFlag=function(q,Q){Q?this._flags[q]=Q:delete this._flags[q];},Q.getFlag=function(q){return this._flags[q];},Q.addShaderPass=function(q,Q,m){var a=new IQ(this,q,Q,m);return this._passes.push(a),a;},q;}(),WQ=function(){function q(){this.source=null,this.destination=null,this.camera=null,this.compositeShaderData=null,this.compositeDefineData=null,this.command=null,this.tempRenderTextures=[];}
return S(q,"laya.d3.core.render.PostProcessRenderContext"),q;}(),sQ=function(){function q(){this._commands=[];}
S(q,"laya.d3.core.render.command.CommandBuffer");var Q=q.prototype;return Q._apply=function(){for(var q=0,Q=this._commands.length;q<Q;q++)this._commands[q].run();},Q.setShaderDataTexture=function(q,Q,m){this._commands.push(pm.create(q,Q,m));},Q.blit=function(q,Q,m,a,w){void 0===w&&(w=0),this._commands.push(mm.create(q,Q,m,a,w));},Q.setRenderTarget=function(q){this._commands.push(Vm.create(q));},Q.clear=function(){for(var q=0,Q=this._commands.length;q<Q;q++)this._commands[q].recover();this._commands.length=0;},q.SCREENTEXTURE_NAME="u_ScreenTexture",y(q,["screenShader",function(){return this.screenShader=Bq.find("ScreenQuad");},"SCREENTEXTURE_ID",function(){return this.SCREENTEXTURE_ID=Bq.propertyNameToID("u_ScreenTexture");}]),q;}(),DQ=function(){function D(){this._type=0,this._separateAxes=!1,this._constant=NaN,this._constantSeparate=null,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._gradientW=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null,this._gradientWMin=null,this._gradientWMax=null;}
S(D,"laya.d3.core.particleShuriKen.module.GradientAngularVelocity");var q=D.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.cloneTo=function(q){var Q=q;Q._type=this._type,Q._separateAxes=this._separateAxes,Q._constant=this._constant,this._constantSeparate.cloneTo(Q._constantSeparate),this._gradient.cloneTo(Q._gradient),this._gradientX.cloneTo(Q._gradientX),this._gradientY.cloneTo(Q._gradientY),this._gradientZ.cloneTo(Q._gradientZ),Q._constantMin=this._constantMin,Q._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(Q._constantMinSeparate),this._constantMaxSeparate.cloneTo(Q._constantMaxSeparate),this._gradientMin.cloneTo(Q._gradientMin),this._gradientMax.cloneTo(Q._gradientMax),this._gradientXMin.cloneTo(Q._gradientXMin),this._gradientXMax.cloneTo(Q._gradientXMax),this._gradientYMin.cloneTo(Q._gradientYMin),this._gradientYMax.cloneTo(Q._gradientYMax),this._gradientZMin.cloneTo(Q._gradientZMin),this._gradientZMax.cloneTo(Q._gradientZMax);},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,q,"gradientZ",function(){return this._gradientZ;}),d(0,q,"constant",function(){return this._constant;}),d(0,q,"gradient",function(){return this._gradient;}),d(0,q,"separateAxes",function(){return this._separateAxes;}),d(0,q,"type",function(){return this._type;}),d(0,q,"constantSeparate",function(){return this._constantSeparate;}),d(0,q,"gradientX",function(){return this._gradientX;}),d(0,q,"gradientY",function(){return this._gradientY;}),d(0,q,"gradientW",function(){return this._gradientW;}),d(0,q,"gradientMin",function(){return this._gradientMin;}),d(0,q,"constantMin",function(){return this._constantMin;}),d(0,q,"gradientMax",function(){return this._gradientMax;}),d(0,q,"constantMax",function(){return this._constantMax;}),d(0,q,"gradientWMin",function(){return this._gradientWMin;}),d(0,q,"constantMinSeparate",function(){return this._constantMinSeparate;}),d(0,q,"constantMaxSeparate",function(){return this._constantMaxSeparate;}),d(0,q,"gradientXMin",function(){return this._gradientXMin;}),d(0,q,"gradientXMax",function(){return this._gradientXMax;}),d(0,q,"gradientWMax",function(){return this._gradientWMax;}),d(0,q,"gradientYMin",function(){return this._gradientYMin;}),d(0,q,"gradientYMax",function(){return this._gradientYMax;}),d(0,q,"gradientZMin",function(){return this._gradientZMin;}),d(0,q,"gradientZMax",function(){return this._gradientZMax;}),D.createByConstant=function(q){var Q=new D();return Q._type=0,Q._separateAxes=!1,Q._constant=q,Q;},D.createByConstantSeparate=function(q){var Q=new D();return Q._type=0,Q._separateAxes=!0,Q._constantSeparate=q,Q;},D.createByGradient=function(q){var Q=new D();return Q._type=1,Q._separateAxes=!1,Q._gradient=q,Q;},D.createByGradientSeparate=function(q,Q,m){var a=new D();return a._type=1,a._separateAxes=!0,a._gradientX=q,a._gradientY=Q,a._gradientZ=m,a;},D.createByRandomTwoConstant=function(q,Q){var m=new D();return m._type=2,m._separateAxes=!1,m._constantMin=q,m._constantMax=Q,m;},D.createByRandomTwoConstantSeparate=function(q,Q){var m=new D();return m._type=2,m._separateAxes=!0,m._constantMinSeparate=q,m._constantMaxSeparate=Q,m;},D.createByRandomTwoGradient=function(q,Q){var m=new D();return m._type=3,m._separateAxes=!1,m._gradientMin=q,m._gradientMax=Q,m;},D.createByRandomTwoGradientSeparate=function(q,Q,m,a,w,e,F,W){var s=new D();return s._type=3,s._separateAxes=!0,s._gradientXMin=q,s._gradientXMax=Q,s._gradientYMin=m,s._gradientYMax=a,s._gradientZMin=w,s._gradientZMax=e,s._gradientWMin=F,s._gradientWMax=W,s;},D;}(),dQ=function(){function Q(){this._defaultPhysicsMemory=16,this._editerEnvironment=!1,this.isAntialias=!0,this.isAlpha=!1,this.premultipliedAlpha=!0,this.isStencil=!0,this.octreeCulling=!1,this.octreeInitialSize=64,this.octreeMinNodeSize=2,this.octreeLooseness=1.25,this.debugFrustumCulling=!1,this.octreeInitialCenter=new _q(0,0,0);}
S(Q,"Config3D");var q=Q.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.cloneTo=function(q){var Q=q;Q._defaultPhysicsMemory=this._defaultPhysicsMemory,Q._editerEnvironment=this._editerEnvironment,Q.isAntialias=this.isAntialias,Q.isAlpha=this.isAlpha,Q.premultipliedAlpha=this.premultipliedAlpha,Q.isStencil=this.isStencil,Q.octreeCulling=this.octreeCulling,this.octreeInitialCenter.cloneTo(Q.octreeInitialCenter),Q.octreeMinNodeSize=this.octreeMinNodeSize,Q.octreeLooseness=this.octreeLooseness,Q.debugFrustumCulling=this.debugFrustumCulling;},q.clone=function(){var q=new Q();return this.cloneTo(q),q;},d(0,q,"defaultPhysicsMemory",function(){return this._defaultPhysicsMemory;},function(q){if(q<16)throw"defaultPhysicsMemory must large than 16M";this._defaultPhysicsMemory=q;}),y(Q,["_default",function(){return this._default=new Q();}]),Q;}(),vQ=(function(){function w(q){if(this._state0U=NaN,this._state0L=NaN,this._state1U=NaN,this._state1L=NaN,!(q instanceof Array)||4!==q.length)throw new Error("Rand:Seed must be an array with 4 numbers");this._state0U=0|q[0],this._state0L=0|q[1],this._state1U=0|q[2],this._state1L=0|q[3];}
S(w,"laya.d3.math.RandX");var q=w.prototype;q.randomint=function(){var q=this._state0U,Q=this._state0L,m=this._state1U,a=this._state1L,w=(a>>>0)+(Q>>>0),e=m+q+(w/2>>>31)>>>0,F=w>>>0,W=0,s=0;W=(q^=W=q<<23|(-512&Q)>>>9)^(this._state0U=m),s=(Q^=s=Q<<23)^(this._state0L=a);W^=q>>>18,s^=Q>>>18|(262143&q)<<14;return W^=m>>>5,s^=a>>>5|(31&m)<<27,this._state1U=W,this._state1L=s,[e,F];},q.random=function(){var q=this.randomint(),Q=q[0],m=1023<<20|Q>>>12,a=0|(q[1]>>>12|(4095&Q)<<20);return w._CONVERTION_BUFFER.setUint32(0,m,!1),w._CONVERTION_BUFFER.setUint32(4,a,!1),lq._CONVERTION_BUFFER.getFloat64(0,!1)-1;},y(w,["_CONVERTION_BUFFER",function(){return this._CONVERTION_BUFFER=new DataView(new ArrayBuffer(8));},"defaultRand",function(){return this.defaultRand=new lq([0,Date.now()/65536,0,Date.now()%65536]);}]);}(),function(){function o(){}
return S(o,"laya.d3.utils.Picker"),o.calculateCursorRay=function(q,Q,m,a,w,e){var F=q.x,W=q.y,s=o._tempVector30,D=s;D.x=F,D.y=W,D.z=Q.minDepth;var d=o._tempVector31,v=d;v.x=F,v.y=W,v.z=Q.maxDepth;var y=e.origin,S=o._tempVector32;Q.unprojectFromWVP(s,m,a,w,y),Q.unprojectFromWVP(d,m,a,w,S);var t=e.direction;t.x=S.x-y.x,t.y=S.y-y.y,t.z=S.z-y.z,_q.normalize(e.direction,e.direction);},o.rayIntersectsTriangle=function(q,Q,m,a){var w=o._tempVector30,e=o._tempVector31;_q.subtract(m,Q,w),_q.subtract(a,Q,e);var F,W=o._tempVector32;if(_q.cross(q.direction,e,W),(F=_q.dot(w,W))>-Number.MIN_VALUE&&F<Number.MIN_VALUE)return Number.NaN;var s,D=1/F,d=o._tempVector33;if(_q.subtract(q.origin,Q,d),s=_q.dot(d,W),(s*=D)<0||1<s)return Number.NaN;var v,y,S=o._tempVector34;return _q.cross(d,w,S),v=_q.dot(q.direction,S),(v*=D)<0||1<s+v?Number.NaN:(y=_q.dot(e,S),(y*=D)<0?Number.NaN:y);},y(o,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();},"_tempVector32",function(){return this._tempVector32=new _q();},"_tempVector33",function(){return this._tempVector33=new _q();},"_tempVector34",function(){return this._tempVector34=new _q();}]),o;}()),yQ=function(){function q(){this._indexInList=-1,this._identifier=-1,this._position=new Zq();}
S(q,"laya.d3.Touch");var Q=q.prototype;return o.imps(Q,{"laya.resource.ISingletonElement":!0}),Q._getIndexInList=function(){return this._indexInList;},Q._setIndexInList=function(q){this._indexInList=q;},d(0,Q,"identifier",function(){return this._identifier;}),d(0,Q,"position",function(){return this._position;}),q;}(),SQ=(function(){function q(){this.startPosition=new _q(),this.endPosition=new _q(),this.startColor=new tq(),this.endColor=new tq();}
S(q,"laya.d3.core.pixelLine.PixelLineData"),q.prototype.cloneTo=function(q){this.startPosition.cloneTo(q.startPosition),this.endPosition.cloneTo(q.endPosition),this.startColor.cloneTo(q.startColor),this.endColor.cloneTo(q.endColor);};}(),function(){function q(){this._lastUpdateFrame=-2147483648,this._updateFrame=-2147483648,this._isTrigger=!1,this.contacts=[];}
return S(q,"laya.d3.physics.Collision"),q.prototype._setUpdateFrame=function(q){this._lastUpdateFrame=this._updateFrame,this._updateFrame=q;},q;}()),tQ=function(){function s(q,Q){this._id=0,this._vertexStride=0,this._vertexElementsDic=null,this._shaderValues=null,this._defineDatas=null,this.vertexElements=null,this._id=++s._uniqueIDCounter,this._defineDatas=new Lq(),this._vertexElementsDic={},this._vertexStride=q;var m=(this.vertexElements=Q).length;this._shaderValues=new Fq(null);for(var a=0;a<m;a++){var w=Q[a],e=w.elementUsage;this._vertexElementsDic[e]=w;var F=new Int32Array(5),W=ZQ.getElementInfos(w.elementFormat);F[0]=W[0],F[1]=W[1],F[2]=W[2],F[3]=this._vertexStride,F[4]=w.offset,this._shaderValues.setAttribute(e,F);}}
S(s,"laya.d3.graphics.VertexDeclaration");var q=s.prototype;return q.getVertexElementByUsage=function(q){return this._vertexElementsDic[q];},q.unBinding=function(){},d(0,q,"id",function(){return this._id;}),d(0,q,"vertexStride",function(){return this._vertexStride;}),s._uniqueIDCounter=1,s;}(),oQ=function(){function q(){this._material=null,this._mesh=Cm.instance;}
S(q,"laya.d3.resource.models.SkyRenderer");var Q=q.prototype;return Q._isAvailable=function(){return this._material&&this._mesh;},Q._render=function(q){if(this._material&&this._mesh){var Q=J.instance,m=q.scene,a=q.camera;E.setCullFace(Q,!1),E.setDepthFunc(Q,515),E.setDepthMask(Q,!1);var w=q.shader=this._material._shader.getSubShaderAt(0)._passes[0].withCompile(0,0,this._material._defineDatas.value),e=w.bind(),F=r.loopCount!==w._uploadMark,W=w._uploadScene!==m||F;(W||e)&&(w.uploadUniforms(w._sceneUniformParamsMap,m._shaderValues,W),w._uploadScene=m);var s=w._uploadCamera!==a||F;(s||e)&&(w.uploadUniforms(w._cameraUniformParamsMap,a._shaderValues,s),w._uploadCamera=a);var D=w._uploadMaterial!==this._material||F;(D||e)&&(w.uploadUniforms(w._materialUniformParamsMap,this._material._shaderValues,D),w._uploadMaterial=this._material),this._mesh._bufferState.bind(),this._mesh._render(q),E.setDepthFunc(Q,513),E.setDepthMask(Q,!0);}},Q.destroy=function(){this._material&&(this._material._removeReference(),this._material=null);},d(0,Q,"material",function(){return this._material;},function(q){this._material!==q&&(this._material&&this._material._removeReference(),q&&q._addReference(),this._material=q);}),d(0,Q,"mesh",function(){return this._mesh;},function(q){this._mesh!==q&&(this._mesh=q);}),q;}(),bQ=(function(){function q(){}
S(q,"laya.d3.animation.AnimatorStateScript");var Q=q.prototype;Q.onStateEnter=function(){},Q.onStateUpdate=function(){},Q.onStateExit=function(){};}(),function(){function q(){this.updateMark=-1,this.indexInList=-1,this.batched=!1;}
return S(q,"laya.d3.core.render.BatchMark"),q;}()),UQ=function(){function q(){this.succeeded=!1,this.collider=null,this.hitFraction=0,this.point=new _q(),this.normal=new _q();}
return S(q,"laya.d3.physics.HitResult"),q;}(),JQ=function(){function W(){this._type=0,this._separateAxes=!1,this._gradient=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=NaN,this._constantMax=NaN,this._constantMinSeparate=null,this._constantMaxSeparate=null,this._gradientMin=null,this._gradientMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null;}
S(W,"laya.d3.core.particleShuriKen.module.GradientSize");var q=W.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.getMaxSizeInGradient=function(){var q=0,Q=0,m=-Number.MAX_VALUE;switch(this._type){case 0:if(this._separateAxes){for(q=0,Q=this._gradientX.gradientCount;q<Q;q++)m=Math.max(m,this._gradientX.getValueByIndex(q));for(q=0,Q=this._gradientY.gradientCount;q<Q;q++)m=Math.max(m,this._gradientY.getValueByIndex(q));}else
for(q=0,Q=this._gradient.gradientCount;q<Q;q++)m=Math.max(m,this._gradient.getValueByIndex(q));break;case 1:m=this._separateAxes?(m=Math.max(this._constantMinSeparate.x,this._constantMaxSeparate.x),m=Math.max(m,this._constantMinSeparate.y),Math.max(m,this._constantMaxSeparate.y)):Math.max(this._constantMin,this._constantMax);break;case 2:if(this._separateAxes){for(q=0,Q=this._gradientXMin.gradientCount;q<Q;q++)m=Math.max(m,this._gradientXMin.getValueByIndex(q));for(q=0,Q=this._gradientXMax.gradientCount;q<Q;q++)m=Math.max(m,this._gradientXMax.getValueByIndex(q));for(q=0,Q=this._gradientYMin.gradientCount;q<Q;q++)m=Math.max(m,this._gradientYMin.getValueByIndex(q));for(q=0,Q=this._gradientZMax.gradientCount;q<Q;q++)m=Math.max(m,this._gradientZMax.getValueByIndex(q));}else{for(q=0,Q=this._gradientMin.gradientCount;q<Q;q++)m=Math.max(m,this._gradientMin.getValueByIndex(q));for(q=0,Q=this._gradientMax.gradientCount;q<Q;q++)m=Math.max(m,this._gradientMax.getValueByIndex(q));}}
return m;},q.cloneTo=function(q){var Q=q;Q._type=this._type,Q._separateAxes=this._separateAxes,this._gradient.cloneTo(Q._gradient),this._gradientX.cloneTo(Q._gradientX),this._gradientY.cloneTo(Q._gradientY),this._gradientZ.cloneTo(Q._gradientZ),Q._constantMin=this._constantMin,Q._constantMax=this._constantMax,this._constantMinSeparate.cloneTo(Q._constantMinSeparate),this._constantMaxSeparate.cloneTo(Q._constantMaxSeparate),this._gradientMin.cloneTo(Q._gradientMin),this._gradientMax.cloneTo(Q._gradientMax),this._gradientXMin.cloneTo(Q._gradientXMin),this._gradientXMax.cloneTo(Q._gradientXMax),this._gradientYMin.cloneTo(Q._gradientYMin),this._gradientYMax.cloneTo(Q._gradientYMax),this._gradientZMin.cloneTo(Q._gradientZMin),this._gradientZMax.cloneTo(Q._gradientZMax);},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,q,"gradientZ",function(){return this._gradientZ;}),d(0,q,"gradient",function(){return this._gradient;}),d(0,q,"separateAxes",function(){return this._separateAxes;}),d(0,q,"type",function(){return this._type;}),d(0,q,"gradientMin",function(){return this._gradientMin;}),d(0,q,"constantMin",function(){return this._constantMin;}),d(0,q,"gradientX",function(){return this._gradientX;}),d(0,q,"gradientY",function(){return this._gradientY;}),d(0,q,"gradientMax",function(){return this._gradientMax;}),d(0,q,"constantMax",function(){return this._constantMax;}),d(0,q,"constantMinSeparate",function(){return this._constantMinSeparate;}),d(0,q,"constantMaxSeparate",function(){return this._constantMaxSeparate;}),d(0,q,"gradientXMin",function(){return this._gradientXMin;}),d(0,q,"gradientXMax",function(){return this._gradientXMax;}),d(0,q,"gradientYMin",function(){return this._gradientYMin;}),d(0,q,"gradientYMax",function(){return this._gradientYMax;}),d(0,q,"gradientZMin",function(){return this._gradientZMin;}),d(0,q,"gradientZMax",function(){return this._gradientZMax;}),W.createByGradient=function(q){var Q=new W();return Q._type=0,Q._separateAxes=!1,Q._gradient=q,Q;},W.createByGradientSeparate=function(q,Q,m){var a=new W();return a._type=0,a._separateAxes=!0,a._gradientX=q,a._gradientY=Q,a._gradientZ=m,a;},W.createByRandomTwoConstant=function(q,Q){var m=new W();return m._type=1,m._separateAxes=!1,m._constantMin=q,m._constantMax=Q,m;},W.createByRandomTwoConstantSeparate=function(q,Q){var m=new W();return m._type=1,m._separateAxes=!0,m._constantMinSeparate=q,m._constantMaxSeparate=Q,m;},W.createByRandomTwoGradient=function(q,Q){var m=new W();return m._type=2,m._separateAxes=!1,m._gradientMin=q,m._gradientMax=Q,m;},W.createByRandomTwoGradientSeparate=function(q,Q,m,a,w,e){var F=new W();return F._type=2,F._separateAxes=!0,F._gradientXMin=q,F._gradientXMax=Q,F._gradientYMin=m,F._gradientYMax=a,F._gradientZMin=w,F._gradientZMax=e,F;},W;}(),VQ=function(){function q(){this.alphaMap=null,this.detailID=null,this.normalMap=null;}
return S(q,"laya.d3.terrain.unit.ChunkInfo"),q;}(),nQ=function(){function q(){this.textureID=-1;}
return S(q,"laya.d3.shader.ShaderVariable"),q;}(),OQ=function(){function q(){this._indexInList=0,this.type=0,this.fullPath=null,this.propertyOwner=null,this.data=null,this._ownerPath=[],this._propertys=[],this._keyFrames=[];}
S(q,"laya.d3.animation.KeyframeNode");var Q=q.prototype;return Q._setOwnerPathCount=function(q){this._ownerPath.length=q;},Q._setOwnerPathByIndex=function(q,Q){this._ownerPath[q]=Q;},Q._joinOwnerPath=function(q){return this._ownerPath.join(q);},Q._setPropertyCount=function(q){this._propertys.length=q;},Q._setPropertyByIndex=function(q,Q){this._propertys[q]=Q;},Q._joinProperty=function(q){return this._propertys.join(q);},Q._setKeyframeCount=function(q){this._keyFrames.length=q;},Q._setKeyframeByIndex=function(q,Q){this._keyFrames[q]=Q;},Q.getOwnerPathByIndex=function(q){return this._ownerPath[q];},Q.getPropertyByIndex=function(q){return this._propertys[q];},Q.getKeyframeByIndex=function(q){return this._keyFrames[q];},d(0,Q,"ownerPathCount",function(){return this._ownerPath.length;}),d(0,Q,"propertyCount",function(){return this._propertys.length;}),d(0,Q,"keyFramesCount",function(){return this._keyFrames.length;}),q;}(),CQ=function(){function W(){this._type=0,this._constant=null,this._gradientX=null,this._gradientY=null,this._gradientZ=null,this._constantMin=null,this._constantMax=null,this._gradientXMin=null,this._gradientXMax=null,this._gradientYMin=null,this._gradientYMax=null,this._gradientZMin=null,this._gradientZMax=null;}
S(W,"laya.d3.core.particleShuriKen.module.GradientVelocity");var q=W.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.cloneTo=function(q){var Q=q;Q._type=this._type,this._constant.cloneTo(Q._constant),this._gradientX.cloneTo(Q._gradientX),this._gradientY.cloneTo(Q._gradientY),this._gradientZ.cloneTo(Q._gradientZ),this._constantMin.cloneTo(Q._constantMin),this._constantMax.cloneTo(Q._constantMax),this._gradientXMin.cloneTo(Q._gradientXMin),this._gradientXMax.cloneTo(Q._gradientXMax),this._gradientYMin.cloneTo(Q._gradientYMin),this._gradientYMax.cloneTo(Q._gradientYMax),this._gradientZMin.cloneTo(Q._gradientZMin),this._gradientZMax.cloneTo(Q._gradientZMax);},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,q,"gradientZ",function(){return this._gradientZ;}),d(0,q,"constant",function(){return this._constant;}),d(0,q,"type",function(){return this._type;}),d(0,q,"gradientXMax",function(){return this._gradientXMax;}),d(0,q,"constantMin",function(){return this._constantMin;}),d(0,q,"gradientX",function(){return this._gradientX;}),d(0,q,"gradientY",function(){return this._gradientY;}),d(0,q,"gradientXMin",function(){return this._gradientXMin;}),d(0,q,"constantMax",function(){return this._constantMax;}),d(0,q,"gradientYMin",function(){return this._gradientYMin;}),d(0,q,"gradientYMax",function(){return this._gradientYMax;}),d(0,q,"gradientZMin",function(){return this._gradientZMin;}),d(0,q,"gradientZMax",function(){return this._gradientZMax;}),W.createByConstant=function(q){var Q=new W();return Q._type=0,Q._constant=q,Q;},W.createByGradient=function(q,Q,m){var a=new W();return a._type=1,a._gradientX=q,a._gradientY=Q,a._gradientZ=m,a;},W.createByRandomTwoConstant=function(q,Q){var m=new W();return m._type=2,m._constantMin=q,m._constantMax=Q,m;},W.createByRandomTwoGradient=function(q,Q,m,a,w,e){var F=new W();return F._type=3,F._gradientXMin=q,F._gradientXMax=Q,F._gradientYMin=m,F._gradientYMax=a,F._gradientZMin=w,F._gradientZMax=e,F;},W;}(),lQ=function(){function q(q,Q){this._updateFlag=0,this._center=new _q(),this._extent=new _q(),this._boundBox=new GQ(new _q(),new _q()),q.cloneTo(this._boundBox.min),Q.cloneTo(this._boundBox.max),this._setUpdateFlag(12,!0);}
S(q,"laya.d3.core.Bounds");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.setMin=function(q){var Q=this._boundBox.min;q!==Q&&q.cloneTo(Q),this._setUpdateFlag(12,!0),this._setUpdateFlag(1,!1);},Q.getMin=function(){var q=this._boundBox.min;return this._getUpdateFlag(1)&&(this._getMin(this.getCenter(),this.getExtent(),q),this._setUpdateFlag(1,!1)),q;},Q.setMax=function(q){var Q=this._boundBox.max;q!==Q&&q.cloneTo(Q),this._setUpdateFlag(12,!0),this._setUpdateFlag(2,!1);},Q.getMax=function(){var q=this._boundBox.max;return this._getUpdateFlag(2)&&(this._getMax(this.getCenter(),this.getExtent(),q),this._setUpdateFlag(2,!1)),q;},Q.setCenter=function(q){q!==this._center&&q.cloneTo(this._center),this._setUpdateFlag(3,!0),this._setUpdateFlag(4,!1);},Q.getCenter=function(){return this._getUpdateFlag(4)&&(this._getCenter(this.getMin(),this.getMax(),this._center),this._setUpdateFlag(4,!1)),this._center;},Q.setExtent=function(q){q!==this._extent&&q.cloneTo(this._extent),this._setUpdateFlag(3,!0),this._setUpdateFlag(8,!1);},Q.getExtent=function(){return this._getUpdateFlag(8)&&(this._getExtent(this.getMin(),this.getMax(),this._extent),this._setUpdateFlag(8,!1)),this._extent;},Q._getUpdateFlag=function(q){return 0!=(this._updateFlag&q);},Q._setUpdateFlag=function(q,Q){Q?this._updateFlag|=q:this._updateFlag&=~q;},Q._getCenter=function(q,Q,m){_q.add(q,Q,m),_q.scale(m,.5,m);},Q._getExtent=function(q,Q,m){_q.subtract(Q,q,m),_q.scale(m,.5,m);},Q._getMin=function(q,Q,m){_q.subtract(q,Q,m);},Q._getMax=function(q,Q,m){_q.add(q,Q,m);},Q._rotateExtents=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=Q.elements;m.x=Math.abs(F[0]*a)+Math.abs(F[4]*w)+Math.abs(F[8]*e),m.y=Math.abs(F[1]*a)+Math.abs(F[5]*w)+Math.abs(F[9]*e),m.z=Math.abs(F[2]*a)+Math.abs(F[6]*w)+Math.abs(F[10]*e);},Q._tranform=function(q,Q){var m=Q._center,a=Q._extent;_q.transformCoordinate(this.getCenter(),q,m),this._rotateExtents(this.getExtent(),q,a),Q._boundBox.setCenterAndExtent(m,a),Q._updateFlag=0;},Q._getBoundBox=function(){var q=this._boundBox.min;this._getUpdateFlag(1)&&(this._getMin(this.getCenter(),this.getExtent(),q),this._setUpdateFlag(1,!1));var Q=this._boundBox.max;return this._getUpdateFlag(2)&&(this._getMax(this.getCenter(),this.getExtent(),Q),this._setUpdateFlag(2,!1)),this._boundBox;},Q.cloneTo=function(q){var Q=q;this.getMin().cloneTo(Q._boundBox.min),this.getMax().cloneTo(Q._boundBox.max),this.getCenter().cloneTo(Q._center),this.getExtent().cloneTo(Q._extent),Q._updateFlag=0;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q._UPDATE_MIN=1,q._UPDATE_MAX=2,q._UPDATE_CENTER=4,q._UPDATE_EXTENT=8,q;}(),uQ=function(){function a(){this._type=0,this._constant=NaN,this._constantMin=NaN,this._constantMax=NaN;}
S(a,"laya.d3.core.particleShuriKen.module.StartFrame");var q=a.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.cloneTo=function(q){var Q=q;Q._type=this._type,Q._constant=this._constant,Q._constantMin=this._constantMin,Q._constantMax=this._constantMax;},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,q,"constant",function(){return this._constant;}),d(0,q,"type",function(){return this._type;}),d(0,q,"constantMin",function(){return this._constantMin;}),d(0,q,"constantMax",function(){return this._constantMax;}),a.createByConstant=function(q){var Q=new a();return Q._type=0,Q._constant=q,Q;},a.createByRandomTwoConstant=function(q,Q){var m=new a();return m._type=1,m._constantMin=q,m._constantMax=Q,m;},a;}(),fQ=function(){function D(q,Q,m,a){this._children=[],this.transform=new hQ(this,q,Q,m,a);}
S(D,"laya.d3.animation.AnimationNode");var q=D.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.addChild=function(q){q._parent=this,q.transform.setParent(this.transform),this._children.push(q);},q.removeChild=function(q){var Q=this._children.indexOf(q);-
1!==Q&&this._children.splice(Q,1);},q.getChildByName=function(q){for(var Q=0,m=this._children.length;Q<m;Q++){var a=this._children[Q];if(a.name===q)return a;}
return null;},q.getChildByIndex=function(q){return this._children[q];},q.getChildCount=function(){return this._children.length;},q.cloneTo=function(q){var Q=q;Q.name=this.name;for(var m=0,a=this._children.length;m<a;m++){var w=this._children[m],e=w.clone();Q.addChild(e);var F=w.transform,W=e.transform,s=W.localPosition,D=W.localRotation,d=W.localScale;F.localPosition.cloneTo(s),F.localRotation.cloneTo(D),F.localScale.cloneTo(d),W.localPosition=s,W.localRotation=D,W.localScale=d;}},q.clone=function(){var q=new D();return this.cloneTo(q),q;},q._cloneNative=function(q,Q,m,a,w,e,F){var W=F._nativeCurCloneCount;w[W]=e;var s=new D(new Float32Array(q.buffer,3*W*4,3),new Float32Array(Q.buffer,4*W*4,4),new Float32Array(m.buffer,3*W*4,3),new Float32Array(a.buffer,16*W*4,16));return s._worldMatrixIndex=W,this._cloneToNative(s,q,Q,m,a,w,W,F),s;},q._cloneToNative=function(q,Q,m,a,w,e,F,W){var s=q;s.name=this.name;for(var D=0,d=this._children.length;D<d;D++){var v=this._children[D];W._nativeCurCloneCount++;var y=v._cloneNative(Q,m,a,w,e,F,W);s.addChild(y);var S=v.transform,t=y.transform,o=t.localPosition,b=t.localRotation,U=t.localScale;S.localPosition.cloneTo(o),S.localRotation.cloneTo(b),S.localScale.cloneTo(U),t.localPosition=o,t.localRotation=b,t.localScale=U;}},D;}(),pQ=function(){function q(){this._context=null,this._compositeShader=Bq.find("PostProcessComposite"),this._compositeShaderData=new Fq(),this._compositeDefineData=new Lq(),this._effects=[],this._context=new WQ(),this._context.compositeShaderData=this._compositeShaderData,this._context.compositeDefineData=this._compositeDefineData;}
S(q,"laya.d3.component.PostProcess");var Q=q.prototype;return Q._init=function(q,Q){this._context.camera=q,this._context.command=Q;},Q._render=function(){var q=oa.getTemporary(H.clientWidth,H.clientHeight,0,3),Q=this._context.camera.getRenderTexture();this._context.command.clear(),this._context.source=q,this._context.destination=Q;for(var m=0,a=this._effects.length;m<a;m++)this._effects[m].render(this._context);oa.setReleaseTemporary(q);var w=this._context.tempRenderTextures;for(m=0,a=w.length;m<a;m++)oa.setReleaseTemporary(w[m]);},Q.addEffect=function(q){this._effects.push(q);},Q.removeEffect=function(q){var Q=this._effects.indexOf(q);-
1!==Q&&this._effects.splice(Q,1);},q.__init__=function(){q.SHADERDEFINE_BLOOM_LOW=q.shaderDefines.registerDefine("BLOOM_LOW"),q.SHADERDEFINE_BLOOM=q.shaderDefines.registerDefine("BLOOM");},q.SHADERDEFINE_BLOOM_LOW=0,q.SHADERDEFINE_BLOOM=0,y(q,["SHADERVALUE_MAINTEX",function(){return this.SHADERVALUE_MAINTEX=Bq.propertyNameToID("u_MainTex");},"SHADERVALUE_BLOOMTEX",function(){return this.SHADERVALUE_BLOOMTEX=Bq.propertyNameToID("u_BloomTex");},"SHADERVALUE_AUTOEXPOSURETEX",function(){return this.SHADERVALUE_AUTOEXPOSURETEX=Bq.propertyNameToID("u_AutoExposureTex");},"SHADERVALUE_BLOOM_DIRTTEX",function(){return this.SHADERVALUE_BLOOM_DIRTTEX=Bq.propertyNameToID("u_Bloom_DirtTex");},"SHADERVALUE_BLOOMTEX_TEXELSIZE",function(){return this.SHADERVALUE_BLOOMTEX_TEXELSIZE=Bq.propertyNameToID("u_BloomTex_TexelSize");},"SHADERVALUE_BLOOM_DIRTTILEOFFSET",function(){return this.SHADERVALUE_BLOOM_DIRTTILEOFFSET=Bq.propertyNameToID("u_Bloom_DirtTileOffset");},"SHADERVALUE_BLOOM_SETTINGS",function(){return this.SHADERVALUE_BLOOM_SETTINGS=Bq.propertyNameToID("u_Bloom_Settings");},"SHADERVALUE_BLOOM_COLOR",function(){return this.SHADERVALUE_BLOOM_COLOR=Bq.propertyNameToID("u_Bloom_Color");},"shaderDefines",function(){return this.shaderDefines=new dq();}]),q;}(),TQ=function(){function e(q,Q,m,a){this.minDepth=0,this.maxDepth=1,this.x=q,this.y=Q,this.width=m,this.height=a;}
S(e,"laya.d3.math.Viewport");var q=e.prototype;return q.project=function(q,Q,m){_q.transformV3ToV3(q,Q,m);var a=Q.elements,w=q.x*a[3]+q.y*a[7]+q.z*a[11]+a[15];1!==w&&(m.x=m.x/w,m.y=m.y/w,m.z=m.z/w),m.x=.5*(m.x+1)*this.width+this.x,m.y=.5*(1-m.y)*this.height+this.y,m.z=m.z*(this.maxDepth-this.minDepth)+this.minDepth;},q.project1=function(q,Q,m){var a=_q._tempVector4;_q.transformV3ToV4(q,Q,a);var w=a.w;w<.1&&-1e-6<w&&(w=1e-6),a.x/=w,a.y/=w,a.z/=w,m.x=(a.x+1)*this.width/2+this.x,m.y=(1-a.y)*this.height/2+this.y,m.z=a.w;},q.unprojectFromMat=function(q,Q,m){var a=Q.elements;m.x=(q.x-this.x)/this.width*2-1,m.y=-((q.y-this.y)/this.height*2-1);var w=(this.maxDepth-this.minDepth)/2;m.z=(q.z-this.minDepth-w)/w;var e=m.x*a[3]+m.y*a[7]+m.z*a[11]+a[15];_q.transformV3ToV3(m,Q,m),1!==e&&(m.x=m.x/e,m.y=m.y/e,m.z=m.z/e);},q.unprojectFromWVP=function(q,Q,m,a,w){kQ.multiply(Q,m,e._tempMatrix4x4),a&&kQ.multiply(e._tempMatrix4x4,a,e._tempMatrix4x4),e._tempMatrix4x4.invert(e._tempMatrix4x4),this.unprojectFromMat(q,e._tempMatrix4x4,w);},q.cloneTo=function(q){q.x=this.x,q.y=this.y,q.width=this.width,q.height=this.height,q.minDepth=this.minDepth,q.maxDepth=this.maxDepth;},y(e,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new kQ();}]),e;}(),cQ=function(){function q(){this.diffuseTexture=null,this.normalTexture=null,this.scale=null,this.offset=null;}
return S(q,"laya.d3.terrain.unit.DetailTextureInfo"),q;}(),rQ=(function(){function o(q,Q){this.extents=null,this.transformation=null,this.extents=q,this.transformation=Q;}
S(o,"laya.d3.math.OrientedBoundBox");var q=o.prototype;q.getCorners=function(q){o._tempV30.x=this.extents.x,o._tempV30.y=o._tempV30.z=0,o._tempV31.y=this.extents.y,o._tempV31.x=o._tempV31.z=0,o._tempV32.z=this.extents.z,o._tempV32.x=o._tempV32.y=0,_q.TransformNormal(o._tempV30,this.transformation,o._tempV30),_q.TransformNormal(o._tempV31,this.transformation,o._tempV31),_q.TransformNormal(o._tempV32,this.transformation,o._tempV32);var Q=o._tempV33;this.transformation.getTranslationVector(Q),q.length=8,_q.add(Q,o._tempV30,o._tempV34),_q.add(o._tempV34,o._tempV31,o._tempV34),_q.add(o._tempV34,o._tempV32,q[0]),_q.add(Q,o._tempV30,o._tempV34),_q.add(o._tempV34,o._tempV31,o._tempV34),_q.subtract(o._tempV34,o._tempV32,q[1]),_q.subtract(Q,o._tempV30,o._tempV34),_q.add(o._tempV34,o._tempV31,o._tempV34),_q.subtract(o._tempV34,o._tempV32,q[2]),_q.subtract(Q,o._tempV30,o._tempV34),_q.add(o._tempV34,o._tempV31,o._tempV34),_q.add(o._tempV34,o._tempV32,q[3]),_q.add(Q,o._tempV30,o._tempV34),_q.subtract(o._tempV34,o._tempV31,o._tempV34),_q.add(o._tempV34,o._tempV32,q[4]),_q.add(Q,o._tempV30,o._tempV34),_q.subtract(o._tempV34,o._tempV31,o._tempV34),_q.subtract(o._tempV34,o._tempV32,q[5]),_q.subtract(Q,o._tempV30,o._tempV34),_q.subtract(o._tempV34,o._tempV31,o._tempV34),_q.subtract(o._tempV34,o._tempV32,q[6]),_q.subtract(Q,o._tempV30,o._tempV34),_q.subtract(o._tempV34,o._tempV31,o._tempV34),_q.add(o._tempV34,o._tempV32,q[7]);},q.transform=function(q){kQ.multiply(this.transformation,q,this.transformation);},q.scale=function(q){_q.multiply(this.extents,q,this.extents);},q.translate=function(q){this.transformation.getTranslationVector(o._tempV30),_q.add(o._tempV30,q,o._tempV31),this.transformation.setTranslationVector(o._tempV31);},q.Size=function(q){_q.scale(this.extents,2,q);},q.getSize=function(q){o._tempV30.x=this.extents.x,o._tempV31.y=this.extents.y,o._tempV32.z=this.extents.z,_q.TransformNormal(o._tempV30,this.transformation,o._tempV30),_q.TransformNormal(o._tempV31,this.transformation,o._tempV31),_q.TransformNormal(o._tempV31,this.transformation,o._tempV32),q.x=_q.scalarLength(o._tempV30),q.y=_q.scalarLength(o._tempV31),q.z=_q.scalarLength(o._tempV32);},q.getSizeSquared=function(q){o._tempV30.x=this.extents.x,o._tempV31.y=this.extents.y,o._tempV32.z=this.extents.z,_q.TransformNormal(o._tempV30,this.transformation,o._tempV30),_q.TransformNormal(o._tempV31,this.transformation,o._tempV31),_q.TransformNormal(o._tempV31,this.transformation,o._tempV32),q.x=_q.scalarLengthSquared(o._tempV30),q.y=_q.scalarLengthSquared(o._tempV31),q.z=_q.scalarLengthSquared(o._tempV32);},q.getCenter=function(q){this.transformation.getTranslationVector(q);},q.containsPoint=function(q){var Q=this.extents.x,m=this.extents.y,a=this.extents.z;this.transformation.invert(o._tempM0),_q.transformCoordinate(q,o._tempM0,o._tempV30);var w=Math.abs(o._tempV30.x),e=Math.abs(o._tempV30.y),F=Math.abs(o._tempV30.z);return qq.nearEqual(w,Q)&&qq.nearEqual(e,m)&&qq.nearEqual(F,a)?2:w<Q&&e<m&&F<a?1:0;},q.containsPoints=function(q){var Q=this.extents.x,m=this.extents.y,a=this.extents.z;this.transformation.invert(o._tempM0);for(var w=!0,e=!1,F=0;F<q.length;F++){_q.transformCoordinate(q[F],o._tempM0,o._tempV30);var W=Math.abs(o._tempV30.x),s=Math.abs(o._tempV30.y),D=Math.abs(o._tempV30.z);qq.nearEqual(W,Q)&&qq.nearEqual(s,m)&&qq.nearEqual(D,a)&&(e=!0),W<Q&&s<m&&D<a?e=!0:w=!1;}
return w?1:e?2:0;},q.containsSphere=function(q,Q){void 0===Q&&(Q=!1);var m=this.extents.x,a=this.extents.y,w=this.extents.z,e=q.radius;this.transformation.invert(o._tempM0),_q.transformCoordinate(q.center,o._tempM0,o._tempV30);var F=NaN;if(F=Q?e:(_q.scale(_q._UnitX,e,o._tempV31),_q.TransformNormal(o._tempV31,o._tempM0,o._tempV31),_q.scalarLength(o._tempV31)),_q.scale(this.extents,-1,o._tempV32),_q.Clamp(o._tempV30,o._tempV32,this.extents,o._tempV33),F*F<_q.distanceSquared(o._tempV30,o._tempV33))return 0;var W=o._tempV30.x,s=o._tempV30.y,D=o._tempV30.z,d=o._tempV32.x,v=o._tempV32.y,y=o._tempV32.z;return d+F<=W&&W<=m-F&&F<m-d&&v+F<=s&&s<=a-F&&F<a-v&&y+F<=D&&D<=w-F&&F<w-y?1:2;},q.containsOrientedBoundBox=function(q){var Q=0,m=0;q.getCorners(o._corners);var a=this.containsPoints(o._corners);if(0!=a)return a;o._sizeAe[0]=this.extents.x,o._sizeAe[1]=this.extents.y,o._sizeAe[2]=this.extents.z,q.extents.cloneTo(o._tempV35),o._sizeBe[0]=o._tempV35.x,o._sizeBe[1]=o._tempV35.y,o._sizeBe[2]=o._tempV35.z,o._getRows(this.transformation,o._rows1),o._getRows(q.transformation,o._rows2);var w=NaN;for(Q=0;Q<4;Q++)
for(m=0;m<4;m++)3==Q||3==m?(o._tempM0.setElementByRowColumn(Q,m,0),o._tempM1.setElementByRowColumn(Q,m,0)):(w=_q.dot(o._rows1[Q],o._rows2[m]),o._tempM0.setElementByRowColumn(Q,m,w),o._tempM1.setElementByRowColumn(Q,m,Math.abs(w)));for(q.getCenter(o._tempV34),this.getCenter(o._tempV36),_q.subtract(o._tempV34,o._tempV36,o._tempV30),o._tempV31.x=_q.dot(o._tempV30,o._rows1[0]),o._tempV31.y=_q.dot(o._tempV30,o._rows1[1]),o._tempV31.z=_q.dot(o._tempV30,o._rows1[2]),o._vsepAe[0]=o._tempV31.x,o._vsepAe[1]=o._tempV31.y,o._vsepAe[2]=o._tempV31.z,Q=0;Q<3;Q++)
if(o._tempV32.x=o._tempM1.getElementByRowColumn(Q,0),o._tempV32.y=o._tempM1.getElementByRowColumn(Q,1),o._tempV32.z=o._tempM1.getElementByRowColumn(Q,2),o._sizeAe[Q]+_q.dot(o._tempV35,o._tempV32)<Math.abs(o._vsepAe[Q]))return 0;for(m=0;m<3;m++)
if(o._tempV32.x=o._tempM1.getElementByRowColumn(0,m),o._tempV32.y=o._tempM1.getElementByRowColumn(1,m),o._tempV32.z=o._tempM1.getElementByRowColumn(2,m),o._tempV33.x=o._tempM0.getElementByRowColumn(0,m),o._tempV33.y=o._tempM0.getElementByRowColumn(1,m),o._tempV33.z=o._tempM0.getElementByRowColumn(2,m),_q.dot(this.extents,o._tempV32)+o._sizeBe[m]<Math.abs(_q.dot(o._tempV31,o._tempV33)))return 0;for(Q=0;Q<3;Q++)
for(m=0;m<3;m++){var e=(Q+1)%3,F=(Q+2)%3,W=(m+1)%3,s=(m+2)%3;if(o._sizeAe[e]*o._tempM1.getElementByRowColumn(F,m)+o._sizeAe[F]*o._tempM1.getElementByRowColumn(e,m)+(o._sizeBe[W]*o._tempM1.getElementByRowColumn(Q,s)+o._sizeBe[s]*o._tempM1.getElementByRowColumn(Q,W))<Math.abs(o._vsepAe[F]*o._tempM0.getElementByRowColumn(e,m)-o._vsepAe[e]*o._tempM0.getElementByRowColumn(F,m)))return 0;}
return 2;},q.containsLine=function(q,Q){o._corners[0]=q,o._corners[1]=Q;var m=this.containsPoints(o._corners);if(0!=m)return m;var a=this.extents.x,w=this.extents.y,e=this.extents.z;this.transformation.invert(o._tempM0),_q.transformCoordinate(q,o._tempM0,o._tempV30),_q.transformCoordinate(Q,o._tempM0,o._tempV31),_q.add(o._tempV30,o._tempV31,o._tempV32),_q.scale(o._tempV32,.5,o._tempV32),_q.subtract(o._tempV30,o._tempV32,o._tempV33);var F=o._tempV33.x,W=o._tempV33.y,s=o._tempV33.z,D=o._tempV34.x=Math.abs(o._tempV33.x),d=o._tempV34.y=Math.abs(o._tempV33.y),v=o._tempV34.z=Math.abs(o._tempV33.z),y=o._tempV32.x,S=o._tempV32.y,t=o._tempV32.z;return Math.abs(y)>a+D?0:Math.abs(S)>w+d?0:Math.abs(t)>e+v?0:Math.abs(S*s-t*W)>w*v+e*d?0:Math.abs(y*s-t*F)>a*v+e*D?0:Math.abs(y*W-S*F)>a*d+w*D?0:2;},q.containsBoundBox=function(q){var Q=0,m=0,a=q.min,w=q.max;q.getCorners(o._corners);var e=this.containsPoints(o._corners);if(0!=e)return e;_q.subtract(w,a,o._tempV30),_q.scale(o._tempV30,.5,o._tempV30),_q.add(a,o._tempV30,o._tempV30),_q.subtract(w,o._tempV30,o._tempV31),o._sizeAe[0]=this.extents.x,o._sizeAe[1]=this.extents.y,o._sizeAe[2]=this.extents.z,o._sizeBe[0]=o._tempV31.x,o._sizeBe[1]=o._tempV31.y,o._sizeBe[2]=o._tempV31.z,o._getRows(this.transformation,o._rows1),this.transformation.invert(o._tempM0);for(Q=0;Q<3;Q++)
for(m=0;m<3;m++)o._tempM1.setElementByRowColumn(Q,m,Math.abs(o._tempM0.getElementByRowColumn(Q,m)));for(this.getCenter(o._tempV35),_q.subtract(o._tempV30,o._tempV35,o._tempV32),o._tempV31.x=_q.dot(o._tempV32,o._rows1[0]),o._tempV31.y=_q.dot(o._tempV32,o._rows1[1]),o._tempV31.z=_q.dot(o._tempV32,o._rows1[2]),o._vsepAe[0]=o._tempV31.x,o._vsepAe[1]=o._tempV31.y,o._vsepAe[2]=o._tempV31.z,Q=0;Q<3;Q++)
if(o._tempV33.x=o._tempM1.getElementByRowColumn(Q,0),o._tempV33.y=o._tempM1.getElementByRowColumn(Q,1),o._tempV33.z=o._tempM1.getElementByRowColumn(Q,2),o._sizeAe[Q]+_q.dot(o._tempV31,o._tempV33)<Math.abs(o._vsepAe[Q]))return 0;for(m=0;m<3;m++)
if(o._tempV33.x=o._tempM1.getElementByRowColumn(0,m),o._tempV33.y=o._tempM1.getElementByRowColumn(1,m),o._tempV33.z=o._tempM1.getElementByRowColumn(2,m),o._tempV34.x=o._tempM0.getElementByRowColumn(0,m),o._tempV34.y=o._tempM0.getElementByRowColumn(1,m),o._tempV34.z=o._tempM0.getElementByRowColumn(2,m),_q.dot(this.extents,o._tempV33)+o._sizeBe[m]<Math.abs(_q.dot(o._tempV31,o._tempV34)))return 0;for(Q=0;Q<3;Q++)
for(m=0;m<3;m++){var F=(Q+1)%3,W=(Q+2)%3,s=(m+1)%3,D=(m+2)%3;if(o._sizeAe[F]*o._tempM1.getElementByRowColumn(W,m)+o._sizeAe[W]*o._tempM1.getElementByRowColumn(F,m)+(o._sizeBe[s]*o._tempM1.getElementByRowColumn(Q,D)+o._sizeBe[D]*o._tempM1.getElementByRowColumn(Q,s))<Math.abs(o._vsepAe[W]*o._tempM0.getElementByRowColumn(F,m)-o._vsepAe[F]*o._tempM0.getElementByRowColumn(W,m)))return 0;}
return 2;},q.intersectsRay=function(q,Q){_q.scale(this.extents,-1,o._tempV30),this.transformation.invert(o._tempM0),_q.TransformNormal(q.direction,o._tempM0,o._ray.direction),_q.transformCoordinate(q.origin,o._tempM0,o._ray.origin),o._boxBound1.min=o._tempV30,o._boxBound1.max=this.extents;var m=YQ.intersectsRayAndBoxRP(o._ray,o._boxBound1,Q);return-1!==m&&_q.transformCoordinate(Q,this.transformation,Q),m;},q._getLocalCorners=function(q){q.length=8,o._tempV30.x=this.extents.x,o._tempV31.y=this.extents.y,o._tempV32.z=this.extents.z,_q.add(o._tempV30,o._tempV31,o._tempV33),_q.add(o._tempV33,o._tempV32,q[0]),_q.add(o._tempV30,o._tempV31,o._tempV33),_q.subtract(o._tempV33,o._tempV32,q[1]),_q.subtract(o._tempV31,o._tempV30,o._tempV33),_q.subtract(o._tempV33,o._tempV30,q[2]),_q.subtract(o._tempV31,o._tempV30,o._tempV33),_q.add(o._tempV33,o._tempV32,q[3]),_q.subtract(o._tempV30,o._tempV31,o._tempV33),_q.add(o._tempV33,o._tempV32,q[4]),_q.subtract(o._tempV30,o._tempV31,o._tempV33),_q.subtract(o._tempV33,o._tempV32,q[5]),_q.scale(q[0],-1,q[6]),_q.subtract(o._tempV32,o._tempV30,o._tempV33),_q.subtract(o._tempV33,o._tempV31,q[7]);},q.equals=function(q){return this.extents==q.extents&&this.transformation==q.transformation;},q.cloneTo=function(q){var Q=q;this.extents.cloneTo(Q.extents),this.transformation.cloneTo(Q.transformation);},o.createByBoundBox=function(q,Q){var m=q.min,a=q.max;_q.subtract(a,m,o._tempV30),_q.scale(o._tempV30,.5,o._tempV30),_q.add(m,o._tempV30,o._tempV31),_q.subtract(a,o._tempV31,o._tempV32),kQ.translation(o._tempV31,o._tempM0);var w=o._tempV32.clone(),e=o._tempM0.clone();Q.extents=w,Q.transformation=e;},o.createByMinAndMaxVertex=function(q,Q){return _q.subtract(Q,q,o._tempV30),_q.scale(o._tempV30,.5,o._tempV30),_q.add(q,o._tempV30,o._tempV31),_q.subtract(Q,o._tempV31,o._tempV32),kQ.translation(o._tempV31,o._tempM0),new o(o._tempV32,o._tempM0);},o._getRows=function(q,Q){Q.length=3;var m=q.elements;Q[0].x=m[0],Q[0].y=m[1],Q[0].z=m[2],Q[1].x=m[4],Q[1].y=m[5],Q[1].z=m[6],Q[2].x=m[8],Q[2].y=m[9],Q[2].z=m[10];},o.getObbtoObbMatrix4x4=function(q,Q,m,a){var w=q.transformation,e=Q.transformation;if(m){o._getRows(w,o._rows1),o._getRows(e,o._rows2);for(var F=0;F<3;F++)
for(var W=0;W<3;W++)a.setElementByRowColumn(F,W,_q.dot(o._rows2[F],o._rows1[W]));Q.getCenter(o._tempV30),q.getCenter(o._tempV31),_q.subtract(o._tempV30,o._tempV31,o._tempV32);var s=a.elements;s[12]=_q.dot(o._tempV32,o._rows1[0]),s[13]=_q.dot(o._tempV32,o._rows1[1]),s[14]=_q.dot(o._tempV32,o._rows1[2]),s[15]=1;}else w.invert(o._tempM0),kQ.multiply(e,o._tempM0,a);},o.merge=function(q,Q,m){var a=q.extents,w=q.transformation;o.getObbtoObbMatrix4x4(q,Q,m,o._tempM0),Q._getLocalCorners(o._corners),_q.transformCoordinate(o._corners[0],o._tempM0,o._corners[0]),_q.transformCoordinate(o._corners[1],o._tempM0,o._corners[1]),_q.transformCoordinate(o._corners[2],o._tempM0,o._corners[2]),_q.transformCoordinate(o._corners[3],o._tempM0,o._corners[3]),_q.transformCoordinate(o._corners[4],o._tempM0,o._corners[4]),_q.transformCoordinate(o._corners[5],o._tempM0,o._corners[5]),_q.transformCoordinate(o._corners[6],o._tempM0,o._corners[6]),_q.transformCoordinate(o._corners[7],o._tempM0,o._corners[7]),_q.scale(a,-1,o._boxBound1.min),a.cloneTo(o._boxBound1.max),GQ.createfromPoints(o._corners,o._boxBound2),GQ.merge(o._boxBound2,o._boxBound1,o._boxBound3);var e=o._boxBound3.min,F=o._boxBound3.max;_q.subtract(F,e,o._tempV30),_q.scale(o._tempV30,.5,o._tempV30),_q.add(e,o._tempV30,o._tempV32),_q.subtract(F,o._tempV32,a),_q.transformCoordinate(o._tempV32,w,o._tempV33);},y(o,["_tempV30",function(){return this._tempV30=new _q();},"_tempV31",function(){return this._tempV31=new _q();},"_tempV32",function(){return this._tempV32=new _q();},"_tempV33",function(){return this._tempV33=new _q();},"_tempV34",function(){return this._tempV34=new _q();},"_tempV35",function(){return this._tempV35=new _q();},"_tempV36",function(){return this._tempV36=new _q();},"_tempM0",function(){return this._tempM0=new kQ();},"_tempM1",function(){return this._tempM1=new kQ();},"_corners",function(){return this._corners=[new _q(),new _q(),new _q(),new _q(),new _q(),new _q(),new _q(),new _q()];},"_rows1",function(){return this._rows1=[new _q(),new _q(),new _q()];},"_rows2",function(){return this._rows2=[new _q(),new _q(),new _q()];},"_ray",function(){return this._ray=new i(new _q(),new _q());},"_boxBound1",function(){return this._boxBound1=new GQ(new _q(),new _q());},"_boxBound2",function(){return this._boxBound2=new GQ(new _q(),new _q());},"_boxBound3",function(){return this._boxBound3=new GQ(new _q(),new _q());},"_vsepAe",function(){return this._vsepAe=new Float32Array();},"_sizeBe",function(){return this._sizeBe=new Float32Array();},"_sizeAe",function(){return this._sizeAe=new Float32Array();}]);}(),function(){function q(q){void 0===q&&(q=!1),this.isTransparent=q,this.elements=[];}
S(q,"laya.d3.core.render.RenderQueue");var Q=q.prototype;return Q._compare=function(q,Q){var m=q.material.renderQueue-Q.material.renderQueue;return 0!==m?m:(this.isTransparent?Q.render._distanceForSort-q.render._distanceForSort:q.render._distanceForSort-Q.render._distanceForSort)+Q.render.sortingFudge-q.render.sortingFudge;},Q._partitionRenderObject=function(q,Q){for(var m=this.elements[Math.floor((Q+q)/2)];q<=Q;){for(;this._compare(this.elements[q],m)<0;)q++;for(;0<this._compare(this.elements[Q],m);)Q--;if(q<Q){var a=this.elements[q];this.elements[q]=this.elements[Q],this.elements[Q]=a,q++,Q--;}else if(q===Q){q++;break;}}
return q;},Q._quickSort=function(q,Q){if(1<this.elements.length){var m=this._partitionRenderObject(q,Q),a=m-1;q<a&&this._quickSort(q,a),m<Q&&this._quickSort(m,Q);}},Q._render=function(q,Q,m,a){for(var w=0,e=this.elements.length;w<e;w++)this.elements[w]._render(q,Q,m,a);},Q.clear=function(){this.elements.length=0,this.lastTransparentRenderElement=null,this.lastTransparentBatched=!1;},q;}()),_Q=(function(){function q(){}
S(q,"laya.d3.core.TextureMode"),q.Stretch=0,q.Tile=1;}(),function(){function q(){}
S(q,"laya.d3.physics.shape.HeightfieldColliderShape");}(),function(){function w(){}
return S(w,"laya.d3.core.particleShuriKen.module.shape.ShapeUtils"),w._randomPointUnitArcCircle=function(q,Q,m){var a=NaN;a=m?m.getFloat()*q:Math.random()*q,Q.x=Math.cos(a),Q.y=Math.sin(a);},w._randomPointInsideUnitArcCircle=function(q,Q,m){w._randomPointUnitArcCircle(q,Q,m);var a=NaN;a=m?Math.pow(m.getFloat(),.5):Math.pow(Math.random(),.5),Q.x=Q.x*a,Q.y=Q.y*a;},w._randomPointUnitCircle=function(q,Q){var m=NaN;m=Q?Q.getFloat()*Math.PI*2:Math.random()*Math.PI*2,q.x=Math.cos(m),q.y=Math.sin(m);},w._randomPointInsideUnitCircle=function(q,Q){w._randomPointUnitCircle(q);var m=NaN;m=Q?Math.pow(Q.getFloat(),.5):Math.pow(Math.random(),.5),q.x=q.x*m,q.y=q.y*m;},w._randomPointUnitSphere=function(q,Q){var m=NaN,a=NaN;a=Q?(m=q.z=2*Q.getFloat()-1,Q.getFloat()*Math.PI*2):(m=q.z=2*Math.random()-1,Math.random()*Math.PI*2);var w=Math.sqrt(1-m*m);q.x=w*Math.cos(a),q.y=w*Math.sin(a);},w._randomPointInsideUnitSphere=function(q,Q){w._randomPointUnitSphere(q);var m=NaN;m=Q?Math.pow(Q.getFloat(),1/3):Math.pow(Math.random(),1/3),q.x=q.x*m,q.y=q.y*m,q.z=q.z*m;},w._randomPointInsideHalfUnitBox=function(q,Q){q.z=Q?(q.x=Q.getFloat()-.5,q.y=Q.getFloat()-.5,Q.getFloat()-.5):(q.x=Math.random()-.5,q.y=Math.random()-.5,Math.random()-.5);},w;}()),ZQ=function(){function m(){}
return S(m,"laya.d3.graphics.VertexElementFormat"),m.getElementInfos=function(q){var Q=m._elementInfos[q];if(Q)return Q;throw"VertexElementFormat: this vertexElementFormat is not implement.";},m.Single="single",m.Vector2="vector2",m.Vector3="vector3",m.Vector4="vector4",m.Color="color",m.Byte4="byte4",m.Short2="short2",m.Short4="short4",m.NormalizedShort2="normalizedshort2",m.NormalizedShort4="normalizedshort4",m.HalfVector2="halfvector2",m.HalfVector4="halfvector4",y(m,["_elementInfos",function(){return this._elementInfos={single:[1,5126,0],vector2:[2,5126,0],vector3:[3,5126,0],vector4:[4,5126,0],color:[4,5126,0],byte4:[4,5121,0],short2:[2,5126,0],short4:[4,5126,0],normalizedshort2:[2,5126,0],normalizedshort4:[4,5126,0],halfvector2:[2,5126,0],halfvector4:[4,5126,0]};}]),m;}(),AQ=function(){function q(q){this._angularVelocity=null,this.enbale=!1,this._angularVelocity=q;}
S(q,"laya.d3.core.particleShuriKen.module.RotationOverLifetime");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.cloneTo=function(q){var Q=q;this._angularVelocity.cloneTo(Q._angularVelocity),Q.enbale=this.enbale;},Q.clone=function(){var q;switch(this._angularVelocity.type){case 0:q=this._angularVelocity.separateAxes?DQ.createByConstantSeparate(this._angularVelocity.constantSeparate.clone()):DQ.createByConstant(this._angularVelocity.constant);break;case 1:q=this._angularVelocity.separateAxes?DQ.createByGradientSeparate(this._angularVelocity.gradientX.clone(),this._angularVelocity.gradientY.clone(),this._angularVelocity.gradientZ.clone()):DQ.createByGradient(this._angularVelocity.gradient.clone());break;case 2:q=this._angularVelocity.separateAxes?DQ.createByRandomTwoConstantSeparate(this._angularVelocity.constantMinSeparate.clone(),this._angularVelocity.constantMaxSeparate.clone()):DQ.createByRandomTwoConstant(this._angularVelocity.constantMin,this._angularVelocity.constantMax);break;case 3:q=this._angularVelocity.separateAxes?DQ.createByRandomTwoGradientSeparate(this._angularVelocity.gradientXMin.clone(),this._angularVelocity.gradientYMin.clone(),this._angularVelocity.gradientZMin.clone(),this._angularVelocity.gradientWMin.clone(),this._angularVelocity.gradientXMax.clone(),this._angularVelocity.gradientYMax.clone(),this._angularVelocity.gradientZMax.clone(),this._angularVelocity.gradientWMax.clone()):DQ.createByRandomTwoGradient(this._angularVelocity.gradientMin.clone(),this._angularVelocity.gradientMax.clone());}
var Q=new this.constructor(q);return Q.enbale=this.enbale,Q;},d(0,Q,"angularVelocity",function(){return this._angularVelocity;}),q;}(),EQ=function(){function D(q){this._matrix=null,this._near=null,this._far=null,this._left=null,this._right=null,this._top=null,this._bottom=null,this._matrix=q,this._near=new mq(new _q()),this._far=new mq(new _q()),this._left=new mq(new _q()),this._right=new mq(new _q()),this._top=new mq(new _q()),this._bottom=new mq(new _q()),D._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom);}
S(D,"laya.d3.math.BoundFrustum");var q=D.prototype;return q.equalsBoundFrustum=function(q){return this._matrix.equalsOtherMatrix(q.matrix);},q.equalsObj=function(q){if(q instanceof laya.d3.math.BoundFrustum){var Q=q;return this.equalsBoundFrustum(Q);}
return!1;},q.getPlane=function(q){switch(q){case 0:return this._near;case 1:return this._far;case 2:return this._left;case 3:return this._right;case 4:return this._top;case 5:return this._bottom;default:return null;}},q.getCorners=function(q){D._get3PlaneInterPoint(this._near,this._bottom,this._right).cloneTo(q[0]),D._get3PlaneInterPoint(this._near,this._top,this._right).cloneTo(q[1]),D._get3PlaneInterPoint(this._near,this._top,this._left).cloneTo(q[2]),D._get3PlaneInterPoint(this._near,this._bottom,this._left).cloneTo(q[3]),D._get3PlaneInterPoint(this._far,this._bottom,this._right).cloneTo(q[4]),D._get3PlaneInterPoint(this._far,this._top,this._right).cloneTo(q[5]),D._get3PlaneInterPoint(this._far,this._top,this._left).cloneTo(q[6]),D._get3PlaneInterPoint(this._far,this._bottom,this._left).cloneTo(q[7]);},q.containsPoint=function(q){for(var Q=mq.PlaneIntersectionType_Front,m=mq.PlaneIntersectionType_Front,a=0;a<6;a++){switch(a){case 0:m=YQ.intersectsPlaneAndPoint(this._near,q);break;case 1:m=YQ.intersectsPlaneAndPoint(this._far,q);break;case 2:m=YQ.intersectsPlaneAndPoint(this._left,q);break;case 3:m=YQ.intersectsPlaneAndPoint(this._right,q);break;case 4:m=YQ.intersectsPlaneAndPoint(this._top,q);break;case 5:m=YQ.intersectsPlaneAndPoint(this._bottom,q);}
switch(m){case mq.PlaneIntersectionType_Back:return 0;case mq.PlaneIntersectionType_Intersecting:Q=mq.PlaneIntersectionType_Intersecting;}}
switch(Q){case mq.PlaneIntersectionType_Intersecting:return 2;default:return 1;}},q.containsBoundBox=function(q){for(var Q=D._tempV30,m=D._tempV31,a=q.min,w=q.max,e=1,F=0;F<6;F++){var W=this.getPlane(F),s=W.normal;if(0<=s.x?(Q.x=w.x,m.x=a.x):(Q.x=a.x,m.x=w.x),0<=s.y?(Q.y=w.y,m.y=a.y):(Q.y=a.y,m.y=w.y),0<=s.z?(Q.z=w.z,m.z=a.z):(Q.z=a.z,m.z=w.z),YQ.intersectsPlaneAndPoint(W,Q)===mq.PlaneIntersectionType_Back)return 0;YQ.intersectsPlaneAndPoint(W,m)===mq.PlaneIntersectionType_Back&&(e=2);}
return e;},q.containsBoundSphere=function(q){for(var Q=mq.PlaneIntersectionType_Front,m=mq.PlaneIntersectionType_Front,a=0;a<6;a++){switch(a){case 0:m=YQ.intersectsPlaneAndSphere(this._near,q);break;case 1:m=YQ.intersectsPlaneAndSphere(this._far,q);break;case 2:m=YQ.intersectsPlaneAndSphere(this._left,q);break;case 3:m=YQ.intersectsPlaneAndSphere(this._right,q);break;case 4:m=YQ.intersectsPlaneAndSphere(this._top,q);break;case 5:m=YQ.intersectsPlaneAndSphere(this._bottom,q);}
switch(m){case mq.PlaneIntersectionType_Back:return 0;case mq.PlaneIntersectionType_Intersecting:Q=mq.PlaneIntersectionType_Intersecting;}}
switch(Q){case mq.PlaneIntersectionType_Intersecting:return 2;default:return 1;}},d(0,q,"top",function(){return this._top;}),d(0,q,"matrix",function(){return this._matrix;},function(q){this._matrix=q,D._getPlanesFromMatrix(this._matrix,this._near,this._far,this._left,this._right,this._top,this._bottom);}),d(0,q,"near",function(){return this._near;}),d(0,q,"far",function(){return this._far;}),d(0,q,"left",function(){return this._left;}),d(0,q,"right",function(){return this._right;}),d(0,q,"bottom",function(){return this._bottom;}),D._getPlanesFromMatrix=function(q,Q,m,a,w,e,F){var W=q.elements,s=W[0],D=W[1],d=W[2],v=W[3],y=W[4],S=W[5],t=W[6],o=W[7],b=W[8],U=W[9],J=W[10],V=W[11],n=W[12],O=W[13],C=W[14],l=W[15],u=Q.normal;u.x=v+d,u.y=o+t,u.z=V+J,Q.distance=l+C,Q.normalize();var f=m.normal;f.x=v-d,f.y=o-t,f.z=V-J,m.distance=l-C,m.normalize();var p=a.normal;p.x=v+s,p.y=o+y,p.z=V+b,a.distance=l+n,a.normalize();var T=w.normal;T.x=v-s,T.y=o-y,T.z=V-b,w.distance=l-n,w.normalize();var c=e.normal;c.x=v-D,c.y=o-S,c.z=V-U,e.distance=l-O,e.normalize();var r=F.normal;r.x=v+D,r.y=o+S,r.z=V+U,F.distance=l+O,F.normalize();},D._get3PlaneInterPoint=function(q,Q,m){var a=q.normal,w=Q.normal,e=m.normal;_q.cross(w,e,D._tempV30),_q.cross(e,a,D._tempV31),_q.cross(a,w,D._tempV32);var F=_q.dot(a,D._tempV30),W=_q.dot(w,D._tempV31),s=_q.dot(e,D._tempV32);return _q.scale(D._tempV30,-q.distance/F,D._tempV33),_q.scale(D._tempV31,-Q.distance/W,D._tempV34),_q.scale(D._tempV32,-m.distance/s,D._tempV35),_q.add(D._tempV33,D._tempV34,D._tempV36),_q.add(D._tempV35,D._tempV36,D._tempV37),D._tempV37;},y(D,["_tempV30",function(){return this._tempV30=new _q();},"_tempV31",function(){return this._tempV31=new _q();},"_tempV32",function(){return this._tempV32=new _q();},"_tempV33",function(){return this._tempV33=new _q();},"_tempV34",function(){return this._tempV34=new _q();},"_tempV35",function(){return this._tempV35=new _q();},"_tempV36",function(){return this._tempV36=new _q();},"_tempV37",function(){return this._tempV37=new _q();}]),D;}(),BQ=function(){function q(){this.indexInList=-1,this.referenceCount=0,this.updateMark=-1,this.type=-1,this.fullPath=null,this.propertyOwner=null,this.property=null,this.defaultValue=null,this.crossFixedValue=null;}
return S(q,"laya.d3.component.KeyframeNodeOwner"),q.prototype.saveCrossFixedValue=function(){var q=this.propertyOwner;if(q)switch(this.type){case 0:for(var Q=this.property,m=Q.length-1,a=0;a<m&&(q=q[Q[a]]);a++);this.crossFixedValue=q[Q[m]];break;case 1:var w=q.localPosition;this.crossFixedValue||(this.crossFixedValue=new _q()),this.crossFixedValue.x=w.x,this.crossFixedValue.y=w.y,this.crossFixedValue.z=w.z;break;case 2:var e=q.localRotation;this.crossFixedValue||(this.crossFixedValue=new eq()),this.crossFixedValue.x=e.x,this.crossFixedValue.y=e.y,this.crossFixedValue.z=e.z,this.crossFixedValue.w=e.w;break;case 3:var F=q.localScale;this.crossFixedValue||(this.crossFixedValue=new _q()),this.crossFixedValue.x=F.x,this.crossFixedValue.y=F.y,this.crossFixedValue.z=F.z;break;case 4:var W=q.localRotationEuler;this.crossFixedValue||(this.crossFixedValue=new _q()),this.crossFixedValue.x=W.x,this.crossFixedValue.y=W.y,this.crossFixedValue.z=W.z;break;default:throw"Animator:unknown type.";}},q;}(),NQ=function(){function n(){}
return S(n,"laya.d3.graphics.FrustumCulling"),n.__init__=function(){M.supportWebGLPlusCulling&&(n._cullingBufferLength=0,n._cullingBuffer=new Float32Array(4096));},n._drawTraversalCullingBound=function(q,Q){q.length;for(var m=q.elements,a=0,w=q.length;a<w;a++){var e=n._tempColor0;e.r=0,e.g=1,e.b=0,e.a=1,Rq._drawBound(Q,m[a].bounds._getBoundBox(),e);}},n._traversalCulling=function(q,Q,m,a){for(var w=a.length,e=a.elements,F=q.boundFrustum,W=q._transform.position,s=0;s<w;s++){var D=e[s];if(q._isLayerVisible(D._owner._layer)&&D._enable)
if(r.frustumCulling++,!q.useOcclusionCulling||D._needRender(F)){D._visible=!0;var d=D.bounds;D._distanceForSort=_q.distance(d.getCenter(),W);for(var v=D._renderElements,y=0,S=v.length;y<S;y++){var t=v[y],o=Q._getRenderQueue(t.material.renderQueue);o.isTransparent?t.addToTransparentRenderQueue(m,o):t.addToOpaqueRenderQueue(m,o);}}else D._visible=!1;else D._visible=!1;}},n.renderObjectCulling=function(q,Q,m,a){var w=0,e=0,F=Q._opaqueQueue,W=Q._transparentQueue;F.clear(),W.clear();var s=j._managers;for(w=0,e=s.length;w<e;w++)s[w]._clear();var D=I._managers;for(w=0,e=D.length;w<e;w++)D[w]._clear();var d=Q._octree;if(d?(d.updateMotionObjects(),d.shrinkRootIfPossible(),d.getCollidingWithFrustum(m)):n._traversalCulling(q,Q,m,a),R._config.debugFrustumCulling){var v=Q._debugTool;v.clear(),d?(d.drawAllBounds(v),d.drawAllObjects(v)):n._drawTraversalCullingBound(a,v);}
var y=F.elements.length;0<y&&F._quickSort(0,y-1),0<(y=W.elements.length)&&W._quickSort(0,y-1);},n.renderObjectCullingNative=function(q,Q,m,a){var w=0,e=0,F=0,W=0,s=Q._opaqueQueue,D=Q._transparentQueue;s.clear(),D.clear();var d=j._managers;for(w=0,e=d.length;w<e;w++)d[w]._clear();var v=I._managers;for(w=0,e=v.length;w<e;w++)v[w]._clear();var y=a.length,S=a.elements;for(w=0;w<y;w++)S[w].bounds;q.boundFrustum;n.cullingNative(q._boundFrustumBuffer,n._cullingBuffer,Q._cullingBufferIndices,y,Q._cullingBufferResult);var t=m.camera._transform.position;for(w=0;w<y;w++){var o=S[w];if(q._isLayerVisible(o._owner._layer)&&o._enable&&Q._cullingBufferResult[w]){o._visible=!0,o._distanceForSort=_q.distance(o.bounds.getCenter(),t);var b=o._renderElements;for(F=0,W=b.length;F<W;F++){var U=b[F],J=Q._getRenderQueue(U.material.renderQueue);J.isTransparent?U.addToTransparentRenderQueue(m,J):U.addToOpaqueRenderQueue(m,J);}}else o._visible=!1;}
var V=s.elements.length;0<V&&s._quickSort(0,V-1),0<(V=D.elements.length)&&D._quickSort(0,V-1);},n.cullingNative=function(q,Q,m,a,w){return J.instance.culling(q,Q,m,a,w);},n._cullingBufferLength=0,n._cullingBuffer=null,y(n,["_tempVector3",function(){return this._tempVector3=new _q();},"_tempColor0",function(){return this._tempColor0=new tq();}]),n;}(),MQ=function(){function q(q){this._defaultState=null,this._statesMap={},this.playOnWake=!0,this._playType=-1,this._crossMark=0,this._crossDuration=-1,this._crossNodesOwnersIndicesMap={},this._crossNodesOwnersCount=0,this._crossNodesOwners=[],this._currentPlayState=null,this._states=[],this._playStateInfo=new vq(),this._crossPlayStateInfo=new vq(),this._srcCrossClipNodeIndices=[],this._destCrossClipNodeIndices=[],this.name=q,this.defaultWeight=1,this.blendingMode=laya.d3.component.AnimatorControllerLayer.BLENDINGMODE_OVERRIDE;}
S(q,"laya.d3.component.AnimatorControllerLayer");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q.getAnimatorState=function(q){var Q=this._statesMap[q];return Q||null;},Q.destroy=function(){this._statesMap=null,this._states=null,this._playStateInfo=null,this._crossPlayStateInfo=null,this._defaultState=null;},Q.cloneTo=function(q){var Q=q;Q.name=this.name,Q.blendingMode=this.blendingMode,Q.defaultWeight=this.defaultWeight,Q.playOnWake=this.playOnWake;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,Q,"defaultState",function(){return this._defaultState;},function(q){this._defaultState=q,this._statesMap[q.name]=q;}),q.BLENDINGMODE_OVERRIDE=0,q.BLENDINGMODE_ADDTIVE=1,q;}(),YQ=function(){function k(){}
return S(k,"laya.d3.math.CollisionUtils"),k.distancePlaneToPoint=function(q,Q){return _q.dot(q.normal,Q)-q.distance;},k.distanceBoxToPoint=function(q,Q){var m=q.min,a=m.x,w=m.y,e=m.z,F=q.max,W=F.x,s=F.y,D=F.z,d=Q.x,v=Q.y,y=Q.z,S=0;return d<a&&(S+=(a-d)*(a-d)),W<d&&(S+=(W-d)*(W-d)),v<w&&(S+=(w-v)*(w-v)),s<v&&(S+=(s-v)*(s-v)),y<e&&(S+=(e-y)*(e-y)),D<y&&(S+=(D-y)*(D-y)),Math.sqrt(S);},k.distanceBoxToBox=function(q,Q){var m=q.min,a=m.x,w=m.y,e=m.z,F=q.max,W=F.x,s=F.y,D=F.z,d=Q.min,v=d.x,y=d.y,S=d.z,t=Q.max,o=t.x,b=t.y,U=t.z,J=0,V=NaN;return o<a?J+=(V=a-o)*V:W<v&&(J+=(V=v-W)*V),b<w?J+=(V=w-b)*V:s<y&&(J+=(V=y-s)*V),U<e?J+=(V=e-U)*V:D<S&&(J+=(V=S-D)*V),Math.sqrt(J);},k.distanceSphereToPoint=function(q,Q){var m=Math.sqrt(_q.distanceSquared(q.center,Q));return m-=q.radius,Math.max(m,0);},k.distanceSphereToSphere=function(q,Q){var m=Math.sqrt(_q.distanceSquared(q.center,Q.center));return m-=q.radius+Q.radius,Math.max(m,0);},k.intersectsRayAndTriangleRD=function(q,Q,m,a,w){var e=q.origin,F=e.x,W=e.y,s=e.z,D=q.direction,d=D.x,v=D.y,y=D.z,S=Q.x,t=Q.y,o=Q.z,b=m.x,U=m.y,J=m.z,V=a.x,n=a.y,O=a.z,C=k._tempV30.x,l=k._tempV30.y,u=k._tempV30.z;C=b-S,l=U-t,u=J-o;var f=k._tempV31.x,p=k._tempV31.y,T=k._tempV31.z;f=V-S,p=n-t,T=O-o;var c=k._tempV32.x,r=k._tempV32.y,_=k._tempV32.z,Z=C*(c=v*T-y*p)+l*(r=y*f-d*T)+u*(_=d*p-v*f);if(qq.isZero(Z))return 0,!1;var A=1/Z,E=k._tempV33.x,B=k._tempV33.y,N=k._tempV33.z,M=(E=F-S)*c+(B=W-t)*r+(N=s-o)*_;if((M*=A)<0||1<M)return 0,!1;var Y=k._tempV34.x,x=k._tempV34.y,L=k._tempV34.z,G=d*(Y=B*u-N*l)+v*(x=N*C-E*u)+y*(L=E*l-B*C);if((G*=A)<0||1<M+G)return 0,!1;var K=f*Y+p*x+T*L;return(K*=A)<0?(0,!1):(K,!0);},k.intersectsRayAndTriangleRP=function(q,Q,m,a,w){return k.intersectsRayAndTriangleRD(q,Q,m,a,NaN)?(_q.scale(q.direction,NaN,k._tempV30),_q.add(q.origin,k._tempV30,w),!0):(w=_q._ZERO,!1);},k.intersectsRayAndPoint=function(q,Q){_q.subtract(q.origin,Q,k._tempV30);var m=_q.dot(k._tempV30,q.direction),a=_q.dot(k._tempV30,k._tempV30)-qq.zeroTolerance;return!(0<a&&0<m)&&!(m*m-a<0);},k.intersectsRayAndRay=function(q,Q,m){var a=q.origin,w=a.x,e=a.y,F=a.z,W=q.direction,s=W.x,D=W.y,d=W.z,v=Q.origin,y=v.x,S=v.y,t=v.z,o=Q.direction,b=o.x,U=o.y,J=o.z;_q.cross(W,o,k._tempV30);var V=k._tempV30,n=_q.scalarLength(k._tempV30);if(qq.isZero(n)&&qq.nearEqual(y,w)&&qq.nearEqual(S,e)&&qq.nearEqual(t,F))return _q._ZERO,!0;n*=n;var O=y-w,C=S-e,l=t-F,u=b,f=U,p=J,T=V.x,c=V.y,r=V.z,_=(O*f*r+C*p*T+l*u*c-O*p*c-C*u*r-l*f*T)/n;f=D,p=d,u=s;_q.scale(W,_,k._tempV30),_q.scale(o,_,k._tempV31),_q.add(a,k._tempV30,k._tempV32),_q.add(v,k._tempV31,k._tempV33);var Z=k._tempV32,A=k._tempV33;return qq.nearEqual(A.x,Z.x)&&qq.nearEqual(A.y,Z.y)&&qq.nearEqual(A.z,Z.z)?(k._tempV32,!0):(_q._ZERO,!1);},k.intersectsPlaneAndTriangle=function(q,Q,m,a){var w=k.intersectsPlaneAndPoint(q,Q),e=k.intersectsPlaneAndPoint(q,m),F=k.intersectsPlaneAndPoint(q,a);return w==mq.PlaneIntersectionType_Front&&e==mq.PlaneIntersectionType_Front&&F==mq.PlaneIntersectionType_Front?mq.PlaneIntersectionType_Front:w==mq.PlaneIntersectionType_Back&&e==mq.PlaneIntersectionType_Back&&F==mq.PlaneIntersectionType_Back?mq.PlaneIntersectionType_Back:mq.PlaneIntersectionType_Intersecting;},k.intersectsRayAndPlaneRD=function(q,Q,m){var a=Q.normal,w=_q.dot(a,q.direction);if(qq.isZero(w))return 0,!1;var e=_q.dot(a,q.origin);return!((-Q.distance-e)/w<0)||(0,!1);},k.intersectsRayAndPlaneRP=function(q,Q,m){return k.intersectsRayAndPlaneRD(q,Q,NaN)?(_q.scale(q.direction,NaN,k._tempV30),_q.add(q.origin,k._tempV30,k._tempV31),k._tempV31,!0):(_q._ZERO,!1);},k.intersectsRayAndBoxRD=function(q,Q){var m=q.origin,a=m.x,w=m.y,e=m.z,F=q.direction,W=F.x,s=F.y,D=F.z,d=Q.min,v=d.x,y=d.y,S=d.z,t=Q.max,o=t.x,b=t.y,U=t.z,J=0,V=qq.MaxValue;if(qq.isZero(W)){if(a<v||o<a)return-1;}else{var n=1/W,O=(v-a)*n,C=(o-a)*n;if(C<O){var l=O;O=C,C=l;}
if(J=Math.max(O,J),(V=Math.min(C,V))<J)return-1;}
if(qq.isZero(s)){if(w<y||b<w)return-1;}else{var u=1/s,f=(y-w)*u,p=(b-w)*u;if(p<f){var T=f;f=p,p=T;}
if(J=Math.max(f,J),(V=Math.min(p,V))<J)return-1;}
if(qq.isZero(D)){if(e<S||U<e)return-1;}else{var c=1/D,r=(S-e)*c,_=(U-e)*c;if(_<r){var Z=r;r=_,_=Z;}
if(J=Math.max(r,J),(V=Math.min(_,V))<J)return-1;}
return J;},k.intersectsRayAndBoxRP=function(q,Q,m){var a=k.intersectsRayAndBoxRD(q,Q);return-1===a?_q._ZERO.cloneTo(m):(_q.scale(q.direction,a,k._tempV30),_q.add(q.origin,k._tempV30,k._tempV31),k._tempV31.cloneTo(m)),a;},k.intersectsRayAndSphereRD=function(q,Q){var m=Q.radius;_q.subtract(q.origin,Q.center,k._tempV30);var a=_q.dot(k._tempV30,q.direction),w=_q.dot(k._tempV30,k._tempV30)-m*m;if(0<w&&0<a)return-1;var e=a*a-w;if(e<0)return-1;var F=-a-Math.sqrt(e);return F<0&&(F=0),F;},k.intersectsRayAndSphereRP=function(q,Q,m){var a=k.intersectsRayAndSphereRD(q,Q);return-1===a?_q._ZERO.cloneTo(m):(_q.scale(q.direction,a,k._tempV30),_q.add(q.origin,k._tempV30,k._tempV31),k._tempV31.cloneTo(m)),a;},k.intersectsSphereAndTriangle=function(q,Q,m,a){var w=q.center,e=q.radius;return k.closestPointPointTriangle(w,Q,m,a,k._tempV30),_q.subtract(k._tempV30,w,k._tempV31),_q.dot(k._tempV31,k._tempV31)<=e*e;},k.intersectsPlaneAndPoint=function(q,Q){var m=_q.dot(q.normal,Q)+q.distance;return 0<m?mq.PlaneIntersectionType_Front:m<0?mq.PlaneIntersectionType_Back:mq.PlaneIntersectionType_Intersecting;},k.intersectsPlaneAndPlane=function(q,Q){_q.cross(q.normal,Q.normal,k._tempV30);var m=_q.dot(k._tempV30,k._tempV30);return!qq.isZero(m);},k.intersectsPlaneAndPlaneRL=function(q,Q,m){var a=q.normal,w=Q.normal;_q.cross(a,w,k._tempV34);var e=_q.dot(k._tempV34,k._tempV34);return!qq.isZero(e)&&(_q.scale(w,q.distance,k._tempV30),_q.scale(a,Q.distance,k._tempV31),_q.subtract(k._tempV30,k._tempV31,k._tempV32),_q.cross(k._tempV32,k._tempV34,k._tempV33),_q.normalize(k._tempV34,k._tempV34),new i(k._tempV33,k._tempV34),!0);},k.intersectsPlaneAndBox=function(q,Q){var m=q.distance,a=q.normal,w=a.x,e=a.y,F=a.z,W=Q.min,s=W.x,D=W.y,d=W.z,v=Q.max,y=v.x,S=v.y,t=v.z;k._tempV30.x=0<w?s:y,k._tempV30.y=0<e?D:S,k._tempV30.z=0<F?d:t,k._tempV31.x=0<w?y:s,k._tempV31.y=0<e?S:D,k._tempV31.z=0<F?t:d;var o=_q.dot(a,k._tempV30);return 0<o+m?mq.PlaneIntersectionType_Front:(o=_q.dot(a,k._tempV31))+m<0?mq.PlaneIntersectionType_Back:mq.PlaneIntersectionType_Intersecting;},k.intersectsPlaneAndSphere=function(q,Q){var m=Q.radius,a=_q.dot(q.normal,Q.center)+q.distance;return m<a?mq.PlaneIntersectionType_Front:a<-m?mq.PlaneIntersectionType_Back:mq.PlaneIntersectionType_Intersecting;},k.intersectsBoxAndBox=function(q,Q){var m=q.min,a=q.max,w=Q.min,e=Q.max;return!(m.x>e.x||w.x>a.x)&&(!(m.y>e.y||w.y>a.y)&&!(m.z>e.z||w.z>a.z));},k.intersectsBoxAndSphere=function(q,Q){var m=Q.center,a=Q.radius;return _q.Clamp(m,q.min,q.max,k._tempV30),_q.distanceSquared(m,k._tempV30)<=a*a;},k.intersectsSphereAndSphere=function(q,Q){var m=q.radius+Q.radius;return _q.distanceSquared(q.center,Q.center)<=m*m;},k.boxContainsPoint=function(q,Q){var m=q.min,a=q.max;return m.x<=Q.x&&a.x>=Q.x&&m.y<=Q.y&&a.y>=Q.y&&m.z<=Q.z&&a.z>=Q.z?1:0;},k.boxContainsBox=function(q,Q){var m=q.min,a=m.x,w=m.y,e=m.z,F=q.max,W=F.x,s=F.y,D=F.z,d=Q.min,v=d.x,y=d.y,S=d.z,t=Q.max,o=t.x,b=t.y,U=t.z;return W<v||o<a?0:s<y||b<w?0:D<S||U<e?0:a<=v&&o<=W&&w<=y&&b<=s&&e<=S&&U<=D?1:2;},k.boxContainsSphere=function(q,Q){var m=q.min,a=m.x,w=m.y,e=m.z,F=q.max,W=F.x,s=F.y,D=F.z,d=Q.center,v=d.x,y=d.y,S=d.z,t=Q.radius;return _q.Clamp(d,m,F,k._tempV30),t*t<_q.distanceSquared(d,k._tempV30)?0:a+t<=v&&v<=W-t&&t<W-a&&w+t<=y&&y<=s-t&&t<s-w&&e+t<=S&&S<=D-t&&t<D-e?1:2;},k.sphereContainsPoint=function(q,Q){return _q.distanceSquared(Q,q.center)<=q.radius*q.radius?1:0;},k.sphereContainsTriangle=function(q,Q,m,a){var w=k.sphereContainsPoint(q,Q),e=k.sphereContainsPoint(q,m),F=k.sphereContainsPoint(q,a);return 1==w&&1==e&&1==F?1:k.intersectsSphereAndTriangle(q,Q,m,a)?2:0;},k.sphereContainsBox=function(q,Q){var m=q.center,a=m.x,w=m.y,e=m.z,F=q.radius,W=Q.min,s=W.x,D=W.y,d=W.z,v=Q.max,y=v.x,S=v.y,t=v.z,o=k._tempV30;o.x,o.y,o.z;if(!k.intersectsBoxAndSphere(Q,q))return 0;var b=F*F;return a-s,w-S,e-t,_q.scalarLengthSquared(k._tempV30)>b?2:(a-y,w-S,e-t,_q.scalarLengthSquared(k._tempV30)>b?2:(a-y,w-D,e-t,_q.scalarLengthSquared(k._tempV30)>b?2:(a-s,w-D,e-t,_q.scalarLengthSquared(k._tempV30)>b?2:(a-s,w-S,e-d,_q.scalarLengthSquared(k._tempV30)>b?2:(a-y,w-S,e-d,_q.scalarLengthSquared(k._tempV30)>b?2:(a-y,w-D,e-d,_q.scalarLengthSquared(k._tempV30)>b?2:(a-s,w-D,e-d,_q.scalarLengthSquared(k._tempV30)>b?2:1)))))));},k.sphereContainsSphere=function(q,Q){var m=q.radius,a=Q.radius,w=_q.distance(q.center,Q.center);return m+a<w?0:m-a<w?2:1;},k.closestPointPointTriangle=function(q,Q,m,a,w){_q.subtract(m,Q,k._tempV30),_q.subtract(a,Q,k._tempV31),_q.subtract(q,Q,k._tempV32),_q.subtract(q,m,k._tempV33),_q.subtract(q,a,k._tempV34);var e=_q.dot(k._tempV30,k._tempV32),F=_q.dot(k._tempV31,k._tempV32),W=_q.dot(k._tempV30,k._tempV33),s=_q.dot(k._tempV31,k._tempV33),D=_q.dot(k._tempV30,k._tempV34),d=_q.dot(k._tempV31,k._tempV34);if(e<=0&&F<=0)Q.cloneTo(w);else if(0<=W&&s<=W)m.cloneTo(w);else{var v=e*s-W*F;if(v<=0&&0<=e&&W<=0){var y=e/(e-W);return _q.scale(k._tempV30,y,w),void _q.add(Q,w,w);}
if(0<=d&&D<=d)a.cloneTo(w);else{var S=D*F-e*d;if(S<=0&&0<=F&&d<=0){var t=F/(F-d);return _q.scale(k._tempV31,t,w),void _q.add(Q,w,w);}
var o=W*d-D*s;if(o<=0&&0<=s-W&&0<=D-d){var b=(s-W)/(s-W+(D-d));return _q.subtract(a,m,w),_q.scale(w,b,w),void _q.add(m,w,w);}
var U=1/(o+S+v),J=S*U,V=v*U;_q.scale(k._tempV30,J,k._tempV35),_q.scale(k._tempV31,V,k._tempV36),_q.add(k._tempV35,k._tempV36,w),_q.add(Q,w,w);}}},k.closestPointPlanePoint=function(q,Q,m){var a=q.normal,w=_q.dot(a,Q)-q.distance;_q.scale(a,w,k._tempV30),_q.subtract(Q,k._tempV30,m);},k.closestPointBoxPoint=function(q,Q,m){_q.max(Q,q.min,k._tempV30),_q.min(k._tempV30,q.max,m);},k.closestPointSpherePoint=function(q,Q,m){var a=q.center;_q.subtract(Q,a,m),_q.normalize(m,m),_q.scale(m,q.radius,m),_q.add(m,a,m);},k.closestPointSphereSphere=function(q,Q,m){var a=q.center;_q.subtract(Q.center,a,m),_q.normalize(m,m),_q.scale(m,q.radius,m),_q.add(m,a,m);},y(k,["_tempV30",function(){return this._tempV30=new _q();},"_tempV31",function(){return this._tempV31=new _q();},"_tempV32",function(){return this._tempV32=new _q();},"_tempV33",function(){return this._tempV33=new _q();},"_tempV34",function(){return this._tempV34=new _q();},"_tempV35",function(){return this._tempV35=new _q();},"_tempV36",function(){return this._tempV36=new _q();}]),k;}(),xQ=function(){function s(){var q=this.elements=new Float32Array(9);q[0]=1,q[1]=0,q[2]=0,q[3]=0,q[4]=1,q[5]=0,q[6]=0,q[7]=0,q[8]=1;}
S(s,"laya.d3.math.Matrix3x3");var q=s.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.determinant=function(){var q=this.elements,Q=q[0],m=q[1],a=q[2],w=q[3],e=q[4],F=q[5],W=q[6],s=q[7],D=q[8];return Q*(D*e-F*s)+m*(-D*w+F*W)+a*(s*w-e*W);},q.translate=function(q,Q){var m=Q.elements,a=this.elements,w=a[0],e=a[1],F=a[2],W=a[3],s=a[4],D=a[5],d=a[6],v=a[7],y=a[8],S=q.x,t=q.y;m[0]=w,m[1]=e,m[2]=F,m[3]=W,m[4]=s,m[5]=D,m[6]=S*w+t*W+d,m[7]=S*e+t*s+v,m[8]=S*F+t*D+y;},q.rotate=function(q,Q){var m=Q.elements,a=this.elements,w=a[0],e=a[1],F=a[2],W=a[3],s=a[4],D=a[5],d=a[6],v=a[7],y=a[8],S=Math.sin(q),t=Math.cos(q);m[0]=t*w+S*W,m[1]=t*e+S*s,m[2]=t*F+S*D,m[3]=t*W-S*w,m[4]=t*s-S*e,m[5]=t*D-S*F,m[6]=d,m[7]=v,m[8]=y;},q.scale=function(q,Q){var m=Q.elements,a=this.elements,w=q.x,e=q.y;m[0]=w*a[0],m[1]=w*a[1],m[2]=w*a[2],m[3]=e*a[3],m[4]=e*a[4],m[5]=e*a[5],m[6]=a[6],m[7]=a[7],m[8]=a[8];},q.invert=function(q){var Q=q.elements,m=this.elements,a=m[0],w=m[1],e=m[2],F=m[3],W=m[4],s=m[5],D=m[6],d=m[7],v=m[8],y=v*W-s*d,S=-v*F+s*D,t=d*F-W*D,o=a*y+w*S+e*t;o||(q=null),o=1/o,Q[0]=y*o,Q[1]=(-v*w+e*d)*o,Q[2]=(s*w-e*W)*o,Q[3]=S*o,Q[4]=(v*a-e*D)*o,Q[5]=(-s*a+e*F)*o,Q[6]=t*o,Q[7]=(-d*a+w*D)*o,Q[8]=(W*a-w*F)*o;},q.transpose=function(q){var Q=q.elements,m=this.elements;if(q===this){var a=m[1],w=m[2],e=m[5];Q[1]=m[3],Q[2]=m[6],Q[3]=a,Q[5]=m[7],Q[6]=w,Q[7]=e;}else Q[0]=m[0],Q[1]=m[3],Q[2]=m[6],Q[3]=m[1],Q[4]=m[4],Q[5]=m[7],Q[6]=m[2],Q[7]=m[5],Q[8]=m[8];},q.identity=function(){var q=this.elements;q[0]=1,q[1]=0,q[2]=0,q[3]=0,q[4]=1,q[5]=0,q[6]=0,q[7]=0,q[8]=1;},q.cloneTo=function(q){var Q,m,a;if((m=this.elements)!==(a=q.elements))
for(Q=0;Q<9;++Q)a[Q]=m[Q];},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},s.createFromTranslation=function(q,Q){Q.elements;Q[0]=1,Q[1]=0,Q[2]=0,Q[3]=0,Q[4]=1,Q[5]=0,Q[6]=q.x,Q[7]=q.y,Q[8]=1;},s.createFromRotation=function(q,Q){var m=Q.elements,a=Math.sin(q),w=Math.cos(q);m[0]=w,m[1]=a,m[2]=0,m[3]=-a,m[4]=w,m[5]=0,m[6]=0,m[7]=0,m[8]=1;},s.createFromScaling=function(q,Q){var m=Q.elements;m[0]=q.x,m[1]=0,m[2]=0,m[3]=0,m[4]=q.y,m[5]=0,m[6]=0,m[7]=0,m[8]=1;},s.createFromMatrix4x4=function(q,Q){Q[0]=q[0],Q[1]=q[1],Q[2]=q[2],Q[3]=q[4],Q[4]=q[5],Q[5]=q[6],Q[6]=q[8],Q[7]=q[9],Q[8]=q[10];},s.multiply=function(q,Q,m){var a=m.elements,w=q.elements,e=Q.elements,F=w[0],W=w[1],s=w[2],D=w[3],d=w[4],v=w[5],y=w[6],S=w[7],t=w[8],o=e[0],b=e[1],U=e[2],J=e[3],V=e[4],n=e[5],O=e[6],C=e[7],l=e[8];a[0]=o*F+b*D+U*y,a[1]=o*W+b*d+U*S,a[2]=o*s+b*v+U*t,a[3]=J*F+V*D+n*y,a[4]=J*W+V*d+n*S,a[5]=J*s+V*v+n*t,a[6]=O*F+C*D+l*y,a[7]=O*W+C*d+l*S,a[8]=O*s+C*v+l*t;},s.lookAt=function(q,Q,m,a){_q.subtract(q,Q,s._tempV30),_q.normalize(s._tempV30,s._tempV30),_q.cross(m,s._tempV30,s._tempV31),_q.normalize(s._tempV31,s._tempV31),_q.cross(s._tempV30,s._tempV31,s._tempV32);var w=s._tempV30,e=s._tempV31,F=s._tempV32,W=a.elements;W[0]=e.x,W[3]=e.y,W[6]=e.z,W[1]=F.x,W[4]=F.y,W[7]=F.z,W[2]=w.x,W[5]=w.y,W[8]=w.z;},s.DEFAULT=new s(),y(s,["_tempV30",function(){return this._tempV30=new _q();},"_tempV31",function(){return this._tempV31=new _q();},"_tempV32",function(){return this._tempV32=new _q();}]),s;}(),LQ=function(){function q(){}
return S(q,"laya.d3.utils.Physics3DUtils"),q.setColliderCollision=function(q,Q,m){},q.getIColliderCollision=function(q,Q){return!1;},q.COLLISIONFILTERGROUP_DEFAULTFILTER=1,q.COLLISIONFILTERGROUP_STATICFILTER=2,q.COLLISIONFILTERGROUP_KINEMATICFILTER=4,q.COLLISIONFILTERGROUP_DEBRISFILTER=8,q.COLLISIONFILTERGROUP_SENSORTRIGGER=16,q.COLLISIONFILTERGROUP_CHARACTERFILTER=32,q.COLLISIONFILTERGROUP_CUSTOMFILTER1=64,q.COLLISIONFILTERGROUP_CUSTOMFILTER2=128,q.COLLISIONFILTERGROUP_CUSTOMFILTER3=256,q.COLLISIONFILTERGROUP_CUSTOMFILTER4=512,q.COLLISIONFILTERGROUP_CUSTOMFILTER5=1024,q.COLLISIONFILTERGROUP_CUSTOMFILTER6=2048,q.COLLISIONFILTERGROUP_CUSTOMFILTER7=4096,q.COLLISIONFILTERGROUP_CUSTOMFILTER8=8192,q.COLLISIONFILTERGROUP_CUSTOMFILTER9=16384,q.COLLISIONFILTERGROUP_CUSTOMFILTER10=32768,q.COLLISIONFILTERGROUP_ALLFILTER=-1,y(q,["gravity",function(){return this.gravity=new _q(0,-9.81,0);}]),q;}(),GQ=function(){function w(q,Q){this.min=null,this.max=null,this.min=q,this.max=Q;}
S(w,"laya.d3.math.BoundBox");var q=w.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q._rotateExtents=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=Q.elements;m.x=Math.abs(F[0]*a)+Math.abs(F[4]*w)+Math.abs(F[8]*e),m.y=Math.abs(F[1]*a)+Math.abs(F[5]*w)+Math.abs(F[9]*e),m.z=Math.abs(F[2]*a)+Math.abs(F[6]*w)+Math.abs(F[10]*e);},q.getCorners=function(q){q.length=8;var Q=this.min.x,m=this.min.y,a=this.min.z,w=this.max.x,e=this.max.y,F=this.max.z;q[0]=new _q(Q,e,F),q[1]=new _q(w,e,F),q[2]=new _q(w,m,F),q[3]=new _q(Q,m,F),q[4]=new _q(Q,e,a),q[5]=new _q(w,e,a),q[6]=new _q(w,m,a),q[7]=new _q(Q,m,a);},q.getCenter=function(q){_q.add(this.min,this.max,q),_q.scale(q,.5,q);},q.getExtent=function(q){_q.subtract(this.max,this.min,q),_q.scale(q,.5,q);},q.setCenterAndExtent=function(q,Q){_q.subtract(q,Q,this.min),_q.add(q,Q,this.max);},q.tranform=function(q,Q){var m=w._tempVector30,a=w._tempVector31;this.getCenter(m),this.getExtent(a),_q.transformCoordinate(m,q,m),this._rotateExtents(a,q,a),Q.setCenterAndExtent(m,a);},q.toDefault=function(){this.min.toDefault(),this.max.toDefault();},q.cloneTo=function(q){var Q=q;this.min.cloneTo(Q.min),this.max.cloneTo(Q.max);},q.clone=function(){var q=new this.constructor(new _q(),new _q());return this.cloneTo(q),q;},w.createfromPoints=function(q,Q){if(null==q)throw new Error("points");var m=Q.min,a=Q.max;m.x=Number.MAX_VALUE,m.y=Number.MAX_VALUE,m.z=Number.MAX_VALUE,a.x=-Number.MAX_VALUE,a.y=-Number.MAX_VALUE,a.z=-Number.MAX_VALUE;for(var w=0,e=q.length;w<e;++w)_q.min(m,q[w],m),_q.max(a,q[w],a);},w.merge=function(q,Q,m){_q.min(q.min,Q.min,m.min),_q.max(q.max,Q.max,m.max);},y(w,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();}]),w;}(),KQ=function(){function q(){this.speed=1,this.clipStart=0,this.clipEnd=1,this._nodeOwners=[];}
S(q,"laya.d3.component.AnimatorState");var Q=q.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q._resetFrameIndices=function(){for(var q=0,Q=this._currentFrameIndices.length;q<Q;q++)this._currentFrameIndices[q]=-1;},Q.addScript=function(q){var Q=new q();return this._scripts=this._scripts||[],this._scripts.push(Q),Q;},Q.getScript=function(q){if(this._scripts)
for(var Q=0,m=this._scripts.length;Q<m;Q++){var a=this._scripts[Q];if(o.__typeof(a,q))return a;}
return null;},Q.getScripts=function(q){var Q;if(this._scripts)
for(var m=0,a=this._scripts.length;m<a;m++){var w=this._scripts[m];o.__typeof(w,q)&&(Q=Q||[]).push(w);}
return Q;},Q.cloneTo=function(q){var Q=q;Q.name=this.name,Q.speed=this.speed,Q.clipStart=this.clipStart,Q.clipEnd=this.clipEnd,Q.clip=this._clip;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,Q,"clip",function(){return this._clip;},function(q){this._clip=q,this._currentFrameIndices=new Int16Array(q._nodes.count),this._resetFrameIndices();}),q;}(),kQ=(function(){function q(){this._vertices=null,this._vertexBuffer=null,this._text=null,this._fontSize=0,this._color=null;}
S(q,"laya.d3.text.TextMesh");var Q=q.prototype;Q._createVertexBuffer=function(q){},Q._resizeVertexBuffer=function(q){},Q._addChar=function(){},d(0,Q,"text",function(){return this._text;},function(q){this._text=q;}),d(0,Q,"fontSize",function(){return this._fontSize;},function(q){this._fontSize=q;}),d(0,Q,"color",function(){return this._color;},function(q){this._color=q;}),q._indexBuffer=null;}(),function(){function l(q,Q,m,a,w,e,F,W,s,D,d,v,y,S,t,o,b){void 0===q&&(q=1),void 0===Q&&(Q=0),void 0===m&&(m=0),void 0===a&&(a=0),void 0===w&&(w=0),void 0===e&&(e=1),void 0===F&&(F=0),void 0===W&&(W=0),void 0===s&&(s=0),void 0===D&&(D=0),void 0===d&&(d=1),void 0===v&&(v=0),void 0===y&&(y=0),void 0===S&&(S=0),void 0===t&&(t=0),void 0===o&&(o=1);var U=this.elements=b||new Float32Array(16);U[0]=q,U[1]=Q,U[2]=m,U[3]=a,U[4]=w,U[5]=e,U[6]=F,U[7]=W,U[8]=s,U[9]=D,U[10]=d,U[11]=v,U[12]=y,U[13]=S,U[14]=t,U[15]=o;}
S(l,"laya.d3.math.Matrix4x4");var q=l.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q.setRotation=function(q){var Q=q.x,m=q.y,a=q.z,w=q.w,e=Q*Q,F=m*m,W=a*a,s=Q*m,D=a*w,d=a*Q,v=m*w,y=m*a,S=Q*w,t=this.elements;t[0]=1-2*(F+W),t[1]=2*(s+D),t[2]=2*(d-v),t[4]=2*(s-D),t[5]=1-2*(W+e),t[6]=2*(y+S),t[8]=2*(d+v),t[9]=2*(y-S),t[10]=1-2*(F+e);},q.setPosition=function(q){var Q=this.elements;Q[12]=q.x,Q[13]=q.y,Q[14]=q.z;},q.getElementByRowColumn=function(q,Q){if(q<0||3<q)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(Q<0||3<Q)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");return this.elements[4*q+Q];},q.setElementByRowColumn=function(q,Q,m){if(q<0||3<q)throw new Error("row","Rows and columns for matrices run from 0 to 3, inclusive.");if(Q<0||3<Q)throw new Error("column","Rows and columns for matrices run from 0 to 3, inclusive.");this.elements[4*q+Q]=m;},q.equalsOtherMatrix=function(q){var Q=this.elements,m=q.elements;return qq.nearEqual(Q[0],m[0])&&qq.nearEqual(Q[1],m[1])&&qq.nearEqual(Q[2],m[2])&&qq.nearEqual(Q[3],m[3])&&qq.nearEqual(Q[4],m[4])&&qq.nearEqual(Q[5],m[5])&&qq.nearEqual(Q[6],m[6])&&qq.nearEqual(Q[7],m[7])&&qq.nearEqual(Q[8],m[8])&&qq.nearEqual(Q[9],m[9])&&qq.nearEqual(Q[10],m[10])&&qq.nearEqual(Q[11],m[11])&&qq.nearEqual(Q[12],m[12])&&qq.nearEqual(Q[13],m[13])&&qq.nearEqual(Q[14],m[14])&&qq.nearEqual(Q[15],m[15]);},q.decomposeTransRotScale=function(q,Q,m){var a=l._tempMatrix4x4;return this.decomposeTransRotMatScale(q,a,m)?(eq.createFromMatrix4x4(a,Q),!0):(Q.identity(),!1);},q.decomposeTransRotMatScale=function(q,Q,m){var a=this.elements,w=q,e=Q.elements,F=m;w.x=a[12],w.y=a[13],w.z=a[14];var W=a[0],s=a[1],D=a[2],d=a[4],v=a[5],y=a[6],S=a[8],t=a[9],o=a[10],b=F.x=Math.sqrt(W*W+s*s+D*D),U=F.y=Math.sqrt(d*d+v*v+y*y),J=F.z=Math.sqrt(S*S+t*t+o*o);if(qq.isZero(b)||qq.isZero(U)||qq.isZero(J))return e[1]=e[2]=e[3]=e[4]=e[6]=e[7]=e[8]=e[9]=e[11]=e[12]=e[13]=e[14]=0,e[0]=e[5]=e[10]=e[15]=1,!1;var V=l._tempVector0;V.x=S/J,V.y=t/J,V.z=o/J;var n=l._tempVector1;n.x=W/b,n.y=s/b,n.z=D/b;var O=l._tempVector2;_q.cross(V,n,O);var C=l._tempVector1;return _q.cross(O,V,C),e[3]=e[7]=e[11]=e[12]=e[13]=e[14]=0,e[15]=1,e[0]=C.x,e[1]=C.y,e[2]=C.z,e[4]=O.x,e[5]=O.y,e[6]=O.z,e[8]=V.x,e[9]=V.y,e[10]=V.z,e[0]*W+e[1]*s+e[2]*D<0&&(F[0]=-b),e[4]*d+e[5]*v+e[6]*y<0&&(F[1]=-U),e[8]*S+e[9]*t+e[10]*o<0&&(F[2]=-J),!0;},q.decomposeYawPitchRoll=function(q){var Q=Math.asin(-this.elements[9]);q.y=Q,Math.cos(Q)>qq.zeroTolerance?(q.z=Math.atan2(this.elements[1],this.elements[5]),q.x=Math.atan2(this.elements[8],this.elements[10])):(q.z=Math.atan2(-this.elements[4],this.elements[0]),q.x=0);},q.normalize=function(){var q=this.elements,Q=q[0],m=q[1],a=q[2],w=Math.sqrt(Q*Q+m*m+a*a);if(!w)return q[0]=0,q[1]=0,void(q[2]=0);1!=w&&(w=1/w,q[0]=Q*w,q[1]=m*w,q[2]=a*w);},q.transpose=function(){var q,Q;return Q=(q=this.elements)[1],q[1]=q[4],q[4]=Q,Q=q[2],q[2]=q[8],q[8]=Q,Q=q[3],q[3]=q[12],q[12]=Q,Q=q[6],q[6]=q[9],q[9]=Q,Q=q[7],q[7]=q[13],q[13]=Q,Q=q[11],q[11]=q[14],q[14]=Q,this;},q.invert=function(q){var Q=this.elements,m=q.elements,a=Q[0],w=Q[1],e=Q[2],F=Q[3],W=Q[4],s=Q[5],D=Q[6],d=Q[7],v=Q[8],y=Q[9],S=Q[10],t=Q[11],o=Q[12],b=Q[13],U=Q[14],J=Q[15],V=a*s-w*W,n=a*D-e*W,O=a*d-F*W,C=w*D-e*s,l=w*d-F*s,u=e*d-F*D,f=v*b-y*o,p=v*U-S*o,T=v*J-t*o,c=y*U-S*b,r=y*J-t*b,_=S*J-t*U,Z=V*_-n*r+O*c+C*T-l*p+u*f;0!==Math.abs(Z)&&(Z=1/Z,m[0]=(s*_-D*r+d*c)*Z,m[1]=(e*r-w*_-F*c)*Z,m[2]=(b*u-U*l+J*C)*Z,m[3]=(S*l-y*u-t*C)*Z,m[4]=(D*T-W*_-d*p)*Z,m[5]=(a*_-e*T+F*p)*Z,m[6]=(U*O-o*u-J*n)*Z,m[7]=(v*u-S*O+t*n)*Z,m[8]=(W*r-s*T+d*f)*Z,m[9]=(w*T-a*r-F*f)*Z,m[10]=(o*l-b*O+J*V)*Z,m[11]=(y*O-v*l-t*V)*Z,m[12]=(s*p-W*c-D*f)*Z,m[13]=(a*c-w*p+e*f)*Z,m[14]=(b*n-o*C-U*V)*Z,m[15]=(v*C-y*n+S*V)*Z);},q.identity=function(){var q=this.elements;q[1]=q[2]=q[3]=q[4]=q[6]=q[7]=q[8]=q[9]=q[11]=q[12]=q[13]=q[14]=0,q[0]=q[5]=q[10]=q[15]=1;},q.cloneTo=function(q){var Q,m,a;if((m=this.elements)!==(a=q.elements))
for(Q=0;Q<16;++Q)a[Q]=m[Q];},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},q.getTranslationVector=function(q){var Q=this.elements;q.x=Q[12],q.y=Q[13],q.z=Q[14];},q.setTranslationVector=function(q){var Q=this.elements,m=q;Q[12]=m.x,Q[13]=m.y,Q[14]=m.z;},q.getForward=function(q){var Q=this.elements;q.x=-Q[8],q.y=-Q[9],q.z=-Q[10];},q.setForward=function(q){var Q=this.elements;Q[8]=-q.x,Q[9]=-q.y,Q[10]=-q.z;},l.createRotationX=function(q,Q){var m=Q.elements,a=Math.sin(q),w=Math.cos(q);m[1]=m[2]=m[3]=m[4]=m[7]=m[8]=m[11]=m[12]=m[13]=m[14]=0,m[0]=m[15]=1,m[5]=m[10]=w,m[6]=a,m[9]=-a;},l.createRotationY=function(q,Q){var m=Q.elements,a=Math.sin(q),w=Math.cos(q);m[1]=m[3]=m[4]=m[6]=m[7]=m[9]=m[11]=m[12]=m[13]=m[14]=0,m[5]=m[15]=1,m[0]=m[10]=w,m[2]=-a,m[8]=a;},l.createRotationZ=function(q,Q){var m=Q.elements,a=Math.sin(q),w=Math.cos(q);m[2]=m[3]=m[6]=m[7]=m[8]=m[9]=m[11]=m[12]=m[13]=m[14]=0,m[10]=m[15]=1,m[0]=m[5]=w,m[1]=a,m[4]=-a;},l.createRotationYawPitchRoll=function(q,Q,m,a){eq.createFromYawPitchRoll(q,Q,m,l._tempQuaternion),l.createRotationQuaternion(l._tempQuaternion,a);},l.createRotationAxis=function(q,Q,m){var a=q.x,w=q.y,e=q.z,F=Math.cos(Q),W=Math.sin(Q),s=a*a,D=w*w,d=e*e,v=a*w,y=a*e,S=w*e,t=m.elements;t[3]=t[7]=t[11]=t[12]=t[13]=t[14]=0,t[15]=1,t[0]=s+F*(1-s),t[1]=v-F*v+W*e,t[2]=y-F*y-W*w,t[4]=v-F*v-W*e,t[5]=D+F*(1-D),t[6]=S-F*S+W*a,t[8]=y-F*y+W*w,t[9]=S-F*S-W*a,t[10]=d+F*(1-d);},l.createRotationQuaternion=function(q,Q){var m=Q.elements,a=q.x,w=q.y,e=q.z,F=q.w,W=a*a,s=w*w,D=e*e,d=a*w,v=e*F,y=e*a,S=w*F,t=w*e,o=a*F;m[3]=m[7]=m[11]=m[12]=m[13]=m[14]=0,m[15]=1,m[0]=1-2*(s+D),m[1]=2*(d+v),m[2]=2*(y-S),m[4]=2*(d-v),m[5]=1-2*(D+W),m[6]=2*(t+o),m[8]=2*(y+S),m[9]=2*(t-o),m[10]=1-2*(s+W);},l.createTranslate=function(q,Q){var m=Q.elements;m[4]=m[8]=m[1]=m[9]=m[2]=m[6]=m[3]=m[7]=m[11]=0,m[0]=m[5]=m[10]=m[15]=1,m[12]=q.x,m[13]=q.y,m[14]=q.z;},l.createScaling=function(q,Q){var m=Q.elements;m[0]=q.x,m[5]=q.y,m[10]=q.z,m[1]=m[4]=m[8]=m[12]=m[9]=m[13]=m[2]=m[6]=m[14]=m[3]=m[7]=m[11]=0,m[15]=1;},l.multiply=function(q,Q,m){var a,w,e,F,W,s,D,d;if(w=m.elements,e=q.elements,w===(F=Q.elements))
for(F=new Float32Array(16),a=0;a<16;++a)F[a]=w[a];var v=F[0],y=F[1],S=F[2],t=F[3],o=F[4],b=F[5],U=F[6],J=F[7],V=F[8],n=F[9],O=F[10],C=F[11],l=F[12],u=F[13],f=F[14],p=F[15];for(a=0;a<4;a++)W=e[a],s=e[a+4],D=e[a+8],d=e[a+12],w[a]=W*v+s*y+D*S+d*t,w[a+4]=W*o+s*b+D*U+d*J,w[a+8]=W*V+s*n+D*O+d*C,w[a+12]=W*l+s*u+D*f+d*p;},l.multiplyForNative=function(q,Q,m){J.instance.matrix4x4Multiply(q.elements,Q.elements,m.elements);},l.createFromQuaternion=function(q,Q){var m=Q.elements,a=q.x,w=q.y,e=q.z,F=q.w,W=a+a,s=w+w,D=e+e,d=a*W,v=w*W,y=w*s,S=e*W,t=e*s,o=e*D,b=F*W,U=F*s,J=F*D;m[0]=1-y-o,m[1]=v+J,m[2]=S-U,m[3]=0,m[4]=v-J,m[5]=1-d-o,m[6]=t+b,m[7]=0,m[8]=S+U,m[9]=t-b,m[10]=1-d-y,m[11]=0,m[12]=0,m[13]=0,m[14]=0,m[15]=1;},l.createAffineTransformation=function(q,Q,m,a){var w=a.elements,e=Q.x,F=Q.y,W=Q.z,s=Q.w,D=e+e,d=F+F,v=W+W,y=e*D,S=e*d,t=e*v,o=F*d,b=F*v,U=W*v,J=s*D,V=s*d,n=s*v,O=m.x,C=m.y,l=m.z;w[0]=(1-(o+U))*O,w[1]=(S+n)*O,w[2]=(t-V)*O,w[3]=0,w[4]=(S-n)*C,w[5]=(1-(y+U))*C,w[6]=(b+J)*C,w[7]=0,w[8]=(t+V)*l,w[9]=(b-J)*l,w[10]=(1-(y+o))*l,w[11]=0,w[12]=q.x,w[13]=q.y,w[14]=q.z,w[15]=1;},l.createLookAt=function(q,Q,m,a){var w=a.elements,e=l._tempVector0,F=l._tempVector1,W=l._tempVector2;_q.subtract(q,Q,W),_q.normalize(W,W),_q.cross(m,W,e),_q.normalize(e,e),_q.cross(W,e,F),a.identity(),w[0]=e.x,w[4]=e.y,w[8]=e.z,w[1]=F.x,w[5]=F.y,w[9]=F.z,w[2]=W.x,w[6]=W.y,w[10]=W.z,w[12]=-_q.dot(e,q),w[13]=-_q.dot(F,q),w[14]=-_q.dot(W,q);},l.createPerspective=function(q,Q,m,a,w){var e=1/Math.tan(.5*q),F=m/(e/Q),W=m/e;l.createPerspectiveOffCenter(-F,F,-W,W,m,a,w);},l.createPerspectiveOffCenter=function(q,Q,m,a,w,e,F){var W=F.elements,s=e/(e-w);W[1]=W[2]=W[3]=W[4]=W[6]=W[7]=W[12]=W[13]=W[15]=0,W[0]=2*w/(Q-q),W[5]=2*w/(a-m),W[8]=(q+Q)/(Q-q),W[9]=(a+m)/(a-m),W[10]=-s,W[11]=-1,W[14]=-w*s;},l.createOrthoOffCenter=function(q,Q,m,a,w,e,F){var W=F.elements,s=1/(e-w);W[1]=W[2]=W[3]=W[4]=W[6]=W[8]=W[7]=W[9]=W[11]=0,W[15]=1,W[0]=2/(Q-q),W[5]=2/(a-m),W[10]=-s,W[12]=(q+Q)/(q-Q),W[13]=(a+m)/(m-a),W[14]=-w*s;},l.billboard=function(q,Q,m,a,w,e){_q.subtract(q,Q,l._tempVector0);var F=_q.scalarLengthSquared(l._tempVector0);qq.isZero(F)?(_q.scale(w,-1,l._tempVector1),l._tempVector1.cloneTo(l._tempVector0)):_q.scale(l._tempVector0,1/Math.sqrt(F),l._tempVector0),_q.cross(a,l._tempVector0,l._tempVector2),_q.normalize(l._tempVector2,l._tempVector2),_q.cross(l._tempVector0,l._tempVector2,l._tempVector3);var W=l._tempVector2,s=l._tempVector3,D=l._tempVector0,d=q,v=e.elements;v[0]=W.x,v[1]=W.y,v[2]=W.z,v[3]=0,v[4]=s.x,v[5]=s.y,v[6]=s.z,v[7]=0,v[8]=D.x,v[9]=D.y,v[10]=D.z,v[11]=0,v[12]=d.x,v[13]=d.y,v[14]=d.z,v[15]=1;},l.translation=function(q,Q){var m=Q.elements;m[0]=m[5]=m[10]=m[15]=1,m[12]=q.x,m[13]=q.y,m[14]=q.z;},y(l,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new l();},"_tempVector0",function(){return this._tempVector0=new _q();},"_tempVector1",function(){return this._tempVector1=new _q();},"_tempVector2",function(){return this._tempVector2=new _q();},"_tempVector3",function(){return this._tempVector3=new _q();},"_tempQuaternion",function(){return this._tempQuaternion=new eq();},"DEFAULT",function(){return this.DEFAULT=new l();},"ZERO",function(){return this.ZERO=new l(0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0);}]),l;}()),RQ=function(){function c(q,Q){this._nativeDiscreteDynamicsWorld=null,this._nativeCollisionWorld=null,this._nativeDispatcher=null,this._nativeCollisionConfiguration=null,this._nativeBroadphase=null,this._nativeSolverInfo=null,this._nativeDispatchInfo=null,this._nativeClosestRayResultCallback=null,this._nativeAllHitsRayResultCallback=null,this._nativeClosestConvexResultCallback=null,this._nativeAllConvexResultCallback=null,this._updatedRigidbodies=0,this.maxSubSteps=1,this.fixedTimeStep=1/60,this._gravity=new _q(0,-10,0),this._nativeVector3Zero=new R._physics3D.btVector3(0,0,0),this._nativeDefaultQuaternion=new R._physics3D.btQuaternion(0,0,0,-1),this._collisionsUtils=new $q(),this._previousFrameCollisions=[],this._currentFrameCollisions=[],this._physicsUpdateList=new dm(),this._characters=[],void 0===Q&&(Q=0),this.maxSubSteps=q.maxSubSteps,this.fixedTimeStep=q.fixedTimeStep;var m=R._physics3D;this._nativeCollisionConfiguration=new m.btDefaultCollisionConfiguration(),this._nativeDispatcher=new m.btCollisionDispatcher(this._nativeCollisionConfiguration),this._nativeBroadphase=new m.btDbvtBroadphase(),this._nativeBroadphase.getOverlappingPairCache().setInternalGhostPairCallback(new m.btGhostPairCallback());var a=q.flags;if(1&a)this._nativeCollisionWorld=new m.btCollisionWorld(this._nativeDispatcher,this._nativeBroadphase,this._nativeCollisionConfiguration);else{if(2&a)throw"PhysicsSimulation:SoftBody processing is not yet available";var w=new m.btSequentialImpulseConstraintSolver();this._nativeDiscreteDynamicsWorld=new m.btDiscreteDynamicsWorld(this._nativeDispatcher,this._nativeBroadphase,w,this._nativeCollisionConfiguration),this._nativeCollisionWorld=this._nativeDiscreteDynamicsWorld;}
this._nativeDiscreteDynamicsWorld&&(this._nativeSolverInfo=this._nativeDiscreteDynamicsWorld.getSolverInfo(),this._nativeDispatchInfo=this._nativeDiscreteDynamicsWorld.getDispatchInfo()),this._nativeClosestRayResultCallback=new m.ClosestRayResultCallback(this._nativeVector3Zero,this._nativeVector3Zero),this._nativeAllHitsRayResultCallback=new m.AllHitsRayResultCallback(this._nativeVector3Zero,this._nativeVector3Zero),this._nativeClosestConvexResultCallback=new m.ClosestConvexResultCallback(this._nativeVector3Zero,this._nativeVector3Zero),this._nativeAllConvexResultCallback=new m.AllConvexResultCallback(this._nativeVector3Zero,this._nativeVector3Zero),m._btGImpactCollisionAlgorithm_RegisterAlgorithm(this._nativeDispatcher.a);}
S(c,"laya.d3.physics.PhysicsSimulation");var q=c.prototype;return q._simulate=function(q){this._updatedRigidbodies=0,this._nativeDiscreteDynamicsWorld?this._nativeDiscreteDynamicsWorld.stepSimulation(q,this.maxSubSteps,this.fixedTimeStep):this._nativeCollisionWorld.PerformDiscreteCollisionDetection();},q._destroy=function(){var q=R._physics3D;this._nativeDiscreteDynamicsWorld?(q.destroy(this._nativeDiscreteDynamicsWorld),this._nativeDiscreteDynamicsWorld=null):(q.destroy(this._nativeCollisionWorld),this._nativeCollisionWorld=null),q.destroy(this._nativeBroadphase),this._nativeBroadphase=null,q.destroy(this._nativeDispatcher),this._nativeDispatcher=null,q.destroy(this._nativeCollisionConfiguration),this._nativeCollisionConfiguration=null;},q._addPhysicsCollider=function(q,Q,m){this._nativeCollisionWorld.addCollisionObject(q._nativeColliderObject,Q,m);},q._removePhysicsCollider=function(q){this._nativeCollisionWorld.removeCollisionObject(q._nativeColliderObject);},q._addRigidBody=function(q,Q,m){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeCollisionWorld.addRigidBody(q._nativeColliderObject,Q,m);},q._removeRigidBody=function(q){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeCollisionWorld.removeRigidBody(q._nativeColliderObject);},q._addCharacter=function(q,Q,m){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeCollisionWorld.addCollisionObject(q._nativeColliderObject,Q,m),this._nativeCollisionWorld.addAction(q._nativeKinematicCharacter);},q._removeCharacter=function(q){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeCollisionWorld.removeCollisionObject(q._nativeColliderObject),this._nativeCollisionWorld.removeAction(q._nativeKinematicCharacter);},q.raycastFromTo=function(q,Q,m,a,w){void 0===a&&(a=LQ.COLLISIONFILTERGROUP_ALLFILTER),void 0===w&&(w=LQ.COLLISIONFILTERGROUP_ALLFILTER);var e=this._nativeClosestRayResultCallback,F=c._nativeTempVector30,W=c._nativeTempVector31;if(F.setValue(-q.x,q.y,q.z),W.setValue(-Q.x,Q.y,Q.z),e.set_m_rayFromWorld(F),e.set_m_rayToWorld(W),e.set_m_collisionFilterGroup(a),e.set_m_collisionFilterMask(w),e.set_m_collisionObject(null),e.set_m_closestHitFraction(1),this._nativeCollisionWorld.rayTest(F,W,e),e.hasHit()){if(m){m.succeeded=!0,m.collider=zQ._physicObjectsMap[e.get_m_collisionObject().getUserIndex()],m.hitFraction=e.get_m_closestHitFraction();var s=e.get_m_hitPointWorld(),D=m.point;D.x=-s.x(),D.y=s.y(),D.z=s.z();var d=e.get_m_hitNormalWorld(),v=m.normal;v.x=-d.x(),v.y=d.y(),v.z=d.z();}
return!0;}
return m&&(m.succeeded=!1),!1;},q.raycastAllFromTo=function(q,Q,m,a,w){void 0===a&&(a=LQ.COLLISIONFILTERGROUP_ALLFILTER),void 0===w&&(w=LQ.COLLISIONFILTERGROUP_ALLFILTER);var e=this._nativeAllHitsRayResultCallback,F=c._nativeTempVector30,W=c._nativeTempVector31;m.length=0,F.setValue(-q.x,q.y,q.z),W.setValue(-Q.x,Q.y,Q.z),e.set_m_rayFromWorld(F),e.set_m_rayToWorld(W),e.set_m_collisionFilterGroup(a),e.set_m_collisionFilterMask(w);var s=e.get_m_collisionObjects(),D=e.get_m_hitPointWorld(),d=e.get_m_hitNormalWorld(),v=e.get_m_hitFractions();s.clear(),D.clear(),d.clear(),v.clear(),this._nativeCollisionWorld.rayTest(F,W,e);var y=s.size();if(0<y){this._collisionsUtils.recoverAllHitResultsPool();for(var S=0;S<y;S++){var t=this._collisionsUtils.getHitResult();m.push(t),t.succeeded=!0,t.collider=zQ._physicObjectsMap[s.at(S).getUserIndex()],t.hitFraction=v.at(S);var o=D.at(S),b=t.point;b.x=-o.x(),b.y=o.y(),b.z=o.z();var U=d.at(S),J=t.normal;J.x=-U.x(),J.y=U.y(),J.z=U.z();}
return!0;}
return!1;},q.rayCast=function(q,Q,m,a,w){void 0===m&&(m=2147483647),void 0===a&&(a=LQ.COLLISIONFILTERGROUP_ALLFILTER),void 0===w&&(w=LQ.COLLISIONFILTERGROUP_ALLFILTER);var e=q.origin,F=c._tempVector30;return _q.normalize(q.direction,F),_q.scale(F,m,F),_q.add(e,F,F),this.raycastFromTo(e,F,Q,a,w);},q.rayCastAll=function(q,Q,m,a,w){void 0===m&&(m=2147483647),void 0===a&&(a=LQ.COLLISIONFILTERGROUP_ALLFILTER),void 0===w&&(w=LQ.COLLISIONFILTERGROUP_ALLFILTER);var e=q.origin,F=c._tempVector30;return _q.normalize(q.direction,F),_q.scale(F,m,F),_q.add(e,F,F),this.raycastAllFromTo(e,F,Q,a,w);},q.shapeCast=function(q,Q,m,a,w,e,F,W,s){void 0===F&&(F=LQ.COLLISIONFILTERGROUP_ALLFILTER),void 0===W&&(W=LQ.COLLISIONFILTERGROUP_ALLFILTER),void 0===s&&(s=0);var D=this._nativeClosestConvexResultCallback,d=c._nativeTempVector30,v=c._nativeTempVector31,y=c._nativeTempQuaternion0,S=c._nativeTempQuaternion1,t=c._nativeTempTransform0,o=c._nativeTempTransform1,b=q._nativeShape;if(d.setValue(-Q.x,Q.y,Q.z),v.setValue(-m.x,m.y,m.z),D.set_m_collisionFilterGroup(F),D.set_m_collisionFilterMask(W),t.setOrigin(d),o.setOrigin(v),w?(y.setValue(-w.x,w.y,w.z,-w.w),t.setRotation(y)):t.setRotation(this._nativeDefaultQuaternion),e?(S.setValue(-e.x,e.y,e.z,-e.w),o.setRotation(S)):o.setRotation(this._nativeDefaultQuaternion),D.set_m_hitCollisionObject(null),D.set_m_closestHitFraction(1),this._nativeCollisionWorld.convexSweepTest(b,t,o,D,s),D.hasHit()){if(a){a.succeeded=!0,a.collider=zQ._physicObjectsMap[D.get_m_hitCollisionObject().getUserIndex()],a.hitFraction=D.get_m_closestHitFraction();var U=D.get_m_hitPointWorld(),J=D.get_m_hitNormalWorld(),V=a.point,n=a.normal;V.x=-U.x(),V.y=U.y(),V.z=U.z(),n.x=-J.x(),n.y=J.y(),n.z=J.z();}
return!0;}
return a&&(a.succeeded=!1),!1;},q.shapeCastAll=function(q,Q,m,a,w,e,F,W,s){void 0===F&&(F=LQ.COLLISIONFILTERGROUP_ALLFILTER),void 0===W&&(W=LQ.COLLISIONFILTERGROUP_ALLFILTER),void 0===s&&(s=0);var D=this._nativeAllConvexResultCallback,d=c._nativeTempVector30,v=c._nativeTempVector31,y=c._nativeTempQuaternion0,S=c._nativeTempQuaternion1,t=c._nativeTempTransform0,o=c._nativeTempTransform1,b=q._nativeShape;a.length=0,d.setValue(-Q.x,Q.y,Q.z),v.setValue(-m.x,m.y,m.z),D.set_m_collisionFilterGroup(F),D.set_m_collisionFilterMask(W),t.setOrigin(d),o.setOrigin(v),w?(y.setValue(-w.x,w.y,w.z,-w.w),t.setRotation(y)):t.setRotation(this._nativeDefaultQuaternion),e?(S.setValue(-e.x,e.y,e.z,-e.w),o.setRotation(S)):o.setRotation(this._nativeDefaultQuaternion);var U=D.get_m_collisionObjects();U.clear(),this._nativeCollisionWorld.convexSweepTest(b,t,o,D,s);var J=U.size();if(0<J){for(var V=D.get_m_hitPointWorld(),n=D.get_m_hitNormalWorld(),O=D.get_m_hitFractions(),C=0;C<J;C++){var l=this._collisionsUtils.getHitResult();a.push(l),l.succeeded=!0,l.collider=zQ._physicObjectsMap[U.at(C).getUserIndex()],l.hitFraction=O.at(C);var u=V.at(C),f=l.point;f.x=-u.x(),f.y=u.y(),f.z=u.z();var p=n.at(C),T=l.normal;T.x=-p.x(),T.y=p.y(),T.z=p.z();}
return!0;}
return!1;},q.addConstraint=function(q,Q){if(void 0===Q&&(Q=!1),!this._nativeDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeDiscreteDynamicsWorld.addConstraint(q._nativeConstraint,Q),q._simulation=this;},q.removeConstraint=function(q){if(!this._nativeDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeDiscreteDynamicsWorld.removeConstraint(q._nativeConstraint);},q._updatePhysicsTransformFromRender=function(){for(var q=this._physicsUpdateList.elements,Q=0,m=this._physicsUpdateList.length;Q<m;Q++){var a=q[Q];a._derivePhysicsTransformation(!1),a._inPhysicUpdateListIndex=-1;}
this._physicsUpdateList.length=0;},q._updateCharacters=function(){for(var q=0,Q=this._characters.length;q<Q;q++){var m=this._characters[q];m._updateTransformComponent(m._nativeColliderObject.getWorldTransform());}},q._updateCollisions=function(){this._collisionsUtils.recoverAllContactPointsPool();var q=this._currentFrameCollisions;this._currentFrameCollisions=this._previousFrameCollisions,this._currentFrameCollisions.length=0,this._previousFrameCollisions=q;for(var Q=r.loopCount,m=this._nativeDispatcher.getNumManifolds(),a=0;a<m;a++){var w=this._nativeDispatcher.getManifoldByIndexInternal(a),e=zQ._physicObjectsMap[w.getBody0().getUserIndex()],F=zQ._physicObjectsMap[w.getBody1().getUserIndex()],W=null,s=!1,D=null;if((e.isTrigger||F.isTrigger)&&(e.owner._needProcessTriggers||F.owner._needProcessTriggers))
for(var d=w.getNumContacts(),v=0;v<d;v++){var y=w.getContactPoint(v),S=y.getDistance();if(S<=0){D=(W=this._collisionsUtils.getCollision(e,F)).contacts,(s=W._updateFrame!==Q)&&(W._isTrigger=!0,D.length=0);break;}}else if((e.owner._needProcessCollisions||F.owner._needProcessCollisions)&&(e._enableProcessCollisions||F._enableProcessCollisions))
for(d=w.getNumContacts(),v=0;v<d;v++)
if((S=(y=w.getContactPoint(v)).getDistance())<=0){var t=this._collisionsUtils.getContactPoints();t.colliderA=e,t.colliderB=F,t.distance=S;var o=y.get_m_normalWorldOnB(),b=t.normal;b.x=-o.x(),b.y=o.y(),b.z=o.z();var U=y.get_m_positionWorldOnA(),J=t.positionOnA;J.x=-U.x(),J.y=U.y(),J.z=U.z();var V=y.get_m_positionWorldOnB(),n=t.positionOnB;n.x=-V.x(),n.y=V.y(),n.z=V.z(),W||(D=(W=this._collisionsUtils.getCollision(e,F)).contacts,(s=W._updateFrame!==Q)&&(W._isTrigger=!1,D.length=0)),D.push(t);}
W&&s&&(this._currentFrameCollisions.push(W),W._setUpdateFrame(Q));}},q._eventScripts=function(){for(var q=r.loopCount,Q=0,m=this._currentFrameCollisions.length;Q<m;Q++){var a=this._currentFrameCollisions[Q],w=a._colliderA,e=a._colliderB;if(!w.destroyed&&!e.destroyed)
if(q-a._lastUpdateFrame==1){var F=w.owner,W=F._scripts;if(W)
if(a._isTrigger){if(F._needProcessTriggers)
for(var s=0,D=W.length;s<D;s++)W[s].onTriggerStay(e);}else if(F._needProcessCollisions)
for(s=0,D=W.length;s<D;s++)a.other=e,W[s].onCollisionStay(a);var d=e.owner,v=d._scripts;if(v)
if(a._isTrigger){if(d._needProcessTriggers)
for(s=0,D=v.length;s<D;s++)v[s].onTriggerStay(w);}else if(d._needProcessCollisions)
for(s=0,D=v.length;s<D;s++)a.other=w,v[s].onCollisionStay(a);}else{if(W=(F=w.owner)._scripts)
if(a._isTrigger){if(F._needProcessTriggers)
for(s=0,D=W.length;s<D;s++)W[s].onTriggerEnter(e);}else if(F._needProcessCollisions)
for(s=0,D=W.length;s<D;s++)a.other=e,W[s].onCollisionEnter(a);if(v=(d=e.owner)._scripts)
if(a._isTrigger){if(d._needProcessTriggers)
for(s=0,D=v.length;s<D;s++)v[s].onTriggerEnter(w);}else if(d._needProcessCollisions)
for(s=0,D=v.length;s<D;s++)a.other=w,v[s].onCollisionEnter(a);}}
for(Q=0,m=this._previousFrameCollisions.length;Q<m;Q++){var y=this._previousFrameCollisions[Q],S=y._colliderA,t=y._colliderB;if(!S.destroyed&&!t.destroyed&&q-y._updateFrame==1){if(this._collisionsUtils.recoverCollision(y),W=(F=S.owner)._scripts)
if(y._isTrigger){if(F._needProcessTriggers)
for(s=0,D=W.length;s<D;s++)W[s].onTriggerExit(t);}else if(F._needProcessCollisions)
for(s=0,D=W.length;s<D;s++)y.other=t,W[s].onCollisionExit(y);if(v=(d=t.owner)._scripts)
if(y._isTrigger){if(d._needProcessTriggers)
for(s=0,D=v.length;s<D;s++)v[s].onTriggerExit(S);}else if(d._needProcessCollisions)
for(s=0,D=v.length;s<D;s++)y.other=S,v[s].onCollisionExit(y);}}},q.clearForces=function(){if(!this._nativeDiscreteDynamicsWorld)throw"Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeDiscreteDynamicsWorld.clearForces();},d(0,q,"gravity",function(){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";return this._gravity;},function(q){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot perform this action when the physics engine is set to CollisionsOnly";this._gravity=q;var Q=c._nativeTempVector30;Q.setValue(-q.x,q.y,q.z),this._nativeDiscreteDynamicsWorld.setGravity(Q);}),d(0,q,"continuousCollisionDetection",function(){return this._nativeDispatchInfo.get_m_useContinuous();},function(q){this._nativeDispatchInfo.set_m_useContinuous(q);}),d(0,q,"speculativeContactRestitution",function(){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";return this._nativeDiscreteDynamicsWorld.getApplySpeculativeContactRestitution();},function(q){if(!this._nativeDiscreteDynamicsWorld)throw"Simulation:Cannot Cannot perform this action when the physics engine is set to CollisionsOnly";this._nativeDiscreteDynamicsWorld.setApplySpeculativeContactRestitution(q);}),c.createConstraint=function(){},c.PHYSICSENGINEFLAGS_NONE=0,c.PHYSICSENGINEFLAGS_COLLISIONSONLY=1,c.PHYSICSENGINEFLAGS_SOFTBODYSUPPORT=2,c.PHYSICSENGINEFLAGS_MULTITHREADED=4,c.PHYSICSENGINEFLAGS_USEHARDWAREWHENPOSSIBLE=8,c.SOLVERMODE_RANDMIZE_ORDER=1,c.SOLVERMODE_FRICTION_SEPARATE=2,c.SOLVERMODE_USE_WARMSTARTING=4,c.SOLVERMODE_USE_2_FRICTION_DIRECTIONS=16,c.SOLVERMODE_ENABLE_FRICTION_DIRECTION_CACHING=32,c.SOLVERMODE_DISABLE_VELOCITY_DEPENDENT_FRICTION_DIRECTION=64,c.SOLVERMODE_CACHE_FRIENDLY=128,c.SOLVERMODE_SIMD=256,c.SOLVERMODE_INTERLEAVE_CONTACT_AND_FRICTION_CONSTRAINTS=512,c.SOLVERMODE_ALLOW_ZERO_LENGTH_FRICTION_DIRECTIONS=1024,c.disableSimulation=!1,y(c,["_nativeTempVector30",function(){return this._nativeTempVector30=new R._physics3D.btVector3(0,0,0);},"_nativeTempVector31",function(){return this._nativeTempVector31=new R._physics3D.btVector3(0,0,0);},"_nativeTempQuaternion0",function(){return this._nativeTempQuaternion0=new R._physics3D.btQuaternion(0,0,0,1);},"_nativeTempQuaternion1",function(){return this._nativeTempQuaternion1=new R._physics3D.btQuaternion(0,0,0,1);},"_nativeTempTransform0",function(){return this._nativeTempTransform0=new R._physics3D.btTransform();},"_nativeTempTransform1",function(){return this._nativeTempTransform1=new R._physics3D.btTransform();},"_tempVector30",function(){return this._tempVector30=new _q();}]),c;}(),zQ=function(Q){function t(q,Q){this._restitution=0,this._friction=.5,this._rollingFriction=0,this._ccdMotionThreshold=0,this._ccdSweptSphereRadius=0,this._colliderShape=null,this._transformFlag=2147483647,this._enableProcessCollisions=!0,this._inPhysicUpdateListIndex=-1,this.canScaleShape=!0,t.__super.call(this),this._collisionGroup=1,this._canCollideWith=LQ.COLLISIONFILTERGROUP_ALLFILTER,this._collisionGroup=q,this._canCollideWith=Q,t._physicObjectsMap[this.id]=this;}
S(t,"laya.d3.physics.PhysicsComponent",Q);var q=t.prototype;return q._isValid=function(){return this._simulation&&this._colliderShape&&this._enabled;},q._parse=function(q){null!=q.collisionGroup&&(this.collisionGroup=q.collisionGroup),null!=q.canCollideWith&&(this.canCollideWith=q.canCollideWith),null!=q.ccdMotionThreshold&&(this.ccdMotionThreshold=q.ccdMotionThreshold),null!=q.ccdSweptSphereRadius&&(this.ccdSweptSphereRadius=q.ccdSweptSphereRadius);},q._parseShape=function(q){var Q=q.length;if(1===Q){var m=k._creatShape(q[0]);this.colliderShape=m;}else{for(var a=new Sm(),w=0;w<Q;w++)m=k._creatShape(q[w]),a.addChildShape(m);this.colliderShape=a;}},q._onScaleChange=function(q){this._colliderShape._setScale(q);},q._setTransformFlag=function(q,Q){Q?this._transformFlag|=q:this._transformFlag&=~q;},q._getTransformFlag=function(q){return 0!=(this._transformFlag&q);},q._addToSimulation=function(){},q._removeFromSimulation=function(){},q._derivePhysicsTransformation=function(q){this._innerDerivePhysicsTransformation(this._nativeColliderObject.getWorldTransform(),q);},q._innerDerivePhysicsTransformation=function(q,Q){var m=this.owner._transform,a=m.rotation;if(Q||this._getTransformFlag(8)){var w=this._colliderShape.localOffset,e=m.position,F=t._nativeVector30;if(0!==w.x||0!==w.y||0!==w.z){var W=t._tempVector30;t.physicVector3TransformQuat(w,a.x,a.y,a.z,a.w,W),_q.add(e,W,W),F.setValue(-W.x,W.y,W.z);}else F.setValue(-e.x,e.y,e.z);q.setOrigin(F),this._setTransformFlag(8,!1);}
if(Q||this._getTransformFlag(16)){var s=this._colliderShape.localRotation,D=t._nativeQuaternion0;if(0!==s.x||0!==s.y||0!==s.z||1!==s.w){var d=t._tempQuaternion0;t.physicQuaternionMultiply(a.x,a.y,a.z,a.w,s,d),D.setValue(-d.x,d.y,d.z,-d.w);}else D.setValue(-a.x,a.y,a.z,-a.w);q.setRotation(D),this._setTransformFlag(16,!1);}
(Q||this._getTransformFlag(32))&&(this._onScaleChange(m.scale),this._setTransformFlag(32,!1));},q._updateTransformComponent=function(q){var Q=this._colliderShape.localOffset,m=this._colliderShape.localRotation,a=this.owner._transform,w=a.position,e=a.rotation,F=q.getOrigin(),W=q.getRotation(),s=-W.x(),D=W.y(),d=W.z(),v=-W.w();if(0!==Q.x||0!==Q.y||0!==Q.z){var y=t._tempVector30;t.physicVector3TransformQuat(Q,s,D,d,v,y),w.x=-F.x()-y.x,w.y=F.y()-y.y,w.z=F.z()-y.z;}else w.x=-F.x(),w.y=F.y(),w.z=F.z();if(a.position=w,0!==m.x||0!==m.y||0!==m.z||1!==m.w){var S=t._tempQuaternion0;m.invert(S),t.physicQuaternionMultiply(s,D,d,v,S,e);}else e.x=s,e.y=D,e.z=d,e.w=v;a.rotation=e;},q._onEnable=function(){this._simulation=this.owner._scene.physicsSimulation,this._nativeColliderObject.setContactProcessingThreshold(1e30),this._colliderShape&&this._enabled&&(this._derivePhysicsTransformation(!0),this._addToSimulation());},q._onDisable=function(){this._colliderShape&&this._enabled&&(this._removeFromSimulation(),-1!==this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.remove(this)),this._simulation=null;},q._onShapeChange=function(q){var Q=this._nativeColliderObject,m=Q.getCollisionFlags();q.needsCustomCollisionCallback?0==(8&m)&&Q.setCollisionFlags(8|m):0<(8&m)&&Q.setCollisionFlags(8^m);},q._onAdded=function(){this.enabled=this._enabled,this.restitution=this._restitution,this.friction=this._friction,this.rollingFriction=this._rollingFriction,this.ccdMotionThreshold=this._ccdMotionThreshold,this.ccdSweptSphereRadius=this._ccdSweptSphereRadius,this.owner.transform.on("transformchanged",this,this._onTransformChanged);},q._onDestroy=function(){var q=R._physics3D;delete t._physicObjectsMap[this.id],q.destroy(this._nativeColliderObject),this._colliderShape.destroy(),Q.prototype._onDestroy.call(this),this._nativeColliderObject=null,this._colliderShape=null,this._simulation=null,this.owner.transform.off("transformchanged",this,this._onTransformChanged);},q._onTransformChanged=function(q){t._addUpdateList&&(q&=56)&&(this._transformFlag|=q,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this));},q._cloneTo=function(q){var Q=q;Q.restitution=this._restitution,Q.friction=this._friction,Q.rollingFriction=this._rollingFriction,Q.ccdMotionThreshold=this._ccdMotionThreshold,Q.ccdSweptSphereRadius=this._ccdSweptSphereRadius,Q.collisionGroup=this._collisionGroup,Q.canCollideWith=this._canCollideWith,Q.canScaleShape=this.canScaleShape,this._colliderShape&&(Q.colliderShape=this._colliderShape.clone());},d(0,q,"isActive",function(){return!!this._nativeColliderObject&&this._nativeColliderObject.isActive();}),d(0,q,"restitution",function(){return this._restitution;},function(q){this._restitution=q,this._nativeColliderObject&&this._nativeColliderObject.setRestitution(q);}),d(0,q,"friction",function(){return this._friction;},function(q){this._friction=q,this._nativeColliderObject&&this._nativeColliderObject.setFriction(q);}),d(0,q,"rollingFriction",function(){return this._nativeColliderObject.getRollingFriction();},function(q){this._rollingFriction=q,this._nativeColliderObject&&this._nativeColliderObject.setRollingFriction(q);}),d(0,q,"ccdMotionThreshold",function(){return this._ccdMotionThreshold;},function(q){this._ccdMotionThreshold=q,this._nativeColliderObject&&this._nativeColliderObject.setCcdMotionThreshold(q);}),d(0,q,"ccdSweptSphereRadius",function(){return this._ccdSweptSphereRadius;},function(q){this._ccdSweptSphereRadius=q,this._nativeColliderObject&&this._nativeColliderObject.setCcdSweptSphereRadius(q);}),d(0,q,"collisionGroup",function(){return this._collisionGroup;},function(q){this._collisionGroup!==q&&(this._collisionGroup=q,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()));}),d(0,q,"simulation",function(){return this._simulation;}),d(0,q,"colliderShape",function(){return this._colliderShape;},function(q){var Q=this._colliderShape;if(Q&&(Q._attatched=!1,Q._attatchedCollisionObject=null),this._colliderShape=q){if(q._attatched)throw"PhysicsComponent: this shape has attatched to other entity.";if(q._attatched=!0,(q._attatchedCollisionObject=this)._nativeColliderObject){this._nativeColliderObject.setCollisionShape(q._nativeShape);var m=this._simulation&&this._enabled;m&&Q&&this._removeFromSimulation(),this._onShapeChange(q),m&&(this._derivePhysicsTransformation(!0),this._addToSimulation());}}else this._simulation&&this._enabled&&Q&&this._removeFromSimulation();}),d(0,q,"enabled",Q.prototype._$get_enabled,function(q){this._simulation&&this._colliderShape&&(q?(this._derivePhysicsTransformation(!0),this._addToSimulation()):this._removeFromSimulation()),o.superSet(w,this,"enabled",q);}),d(0,q,"canCollideWith",function(){return this._canCollideWith;},function(q){this._canCollideWith!==q&&(this._canCollideWith=q,this._simulation&&this._colliderShape&&this._enabled&&(this._removeFromSimulation(),this._addToSimulation()));}),t._createAffineTransformationArray=function(q,Q,m,a,w,e,F,W,s){var D=a+a,d=w+w,v=e+e,y=a*D,S=a*d,t=a*v,o=w*d,b=w*v,U=e*v,J=F*D,V=F*d,n=F*v,O=W[0],C=W[1],l=W[2];s[0]=(1-(o+U))*O,s[1]=(S+n)*O,s[2]=(t-V)*O,s[3]=0,s[4]=(S-n)*C,s[5]=(1-(y+U))*C,s[6]=(b+J)*C,s[7]=0,s[8]=(t+V)*l,s[9]=(b-J)*l,s[10]=(1-(y+o))*l,s[11]=0,s[12]=q,s[13]=Q,s[14]=m,s[15]=1;},t.physicVector3TransformQuat=function(q,Q,m,a,w,e){var F=q.x,W=q.y,s=q.z,D=w*F+m*s-a*W,d=w*W+a*F-Q*s,v=w*s+Q*W-m*F,y=-Q*F-m*W-a*s;e.x=D*w+y* -Q+d* -a-v* -m,e.y=d*w+y* -m+v* -Q-D* -a,e.z=v*w+y* -a+D* -m-d* -Q;},t.physicQuaternionMultiply=function(q,Q,m,a,w,e){var F=w.x,W=w.y,s=w.z,D=w.w,d=Q*s-m*W,v=m*F-q*s,y=q*W-Q*F,S=q*F+Q*W+m*s;e.x=q*D+F*a+d,e.y=Q*D+W*a+v,e.z=m*D+s*a+y,e.w=a*D-S;},t.ACTIVATIONSTATE_ACTIVE_TAG=1,t.ACTIVATIONSTATE_ISLAND_SLEEPING=2,t.ACTIVATIONSTATE_WANTS_DEACTIVATION=3,t.ACTIVATIONSTATE_DISABLE_DEACTIVATION=4,t.ACTIVATIONSTATE_DISABLE_SIMULATION=5,t.COLLISIONFLAGS_STATIC_OBJECT=1,t.COLLISIONFLAGS_KINEMATIC_OBJECT=2,t.COLLISIONFLAGS_NO_CONTACT_RESPONSE=4,t.COLLISIONFLAGS_CUSTOM_MATERIAL_CALLBACK=8,t.COLLISIONFLAGS_CHARACTER_OBJECT=16,t.COLLISIONFLAGS_DISABLE_VISUALIZE_OBJECT=32,t.COLLISIONFLAGS_DISABLE_SPU_COLLISION_PROCESSING=64,t._physicObjectsMap={},t._addUpdateList=!0,y(t,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempQuaternion0",function(){return this._tempQuaternion0=new eq();},"_tempQuaternion1",function(){return this._tempQuaternion1=new eq();},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new kQ();},"_nativeVector30",function(){return this._nativeVector30=new R._physics3D.btVector3(0,0,0);},"_nativeQuaternion0",function(){return this._nativeQuaternion0=new R._physics3D.btQuaternion(0,0,0,1);}]),t;}(w),iQ=function(q){function e(q){if(this._indexInList=-1,this._indexInCastShadowList=-1,this._boundsChange=!0,this._visible=!0,this._indexInOctreeMotionList=-1,this._updateMark=-1,this._updateRenderType=-1,this._isPartOfStaticBatch=!1,this._staticBatch=null,e.__super.call(this),this._sharedMaterials=[],this._id=++e._uniqueIDCounter,this._indexInCastShadowList=-1,this._bounds=new lQ(_q._ZERO,_q._ZERO),M.supportWebGLPlusCulling){var Q=NQ._cullingBufferLength;this._cullingBufferIndex=Q;var m=NQ._cullingBuffer,a=Q+7;if(a>=m.length){var w=m;(m=NQ._cullingBuffer=new Float32Array(m.length+4096)).set(w,0);}
m[Q]=2,NQ._cullingBufferLength=a;}
this._renderElements=[],this._owner=q,this._enable=!0,this._materialsInstance=[],this._shaderValues=new Fq(null),this._defineDatas=new Lq(),this.lightmapIndex=-1,this._castShadow=!1,this.receiveShadow=!1,this.sortingFudge=0,q&&this._owner.transform.on("transformchanged",this,this._onWorldMatNeedChange);}
S(e,"laya.d3.core.render.BaseRender",t);var Q=e.prototype;return o.imps(Q,{"laya.resource.ISingletonElement":!0,"laya.d3.core.scene.IOctreeObject":!0}),Q._getOctreeNode=function(){return this._octreeNode;},Q._setOctreeNode=function(q){this._octreeNode=q;},Q._getIndexInMotionList=function(){return this._indexInOctreeMotionList;},Q._setIndexInMotionList=function(q){this._indexInOctreeMotionList=q;},Q._changeMaterialReference=function(q,Q){q&&q._removeReference(),Q._addReference();},Q._getInstanceMaterial=function(q,Q){var m=new q.constructor();return q.cloneTo(m),m.name=m.name+"(Instance)",this._materialsInstance[Q]=!0,this._changeMaterialReference(this._sharedMaterials[Q],m),this._sharedMaterials[Q]=m;},Q._applyLightMapParams=function(){if(this._scene&&0<=this._lightmapIndex){var q=this._scene.getlightmaps();this._lightmapIndex<q.length?(this._defineDatas.add(Im.SAHDERDEFINE_LIGHTMAP),this._shaderValues.setTexture(Im.LIGHTMAP,q[this._lightmapIndex])):this._defineDatas.remove(Im.SAHDERDEFINE_LIGHTMAP);}else this._defineDatas.remove(Im.SAHDERDEFINE_LIGHTMAP);},Q._onWorldMatNeedChange=function(q){this._boundsChange=!0,this._octreeNode&&(q&=56)&&-1===this._indexInOctreeMotionList&&this._octreeNode._octree.addMotionObject(this);},Q._calculateBoundingBox=function(){throw"BaseRender: must override it.";},Q._getIndexInList=function(){return this._indexInList;},Q._setIndexInList=function(q){this._indexInList=q;},Q._setBelongScene=function(q){this._scene!==q&&(this._scene=q,this._applyLightMapParams());},Q._needRender=function(q){return!0;},Q._renderUpdate=function(q,Q){},Q._renderUpdateWithCamera=function(q,Q){},Q._revertBatchRenderUpdate=function(q){},Q._destroy=function(){-1!==this._indexInOctreeMotionList&&this._octreeNode._octree.removeMotionObject(this),this.offAll();var q=0,Q=0;for(q=0,Q=this._renderElements.length;q<Q;q++)this._renderElements[q].destroy();for(q=0,Q=this._sharedMaterials.length;q<Q;q++)this._sharedMaterials[q].destroyed||this._sharedMaterials[q]._removeReference();this._renderElements=null,this._owner=null,this._sharedMaterials=null,this._bounds=null,this._lightmapScaleOffset=null;},d(0,Q,"bounds",function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds;}),d(0,Q,"id",function(){return this._id;}),d(0,Q,"material",function(){var q=this._sharedMaterials[0];if(q&&!this._materialsInstance[0]){var Q=this._getInstanceMaterial(q,0),m=this._renderElements[0];m&&(m.material=Q);}
return this._sharedMaterials[0];},function(q){this.sharedMaterial=q;}),d(0,Q,"isPartOfStaticBatch",function(){return this._isPartOfStaticBatch;}),d(0,Q,"sharedMaterial",function(){return this._sharedMaterials[0];},function(q){var Q=this._sharedMaterials[0];if(Q!==q){this._sharedMaterials[0]=q,this._materialsInstance[0]=!1,this._changeMaterialReference(Q,q);var m=this._renderElements[0];m&&(m.material=q);}}),d(0,Q,"lightmapIndex",function(){return this._lightmapIndex;},function(q){this._lightmapIndex!==q&&(this._lightmapIndex=q,this._applyLightMapParams());}),d(0,Q,"lightmapScaleOffset",function(){return this._lightmapScaleOffset;},function(q){this._lightmapScaleOffset=q,this._shaderValues.setVector(Im.LIGHTMAPSCALEOFFSET,q),this._defineDatas.add(Im.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV);}),d(0,Q,"castShadow",function(){return this._castShadow;},function(q){this._castShadow!==q&&(this._owner.activeInHierarchy&&(q?this._scene._addShadowCastRenderObject(this):this._scene._removeShadowCastRenderObject(this)),this._castShadow=q);}),d(0,Q,"enable",function(){return this._enable;},function(q){this._enable=!!q;}),d(0,Q,"materials",function(){for(var q=0,Q=this._sharedMaterials.length;q<Q;q++)
if(!this._materialsInstance[q]){var m=this._getInstanceMaterial(this._sharedMaterials[q],q),a=this._renderElements[q];a&&(a.material=m);}
return this._sharedMaterials.slice();},function(q){this.sharedMaterials=q;}),d(0,Q,"sharedMaterials",function(){return this._sharedMaterials.slice();},function(q){for(var Q=this._sharedMaterials,m=0,a=Q.length;m<a;m++)Q[m]._removeReference();if(!q)throw new Error("BaseRender: shadredMaterials value can't be null.");var w=q.length;for(this._materialsInstance.length=w,Q.length=w,m=0;m<w;m++){var e=Q[m],F=q[m];if(e!==F){this._materialsInstance[m]=!1;var W=this._renderElements[m];W&&(W.material=F);}
F._addReference(),Q[m]=F;}}),d(0,Q,"receiveShadow",function(){return this._receiveShadow;},function(q){this._receiveShadow!==q&&((this._receiveShadow=q)?this._defineDatas.add(Im.SHADERDEFINE_RECEIVE_SHADOW):this._defineDatas.remove(Im.SHADERDEFINE_RECEIVE_SHADOW));}),e._uniqueIDCounter=0,y(e,["_tempBoundBoxCorners",function(){return this._tempBoundBoxCorners=[new _q(),new _q(),new _q(),new _q(),new _q(),new _q(),new _q(),new _q()];}]),e;}(),$Q=(function(q){function Q(){Q.__super.call(this);}
S(Q,"laya.d3.component.Script3D",w);var m=Q.prototype;m._checkProcessTriggers=function(){var q=laya.d3.component.Script3D.prototype;return this.onTriggerEnter!==q.onTriggerEnter||(this.onTriggerStay!==q.onTriggerStay||this.onTriggerExit!==q.onTriggerExit);},m._checkProcessCollisions=function(){var q=laya.d3.component.Script3D.prototype;return this.onCollisionEnter!==q.onCollisionEnter||(this.onCollisionStay!==q.onCollisionStay||this.onCollisionExit!==q.onCollisionExit);},m._onAwake=function(){this.onAwake(),this.onStart!==laya.d3.component.Script3D.prototype.onStart&&o.startTimer.callLater(this,this.onStart);},m._onEnable=function(){this.owner._scene._scriptPool.add(this);var q=laya.d3.component.Script3D.prototype;this.onKeyDown!==q.onKeyDown&&o.stage.on("keydown",this,this.onKeyDown),this.onKeyPress!==q.onKeyPress&&o.stage.on("keypress",this,this.onKeyUp),this.onKeyUp!==q.onKeyUp&&o.stage.on("keyup",this,this.onKeyUp);},m._onDisable=function(){this.owner._scene._scriptPool.remove(this),this.owner.offAllCaller(this),o.stage.offAllCaller(this);},m._isScript=function(){return!0;},m._onAdded=function(){var q=this.owner,Q=q._scripts;Q||(q._scripts=Q=[]),Q.push(this),q._needProcessCollisions||(q._needProcessCollisions=this._checkProcessCollisions()),q._needProcessTriggers||(q._needProcessTriggers=this._checkProcessTriggers());},m._onDestroy=function(){var q=this.owner._scripts;q.splice(q.indexOf(this),1);var Q=this.owner;Q._needProcessTriggers=!1;for(var m=0,a=q.length;m<a;m++)
if(q[m]._checkProcessTriggers()){Q._needProcessTriggers=!0;break;}
for(Q._needProcessCollisions=!1,m=0,a=q.length;m<a;m++)
if(q[m]._checkProcessCollisions()){Q._needProcessCollisions=!0;break;}
this.onDestroy();},m.onAwake=function(){},m.onEnable=function(){},m.onStart=function(){},m.onTriggerEnter=function(q){},m.onTriggerStay=function(q){},m.onTriggerExit=function(q){},m.onCollisionEnter=function(q){},m.onCollisionStay=function(q){},m.onCollisionExit=function(q){},m.onMouseDown=function(){},m.onMouseDrag=function(){},m.onMouseClick=function(){},m.onMouseUp=function(){},m.onMouseEnter=function(){},m.onMouseOver=function(){},m.onMouseOut=function(){},m.onKeyDown=function(q){},m.onKeyPress=function(q){},m.onKeyUp=function(q){},m.onUpdate=function(){},m.onLateUpdate=function(){},m.onPreRender=function(){},m.onPostRender=function(){},m.onDisable=function(){},m.onDestroy=function(){},d(0,m,"isSingleton",function(){return!1;});}(),function(q){function F(q){this._owner=null,this._children=null,this._parent=null,this._dummy=null,this._transformFlag=0,F.__super.call(this),this._localPosition=new _q(0,0,0),this._localRotation=new eq(0,0,0,1),this._localScale=new _q(1,1,1),this._localRotationEuler=new _q(0,0,0),this._localMatrix=new kQ(),this._position=new _q(0,0,0),this._rotation=new eq(0,0,0,1),this._scale=new _q(1,1,1),this._rotationEuler=new _q(0,0,0),this._worldMatrix=new kQ(),this._owner=q,this._children=[],this._setTransformFlag(7,!1),this._setTransformFlag(248,!0);}
S(F,"laya.d3.core.Transform3D",t);var Q=F.prototype;return Q._setTransformFlag=function(q,Q){Q?this._transformFlag|=q:this._transformFlag&=~q;},Q._getTransformFlag=function(q){return 0!=(this._transformFlag&q);},Q._setParent=function(q){if(this._parent!==q){if(this._parent){var Q=this._parent._children,m=Q.indexOf(this);Q.splice(m,1);}
q&&(q._children.push(this),q&&this._onWorldTransform()),this._parent=q;}},Q._updateLocalMatrix=function(){kQ.createAffineTransformation(this._localPosition,this.localRotation,this._localScale,this._localMatrix);},Q._onWorldPositionRotationTransform=function(){if(!(this._getTransformFlag(64)&&this._getTransformFlag(8)&&this._getTransformFlag(16)&&this._getTransformFlag(128))){this._setTransformFlag(216,!0),this.event("transformchanged",this._transformFlag);for(var q=0,Q=this._children.length;q<Q;q++)this._children[q]._onWorldPositionRotationTransform();}},Q._onWorldPositionScaleTransform=function(){if(!this._getTransformFlag(64)||!this._getTransformFlag(8)||!this._getTransformFlag(32)){this._setTransformFlag(104,!0),this.event("transformchanged",this._transformFlag);for(var q=0,Q=this._children.length;q<Q;q++)this._children[q]._onWorldPositionScaleTransform();}},Q._onWorldPositionTransform=function(){if(!this._getTransformFlag(64)||!this._getTransformFlag(8)){this._setTransformFlag(72,!0),this.event("transformchanged",this._transformFlag);for(var q=0,Q=this._children.length;q<Q;q++)this._children[q]._onWorldPositionTransform();}},Q._onWorldRotationTransform=function(){if(!this._getTransformFlag(64)||!this._getTransformFlag(16)||!this._getTransformFlag(128)){this._setTransformFlag(208,!0),this.event("transformchanged",this._transformFlag);for(var q=0,Q=this._children.length;q<Q;q++)this._children[q]._onWorldPositionRotationTransform();}},Q._onWorldScaleTransform=function(){if(!this._getTransformFlag(64)||!this._getTransformFlag(32)){this._setTransformFlag(96,!0),this.event("transformchanged",this._transformFlag);for(var q=0,Q=this._children.length;q<Q;q++)this._children[q]._onWorldPositionScaleTransform();}},Q._onWorldTransform=function(){if(!(this._getTransformFlag(64)&&this._getTransformFlag(8)&&this._getTransformFlag(16)&&this._getTransformFlag(128)&&this._getTransformFlag(32))){this._setTransformFlag(248,!0),this.event("transformchanged",this._transformFlag);for(var q=0,Q=this._children.length;q<Q;q++)this._children[q]._onWorldTransform();}},Q.translate=function(q,Q){void 0===Q&&(Q=!0),Q?(kQ.createFromQuaternion(this.localRotation,F._tempMatrix0),_q.transformCoordinate(q,F._tempMatrix0,F._tempVector30),_q.add(this.localPosition,F._tempVector30,this._localPosition),this.localPosition=this._localPosition):(_q.add(this.position,q,this._position),this.position=this._position);},Q.rotate=function(q,Q,m){var a;void 0===Q&&(Q=!0),void 0===m&&(m=!0),a=m?q:(_q.scale(q,Math.PI/180,F._tempVector30),F._tempVector30),eq.createFromYawPitchRoll(a.y,a.x,a.z,F._tempQuaternion0),Q?(eq.multiply(this._localRotation,F._tempQuaternion0,this._localRotation),this.localRotation=this._localRotation):(eq.multiply(F._tempQuaternion0,this.rotation,this._rotation),this.rotation=this._rotation);},Q.getForward=function(q){var Q=this.worldMatrix.elements;q.x=-Q[8],q.y=-Q[9],q.z=-Q[10];},Q.getUp=function(q){var Q=this.worldMatrix.elements;q.x=Q[4],q.y=Q[5],q.z=Q[6];},Q.getRight=function(q){var Q=this.worldMatrix.elements;q.x=Q[0],q.y=Q[1],q.z=Q[2];},Q.lookAt=function(q,Q,m){var a;if(void 0===m&&(m=!1),m){if(a=this._localPosition,Math.abs(a.x-q.x)<qq.zeroTolerance&&Math.abs(a.y-q.y)<qq.zeroTolerance&&Math.abs(a.z-q.z)<qq.zeroTolerance)return;eq.lookAt(this._localPosition,q,Q,this._localRotation),this._localRotation.invert(this._localRotation),this.localRotation=this._localRotation;}else{var w=this.position;if(a=w,Math.abs(a.x-q.x)<qq.zeroTolerance&&Math.abs(a.y-q.y)<qq.zeroTolerance&&Math.abs(a.z-q.z)<qq.zeroTolerance)return;eq.lookAt(w,q,Q,this._rotation),this._rotation.invert(this._rotation),this.rotation=this._rotation;}},d(0,Q,"_isFrontFaceInvert",function(){var q=this.scale,Q=q.x<0;return q.y<0&&(Q=!Q),q.z<0&&(Q=!Q),Q;}),d(0,Q,"owner",function(){return this._owner;}),d(0,Q,"localPositionY",function(){return this._localPosition.y;},function(q){this._localPosition.y=q,this.localPosition=this._localPosition;}),d(0,Q,"localScaleX",function(){return this._localScale.x;},function(q){this._localScale.x=q,this.localScale=this._localScale;}),d(0,Q,"worldNeedUpdate",function(){return this._getTransformFlag(64);}),d(0,Q,"localPositionX",function(){return this._localPosition.x;},function(q){this._localPosition.x=q,this.localPosition=this._localPosition;}),d(0,Q,"localPosition",function(){return this._localPosition;},function(q){this._localPosition!==q&&q.cloneTo(this._localPosition),this._setTransformFlag(4,!0),this._onWorldPositionTransform();}),d(0,Q,"localPositionZ",function(){return this._localPosition.z;},function(q){this._localPosition.z=q,this.localPosition=this._localPosition;}),d(0,Q,"localRotationX",function(){return this.localRotation.x;},function(q){this._localRotation.x=q,this.localRotation=this._localRotation;}),d(0,Q,"localRotationY",function(){return this.localRotation.y;},function(q){this._localRotation.y=q,this.localRotation=this._localRotation;}),d(0,Q,"localRotationZ",function(){return this.localRotation.z;},function(q){this._localRotation.z=q,this.localRotation=this._localRotation;}),d(0,Q,"localRotationW",function(){return this.localRotation.w;},function(q){this._localRotation.w=q,this.localRotation=this._localRotation;}),d(0,Q,"localRotation",function(){if(this._getTransformFlag(1)){var q=this._localRotationEuler;eq.createFromYawPitchRoll(q.y/F._angleToRandin,q.x/F._angleToRandin,q.z/F._angleToRandin,this._localRotation),this._setTransformFlag(1,!1);}
return this._localRotation;},function(q){this._localRotation!==q&&q.cloneTo(this._localRotation),this._localRotation.normalize(this._localRotation),this._setTransformFlag(6,!0),this._setTransformFlag(1,!1),this._onWorldRotationTransform();}),d(0,Q,"localScaleY",function(){return this._localScale.y;},function(q){this._localScale.y=q,this.localScale=this._localScale;}),d(0,Q,"localScaleZ",function(){return this._localScale.z;},function(q){this._localScale.z=q,this.localScale=this._localScale;}),d(0,Q,"position",function(){if(this._getTransformFlag(8)){if(null!=this._parent){var q=this._parent.position;_q.multiply(this._localPosition,this._parent.scale,F._tempVector30),_q.transformQuat(F._tempVector30,this._parent.rotation,F._tempVector30),_q.add(q,F._tempVector30,this._position);}else this._localPosition.cloneTo(this._position);this._setTransformFlag(8,!1);}
return this._position;},function(q){if(null!=this._parent){_q.subtract(q,this._parent.position,this._localPosition);var Q=this._parent.scale,m=Q.x,a=Q.y,w=Q.z;if(1!==m||1!==a||1!==w){var e=F._tempVector30;e.x=1/m,e.y=1/a,e.z=1/w,_q.multiply(this._localPosition,e,this._localPosition);}
this._parent.rotation.invert(F._tempQuaternion0),_q.transformQuat(this._localPosition,F._tempQuaternion0,this._localPosition);}else q.cloneTo(this._localPosition);this.localPosition=this._localPosition,this._position!==q&&q.cloneTo(this._position),this._setTransformFlag(8,!1);}),d(0,Q,"localRotationEulerY",function(){return this.localRotationEuler.y;},function(q){this._localRotationEuler.y=q,this.localRotationEuler=this._localRotationEuler;}),d(0,Q,"localScale",function(){return this._localScale;},function(q){this._localScale!==q&&q.cloneTo(this._localScale),this._setTransformFlag(4,!0),this._onWorldScaleTransform();}),d(0,Q,"localRotationEulerX",function(){return this.localRotationEuler.x;},function(q){this._localRotationEuler.x=q,this.localRotationEuler=this._localRotationEuler;}),d(0,Q,"localRotationEulerZ",function(){return this.localRotationEuler.z;},function(q){this._localRotationEuler.z=q,this.localRotationEuler=this._localRotationEuler;}),d(0,Q,"localRotationEuler",function(){if(this._getTransformFlag(2)){this._localRotation.getYawPitchRoll(F._tempVector30);var q=F._tempVector30,Q=this._localRotationEuler;Q.x=q.y*F._angleToRandin,Q.y=q.x*F._angleToRandin,Q.z=q.z*F._angleToRandin,this._setTransformFlag(2,!1);}
return this._localRotationEuler;},function(q){this._localRotationEuler!==q&&q.cloneTo(this._localRotationEuler),this._setTransformFlag(2,!1),this._setTransformFlag(5,!0),this._onWorldRotationTransform();}),d(0,Q,"localMatrix",function(){return this._getTransformFlag(4)&&(this._updateLocalMatrix(),this._setTransformFlag(4,!1)),this._localMatrix;},function(q){this._localMatrix!==q&&q.cloneTo(this._localMatrix),this._localMatrix.decomposeTransRotScale(this._localPosition,this._localRotation,this._localScale),this._setTransformFlag(4,!1),this._onWorldTransform();}),d(0,Q,"rotation",function(){return this._getTransformFlag(16)&&(null!=this._parent?eq.multiply(this._parent.rotation,this.localRotation,this._rotation):this.localRotation.cloneTo(this._rotation),this._setTransformFlag(16,!1)),this._rotation;},function(q){null!=this._parent?(this._parent.rotation.invert(F._tempQuaternion0),eq.multiply(F._tempQuaternion0,q,this._localRotation)):q.cloneTo(this._localRotation),this.localRotation=this._localRotation,q!==this._rotation&&q.cloneTo(this._rotation),this._setTransformFlag(16,!1);}),d(0,Q,"scale",function(){return this._getTransformFlag(32)&&(null!==this._parent?_q.multiply(this._parent.scale,this._localScale,this._scale):this._localScale.cloneTo(this._scale),this._setTransformFlag(32,!1)),this._scale;},function(q){if(null!==this._parent){var Q=this._parent.scale,m=F._tempVector30;m.x=1/Q.x,m.y=1/Q.y,m.z=1/Q.z,_q.multiply(q,F._tempVector30,this._localScale);}else q.cloneTo(this._localScale);this.localScale=this._localScale,this._scale!==q&&q.cloneTo(this._scale),this._setTransformFlag(32,!1);}),d(0,Q,"rotationEuler",function(){if(this._getTransformFlag(128)){this.rotation.getYawPitchRoll(F._tempVector30);var q=F._tempVector30,Q=this._rotationEuler;Q.x=q.y*F._angleToRandin,Q.y=q.x*F._angleToRandin,Q.z=q.z*F._angleToRandin,this._setTransformFlag(128,!1);}
return this._rotationEuler;},function(q){eq.createFromYawPitchRoll(q.y/F._angleToRandin,q.x/F._angleToRandin,q.z/F._angleToRandin,this._rotation),this.rotation=this._rotation,this._rotationEuler!==q&&q.cloneTo(this._rotationEuler),this._setTransformFlag(128,!1);}),d(0,Q,"worldMatrix",function(){return this._getTransformFlag(64)&&(null!=this._parent?kQ.multiply(this._parent.worldMatrix,this.localMatrix,this._worldMatrix):this.localMatrix.cloneTo(this._worldMatrix),this._setTransformFlag(64,!1)),this._worldMatrix;},function(q){null===this._parent?q.cloneTo(this._localMatrix):(this._parent.worldMatrix.invert(this._localMatrix),kQ.multiply(this._localMatrix,q,this._localMatrix)),this.localMatrix=this._localMatrix,this._worldMatrix!==q&&q.cloneTo(this._worldMatrix),this._setTransformFlag(64,!1);}),F.TRANSFORM_LOCALQUATERNION=1,F.TRANSFORM_LOCALEULER=2,F.TRANSFORM_LOCALMATRIX=4,F.TRANSFORM_WORLDPOSITION=8,F.TRANSFORM_WORLDQUATERNION=16,F.TRANSFORM_WORLDSCALE=32,F.TRANSFORM_WORLDMATRIX=64,F.TRANSFORM_WORLDEULER=128,y(F,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();},"_tempVector32",function(){return this._tempVector32=new _q();},"_tempVector33",function(){return this._tempVector33=new _q();},"_tempQuaternion0",function(){return this._tempQuaternion0=new eq();},"_tempMatrix0",function(){return this._tempMatrix0=new kQ();},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI;}]),F;}()),jQ=function(q){function l(){this._linkAvatarSpritesData={},this._keyframeNodeOwners=[],this._linkAvatarSprites=[],this._renderableSprites=[],this.cullingMode=2,l.__super.call(this),this._controllerLayers=[],this._linkSprites={},this._speed=1,this._keyframeNodeOwnerMap={},this._updateMark=0;}
S(l,"laya.d3.component.Animator",w);var Q=l.prototype;return Q._linkToSprites=function(q){for(var Q in q){for(var m=this.owner,a=q[Q],w=0,e=a.length;w<e;w++){var F=a[w];if(""===F)break;if(!(m=m.getChildByName(F)))break;}
m&&this.linkSprite3DToAvatarNode(Q,m);}},Q._addKeyframeNodeOwner=function(q,Q,m){var a=Q._indexInList,w=Q.fullPath,e=this._keyframeNodeOwnerMap[w];if(e)e.referenceCount++,q[a]=e;else{for(var F=m,W=0,s=Q.propertyCount;W<s&&(F=F[Q.getPropertyByIndex(W)]);W++);(e=this._keyframeNodeOwnerMap[w]=new BQ()).fullPath=w,e.indexInList=this._keyframeNodeOwners.length,e.referenceCount=1,e.propertyOwner=m;var D=Q.propertyCount,d=N(D);for(W=0;W<D;W++)d[W]=Q.getPropertyByIndex(W);if(e.property=d,e.type=Q.type,F)
if(0===Q.type)e.defaultValue=F;else{var v=new F.constructor();F.cloneTo(v),e.defaultValue=v;}
this._keyframeNodeOwners.push(e),q[a]=e;}},Q._removeKeyframeNodeOwner=function(q,Q){var m=Q.fullPath,a=this._keyframeNodeOwnerMap[m];a&&(a.referenceCount--,0===a.referenceCount&&(delete this._keyframeNodeOwnerMap[m],this._keyframeNodeOwners.splice(this._keyframeNodeOwners.indexOf(a),1)),q[Q._indexInList]=null);},Q._getOwnersByClip=function(q){var Q=q._clip._nodes,m=Q.count,a=q._nodeOwners;a.length=m;for(var w=0;w<m;w++){for(var e=Q.getNodeByIndex(w),F=this._avatar?this._avatarNodeMap[this._avatar._rootNode.name]:this.owner,W=0,s=e.ownerPathCount;W<s;W++){var D=e.getOwnerPathByIndex(W);if(""===D)break;if(!(F=F.getChildByName(D)))break;}
if(F){var d=e.propertyOwner;d&&(F=F[d]),F&&this._addKeyframeNodeOwner(a,e,F);}}},Q._updatePlayer=function(q,Q,m,a){var w=q._clip._duration*(q.clipEnd-q.clipStart),e=Q._elapsedTime,F=e+m;Q._lastElapsedTime=e;var W=(Q._elapsedTime=F)/w,s=(Q._normalizedTime=W)%1;Q._normalizedPlayTime=s<0?s+1:s,Q._duration=w;var D=q._scripts;if(!a&&w<=F){if(Q._finish=!0,Q._elapsedTime=w,Q._normalizedPlayTime=1,D)
for(var d=0,v=D.length;d<v;d++)D[d].onStateExit();}else if(D)
for(d=0,v=D.length;d<v;d++)D[d].onStateUpdate();},Q._eventScript=function(q,Q,m,a,w){if(w)
for(var e=Q.length;m<e;m++){var F=Q[m];if(!(F.time<=a))break;for(var W=0,s=q.length;W<s;W++){var D=q[W],d=D[F.eventName];d&&d.apply(D,F.params);}}else
for(;0<=m&&(F=Q[m]).time>=a;m--)
for(W=0,s=q.length;W<s;W++)(d=(D=q[W])[F.eventName])&&d.apply(D,F.params);return m;},Q._updateEventScript=function(q,Q){var m=this.owner._scripts;if(m&&!this.owner.disableEventScript){var a=q._clip,w=a._events,e=a._duration,F=Q._elapsedTime,W=F%e,s=Math.abs(Math.floor(F/e)-Math.floor(Q._lastElapsedTime/e)),D=Q._elapsedTime>=Q._lastElapsedTime;if(Q._lastIsFront!==D&&(D?Q._playEventIndex++:Q._playEventIndex--,Q._lastIsFront=D),0==s)Q._playEventIndex=this._eventScript(m,w,Q._playEventIndex,W,D);else if(D){this._eventScript(m,w,Q._playEventIndex,e,!0);for(var d=0,v=s-1;d<v;d++)this._eventScript(m,w,0,e,!0);Q._playEventIndex=this._eventScript(m,w,0,W,!0);}else{this._eventScript(m,w,Q._playEventIndex,0,!1);var y=w.length-1;for(d=0,v=s-1;d<v;d++)this._eventScript(m,w,y,0,!1);Q._playEventIndex=this._eventScript(m,w,y,W,!1);}}},Q._updateClipDatas=function(q,Q,m,a){var w=q._clip,e=w._duration,F=q.clipStart*e+m._normalizedPlayTime*m._duration,W=q._currentFrameIndices,s=m._elapsedTime>m._lastElapsedTime;w._evaluateClipDatasRealTime(w._nodes,F,W,Q,s);},Q._applyFloat=function(q,Q,m,a,w,e,F){if(m.updateMark===this._updateMark)
if(a)q[Q]+=w*F;else{var W=q[Q];q[Q]=W+w*(F-W);}
else if(e)q[Q]=a?m.defaultValue+F:F;else if(a)q[Q]=m.defaultValue+w*F;else{var s=m.defaultValue;q[Q]=s+w*(F-s);}},Q._applyPositionAndRotationEuler=function(q,Q,m,a,w,e){if(q.updateMark===this._updateMark)
if(Q)e.x+=m*w.x,e.y+=m*w.y,e.z+=m*w.z;else{var F=e.x,W=e.y,s=e.z;e.x=F+m*(w.x-F),e.y=W+m*(w.y-W),e.z=s+m*(w.z-s);}
else if(a)
if(Q){var D=q.defaultValue;e.x=D.x+w.x,e.y=D.y+w.y,e.z=D.z+w.z;}else e.x=w.x,e.y=w.y,e.z=w.z;else if(D=q.defaultValue,Q)e.x=D.x+m*w.x,e.y=D.y+m*w.y,e.z=D.z+m*w.z;else{var d=D.x,v=D.y,y=D.z;e.x=d+m*(w.x-d),e.y=v+m*(w.y-v),e.z=y+m*(w.z-y);}},Q._applyRotation=function(q,Q,m,a,w,e){if(q.updateMark===this._updateMark)
if(Q){var F=l._tempQuaternion1;Rq.quaternionWeight(w,m,F),F.normalize(F),eq.multiply(e,F,e);}else eq.lerp(e,w,m,e);else if(a)
if(Q){var W=q.defaultValue;eq.multiply(W,w,e);}else e.x=w.x,e.y=w.y,e.z=w.z,e.w=w.w;else W=q.defaultValue,Q?(F=l._tempQuaternion1,Rq.quaternionWeight(w,m,F),F.normalize(F),eq.multiply(W,F,e)):eq.lerp(W,w,m,e);},Q._applyScale=function(q,Q,m,a,w,e){if(q.updateMark===this._updateMark)
if(Q){var F=l._tempVector31;Rq.scaleWeight(w,m,F),e.x=e.x*F.x,e.y=e.y*F.y,e.z=e.z*F.z;}else Rq.scaleBlend(e,w,m,e);else if(a)
if(Q){var W=q.defaultValue;e.x=W.x*w.x,e.y=W.y*w.y,e.z=W.z*w.z;}else e.x=w.x,e.y=w.y,e.z=w.z;else W=q.defaultValue,Q?(F=l._tempVector31,Rq.scaleWeight(w,m,F),e.x=W.x*F.x,e.y=W.y*F.y,e.z=W.z*F.z):Rq.scaleBlend(W,w,m,e);},Q._applyCrossData=function(q,Q,m,a,w,e,F){var W=q.propertyOwner;if(W){switch(q.type){case 0:for(var s=q.property,D=s.length-1,d=0;d<D&&(W=W[s[d]]);d++);var v=w+F*(e-w);this._applyFloat(W,s[D],q,Q,m,a,v);break;case 1:var y=W.localPosition,S=l._tempVector30,t=w.x,o=w.y,b=w.z;S.x=t+F*(e.x-t),S.y=o+F*(e.y-o),S.z=b+F*(e.z-b),this._applyPositionAndRotationEuler(q,Q,m,a,S,y),W.localPosition=y;break;case 2:var U=W.localRotation,J=l._tempQuaternion0;eq.lerp(w,e,F,J),this._applyRotation(q,Q,m,a,J,U),W.localRotation=U;break;case 3:var V=W.localScale,n=l._tempVector30;Rq.scaleBlend(w,e,F,n),this._applyScale(q,Q,m,a,n,V),W.localScale=V;break;case 4:var O=W.localRotationEuler,C=l._tempVector30;t=w.x,o=w.y,b=w.z,C.x=t+F*(e.x-t),C.y=o+F*(e.y-o),C.z=b+F*(e.z-b),this._applyPositionAndRotationEuler(q,Q,m,a,C,O),W.localRotationEuler=O;}
q.updateMark=this._updateMark;}},Q._setClipDatasToNode=function(q,Q,m,a){for(var w=q._clip._nodes,e=q._nodeOwners,F=0,W=w.count;F<W;F++){var s=e[F];if(s){var D=s.propertyOwner;if(D){switch(s.type){case 0:for(var d=s.property,v=d.length-1,y=0;y<v&&(D=D[d[y]]);y++);this._applyFloat(D,d[v],s,Q,m,a,w.getNodeByIndex(F).data);break;case 1:var S=D.localPosition;this._applyPositionAndRotationEuler(s,Q,m,a,w.getNodeByIndex(F).data,S),D.localPosition=S;break;case 2:var t=D.localRotation;this._applyRotation(s,Q,m,a,w.getNodeByIndex(F).data,t),D.localRotation=t;break;case 3:var o=D.localScale;this._applyScale(s,Q,m,a,w.getNodeByIndex(F).data,o),D.localScale=o;break;case 4:var b=D.localRotationEuler;this._applyPositionAndRotationEuler(s,Q,m,a,w.getNodeByIndex(F).data,b),D.localRotationEuler=b;}
s.updateMark=this._updateMark;}}}},Q._setCrossClipDatasToNode=function(q,Q,m,a,w){for(var e=q._crossNodesOwners,F=q._crossNodesOwnersCount,W=q.blendingMode!==MQ.BLENDINGMODE_OVERRIDE,s=q.defaultWeight,D=q._destCrossClipNodeIndices,d=m._clip._nodes,v=m._nodeOwners,y=q._srcCrossClipNodeIndices,S=Q._nodeOwners,t=Q._clip._nodes,o=0;o<F;o++){var b=e[o];if(b){var U=y[o],J=D[o],V=-1!==U?t.getNodeByIndex(U).data:v[J].defaultValue,n=-1!==J?d.getNodeByIndex(J).data:S[U].defaultValue;this._applyCrossData(b,W,s,w,V,n,a);}}},Q._setFixedCrossClipDatasToNode=function(q,Q,m,a){for(var w=q._crossNodesOwners,e=q._crossNodesOwnersCount,F=q.blendingMode!==MQ.BLENDINGMODE_OVERRIDE,W=q.defaultWeight,s=q._destCrossClipNodeIndices,D=Q._clip._nodes,d=0;d<e;d++){var v=w[d];if(v){var y=s[d],S=v.crossFixedValue,t=-1!==y?D.getNodeByIndex(y).data:v.defaultValue;this._applyCrossData(v,F,W,a,S,t,m);}}},Q._revertDefaultKeyframeNodes=function(q){for(var Q=q._nodeOwners,m=0,a=Q.length;m<a;m++){var w=Q[m];if(w){var e=w.propertyOwner;if(e)switch(w.type){case 0:for(var F=w.property,W=F.length-1,s=0;s<W&&(e=e[F[s]]);s++);e[F[W]]=w.defaultValue;break;case 1:var D=e.localPosition,d=w.defaultValue;D.x=d.x,D.y=d.y,D.z=d.z,e.localPosition=D;break;case 2:var v=e.localRotation,y=w.defaultValue;v.x=y.x,v.y=y.y,v.z=y.z,v.w=y.w,e.localRotation=v;break;case 3:var S=e.localScale;d=w.defaultValue,S.x=d.x,S.y=d.y,S.z=d.z,e.localScale=S;break;case 4:var t=e.localRotationEuler;d=w.defaultValue,t.x=d.x,t.y=d.y,t.z=d.z,e.localRotationEuler=t;break;default:throw"Animator:unknown type.";}}}},Q._removeClip=function(q,Q,m,a){var w=a._clip;w._removeReference(),q.splice(m,1),delete Q[a.name];for(var e=q[m],F=w._nodes,W=e._nodeOwners,s=0,D=F.count;s<D;s++)this._removeKeyframeNodeOwner(W,F.getNodeByIndex(s));},Q._onAdded=function(){var q=this.owner._parent;this.owner._setHierarchyAnimator(this,q?q._hierarchyAnimator:null),this.owner._changeAnimatorToLinkSprite3DNoAvatar(this,!0,[]);},Q._onDestroy=function(){for(var q=0,Q=this._controllerLayers.length;q<Q;q++)
for(var m=this._controllerLayers[q]._states,a=0,w=m.length;a<w;a++)m[a]._clip._removeReference();var e=this.owner._parent;this.owner._clearHierarchyAnimator(this,e?e._hierarchyAnimator:null);},Q._onEnableInScene=function(){this.owner._scene._animatorPool.add(this);},Q._onDisableInScene=function(){this.owner._scene._animatorPool.remove(this);},Q._onEnable=function(){for(var q=0,Q=this._controllerLayers.length;q<Q;q++){if(this._controllerLayers[q].playOnWake)this.getDefaultState(q)&&this.play(null,q,0);}},Q._handleSpriteOwnersBySprite=function(q,Q,m){for(var a=0,w=this._controllerLayers.length;a<w;a++)
for(var e=this._controllerLayers[a]._states,F=0,W=e.length;F<W;F++){var s=e[F],D=s._clip,d=Q.join("/"),v=D._nodesMap[d];if(v)
for(var y=s._nodeOwners,S=0,t=v.length;S<t;S++)q?this._addKeyframeNodeOwner(y,v[S],m):this._removeKeyframeNodeOwner(y,v[S]);}},Q._parse=function(q){var Q=q.avatar;if(Q){this.avatar=uq.getRes(Q.path);var m=Q.linkSprites;this._linkSprites=m,this._linkToSprites(m);}
q.clipPaths;for(var a=q.playOnWake,w=q.layers,e=0;e<w.length;e++){var F=w[e],W=new MQ(F.name);W.defaultWeight=0===e?1:F.weight;var s=F.blendingMode;s&&(W.blendingMode=s),this.addControllerLayer(W);for(var D=F.states,d=0,v=D.length;d<v;d++){var y=D[d],S=y.clipPath;if(S){var t,o=y.name;if(t=uq.getRes(S)){var b=new KQ();b.name=o,b.clip=t,this.addState(b,e),0===d&&(this.getControllerLayer(e).defaultState=b);}}}
void 0!==a&&(W.playOnWake=a);}
var U=q.cullingMode;void 0!==U&&(this.cullingMode=U);},Q._update=function(){if(0!==this._speed){var q=!1;if(2===this.cullingMode){q=!1;for(var Q=0,m=this._renderableSprites.length;Q<m;Q++)
if(this._renderableSprites[Q]._render._visible){q=!0;break;}}else q=!0;this._updateMark++;var a=this.owner._scene.timer,w=a._delta/1e3,e=a.scale;for(Q=0,m=this._controllerLayers.length;Q<m;Q++){var F=this._controllerLayers[Q],W=F._playStateInfo,s=F._crossPlayStateInfo;switch(S=F.blendingMode!==MQ.BLENDINGMODE_OVERRIDE,F._playType){case 0:var D=F._currentPlayState,d=D._clip,v=this._speed*D.speed,y=W._finish;if(y||this._updatePlayer(D,W,w*v,d.islooping),q){var S=F.blendingMode!==MQ.BLENDINGMODE_OVERRIDE;this._updateClipDatas(D,S,W,e*v),this._setClipDatasToNode(D,S,F.defaultWeight,0===Q),y||this._updateEventScript(D,W);}
break;case 1:d=(D=F._currentPlayState)._clip;var t=F._crossPlayState,o=t._clip,b=F._crossDuration,U=s._startPlayTime,J=o._duration-U,V=J<b?J/b:1,n=this._speed*t.speed;this._updatePlayer(t,s,w*V*n,o.islooping);var O=(s._elapsedTime-U)/V/b;1<=O?q&&(this._updateClipDatas(t,S,s,e*n),this._setClipDatasToNode(t,S,F.defaultWeight,0===Q),F._playType=0,F._currentPlayState=t,s._cloneTo(W)):(W._finish||(v=this._speed*D.speed,this._updatePlayer(D,W,w*v,d.islooping),q&&this._updateClipDatas(D,S,W,e*v)),q&&(this._updateClipDatas(t,S,s,e*V*n),this._setCrossClipDatasToNode(F,D,t,O,0===Q))),q&&(this._updateEventScript(D,W),this._updateEventScript(t,s));break;case 2:o=(t=F._crossPlayState)._clip,b=F._crossDuration,U=s._startPlayTime,V=(J=o._duration-U)<b?J/b:1,n=this._speed*t.speed,this._updatePlayer(t,s,w*V*n,o.islooping),q&&(1<=(O=(s._elapsedTime-U)/V/b)?(this._updateClipDatas(t,S,s,e*n),this._setClipDatasToNode(t,S,1,0===Q),F._playType=0,F._currentPlayState=t,s._cloneTo(W)):(this._updateClipDatas(t,S,s,e*V*n),this._setFixedCrossClipDatasToNode(F,t,O,0===Q)),this._updateEventScript(t,s));}}
q&&this._avatar&&(M.supportWebGLPlusAnimation&&this._updateAnimationNodeWorldMatix(this._animationNodeLocalPositions,this._animationNodeLocalRotations,this._animationNodeLocalScales,this._animationNodeWorldMatrixs,this._animationNodeParentIndices),this._updateAvatarNodesToSprite());}},Q._cloneTo=function(q){var Q=q;Q.avatar=this.avatar;for(var m=0,a=this._controllerLayers.length;m<a;m++){var w=this._controllerLayers[m];Q.addControllerLayer(w.clone());for(var e=w._states,F=0,W=e.length;F<W;F++){var s=e[F].clone();Q.addState(s,m),0==F&&(Q.getControllerLayer(m).defaultState=s);}}
this.avatar&&(Q.cullingMode=this.avatar.cullingMode),Q._linkSprites=this._linkSprites,Q._linkToSprites(this._linkSprites);},Q.getDefaultState=function(q){return void 0===q&&(q=0),this._controllerLayers[q].defaultState;},Q.addState=function(q,Q){void 0===Q&&(Q=0);var m=q.name,a=this._controllerLayers[Q],w=a._statesMap,e=a._states;if(w[m])throw"Animator:this stat's name has exist.";w[m]=q,e.push(q),q._clip._addReference(),this._getOwnersByClip(q);},Q.removeState=function(q,Q){void 0===Q&&(Q=0);for(var m=this._controllerLayers[Q],a=m._states,w=m._statesMap,e=-1,F=0,W=a.length;F<W;F++)
if(a[F]===q){e=F;break;}-
1!==e&&this._removeClip(a,w,e,q);},Q.addControllerLayer=function(q){this._controllerLayers.push(q);},Q.getControllerLayer=function(q){return void 0===q&&(q=0),this._controllerLayers[q];},Q.getCurrentAnimatorPlayState=function(q){return void 0===q&&(q=0),this._controllerLayers[q]._playStateInfo;},Q.play=function(q,Q,m){void 0===Q&&(Q=0),void 0===m&&(m=Number.NEGATIVE_INFINITY);var a=this._controllerLayers[Q],w=a.defaultState;if(!q&&!w)throw new Error("Animator:must have  default clip value,please set clip property.");var e=a._currentPlayState,F=a._playStateInfo,W=q?a._statesMap[q]:w,s=W._clip._duration;e!==W?(m!==Number.NEGATIVE_INFINITY?F._resetPlayState(s*m):F._resetPlayState(0),null!==e&&e!==W&&this._revertDefaultKeyframeNodes(e),a._playType=0,a._currentPlayState=W):m!==Number.NEGATIVE_INFINITY&&(F._resetPlayState(s*m),a._playType=0);var D=W._scripts;if(D)
for(var d=0,v=D.length;d<v;d++)D[d].onStateEnter();},Q.crossFade=function(q,Q,m,a){void 0===m&&(m=0),void 0===a&&(a=Number.NEGATIVE_INFINITY);var w=this._controllerLayers[m],e=w._statesMap[q];if(e){var F=w._playType;if(-1===F)return void this.play(q,m,a);var W=w._crossPlayStateInfo,s=w._crossNodesOwners,D=w._crossNodesOwnersIndicesMap,d=w._currentPlayState,v=e._nodeOwners,y=w._destCrossClipNodeIndices,S=e._clip,t=S._nodes,o=S._nodesDic;switch(F){case 0:var b=d._nodeOwners,U=w._srcCrossClipNodeIndices,J=d._clip,V=J._nodes,n=J._nodesDic;w._playType=1;for(var O=++w._crossMark,C=w._crossNodesOwnersCount=0,l=0,u=V.count;l<u;l++){var f=V.getNodeByIndex(l),p=f._indexInList,T=b[p];if(T){var c=f.fullPath;U[C]=p;var r=o[c];y[C]=r?r._indexInList:-1,D[c]=O,s[C]=T,C++;}}
for(l=0,u=t.count;l<u;l++){var _=(r=t.getNodeByIndex(l))._indexInList,Z=v[_];if(Z){var A=r.fullPath;n[A]||(U[C]=-1,y[C]=_,D[A]=O,s[C]=Z,C++);}}
break;case 1:case 2:for(w._playType=2,l=0,u=s.length;l<u;l++){var E=s[l];E.saveCrossFixedValue(),r=o[E.fullPath],y[l]=r?r._indexInList:-1;}
for(C=w._crossNodesOwnersCount,O=w._crossMark,l=0,u=t.count;l<u;l++)(Z=v[_=(r=t.getNodeByIndex(l))._indexInList])&&D[A=r.fullPath]!==O&&(y[C]=_,D[A]=O,E=v[_],(s[C]=E).saveCrossFixedValue(),C++);}
w._crossNodesOwnersCount=C,w._crossPlayState=e,w._crossDuration=d._clip._duration*Q,a!==Number.NEGATIVE_INFINITY?W._resetPlayState(S._duration*a):W._resetPlayState(0);}
var B=e._scripts;if(B)
for(l=0,u=B.length;l<u;l++)B[l].onStateEnter();},Q._getAvatarOwnersAndInitDatasAsync=function(){for(var q=0,Q=this._controllerLayers.length;q<Q;q++)
for(var m=this._controllerLayers[q]._states,a=0,w=m.length;a<w;a++)this._getOwnersByClip(m[a]);for(var e in this._avatar._cloneDatasToAnimator(this),this._linkAvatarSpritesData){var F=this._linkAvatarSpritesData[e];if(F)
for(var W=0,s=F.length;W<s;W++)this._isLinkSpriteToAnimationNode(F[W],e,!0);}},Q._isLinkSpriteToAnimationNode=function(q,Q,m){if(this._avatar){var a=this._avatarNodeMap[Q];if(a)
if(m){q._transform._dummy=a.transform,this._linkAvatarSprites.push(q);var w=a.transform,e=q.transform;if(!e.owner.isStatic&&w){var F=e.worldMatrix,W=this.owner._transform._parent;if(W)Rq.matrix4x4MultiplyMFM(W.worldMatrix,w.getWorldMatrix(),F);else
for(var s=F.elements,D=w.getWorldMatrix(),d=0;d<16;d++)s[d]=D[d];e.worldMatrix=F;}}else q._transform._dummy=null,this._linkAvatarSprites.splice(this._linkAvatarSprites.indexOf(q),1);}},Q._isLinkSpriteToAnimationNodeData=function(q,Q,m){var a=this._linkAvatarSpritesData[Q];m?(a||(this._linkAvatarSpritesData[Q]=a=[]),a.push(q)):a.splice(q,1);},Q._updateAvatarNodesToSprite=function(){for(var q=0,Q=this._linkAvatarSprites.length;q<Q;q++){var m=this._linkAvatarSprites[q],a=m.transform._dummy,w=m.transform;if(!w.owner.isStatic&&a){var e=w.worldMatrix,F=this.owner._transform;Rq.matrix4x4MultiplyMFM(F.worldMatrix,a.getWorldMatrix(),e),w.worldMatrix=e;}}},Q.linkSprite3DToAvatarNode=function(q,Q){return this._isLinkSpriteToAnimationNodeData(Q,q,!0),this._isLinkSpriteToAnimationNode(Q,q,!0),!0;},Q.unLinkSprite3DToAvatarNode=function(q){if(q._hierarchyAnimator!==this)throw"Animator:sprite3D must belong to this Animator";var Q=q.transform._dummy;if(Q){var m=Q._owner.name;return this._isLinkSpriteToAnimationNodeData(q,m,!1),this._isLinkSpriteToAnimationNode(q,m,!1),!0;}
return!1;},Q._updateAnimationNodeWorldMatix=function(q,Q,m,a,w){J.instance.updateAnimationNodeWorldMatix(q,Q,m,w,a);},d(0,Q,"speed",function(){return this._speed;},function(q){this._speed=q;}),d(0,Q,"avatar",function(){return this._avatar;},function(q){if(this._avatar!==q)
if(this._avatar=q)this._getAvatarOwnersAndInitDatasAsync(),this.owner._changeHierarchyAnimatorAvatar(this,q);else{var Q=this.owner._parent;this.owner._changeHierarchyAnimatorAvatar(this,Q?Q._hierarchyAnimator._avatar:null);}}),l._update=function(q){for(var Q=q._animatorPool,m=Q.elements,a=0,w=Q.length;a<w;a++){var e=m[a];e&&e.enabled&&e._update();}},l._tempVector3Array0=new Float32Array(3),l._tempVector3Array1=new Float32Array(3),l._tempQuaternionArray0=new Float32Array(4),l._tempQuaternionArray1=new Float32Array(4),l.CULLINGMODE_ALWAYSANIMATE=0,l.CULLINGMODE_CULLCOMPLETELY=2,y(l,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();},"_tempQuaternion0",function(){return this._tempQuaternion0=new eq();},"_tempQuaternion1",function(){return this._tempQuaternion1=new eq();}]),l;}(),hQ=function(q){function e(q,Q,m,a,w){e.__super.call(this),this._owner=q,this._children=[],this._localMatrix=new Float32Array(16),M.supportWebGLPlusAnimation?(this._localPosition=new L(0,0,0,Q),this._localRotation=new x(0,0,0,1,m),this._localScale=new L(0,0,0,a),this._worldMatrix=w):(this._localPosition=new _q(),this._localRotation=new eq(),this._localScale=new _q(),this._worldMatrix=new Float32Array(16)),this._localQuaternionUpdate=!1,this._locaEulerlUpdate=!1,this._localUpdate=!1,this._worldUpdate=!0;}
S(e,"laya.d3.animation.AnimationTransform3D",t);var Q=e.prototype;return Q._getlocalMatrix=function(){return this._localUpdate&&(Rq._createAffineTransformationArray(this._localPosition,this._localRotation,this._localScale,this._localMatrix),this._localUpdate=!1),this._localMatrix;},Q._onWorldTransform=function(){if(!this._worldUpdate){this._worldUpdate=!0,this.event("transformchanged");for(var q=0,Q=this._children.length;q<Q;q++)this._children[q]._onWorldTransform();}},Q.getWorldMatrix=function(){if(!M.supportWebGLPlusAnimation&&this._worldUpdate){if(null!=this._parent)Rq.matrix4x4MultiplyFFF(this._parent.getWorldMatrix(),this._getlocalMatrix(),this._worldMatrix);else{var q=this._worldMatrix;q[1]=q[2]=q[3]=q[4]=q[6]=q[7]=q[8]=q[9]=q[11]=q[12]=q[13]=q[14]=0,q[0]=q[5]=q[10]=q[15]=1;}
this._worldUpdate=!1;}
return M.supportWebGLPlusAnimation&&this._worldUpdate&&(this._worldUpdate=!1),this._worldMatrix;},Q.setParent=function(q){if(this._parent!==q){if(this._parent){var Q=this._parent._children,m=Q.indexOf(this);Q.splice(m,1);}
q&&(q._children.push(this),q&&this._onWorldTransform()),this._parent=q;}},d(0,Q,"localPosition",function(){return this._localPosition;},function(q){this._localPosition=q,this._localUpdate=!0,this._onWorldTransform();}),d(0,Q,"localRotation",function(){if(this._localQuaternionUpdate){var q=this._localRotationEuler;eq.createFromYawPitchRoll(q.y/e._angleToRandin,q.x/e._angleToRandin,q.z/e._angleToRandin,this._localRotation),this._localQuaternionUpdate=!1;}
return this._localRotation;},function(q){this._localRotation=q,this._locaEulerlUpdate=!0,this._localQuaternionUpdate=!1,this._localUpdate=!0,this._onWorldTransform();}),d(0,Q,"localScale",function(){return this._localScale;},function(q){this._localScale=q,this._localUpdate=!0,this._onWorldTransform();}),d(0,Q,"localRotationEuler",function(){if(this._locaEulerlUpdate){this._localRotation.getYawPitchRoll(e._tempVector3);var q=e._tempVector3,Q=this._localRotationEuler;Q.x=q.y*e._angleToRandin,Q.y=q.x*e._angleToRandin,Q.z=q.z*e._angleToRandin,this._locaEulerlUpdate=!1;}
return this._localRotationEuler;},function(q){this._localRotationEuler=q,this._locaEulerlUpdate=!1,this._localQuaternionUpdate=!0,this._localUpdate=!0,this._onWorldTransform();}),y(e,["_tempVector3",function(){return this._tempVector3=new _q();},"_angleToRandin",function(){return this._angleToRandin=180/Math.PI;}]),e;}(),HQ=function(q){function w(q,Q,m,a){if(this._vertexCount=0,this._canRead=!1,this._dataType=0,this._vertexDeclaration=null,void 0===m&&(m=!1),void 0===a&&(a=0),w.__super.call(this),this._vertexCount=-1,this._bufferUsage=Q,this._bufferType=34962,this._canRead=m,this._dataType=a,this._byteLength=q,this.bind(),J.instance.bufferData(this._bufferType,this._byteLength,this._bufferUsage),m)switch(a){case 0:this._buffer=new Float32Array(q/4);break;case 1:this._buffer=new Uint8Array(q);}}
S(w,"laya.d3.graphics.VertexBuffer3D",q);var Q=w.prototype;return Q.bind=function(){return a._bindedVertexBuffer!==this._glBuffer&&(J.instance.bindBuffer(34962,this._glBuffer),a._bindedVertexBuffer=this._glBuffer,!0);},Q.setData=function(q,Q,m,a){if(void 0===Q&&(Q=0),void 0===m&&(m=0),void 0===a&&(a=4294967295),this.bind(),0!==m||4294967295!==a)switch(this._dataType){case 0:q=new Float32Array(q.buffer,4*m,a);break;case 1:q=new Uint8Array(q.buffer,m,a);}
switch(this._dataType){case 0:J.instance.bufferSubData(this._bufferType,4*Q,q);break;case 1:J.instance.bufferSubData(this._bufferType,Q,q);}
this._canRead&&this._buffer.set(q,Q);},Q.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!");},Q.destroy=function(){q.prototype.destroy.call(this),this._buffer=null,this._vertexDeclaration=null;},d(0,Q,"vertexDeclaration",function(){return this._vertexDeclaration;},function(q){this._vertexDeclaration!==q&&(this._vertexDeclaration=q,this._vertexCount=q?this._byteLength/q.vertexStride:-1);}),d(0,Q,"vertexCount",function(){return this._vertexCount;}),d(0,Q,"canRead",function(){return this._canRead;}),w.DATATYPE_FLOAT32ARRAY=0,w.DATATYPE_UINT8ARRAY=1,w;}(a),gQ=(function(q){function Q(){this._nativeConstraint=null,this._breakingImpulseThreshold=NaN,this._connectedBody=null,this._feedbackEnabled=!1,Q.__super.call(this);}
S(Q,"laya.d3.physics.constraints.ConstraintComponent",w);var m=Q.prototype;m._onDestroy=function(){R._physics3D.destroy(this._nativeConstraint),this._nativeConstraint=null;},d(0,m,"breakingImpulseThreshold",function(){return this._breakingImpulseThreshold;},function(q){this._nativeConstraint.BreakingImpulseThreshold=q,this._breakingImpulseThreshold=q;}),d(0,m,"enabled",function(){return o.superGet(w,this,"enabled");},function(q){this._nativeConstraint.IsEnabled=q,o.superSet(w,this,"enabled",q);}),d(0,m,"appliedImpulse",function(){return this._feedbackEnabled||(this._nativeConstraint.EnableFeedback(!0),this._feedbackEnabled=!0),this._nativeConstraint.AppliedImpulse;}),d(0,m,"connectedBody",function(){return this._connectedBody;},function(q){this._connectedBody=q;});}(),function(q){function F(q,Q,m,a){this._indexType=null,this._indexTypeByteCount=0,this._indexCount=0,this._canRead=!1,void 0===m&&(m=35044),void 0===a&&(a=!1),F.__super.call(this),this._indexType=q,this._indexCount=Q,this._bufferUsage=m,this._bufferType=34963,this._canRead=a;var w;if("ushort"==q)this._indexTypeByteCount=2;else{if("ubyte"!=q)throw new Error("unidentification index type.");this._indexTypeByteCount=1;}
w=this._indexTypeByteCount*Q,this._byteLength=w;var e=v._curBindedBufferState;e?e._bindedIndexBuffer===this?J.instance.bufferData(this._bufferType,w,this._bufferUsage):(e.unBind(),this.bind(),J.instance.bufferData(this._bufferType,w,this._bufferUsage),e.bind()):(this.bind(),J.instance.bufferData(this._bufferType,w,this._bufferUsage)),a&&("ushort"==q?this._buffer=new Uint16Array(Q):"ubyte"==q&&(this._buffer=new Uint8Array(Q)));}
S(F,"laya.d3.graphics.IndexBuffer3D",q);var Q=F.prototype;return Q._bindForVAO=function(){if(!v._curBindedBufferState)throw"IndexBuffer3D: must bind current BufferState.";J.instance.bindBuffer(34963,this._glBuffer);},Q.bind=function(){if(v._curBindedBufferState)throw"IndexBuffer3D: must unbind current BufferState.";return a._bindedIndexBuffer!==this._glBuffer&&(J.instance.bindBuffer(34963,this._glBuffer),a._bindedIndexBuffer=this._glBuffer,!0);},Q.setData=function(q,Q,m,a){void 0===Q&&(Q=0),void 0===m&&(m=0),void 0===a&&(a=4294967295);var w=0;"ushort"==this._indexType?(w=2,0===m&&4294967295===a||(q=new Uint16Array(q.buffer,m*w,a))):"ubyte"==this._indexType&&(w=1,0===m&&4294967295===a||(q=new Uint8Array(q.buffer,m*w,a)));var e=v._curBindedBufferState;if(e?e._bindedIndexBuffer===this?J.instance.bufferSubData(this._bufferType,Q*w,q):(e.unBind(),this.bind(),J.instance.bufferSubData(this._bufferType,Q*w,q),e.bind()):(this.bind(),J.instance.bufferSubData(this._bufferType,Q*w,q)),this._canRead)
if(0!==Q||0!==m||4294967295!==a){var F=this._buffer.length-Q;F<a&&(a=F);for(var W=0;W<a;W++)this._buffer[Q+W]=q[W];}else this._buffer=q;},Q.getData=function(){if(this._canRead)return this._buffer;throw new Error("Can't read data from VertexBuffer with only write flag!");},Q.destroy=function(){q.prototype.destroy.call(this),this._buffer=null;},d(0,Q,"indexType",function(){return this._indexType;}),d(0,Q,"indexTypeByteCount",function(){return this._indexTypeByteCount;}),d(0,Q,"indexCount",function(){return this._indexCount;}),d(0,Q,"canRead",function(){return this._canRead;}),F.INDEXTYPE_UBYTE="ubyte",F.INDEXTYPE_USHORT="ushort",F;}(a)),IQ=function(q){function s(q,Q,m,a){this._renderState=new z(),this._owner=q,this._cacheSharders=[],this._publicValidDefine=0,this._spriteValidDefine=0,this._materialValidDefine=0,this._validDefineMap={},s.__super.call(this,Q,m,null,this._validDefineMap);var w=this._owner._publicDefinesMap,e=this._owner._spriteDefinesMap,F=this._owner._materialDefinesMap;for(var W in this._validDefineMap)null!=w[W]?this._publicValidDefine|=w[W]:null!=e[W]?this._spriteValidDefine|=e[W]:null!=F[W]&&(this._materialValidDefine|=F[W]);this._stateMap=a;}
S(s,"laya.d3.shader.ShaderPass",f);var Q=s.prototype;return Q._definesToNameDic=function(q,Q){for(var m={},a=1,w=0;w<32&&!(q<(a=1<<w));w++){q&a&&(m[Q[a]]="");}
return m;},Q._compileToTree=function(q,Q,m,a,w){var e,F,W,s,D,d,v,y=0,S=0,t=0,o=0;for(S=m;S<Q.length;S++)
if(!((W=Q[S]).length<1)&&0!==(y=W.indexOf("//"))){if(0<=y&&(W=W.substr(0,y)),e=v||new p(a),v=null,0<=(y=(e.text=W).indexOf("#"))){for(s="#",o=y+1,t=W.length;o<t;o++){var b=W.charAt(o);if(" "===b||"\t"===b||"?"===b)break;s+=b;}
switch(e.name=s){case"#ifdef":case"#ifndef":if(e.setParent(q),q=e,w)
for(d=W.substr(o).split(f._splitToWordExps3),o=0;o<d.length;o++)(W=d[o]).length&&(w[W]=!0);continue;case"#if":case"#elif":if(e.setParent(q),q=e,w)
for(d=W.substr(o).split(f._splitToWordExps3),o=0;o<d.length;o++)(W=d[o]).length&&"defined"!=W&&(w[W]=!0);continue;case"#else":F=(q=q.parent).childs[q.childs.length-1],e.setParent(q),q=e;continue;case"#endif":F=(q=q.parent).childs[q.childs.length-1],e.setParent(q);continue;case"#include":d=f.splitToWords(W,null);var U=f.includes[d[1]];if(!U)throw"ShaderCompile error no this include file:"+d[1];if((y=d[0].indexOf("?"))<0){e.setParent(q),W=U.getWith("with"==d[2]?d[3]:null),this._compileToTree(e,W.split("\n"),0,a,w),e.text="";continue;}
e.setCondition(d[0].substr(y+1),1),e.text=U.getWith("with"==d[2]?d[3]:null);break;case"#import":D=(d=f.splitToWords(W,null))[1],a.push({node:e,file:f.includes[D],ofs:e.text.length});continue;}}else{if((F=q.childs[q.childs.length-1])&&!F.name){0<a.length&&f.splitToWords(W,F),v=e,F.text+="\n"+W;continue;}
0<a.length&&f.splitToWords(W,e);}
e.setParent(q);}},Q.withCompile=function(q,Q,m){var a,w,e;if(q&=this._publicValidDefine,Q&=this._spriteValidDefine,m&=this._materialValidDefine,w=this._cacheSharders[q])
if(e=w[Q]){if(a=e[m])return a;}else e=w[Q]=[];else e=(w=this._cacheSharders[q]=[])[Q]=[];var F,W=this._definesToNameDic(q,this._owner._publicDefines),s=this._definesToNameDic(Q,this._owner._spriteDefines),D=this._definesToNameDic(m,this._owner._materialDefines);if(Bq.debugMode){var d="";for(F in W)d+=F+" ";var v="";for(F in s)v+=F+" ";var y="";for(F in D)y+=F+" ";A.shaderHighPrecision||(q+=Bq.SHADERDEFINE_HIGHPRECISION),console.log("%cShader3DDebugMode---(Name:"+this._owner._owner._name+" PassIndex:"+this._owner._passes.indexOf(this)+" PublicDefine:"+q+" SpriteDefine:"+Q+" MaterialDefine:"+m+" PublicDefineGroup:"+d+" SpriteDefineGroup:"+v+"MaterialDefineGroup: "+y+")---ShaderCompile3DDebugMode","color:green");}
var S={},t="";if(W)
for(F in W)t+="#define "+F+"\n",S[F]=!0;if(s)
for(F in s)t+="#define "+F+"\n",S[F]=!0;if(D)
for(F in D)t+="#define "+F+"\n",S[F]=!0;var o=this._VS.toscript(S,[]),b="";0==o[0].indexOf("#version")&&(b=o[0]+"\n",o.shift());var U=this._PS.toscript(S,[]),J="";return 0==U[0].indexOf("#version")&&(J=U[0]+"\n",U.shift()),a=new Rm(b+t+o.join("\n"),J+t+U.join("\n"),this._owner._attributeMap||this._owner._owner._attributeMap,this._owner._uniformMap||this._owner._owner._uniformMap,this),e[m]=a;},d(0,Q,"renderState",function(){return this._renderState;}),s;}(),PQ=function(q){function Q(){Q.__super.call(this);}
S(Q,"laya.d3.core.BufferState",v);var m=Q.prototype;return m.applyVertexBuffer=function(q){if(v._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var Q=J.instance,m=q.vertexDeclaration,a=null;for(var w in a=M.supportWebGLPlusRendering?m._shaderValues._nativeArray:m._shaderValues.getData(),q.bind(),a){var e=parseInt(w),F=a[w];Q.enableVertexAttribArray(e),Q.vertexAttribPointer(e,F[0],F[1],!!F[2],F[3],F[4]);}},m.applyVertexBuffers=function(q){if(v._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";for(var Q=J.instance,m=0,a=q.length;m<a;m++){var w=q[m],e=w.vertexDeclaration,F=null;for(var W in F=M.supportWebGLPlusRendering?e._shaderValues._nativeArray:e._shaderValues.getData(),w.bind(),F){var s=parseInt(W),D=F[W];Q.enableVertexAttribArray(s),Q.vertexAttribPointer(s,D[0],D[1],!!D[2],D[3],D[4]);}}},m.applyInstanceVertexBuffer=function(q){if(E._angleInstancedArrays){if(v._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";var Q=J.instance,m=q.vertexDeclaration,a=null;for(var w in a=M.supportWebGLPlusRendering?m._shaderValues._nativeArray:m._shaderValues.getData(),q.bind(),a){var e=parseInt(w),F=a[w];Q.enableVertexAttribArray(e),Q.vertexAttribPointer(e,F[0],F[1],!!F[2],F[3],F[4]),E._angleInstancedArrays.vertexAttribDivisorANGLE(e,1);}}},m.applyIndexBuffer=function(q){if(v._curBindedBufferState!==this)throw"BufferState: must call bind() function first.";this._bindedIndexBuffer!==q&&(q._bindForVAO(),this._bindedIndexBuffer=q);},Q;}(),XQ=function(m){function d(){this.angle=NaN,this.radius=NaN,this.length=NaN,this.emitType=0,d.__super.call(this),this.angle=25/180*Math.PI,this.radius=1,this.length=5,this.emitType=0,this.randomDirection=!1;}
S(d,"laya.d3.core.particleShuriKen.module.shape.ConeShape",m);var q=d.prototype;return q._getShapeBoundBox=function(q){var Q=this.radius+this.length*Math.sin(this.angle),m=this.length*Math.cos(this.angle),a=q.min;a.x=a.y=-Q,a.z=0;var w=q.max;w.x=w.y=Q,w.z=m;},q._getSpeedBoundBox=function(q){var Q=Math.sin(this.angle),m=q.min;m.x=m.y=-Q,m.z=0;var a=q.max;a.x=a.y=Q,a.z=1;},q.generatePositionAndDirection=function(q,Q,m,a){var w,e=d._tempPositionPoint,F=NaN,W=NaN,s=Math.cos(this.angle),D=Math.sin(this.angle);switch(this.emitType){case 0:m?(m.seed=a[16],_Q._randomPointInsideUnitCircle(d._tempPositionPoint,m),a[16]=m.seed):_Q._randomPointInsideUnitCircle(d._tempPositionPoint),F=e.x,W=e.y,q.x=F*this.radius,q.y=W*this.radius,q.z=0,this.randomDirection?(m?(m.seed=a[17],_Q._randomPointInsideUnitCircle(d._tempDirectionPoint,m),a[17]=m.seed):_Q._randomPointInsideUnitCircle(d._tempDirectionPoint),w=d._tempDirectionPoint,Q.x=w.x*D,Q.y=w.y*D):(Q.x=F*D,Q.y=W*D),Q.z=s;break;case 1:m?(m.seed=a[16],_Q._randomPointUnitCircle(d._tempPositionPoint,m),a[16]=m.seed):_Q._randomPointUnitCircle(d._tempPositionPoint),F=e.x,W=e.y,q.x=F*this.radius,q.y=W*this.radius,q.z=0,this.randomDirection?(m?(m.seed=a[17],_Q._randomPointInsideUnitCircle(d._tempDirectionPoint,m),a[17]=m.seed):_Q._randomPointInsideUnitCircle(d._tempDirectionPoint),w=d._tempDirectionPoint,Q.x=w.x*D,Q.y=w.y*D):(Q.x=F*D,Q.y=W*D),Q.z=s;break;case 2:m?(m.seed=a[16],_Q._randomPointInsideUnitCircle(d._tempPositionPoint,m)):_Q._randomPointInsideUnitCircle(d._tempPositionPoint),F=e.x,W=e.y,q.x=F*this.radius,q.y=W*this.radius,q.z=0,Q.x=F*D,Q.y=W*D,Q.z=s,_q.normalize(Q,Q),m?(_q.scale(Q,this.length*m.getFloat(),Q),a[16]=m.seed):_q.scale(Q,this.length*Math.random(),Q),_q.add(q,Q,q),this.randomDirection&&(m?(m.seed=a[17],_Q._randomPointUnitSphere(Q,m),a[17]=m.seed):_Q._randomPointUnitSphere(Q));break;case 3:m?(m.seed=a[16],_Q._randomPointUnitCircle(d._tempPositionPoint,m)):_Q._randomPointUnitCircle(d._tempPositionPoint),F=e.x,W=e.y,q.x=F*this.radius,q.y=W*this.radius,q.z=0,Q.x=F*D,Q.y=W*D,Q.z=s,_q.normalize(Q,Q),m?(_q.scale(Q,this.length*m.getFloat(),Q),a[16]=m.seed):_q.scale(Q,this.length*Math.random(),Q),_q.add(q,Q,q),this.randomDirection&&(m?(m.seed=a[17],_Q._randomPointUnitSphere(Q,m),a[17]=m.seed):_Q._randomPointUnitSphere(Q));break;default:throw new Error("ConeShape:emitType is invalid.");}},q.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;Q.angle=this.angle,Q.radius=this.radius,Q.length=this.length,Q.emitType=this.emitType,Q.randomDirection=this.randomDirection;},y(d,["_tempPositionPoint",function(){return this._tempPositionPoint=new Zq();},"_tempDirectionPoint",function(){return this._tempDirectionPoint=new Zq();}]),d;}(K),qm=function(q){function Q(q){Q.__super.call(this),void 0===q&&(q=.5),this._radius=q,this._type=1,this._nativeShape=new R._physics3D.btSphereShape(q);}
S(Q,"laya.d3.physics.shape.SphereColliderShape",k);var m=Q.prototype;return m.clone=function(){var q=new Q(this._radius);return this.cloneTo(q),q;},d(0,m,"radius",function(){return this._radius;}),Q;}(),Qm=function(m){function e(){this.radius=NaN,this.arc=NaN,this.emitFromEdge=!1,e.__super.call(this),this.radius=1,this.arc=2*Math.PI,this.emitFromEdge=!1,this.randomDirection=!1;}
S(e,"laya.d3.core.particleShuriKen.module.shape.CircleShape",m);var q=e.prototype;return q._getShapeBoundBox=function(q){var Q=q.min;Q.x=Q.z=-this.radius,Q.y=0;var m=q.max;m.x=m.z=this.radius,m.y=0;},q._getSpeedBoundBox=function(q){var Q=q.min;Q.x=Q.y=-1,Q.z=0;var m=q.max;m.x=m.y=1,m.z=0;},q.generatePositionAndDirection=function(q,Q,m,a){var w=e._tempPositionPoint;m?(m.seed=a[16],this.emitFromEdge?_Q._randomPointUnitArcCircle(this.arc,e._tempPositionPoint,m):_Q._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint,m),a[16]=m.seed):this.emitFromEdge?_Q._randomPointUnitArcCircle(this.arc,e._tempPositionPoint):_Q._randomPointInsideUnitArcCircle(this.arc,e._tempPositionPoint),q.x=-w.x,q.y=w.y,q.z=0,_q.scale(q,this.radius,q),this.randomDirection?m?(m.seed=a[17],_Q._randomPointUnitSphere(Q,m),a[17]=m.seed):_Q._randomPointUnitSphere(Q):q.cloneTo(Q);},q.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;Q.radius=this.radius,Q.arc=this.arc,Q.emitFromEdge=this.emitFromEdge,Q.randomDirection=this.randomDirection;},y(e,["_tempPositionPoint",function(){return this._tempPositionPoint=new Zq();}]),e;}(K),mm=function(q){function F(){this._source=null,this._dest=null,this._shader=null,this._shaderData=null,this._subShader=0,F.__super.call(this);}
S(F,"laya.d3.core.render.command.BlitCMD",h);var Q=F.prototype;return Q.run=function(){this._shaderData.setTexture(sQ.SCREENTEXTURE_ID,this._source);var q=this._dest;q&&q._start();for(var Q=this._shader.getSubShaderAt(this._subShader)._passes,m=0,a=Q.length;m<a;m++){var w=Q[m].withCompile(0,0,0);w.bind(),this._shaderData&&w.uploadUniforms(w._materialUniformParamsMap,this._shaderData,!0),w.uploadRenderStateBlendDepth(this._shaderData),w.uploadRenderStateFrontFace(this._shaderData,!0,null),xm.instance.render();}
q&&q._end();},Q.recover=function(){F._pool.push(this),this._dest=null,this._shader=null,this._shaderData=null;},F.create=function(q,Q,m,a,w){var e;return void 0===w&&(w=0),(e=0<F._pool.length?F._pool.pop():new F())._source=q,e._dest=Q,e._shader=m,e._shaderData=a,e._subShader=w,e;},F._pool=[],F;}(),am=function(q){function Q(){Q.__super.call(this);}
S(Q,"laya.d3.CastShadowList",g);var m=Q.prototype;return m.add=function(q){if(-1!==q._indexInCastShadowList)throw"CastShadowList:element has  in  CastShadowList.";this._add(q),q._indexInCastShadowList=this.length++;},m.remove=function(q){var Q=q._indexInCastShadowList;if(this.length--,Q!==this.length){var m=this.elements[this.length];(this.elements[Q]=m)._indexInCastShadowList=Q;}
q._indexInCastShadowList=-1;},Q;}(),wm=function(m){function a(q,Q,m){switch(a.__super.call(this),void 0===q&&(q=.5),void 0===Q&&(Q=1.25),void 0===m&&(m=1),this._radius=q,this._length=Q,this._orientation=m,this._type=3,m){case 0:this._nativeShape=new R._physics3D.btCapsuleShapeX(q,Q-2*q);break;case 1:this._nativeShape=new R._physics3D.btCapsuleShape(q,Q-2*q);break;case 2:this._nativeShape=new R._physics3D.btCapsuleShapeZ(q,Q-2*q);break;default:throw"CapsuleColliderShape:unknown orientation.";}}
S(a,"laya.d3.physics.shape.CapsuleColliderShape",m);var q=a.prototype;return q._setScale=function(q){var Q=a._tempVector30;switch(this.orientation){case 0:Q.x=q.x,Q.y=Q.z=Math.max(q.y,q.z);break;case 1:Q.y=q.y,Q.x=Q.z=Math.max(q.x,q.z);break;case 2:Q.z=q.z,Q.x=Q.y=Math.max(q.x,q.y);break;default:throw"CapsuleColliderShape:unknown orientation.";}
m.prototype._setScale.call(this,Q);},q.clone=function(){var q=new a(this._radius,this._length,this._orientation);return this.cloneTo(q),q;},d(0,q,"radius",function(){return this._radius;}),d(0,q,"length",function(){return this._length;}),d(0,q,"orientation",function(){return this._orientation;}),y(a,["_tempVector30",function(){return this._tempVector30=new _q();}]),a;}(k),em=function(q){function Q(q){this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null,this._indexInMesh=0,this._vertexStart=0,this._indexStart=0,this._indexCount=0,this._indices=null,this._vertexBuffer=null,this._indexBuffer=null,this._id=0,Q.__super.call(this),this._id=++Q._uniqueIDCounter,this._mesh=q,this._boneIndicesList=[],this._subIndexBufferStart=[],this._subIndexBufferCount=[];}
S(Q,"laya.d3.resource.models.SubMesh",q);var m=Q.prototype;return m._getType=function(){return Q._type;},m._render=function(q){this._mesh._bufferState.bind();var Q=q.renderElement.render._skinnedData;if(Q)
for(var m=Q[this._indexInMesh],a=this._boneIndicesList.length,w=0;w<a;w++)q.shader.uploadCustomUniform(la.BONES,m[w]),J.instance.drawElements(4,this._subIndexBufferCount[w],5123,2*this._subIndexBufferStart[w]);else J.instance.drawElements(4,this._indexCount,5123,2*this._indexStart);r.trianglesFaces+=this._indexCount/3,r.renderBatches++;},m.getIndices=function(){return this._indices;},m.destroy=function(){this._destroyed||(q.prototype.destroy.call(this),this._indexBuffer.destroy(),this._indexBuffer=null,this._mesh=null,this._boneIndicesList=null,this._subIndexBufferStart=null,this._subIndexBufferCount=null,this._skinAnimationDatas=null);},Q._uniqueIDCounter=0,y(Q,["_type",function(){return this._type=P._typeCounter++;}]),Q;}(P),Fm=function(Q){function $(q){$.__super.call(this),this._tempRotationMatrix=new kQ(),this._uvLength=new Zq(),this._bufferState=new PQ(),this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._owner=q,this._ownerRender=q.particleRenderer,this._boundingBoxCorners=N(8,null),this._boundingSphere=new Jq(new _q(),Number.MAX_VALUE),this._boundingBox=new GQ(new _q(-Number.MAX_VALUE,-Number.MAX_VALUE,-Number.MAX_VALUE),new _q(Number.MAX_VALUE,Number.MAX_VALUE,Number.MAX_VALUE)),this._currentTime=0,this._isEmitting=!1,this._isPlaying=!1,this._isPaused=!1,this._burstsIndex=0,this._frameRateTime=0,this._emissionTime=0,this._totalDelayTime=0,this._simulateUpdate=!1,this._bufferMaxParticles=1,this.duration=5,this.looping=!0,this.prewarm=!1,this.startDelayType=0,this.startDelay=0,this.startDelayMin=0,this.startDelayMax=0,this._startLifetimeType=0,this._startLifetimeConstant=5,this._startLifeTimeGradient=new zq(),this._startLifetimeConstantMin=0,this._startLifetimeConstantMax=5,this._startLifeTimeGradientMin=new zq(),this._startLifeTimeGradientMax=new zq(),this._maxStartLifetime=5,this.startSpeedType=0,this.startSpeedConstant=5,this.startSpeedConstantMin=0,this.startSpeedConstantMax=5,this.threeDStartSize=!1,this.startSizeType=0,this.startSizeConstant=1,this.startSizeConstantSeparate=new _q(1,1,1),this.startSizeConstantMin=0,this.startSizeConstantMax=1,this.startSizeConstantMinSeparate=new _q(0,0,0),this.startSizeConstantMaxSeparate=new _q(1,1,1),this.threeDStartRotation=!1,this.startRotationType=0,this.startRotationConstant=0,this.startRotationConstantSeparate=new _q(0,0,0),this.startRotationConstantMin=0,this.startRotationConstantMax=0,this.startRotationConstantMinSeparate=new _q(0,0,0),this.startRotationConstantMaxSeparate=new _q(0,0,0),this.randomizeRotationDirection=0,this.startColorType=0,this.startColorConstant=new rq(1,1,1,1),this.startColorConstantMin=new rq(1,1,1,1),this.startColorConstantMax=new rq(1,1,1,1),this.gravityModifier=0,this.simulationSpace=1,this.scaleMode=0,this.playOnAwake=!0,this._rand=new lq(0),this.autoRandomSeed=!0,this.randomSeed=new Uint32Array(1),this._randomSeeds=new Uint32Array($._RANDOMOFFSET.length),this.isPerformanceMode=!0,this._emission=new Uq(),this._emission.enbale=!0;}
S($,"laya.d3.core.particleShuriKen.ShurikenParticleSystem",Q);var q=$.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q._getVertexBuffer=function(q){return void 0===q&&(q=0),0===q?this._vertexBuffer:null;},q._getIndexBuffer=function(){return this._indexBuffer;},q._generateBoundingSphere=function(){var q=this._boundingSphere.center;q.x=0,q.y=0,q.z=0,this._boundingSphere.radius=Number.MAX_VALUE;},q._generateBoundingBox=function(){var q=this._owner.particleRenderer,Q=this._boundingBox.min,m=this._boundingBox.max,a=0,w=0,e=NaN;switch(this.startLifetimeType){case 0:e=this.startLifetimeConstant;break;case 1:e=-Number.MAX_VALUE;var F=F;for(a=0,w=F.gradientCount;a<w;a++)e=Math.max(e,F.getValueByIndex(a));break;case 2:e=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:e=-Number.MAX_VALUE;var W=W;for(a=0,w=W.gradientCount;a<w;a++)e=Math.max(e,W.getValueByIndex(a));var s=s;for(a=0,w=s.gradientCount;a<w;a++)e=Math.max(e,s.getValueByIndex(a));}
var D,d,v,y,S=NaN,t=NaN;switch(this.startSpeedType){case 0:S=t=this.startSpeedConstant;break;case 1:break;case 2:S=this.startLifetimeConstantMin,t=this.startLifetimeConstantMax;}
this._shape&&this._shape.enable||(D=d=_q._ZERO,v=_q._ZERO,y=_q._UnitZ);var o,b,U=new _q(v.x*S,v.y*S,v.z*S),J=new _q(y.x*t,y.y*t,y.z*t);if(this._velocityOverLifetime&&this._velocityOverLifetime.enbale){var V=this._velocityOverLifetime.velocity;switch(V.type){case 0:V.constant;break;case 1:new _q(V.gradientX.getAverageValue(),V.gradientY.getAverageValue(),V.gradientZ.getAverageValue());break;case 2:V.constantMin,V.constantMax;break;case 3:new _q(V.gradientXMin.getAverageValue(),V.gradientYMin.getAverageValue(),V.gradientZMin.getAverageValue()),new _q(V.gradientXMax.getAverageValue(),V.gradientYMax.getAverageValue(),V.gradientZMax.getAverageValue());}}
var n,O,C=this._owner.transform,l=C.position,u=$._tempVector39,f=q.renderMode;switch(this.scaleMode){case 0:var p=C.scale;o=p,u.x=p.x,u.y=p.z,u.z=p.y,1===f&&(b=p);break;case 1:var T=C.localScale;o=T,u.x=T.x,u.y=T.z,u.z=T.y,1===f&&(b=T);break;case 2:o=C.scale,u.x=u.y=u.z=1,1===f&&(b=_q._ONE);}
switch(this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(n=new _q(U.x*e,U.y*e,U.z*e),O=new _q(J.x*e,J.y*e,J.z*e),2!=this.scaleMode?(_q.add(D,n,Q),_q.multiply(o,Q,Q),_q.add(d,O,m),_q.multiply(o,m,m)):(_q.multiply(o,D,Q),_q.add(Q,n,Q),_q.multiply(o,d,m),_q.add(m,O,m))),this.simulationSpace){case 0:break;case 1:_q.add(Q,l,Q),_q.add(m,l,m);}
var c=NaN,r=NaN;switch(this.startSizeType){case 0:if(this.threeDStartSize){var _=_;c=Math.max(_.x,_.y),1===f&&(r=_.y);}else c=this.startSizeConstant,1===f&&(r=this.startSizeConstant);break;case 1:break;case 2:if(this.threeDStartSize){var Z=Z;c=Math.max(Z.x,Z.y),1===f&&(r=Z.y);}else c=this.startSizeConstantMax,1===f&&(r=this.startSizeConstantMax);}
if(this._sizeOverLifetime&&this._sizeOverLifetime.enbale){this._sizeOverLifetime.size;c*=this._sizeOverLifetime.size.getMaxSizeInGradient();}
var A=$._tempVector30,E=NaN,B=NaN;switch(f){case 0:E=c*$.halfKSqrtOf2,_q.scale(u,c,A),_q.subtract(Q,A,Q),_q.add(m,A,m);break;case 1:var N=$._tempVector31,M=$._tempVector32,Y=$._tempVector33,x=$._tempVector34;this._velocityOverLifetime&&this._velocityOverLifetime.enbale||(_q.multiply(b,J,M),_q.multiply(b,U,Y));var L=r*q.stretchedBillboardLengthScale,G=_q.scalarLength(M)*q.stretchedBillboardSpeedScale+L,K=_q.scalarLength(Y)*q.stretchedBillboardSpeedScale+L,k=$._tempVector35,R=$._tempVector36;_q.normalize(M,k),_q.scale(k,G,x),_q.subtract(O,x,x),_q.normalize(Y,R),_q.scale(R,K,N),_q.add(n,N,N),E=c*$.halfKSqrtOf2,_q.scale(u,E,A);var z=$._tempVector37,i=$._tempVector38;_q.scale(k,.5,z),_q.scale(R,.5,i),_q.multiply(z,u,z),_q.multiply(i,u,i),_q.add(Q,i,Q),_q.min(Q,x,Q),_q.subtract(Q,A,Q),_q.subtract(m,z,m),_q.max(m,N,m),_q.add(m,A,m);break;case 2:B=.5*(c*=Math.cos(.7853981633974483)),A.x=u.x*B,A.y=u.z*B,_q.subtract(Q,A,Q),_q.add(m,A,m);break;case 3:B=.5*(c*=Math.cos(.7853981633974483)),_q.scale(u,B,A),_q.subtract(Q,A,Q),_q.add(m,A,m);}
this._boundingBox.getCorners(this._boundingBoxCorners);},q._updateEmission=function(){if(this.isAlive)
if(this._simulateUpdate)this._simulateUpdate=!1;else{var q=this._startUpdateLoopCount===r.loopCount||this._isPaused?0:this._owner._scene.timer._delta/1e3;q=Math.min($._maxElapsedTime,q),this._updateParticles(q);}},q._updateParticles=function(q){(4!==this._ownerRender.renderMode||this._ownerRender.mesh)&&(this._currentTime+=q,this._retireActiveParticles(),this._freeRetiredParticles(),this._totalDelayTime+=q,this._totalDelayTime<this._playStartDelay||this._emission.enbale&&this._isEmitting&&!this._isPaused&&this._advanceTime(q,this._currentTime));},q._updateParticlesSimulationRestart=function(q){this._firstActiveElement=0,this._firstNewElement=0,this._firstFreeElement=0,this._firstRetiredElement=0,this._burstsIndex=0,this._frameRateTime=q,this._emissionTime=0,this._totalDelayTime=0;var Q=this._currentTime=q;Q<this._playStartDelay?this._totalDelayTime=Q:this._emission.enbale&&this._advanceTime(q,q);},q._retireActiveParticles=function(){for(;this._firstActiveElement!=this._firstNewElement;){var q=this._firstActiveElement*this._floatCountPerVertex*this._vertexStride,Q=q+this._timeIndex;if(this._currentTime-this._vertices[Q]+1e-4<this._vertices[q+this._startLifeTimeIndex])break;this._vertices[Q]=this._drawCounter,this._firstActiveElement++,this._firstActiveElement>=this._bufferMaxParticles&&(this._firstActiveElement=0);}},q._freeRetiredParticles=function(){for(;this._firstRetiredElement!=this._firstActiveElement;){var q=this._drawCounter-this._vertices[this._firstRetiredElement*this._floatCountPerVertex*this._vertexStride+this._timeIndex];if(this.isPerformanceMode&&q<3)break;this._firstRetiredElement++,this._firstRetiredElement>=this._bufferMaxParticles&&(this._firstRetiredElement=0);}},q._burst=function(q,Q){for(var m=0,a=this._emission._bursts,w=a.length;this._burstsIndex<w;this._burstsIndex++){var e=a[this._burstsIndex],F=e.time;if(!(q<=F&&F<Q))break;var W=0;this.autoRandomSeed?W=G.lerp(e.minCount,e.maxCount,Math.random()):(this._rand.seed=this._randomSeeds[0],W=G.lerp(e.minCount,e.maxCount,this._rand.getFloat()),this._randomSeeds[0]=this._rand.seed),m+=W;}
return m;},q._advanceTime=function(q,Q){var m=0,a=this._emissionTime;this._emissionTime+=q;var w=0;if(this._emissionTime>this.duration){if(!this.looping){for(w=Math.min(this.maxParticles-this.aliveParticleCount,w),m=0;m<w;m++)this.emit(Q);return this._isPlaying=!1,void this.stop();}
w+=this._burst(a,this._emissionTime),this._emissionTime-=this.duration,this._burstsIndex=0,w+=this._burst(0,this._emissionTime);}else w+=this._burst(a,this._emissionTime);for(w=Math.min(this.maxParticles-this.aliveParticleCount,w),m=0;m<w;m++)this.emit(Q);var e=this.emission.emissionRate;if(0<e){var F=1/e;for(this._frameRateTime+=F,this._frameRateTime=this._currentTime-(this._currentTime-this._frameRateTime)%this._maxStartLifetime;this._frameRateTime<=Q&&this.emit(this._frameRateTime);)this._frameRateTime+=F;this._frameRateTime=Math.floor(Q/F)*F;}},q._initBufferDatas=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy());var q=this._ownerRender,Q=q.renderMode;if(-1!==Q&&0<this.maxParticles){var m,a,w=0,e=0,F=0,W=0,s=0,D=0,d=0,v=q.mesh;if(4===Q){if(v){if(1<v._vertexBuffers.length)throw new Error("ShurikenParticleSystem: submesh Count mesh be One or all subMeshes have the same vertexDeclaration.");a=Nm.vertexDeclaration,this._floatCountPerVertex=a.vertexStride/4,this._startLifeTimeIndex=12,this._timeIndex=16,this._vertexStride=v._vertexBuffers[0].vertexCount;var y=this._bufferMaxParticles*this._vertexStride,S=y%65535;if(1<Math.floor(y/65535)+1)throw new Error("ShurikenParticleSystem:the maxParticleCount multiply mesh vertexCount is large than 65535.");D=a.vertexStride*S,this._vertexBuffer=new HQ(D,35048),this._vertexBuffer.vertexDeclaration=a,this._vertices=new Float32Array(this._floatCountPerVertex*S),this._indexStride=v._indexBuffer.indexCount;var t=v._indexBuffer.getData(),o=this._bufferMaxParticles*this._indexStride;for(this._indexBuffer=new gQ("ushort",o,35044),m=new Uint16Array(o),d=D+2*o,w=W=0;w<this._bufferMaxParticles;w++){var b=w*this._vertexStride;for(e=0,F=t.length;e<F;e++)m[W++]=b+t[e];}
this._indexBuffer.setData(m),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind();}}else{for(a=Bm.vertexDeclaration,this._floatCountPerVertex=a.vertexStride/4,this._startLifeTimeIndex=7,this._timeIndex=11,this._vertexStride=4,D=a.vertexStride*this._bufferMaxParticles*this._vertexStride,this._vertexBuffer=new HQ(D,35048),this._vertexBuffer.vertexDeclaration=a,this._vertices=new Float32Array(this._floatCountPerVertex*this._bufferMaxParticles*this._vertexStride),w=0;w<this._bufferMaxParticles;w++)s=w*this._floatCountPerVertex*this._vertexStride,this._vertices[s]=-.5,this._vertices[s+1]=-.5,this._vertices[s+2]=0,this._vertices[s+3]=1,s+=this._floatCountPerVertex,this._vertices[s]=.5,this._vertices[s+1]=-.5,this._vertices[s+2]=1,this._vertices[s+3]=1,s+=this._floatCountPerVertex,this._vertices[s]=.5,this._vertices[s+1]=.5,this._vertices[s+2]=1,this._vertices[s+3]=0,s+=this._floatCountPerVertex,this._vertices[s]=-.5,this._vertices[s+1]=.5,this._vertices[s+2]=0,this._vertices[s+3]=0;for(this._indexStride=6,this._indexBuffer=new gQ("ushort",6*this._bufferMaxParticles,35044),m=new Uint16Array(6*this._bufferMaxParticles),w=0;w<this._bufferMaxParticles;w++){W=6*w;var U=w*this._vertexStride,J=U+2;m[W++]=U,m[W++]=J,m[W++]=U+1,m[W++]=U,m[W++]=U+3,m[W++]=J;}
this._indexBuffer.setData(m),d=D+6*this._bufferMaxParticles*2,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind();}
u._addMemory(d,d);}},q.destroy=function(){Q.prototype.destroy.call(this);var q=this._vertexBuffer._byteLength+2*this._indexBuffer.indexCount;u._addMemory(-q,-q),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._emission.destroy(),this._bufferState=null,this._vertexBuffer=null,this._indexBuffer=null,this._owner=null,this._vertices=null,this._indexBuffer=null,this._emission=null,this._shape=null,this.startLifeTimeGradient=null,this.startLifeTimeGradientMin=null,this.startLifeTimeGradientMax=null,this.startSizeConstantSeparate=null,this.startSizeConstantMinSeparate=null,this.startSizeConstantMaxSeparate=null,this.startRotationConstantSeparate=null,this.startRotationConstantMinSeparate=null,this.startRotationConstantMaxSeparate=null,this.startColorConstant=null,this.startColorConstantMin=null,this.startColorConstantMax=null,this._velocityOverLifetime=null,this._colorOverLifetime=null,this._sizeOverLifetime=null,this._rotationOverLifetime=null,this._textureSheetAnimation=null;},q.emit=function(q){var Q=$._tempPosition,m=$._tempDirection;return this._shape&&this._shape.enable?this.autoRandomSeed?this._shape.generatePositionAndDirection(Q,m):this._shape.generatePositionAndDirection(Q,m,this._rand,this._randomSeeds):(Q.x=Q.y=Q.z=0,m.x=m.y=0,m.z=1),this.addParticle(Q,m,q);},q.addParticle=function(q,Q,m){_q.normalize(Q,Q);var a=this._firstFreeElement+1;if(a>=this._bufferMaxParticles&&(a=0),a===this._firstRetiredElement)return!1;if(hq.create(this,this._ownerRender,this._owner.transform),this._currentTime-m>=hq.startLifeTime)return!0;var w=NaN,e=NaN,F=NaN,W=NaN,s=NaN,D=NaN,d=NaN,v=this._velocityOverLifetime&&this._velocityOverLifetime.enbale;if(v){var y=this._velocityOverLifetime.velocity.type;2===y||3===y?this.autoRandomSeed?(w=Math.random(),e=Math.random(),F=Math.random()):(this._rand.seed=this._randomSeeds[9],w=this._rand.getFloat(),e=this._rand.getFloat(),F=this._rand.getFloat(),this._randomSeeds[9]=this._rand.seed):v=!1;}else v=!1;var S=this._colorOverLifetime&&this._colorOverLifetime.enbale;S?3===this._colorOverLifetime.color.type?this.autoRandomSeed?W=Math.random():(this._rand.seed=this._randomSeeds[10],W=this._rand.getFloat(),this._randomSeeds[10]=this._rand.seed):S=!1:S=!1;var t=this._sizeOverLifetime&&this._sizeOverLifetime.enbale;t?3===this._sizeOverLifetime.size.type?this.autoRandomSeed?s=Math.random():(this._rand.seed=this._randomSeeds[11],s=this._rand.getFloat(),this._randomSeeds[11]=this._rand.seed):t=!1:t=!1;var o=this._rotationOverLifetime&&this._rotationOverLifetime.enbale;if(o){var b=this._rotationOverLifetime.angularVelocity.type;2===b||3===b?this.autoRandomSeed?D=Math.random():(this._rand.seed=this._randomSeeds[12],D=this._rand.getFloat(),this._randomSeeds[12]=this._rand.seed):o=!1;}else o=!1;var U=this._textureSheetAnimation&&this._textureSheetAnimation.enable;U?3===this._textureSheetAnimation.frame.type?this.autoRandomSeed?d=Math.random():(this._rand.seed=this._randomSeeds[15],d=this._rand.getFloat(),this._randomSeeds[15]=this._rand.seed):U=!1:U=!1;var J,V=this._firstFreeElement*this._floatCountPerVertex*this._vertexStride,n=hq.startUVInfo[0],O=hq.startUVInfo[1],C=hq.startUVInfo[2],l=hq.startUVInfo[3],u=0,f=0,p=0,T=0,c=0,r=this._ownerRender;if(4===r.renderMode){var _=r.mesh._vertexBuffers[0];J=_.getData();var Z=_.vertexDeclaration;f=Z.getVertexElementByUsage(0).offset/4;var A=Z.getVertexElementByUsage(1);p=A?A.offset/4:-1;var E=Z.getVertexElementByUsage(2);T=E?E.offset/4:-1,u=Z.vertexStride/4,c=0;}else{this._vertices[V+2]=C,this._vertices[V+3]=l+O;var B=V+this._floatCountPerVertex;this._vertices[B+2]=C+n,this._vertices[B+3]=l+O;var N=B+this._floatCountPerVertex;this._vertices[N+2]=C+n,this._vertices[N+3]=l;var M=N+this._floatCountPerVertex;this._vertices[M+2]=C,this._vertices[M+3]=l;}
for(var Y=V,x=V+this._floatCountPerVertex*this._vertexStride;Y<x;Y+=this._floatCountPerVertex){var L=0;if(4===r.renderMode){L=Y;var G=u*c++,K=G+f;this._vertices[L++]=J[K++],this._vertices[L++]=J[K++],this._vertices[L++]=J[K],this._vertices[L++]=-1===p?(this._vertices[L++]=1,this._vertices[L++]=1,this._vertices[L++]=1):(K=G+p,this._vertices[L++]=J[K++],this._vertices[L++]=J[K++],this._vertices[L++]=J[K++],J[K]),this._vertices[L++]=-1===T?this._vertices[L++]=0:(K=G+T,this._vertices[L++]=C+J[K++]*n,l+J[K]*O);}else L=Y+4;switch(this._vertices[L++]=q.x,this._vertices[L++]=q.y,this._vertices[L++]=q.z,this._vertices[L++]=hq.startLifeTime,this._vertices[L++]=Q.x,this._vertices[L++]=Q.y,this._vertices[L++]=Q.z,this._vertices[L++]=m,this._vertices[L++]=hq.startColor.x,this._vertices[L++]=hq.startColor.y,this._vertices[L++]=hq.startColor.z,this._vertices[L++]=hq.startColor.w,this._vertices[L++]=hq.startSize[0],this._vertices[L++]=hq.startSize[1],this._vertices[L++]=hq.startSize[2],this._vertices[L++]=hq.startRotation[0],this._vertices[L++]=hq.startRotation[1],this._vertices[L++]=hq.startRotation[2],this._vertices[L++]=hq.startSpeed,S&&(this._vertices[L+1]=W),t&&(this._vertices[L+2]=s),o&&(this._vertices[L+3]=D),U&&(this._vertices[L+4]=d),v&&(this._vertices[L+5]=w,this._vertices[L+6]=e,this._vertices[L+7]=F),this.simulationSpace){case 0:L+=8,this._vertices[L++]=hq.simulationWorldPostion[0],this._vertices[L++]=hq.simulationWorldPostion[1],this._vertices[L++]=hq.simulationWorldPostion[2],this._vertices[L++]=hq.simulationWorldRotation[0],this._vertices[L++]=hq.simulationWorldRotation[1],this._vertices[L++]=hq.simulationWorldRotation[2],this._vertices[L++]=hq.simulationWorldRotation[3];break;case 1:break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.");}}
return this._firstFreeElement=a,!0;},q.addNewParticlesToVertexBuffer=function(){var q=0;this._firstNewElement<this._firstFreeElement?(q=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,q,q,(this._firstFreeElement-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex)):(q=this._firstNewElement*this._vertexStride*this._floatCountPerVertex,this._vertexBuffer.setData(this._vertices,q,q,(this._bufferMaxParticles-this._firstNewElement)*this._vertexStride*this._floatCountPerVertex),0<this._firstFreeElement&&this._vertexBuffer.setData(this._vertices,0,0,this._firstFreeElement*this._vertexStride*this._floatCountPerVertex)),this._firstNewElement=this._firstFreeElement;},q._getType=function(){return $._type;},q._prepareRender=function(q){return this._updateEmission(),this._firstNewElement!=this._firstFreeElement&&this.addNewParticlesToVertexBuffer(),this._drawCounter++,this._firstActiveElement!=this._firstFreeElement;},q._render=function(q){this._bufferState.bind();var Q=0,m=J.instance;this._firstActiveElement<this._firstFreeElement?(Q=(this._firstFreeElement-this._firstActiveElement)*this._indexStride,m.drawElements(4,Q,5123,2*this._firstActiveElement*this._indexStride),r.trianglesFaces+=Q/3,r.renderBatches++):(Q=(this._bufferMaxParticles-this._firstActiveElement)*this._indexStride,m.drawElements(4,Q,5123,2*this._firstActiveElement*this._indexStride),r.trianglesFaces+=Q/3,r.renderBatches++,0<this._firstFreeElement&&(Q=this._firstFreeElement*this._indexStride,m.drawElements(4,Q,5123,0),r.trianglesFaces+=Q/3,r.renderBatches++));},q.play=function(){if(this._burstsIndex=0,this._isEmitting=!0,this._isPlaying=!0,this._isPaused=!1,this._emissionTime=0,this._totalDelayTime=0,!this.autoRandomSeed)
for(var q=0,Q=this._randomSeeds.length;q<Q;q++)this._randomSeeds[q]=this.randomSeed[0]+$._RANDOMOFFSET[q];switch(this.startDelayType){case 0:this._playStartDelay=this.startDelay;break;case 1:this.autoRandomSeed?this._playStartDelay=G.lerp(this.startDelayMin,this.startDelayMax,Math.random()):(this._rand.seed=this._randomSeeds[2],this._playStartDelay=G.lerp(this.startDelayMin,this.startDelayMax,this._rand.getFloat()),this._randomSeeds[2]=this._rand.seed);break;default:throw new Error("Utils3D: startDelayType is invalid.");}
this._frameRateTime=this._currentTime+this._playStartDelay,this._startUpdateLoopCount=r.loopCount;},q.pause=function(){this._isPaused=!0;},q.simulate=function(q,Q){void 0===Q&&(Q=!0),this._simulateUpdate=!0,Q?this._updateParticlesSimulationRestart(q):(this._isPaused=!1,this._updateParticles(q)),this.pause();},q.stop=function(){this._burstsIndex=0,this._isEmitting=!1,this._emissionTime=0;},q.cloneTo=function(q){var Q=q;Q.duration=this.duration,Q.looping=this.looping,Q.prewarm=this.prewarm,Q.startDelayType=this.startDelayType,Q.startDelay=this.startDelay,Q.startDelayMin=this.startDelayMin,Q.startDelayMax=this.startDelayMax,Q._maxStartLifetime=this._maxStartLifetime,Q.startLifetimeType=this.startLifetimeType,Q.startLifetimeConstant=this.startLifetimeConstant,this.startLifeTimeGradient.cloneTo(Q.startLifeTimeGradient),Q.startLifetimeConstantMin=this.startLifetimeConstantMin,Q.startLifetimeConstantMax=this.startLifetimeConstantMax,this.startLifeTimeGradientMin.cloneTo(Q.startLifeTimeGradientMin),this.startLifeTimeGradientMax.cloneTo(Q.startLifeTimeGradientMax),Q.startSpeedType=this.startSpeedType,Q.startSpeedConstant=this.startSpeedConstant,Q.startSpeedConstantMin=this.startSpeedConstantMin,Q.startSpeedConstantMax=this.startSpeedConstantMax,Q.threeDStartSize=this.threeDStartSize,Q.startSizeType=this.startSizeType,Q.startSizeConstant=this.startSizeConstant,this.startSizeConstantSeparate.cloneTo(Q.startSizeConstantSeparate),Q.startSizeConstantMin=this.startSizeConstantMin,Q.startSizeConstantMax=this.startSizeConstantMax,this.startSizeConstantMinSeparate.cloneTo(Q.startSizeConstantMinSeparate),this.startSizeConstantMaxSeparate.cloneTo(Q.startSizeConstantMaxSeparate),Q.threeDStartRotation=this.threeDStartRotation,Q.startRotationType=this.startRotationType,Q.startRotationConstant=this.startRotationConstant,this.startRotationConstantSeparate.cloneTo(Q.startRotationConstantSeparate),Q.startRotationConstantMin=this.startRotationConstantMin,Q.startRotationConstantMax=this.startRotationConstantMax,this.startRotationConstantMinSeparate.cloneTo(Q.startRotationConstantMinSeparate),this.startRotationConstantMaxSeparate.cloneTo(Q.startRotationConstantMaxSeparate),Q.randomizeRotationDirection=this.randomizeRotationDirection,Q.startColorType=this.startColorType,this.startColorConstant.cloneTo(Q.startColorConstant),this.startColorConstantMin.cloneTo(Q.startColorConstantMin),this.startColorConstantMax.cloneTo(Q.startColorConstantMax),Q.gravityModifier=this.gravityModifier,Q.simulationSpace=this.simulationSpace,Q.scaleMode=this.scaleMode,Q.playOnAwake=this.playOnAwake,Q.maxParticles=this.maxParticles,this._emission&&(Q._emission=this._emission.clone()),this.shape&&(Q.shape=this.shape.clone()),this.velocityOverLifetime&&(Q.velocityOverLifetime=this.velocityOverLifetime.clone()),this.colorOverLifetime&&(Q.colorOverLifetime=this.colorOverLifetime.clone()),this.sizeOverLifetime&&(Q.sizeOverLifetime=this.sizeOverLifetime.clone()),this.rotationOverLifetime&&(Q.rotationOverLifetime=this.rotationOverLifetime.clone()),this.textureSheetAnimation&&(Q.textureSheetAnimation=this.textureSheetAnimation.clone()),Q.isPerformanceMode=this.isPerformanceMode,Q._isEmitting=this._isEmitting,Q._isPlaying=this._isPlaying,Q._isPaused=this._isPaused,Q._playStartDelay=this._playStartDelay,Q._frameRateTime=this._frameRateTime,Q._emissionTime=this._emissionTime,Q._totalDelayTime=this._totalDelayTime,Q._burstsIndex=this._burstsIndex;},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,q,"maxParticles",function(){return this._bufferMaxParticles-1;},function(q){var Q=q+1;Q!==this._bufferMaxParticles&&(this._bufferMaxParticles=Q,this._initBufferDatas());}),d(0,q,"isEmitting",function(){return this._isEmitting;}),d(0,q,"isAlive",function(){return!!(this._isPlaying||0<this.aliveParticleCount);}),d(0,q,"shape",function(){return this._shape;},function(q){this._shape!==q&&(q&&q.enable?this._owner._render._defineDatas.add(Oa.SHADERDEFINE_SHAPE):this._owner._render._defineDatas.remove(Oa.SHADERDEFINE_SHAPE),this._shape=q);}),d(0,q,"rotationOverLifetime",function(){return this._rotationOverLifetime;},function(q){var Q=this._owner._render._defineDatas,m=this._owner._render._shaderValues;if(q){var a=q.angularVelocity;if(!a)return;var w=a.separateAxes,e=a.type;if(q.enbale)switch(w?Q.add(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE):Q.add(Oa.SHADERDEFINE_ROTATIONOVERLIFETIME),e){case 0:Q.add(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT);break;case 1:Q.add(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE);break;case 2:Q.add(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS);break;case 3:Q.add(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);}else Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIME),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES);switch(e){case 0:w?m.setVector3(Oa.ROLANGULARVELOCITYCONSTSEPRARATE,a.constantSeparate):m.setNumber(Oa.ROLANGULARVELOCITYCONST,a.constant);break;case 1:w?(m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTX,a.gradientX._elements),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTY,a.gradientY._elements),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTZ,a.gradientZ._elements)):m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENT,a.gradient._elements);break;case 2:w?(m.setVector3(Oa.ROLANGULARVELOCITYCONSTSEPRARATE,a.constantMinSeparate),m.setVector3(Oa.ROLANGULARVELOCITYCONSTMAXSEPRARATE,a.constantMaxSeparate)):(m.setNumber(Oa.ROLANGULARVELOCITYCONST,a.constantMin),m.setNumber(Oa.ROLANGULARVELOCITYCONSTMAX,a.constantMax));break;case 3:w?(m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTX,a.gradientXMin._elements),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTXMAX,a.gradientXMax._elements),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTY,a.gradientYMin._elements),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTYMAX,a.gradientYMax._elements),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTZ,a.gradientZMin._elements),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTZMAX,a.gradientZMax._elements)):(m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENT,a.gradientMin._elements),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTMAX,a.gradientMax._elements));}}else Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIME),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS),Q.remove(Oa.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES),m.setVector(Oa.ROLANGULARVELOCITYCONSTSEPRARATE,null),m.setVector(Oa.ROLANGULARVELOCITYCONSTMAXSEPRARATE,null),m.setNumber(Oa.ROLANGULARVELOCITYCONST,void 0),m.setNumber(Oa.ROLANGULARVELOCITYCONSTMAX,void 0),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTX,null),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTXMAX,null),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTY,null),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTYMAX,null),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTZ,null),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTZMAX,null),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTWMAX,null),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENT,null),m.setBuffer(Oa.ROLANGULARVELOCITYGRADIENTMAX,null);this._rotationOverLifetime=q;}),d(0,q,"emission",function(){return this._emission;}),d(0,q,"emissionTime",function(){return this._emissionTime>this.duration?this.duration:this._emissionTime;}),d(0,q,"aliveParticleCount",function(){return this._firstNewElement>=this._firstRetiredElement?this._firstNewElement-this._firstRetiredElement:this._bufferMaxParticles-this._firstRetiredElement+this._firstNewElement;}),d(0,q,"isPlaying",function(){return this._isPlaying;}),d(0,q,"isPaused",function(){return this._isPaused;}),d(0,q,"startLifetimeType",function(){return this._startLifetimeType;},function(q){var Q=0,m=0;switch(this.startLifetimeType){case 0:this._maxStartLifetime=this.startLifetimeConstant;break;case 1:this._maxStartLifetime=-Number.MAX_VALUE;var a=a;for(Q=0,m=a.gradientCount;Q<m;Q++)this._maxStartLifetime=Math.max(this._maxStartLifetime,a.getValueByIndex(Q));break;case 2:this._maxStartLifetime=Math.max(this.startLifetimeConstantMin,this.startLifetimeConstantMax);break;case 3:this._maxStartLifetime=-Number.MAX_VALUE;var w=w;for(Q=0,m=w.gradientCount;Q<m;Q++)this._maxStartLifetime=Math.max(this._maxStartLifetime,w.getValueByIndex(Q));var e=e;for(Q=0,m=e.gradientCount;Q<m;Q++)this._maxStartLifetime=Math.max(this._maxStartLifetime,e.getValueByIndex(Q));}
this._startLifetimeType=q;}),d(0,q,"startLifetimeConstant",function(){return this._startLifetimeConstant;},function(q){0===this._startLifetimeType&&(this._maxStartLifetime=q),this._startLifetimeConstant=q;}),d(0,q,"startLifetimeConstantMin",function(){return this._startLifetimeConstantMin;},function(q){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(q,this._startLifetimeConstantMax)),this._startLifetimeConstantMin=q;}),d(0,q,"startLifeTimeGradient",function(){return this._startLifeTimeGradient;},function(q){if(1===this._startLifetimeType){this._maxStartLifetime=-Number.MAX_VALUE;for(var Q=0,m=q.gradientCount;Q<m;Q++)this._maxStartLifetime=Math.max(this._maxStartLifetime,q.getValueByIndex(Q));}
this._startLifeTimeGradient=q;}),d(0,q,"startLifetimeConstantMax",function(){return this._startLifetimeConstantMax;},function(q){2===this._startLifetimeType&&(this._maxStartLifetime=Math.max(this._startLifetimeConstantMin,q)),this._startLifetimeConstantMax=q;}),d(0,q,"startLifeTimeGradientMin",function(){return this._startLifeTimeGradientMin;},function(q){if(3===this._startLifetimeType){var Q=0,m=0;for(this._maxStartLifetime=-Number.MAX_VALUE,Q=0,m=q.gradientCount;Q<m;Q++)this._maxStartLifetime=Math.max(this._maxStartLifetime,q.getValueByIndex(Q));for(Q=0,m=this._startLifeTimeGradientMax.gradientCount;Q<m;Q++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMax.getValueByIndex(Q));}
this._startLifeTimeGradientMin=q;}),d(0,q,"startLifeTimeGradientMax",function(){return this._startLifeTimeGradientMax;},function(q){if(3===this._startLifetimeType){var Q=0,m=0;for(this._maxStartLifetime=-Number.MAX_VALUE,Q=0,m=this._startLifeTimeGradientMin.gradientCount;Q<m;Q++)this._maxStartLifetime=Math.max(this._maxStartLifetime,this._startLifeTimeGradientMin.getValueByIndex(Q));for(Q=0,m=q.gradientCount;Q<m;Q++)this._maxStartLifetime=Math.max(this._maxStartLifetime,q.getValueByIndex(Q));}
this._startLifeTimeGradientMax=q;}),d(0,q,"velocityOverLifetime",function(){return this._velocityOverLifetime;},function(q){var Q=this._owner._render._defineDatas,m=this._owner._render._shaderValues;if(q){var a=q.velocity,w=a.type;if(q.enbale)switch(w){case 0:Q.add(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT);break;case 1:Q.add(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE);break;case 2:Q.add(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT);break;case 3:Q.add(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);}else Q.remove(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),Q.remove(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),Q.remove(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),Q.remove(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE);switch(w){case 0:m.setVector3(Oa.VOLVELOCITYCONST,a.constant);break;case 1:m.setBuffer(Oa.VOLVELOCITYGRADIENTX,a.gradientX._elements),m.setBuffer(Oa.VOLVELOCITYGRADIENTY,a.gradientY._elements),m.setBuffer(Oa.VOLVELOCITYGRADIENTZ,a.gradientZ._elements);break;case 2:m.setVector3(Oa.VOLVELOCITYCONST,a.constantMin),m.setVector3(Oa.VOLVELOCITYCONSTMAX,a.constantMax);break;case 3:m.setBuffer(Oa.VOLVELOCITYGRADIENTX,a.gradientXMin._elements),m.setBuffer(Oa.VOLVELOCITYGRADIENTXMAX,a.gradientXMax._elements),m.setBuffer(Oa.VOLVELOCITYGRADIENTY,a.gradientYMin._elements),m.setBuffer(Oa.VOLVELOCITYGRADIENTYMAX,a.gradientYMax._elements),m.setBuffer(Oa.VOLVELOCITYGRADIENTZ,a.gradientZMin._elements),m.setBuffer(Oa.VOLVELOCITYGRADIENTZMAX,a.gradientZMax._elements);}
m.setInt(Oa.VOLSPACETYPE,q.space);}else Q.remove(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT),Q.remove(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE),Q.remove(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT),Q.remove(Oa.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE),m.setVector(Oa.VOLVELOCITYCONST,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTX,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTY,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTZ,null),m.setVector(Oa.VOLVELOCITYCONST,null),m.setVector(Oa.VOLVELOCITYCONSTMAX,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTX,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTXMAX,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTY,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTYMAX,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTZ,null),m.setBuffer(Oa.VOLVELOCITYGRADIENTZMAX,null),m.setInt(Oa.VOLSPACETYPE,void 0);this._velocityOverLifetime=q;}),d(0,q,"colorOverLifetime",function(){return this._colorOverLifetime;},function(q){var Q=this._owner._render._defineDatas,m=this._owner._render._shaderValues;if(q){var a=q.color;if(q.enbale)switch(a.type){case 1:Q.add(Oa.SHADERDEFINE_COLOROVERLIFETIME);break;case 3:Q.add(Oa.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);}else Q.remove(Oa.SHADERDEFINE_COLOROVERLIFETIME),Q.remove(Oa.SHADERDEFINE_RANDOMCOLOROVERLIFETIME);switch(a.type){case 1:var w=a.gradient;m.setBuffer(Oa.COLOROVERLIFEGRADIENTALPHAS,w._alphaElements),m.setBuffer(Oa.COLOROVERLIFEGRADIENTCOLORS,w._rgbElements);break;case 3:var e=a.gradientMin,F=a.gradientMax;m.setBuffer(Oa.COLOROVERLIFEGRADIENTALPHAS,e._alphaElements),m.setBuffer(Oa.COLOROVERLIFEGRADIENTCOLORS,e._rgbElements),m.setBuffer(Oa.MAXCOLOROVERLIFEGRADIENTALPHAS,F._alphaElements),m.setBuffer(Oa.MAXCOLOROVERLIFEGRADIENTCOLORS,F._rgbElements);}}else Q.remove(Oa.SHADERDEFINE_COLOROVERLIFETIME),Q.remove(Oa.SHADERDEFINE_RANDOMCOLOROVERLIFETIME),m.setBuffer(Oa.COLOROVERLIFEGRADIENTALPHAS,w._alphaElements),m.setBuffer(Oa.COLOROVERLIFEGRADIENTCOLORS,w._rgbElements),m.setBuffer(Oa.COLOROVERLIFEGRADIENTALPHAS,e._alphaElements),m.setBuffer(Oa.COLOROVERLIFEGRADIENTCOLORS,e._rgbElements),m.setBuffer(Oa.MAXCOLOROVERLIFEGRADIENTALPHAS,F._alphaElements),m.setBuffer(Oa.MAXCOLOROVERLIFEGRADIENTCOLORS,F._rgbElements);this._colorOverLifetime=q;}),d(0,q,"sizeOverLifetime",function(){return this._sizeOverLifetime;},function(q){var Q=this._owner._render._defineDatas,m=this._owner._render._shaderValues;if(q){var a=q.size,w=a.separateAxes,e=a.type;if(q.enbale)switch(e){case 0:w?Q.add(Oa.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE):Q.add(Oa.SHADERDEFINE_SIZEOVERLIFETIMECURVE);break;case 2:w?Q.add(Oa.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE):Q.add(Oa.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES);}else Q.remove(Oa.SHADERDEFINE_SIZEOVERLIFETIMECURVE),Q.remove(Oa.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),Q.remove(Oa.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),Q.remove(Oa.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE);switch(e){case 0:w?(m.setBuffer(Oa.SOLSIZEGRADIENTX,a.gradientX._elements),m.setBuffer(Oa.SOLSIZEGRADIENTY,a.gradientY._elements),m.setBuffer(Oa.SOLSizeGradientZ,a.gradientZ._elements)):m.setBuffer(Oa.SOLSIZEGRADIENT,a.gradient._elements);break;case 2:w?(m.setBuffer(Oa.SOLSIZEGRADIENTX,a.gradientXMin._elements),m.setBuffer(Oa.SOLSIZEGRADIENTXMAX,a.gradientXMax._elements),m.setBuffer(Oa.SOLSIZEGRADIENTY,a.gradientYMin._elements),m.setBuffer(Oa.SOLSIZEGRADIENTYMAX,a.gradientYMax._elements),m.setBuffer(Oa.SOLSizeGradientZ,a.gradientZMin._elements),m.setBuffer(Oa.SOLSizeGradientZMAX,a.gradientZMax._elements)):(m.setBuffer(Oa.SOLSIZEGRADIENT,a.gradientMin._elements),m.setBuffer(Oa.SOLSizeGradientMax,a.gradientMax._elements));}}else Q.remove(Oa.SHADERDEFINE_SIZEOVERLIFETIMECURVE),Q.remove(Oa.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE),Q.remove(Oa.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES),Q.remove(Oa.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE),m.setBuffer(Oa.SOLSIZEGRADIENTX,null),m.setBuffer(Oa.SOLSIZEGRADIENTXMAX,null),m.setBuffer(Oa.SOLSIZEGRADIENTY,null),m.setBuffer(Oa.SOLSIZEGRADIENTYMAX,null),m.setBuffer(Oa.SOLSizeGradientZ,null),m.setBuffer(Oa.SOLSizeGradientZMAX,null),m.setBuffer(Oa.SOLSIZEGRADIENT,null),m.setBuffer(Oa.SOLSizeGradientMax,null);this._sizeOverLifetime=q;}),d(0,q,"textureSheetAnimation",function(){return this._textureSheetAnimation;},function(q){var Q=this._owner._render._defineDatas,m=this._owner._render._shaderValues;if(q){var a=q.frame,w=a.type;if(q.enable)switch(w){case 1:Q.add(Oa.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE);break;case 3:Q.add(Oa.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);}else Q.remove(Oa.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),Q.remove(Oa.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE);if(1===w||3===w){m.setNumber(Oa.TEXTURESHEETANIMATIONCYCLES,q.cycles);var e=q.tiles,F=this._uvLength;F.x=1/e.x,F.y=1/e.y,m.setVector2(Oa.TEXTURESHEETANIMATIONSUBUVLENGTH,this._uvLength);}
switch(w){case 1:m.setBuffer(Oa.TEXTURESHEETANIMATIONGRADIENTUVS,a.frameOverTimeData._elements);break;case 3:m.setBuffer(Oa.TEXTURESHEETANIMATIONGRADIENTUVS,a.frameOverTimeDataMin._elements),m.setBuffer(Oa.TEXTURESHEETANIMATIONGRADIENTMAXUVS,a.frameOverTimeDataMax._elements);}}else Q.remove(Oa.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE),Q.remove(Oa.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE),m.setNumber(Oa.TEXTURESHEETANIMATIONCYCLES,void 0),m.setVector(Oa.TEXTURESHEETANIMATIONSUBUVLENGTH,null),m.setBuffer(Oa.TEXTURESHEETANIMATIONGRADIENTUVS,null),m.setBuffer(Oa.TEXTURESHEETANIMATIONGRADIENTMAXUVS,null);this._textureSheetAnimation=q;}),$.halfKSqrtOf2=.71,y($,["_RANDOMOFFSET",function(){return this._RANDOMOFFSET=new Uint32Array([592910910,3276756734,322376503,306581307,1793934638,3737431713,2527743459,2368504881,4085612399,3774601268,326370691,1494990940,1089181156,3159510623,2941263940,2786374529,271901988,4233252447]);},"_maxElapsedTime",function(){return this._maxElapsedTime=1/3;},"_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();},"_tempVector32",function(){return this._tempVector32=new _q();},"_tempVector33",function(){return this._tempVector33=new _q();},"_tempVector34",function(){return this._tempVector34=new _q();},"_tempVector35",function(){return this._tempVector35=new _q();},"_tempVector36",function(){return this._tempVector36=new _q();},"_tempVector37",function(){return this._tempVector37=new _q();},"_tempVector38",function(){return this._tempVector38=new _q();},"_tempVector39",function(){return this._tempVector39=new _q();},"_tempPosition",function(){return this._tempPosition=new _q();},"_tempDirection",function(){return this._tempDirection=new _q();},"_type",function(){return this._type=P._typeCounter++;}]),$;}(P),Wm=(function(q){function m(q,Q){m.__super.call(this),this._normal=q,this._offset=Q,this._type=6,m._nativeNormal.setValue(-q.x,q.y,q.z),this._nativeShape=new R._physics3D.btStaticPlaneShape(m._nativeNormal,Q);}
S(m,"laya.d3.physics.shape.StaticPlaneColliderShape",k),m.prototype.clone=function(){var q=new m(this._normal,this._offset);return this.cloneTo(q),q;},y(m,["_nativeNormal",function(){return this._nativeNormal=new R._physics3D.btVector3(0,0,0);}]);}(),function(q){function Q(){this._instanceBatchOpaqueMarks=[],this._vertexBatchOpaqueMarks=[],this._cacheBufferStates=[],Q.__super.call(this),Om.instance=new Om(),this._updateCountMark=0;}
S(Q,"laya.d3.graphics.MeshRenderDynamicBatchManager",q);var m=Q.prototype;return m.getInstanceBatchOpaquaMark=function(q,Q,m,a){var w=this._instanceBatchOpaqueMarks[q]||(this._instanceBatchOpaqueMarks[q]=[]),e=w[Q?0:1]||(w[Q?0:1]=[]),F=e[m]||(e[m]=[]);return F[a]||(F[a]=new bQ());},m.getVertexBatchOpaquaMark=function(q,Q,m,a){var w=this._vertexBatchOpaqueMarks[q]||(this._vertexBatchOpaqueMarks[q]=[]),e=w[Q?0:1]||(w[Q?0:1]=[]),F=e[m]||(e[m]=[]);return F[a]||(F[a]=new bQ());},m._getBufferState=function(q){var Q=this._cacheBufferStates[q.id];if(!Q){var m=Om.instance;(Q=new PQ()).bind();var a=m._vertexBuffer;a.vertexDeclaration=q,Q.applyVertexBuffer(a),Q.applyIndexBuffer(m._indexBuffer),Q.unBind(),this._cacheBufferStates[q.id]=Q;}
return Q;},m._getBatchRenderElementFromPool=function(){var q=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return q||(q=new Em(),(this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=q).vertexBatchElementList=[],q.instanceBatchElementList=[]),q;},m._clear=function(){q.prototype._clear.call(this),this._updateCountMark++;},y(Q,["instance",function(){return this.instance=new Q();}]),Q;}(I)),sm=function(q){function a(q,Q,m){a.__super.call(this),void 0===q&&(q=1),void 0===Q&&(Q=1),void 0===m&&(m=1),this._sizeX=q,this._sizeY=Q,this._sizeZ=m,this._type=0,a._nativeSize.setValue(q/2,Q/2,m/2),this._nativeShape=new R._physics3D.btBoxShape(a._nativeSize);}
S(a,"laya.d3.physics.shape.BoxColliderShape",k);var Q=a.prototype;return Q.clone=function(){var q=new a(this._sizeX,this._sizeY,this._sizeZ);return this.cloneTo(q),q;},d(0,Q,"sizeX",function(){return this._sizeX;}),d(0,Q,"sizeY",function(){return this._sizeY;}),d(0,Q,"sizeZ",function(){return this._sizeZ;}),y(a,["_nativeSize",function(){return this._nativeSize=new R._physics3D.btVector3(0,0,0);}]),a;}(),Dm=function(q){function Q(){Q.__super.call(this);}
S(Q,"laya.d3.component.SimpleSingletonList",g);var m=Q.prototype;return m.add=function(q){if(-1!==q._getIndexInList())throw"SimpleSingletonList:"+q+" has  in  SingletonList.";this._add(q),q._setIndexInList(this.length++);},m.remove=function(q){var Q=q._getIndexInList();if(this.length--,Q!==this.length){var m=this.elements[this.length];(this.elements[Q]=m)._setIndexInList(Q);}
q._setIndexInList(-1);},Q;}(),dm=function(q){function Q(){Q.__super.call(this);}
S(Q,"laya.d3.physics.PhysicsUpdateList",g);var m=Q.prototype;return m.add=function(q){if(-1!==q._inPhysicUpdateListIndex)throw"PhysicsUpdateList:element has  in  PhysicsUpdateList.";this._add(q),q._inPhysicUpdateListIndex=this.length++;},m.remove=function(q){var Q=q._inPhysicUpdateListIndex;if(this.length--,Q!==this.length){var m=this.elements[this.length];(this.elements[Q]=m)._inPhysicUpdateListIndex=Q;}
q._inPhysicUpdateListIndex=-1;},Q;}(),vm=function(q){function B(q,Q,m){B.__super.call(this),this._bufferState=new PQ(),this._batchID=B._batchIDCounter++,this._batchElements=[],this._currentBatchVertexCount=0,this._currentBatchIndexCount=0,this._vertexDeclaration=m,this.batchOwner=q,this.number=Q;}
S(B,"laya.d3.graphics.SubMeshStaticBatch",P);var Q=B.prototype;return o.imps(Q,{"laya.resource.IDispose":!0}),Q._getStaticBatchBakedVertexs=function(q,Q,m,a,w,e){var F,W=e._vertexBuffers[0],s=W.vertexDeclaration,D=s.getVertexElementByUsage(0).offset/4,d=s.getVertexElementByUsage(3),v=d?d.offset/4:-1,y=s.getVertexElementByUsage(1),S=y?y.offset/4:-1,t=s.getVertexElementByUsage(2),o=t?t.offset/4:-1,b=s.getVertexElementByUsage(7),U=b?b.offset/4:-1,J=s.getVertexElementByUsage(4),V=J?J.offset/4:-1,n=s.vertexStride/4,O=W.getData();m?(m.worldMatrix.invert(B._tempMatrix4x40),F=B._tempMatrix4x41,kQ.multiply(B._tempMatrix4x40,a.worldMatrix,F)):F=a.worldMatrix;var C=B._tempQuaternion0;F.decomposeTransRotScale(B._tempVector30,C,B._tempVector31);for(var l=w.lightmapScaleOffset,u=e.vertexCount,f=0;f<u;f++){var p=f*n,T=18*(f+Q);Rq.transformVector3ArrayToVector3ArrayCoordinate(O,p+D,F,q,T+0),-1!==v&&Rq.transformVector3ArrayByQuat(O,p+v,C,q,T+3);var c=0,r=0,_=T+6;if(-1!==S){var Z=p+S;for(c=0,r=4;c<r;c++)q[_+c]=O[Z+c];}else
for(c=0,r=4;c<r;c++)q[_+c]=1;if(-1!==o){var A=p+o;q[T+10]=O[A],q[T+11]=O[A+1];}
if(l&&(-1!==U?Rq.transformLightingMapTexcoordArray(O,p+U,l,q,T+12):Rq.transformLightingMapTexcoordArray(O,p+o,l,q,T+12)),-1!==V){var E=p+V;q[T+14]=O[E],q[T+15]=O[E+1],q[T+16]=O[E+2],q[T+17]=O[E+3];}}
return u;},Q.addTest=function(q){var Q=q.meshFilter.sharedMesh.vertexCount;return!(65535<this._currentBatchVertexCount+Q);},Q.add=function(q){var Q=q._render._staticBatch;Q&&Q.remove(q);var m=q.meshFilter.sharedMesh,a=m.vertexCount;this._batchElements.push(q);var w=q._render;w._isPartOfStaticBatch=!0,w._staticBatch=this;for(var e=w._renderElements,F=0,W=e.length;F<W;F++)e[F].staticBatch=this;this._currentBatchIndexCount+=m._indexBuffer.indexCount,this._currentBatchVertexCount+=a;},Q.remove=function(q){var Q=q.meshFilter.sharedMesh,m=this._batchElements.indexOf(q);if(-1!==m){this._batchElements.splice(m,1);q._render;for(var a=q._render._renderElements,w=0,e=a.length;w<e;w++)a[w].staticBatch=null;var F=Q.vertexCount;this._currentBatchIndexCount=this._currentBatchIndexCount-Q._indexBuffer.indexCount,this._currentBatchVertexCount=this._currentBatchVertexCount-F,q._render._isPartOfStaticBatch=!1;}},Q.finishInit=function(){this._vertexBuffer&&(this._vertexBuffer.destroy(),this._indexBuffer.destroy(),u._addGPUMemory(-(this._vertexBuffer._byteLength+this._indexBuffer._byteLength)));var q=0,Q=0,m=this.batchOwner,a=this._vertexDeclaration.vertexStride/4,w=new Float32Array(a*this._currentBatchVertexCount),e=new Uint16Array(this._currentBatchIndexCount);this._vertexBuffer=new HQ(this._vertexDeclaration.vertexStride*this._currentBatchVertexCount,35044),this._vertexBuffer.vertexDeclaration=this._vertexDeclaration,this._indexBuffer=new gQ("ushort",this._currentBatchIndexCount,35044);for(var F=0,W=this._batchElements.length;F<W;F++){for(var s=this._batchElements[F],D=s.meshFilter.sharedMesh,d=this._getStaticBatchBakedVertexs(w,q,m?m._transform:null,s._transform,s._render,D),v=D._indexBuffer.getData(),y=q,S=Q+v.length,t=s._render._renderElements,o=0,b=D.subMeshCount;o<b;o++){var U=D._subMeshes[o],J=Q+U._indexStart,V=t[o];V.staticBatchIndexStart=J,V.staticBatchIndexEnd=J+U._indexCount;}
e.set(v,Q);var n=0;if(m?s._transform._isFrontFaceInvert!==m.transform._isFrontFaceInvert:s._transform._isFrontFaceInvert)
for(n=Q;n<S;n+=3){e[n]=y+e[n];var O=e[n+1],C=e[n+2];e[n+1]=y+C,e[n+2]=y+O;}else
for(n=Q;n<S;n+=3)e[n]=y+e[n],e[n+1]=y+e[n+1],e[n+2]=y+e[n+2];Q+=v.length,q+=d;}
this._vertexBuffer.setData(w),this._indexBuffer.setData(e);var l=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;u._addGPUMemory(l),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind();},Q._render=function(q){this._bufferState.bind();for(var Q=q.renderElement.staticBatchElementList,m=0,a=0,w=Q.length,e=1;e<w;e++){if(Q[e-1].staticBatchIndexEnd!==Q[e].staticBatchIndexStart){var F=Q[m].staticBatchIndexStart,W=Q[a].staticBatchIndexEnd-F;J.instance.drawElements(4,W,5123,2*F),m=++a,r.trianglesFaces+=W/3;}else a++;}
F=Q[m].staticBatchIndexStart,W=Q[a].staticBatchIndexEnd-F,J.instance.drawElements(4,W,5123,2*F),r.renderBatches++,r.savedRenderBatches+=w-1,r.trianglesFaces+=W/3;},Q.dispose=function(){var q=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;u._addGPUMemory(-q),this._batchElements=null,this.batchOwner=null,this._vertexDeclaration=null,this._bufferState.destroy(),this._vertexBuffer.destroy(),this._indexBuffer.destroy(),this._vertexBuffer=null,this._indexBuffer=null,this._bufferState=null;},B.maxBatchVertexCount=65535,B._batchIDCounter=0,y(B,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();},"_tempQuaternion0",function(){return this._tempQuaternion0=new eq();},"_tempMatrix4x40",function(){return this._tempMatrix4x40=new kQ();},"_tempMatrix4x41",function(){return this._tempMatrix4x41=new kQ();}]),B;}(),ym=function(Q){function s(q){this._floatCountPerVertices1=8,this._floatCountPerVertices2=1,this._increaseSegementCount=128,this._activeIndex=0,this._endIndex=0,this._needAddFirstVertex=!1,this._isTempEndVertex=!1,this._subBirthTime=null,this._subDistance=null,this._segementCount=0,this._vertices1=null,this._vertices2=null,this._vertexBuffer1=null,this._vertexBuffer2=null,this._owner=null,s.__super.call(this),this._lastFixedVertexPosition=new _q(),this._bufferState=new PQ(),this._owner=q,this._resizeData(this._increaseSegementCount,this._bufferState);}
S(s,"laya.d3.core.trail.TrailGeometry",Q);var q=s.prototype;return q._resizeData=function(q,Q){this._segementCount=this._increaseSegementCount,this._subBirthTime=new Float32Array(q),this._subDistance=new Float32Array(q);var m=2*q,a=QQ.vertexDeclaration1,w=QQ.vertexDeclaration2,e=[],F=m*a.vertexStride,W=m*w.vertexStride,s=F+W;this._vertices1=new Float32Array(m*this._floatCountPerVertices1),this._vertexBuffer1=new HQ(F,35044,!1),this._vertexBuffer1.vertexDeclaration=a,this._vertices2=new Float32Array(m*this._floatCountPerVertices2),this._vertexBuffer2=new HQ(W,35048,!1),this._vertexBuffer2.vertexDeclaration=w,e.push(this._vertexBuffer1),e.push(this._vertexBuffer2),Q.bind(),Q.applyVertexBuffers(e),Q.unBind(),u._addMemory(s,s);},q._resetData=function(){var q=this._endIndex-this._activeIndex;q==this._segementCount&&(this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._segementCount+=this._increaseSegementCount,this._resizeData(this._segementCount,this._bufferState)),this._vertexBuffer1.setData(this._vertices1,0,2*this._floatCountPerVertices1*this._activeIndex,2*this._floatCountPerVertices1*q),this._vertexBuffer2.setData(this._vertices2,0,2*this._floatCountPerVertices2*this._activeIndex,2*this._floatCountPerVertices2*q);var Q=4*this._activeIndex,m=new Float32Array(this._subDistance.buffer,Q,q),a=new Float32Array(this._subBirthTime.buffer,Q,q);this._subDistance.set(m,0),this._subBirthTime.set(a,0),this._endIndex=q,this._activeIndex=0;},q._updateTrail=function(q,Q,m){_q.equals(Q,m)||(this._endIndex-this._activeIndex==0?this._addTrailByFirstPosition(q,m):this._addTrailByNextPosition(q,m));},q._addTrailByFirstPosition=function(q,Q){this._endIndex===this._segementCount&&this._resetData(),this._subDistance[this._endIndex]=0,this._subBirthTime[this._endIndex]=this._owner._curtime,this._endIndex++,Q.cloneTo(this._lastFixedVertexPosition),this._needAddFirstVertex=!0;},q._addTrailByNextPosition=function(q,Q){var m=s._tempVector30,a=s._tempVector31;_q.subtract(Q,this._lastFixedVertexPosition,m);var w=s._tempVector32;switch(this._owner.alignment){case 0:q.transform.getForward(w),_q.cross(m,w,a);break;case 1:this._owner._owner.transform.getForward(w),_q.cross(m,w,a);}
_q.normalize(a,a),_q.scale(a,this._owner.widthMultiplier/2,a);var e=_q.scalarLength(m),F=0,W=NaN;this._needAddFirstVertex&&(this._updateVerticesByPositionData(Q,a,this._endIndex-1),this._needAddFirstVertex=!1),e-this._owner.minVertexDistance>=qq.zeroTolerance?(this._isTempEndVertex?(F=this._endIndex-1,W=e-this._subDistance[F],this._updateVerticesByPosition(Q,a,e,F),this._owner._totalLength+=W):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(Q,a,e,this._endIndex),this._owner._totalLength+=e,this._endIndex++),Q.cloneTo(this._lastFixedVertexPosition),this._isTempEndVertex=!1):(this._isTempEndVertex?(F=this._endIndex-1,W=e-this._subDistance[F],this._updateVerticesByPosition(Q,a,e,F),this._owner._totalLength+=W):(this._endIndex===this._segementCount&&this._resetData(),this._updateVerticesByPosition(Q,a,e,this._endIndex),this._owner._totalLength+=e,this._endIndex++),this._isTempEndVertex=!0);},q._updateVerticesByPositionData=function(q,Q,m){var a=2*this._floatCountPerVertices1*m,w=this._owner._curtime;this._vertices1[a]=q.x,this._vertices1[a+1]=q.y,this._vertices1[a+2]=q.z,this._vertices1[a+3]=-Q.x,this._vertices1[a+4]=-Q.y,this._vertices1[a+5]=-Q.z,this._vertices1[a+6]=w,this._vertices1[a+7]=1,this._vertices1[a+8]=q.x,this._vertices1[a+9]=q.y,this._vertices1[a+10]=q.z,this._vertices1[a+11]=Q.x,this._vertices1[a+12]=Q.y,this._vertices1[a+13]=Q.z,this._vertices1[a+14]=w,this._vertices1[a+15]=0;var e=2*this._floatCountPerVertices1;this._vertexBuffer1.setData(this._vertices1,a,a,e);},q._updateVerticesByPosition=function(q,Q,m,a){this._updateVerticesByPositionData(q,Q,a),this._subDistance[a]=m,this._subBirthTime[a]=this._owner._curtime;},q._updateVertexBufferUV=function(){for(var q=this._endIndex,Q=0,m=this._activeIndex,a=q;m<a;m++){m!==this._activeIndex&&(Q+=this._subDistance[m]);var w=NaN;w=0==this._owner.textureMode?1-Q/this._owner._totalLength:1-(this._owner._totalLength-Q),this._vertices2[2*m]=w,this._vertices2[2*m+1]=w;}
var e=2*this._activeIndex;this._vertexBuffer2.setData(this._vertices2,e,e,2*q-e);},q._updateDisappear=function(){for(var q=this._endIndex,Q=this._activeIndex;Q<q&&this._owner._curtime-this._subBirthTime[Q]>=this._owner.time+qq.zeroTolerance;Q++){var m=Q+1;if(m!==q&&(this._owner._totalLength-=this._subDistance[m]),this._isTempEndVertex&&m===q-1){this._floatCountPerVertices1;var a=this._lastFixedVertexPosition;a.x=this._vertices1[0],a.y=this._vertices1[1],a.z=this._vertices1[2],this._isTempEndVertex=!1;}
this._activeIndex++;}},q._getType=function(){return s._type;},q._prepareRender=function(q){return 1<this._endIndex-this._activeIndex;},q._render=function(q){this._bufferState.bind();var Q=2*this._activeIndex,m=2*this._endIndex-Q;J.instance.drawArrays(5,Q,m),r.renderBatches++,r.trianglesFaces+=m-2;},q.destroy=function(){Q.prototype.destroy.call(this);var q=this._vertexBuffer1._byteLength+this._vertexBuffer2._byteLength;u._addMemory(-q,-q),this._bufferState.destroy(),this._vertexBuffer1.destroy(),this._vertexBuffer2.destroy(),this._bufferState=null,this._vertices1=null,this._vertexBuffer1=null,this._vertices2=null,this._vertexBuffer2=null,this._subBirthTime=null,this._subDistance=null,this._lastFixedVertexPosition=null;},y(s,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();},"_tempVector32",function(){return this._tempVector32=new _q();},"_type",function(){return this._type=P._typeCounter++;}]),s;}(P),Sm=function(a){function w(){w.__super.call(this),this._childColliderShapes=[],this._type=5,this._nativeShape=new R._physics3D.btCompoundShape();}
S(w,"laya.d3.physics.shape.CompoundColliderShape",a);var q=w.prototype;return q._clearChildShape=function(q){q._attatched=!1,q._compoundParent=null,q._indexInCompound=-1;},q._addReference=function(){},q._removeReference=function(){},q._updateChildTransform=function(q){var Q=q.localOffset,m=q.localRotation,a=k._nativeVector30,w=k._nativQuaternion0,e=k._nativeTransform0;a.setValue(-Q.x,Q.y,Q.z),w.setValue(-m.x,m.y,m.z,-m.w),e.setOrigin(a),e.setRotation(w),this._nativeShape.updateChildTransform(q._indexInCompound,e,!0);},q.addChildShape=function(q){if(q._attatched)throw"CompoundColliderShape: this shape has attatched to other entity.";q._attatched=!0,q._compoundParent=this,q._indexInCompound=this._childColliderShapes.length,this._childColliderShapes.push(q);var Q=q.localOffset,m=q.localRotation;w._nativeOffset.setValue(-Q.x,Q.y,Q.z),w._nativRotation.setValue(-m.x,m.y,m.z,-m.w),w._nativeTransform.setOrigin(w._nativeOffset),w._nativeTransform.setRotation(w._nativRotation);var a=this._nativeShape.getLocalScaling();this._nativeShape.setLocalScaling(w._nativeVector3One),this._nativeShape.addChildShape(w._nativeTransform,q._nativeShape),this._nativeShape.setLocalScaling(a),this._attatchedCollisionObject&&(this._attatchedCollisionObject.colliderShape=this);},q.removeChildShape=function(q){if(q._compoundParent===this){var Q=q._indexInCompound;this._clearChildShape(q);var m=this._childColliderShapes[this._childColliderShapes.length-1];m._indexInCompound=Q,this._childColliderShapes[Q]=m,this._childColliderShapes.pop(),this._nativeShape.removeChildShapeByIndex(Q);}},q.clearChildShape=function(){for(var q=0,Q=this._childColliderShapes.length;q<Q;q++)this._clearChildShape(this._childColliderShapes[q]),this._nativeShape.removeChildShapeByIndex(0);this._childColliderShapes.length=0;},q.getChildShapeCount=function(){return this._childColliderShapes.length;},q.cloneTo=function(q){var Q=q;Q.clearChildShape();for(var m=0,a=this._childColliderShapes.length;m<a;m++)Q.addChildShape(this._childColliderShapes[m].clone());},q.clone=function(){var q=new w();return this.cloneTo(q),q;},q.destroy=function(){a.prototype.destroy.call(this);for(var q=0,Q=this._childColliderShapes.length;q<Q;q++){var m=this._childColliderShapes[q];0===m._referenceCount&&m.destroy();}},y(w,["_nativeVector3One",function(){return this._nativeVector3One=new R._physics3D.btVector3(1,1,1);},"_nativeTransform",function(){return this._nativeTransform=new R._physics3D.btTransform();},"_nativeOffset",function(){return this._nativeOffset=new R._physics3D.btVector3(0,0,0);},"_nativRotation",function(){return this._nativRotation=new R._physics3D.btQuaternion(0,0,0,1);}]),w;}(k),tm=function(q){function a(q,Q){this._floatCountPerVertices=7,this._owner=null,this._vertexBuffer=null,this._vertices=null,this._maxLineCount=0,this._lineCount=0,a.__super.call(this),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE,this._bufferState=new PQ();var m=2*Q;this._owner=q,this._maxLineCount=Q,this._vertices=new Float32Array(m*this._floatCountPerVertices),this._vertexBuffer=new HQ(iq.vertexDeclaration.vertexStride*m,35044,!1),this._vertexBuffer.vertexDeclaration=iq.vertexDeclaration,this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind();}
S(a,"laya.d3.core.pixelLine.PixelLineFilter",q);var Q=a.prototype;return Q._getType=function(){return a._type;},Q._resizeLineData=function(q){var Q=2*q,m=this._vertices;this._vertexBuffer.destroy(),this._maxLineCount=q;var a=Q*this._floatCountPerVertices;this._vertices=new Float32Array(a),this._vertexBuffer=new HQ(iq.vertexDeclaration.vertexStride*Q,35044,!1),this._vertexBuffer.vertexDeclaration=iq.vertexDeclaration,a<m.length?(this._vertices.set(new Float32Array(m.buffer,0,a)),this._vertexBuffer.setData(this._vertices,0,0,a)):(this._vertices.set(m),this._vertexBuffer.setData(this._vertices,0,0,m.length)),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind();},Q._updateLineVertices=function(q,Q,m,a,w){Q&&(this._vertices[q+0]=Q.x,this._vertices[q+1]=Q.y,this._vertices[q+2]=Q.z),a&&(this._vertices[q+3]=a.r,this._vertices[q+4]=a.g,this._vertices[q+5]=a.b,this._vertices[q+6]=a.a),m&&(this._vertices[q+7]=m.x,this._vertices[q+8]=m.y,this._vertices[q+9]=m.z),w&&(this._vertices[q+10]=w.r,this._vertices[q+11]=w.g,this._vertices[q+12]=w.b,this._vertices[q+13]=w.a),this._minUpdate=Math.min(this._minUpdate,q),this._maxUpdate=Math.max(this._maxUpdate,q+2*this._floatCountPerVertices);},Q._removeLineData=function(q){var Q=2*this._floatCountPerVertices,m=q+1,a=q*Q,w=new Float32Array(this._vertices.buffer,m*Q*4,(this._lineCount-m)*Q);this._vertices.set(w,a),this._minUpdate=a,this._maxUpdate=a+2*this._floatCountPerVertices,this._lineCount--;},Q._updateLineData=function(q,Q,m,a,w){var e=q*(2*this._floatCountPerVertices);this._updateLineVertices(e,Q,m,a,w);},Q._updateLineDatas=function(q,Q){for(var m=2*this._floatCountPerVertices,a=Q.length,w=0;w<a;w++){var e=Q[w];this._updateLineVertices((q+w)*m,e.startPosition,e.endPosition,e.startColor,e.endColor);}},Q._getLineData=function(q,Q){var m=Q.startPosition,a=Q.startColor,w=Q.endPosition,e=Q.endColor,F=this._vertices,W=q*this._floatCountPerVertices*2;m.x=F[W+0],m.y=F[W+1],m.z=F[W+2],a.r=F[W+3],a.g=F[W+4],a.b=F[W+5],a.a=F[W+6],w.x=F[W+7],w.y=F[W+8],w.z=F[W+9],e.r=F[W+10],e.g=F[W+11],e.b=F[W+12],e.a=F[W+13];},Q._prepareRender=function(q){return!0;},Q._render=function(q){this._minUpdate!==Number.MAX_VALUE&&this._maxUpdate!==Number.MIN_VALUE&&(this._vertexBuffer.setData(this._vertices,this._minUpdate,this._minUpdate,this._maxUpdate-this._minUpdate),this._minUpdate=Number.MAX_VALUE,this._maxUpdate=Number.MIN_VALUE),0<this._lineCount&&(this._bufferState.bind(),J.instance.drawArrays(1,0,2*this._lineCount),r.renderBatches++);},Q.destroy=function(){this._destroyed||(q.prototype.destroy.call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._bufferState=null,this._vertexBuffer=null,this._vertices=null);},y(a,["_type",function(){return this._type=P._typeCounter++;}]),a;}(P),om=function(q){function a(q,Q,m){switch(this._radius=1,this._height=.5,a.__super.call(this),void 0===q&&(q=.5),void 0===Q&&(Q=1),void 0===m&&(m=1),this._radius=q,this._height=Q,this._orientation=m,this._type=2,m){case 0:a._nativeSize.setValue(Q/2,q,q),this._nativeShape=new R._physics3D.btCylinderShapeX(a._nativeSize);break;case 1:a._nativeSize.setValue(q,Q/2,q),this._nativeShape=new R._physics3D.btCylinderShape(a._nativeSize);break;case 2:a._nativeSize.setValue(q,q,Q/2),this._nativeShape=new R._physics3D.btCylinderShapeZ(a._nativeSize);break;default:throw"CapsuleColliderShape:unknown orientation.";}}
S(a,"laya.d3.physics.shape.CylinderColliderShape",k);var Q=a.prototype;return Q.clone=function(){var q=new a(this._radius,this._height,this._orientation);return this.cloneTo(q),q;},d(0,Q,"radius",function(){return this._radius;}),d(0,Q,"height",function(){return this._height;}),d(0,Q,"orientation",function(){return this._orientation;}),y(a,["_nativeSize",function(){return this._nativeSize=new R._physics3D.btVector3(0,0,0);}]),a;}(),bm=function(m){function q(){q.__super.call(this);}
return S(q,"laya.d3.core.FloatKeyframe",m),q.prototype.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;Q.inTangent=this.inTangent,Q.outTangent=this.outTangent,Q.value=this.value;},q;}(Dq),Um=function(q){function Q(){this.maxInstanceCount=1024,Q.__super.call(this),this.instanceWorldMatrixData=new Float32Array(16*this.maxInstanceCount),this.instanceMVPMatrixData=new Float32Array(16*this.maxInstanceCount),this.instanceWorldMatrixBuffer=new HQ(4*this.instanceWorldMatrixData.length,35048),this.instanceMVPMatrixBuffer=new HQ(4*this.instanceMVPMatrixData.length,35048),this.instanceWorldMatrixBuffer.vertexDeclaration=bq.instanceWorldMatrixDeclaration,this.instanceMVPMatrixBuffer.vertexDeclaration=bq.instanceMVPMatrixDeclaration;}
return S(Q,"laya.d3.graphics.SubMeshInstanceBatch",P),Q.prototype._render=function(q){var Q=q.renderElement,m=Q.instanceSubMesh,a=Q.instanceBatchElementList.length,w=m._indexCount;m._mesh._instanceBufferState.bind(),E._angleInstancedArrays.drawElementsInstancedANGLE(4,w,5123,2*m._indexStart,a),r.renderBatches++,r.savedRenderBatches+=a-1,r.trianglesFaces+=w*a/3;},y(Q,["instance",function(){return this.instance=new Q();}]),Q;}(),Jm=function(q){function Q(){Q.__super.call(this);}
S(Q,"laya.d3.core.scene.OctreeMotionList",g);var m=Q.prototype;return m.add=function(q){if(-1!==q._getIndexInMotionList())throw"OctreeMotionList:element has  in  PhysicsUpdateList.";this._add(q),q._setIndexInMotionList(this.length++);},m.remove=function(q){var Q=q._getIndexInMotionList();if(this.length--,Q!==this.length){var m=this.elements[this.length];(this.elements[Q]=m)._inPhysicUpdateListIndex=Q;}
q._setIndexInMotionList(-1);},Q;}(),Vm=function(q){function m(){this._renderTexture=null,m.__super.call(this);}
S(m,"laya.d3.core.render.command.SetRenderTargetCMD",h);var Q=m.prototype;return Q.run=function(){this._renderTexture._start();},Q.recover=function(){m._pool.push(this),this._renderTexture=null;},m.create=function(q){var Q;return(Q=0<m._pool.length?m._pool.pop():new m())._renderTexture=q,Q;},m._pool=[],m;}(),nm=function(q){function w(){this._opaqueBatchMarks=[],w.__super.call(this),this._updateCountMark=0;}
S(w,"laya.d3.graphics.MeshRenderStaticBatchManager",q);var Q=w.prototype;return Q._compare=function(q,Q){var m=q._render,a=Q._render,w=q.meshFilter.sharedMesh,e=Q.meshFilter.sharedMesh,F=m.lightmapIndex-a.lightmapIndex;if(0!==F)return F;var W=(m.receiveShadow?1:0)-(a.receiveShadow?1:0);if(0!==W)return W;var s=m.sharedMaterial.id-a.sharedMaterial.id;if(0!==s)return s;var D=w._vertexBuffers[0].vertexDeclaration.id-e._vertexBuffers[0].vertexDeclaration.id;return 0===D?e._indexBuffer.indexCount-w._indexBuffer.indexCount:D;},Q._getBatchRenderElementFromPool=function(){var q=this._batchRenderElementPool[this._batchRenderElementPoolIndex++];return q||(q=new Em(),(this._batchRenderElementPool[this._batchRenderElementPoolIndex-1]=q).staticBatchElementList=[]),q;},Q._getStaticBatch=function(q,Q){var m=q?q.id:0,a=this._staticBatches[m];return a||(a=this._staticBatches[m]=[]),a[Q]||(a[Q]=new vm(q,Q,w._verDec));},Q._initStaticBatchs=function(q){this._quickSort(this._initBatchSprites,0,this._initBatchSprites.length-1);for(var Q,m=!1,a=0,w=0,e=this._initBatchSprites.length;w<e;w++){var F=this._initBatchSprites[w];if(m)Q.addTest(F)?Q.add(F):(m=!1,a++);else w!==e-1&&((Q=this._getStaticBatch(q,a)).add(F),m=!0);}
for(var W in this._staticBatches){var s=this._staticBatches[W];for(w=0,e=s.length;w<e;w++)s[w].finishInit();}
this._initBatchSprites.length=0;},Q._destroyRenderSprite=function(q){var Q=q._render._staticBatch;if(Q.remove(q),0===Q._batchElements.length){var m=Q.batchOwner,a=m?m.id:0,w=this._staticBatches[a];w[Q.number]=null,Q.dispose();for(var e=!0,F=0;F<w.length;F++)w[F]&&(e=!1);e&&delete this._staticBatches[a];}},Q._clear=function(){q.prototype._clear.call(this),this._updateCountMark++;},Q._garbageCollection=function(){for(var q in this._staticBatches)
for(var Q=this._staticBatches[q],m=0,a=Q.length;m<a;m++){var w=Q[m];0===w._batchElements.length&&(w.dispose(),Q.splice(m,1),m--,0===--a&&delete this._staticBatches[q]);}},Q.getBatchOpaquaMark=function(q,Q,m,a){var w=this._opaqueBatchMarks[q]||(this._opaqueBatchMarks[q]=[]),e=w[Q]||(w[Q]=[]),F=e[m]||(e[m]=[]);return F[a]||(F[a]=new bQ());},y(w,["_verDec",function(){return this._verDec=bq.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT");},"instance",function(){return this.instance=new w();}]),w;}(j),Om=function(q){function m(){this._vertices=null,this._indices=null,this._positionOffset=0,this._normalOffset=0,this._colorOffset=0,this._uv0Offset=0,this._uv1Offset=0,this._sTangentOffset=0,this._vertexBuffer=null,this._indexBuffer=null,m.__super.call(this),this._bufferState=new PQ();var q=32e3*bq.getVertexDeclaration("POSITION,NORMAL,COLOR,UV,UV1,TANGENT").vertexStride;this._vertices=new Float32Array(q/4),this._vertexBuffer=new HQ(q,35048),this._indices=new Int16Array(32e3),this._indexBuffer=new gQ("ushort",this._indices.length,35048);var Q=this._vertexBuffer._byteLength+this._indexBuffer._byteLength;u._addMemory(Q,Q);}
S(m,"laya.d3.graphics.SubMeshDynamicBatch",P);var Q=m.prototype;return Q._getBatchVertices=function(q,Q,m,a,w,e){var F=q.vertexStride/4,W=e._vertexBuffer.getData(),s=(w.render.lightmapScaleOffset,w._dynamicMultiSubMesh),D=w._dynamicVertexCount;w._computeWorldPositionsAndNormals(this._positionOffset,this._normalOffset,s,D);for(var d=w._dynamicWorldPositions,v=w._dynamicWorldNormals,y=e._indices,S=0;S<D;S++){var t=(s?y[S]:S)*F,o=(S+m)*F,b=3*S,U=o+this._positionOffset;Q[U]=d[b],Q[U+1]=d[b+1],Q[U+2]=d[b+2],-1!==this._normalOffset&&(Q[U=o+this._normalOffset]=v[b],Q[U+1]=v[b+1],Q[U+2]=v[b+2]),-1!==this._colorOffset&&(U=o+this._colorOffset,b=t+this._colorOffset,Q[U]=W[b],Q[U+1]=W[b+1],Q[U+2]=W[b+2],Q[U+3]=W[b+3]),-1!==this._uv0Offset&&(U=o+this._uv0Offset,b=t+this._uv0Offset,Q[U]=W[b],Q[U+1]=W[b+1]),-1!==this._sTangentOffset&&(U=o+this._sTangentOffset,b=t+this._sTangentOffset,Q[U]=W[b],Q[U+1]=W[b+1],Q[U+2]=W[b+2],Q[U+3]=W[b+3],U=o+this._sTangentOffset,b=t+this._sTangentOffset,Q[U]=W[b],Q[U+1]=W[b+1],Q[U+2]=W[b+2],Q[U+3]=W[b+3]);}},Q._getBatchIndices=function(q,Q,m,a,w,e){var F=w._indices,W=0,s=0,D=0,d=a._isFrontFaceInvert;if(e)
if(d)
for(W=0,s=F.length;W<s;W+=3){var v=m+W;q[D=Q+W]=v,q[D+1]=v+2,q[D+2]=v+1;}else
for(W=s,s=F.length;W<s;W+=3)v=m+W,q[D=Q+W]=v,q[D+1]=v+1,q[D+2]=v+2;else if(d)
for(W=0,s=F.length;W<s;W+=3)q[D=Q+W]=m+F[W],q[D+1]=m+F[W+2],q[D+2]=m+F[W+1];else
for(W=s,s=F.length;W<s;W+=3)q[D=Q+W]=m+F[W],q[D+1]=m+F[W+1],q[D+2]=m+F[W+2];},Q._flush=function(q,Q){this._vertexBuffer.setData(this._vertices,0,0,q*(this._vertexBuffer.vertexDeclaration.vertexStride/4)),this._indexBuffer.setData(this._indices,0,0,Q),J.instance.drawElements(4,Q,5123,0);},Q._prepareRender=function(q){var Q=q.renderElement.vertexBatchVertexDeclaration;this._bufferState=Wm.instance._getBufferState(Q),this._positionOffset=Q.getVertexElementByUsage(0).offset/4;var m=Q.getVertexElementByUsage(3);this._normalOffset=m?m.offset/4:-1;var a=Q.getVertexElementByUsage(1);this._colorOffset=a?a.offset/4:-1;var w=Q.getVertexElementByUsage(2);this._uv0Offset=w?w.offset/4:-1;var e=Q.getVertexElementByUsage(7);this._uv1Offset=e?e.offset/4:-1;var F=Q.getVertexElementByUsage(4);return this._sTangentOffset=F?F.offset/4:-1,!0;},Q._render=function(q){this._bufferState.bind();for(var Q=q.renderElement,m=Q.vertexBatchVertexDeclaration,a=Q.vertexBatchElementList,w=0,e=0,F=(m.vertexStride,0),W=a.length,s=0;s<W;s++){var D=a[s],d=D._geometry,v=d._indexCount;32e3<e+v&&(this._flush(w,e),F++,r.trianglesFaces+=e/3,w=e=0);var y=D._transform;this._getBatchVertices(m,this._vertices,w,y,D,d),this._getBatchIndices(this._indices,e,w,y,d,D._dynamicMultiSubMesh),w+=D._dynamicVertexCount,e+=v;}
this._flush(w,e),F++,r.renderBatches+=F,r.savedRenderBatches+=W-F,r.trianglesFaces+=e/3;},m.maxAllowVertexCount=10,m.maxAllowAttribueCount=900,m.maxIndicesCount=32e3,m.instance=null,m;}(),Cm=function(q){function w(){w.__super.call(this);var q=new Float32Array([-.5,.5,-.5,.5,.5,-.5,.5,.5,.5,-.5,.5,.5,-.5,-.5,-.5,.5,-.5,-.5,.5,-.5,.5,-.5,-.5,.5]),Q=new Uint8Array([0,1,2,2,3,0,4,7,6,6,5,4,0,3,7,7,4,0,1,5,6,6,2,1,3,2,6,6,7,3,0,4,5,5,1,0]),m=bq.getVertexDeclaration("POSITION");this._vertexBuffer=new HQ(8*m.vertexStride,35044,!1),this._vertexBuffer.vertexDeclaration=m,this._indexBuffer=new gQ("ubyte",36,35044,!1),this._vertexBuffer.setData(q),this._indexBuffer.setData(Q);var a=new PQ();a.bind(),a.applyVertexBuffer(this._vertexBuffer),a.applyIndexBuffer(this._indexBuffer),a.unBind(),this._bufferState=a;}
return S(w,"laya.d3.resource.models.SkyBox",Oq),w.prototype._render=function(q){J.instance.drawElements(4,36,5121,0),r.trianglesFaces+=12,r.renderBatches++;},w.__init__=function(){w.instance=new w();},w.instance=null,w;}(),lm=function(m){function Q(){this._mesh=null,this._convex=!1,Q.__super.call(this);}
S(Q,"laya.d3.physics.shape.MeshColliderShape",m);var q=Q.prototype;return q._setScale=function(q){this._compoundParent?this.updateLocalTransformations():(k._nativeScale.setValue(q.x,q.y,q.z),this._nativeShape.setLocalScaling(k._nativeScale),this._nativeShape.updateBound());},q.cloneTo=function(q){var Q=q;Q.convex=this._convex,Q.mesh=this._mesh,m.prototype.cloneTo.call(this,q);},q.clone=function(){var q=new Q();return this.cloneTo(q),q;},q.destroy=function(){this._nativeShape&&(R._physics3D.destroy(this._nativeShape),this._nativeShape=null);},d(0,q,"mesh",function(){return this._mesh;},function(q){if(this._mesh!==q){var Q=R._physics3D;this._mesh&&Q.destroy(this._nativeShape),q&&(this._nativeShape=new Q.btGImpactMeshShape(q._getPhysicMesh()),this._nativeShape.updateBound()),this._mesh=q;}}),d(0,q,"convex",function(){return this._convex;},function(q){this._convex=q;}),Q;}(k),um=function(m){function q(){this.radius=NaN,this.emitFromShell=!1,q.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1;}
S(q,"laya.d3.core.particleShuriKen.module.shape.HemisphereShape",m);var Q=q.prototype;return Q._getShapeBoundBox=function(q){var Q=q.min;Q.x=Q.y=Q.z=-this.radius;var m=q.max;m.x=m.y=this.radius,m.z=0;},Q._getSpeedBoundBox=function(q){var Q=q.min;Q.x=Q.y=-1,Q.z=0;var m=q.max;m.x=m.y=m.z=1;},Q.generatePositionAndDirection=function(q,Q,m,a){m?(m.seed=a[16],this.emitFromShell?_Q._randomPointUnitSphere(q,m):_Q._randomPointInsideUnitSphere(q,m),a[16]=m.seed):this.emitFromShell?_Q._randomPointUnitSphere(q):_Q._randomPointInsideUnitSphere(q),_q.scale(q,this.radius,q);var w=q.z;w<0&&(q.z=-1*w),this.randomDirection?m?(m.seed=a[17],_Q._randomPointUnitSphere(Q,m),a[17]=m.seed):_Q._randomPointUnitSphere(Q):q.cloneTo(Q);},Q.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;Q.radius=this.radius,Q.emitFromShell=this.emitFromShell,Q.randomDirection=this.randomDirection;},q;}(K),fm=function(q){function D(q,Q,m,a,w,e,F,W){this._owner=null,this._gridSize=NaN,this.memorySize=0,this._numberVertices=0,this._maxNumberIndices=0,this._currentNumberIndices=0,this._numberTriangle=0,this._vertexBuffer=null,this._indexBuffer=null,this._indexArrayBuffer=null,this._boundingBoxCorners=null,this._leafs=null,this._leafNum=0,this._terrainHeightData=null,this._terrainHeightDataWidth=0,this._terrainHeightDataHeight=0,this._chunkOffsetX=0,this._chunkOffsetZ=0,this._cameraCoordinateInverse=!1,this._cameraPos=null,this._currentLOD=0,this._perspectiveFactor=NaN,this._LODTolerance=0,this._boundingSphere=null,this._boundingBox=null,D.__super.call(this),this._bufferState=new PQ(),this._owner=q,this._cameraPos=new _q(),this._chunkOffsetX=Q,this._chunkOffsetZ=m,this._gridSize=a,this._terrainHeightData=w,this._terrainHeightDataWidth=e,this._terrainHeightDataHeight=F,this._leafNum=Wq.CHUNK_GRID_NUM/Wq.LEAF_GRID_NUM*(Wq.CHUNK_GRID_NUM/Wq.LEAF_GRID_NUM),this._leafs=N(this._leafNum),this._cameraCoordinateInverse=W;for(var s=0;s<this._leafNum;s++)this._leafs[s]=new Wq();this.recreateResource();}
S(D,"laya.d3.terrain.TerrainFilter",P);var Q=D.prototype;return Q.recreateResource=function(){this._currentNumberIndices=0,this._numberTriangle=0;var q=Wq.LEAF_VERTEXT_COUNT,Q=Wq.LEAF_MAX_INDEX_COUNT;this._numberVertices=q*this._leafNum,this._maxNumberIndices=Q*this._leafNum,this._indexArrayBuffer=new Uint16Array(this._maxNumberIndices);var m=gq.vertexDeclaration,a=m.vertexStride/4,w=new Float32Array(this._numberVertices*a),e=Wq.CHUNK_GRID_NUM/Wq.LEAF_GRID_NUM,F=0,W=0,s=0;for(F=0;F<this._leafNum;F++)W=F%e,s=Math.floor(F/e),this._leafs[F].calcVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,W*Wq.LEAF_GRID_NUM,s*Wq.LEAF_GRID_NUM,this._gridSize,w,F*Wq.LEAF_PLANE_VERTEXT_COUNT,a,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight,this._cameraCoordinateInverse);for(F=0;F<this._leafNum;F++)W=F%e,s=Math.floor(F/e),this._leafs[F].calcSkirtVertextBuffer(this._chunkOffsetX,this._chunkOffsetZ,W*Wq.LEAF_GRID_NUM,s*Wq.LEAF_GRID_NUM,this._gridSize,w,this._leafNum*Wq.LEAF_PLANE_VERTEXT_COUNT+F*Wq.LEAF_SKIRT_VERTEXT_COUNT,a,this._terrainHeightData,this._terrainHeightDataWidth,this._terrainHeightDataHeight);this.assembleIndexInit(),this._vertexBuffer=new HQ(m.vertexStride*this._numberVertices,35044,!1),this._vertexBuffer.vertexDeclaration=m,this._indexBuffer=new gQ("ushort",this._maxNumberIndices,35044,!1),this._vertexBuffer.setData(w),this._indexBuffer.setData(this._indexArrayBuffer),this.memorySize=2*(this._vertexBuffer._byteLength+this._indexBuffer._byteLength),this.calcOriginalBoudingBoxAndSphere(),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.applyIndexBuffer(this._indexBuffer),this._bufferState.unBind();},Q.setLODLevel=function(q){if(4!=q.length)return!0;var Q=(q[0]+1<<24)+(q[1]+1<<16)+(q[2]+1<<8)+(q[3]+1);return this._currentLOD!=Q&&(this._currentLOD=Q,!0);},Q.assembleIndexInit=function(){this._currentNumberIndices=0;for(var q=this._numberTriangle=0,Q=0;Q<this._leafNum;Q++){var m=Wq.getPlaneLODIndex(Q,0);this._indexArrayBuffer.set(m,q),q+=m.length;var a=Wq.getSkirtLODIndex(Q,0);this._indexArrayBuffer.set(a,q),q+=a.length,this._currentNumberIndices+=m.length+a.length;}
this._numberTriangle=this._currentNumberIndices/3;},Q.isNeedAssemble=function(q,Q){var m=Math.min(q.viewport.width,q.viewport.height)/(2*Math.tan(Math.PI*q.fieldOfView/180));return this._perspectiveFactor!=m?(this._perspectiveFactor=m,1):this._LODTolerance!=qa.LOD_TOLERANCE_VALUE?(this._LODTolerance=qa.LOD_TOLERANCE_VALUE,1):0==_q.equals(Q,this._cameraPos)?(this._cameraPos.x=Q.x,this._cameraPos.y=Q.y,this._cameraPos.z=Q.z,2):0;},Q.assembleIndex=function(q,Q){var m=this.isNeedAssemble(q,Q);if(0<m){for(var a=0;a<this._leafNum;a++)D._TEMP_ARRAY_BUFFER[a]=this._leafs[a].determineLod(Q,this._perspectiveFactor,qa.LOD_TOLERANCE_VALUE,1==m);if(this.setLODLevel(D._TEMP_ARRAY_BUFFER)){this._currentNumberIndices=0;var w=this._numberTriangle=0;for(a=0;a<this._leafNum;a++){var e=D._TEMP_ARRAY_BUFFER[a],F=Wq.getPlaneLODIndex(a,e);this._indexArrayBuffer.set(F,w),w+=F.length;var W=Wq.getSkirtLODIndex(a,e);this._indexArrayBuffer.set(W,w),w+=W.length,this._currentNumberIndices+=F.length+W.length;}
return this._numberTriangle=this._currentNumberIndices/3,!0;}}
return!1;},Q.calcOriginalBoudingBoxAndSphere=function(){for(var q=new Zq(2147483647,-2147483647),Q=0;Q<this._leafNum;Q++)q.x=this._leafs[Q]._sizeOfY.x<q.x?this._leafs[Q]._sizeOfY.x:q.x,q.y=this._leafs[Q]._sizeOfY.y>q.y?this._leafs[Q]._sizeOfY.y:q.y;var m=new _q(this._chunkOffsetX*Wq.CHUNK_GRID_NUM*this._gridSize,q.x,this._chunkOffsetZ*Wq.CHUNK_GRID_NUM*this._gridSize),a=new _q((this._chunkOffsetX+1)*Wq.CHUNK_GRID_NUM*this._gridSize,q.y,(this._chunkOffsetZ+1)*Wq.CHUNK_GRID_NUM*this._gridSize);Wq.__ADAPT_MATRIX__&&(_q.transformV3ToV3(m,Wq.__ADAPT_MATRIX__,m),_q.transformV3ToV3(a,Wq.__ADAPT_MATRIX__,a)),this._boundingBox=new GQ(m,a);var w=new _q();_q.subtract(a,m,w),_q.scale(w,.5,w);var e=new _q();_q.add(m,w,e),this._boundingSphere=new Jq(e,_q.scalarLength(w)),this._boundingBoxCorners=N(8,null),this._boundingBox.getCorners(this._boundingBoxCorners);},Q.calcLeafBoudingBox=function(q){for(var Q=0;Q<this._leafNum;Q++)this._leafs[Q].calcLeafBoudingBox(q);},Q.calcLeafBoudingSphere=function(q,Q){for(var m=0;m<this._leafNum;m++)this._leafs[m].calcLeafBoudingSphere(q,Q);},Q._getVertexBuffer=function(q){return void 0===q&&(q=0),0==q?this._vertexBuffer:null;},Q._getIndexBuffer=function(){return this._indexBuffer;},Q._getType=function(){return D._type;},Q._prepareRender=function(q){return!0;},Q._render=function(q){this._bufferState.bind(),J.instance.drawElements(qa.RENDER_LINE_MODEL?1:4,this._currentNumberIndices,5123,0),r.trianglesFaces+=this._numberTriangle,r.renderBatches++;},Q.destroy=function(){this._owner=null,this._bufferState.destroy(),this._vertexBuffer&&this._vertexBuffer.destroy(),this._indexBuffer&&this._indexBuffer.destroy();},y(D,["_TEMP_ARRAY_BUFFER",function(){return this._TEMP_ARRAY_BUFFER=new Uint32Array(Wq.CHUNK_GRID_NUM/Wq.LEAF_GRID_NUM*Wq.CHUNK_GRID_NUM/Wq.LEAF_GRID_NUM);},"_type",function(){return this._type=P._typeCounter++;}]),D;}(),pm=(function(q){function B(){this._shader=null,this._pyramid=null,this._intensity=0,this._threshold=1,this._softKnee=.5,this._diffusion=7,this._anamorphicRatio=0,this._dirtIntensity=0,this.clamp=65472,this.fastMode=!1,this.dirtTexture=null,B.__super.call(this),this._shaderData=new Fq(),this._linearColor=new tq(),this._shaderThreshold=new rq(),this._shaderParams=new rq(),this._shaderSetting=new rq(),this._dirtTileOffset=new rq(),this.color=new tq(1,1,1,1),this._shader=Bq.find("PostProcessBloom"),this._pyramid=new Array(32);}
S(B,"laya.d3.core.render.BloomEffect",Mq);var Q=B.prototype;Q.render=function(q){var Q=q.command,m=q.camera.viewport;this._shaderData.setTexture(B.SHADERVALUE_AUTOEXPOSURETEX,Y.whiteTexture);var a,w=this._anamorphicRatio,e=w<0?-w:0,F=0<w?w:0,W=Math.floor(m.width/(2-e)),s=Math.floor(m.height/(2-F)),D=Math.max(W,s);a=Math.log2(D)+this._diffusion-10;var d=Math.floor(a),v=Math.min(Math.max(d,1),16),y=.5+a-d;this._shaderData.setNumber(B.SHADERVALUE_SAMPLESCALE,y);var S=Rq.gammaToLinearSpace(this.threshold),t=S*this._softKnee+1e-5;this._shaderThreshold.setValue(S,S-t,2*t,.25/t),this._shaderData.setVector(B.SHADERVALUE_THRESHOLD,this._shaderThreshold);var o=Rq.gammaToLinearSpace(this.clamp);this._shaderParams.setValue(o,0,0,0),this._shaderData.setVector(B.SHADERVALUE_PARAMS,this._shaderParams);for(var b=this.fastMode?1:0,U=q.source,J=0;J<v;J++){var V=2*J,n=V+1,O=0==J?0+b:2+b,C=oa.getTemporary(W,s,0,3,1),l=oa.getTemporary(W,s,0,3,1);this._pyramid[V]=C,this._pyramid[n]=l,Q.blit(U,C,this._shader,this._shaderData,O),U=C,W=Math.max(W/2,1),s=Math.max(s/2,1);}
var u=this._pyramid[2*v-3];for(J=v-2;0<=J;J--)n=(V=2*J)+1,C=this._pyramid[V],l=this._pyramid[n],Q.setShaderDataTexture(this._shaderData,B.SHADERVALUE_BLOOMTEX,C),Q.blit(u,l,this._shader,this._shaderData,4+b),u=l;var f=this._linearColor;this.color.toLinear(f);var p=Math.pow(2,this._intensity/10)-1,T=this._shaderSetting;this._shaderSetting.setValue(y,p,this._dirtIntensity,v);var c=c||Y.blackTexture,r=c.width/c.height,_=m.width/m.height,Z=this._dirtTileOffset;Z.setValue(1,1,0,0),_<r?Z.setValue(_/r,1,.5*(1-Z.x),0):r<_&&Z.setValue(1,r/_,0,.5*(1-Z.y));var A=q.compositeShaderData,E=q.compositeDefineData;for(this.fastMode?E.add(pQ.SHADERDEFINE_BLOOM_LOW):E.add(pQ.SHADERDEFINE_BLOOM),A.setVector(pQ.SHADERVALUE_BLOOM_DIRTTILEOFFSET,Z),A.setVector(pQ.SHADERVALUE_BLOOM_SETTINGS,T),A.setVector(pQ.SHADERVALUE_BLOOM_COLOR,new rq(f.r,f.g,f.b,f.a)),A.setTexture(pQ.SHADERVALUE_BLOOM_DIRTTEX,c),A.setTexture(pQ.SHADERVALUE_BLOOMTEX,u),J=0;J<v;J++)n=(V=2*J)+1,this._pyramid[V]!=u&&oa.setReleaseTemporary(this._pyramid[V]),this._pyramid[n]!=u&&oa.setReleaseTemporary(this._pyramid[n]);q.tempRenderTextures.push(u);},d(0,Q,"softKnee",function(){return this._softKnee;},function(q){this._softKnee=Math.min(Math.max(q,0),1);}),d(0,Q,"intensity",function(){return this._intensity;},function(q){this._intensity=Math.max(q,0);}),d(0,Q,"threshold",function(){return this._threshold;},function(q){this._threshold=Math.max(q,0);}),d(0,Q,"anamorphicRatio",function(){return this._anamorphicRatio;},function(q){this._anamorphicRatio=Math.min(Math.max(q,-1),1);}),d(0,Q,"diffusion",function(){return this._diffusion;},function(q){this._diffusion=Math.min(Math.max(q,1),10);}),d(0,Q,"dirtIntensity",function(){return this._dirtIntensity;},function(q){this._dirtIntensity=Math.max(q,0);}),B.SUBSHADER_PREFILTER13=0,B.SUBSHADER_PREFILTER4=1,B.SUBSHADER_DOWNSAMPLE13=2,B.SUBSHADER_DOWNSAMPLE4=3,B.SUBSHADER_UPSAMPLETENT=4,B.SUBSHADER_UPSAMPLEBOX=5,B.MAXPYRAMIDSIZE=16,y(B,["SHADERVALUE_MAINTEX",function(){return this.SHADERVALUE_MAINTEX=Bq.propertyNameToID("u_MainTex");},"SHADERVALUE_AUTOEXPOSURETEX",function(){return this.SHADERVALUE_AUTOEXPOSURETEX=Bq.propertyNameToID("u_AutoExposureTex");},"SHADERVALUE_SAMPLESCALE",function(){return this.SHADERVALUE_SAMPLESCALE=Bq.propertyNameToID("u_SampleScale");},"SHADERVALUE_THRESHOLD",function(){return this.SHADERVALUE_THRESHOLD=Bq.propertyNameToID("u_Threshold");},"SHADERVALUE_PARAMS",function(){return this.SHADERVALUE_PARAMS=Bq.propertyNameToID("u_Params");},"SHADERVALUE_BLOOMTEX",function(){return this.SHADERVALUE_BLOOMTEX=Bq.propertyNameToID("u_BloomTex");}]);}(),function(q){function w(){this._shaderData=null,this._nameID=0,this._texture=null,w.__super.call(this);}
S(w,"laya.d3.core.render.command.SetShaderDataTextureCMD",h);var Q=w.prototype;return Q.run=function(){this._shaderData.setTexture(this._nameID,this._texture);},Q.recover=function(){w._pool.push(this),this._shaderData=null,this._nameID=0,this._texture=null;},w.create=function(q,Q,m){var a;return(a=0<w._pool.length?w._pool.pop():new w())._shaderData=q,a._nameID=Q,a._texture=m,a;},w._pool=[],w;}()),Tm=function(m){function q(){this.radius=NaN,this.emitFromShell=!1,q.__super.call(this),this.radius=1,this.emitFromShell=!1,this.randomDirection=!1;}
S(q,"laya.d3.core.particleShuriKen.module.shape.SphereShape",m);var Q=q.prototype;return Q._getShapeBoundBox=function(q){var Q=q.min;Q.x=Q.y=Q.z=-this.radius;var m=q.max;m.x=m.y=m.z=this.radius;},Q._getSpeedBoundBox=function(q){var Q=q.min;Q.x=Q.y=Q.z=-1;var m=q.max;m.x=m.y=m.z=1;},Q.generatePositionAndDirection=function(q,Q,m,a){m?(m.seed=a[16],this.emitFromShell?_Q._randomPointUnitSphere(q,m):_Q._randomPointInsideUnitSphere(q,m),a[16]=m.seed):this.emitFromShell?_Q._randomPointUnitSphere(q):_Q._randomPointInsideUnitSphere(q),_q.scale(q,this.radius,q),this.randomDirection?m?(m.seed=a[17],_Q._randomPointUnitSphere(Q,m),a[17]=m.seed):_Q._randomPointUnitSphere(Q):q.cloneTo(Q);},Q.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;Q.radius=this.radius,Q.emitFromShell=this.emitFromShell,Q.randomDirection=this.randomDirection;},q;}(K),cm=function(m){function q(){q.__super.call(this),this.inTangent=new _q(),this.outTangent=new _q(),this.value=new _q();}
return S(q,"laya.d3.core.Vector3Keyframe",m),q.prototype.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;this.inTangent.cloneTo(Q.inTangent),this.outTangent.cloneTo(Q.outTangent),this.value.cloneTo(Q.value);},q;}(Dq),rm=function(q){function n(q,Q){this._stacks=0,this._slices=0,n.__super.call(this),void 0===q&&(q=48),void 0===Q&&(Q=48),this._stacks=q,this._slices=Q;for(var m=X.vertexDeclaration,a=m.vertexStride/4,w=(this._stacks+1)*(this._slices+1),e=3*this._stacks*(this._slices+1)*2,F=new Float32Array(w*a),W=new Uint16Array(e),s=Math.PI/this._stacks,D=2*Math.PI/this._slices,d=0,v=0,y=0,S=0;S<this._stacks+1;S++)
for(var t=Math.sin(S*s),o=Math.cos(S*s),b=0;b<this._slices+1;b++){var U=t*Math.sin(b*D),J=t*Math.cos(b*D);F[v+0]=U*n._radius,F[v+1]=o*n._radius,F[v+2]=J*n._radius,F[v+3]=-b/this._slices+.75,F[v+4]=S/this._stacks,v+=a,S!=this._stacks-1&&(W[y++]=d+1,W[y++]=d,W[y++]=d+(this._slices+1),W[y++]=d+(this._slices+1),W[y++]=d,W[y++]=d+this._slices,d++);}
this._vertexBuffer=new HQ(4*F.length,35044,!1),this._vertexBuffer.vertexDeclaration=m,this._indexBuffer=new gQ("ushort",W.length,35044,!1),this._vertexBuffer.setData(F),this._indexBuffer.setData(W);var V=new PQ();V.bind(),V.applyVertexBuffer(this._vertexBuffer),V.applyIndexBuffer(this._indexBuffer),V.unBind(),this._bufferState=V;}
S(n,"laya.d3.resource.models.SkyDome",Oq);var Q=n.prototype;return Q._render=function(q){var Q=this._indexBuffer.indexCount;J.instance.drawElements(4,Q,5123,0),r.trianglesFaces+=Q/3,r.renderBatches++;},d(0,Q,"stacks",function(){return this._stacks;}),d(0,Q,"slices",function(){return this._slices;}),n.__init__=function(){n.instance=new n();},n._radius=1,n.instance=null,n;}(),_m=function(q){function a(q,Q,m){switch(this._radius=1,this._height=.5,a.__super.call(this),void 0===q&&(q=.5),void 0===Q&&(Q=1),void 0===m&&(m=1),this._radius=q,this._height=Q,this._orientation=m,this._type=2,m){case 0:this._nativeShape=new R._physics3D.btConeShapeX(q,Q);break;case 1:this._nativeShape=new R._physics3D.btConeShape(q,Q);break;case 2:this._nativeShape=new R._physics3D.btConeShapeZ(q,Q);break;default:throw"ConeColliderShape:unknown orientation.";}}
S(a,"laya.d3.physics.shape.ConeColliderShape",k);var Q=a.prototype;return Q.clone=function(){var q=new a(this._radius,this._height,this._orientation);return this.cloneTo(q),q;},d(0,Q,"radius",function(){return this._radius;}),d(0,Q,"height",function(){return this._height;}),d(0,Q,"orientation",function(){return this._orientation;}),a;}(),Zm=function(m){function q(){this.x=NaN,this.y=NaN,this.z=NaN,q.__super.call(this),this.x=1,this.y=1,this.z=1,this.randomDirection=!1;}
S(q,"laya.d3.core.particleShuriKen.module.shape.BoxShape",m);var Q=q.prototype;return Q._getShapeBoundBox=function(q){var Q=q.min;Q.x=.5* -this.x,Q.y=.5* -this.y,Q.z=.5* -this.z;var m=q.max;m.x=.5*this.x,m.y=.5*this.y,m.z=.5*this.z;},Q._getSpeedBoundBox=function(q){var Q=q.min;Q.x=0,Q.y=0,Q.z=0;var m=q.max;m.x=0,m.y=1,m.z=0;},Q.generatePositionAndDirection=function(q,Q,m,a){m?(m.seed=a[16],_Q._randomPointInsideHalfUnitBox(q,m),a[16]=m.seed):_Q._randomPointInsideHalfUnitBox(q),q.x=this.x*q.x,q.y=this.y*q.y,q.z=this.z*q.z,this.randomDirection?m?(m.seed=a[17],_Q._randomPointUnitSphere(Q,m),a[17]=m.seed):_Q._randomPointUnitSphere(Q):(Q.x=0,Q.y=0,Q.z=1);},Q.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;Q.x=this.x,Q.y=this.y,Q.z=this.z,Q.randomDirection=this.randomDirection;},q;}(K),Am=function(m){function q(){q.__super.call(this),this.inTangent=new rq(),this.outTangent=new rq(),this.value=new eq();}
return S(q,"laya.d3.core.QuaternionKeyframe",m),q.prototype.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;this.inTangent.cloneTo(Q.inTangent),this.outTangent.cloneTo(Q.outTangent),this.value.cloneTo(Q.value);},q;}(Dq),Em=function(q){function Q(){Q.__super.call(this),this._dynamicWorldPositionNormalNeedUpdate=!0;}
S(Q,"laya.d3.core.render.SubMeshRenderElement",q);var m=Q.prototype;return m._onWorldMatrixChanged=function(){this._dynamicWorldPositionNormalNeedUpdate=!0;},m._computeWorldPositionsAndNormals=function(q,Q,m,a){if(this._dynamicWorldPositionNormalNeedUpdate){for(var w=this._geometry,e=w._vertexBuffer,F=e.vertexDeclaration.vertexStride/4,W=e.getData(),s=this._transform.worldMatrix,D=this._transform.rotation,d=w._indices,v=0;v<a;v++){var y=(m?d[v]:v)*F,S=3*v;Rq.transformVector3ArrayToVector3ArrayCoordinate(W,y+q,s,this._dynamicWorldPositions,S),-1!==Q&&Rq.transformVector3ArrayByQuat(W,y+Q,D,this._dynamicWorldNormals,S);}
this._dynamicWorldPositionNormalNeedUpdate=!1;}},m.setTransform=function(q){this._transform!==q&&(this._transform&&this._transform.off("transformchanged",this,this._onWorldMatrixChanged),q&&q.on("transformchanged",this,this._onWorldMatrixChanged),this._dynamicWorldPositionNormalNeedUpdate=!0,this._transform=q);},m.setGeometry=function(q){if(this._geometry!==q){var Q=q,m=Q._mesh;if(m){var a=1<m._subMeshCount,w=a?Q._indexCount:m._vertexCount;if(w<=10){var e=3*w;this._dynamicVertexBatch=!0,this._dynamicWorldPositions=new Float32Array(e),this._dynamicWorldNormals=new Float32Array(e),this._dynamicVertexCount=w,this._dynamicMultiSubMesh=a;}else this._dynamicVertexBatch=!1;}
this._geometry=q;}},m.addToOpaqueRenderQueue=function(q,Q){var m=this.staticBatch,a=Q.elements;if(m){var w=nm.instance,e=w.getBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,m._batchID);if(w._updateCountMark===e.updateMark){var F=e.indexInList;if(e.batched)a[F].staticBatchElementList.push(this);else{var W=a[F],s=W.render,D=w._getBatchRenderElementFromPool();D.renderType=1,D.setGeometry(m),D.material=W.material;var d=m.batchOwner,v=d?d._transform:null;D.setTransform(v),D.render=s;var y=D.staticBatchElementList;y.length=0,y.push(W),y.push(this),a[F]=D,e.batched=!0;}}else e.updateMark=w._updateCountMark,e.indexInList=a.length,e.batched=!1,a.push(this);}else if(this.material._shader._enableInstancing&&E._angleInstancedArrays){var S=this._geometry,t=Wm.instance,o=t.getInstanceBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,S._id);if(t._updateCountMark===o.updateMark){var b=o.indexInList;if(o.batched){var U=a[b].instanceBatchElementList;U.length===Um.instance.maxInstanceCount?(o.updateMark=t._updateCountMark,o.indexInList=a.length,o.batched=!1,a.push(this)):U.push(this);}else{var J=a[b],V=J.render,n=t._getBatchRenderElementFromPool();n.renderType=2,n.setGeometry(Um.instance),n.material=J.material,n.setTransform(null),n.render=V,n.instanceSubMesh=S;var O=n.instanceBatchElementList;O.length=0,O.push(J),O.push(this),a[b]=n,o.batched=!0;}}else o.updateMark=t._updateCountMark,o.indexInList=a.length,o.batched=!1,a.push(this);}else if(this._dynamicVertexBatch){var C=this._geometry._vertexBuffer.vertexDeclaration,l=Wm.instance,u=l.getVertexBatchOpaquaMark(this.render.lightmapIndex+1,this.render.receiveShadow,this.material.id,C.id);if(l._updateCountMark===u.updateMark){var f=u.indexInList;if(u.batched)a[f].vertexBatchElementList.push(this);else{var p=a[f],T=p.render,c=l._getBatchRenderElementFromPool();c.renderType=3,c.setGeometry(Om.instance),c.material=p.material,c.setTransform(null),c.render=T,c.vertexBatchVertexDeclaration=C;var r=c.vertexBatchElementList;r.length=0,r.push(p),r.push(this),a[f]=c,u.batched=!0;}}else u.updateMark=l._updateCountMark,u.indexInList=a.length,u.batched=!1,a.push(this);}else a.push(this);},m.addToTransparentRenderQueue=function(q,Q){var m=this.staticBatch,a=Q.elements;if(m){var w=nm.instance,e=Q.lastTransparentRenderElement;if(e){var F=e.render;if(e._geometry._getType()!==this._geometry._getType()||e.staticBatch!==m||e.material!==this.material||F.receiveShadow!==this.render.receiveShadow||F.lightmapIndex!==this.render.lightmapIndex)a.push(this),Q.lastTransparentBatched=!1;else{if(Q.lastTransparentBatched)a[a.length-1].staticBatchElementList.push(this);else{var W=w._getBatchRenderElementFromPool();W.renderType=1,W.setGeometry(m),W.material=e.material;var s=m.batchOwner,D=s?s._transform:null;W.setTransform(D),W.render=this.render;var d=W.staticBatchElementList;d.length=0,d.push(e),d.push(this),a[a.length-1]=W;}
Q.lastTransparentBatched=!0;}}else a.push(this),Q.lastTransparentBatched=!1;}else if(this.material._shader._enableInstancing&&E._angleInstancedArrays){var v=this._geometry,y=Wm.instance,S=Q.lastTransparentRenderElement;if(S){var t=S.render;if(S._geometry._getType()!==this._geometry._getType()||S._geometry!==v||S.material!==this.material||t.receiveShadow!==this.render.receiveShadow||t.lightmapIndex!==this.render.lightmapIndex)a.push(this),Q.lastTransparentBatched=!1;else{if(Q.lastTransparentBatched)a[a.length-1].instanceBatchElementList.push(this);else{var o=y._getBatchRenderElementFromPool();o.renderType=2,o.setGeometry(Um.instance),o.material=S.material,o.setTransform(null),o.render=this.render,o.instanceSubMesh=v;var b=o.instanceBatchElementList;b.length=0,b.push(S),b.push(this),a[a.length-1]=o;}
Q.lastTransparentBatched=!0;}}else a.push(this),Q.lastTransparentBatched=!1;}else if(this._dynamicVertexBatch){var U=this._geometry._vertexBuffer.vertexDeclaration,J=Wm.instance,V=Q.lastTransparentRenderElement;if(V){var n=V.render;if(V._geometry._getType()!==this._geometry._getType()||V._geometry._vertexBuffer._vertexDeclaration!==U||V.material!==this.material||n.receiveShadow!==this.render.receiveShadow||n.lightmapIndex!==this.render.lightmapIndex)a.push(this),Q.lastTransparentBatched=!1;else{if(Q.lastTransparentBatched)a[a.length-1].vertexBatchElementList.push(this);else{var O=J._getBatchRenderElementFromPool();O.renderType=3,O.setGeometry(Om.instance),O.material=V.material,O.setTransform(null),O.render=this.render,O.vertexBatchVertexDeclaration=U;var C=O.vertexBatchElementList;C.length=0,C.push(V),C.push(this),a[a.length-1]=O;}
Q.lastTransparentBatched=!0;}}else a.push(this),Q.lastTransparentBatched=!1;}else a.push(this);Q.lastTransparentRenderElement=this;},m.destroy=function(){q.prototype.destroy.call(this),this._dynamicWorldPositions=null,this._dynamicWorldNormals=null,this.staticBatch=null,this.staticBatchElementList=null,this.vertexBatchElementList=null,this.vertexBatchVertexDeclaration=null;},Q._maxInstanceCount=1024,y(Q,["_instanceMatrixData",function(){return this._instanceMatrixData=new Float32Array(16*Q._maxInstanceCount);},"_instanceMatrixBuffer",function(){return this._instanceMatrixBuffer=new HQ(4*Q._instanceMatrixData.length,35048);}]),Q;}(Vq),Bm=function(q){function t(q,Q,m,a,w,e,F,W,s,D,d,v,y,S){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,t.__super.call(this),this._cornerTextureCoordinate=q,this._positionStartLifeTime=Q,this._velocity=m,this._startColor=a,this._startSize=w,this._startRotation0=e,this._startRotation1=F,this._startRotation2=W,this._startLifeTime=s,this._time=D,this._startSpeed=d,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=S;}
S(t,"laya.d3.graphics.Vertex.VertexShurikenParticleBillboard",sq);var Q=t.prototype;return d(0,Q,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate;}),d(0,Q,"random1",function(){return this._randoms1;}),d(0,Q,"startRotation2",function(){return this._startRotation2;}),d(0,Q,"positionStartLifeTime",function(){return this._positionStartLifeTime;}),d(0,Q,"velocity",function(){return this._velocity;}),d(0,Q,"random0",function(){return this._randoms0;}),d(0,Q,"startSize",function(){return this._startSize;}),d(0,Q,"startColor",function(){return this._startColor;}),d(0,Q,"startRotation0",function(){return this._startRotation0;}),d(0,Q,"startRotation1",function(){return this._startRotation1;}),d(0,Q,"startLifeTime",function(){return this._startLifeTime;}),d(0,Q,"time",function(){return this._time;}),d(0,Q,"startSpeed",function(){return this._startSpeed;}),d(0,Q,"simulationWorldPostion",function(){return this._simulationWorldPostion;}),d(1,t,"vertexDeclaration",function(){return t._vertexDeclaration;},laya.d3.graphics.Vertex.VertexShuriKenParticle._$SET_vertexDeclaration),y(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new tQ(152,[new Gq(0,"vector4",0),new Gq(16,"vector4",4),new Gq(32,"vector4",5),new Gq(48,"vector4",6),new Gq(64,"vector3",8),new Gq(76,"vector3",9),new Gq(88,"single",10),new Gq(92,"vector4",11),new Gq(108,"vector4",12),new Gq(124,"vector3",13),new Gq(136,"vector4",14)]);}]),t;}(),Nm=function(q){function t(q,Q,m,a,w,e,F,W,s,D,d,v,y,S){this._cornerTextureCoordinate=null,this._positionStartLifeTime=null,this._velocity=null,this._startColor=null,this._startSize=null,this._startRotation0=null,this._startRotation1=null,this._startRotation2=null,this._startLifeTime=NaN,this._time=NaN,this._startSpeed=NaN,this._randoms0=null,this._randoms1=null,this._simulationWorldPostion=null,t.__super.call(this),this._cornerTextureCoordinate=q,this._positionStartLifeTime=Q,this._velocity=m,this._startColor=a,this._startSize=w,this._startRotation0=e,this._startRotation1=F,this._startRotation2=W,this._startLifeTime=s,this._time=D,this._startSpeed=d,this._randoms0=this.random0,this._randoms1=this.random1,this._simulationWorldPostion=S;}
S(t,"laya.d3.graphics.Vertex.VertexShurikenParticleMesh",sq);var Q=t.prototype;return d(0,Q,"cornerTextureCoordinate",function(){return this._cornerTextureCoordinate;}),d(0,Q,"velocity",function(){return this._velocity;}),d(0,Q,"position",function(){return this._positionStartLifeTime;}),d(0,Q,"random0",function(){return this._randoms0;}),d(0,Q,"startSize",function(){return this._startSize;}),d(0,Q,"startColor",function(){return this._startColor;}),d(0,Q,"startRotation0",function(){return this._startRotation0;}),d(0,Q,"startRotation1",function(){return this._startRotation1;}),d(0,Q,"random1",function(){return this._randoms1;}),d(0,Q,"startRotation2",function(){return this._startRotation2;}),d(0,Q,"startLifeTime",function(){return this._startLifeTime;}),d(0,Q,"time",function(){return this._time;}),d(0,Q,"startSpeed",function(){return this._startSpeed;}),d(0,Q,"simulationWorldPostion",function(){return this._simulationWorldPostion;}),d(1,t,"vertexDeclaration",function(){return t._vertexDeclaration;},laya.d3.graphics.Vertex.VertexShuriKenParticle._$SET_vertexDeclaration),y(t,["_vertexDeclaration",function(){return this._vertexDeclaration=new tQ(172,[new Gq(0,"vector3",1),new Gq(12,"vector4",2),new Gq(28,"vector2",3),new Gq(36,"vector4",4),new Gq(52,"vector4",5),new Gq(68,"vector4",6),new Gq(84,"vector3",8),new Gq(96,"vector3",9),new Gq(108,"single",10),new Gq(112,"vector4",11),new Gq(128,"vector4",12),new Gq(144,"vector3",13),new Gq(156,"vector4",14)]);}]),t;}(),Mm=function(W){function s(q,Q){this._needProcessCollisions=!1,this._needProcessTriggers=!1,s.__super.call(this),void 0===Q&&(Q=!1),this._id=++s._uniqueIDCounter,this._transform=new $Q(this),this._isStatic=Q,this.layer=0,this.name=q||"New Sprite3D";}
S(s,"laya.d3.core.Sprite3D",W);var q=s.prototype;return o.imps(q,{"laya.resource.ICreateResource":!0}),q._setCreateURL=function(q){this._url=Z.formatURL(q);},q._changeAnimatorsToLinkSprite3D=function(q,Q,m){var a=this.getComponent(jQ);if(a&&(a.avatar||q._changeAnimatorToLinkSprite3DNoAvatar(a,Q,m)),this._parent&&this._parent instanceof laya.d3.core.Sprite3D){m.unshift(this._parent.name);var w=this._parent;w._hierarchyAnimator&&w._changeAnimatorsToLinkSprite3D(q,Q,m);}},q._setHierarchyAnimator=function(q,Q){this._changeHierarchyAnimator(q),this._changeAnimatorAvatar(q.avatar);for(var m=0,a=this._children.length;m<a;m++){var w=this._children[m];w._hierarchyAnimator==Q&&w._setHierarchyAnimator(q,Q);}},q._clearHierarchyAnimator=function(q,Q){this._changeHierarchyAnimator(Q),this._changeAnimatorAvatar(Q?Q.avatar:null);for(var m=0,a=this._children.length;m<a;m++){var w=this._children[m];w._hierarchyAnimator==q&&w._clearHierarchyAnimator(q,Q);}},q._changeHierarchyAnimatorAvatar=function(q,Q){this._changeAnimatorAvatar(Q);for(var m=0,a=this._children.length;m<a;m++){var w=this._children[m];w._hierarchyAnimator==q&&w._changeHierarchyAnimatorAvatar(q,Q);}},q._changeAnimatorToLinkSprite3DNoAvatar=function(q,Q,m){q._handleSpriteOwnersBySprite(Q,m,this);for(var a=0,w=this._children.length;a<w;a++){var e=this._children[a],F=m.length;m.push(e.name),e._changeAnimatorToLinkSprite3DNoAvatar(q,Q,m),m.splice(F,1);}},q._changeHierarchyAnimator=function(q){this._hierarchyAnimator=q;},q._changeAnimatorAvatar=function(q){},q._onAdded=function(){if(this._parent instanceof laya.d3.core.Sprite3D){var q=this._parent;this.transform._setParent(q.transform),q._hierarchyAnimator&&(!this._hierarchyAnimator&&this._setHierarchyAnimator(q._hierarchyAnimator,null),q._changeAnimatorsToLinkSprite3D(this,!0,[this.name]));}
W.prototype._onAdded.call(this);},q._onRemoved=function(){if(W.prototype._onRemoved.call(this),this._parent instanceof laya.d3.core.Sprite3D){var q=this._parent;this.transform._setParent(null),q._hierarchyAnimator&&(this._hierarchyAnimator==q._hierarchyAnimator&&this._clearHierarchyAnimator(q._hierarchyAnimator,null),q._changeAnimatorsToLinkSprite3D(this,!1,[this.name]));}},q._parse=function(q,Q){if(void 0!==q.isStatic&&(this._isStatic=q.isStatic),void 0!==q.active&&(this.active=q.active),null!=q.name&&(this.name=q.name),void 0!==q.position){var m=this.transform.localPosition;m.fromArray(q.position),this.transform.localPosition=m;}
if(void 0!==q.rotationEuler){var a=this.transform.localRotationEuler;a.fromArray(q.rotationEuler),this.transform.localRotationEuler=a;}
if(void 0!==q.rotation){var w=this.transform.localRotation;w.fromArray(q.rotation),this.transform.localRotation=w;}
if(void 0!==q.scale){var e=this.transform.localScale;e.fromArray(q.scale),this.transform.localScale=e;}
null!=q.layer&&(this.layer=q.layer);},q._cloneTo=function(q,Q,m){if(this.destroyed)throw new Error("Sprite3D: Can't be cloned if the Sprite3D has destroyed.");var a=q;a.name=this.name,a.destroyed=this.destroyed,a.active=this.active;var w=a.transform.localPosition;this.transform.localPosition.cloneTo(w),a.transform.localPosition=w;var e=a.transform.localRotation;this.transform.localRotation.cloneTo(e),a.transform.localRotation=e;var F=a.transform.localScale;this.transform.localScale.cloneTo(F),a.transform.localScale=F,a._isStatic=this._isStatic,a.layer=this.layer,W.prototype._cloneTo.call(this,a,Q,m);},q.clone=function(){var q=s._createSprite3DInstance(this);return s._parseSprite3DInstance(this,q,this,q),q;},q.destroy=function(q){void 0===q&&(q=!0),this.destroyed||(W.prototype.destroy.call(this,q),this._transform=null,this._scripts=null,this._url&&uq.clearRes(this._url));},d(0,q,"id",function(){return this._id;}),d(0,q,"url",function(){return this._url;}),d(0,q,"layer",function(){return this._layer;},function(q){if(this._layer!==q){if(!(0<=q&&q<=30))throw new Error("Layer value must be 0-30.");this._layer=q;}}),d(0,q,"transform",function(){return this._transform;}),d(0,q,"isStatic",function(){return this._isStatic;}),s._parse=function(q,Q,m){var a,w=q.data,e=[];switch(q.version){case"LAYAHIERARCHY:02":a=Rq._createNodeByJson02(w,e);break;default:a=Rq._createNodeByJson(w,e);}
return j.combine(a,e),a;},s.__init__=function(){},s.instantiate=function(q,Q,m,a,w){void 0===m&&(m=!0);var e=q.clone();Q&&Q.addChild(e);var F=e.transform;if(m){var W=F.worldMatrix;q.transform.worldMatrix.cloneTo(W),F.worldMatrix=W;}else a&&(F.position=a),w&&(F.rotation=w);return e;},s.load=function(q,Q){o.loader.create(q,Q,null,"HIERARCHY");},s._createSprite3DInstance=function(q){for(var Q=new q.constructor(),m=q._children,a=0,w=m.length;a<w;a++){var e=s._createSprite3DInstance(m[a]);Q.addChild(e);}
return Q;},s._parseSprite3DInstance=function(q,Q,m,a){for(var w=m._children,e=a._children,F=0,W=w.length;F<W;F++)s._parseSprite3DInstance(q,Q,w[F],e[F]);m._cloneTo(a,q,Q);},s._uniqueIDCounter=0,y(s,["WORLDMATRIX",function(){return this.WORLDMATRIX=Bq.propertyNameToID("u_WorldMat");},"MVPMATRIX",function(){return this.MVPMATRIX=Bq.propertyNameToID("u_MvpMatrix");}]),s;}(Q),Ym=function(w){function Q(){this._shaderValues=null,Q.__super.call(this),this._defineDatas=new Lq(),this._disablePublicDefineDatas=new Lq(),this._shaderValues=new Fq(this),this.renderQueue=2e3,this._alphaTest=!1;}
S(Q,"laya.d3.core.material.BaseMaterial",w);var q=Q.prototype;return o.imps(q,{"laya.d3.core.IClone":!0}),q._removeTetxureReference=function(){var q=this._shaderValues.getData();for(var Q in q){var m=q[Q];m&&m instanceof laya.resource.BaseTexture&&m._removeReference();}},q._addReference=function(q){void 0===q&&(q=1),w.prototype._addReference.call(this,q);var Q=this._shaderValues.getData();for(var m in Q){var a=Q[m];a&&a instanceof laya.resource.BaseTexture&&a._addReference();}},q._removeReference=function(q){void 0===q&&(q=1),w.prototype._removeReference.call(this,q),this._removeTetxureReference();},q._disposeResource=function(){0<this._referenceCount&&this._removeTetxureReference(),this._shaderValues=null;},q.setShaderName=function(q){if(this._shader=Bq.find(q),!this._shader)throw new Error("BaseMaterial: unknown shader name.");},q.cloneTo=function(q){var Q=q;Q.name=this.name,Q.renderQueue=this.renderQueue,this._disablePublicDefineDatas.cloneTo(Q._disablePublicDefineDatas),this._defineDatas.cloneTo(Q._defineDatas),this._shaderValues.cloneTo(Q._shaderValues);},q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,q,"alphaTestValue",function(){return this._shaderValues.getNumber(Q.ALPHATESTVALUE);},function(q){this._shaderValues.setNumber(Q.ALPHATESTVALUE,q);}),d(0,q,"alphaTest",function(){return this._alphaTest;},function(q){(this._alphaTest=q)?this._defineDatas.add(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST):this._defineDatas.remove(laya.d3.core.material.BaseMaterial.SHADERDEFINE_ALPHATEST);}),Q.load=function(q,Q){o.loader.create(q,Q,null,"MATERIAL");},Q.__init__=function(){Q.SHADERDEFINE_ALPHATEST=Q.shaderDefines.registerDefine("ALPHATEST");},Q._parse=function(q,Q,m){var a,w=q,e=w.props,F=e.type.split("."),W=O.window;if(F.forEach(function(q){W=W[q];}),"function"!=typeof W)throw"_getSprite3DHierarchyInnerUrls 错误: "+q.type+" 不是类";switch(a=new W(),w.version){case"LAYAMATERIAL:01":case"LAYAMATERIAL:02":var s=0,D=0;for(var d in e)switch(d){case"vectors":var v=e[d];for(s=0,D=v.length;s<D;s++){var y=v[s],S=y.value;switch(S.length){case 2:a[y.name]=new Zq(S[0],S[1]);break;case 3:a[y.name]=new _q(S[0],S[1],S[2]);break;case 4:a[y.name]=new rq(S[0],S[1],S[2],S[3]);break;default:throw new Error("BaseMaterial:unkonwn color length.");}}
break;case"textures":var t=e[d];for(s=0,D=t.length;s<D;s++){var o=t[s],b=o.path;b&&(a[o.name]=uq.getRes(b));}
break;case"defines":var U=e[d];for(s=0,D=U.length;s<D;s++){var J=a._shader.getSubShaderAt(0).getMaterialDefineByName(U[s]);a._defineDatas.add(J);}
break;case"renderStates":var V=e[d][0],n=a;n.blend=V.blend,n.cull=V.cull,n.depthTest=V.depthTest,n.depthWrite=V.depthWrite,n.blendSrc=V.srcBlend,n.blendDst=V.dstBlend;break;case"cull":a.cull=e[d];break;case"blend":a.blend=e[d];break;case"depthWrite":a.depthWrite=e[d];break;case"srcBlend":a.blendSrc=e[d];break;case"dstBlend":a.blendDst=e[d];break;default:a[d]=e[d];}
break;default:throw new Error("BaseMaterial:unkonwn version.");}
return a;},Q.RENDERQUEUE_OPAQUE=2e3,Q.RENDERQUEUE_ALPHATEST=2450,Q.RENDERQUEUE_TRANSPARENT=3e3,Q.SHADERDEFINE_ALPHATEST=0,y(Q,["ALPHATESTVALUE",function(){return this.ALPHATESTVALUE=Bq.propertyNameToID("u_AlphaTestValue");},"shaderDefines",function(){return this.shaderDefines=new dq();}]),Q;}(u),xm=function(q){function Q(){this._vertexBuffer=null,Q.__super.call(this),this._bufferState=new PQ(),this._vertexBuffer=new HQ(64,35044,!1),this._vertexBuffer.vertexDeclaration=laya.d3.core.render.ScreenQuad._vertexDeclaration,this._vertexBuffer.setData(Q._vertices),this._bufferState.bind(),this._bufferState.applyVertexBuffer(this._vertexBuffer),this._bufferState.unBind(),this._setGPUMemory(this._vertexBuffer._byteLength);}
S(Q,"laya.d3.core.render.ScreenQuad",q);var m=Q.prototype;return m.render=function(){this._bufferState.bind(),J.instance.drawArrays(5,0,4),r.renderBatches++;},m.destroy=function(){q.prototype.destroy.call(this),this._bufferState.destroy(),this._vertexBuffer.destroy(),this._setGPUMemory(0);},Q.__init__=function(){(Q.instance=new Q()).lock=!0;},Q.SCREENQUAD_POSITION_UV=0,Q.instance=null,y(Q,["_vertexDeclaration",function(){return this._vertexDeclaration=new tQ(16,[new Gq(0,"vector4",0)]);},"_vertices",function(){return this._vertices=new Float32Array([1,1,1,0,1,-1,1,1,-1,1,0,0,-1,-1,0,1]);}]),Q;}(u),Lm=function(q){function e(){this._rootNode=null,this._nativeNodeCount=0,this._nativeCurCloneCount=0,e.__super.call(this);}
S(e,"laya.d3.core.Avatar",u);var Q=e.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q._initCloneToAnimator=function(q,Q){for(var m=0,a=(Q._avatarNodeMap[q.name]=q).getChildCount();m<a;m++)this._initCloneToAnimator(q.getChildByIndex(m),Q);},Q._parseNode=function(q,Q){var m=q.props.name;Q.name=m;var a=q.props,w=Q.transform,e=w.localPosition,F=w.localRotation,W=w.localScale;e.fromArray(a.translate),F.fromArray(a.rotation),W.fromArray(a.scale),w.localPosition=e,w.localRotation=F,w.localScale=W;for(var s=q.child,D=0,d=s.length;D<d;D++){var v=s[D],y=new fQ(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16));Q.addChild(y),M.supportWebGLPlusAnimation&&this._nativeNodeCount++,this._parseNode(v,y);}},Q._cloneDatasToAnimator=function(q){var Q;Q=this._rootNode.clone();var m=this._rootNode.transform,a=Q.transform,w=a.localPosition,e=a.localRotation,F=a.localScale;m.localPosition.cloneTo(w),m.localRotation.cloneTo(e),m.localScale.cloneTo(F),a.localPosition=w,a.localRotation=e,a.localScale=F,q._avatarNodeMap={},this._initCloneToAnimator(Q,q);},Q.cloneTo=function(q){var Q=q,m=this._rootNode.clone();Q._rootNode=m;},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},Q._cloneDatasToAnimatorNative=function(q){var Q=new Float32Array(3*this._nativeNodeCount),m=new Float32Array(4*this._nativeNodeCount),a=new Float32Array(3*this._nativeNodeCount),w=new Float32Array(16*this._nativeNodeCount),e=new Int16Array(this._nativeNodeCount);q._animationNodeLocalPositions=Q,q._animationNodeLocalRotations=m,q._animationNodeLocalScales=a,q._animationNodeWorldMatrixs=w,q._animationNodeParentIndices=e,this._nativeCurCloneCount=0;var F=this._rootNode._cloneNative(Q,m,a,w,e,-1,this),W=this._rootNode.transform,s=F.transform,D=s.localPosition,d=s.localRotation,v=s.localScale;W.localPosition.cloneTo(D),W.localRotation.cloneTo(d),W.localScale.cloneTo(v),s.localPosition=D,s.localRotation=d,s.localScale=v,q._avatarNodeMap={},this._initCloneToAnimator(F,q);},e._parse=function(q,Q,m){var a=new e();if(a._rootNode=new fQ(new Float32Array(3),new Float32Array(4),new Float32Array(3),new Float32Array(16)),M.supportWebGLPlusAnimation&&a._nativeNodeCount++,q.version){var w=q.rootNode;w&&a._parseNode(w,a._rootNode);}
return a;},e.load=function(q,Q){o.loader.create(q,Q,null,"AVATAR");},e;}(),Gm=function(q){function J(){this._nativeTriangleMesh=null,this._bounds=null,this._subMeshCount=0,this._subMeshes=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null,this._inverseBindPosesBuffer=null,this._bindPoseIndices=null,this._skinDataPathMarks=null,this._vertexCount=0,this._tempVector30=new _q(),this._tempVector31=new _q(),this._tempVector32=new _q(),this._bufferState=new PQ(),this._instanceBufferState=new PQ(),J.__super.call(this),this._subMeshes=[],this._vertexBuffers=[],this._skinDataPathMarks=[];}
S(J,"laya.d3.resource.models.Mesh",u);var Q=J.prototype;return o.imps(Q,{"laya.d3.core.IClone":!0}),Q._getPositionElement=function(q){for(var Q=q.vertexDeclaration.vertexElements,m=0,a=Q.length;m<a;m++){var w=Q[m];if("vector3"===w.elementFormat&&0===w.elementUsage)return w;}
return null;},Q._generateBoundingObject=function(){var q=this._tempVector30,Q=this._tempVector31;q.x=q.y=q.z=Number.MAX_VALUE,Q.x=Q.y=Q.z=-Number.MAX_VALUE;for(var m=this._vertexBuffers.length,a=0;a<m;a++)
for(var w=this._vertexBuffers[a],e=this._getPositionElement(w),F=w.getData(),W=w.vertexDeclaration.vertexStride/4,s=e.offset/4,D=0,d=F.length;D<d;D+=W){var v=D+s,y=F[v],S=F[v+1],t=F[v+2];q.x=Math.min(q.x,y),q.y=Math.min(q.y,S),q.z=Math.min(q.z,t),Q.x=Math.max(Q.x,y),Q.y=Math.max(Q.y,S),Q.z=Math.max(Q.z,t);}
this._bounds=new lQ(q,Q);},Q._setSubMeshes=function(q){this._subMeshes=q,this._subMeshCount=q.length;for(var Q=0;Q<this._subMeshCount;Q++)q[Q]._indexInMesh=Q;this._generateBoundingObject();},Q._getSubMesh=function(q){return this._subMeshes[q];},Q._setBuffer=function(q,Q){var m=this._bufferState;m.bind(),m.applyVertexBuffers(q),m.applyIndexBuffer(Q),m.unBind();var a=this._instanceBufferState;a.bind(),a.applyVertexBuffers(q),a.applyInstanceVertexBuffer(Um.instance.instanceWorldMatrixBuffer),a.applyInstanceVertexBuffer(Um.instance.instanceMVPMatrixBuffer),a.applyIndexBuffer(Q),a.unBind();},Q._disposeResource=function(){for(var q=0,Q=this._subMeshes.length;q<Q;q++)this._subMeshes[q].destroy();for(this._nativeTriangleMesh&&R._physics3D.destroy(this._nativeTriangleMesh),q=0,Q=this._vertexBuffers.length;q<Q;q++)this._vertexBuffers[q].destroy();this._indexBuffer.destroy(),this._setCPUMemory(0),this._setGPUMemory(0),this._bufferState.destroy(),this._instanceBufferState.destroy(),this._bufferState=null,this._instanceBufferState=null,this._vertexBuffers=null,this._indexBuffer=null,this._subMeshes=null,this._nativeTriangleMesh=null,this._vertexBuffers=null,this._indexBuffer=null,this._boneNames=null,this._inverseBindPoses=null;},Q._getPhysicMesh=function(){if(!this._nativeTriangleMesh){for(var q=new R._physics3D.btTriangleMesh(),Q=J._nativeTempVector30,m=J._nativeTempVector31,a=J._nativeTempVector32,w=this._tempVector30,e=this._tempVector31,F=this._tempVector32,W=this._vertexBuffers[0],s=this._getPositionElement(W),D=W.getData(),d=W.vertexDeclaration.vertexStride/4,v=s.offset/4,y=this._indexBuffer.getData(),S=0,t=y.length;S<t;S+=3){var o=y[S]*d+v,b=y[S+1]*d+v,U=y[S+2]*d+v;w.setValue(D[o],D[o+1],D[o+2]),e.setValue(D[b],D[b+1],D[b+2]),F.setValue(D[U],D[U+1],D[U+2]),Rq._convertToBulletVec3(w,Q,!0),Rq._convertToBulletVec3(e,m,!0),Rq._convertToBulletVec3(F,a,!0),q.addTriangle(Q,m,a,!0);}
this._nativeTriangleMesh=q;}
return this._nativeTriangleMesh;},Q.cloneTo=function(q){for(var Q=q,m=0;m<this._vertexBuffers.length;m++){var a=this._vertexBuffers[m],w=new HQ(a._byteLength,a.bufferUsage,a.canRead);w.vertexDeclaration=a.vertexDeclaration,w.setData(a.getData().slice()),Q._vertexBuffers.push(w),Q._vertexCount+=w.vertexCount;}
var e=this._indexBuffer,F=new gQ("ushort",e.indexCount,e.bufferUsage,e.canRead);F.setData(e.getData().slice()),Q._indexBuffer=F,Q._setBuffer(Q._vertexBuffers,F),Q._setCPUMemory(this.cpuMemory),Q._setGPUMemory(this.gpuMemory);var W=this._boneNames,s=Q._boneNames=N(W.length);for(m=0;m<W.length;m++)s[m]=W[m];var D=this._inverseBindPoses,d=Q._inverseBindPoses=N(D.length);for(m=0;m<D.length;m++)d[m]=D[m];for(Q._bindPoseIndices=new Uint16Array(this._bindPoseIndices),m=0;m<this._skinDataPathMarks.length;m++)Q._skinDataPathMarks[m]=this._skinDataPathMarks[m].slice();for(m=0;m<this.subMeshCount;m++){var v=this._subMeshes[m],y=v._subIndexBufferStart,S=v._subIndexBufferCount,t=v._boneIndicesList,o=new em(Q);o._subIndexBufferStart.length=y.length,o._subIndexBufferCount.length=S.length,o._boneIndicesList.length=t.length;for(var b=0;b<y.length;b++)o._subIndexBufferStart[b]=y[b];for(b=0;b<S.length;b++)o._subIndexBufferCount[b]=S[b];for(b=0;b<t.length;b++)o._boneIndicesList[b]=new Uint16Array(t[b]);o._indexBuffer=F,o._indexStart=v._indexStart,o._indexCount=v._indexCount,o._indices=new Uint16Array(F.getData().buffer,2*v._indexStart,v._indexCount);var U=Q._vertexBuffers[0];o._vertexBuffer=U,Q._subMeshes.push(o);}
Q._setSubMeshes(Q._subMeshes);},Q.clone=function(){var q=new this.constructor();return this.cloneTo(q),q;},d(0,Q,"inverseAbsoluteBindPoses",function(){return this._inverseBindPoses;}),d(0,Q,"vertexCount",function(){return this._vertexCount;}),d(0,Q,"subMeshCount",function(){return this._subMeshCount;}),d(0,Q,"bounds",function(){return this._bounds;}),J._parse=function(q,Q,m){var a=new J();return yq.read(q,a,a._subMeshes),a;},J.load=function(q,Q){o.loader.create(q,Q,null,"MESH");},y(J,["_nativeTempVector30",function(){return this._nativeTempVector30=new R._physics3D.btVector3(0,0,0);},"_nativeTempVector31",function(){return this._nativeTempVector31=new R._physics3D.btVector3(0,0,0);},"_nativeTempVector32",function(){return this._nativeTempVector32=new R._physics3D.btVector3(0,0,0);}]),J;}(),Km=function(q){function s(q,Q,m,a){this._terrainHeightData=null,this._width=0,this._height=0,this._bitType=0,this._value=NaN,s.__super.call(this),this._width=q,this._height=Q,this._bitType=m,this._value=a;}
return S(s,"laya.d3.terrain.TerrainHeightData",u),s._pharse=function(q,Q,m){var a,w=new s(m[0],m[1],m[2],m[3]),e=NaN;8==w._bitType?(a=new Uint8Array(q),e=1/255):16==w._bitType&&(a=new Int16Array(q),e=1/32766),w._terrainHeightData=new Float32Array(w._height*w._width);for(var F=0,W=w._height*w._width;F<W;F++)w._terrainHeightData[F]=a[F]*e*w._value/2;},s.load=function(q,Q,m,a,w,e){o.loader.create(q,Q,null,"TERRAINHEIGHTDATA",[m,a,w,e],null,1,!1);},s;}(),km=function(q){function l(){l.__super.call(this),this._nodes=new Iq(),this._events=[];}
S(l,"laya.d3.animation.AnimationClip",u);var Q=l.prototype;return Q.duration=function(){return this._duration;},Q._hermiteInterpolate=function(q,Q,m,a){var w=q.outTangent,e=Q.inTangent;if(Number.isFinite(w)&&Number.isFinite(e)){var F=m*m,W=F*m,s=W-2*F+m,D=W-F,d=-2*W+3*F;return(2*W-3*F+1)*q.value+s*w*a+D*e*a+d*Q.value;}
return q.value;},Q._hermiteInterpolateVector3=function(q,Q,m,a,w){var e=q.value,F=q.outTangent,W=Q.value,s=Q.inTangent,D=m*m,d=D*m,v=2*d-3*D+1,y=d-2*D+m,S=d-D,t=-2*d+3*D,o=F.x,b=s.x;Number.isFinite(o)&&Number.isFinite(b)?w.x=v*e.x+y*o*a+S*b*a+t*W.x:w.x=e.x,o=F.y,b=s.y,Number.isFinite(o)&&Number.isFinite(b)?w.y=v*e.y+y*o*a+S*b*a+t*W.y:w.y=e.y,o=F.z,b=s.z,Number.isFinite(o)&&Number.isFinite(b)?w.z=v*e.z+y*o*a+S*b*a+t*W.z:w.z=e.z;},Q._hermiteInterpolateQuaternion=function(q,Q,m,a,w){var e=q.value,F=q.outTangent,W=Q.value,s=Q.inTangent,D=m*m,d=D*m,v=2*d-3*D+1,y=d-2*D+m,S=d-D,t=-2*d+3*D,o=F.x,b=s.x;Number.isFinite(o)&&Number.isFinite(b)?w.x=v*e.x+y*o*a+S*b*a+t*W.x:w.x=e.x,o=F.y,b=s.y,Number.isFinite(o)&&Number.isFinite(b)?w.y=v*e.y+y*o*a+S*b*a+t*W.y:w.y=e.y,o=F.z,b=s.z,Number.isFinite(o)&&Number.isFinite(b)?w.z=v*e.z+y*o*a+S*b*a+t*W.z:w.z=e.z,o=F.w,b=s.w,Number.isFinite(o)&&Number.isFinite(b)?w.w=v*e.w+y*o*a+S*b*a+t*W.w:w.w=e.w;},Q._evaluateClipDatasRealTime=function(q,Q,m,a,w){for(var e=0,F=q.count;e<F;e++){var W=q.getNodeByIndex(e),s=W.type,D=0,d=W._keyFrames,v=d.length,y=m[e];if(w)
for(-1!==y&&Q<d[y].time&&(y=-1,m[e]=y),D=y+1;D<v&&!(d[D].time>Q);)y++,D++,m[e]=y;else
for((D=y+1)!==v&&Q>d[D].time&&(y=v-1,m[e]=y),D=y+1;-1<y&&!(d[y].time<Q);)y--,D--,m[e]=y;var S=D===v;switch(s){case 0:if(-1!==y){var t=d[y];if(S)W.data=t.value;else{var o=d[D],b=o.time-t.time,U=NaN;U=0!==b?(Q-t.time)/b:0,W.data=this._hermiteInterpolate(t,o,U,b);}}else W.data=d[0].value;a&&(W.data-=d[0].value);break;case 1:case 4:var J=W.data;if(this._evaluateFrameNodeVector3DatasRealTime(d,y,S,Q,J),a){var V=d[0].value;J.x-=V.x,J.y-=V.y,J.z-=V.z;}
break;case 2:var n=W.data;if(this._evaluateFrameNodeQuaternionDatasRealTime(d,y,S,Q,n),a){var O=l._tempQuaternion0,C=d[0].value;Rq.quaternionConjugate(C,O),eq.multiply(O,n,n);}
break;case 3:J=W.data,this._evaluateFrameNodeVector3DatasRealTime(d,y,S,Q,J),a&&(V=d[0].value,J.x/=V.x,J.y/=V.y,J.z/=V.z);break;default:throw"AnimationClip:unknown node type.";}}},Q._evaluateClipDatasRealTimeForNative=function(q,Q,m,a){J.instance.evaluateClipDatasRealTime(q._nativeObj,Q,m,a);},Q._evaluateFrameNodeVector3DatasRealTime=function(q,Q,m,a,w){if(-1!==Q){var e=q[Q];if(m){var F=e.value;w.x=F.x,w.y=F.y,w.z=F.z;}else{var W=q[Q+1],s=NaN,D=e.time,d=W.time-D;s=0!==d?(a-D)/d:0,this._hermiteInterpolateVector3(e,W,s,d,w);}}else{var v=q[0].value;w.x=v.x,w.y=v.y,w.z=v.z;}},Q._evaluateFrameNodeQuaternionDatasRealTime=function(q,Q,m,a,w){if(-1!==Q){var e=q[Q];if(m){var F=e.value;w.x=F.x,w.y=F.y,w.z=F.z,w.w=F.w;}else{var W=q[Q+1],s=NaN,D=e.time,d=W.time-D;s=0!==d?(a-D)/d:0,this._hermiteInterpolateQuaternion(e,W,s,d,w);}}else{var v=q[0].value;w.x=v.x,w.y=v.y,w.z=v.z,w.w=v.w;}},Q._binarySearchEventIndex=function(q){for(var Q=0,m=this._events.length-1,a=0;Q<=m;){a=Math.floor((Q+m)/2);var w=this._events[a].time;if(w==q)return a;q<w?m=a-1:Q=a+1;}
return Q;},Q.addEvent=function(q){var Q=this._binarySearchEventIndex(q.time);this._events.splice(Q,0,q);},Q._disposeResource=function(){this._nodes=null,this._nodesMap=null;},l._parse=function(q,Q,m){var a=new l(),w=new W(q),e=w.readUTFString();switch(e){case"LAYAANIMATION:03":xq.parse(a,w);break;case"LAYAANIMATION:04":case"LAYAANIMATION:COMPRESSION_04":Yq.parse(a,w,e);break;default:throw"unknown animationClip version.";}
return a;},l.load=function(q,Q){o.loader.create(q,Q,null,"ANIMATIONCLIP");},y(l,["_tempQuaternion0",function(){return this._tempQuaternion0=new eq();}]),l;}(),Rm=function(q){function e(q,Q,m,a,w){this._stateParamsMap=[],this._uploadMark=-1,this._uploadRenderType=-1,e.__super.call(this),this._vs=q,this._ps=Q,this._attributeMap=m,this._uniformMap=a,this._shaderPass=w,this._create(),this.lock=!0;}
S(e,"laya.d3.shader.ShaderInstance",u);var Q=e.prototype;return Q._create=function(){var q=J.instance;for(var Q in this._program=q.createProgram(),this._vshader=this._createShader(q,this._vs,35633),this._pshader=this._createShader(q,this._ps,35632),q.attachShader(this._program,this._vshader),q.attachShader(this._program,this._pshader),this._attributeMap)q.bindAttribLocation(this._program,this._attributeMap[Q],Q);if(q.linkProgram(this._program),!M.isConchApp&&Bq.debugMode&&!q.getProgramParameter(this._program,35714))throw q.getProgramInfoLog(this._program);var m=[],a=[],w=[],e=[],F=[];this._customUniformParamsMap=[];var W=q.getProgramParameter(this._program,35718);E.useProgram(q,this._program);var s,D=this._curActTexIndex=0,d=0;for(D=0;D<W;D++){var v=q.getActiveUniform(this._program,D),y=v.name;(s=new nQ()).location=q.getUniformLocation(this._program,y),0<y.indexOf("[0]")?(s.name=y=y.substr(0,y.length-3),s.isArray=!0):(s.name=y,s.isArray=!1),s.type=v.type,this._addShaderUnifiormFun(s);var S=this._uniformMap[y];if(null!=S)switch(s.dataOffset=Bq.propertyNameToID(y),S){case 0:F.push(s);break;case 1:e.push(s);break;case 2:w.push(s);break;case 3:a.push(s);break;case 4:m.push(s);break;default:throw new Error("Shader3D: period is unkonw.");}}
for(this._sceneUniformParamsMap=J.instance.createCommandEncoder(4*m.length*5+4,64,!0),D=0,d=m.length;D<d;D++)this._sceneUniformParamsMap.addShaderUniform(m[D]);for(this._cameraUniformParamsMap=J.instance.createCommandEncoder(4*a.length*5+4,64,!0),D=0,d=a.length;D<d;D++)this._cameraUniformParamsMap.addShaderUniform(a[D]);for(this._spriteUniformParamsMap=J.instance.createCommandEncoder(4*w.length*5+4,64,!0),D=0,d=w.length;D<d;D++)this._spriteUniformParamsMap.addShaderUniform(w[D]);for(this._materialUniformParamsMap=J.instance.createCommandEncoder(4*e.length*5+4,64,!0),D=0,d=e.length;D<d;D++)this._materialUniformParamsMap.addShaderUniform(e[D]);for(this._customUniformParamsMap.length=F.length,D=0,d=F.length;D<d;D++){var t=F[D];this._customUniformParamsMap[t.dataOffset]=t;}
var o=this._shaderPass._stateMap;for(var b in o)this._stateParamsMap[o[b]]=Bq.propertyNameToID(b);},Q._getRenderState=function(q,Q){var m=this._stateParamsMap[Q];return null==m?null:q[m];},Q._disposeResource=function(){J.instance.deleteShader(this._vshader),J.instance.deleteShader(this._pshader),J.instance.deleteProgram(this._program),this._vshader=this._pshader=this._program=null,this._setGPUMemory(0),this._curActTexIndex=0;},Q._addShaderUnifiormFun=function(q){var Q=J.instance;q.caller=this;var m=q.isArray;switch(q.type){case 35670:q.fun=this._uniform1i,q.uploadedValue=new Array(1);break;case 5124:q.fun=m?this._uniform1iv:this._uniform1i,q.uploadedValue=new Array(1);break;case 5126:q.fun=m?this._uniform1fv:this._uniform1f,q.uploadedValue=new Array(1);break;case 35664:q.fun=m?this._uniform_vec2v:this._uniform_vec2,q.uploadedValue=new Array(2);break;case 35665:q.fun=m?this._uniform_vec3v:this._uniform_vec3,q.uploadedValue=new Array(3);break;case 35666:q.fun=m?this._uniform_vec4v:this._uniform_vec4,q.uploadedValue=new Array(4);break;case 35674:q.fun=this._uniformMatrix2fv;break;case 35675:q.fun=this._uniformMatrix3fv;break;case 35676:q.fun=m?this._uniformMatrix4fv:this._uniformMatrix4f;break;case 35678:Q.uniform1i(q.location,this._curActTexIndex),q.textureID=E._glTextureIDs[this._curActTexIndex++],q.fun=this._uniform_sampler2D;break;case 35679:Q.uniform1i(q.location,this._curActTexIndex),q.textureID=E._glTextureIDs[this._curActTexIndex++],q.fun=this._uniform_sampler3D;break;case 35680:Q.uniform1i(q.location,this._curActTexIndex),q.textureID=E._glTextureIDs[this._curActTexIndex++],q.fun=this._uniform_samplerCube;break;default:throw new Error("compile shader err!");}},Q._createShader=function(q,Q,m){var a=q.createShader(m);if(q.shaderSource(a,Q),q.compileShader(a),Bq.debugMode&&!q.getShaderParameter(a,35713))throw q.getShaderInfoLog(a);return a;},Q._uniform1f=function(q,Q){var m=q.uploadedValue;return m[0]!==Q?(J.instance.uniform1f(q.location,m[0]=Q),1):0;},Q._uniform1fv=function(q,Q){if(Q.length<4){var m=q.uploadedValue;return m[0]!==Q[0]||m[1]!==Q[1]||m[2]!==Q[2]||m[3]!==Q[3]?(J.instance.uniform1fv(q.location,Q),m[0]=Q[0],m[1]=Q[1],m[2]=Q[2],m[3]=Q[3],1):0;}
return J.instance.uniform1fv(q.location,Q),1;},Q._uniform_vec2=function(q,Q){var m=q.uploadedValue;return m[0]!==Q.x||m[1]!==Q.y?(J.instance.uniform2f(q.location,m[0]=Q.x,m[1]=Q.y),1):0;},Q._uniform_vec2v=function(q,Q){if(Q.length<2){var m=q.uploadedValue;return m[0]!==Q[0]||m[1]!==Q[1]||m[2]!==Q[2]||m[3]!==Q[3]?(J.instance.uniform2fv(q.location,Q),m[0]=Q[0],m[1]=Q[1],m[2]=Q[2],m[3]=Q[3],1):0;}
return J.instance.uniform2fv(q.location,Q),1;},Q._uniform_vec3=function(q,Q){var m=q.uploadedValue;return m[0]!==Q.x||m[1]!==Q.y||m[2]!==Q.z?(J.instance.uniform3f(q.location,m[0]=Q.x,m[1]=Q.y,m[2]=Q.z),1):0;},Q._uniform_vec3v=function(q,Q){return J.instance.uniform3fv(q.location,Q),1;},Q._uniform_vec4=function(q,Q){var m=q.uploadedValue;return m[0]!==Q.x||m[1]!==Q.y||m[2]!==Q.z||m[3]!==Q.w?(J.instance.uniform4f(q.location,m[0]=Q.x,m[1]=Q.y,m[2]=Q.z,m[3]=Q.w),1):0;},Q._uniform_vec4v=function(q,Q){return J.instance.uniform4fv(q.location,Q),1;},Q._uniformMatrix2fv=function(q,Q){return J.instance.uniformMatrix2fv(q.location,!1,Q),1;},Q._uniformMatrix3fv=function(q,Q){return J.instance.uniformMatrix3fv(q.location,!1,Q),1;},Q._uniformMatrix4f=function(q,Q){var m=Q.elements;return J.instance.uniformMatrix4fv(q.location,!1,m),1;},Q._uniformMatrix4fv=function(q,Q){return J.instance.uniformMatrix4fv(q.location,!1,Q),1;},Q._uniform1i=function(q,Q){var m=q.uploadedValue;return m[0]!==Q?(J.instance.uniform1i(q.location,m[0]=Q),1):0;},Q._uniform1iv=function(q,Q){return J.instance.uniform1iv(q.location,Q),1;},Q._uniform_ivec2=function(q,Q){var m=q.uploadedValue;return m[0]!==Q[0]||m[1]!==Q[1]?(J.instance.uniform2i(q.location,m[0]=Q[0],m[1]=Q[1]),1):0;},Q._uniform_ivec2v=function(q,Q){return J.instance.uniform2iv(q.location,Q),1;},Q._uniform_vec3i=function(q,Q){var m=q.uploadedValue;return m[0]!==Q[0]||m[1]!==Q[1]||m[2]!==Q[2]?(J.instance.uniform3i(q.location,m[0]=Q[0],m[1]=Q[1],m[2]=Q[2]),1):0;},Q._uniform_vec3vi=function(q,Q){return J.instance.uniform3iv(q.location,Q),1;},Q._uniform_vec4i=function(q,Q){var m=q.uploadedValue;return m[0]!==Q[0]||m[1]!==Q[1]||m[2]!==Q[2]||m[3]!==Q[3]?(J.instance.uniform4i(q.location,m[0]=Q[0],m[1]=Q[1],m[2]=Q[2],m[3]=Q[3]),1):0;},Q._uniform_vec4vi=function(q,Q){return J.instance.uniform4iv(q.location,Q),1;},Q._uniform_sampler2D=function(q,Q){var m=Q._getSource()||Q.defaulteTexture._getSource(),a=J.instance;return E.activeTexture(a,q.textureID),E.bindTexture(a,3553,m),0;},Q._uniform_sampler3D=function(q,Q){var m=Q._getSource()||Q.defaulteTexture._getSource(),a=J.instance;return E.activeTexture(a,q.textureID),E.bindTexture(a,32879,m),0;},Q._uniform_samplerCube=function(q,Q){var m=Q._getSource()||Q.defaulteTexture._getSource(),a=J.instance;return E.activeTexture(a,q.textureID),E.bindTexture(a,34067,m),0;},Q.bind=function(){return E.useProgram(J.instance,this._program);},Q.uploadUniforms=function(q,Q,m){r.shaderCall+=V.uploadShaderUniforms(J.instance,q,Q,m);},Q.uploadRenderStateBlendDepth=function(q){var Q=J.instance,m=this._shaderPass.renderState,a=q.getData(),w=this._getRenderState(a,13),e=this._getRenderState(a,12),F=this._getRenderState(a,1);switch(null==w&&(w=m.depthWrite),null==e&&(e=m.depthTest),null==F&&(F=m.blend),E.setDepthMask(Q,w),0===e?E.setDepthTest(Q,!1):(E.setDepthTest(Q,!0),E.setDepthFunc(Q,e)),F){case 0:E.setBlend(Q,!1);break;case 1:E.setBlend(Q,!0);var W=this._getRenderState(a,2);null==W&&(W=m.srcBlend);var s=this._getRenderState(a,3);null==s&&(s=m.dstBlend),E.setBlendFunc(Q,W,s);break;case 2:E.setBlend(Q,!0);var D=this._getRenderState(a,4);null==D&&(D=m.srcBlendRGB);var d=this._getRenderState(a,5);null==d&&(d=m.dstBlendRGB);var v=this._getRenderState(a,6);null==v&&(v=m.srcBlendAlpha);var y=this._getRenderState(a,7);null==y&&(y=m.dstBlendAlpha),E.setBlendFuncSeperate(Q,D,d,v,y);}},Q.uploadRenderStateFrontFace=function(q,Q,m){var a=J.instance,w=this._shaderPass.renderState,e=q.getData(),F=this._getRenderState(e,0);null==F&&(F=w.cull);var W=0;switch(F){case 0:E.setCullFace(a,!1);break;case 1:E.setCullFace(a,!0),W=Q?m&&m._isFrontFaceInvert?2305:2304:m&&m._isFrontFaceInvert?2304:2305,E.setFrontFace(a,W);break;case 2:E.setCullFace(a,!0),W=Q?m&&m._isFrontFaceInvert?2304:2305:m&&m._isFrontFaceInvert?2305:2304,E.setFrontFace(a,W);}},Q.uploadCustomUniform=function(q,Q){r.shaderCall+=V.uploadCustomUniform(J.instance,this._customUniformParamsMap,q,Q);},Q._uniformMatrix2fvForNative=function(q,Q){return J.instance.uniformMatrix2fvEx(q.location,!1,Q),1;},Q._uniformMatrix3fvForNative=function(q,Q){return J.instance.uniformMatrix3fvEx(q.location,!1,Q),1;},Q._uniformMatrix4fvForNative=function(q,Q){return J.instance.uniformMatrix4fvEx(q.location,!1,Q),1;},e;}(),zm=(function(q){function w(){this._version=NaN,this._cameraCoordinateInverse=!1,this._gridSize=NaN,this._chunkNumX=0,this._chunkNumZ=0,this._heightDataX=0,this._heightDataZ=0,this._heightDataBitType=0,this._heightDataValue=NaN,this._heightDataUrl=null,this._detailTextureInfos=null,this._chunkInfos=null,this._heightData=null,this._materialInfo=null,this._alphaMaps=null,this._normalMaps=null,w.__super.call(this);}
S(w,"laya.d3.terrain.TerrainRes",u);var Q=w.prototype;Q.parseData=function(q){var Q=q[0],m=q[1];if(this._version=Q.version,1==this._version){this._cameraCoordinateInverse=Q.cameraCoordinateInverse,this._gridSize=Q.gridSize,this._chunkNumX=Q.chunkNumX,this._chunkNumZ=Q.chunkNumZ;var a=Q.heightData;if(this._heightDataX=a.numX,this._heightDataZ=a.numZ,this._heightDataBitType=a.bitType,this._heightDataValue=a.value,this._heightDataUrl=m[a.url],this._materialInfo=new aq(),Q.material){var w=Q.material.ambient,e=Q.material.diffuse,F=Q.material.specular;this._materialInfo.ambientColor=new _q(w[0],w[1],w[2]),this._materialInfo.diffuseColor=new _q(e[0],e[1],e[2]),this._materialInfo.specularColor=new rq(F[0],F[1],F[2],F[3]);}
var W=Q.detailTexture;this._detailTextureInfos=N(W.length);for(var s=0;s<W.length;s++){var D=W[s],d=new cQ();d.diffuseTexture=m[D.diffuse],d.normalTexture=D.normal?m[D.normal]:null,D.scale?d.scale=new Zq(D.scale[0],D.scale[1]):d.scale=new Zq(1,1),D.offset?d.offset=new Zq(D.offset[0],D.offset[1]):d.offset=new Zq(0,0),this._detailTextureInfos[s]=d;}
var v=Q.alphaMap;for(this._alphaMaps=N(v.length),s=0;s<this._alphaMaps.length;s++)this._alphaMaps[s]=Q.alphaMap[s];var y=Q.normalMap;for(this._normalMaps=N(y.length),s=0;s<this._normalMaps.length;s++)this._normalMaps[s]=Q.normalMap[s];var S=Q.chunkInfo;if(this._chunkNumX*this._chunkNumZ!=S.length)return alert("terrain data error"),!1;for(this._chunkInfos=N(S.length),s=0;s<S.length;s++){var t=S[s],o=new VQ(),b=t.alphaMap.length,U=t.detailID.length;if(b!=U)return alert("terrain chunk data error"),!1;o.alphaMap=N(b),o.detailID=N(U),o.normalMap=m[this._normalMaps[t.normalMap]];for(var J=0;J<b;J++){o.alphaMap[J]=m[this._alphaMaps[t.alphaMap[J]]];var V=t.detailID[J],n=V.length;o.detailID[J]=new Uint8Array(n);for(var O=0;O<n;O++)o.detailID[J][O]=V[O];}
this._chunkInfos[s]=o;}
this._heightData=uq.getRes(this._heightDataUrl),this.onLoadTerrainComplete(this._heightData);}
return!0;},Q.onLoadTerrainComplete=function(q){},w._parse=function(q,Q,m){var a=new w();return a.parseData(q),a;},w.load=function(q,Q){o.loader.create(q,Q,null,"TERRAIN",null,null,1,!1);};}(),function(q){function Q(q){this._finalGravity=new _q(),this._tempRotationMatrix=new kQ(),Q.__super.call(this,q),this._defaultBoundBox=new GQ(new _q(),new _q()),this._renderMode=-1,this.stretchedBillboardCameraSpeedScale=0,this.stretchedBillboardSpeedScale=0,this.stretchedBillboardLengthScale=1;}
S(Q,"laya.d3.core.particleShuriKen.ShurikenParticleRenderer",q);var m=Q.prototype;return m._calculateBoundingBox=function(){var q=this._bounds.getMin();q.x=-Number.MAX_VALUE,q.y=-Number.MAX_VALUE,q.z=-Number.MAX_VALUE,this._bounds.setMin(q);var Q=this._bounds.getMax();if(Q.x=Number.MAX_VALUE,Q.y=Number.MAX_VALUE,Q.z=Number.MAX_VALUE,this._bounds.setMax(Q),M.supportWebGLPlusCulling){q=this._bounds.getMin(),Q=this._bounds.getMax();var m=NQ._cullingBuffer;m[this._cullingBufferIndex+1]=q.x,m[this._cullingBufferIndex+2]=q.y,m[this._cullingBufferIndex+3]=q.z,m[this._cullingBufferIndex+4]=Q.x,m[this._cullingBufferIndex+5]=Q.y,m[this._cullingBufferIndex+6]=Q.z;}},m._needRender=function(q){return!q||0!==q.containsBoundBox(this.bounds._getBoundBox())&&!!this._owner.particleSystem.isAlive;},m._renderUpdate=function(q,Q){var m=this._owner.particleSystem,a=this._shaderValues,w=this._owner.transform;switch(m.simulationSpace){case 0:break;case 1:a.setVector3(Oa.WORLDPOSITION,w.position),a.setQuaternion(Oa.WORLDROTATION,w.rotation);break;default:throw new Error("ShurikenParticleMaterial: SimulationSpace value is invalid.");}
switch(m.scaleMode){case 0:var e=w.scale;a.setVector3(Oa.POSITIONSCALE,e),a.setVector3(Oa.SIZESCALE,e);break;case 1:var F=w.localScale;a.setVector3(Oa.POSITIONSCALE,F),a.setVector3(Oa.SIZESCALE,F);break;case 2:a.setVector3(Oa.POSITIONSCALE,w.scale),a.setVector3(Oa.SIZESCALE,_q._ONE);}
_q.scale(LQ.gravity,m.gravityModifier,this._finalGravity),a.setVector3(Oa.GRAVITY,this._finalGravity),a.setInt(Oa.SIMULATIONSPACE,m.simulationSpace),a.setBool(Oa.THREEDSTARTROTATION,m.threeDStartRotation),a.setInt(Oa.SCALINGMODE,m.scaleMode),a.setNumber(Oa.STRETCHEDBILLBOARDLENGTHSCALE,this.stretchedBillboardLengthScale),a.setNumber(Oa.STRETCHEDBILLBOARDSPEEDSCALE,this.stretchedBillboardSpeedScale),a.setNumber(Oa.CURRENTTIME,m._currentTime);},m._destroy=function(){q.prototype._destroy.call(this),this._mesh&&(this._mesh._removeReference(),this._mesh=null);},d(0,m,"renderMode",function(){return this._renderMode;},function(q){if(this._renderMode!==q){var Q=this._defineDatas;switch(this._renderMode){case 0:Q.remove(Oa.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:Q.remove(Oa.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:Q.remove(Oa.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:Q.remove(Oa.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:Q.remove(Oa.SHADERDEFINE_RENDERMODE_MESH);}
switch(this._renderMode=q){case 0:Q.add(Oa.SHADERDEFINE_RENDERMODE_BILLBOARD);break;case 1:Q.add(Oa.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD);break;case 2:Q.add(Oa.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD);break;case 3:Q.add(Oa.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD);break;case 4:Q.add(Oa.SHADERDEFINE_RENDERMODE_MESH);break;default:throw new Error("ShurikenParticleRender: unknown renderMode Value.");}
this._owner.particleSystem._initBufferDatas();}}),d(0,m,"mesh",function(){return this._mesh;},function(q){this._mesh!==q&&(this._mesh&&this._mesh._removeReference(),(this._mesh=q)&&q._addReference(),this._owner.particleSystem._initBufferDatas());}),d(0,m,"bounds",function(){return this._boundsChange&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds;}),Q;}(iQ)),im=function(Q){function m(q,Q){this._isTrigger=!1,m.__super.call(this,q,Q);}
S(m,"laya.d3.physics.PhysicsTriggerComponent",Q);var q=m.prototype;return q._onAdded=function(){Q.prototype._onAdded.call(this),this.isTrigger=this._isTrigger;},q._cloneTo=function(q){Q.prototype._cloneTo.call(this,q),q.isTrigger=this._isTrigger;},d(0,q,"isTrigger",function(){return this._isTrigger;},function(q){if(this._isTrigger=q,this._nativeColliderObject){var Q=this._nativeColliderObject.getCollisionFlags();q?0==(4&Q)&&this._nativeColliderObject.setCollisionFlags(4|Q):0!=(4&Q)&&this._nativeColliderObject.setCollisionFlags(4^Q);}}),m;}(zQ),$m=(function(m){function w(q,Q,m,a){this._maxSlope=45,this._jumpSpeed=10,this._fallSpeed=55,this._upAxis=new _q(0,1,0),this._gravity=new _q(0,3* -9.8,0),void 0===q&&(q=.1),void 0===m&&(m=1),void 0===a&&(a=LQ.COLLISIONFILTERGROUP_ALLFILTER),this._stepHeight=q,Q&&(this._upAxis=Q),w.__super.call(this,m,a);}
S(w,"laya.d3.physics.CharacterController",m);var q=w.prototype;q._constructCharacter=function(){var q=R._physics3D;this._nativeKinematicCharacter&&q.destroy(this._nativeKinematicCharacter);var Q=w._nativeTempVector30;Q.setValue(this._upAxis.x,this._upAxis.y,this._upAxis.z),this._nativeKinematicCharacter=new q.btKinematicCharacterController(this._nativeColliderObject,this._colliderShape._nativeShape,this._stepHeight,Q),this.fallSpeed=this._fallSpeed,this.maxSlope=this._maxSlope,this.jumpSpeed=this._jumpSpeed,this.gravity=this._gravity;},q._onShapeChange=function(q){m.prototype._onShapeChange.call(this,q),this._constructCharacter();},q._onAdded=function(){var q=new R._physics3D.btPairCachingGhostObject();q.setUserIndex(this.id),q.setCollisionFlags(16),this._nativeColliderObject=q,this._colliderShape&&this._constructCharacter(),m.prototype._onAdded.call(this);},q._addToSimulation=function(){this._simulation._characters.push(this),this._simulation._addCharacter(this,this._collisionGroup,this._canCollideWith);},q._removeFromSimulation=function(){this._simulation._removeCharacter(this);var q=this._simulation._characters;q.splice(q.indexOf(this),1);},q._cloneTo=function(q){m.prototype._cloneTo.call(this,q);var Q=q;Q.stepHeight=this._stepHeight,Q.upAxis=this._upAxis,Q.maxSlope=this._maxSlope,Q.jumpSpeed=this._jumpSpeed,Q.fallSpeed=this._fallSpeed,Q.gravity=this._gravity;},q._onDestroy=function(){R._physics3D.destroy(this._nativeKinematicCharacter),m.prototype._onDestroy.call(this),this._nativeKinematicCharacter=null;},q.move=function(q){var Q=zQ._nativeVector30;Q.setValue(-q.x,q.y,q.z),this._nativeKinematicCharacter.setWalkDirection(Q);},q.jump=function(q){if(q){var Q=zQ._nativeVector30;Rq._convertToBulletVec3(q,Q,!0),this._nativeKinematicCharacter.jump(Q);}else this._nativeKinematicCharacter.jump();},d(0,q,"fallSpeed",function(){return this._fallSpeed;},function(q){this._fallSpeed=q,this._nativeKinematicCharacter.setFallSpeed(q);}),d(0,q,"stepHeight",function(){return this._stepHeight;},function(q){this._stepHeight=q,this._constructCharacter();}),d(0,q,"jumpSpeed",function(){return this._jumpSpeed;},function(q){this._jumpSpeed=q,this._nativeKinematicCharacter.setJumpSpeed(q);}),d(0,q,"gravity",function(){return this._gravity;},function(q){this._gravity=q;var Q=w._nativeTempVector30;Q.setValue(-q.x,q.y,q.z),this._nativeKinematicCharacter.setGravity(Q);}),d(0,q,"maxSlope",function(){return this._maxSlope;},function(q){this._maxSlope=q,this._nativeKinematicCharacter.setMaxSlope(q/180*Math.PI);}),d(0,q,"isGrounded",function(){return this._nativeKinematicCharacter.onGround();}),d(0,q,"upAxis",function(){return this._upAxis;},function(q){this._upAxis=q,this._constructCharacter();}),w.UPAXIS_X=0,w.UPAXIS_Y=1,w.UPAXIS_Z=2,y(w,["_nativeTempVector30",function(){return this._nativeTempVector30=new R._physics3D.btVector3(0,0,0);}]);}(zQ),function(q){function Q(q){this._terrainSprite3DOwner=null,this._projectionViewWorldMatrix=null,Q.__super.call(this,q),this._terrainSprite3DOwner=q,this._projectionViewWorldMatrix=new kQ();}
S(Q,"laya.d3.terrain.TerrainRender",q);var m=Q.prototype;return m._needRender=function(q){return!q||0!==q.containsBoundBox(this._bounds._getBoundBox());},m._calculateBoundingBox=function(){},m._renderUpdate=function(q,Q){this._shaderValues.setMatrix4x4(Mm.WORLDMATRIX,Q.worldMatrix);},m._renderUpdateWithCamera=function(q,Q){var m=q.projectionViewMatrix;kQ.multiply(m,Q.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,this._projectionViewWorldMatrix);},m._destroy=function(){q.prototype._destroy.call(this),this._terrainSprite3DOwner=null;},Q;}(iQ)),jm=function(q){function Q(q){Q.__super.call(this,q),this._projectionViewWorldMatrix=new kQ();}
S(Q,"laya.d3.core.MeshRenderer",q);var m=Q.prototype;return m._onMeshChange=function(q){this._boundsChange=!0;},m._calculateBoundingBox=function(){var q=this._owner.meshFilter.sharedMesh;if(q){var Q=this._owner.transform.worldMatrix;q.bounds._tranform(Q,this._bounds);}
if(M.supportWebGLPlusCulling){var m=this._bounds.getMin(),a=this._bounds.getMax(),w=NQ._cullingBuffer;w[this._cullingBufferIndex+1]=m.x,w[this._cullingBufferIndex+2]=m.y,w[this._cullingBufferIndex+3]=m.z,w[this._cullingBufferIndex+4]=a.x,w[this._cullingBufferIndex+5]=a.y,w[this._cullingBufferIndex+6]=a.z;}},m._changeRenderObjectsByMesh=function(q){var Q=q.subMeshCount;this._renderElements.length=Q;for(var m=0;m<Q;m++){var a=this._renderElements[m];if(!a){var w=this.sharedMaterials[m];(a=this._renderElements[m]=new Em()).setTransform(this._owner._transform),a.render=this,a.material=w||da.defaultMaterial;}
a.setGeometry(q._getSubMesh(m));}},m._needRender=function(q){return!q||0!==q.containsBoundBox(this.bounds._getBoundBox());},m._renderUpdate=function(q,Q){var m=q.renderElement;switch(m.renderType){case 0:this._shaderValues.setMatrix4x4(Mm.WORLDMATRIX,Q.worldMatrix);break;case 1:this._oriDefineValue=this._defineDatas.value,Q?this._shaderValues.setMatrix4x4(Mm.WORLDMATRIX,Q.worldMatrix):this._shaderValues.setMatrix4x4(Mm.WORLDMATRIX,kQ.DEFAULT),this._defineDatas.add(Ua.SHADERDEFINE_UV1),this._defineDatas.remove(Im.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV);break;case 3:this._shaderValues.setMatrix4x4(Mm.WORLDMATRIX,kQ.DEFAULT);break;case 2:for(var a=Um.instance.instanceWorldMatrixData,w=m.instanceBatchElementList,e=w.length,F=0;F<e;F++)a.set(w[F]._transform.worldMatrix.elements,16*F);Um.instance.instanceWorldMatrixBuffer.setData(a,0,0,16*e),this._defineDatas.add(Ua.SHADERDEFINE_GPU_INSTANCE);}},m._renderUpdateWithCamera=function(q,Q){var m=q.projectionViewMatrix,a=q.renderElement;switch(a.renderType){case 0:case 1:case 3:Q?(kQ.multiply(m,Q.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,m);break;case 2:for(var w=Um.instance.instanceMVPMatrixData,e=a.instanceBatchElementList,F=e.length,W=0;W<F;W++){var s=e[W]._transform.worldMatrix;Rq.mulMatrixByArray(m.elements,0,s.elements,0,w,16*W);}
Um.instance.instanceMVPMatrixBuffer.setData(w,0,0,16*F);}},m._renderUpdateWithCameraForNative=function(q,Q){var m=q.projectionViewMatrix,a=q.renderElement;switch(a.renderType){case 0:Q?(kQ.multiply(m,Q.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,m);break;case 1:case 3:var w=Fq._SET_RUNTIME_VALUE_MODE_REFERENCE_;Fq.setRuntimeValueMode(!1),Q?(kQ.multiply(m,Q.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,m),Fq.setRuntimeValueMode(w);break;case 2:for(var e=Um.instance.instanceMVPMatrixData,F=a.instanceBatchElementList,W=F.length,s=0;s<W;s++){var D=F[s]._transform.worldMatrix;Rq.mulMatrixByArray(m.elements,0,D.elements,0,e,16*s);}
Um.instance.instanceMVPMatrixBuffer.setData(e,0,0,16*W);}},m._revertBatchRenderUpdate=function(q){switch(q.renderElement.renderType){case 1:this._defineDatas.value=this._oriDefineValue;break;case 2:this._defineDatas.remove(Ua.SHADERDEFINE_GPU_INSTANCE);}},m._destroy=function(){this._isPartOfStaticBatch&&nm.instance._destroyRenderSprite(this._owner),q.prototype._destroy.call(this);},y(Q,["_tempVector30",function(){return this._tempVector30=new _q();},"_tempVector31",function(){return this._tempVector31=new _q();}]),Q;}(iQ),hm=function(m){function Q(q){this._projectionViewWorldMatrix=new kQ(),Q.__super.call(this,q);}
S(Q,"laya.d3.core.trail.TrailRenderer",m);var q=Q.prototype;return q._calculateBoundingBox=function(){var q=this._bounds.getMin();q.x=-Number.MAX_VALUE,q.y=-Number.MAX_VALUE,q.z=-Number.MAX_VALUE,this._bounds.setMin(q);var Q=this._bounds.getMax();if(Q.x=Number.MAX_VALUE,Q.y=Number.MAX_VALUE,Q.z=Number.MAX_VALUE,this._bounds.setMax(Q),M.supportWebGLPlusCulling){q=this._bounds.getMin(),Q=this._bounds.getMax();var m=NQ._cullingBuffer;m[this._cullingBufferIndex+1]=q.x,m[this._cullingBufferIndex+2]=q.y,m[this._cullingBufferIndex+3]=q.z,m[this._cullingBufferIndex+4]=Q.x,m[this._cullingBufferIndex+5]=Q.y,m[this._cullingBufferIndex+6]=Q.z;}},q._needRender=function(q){return!0;},q._renderUpdate=function(q,Q){m.prototype._renderUpdate.call(this,q,Q),this._owner.trailFilter._update(q);},q._renderUpdateWithCamera=function(q,Q){var m=q.projectionViewMatrix;Q?(kQ.multiply(m,Q.worldMatrix,this._projectionViewWorldMatrix),this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,this._projectionViewWorldMatrix)):this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,m);},Q;}(iQ),Hm=function(q){function Q(q){this._projectionViewWorldMatrix=null,Q.__super.call(this,q),this._projectionViewWorldMatrix=new kQ();}
S(Q,"laya.d3.core.pixelLine.PixelLineRenderer",iQ);var m=Q.prototype;return m._calculateBoundingBox=function(){var q=this._bounds.getMin();q.x=-Number.MAX_VALUE,q.y=-Number.MAX_VALUE,q.z=-Number.MAX_VALUE,this._bounds.setMin(q);var Q=this._bounds.getMax();if(Q.x=Number.MAX_VALUE,Q.y=Number.MAX_VALUE,Q.z=Number.MAX_VALUE,this._bounds.setMax(Q),M.supportWebGLPlusCulling){q=this._bounds.getMin(),Q=this._bounds.getMax();var m=NQ._cullingBuffer;m[this._cullingBufferIndex+1]=q.x,m[this._cullingBufferIndex+2]=q.y,m[this._cullingBufferIndex+3]=q.z,m[this._cullingBufferIndex+4]=Q.x,m[this._cullingBufferIndex+5]=Q.y,m[this._cullingBufferIndex+6]=Q.z;}},m._renderUpdateWithCamera=function(q,Q){var m=q.projectionViewMatrix,a=this._shaderValues;if(Q){var w=Q.worldMatrix;a.setMatrix4x4(Mm.WORLDMATRIX,w),kQ.multiply(m,w,this._projectionViewWorldMatrix),a.setMatrix4x4(Mm.MVPMATRIX,this._projectionViewWorldMatrix);}else a.setMatrix4x4(Mm.WORLDMATRIX,kQ.DEFAULT),a.setMatrix4x4(Mm.MVPMATRIX,m);},Q;}(),gm=function(Q){function m(){this._reflectionMode=1,this._enableLightCount=3,this.enableLight=!0,this._time=0,m.__super.call(this),this._lights=[],this._lightmaps=[],this._skyRenderer=new oQ(),this._input=new jq(),this._timer=o.timer,this._collsionTestList=[],this._renders=new Dm(),this._opaqueQueue=new rQ(!1),this._transparentQueue=new rQ(!0),this._cameraPool=[],this._animatorPool=new Dm(),this._scriptPool=new Dm(),this._castShadowRenders=new am(),this.currentCreationLayer=Math.pow(2,0),this._key=new _(),this._pickIdToSprite=new Object(),R._enbalePhysics&&(this._physicsSimulation=new RQ(R.physicsSettings)),this._defineDatas=new Lq(),this._shaderValues=new Fq(null),this.parallelSplitShadowMaps=[],this.enableFog=!1,this.fogStart=300,this.fogRange=1e3,this.fogColor=new _q(.7,.7,.7),this.ambientColor=new _q(.212,.227,.259),this.reflectionIntensity=1,A.shaderHighPrecision&&this._defineDatas.add(Bq.SHADERDEFINE_HIGHPRECISION),M.supportWebGLPlusCulling&&(this._cullingBufferIndices=new Int32Array(1024),this._cullingBufferResult=new Int32Array(1024)),this._shaderValues.setTexture(laya.d3.core.scene.Scene3D.RANGEATTENUATIONTEXTURE,kq._rangeAttenTex),this._scene=this,R._enbalePhysics&&!RQ.disableSimulation&&this._input.__init__(M.canvas,this);var q=R._config;if(q.octreeCulling&&(this._octree=new Pq(q.octreeInitialSize,q.octreeInitialCenter,q.octreeMinNodeSize,q.octreeLooseness)),R._config.debugFrustumCulling){this._debugTool=new Ca();var Q=new aa();Q.renderQueue=3e3,Q.alphaTest=!1,Q.depthWrite=!1,Q.cull=2,Q.blend=1,Q.blendSrc=770,Q.blendDst=771,Q.depthTest=513,this._debugTool.pixelLineRenderer.sharedMaterial=Q;}}
S(m,"laya.d3.core.scene.Scene3D",Q);var q=m.prototype;return o.imps(q,{"laya.webgl.submit.ISubmit":!0,"laya.resource.ICreateResource":!0}),q._allotPickColorByID=function(q,Q){var m=Math.floor(q/65025);q-=255*m*255;var a=Math.floor(q/255),w=q-=255*a;Q.x=m/255,Q.y=a/255,Q.z=w/255,Q.w=1;},q._searchIDByPickColor=function(q){return 255*q.x*255+255*q.y+q.z;},q._setLightmapToChildNode=function(q){q instanceof laya.d3.core.RenderableSprite3D&&q._render._applyLightMapParams();for(var Q=q._children,m=0,a=Q.length;m<a;m++)this._setLightmapToChildNode(Q[m]);},q._update=function(){var q=this.timer._delta/1e3;this._time+=q,this._shaderValues.setNumber(laya.d3.core.scene.Scene3D.TIME,this._time);var Q=this._physicsSimulation;R._enbalePhysics&&!RQ.disableSimulation&&(Q._updatePhysicsTransformFromRender(),zQ._addUpdateList=!1,Q._simulate(q),Q._updateCharacters(),zQ._addUpdateList=!0,Q._updateCollisions(),Q._eventScripts(),this._input._update()),this._updateScript(),jQ._update(this),this._lateUpdateScript();},q._binarySearchIndexInCameraPool=function(q){for(var Q=0,m=this._cameraPool.length-1,a=0;Q<=m;){a=Math.floor((Q+m)/2);var w=this._cameraPool[a]._renderingOrder;if(w==q._renderingOrder)return a;w>q._renderingOrder?m=a-1:Q=a+1;}
return Q;},q._setCreateURL=function(q){this._url=Z.formatURL(q);},q._getGroup=function(){return this._group;},q._setGroup=function(q){this._group=q;},q._updateScript=function(){for(var q=this._scriptPool,Q=q.elements,m=0,a=q.length;m<a;m++){var w=Q[m];w&&w.enabled&&w.onUpdate();}},q._lateUpdateScript=function(){for(var q=this._scriptPool,Q=q.elements,m=0,a=q.length;m<a;m++){var w=Q[m];w&&w.enabled&&w.onLateUpdate();}},q._preRenderScript=function(){for(var q=this._scriptPool,Q=q.elements,m=0,a=q.length;m<a;m++){var w=Q[m];w&&w.enabled&&w.onPreRender();}},q._postRenderScript=function(){for(var q=this._scriptPool,Q=q.elements,m=0,a=q.length;m<a;m++){var w=Q[m];w&&w.enabled&&w.onPostRender();}},q._prepareSceneToRender=function(){var q=this._lights.length;if(0<q)
for(var Q=0,m=0;m<q&&!(this._lights[m]._prepareToScene()&&++Q>=this._enableLightCount);m++);},q._addCamera=function(q){for(var Q=this._binarySearchIndexInCameraPool(q),m=q._renderingOrder,a=this._cameraPool.length;Q<a&&this._cameraPool[Q]._renderingOrder<=m;)Q++;this._cameraPool.splice(Q,0,q);},q._removeCamera=function(q){this._cameraPool.splice(this._cameraPool.indexOf(q),1);},q._preCulling=function(q,Q){NQ.renderObjectCulling(Q,this,q,this._renders);},q._clear=function(q,Q){var m=Q.viewport,a=Q.camera,w=a.getRenderTexture(),e=m.width,F=m.height,W=m.x,s=a._getCanvasHeight()-m.y-F;q.viewport(W,s,e,F);var D=0,d=a.clearFlag;switch(1!==d||a.skyRenderer._isAvailable()||this._skyRenderer._isAvailable()||(d=0),d){case 0:var v=a.clearColor;if(q.enable(3089),q.scissor(W,s,e,F),v?q.clearColor(v.x,v.y,v.z,v.w):q.clearColor(0,0,0,0),w)switch(D=16384,w.depthStencilFormat){case 0:D|=256;break;case 1:D|=1024;break;case 2:D|=256,D|=1024;}else D=16640;E.setDepthMask(q,!0),q.clear(D),q.disable(3089);break;case 1:case 2:if(q.enable(3089),q.scissor(W,s,e,F),w)switch(w.depthStencilFormat){case 0:D=256;break;case 1:D=1024;break;case 2:D=1280;}else D=256;E.setDepthMask(q,!0),q.clear(D),q.disable(3089);break;case 3:break;default:throw new Error("BaseScene:camera clearFlag invalid.");}},q._renderScene=function(q,Q,m,a){var w=Q.camera;w.transform.position;if(w.getRenderTexture()?this._opaqueQueue._render(Q,!0,m,a):this._opaqueQueue._render(Q,!1,m,a),1===w.clearFlag&&(w.skyRenderer._isAvailable()?w.skyRenderer._render(Q):this._skyRenderer._isAvailable()&&this._skyRenderer._render(Q)),w.getRenderTexture()?this._transparentQueue._render(Q,!0,m,a):this._transparentQueue._render(Q,!1,m,a),w._applyPostProcessCommandBuffers(),R._config.debugFrustumCulling)
for(var e=this._debugTool._render._renderElements,F=0,W=e.length;F<W;F++)e[F]._render(Q,!1,m,a);},q._parse=function(q,Q){var m=q.lightmaps;if(m){for(var a=m.length,w=N(a),e=0;e<a;e++)w[e]=uq.getRes(m[e].path);this.setlightmaps(w);}
var F=q.ambientColor;if(F){var W=this.ambientColor;W.fromArray(F),this.ambientColor=W;}
var s=q.sky;if(s)switch(this._skyRenderer.material=uq.getRes(s.material.path),s.mesh){case"SkyBox":this._skyRenderer.mesh=Cm.instance;break;case"SkyDome":this._skyRenderer.mesh=rm.instance;break;default:this.skyRenderer.mesh=Cm.instance;}
var D=q.reflectionTexture;D&&(this.customReflection=uq.getRes(D)),this.enableFog=q.enableFog,this.fogStart=q.fogStart,this.fogRange=q.fogRange;var d=q.fogColor;if(d){var v=this.fogColor;v.fromArray(d),this.fogColor=v;}},q._onActive=function(){laya.display.Node.prototype._onActive.call(this),o.stage._scene3Ds.push(this);},q._onInActive=function(){laya.display.Node.prototype._onInActive.call(this);var q=o.stage._scene3Ds;q.splice(q.indexOf(this),1);},q._addLight=function(q){this._lights.indexOf(q)<0&&this._lights.push(q);},q._removeLight=function(q){var Q=this._lights.indexOf(q);0<=Q&&this._lights.splice(Q,1);},q._addRenderObject=function(q){if(this._octree)this._octree.add(q);else if(this._renders.add(q),M.supportWebGLPlusCulling){var Q=q._getIndexInList(),m=this._cullingBufferIndices.length;if(m<=Q){var a=this._cullingBufferIndices,w=this._cullingBufferResult;this._cullingBufferIndices=new Int32Array(m+1024),this._cullingBufferResult=new Int32Array(m+1024),this._cullingBufferIndices.set(a,0),this._cullingBufferResult.set(w,0);}
this._cullingBufferIndices[Q]=q._cullingBufferIndex;}},q._removeRenderObject=function(q){var Q;this._octree?this._octree.remove(q):(M.supportWebGLPlusCulling&&(Q=this._renders.elements[this._renders.length-1]),this._renders.remove(q),M.supportWebGLPlusCulling&&(this._cullingBufferIndices[Q._getIndexInList()]=Q._cullingBufferIndex));},q._addShadowCastRenderObject=function(q){this._octree||this._castShadowRenders.add(q);},q._removeShadowCastRenderObject=function(q){this._octree||this._castShadowRenders.remove(q);},q._getRenderQueue=function(q){return q<=2500?this._opaqueQueue:this._transparentQueue;},q.setlightmaps=function(q){for(var Q=this._lightmaps,m=0,a=Q.length;m<a;m++)Q[m]._removeReference();if(!q)throw new Error("Scene3D: value value can't be null.");var w=q.length;for(Q.length=w,m=0;m<w;m++){var e=q[m];e._addReference(),Q[m]=e;}
for(m=0,a=this._children.length;m<a;m++)this._setLightmapToChildNode(this._children[m]);},q.getlightmaps=function(){return this._lightmaps.slice();},q.destroy=function(q){void 0===q&&(q=!0),this.destroyed||(Q.prototype.destroy.call(this,q),this._skyRenderer.destroy(),this._skyRenderer=null,this._lights=null,this._lightmaps=null,this._renderTargetTexture=null,this._shaderValues=null,this._renders=null,this._castShadowRenders=null,this._cameraPool=null,this._octree=null,this.parallelSplitShadowMaps=null,this._physicsSimulation&&this._physicsSimulation._destroy(),uq.clearRes(this.url));},q.render=function(q,Q,m){q._curSubmit=c.RENDERBASE,0<this._children.length&&q.addRenderObject(this);},q.renderSubmit=function(){J.instance;this._prepareSceneToRender();var q,Q,m=0;for(m=0,Q=(q=this._cameraPool.length)-1;m<q;m++){M.supportWebGLPlusRendering&&Fq.setRuntimeValueMode(m==Q);var a=this._cameraPool[m];a.enableRender&&a.render();}
return D.set2DRenderConfig(),1;},q.getRenderType=function(){return 0;},q.releaseRender=function(){},q.reUse=function(q,Q){return 0;},d(0,q,"fogColor",function(){return this._shaderValues.getVector(laya.d3.core.scene.Scene3D.FOGCOLOR);},function(q){this._shaderValues.setVector3(laya.d3.core.scene.Scene3D.FOGCOLOR,q);}),d(0,q,"enableFog",function(){return this._enableFog;},function(q){this._enableFog!==q&&((this._enableFog=q)?this._defineDatas.add(laya.d3.core.scene.Scene3D.SHADERDEFINE_FOG):this._defineDatas.remove(laya.d3.core.scene.Scene3D.SHADERDEFINE_FOG));}),d(0,q,"url",function(){return this._url;}),d(0,q,"fogStart",function(){return this._shaderValues.getNumber(laya.d3.core.scene.Scene3D.FOGSTART);},function(q){this._shaderValues.setNumber(laya.d3.core.scene.Scene3D.FOGSTART,q);}),d(0,q,"reflectionIntensity",function(){return this._shaderValues.getNumber(laya.d3.core.scene.Scene3D.REFLETIONINTENSITY);},function(q){q=Math.max(Math.min(q,1),0),this._shaderValues.setNumber(laya.d3.core.scene.Scene3D.REFLETIONINTENSITY,q);}),d(0,q,"skyRenderer",function(){return this._skyRenderer;}),d(0,q,"fogRange",function(){return this._shaderValues.getNumber(laya.d3.core.scene.Scene3D.FOGRANGE);},function(q){this._shaderValues.setNumber(laya.d3.core.scene.Scene3D.FOGRANGE,q);}),d(0,q,"ambientColor",function(){return this._shaderValues.getVector(laya.d3.core.scene.Scene3D.AMBIENTCOLOR);},function(q){this._shaderValues.setVector3(laya.d3.core.scene.Scene3D.AMBIENTCOLOR,q);}),d(0,q,"customReflection",function(){return this._shaderValues.getTexture(laya.d3.core.scene.Scene3D.REFLECTIONTEXTURE);},function(q){this._shaderValues.setTexture(laya.d3.core.scene.Scene3D.REFLECTIONTEXTURE,q),q?this._defineDatas.add(laya.d3.core.scene.Scene3D.SHADERDEFINE_REFLECTMAP):this._defineDatas.remove(laya.d3.core.scene.Scene3D.SHADERDEFINE_REFLECTMAP);}),d(0,q,"physicsSimulation",function(){return this._physicsSimulation;}),d(0,q,"reflectionMode",function(){return this._reflectionMode;},function(q){this._reflectionMode=q;}),d(0,q,"timer",function(){return this._timer;},function(q){this._timer=q;}),d(0,q,"input",function(){return this._input;}),m._parse=function(q,Q,m){var a,w=q.data,e=[];switch(q.version){case"LAYAHIERARCHY:02":a=Rq._createNodeByJson02(w,e);break;default:a=Rq._createNodeByJson(w,e);}
return j.combine(null,e),a;},m.load=function(q,Q){o.loader.create(q,Q,null,"HIERARCHY");},m.REFLECTIONMODE_SKYBOX=0,m.REFLECTIONMODE_CUSTOM=1,m.SHADERDEFINE_FOG=0,m.SHADERDEFINE_DIRECTIONLIGHT=0,m.SHADERDEFINE_POINTLIGHT=0,m.SHADERDEFINE_SPOTLIGHT=0,m.SHADERDEFINE_CAST_SHADOW=0,m.SHADERDEFINE_SHADOW_PSSM1=0,m.SHADERDEFINE_SHADOW_PSSM2=0,m.SHADERDEFINE_SHADOW_PSSM3=0,m.SHADERDEFINE_SHADOW_PCF_NO=0,m.SHADERDEFINE_SHADOW_PCF1=0,m.SHADERDEFINE_SHADOW_PCF2=0,m.SHADERDEFINE_SHADOW_PCF3=0,m.SHADERDEFINE_REFLECTMAP=0,y(m,["FOGCOLOR",function(){return this.FOGCOLOR=Bq.propertyNameToID("u_FogColor");},"FOGSTART",function(){return this.FOGSTART=Bq.propertyNameToID("u_FogStart");},"FOGRANGE",function(){return this.FOGRANGE=Bq.propertyNameToID("u_FogRange");},"LIGHTDIRECTION",function(){return this.LIGHTDIRECTION=Bq.propertyNameToID("u_DirectionLight.Direction");},"LIGHTDIRCOLOR",function(){return this.LIGHTDIRCOLOR=Bq.propertyNameToID("u_DirectionLight.Color");},"POINTLIGHTPOS",function(){return this.POINTLIGHTPOS=Bq.propertyNameToID("u_PointLight.Position");},"POINTLIGHTRANGE",function(){return this.POINTLIGHTRANGE=Bq.propertyNameToID("u_PointLight.Range");},"POINTLIGHTATTENUATION",function(){return this.POINTLIGHTATTENUATION=Bq.propertyNameToID("u_PointLight.Attenuation");},"POINTLIGHTCOLOR",function(){return this.POINTLIGHTCOLOR=Bq.propertyNameToID("u_PointLight.Color");},"SPOTLIGHTPOS",function(){return this.SPOTLIGHTPOS=Bq.propertyNameToID("u_SpotLight.Position");},"SPOTLIGHTDIRECTION",function(){return this.SPOTLIGHTDIRECTION=Bq.propertyNameToID("u_SpotLight.Direction");},"SPOTLIGHTSPOTANGLE",function(){return this.SPOTLIGHTSPOTANGLE=Bq.propertyNameToID("u_SpotLight.Spot");},"SPOTLIGHTRANGE",function(){return this.SPOTLIGHTRANGE=Bq.propertyNameToID("u_SpotLight.Range");},"SPOTLIGHTCOLOR",function(){return this.SPOTLIGHTCOLOR=Bq.propertyNameToID("u_SpotLight.Color");},"SHADOWDISTANCE",function(){return this.SHADOWDISTANCE=Bq.propertyNameToID("u_shadowPSSMDistance");},"SHADOWLIGHTVIEWPROJECT",function(){return this.SHADOWLIGHTVIEWPROJECT=Bq.propertyNameToID("u_lightShadowVP");},"SHADOWMAPPCFOFFSET",function(){return this.SHADOWMAPPCFOFFSET=Bq.propertyNameToID("u_shadowPCFoffset");},"SHADOWMAPTEXTURE1",function(){return this.SHADOWMAPTEXTURE1=Bq.propertyNameToID("u_shadowMap1");},"SHADOWMAPTEXTURE2",function(){return this.SHADOWMAPTEXTURE2=Bq.propertyNameToID("u_shadowMap2");},"SHADOWMAPTEXTURE3",function(){return this.SHADOWMAPTEXTURE3=Bq.propertyNameToID("u_shadowMap3");},"AMBIENTCOLOR",function(){return this.AMBIENTCOLOR=Bq.propertyNameToID("u_AmbientColor");},"REFLECTIONTEXTURE",function(){return this.REFLECTIONTEXTURE=Bq.propertyNameToID("u_ReflectTexture");},"REFLETIONINTENSITY",function(){return this.REFLETIONINTENSITY=Bq.propertyNameToID("u_ReflectIntensity");},"TIME",function(){return this.TIME=Bq.propertyNameToID("u_Time");},"ANGLEATTENUATIONTEXTURE",function(){return this.ANGLEATTENUATIONTEXTURE=Bq.propertyNameToID("u_AngleTexture");},"RANGEATTENUATIONTEXTURE",function(){return this.RANGEATTENUATIONTEXTURE=Bq.propertyNameToID("u_RangeTexture");},"POINTLIGHTMATRIX",function(){return this.POINTLIGHTMATRIX=Bq.propertyNameToID("u_PointLightMatrix");},"SPOTLIGHTMATRIX",function(){return this.SPOTLIGHTMATRIX=Bq.propertyNameToID("u_SpotLightMatrix");}]),m;}(T),Im=function(m){function Q(q){this.pickColor=null,this._render=null,Q.__super.call(this,q);}
S(Q,"laya.d3.core.RenderableSprite3D",m);var q=Q.prototype;return q._onInActive=function(){laya.display.Node.prototype._onInActive.call(this);var q=this._scene;q._removeRenderObject(this._render),this._render.castShadow&&q._removeShadowCastRenderObject(this._render);},q._onActive=function(){laya.display.Node.prototype._onActive.call(this);var q=this._scene;q._addRenderObject(this._render),this._render.castShadow&&q._addShadowCastRenderObject(this._render);},q._onActiveInScene=function(){if(laya.display.Node.prototype._onActiveInScene.call(this),R._editerEnvironment){var q=this._scene,Q=new rq();q._allotPickColorByID(this.id,Q),(q._pickIdToSprite[this.id]=this)._render._shaderValues.setVector(laya.d3.core.RenderableSprite3D.PICKCOLOR,Q);}},q._addToInitStaticBatchManager=function(){},q._setBelongScene=function(q){laya.display.Node.prototype._setBelongScene.call(this,q),this._render._setBelongScene(q);},q._setUnBelongScene=function(){this._render._defineDatas.remove(laya.d3.core.RenderableSprite3D.SAHDERDEFINE_LIGHTMAP),laya.display.Node.prototype._setUnBelongScene.call(this);},q._changeHierarchyAnimator=function(q){if(this._hierarchyAnimator){var Q=this._hierarchyAnimator._renderableSprites;Q.splice(Q.indexOf(this),1);}
q&&q._renderableSprites.push(this),m.prototype._changeHierarchyAnimator.call(this,q);},q.destroy=function(q){void 0===q&&(q=!0),m.prototype.destroy.call(this,q),this._render._destroy(),this._render=null;},Q.__init__=function(){Q.SHADERDEFINE_RECEIVE_SHADOW=Q.shaderDefines.registerDefine("RECEIVESHADOW"),Q.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=Q.shaderDefines.registerDefine("SCALEOFFSETLIGHTINGMAPUV"),Q.SAHDERDEFINE_LIGHTMAP=Q.shaderDefines.registerDefine("LIGHTMAP");},Q.SHADERDEFINE_RECEIVE_SHADOW=0,Q.SHADERDEFINE_SCALEOFFSETLIGHTINGMAPUV=0,Q.SAHDERDEFINE_LIGHTMAP=0,y(Q,["LIGHTMAPSCALEOFFSET",function(){return this.LIGHTMAPSCALEOFFSET=Bq.propertyNameToID("u_LightmapScaleOffset");},"LIGHTMAP",function(){return this.LIGHTMAP=Bq.propertyNameToID("u_LightMap");},"PICKCOLOR",function(){return this.PICKCOLOR=Bq.propertyNameToID("u_PickColor");},"shaderDefines",function(){return this.shaderDefines=new dq();}]),Q;}(Mm),Pm=function(q){function m(){this._albedoIntensity=1,this._enableVertexColor=!1,this._albedoColor=new rq(1,1,1,1),m.__super.call(this),this.setShaderName("Unlit"),this._shaderValues.setVector(m.ALBEDOCOLOR,new rq(1,1,1,1)),this.renderMode=0;}
S(m,"laya.d3.core.material.UnlitMaterial",Ym);var Q=m.prototype;return d(0,Q,"_ColorB",function(){return this._albedoColor.z;},function(q){this._albedoColor.z=q,this.albedoColor=this._albedoColor;}),d(0,Q,"_ColorR",function(){return this._albedoColor.x;},function(q){this._albedoColor.x=q,this.albedoColor=this._albedoColor;}),d(0,Q,"albedoColorA",function(){return this._ColorA;},function(q){this._ColorA=q;}),d(0,Q,"_MainTex_STX",function(){return this._shaderValues.getVector(m.TILINGOFFSET).x;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.x=q,this.tilingOffset=Q;}),d(0,Q,"_ColorG",function(){return this._albedoColor.y;},function(q){this._albedoColor.y=q,this.albedoColor=this._albedoColor;}),d(0,Q,"_ColorA",function(){return this._albedoColor.w;},function(q){this._albedoColor.w=q,this.albedoColor=this._albedoColor;}),d(0,Q,"_AlbedoIntensity",function(){return this._albedoIntensity;},function(q){if(this._albedoIntensity!==q){var Q=this._shaderValues.getVector(m.ALBEDOCOLOR);rq.scale(this._albedoColor,q,Q),this._albedoIntensity=q,this._shaderValues.setVector(m.ALBEDOCOLOR,Q);}}),d(0,Q,"_MainTex_STZ",function(){return this._shaderValues.getVector(m.TILINGOFFSET).z;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.z=q,this.tilingOffset=Q;}),d(0,Q,"_MainTex_STY",function(){return this._shaderValues.getVector(m.TILINGOFFSET).y;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.y=q,this.tilingOffset=Q;}),d(0,Q,"_Cutoff",function(){return this.alphaTestValue;},function(q){this.alphaTestValue=q;}),d(0,Q,"_MainTex_STW",function(){return this._shaderValues.getVector(m.TILINGOFFSET).w;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.w=q,this.tilingOffset=Q;}),d(0,Q,"albedoColorR",function(){return this._ColorR;},function(q){this._ColorR=q;}),d(0,Q,"albedoColorG",function(){return this._ColorG;},function(q){this._ColorG=q;}),d(0,Q,"albedoColorB",function(){return this._ColorB;},function(q){this._ColorB=q;}),d(0,Q,"tilingOffsetX",function(){return this._MainTex_STX;},function(q){this._MainTex_STX=q;}),d(0,Q,"albedoColor",function(){return this._albedoColor;},function(q){var Q=this._shaderValues.getVector(m.ALBEDOCOLOR);rq.scale(q,this._albedoIntensity,Q),this._albedoColor=q,this._shaderValues.setVector(m.ALBEDOCOLOR,Q);}),d(0,Q,"albedoIntensity",function(){return this._albedoIntensity;},function(q){this._AlbedoIntensity=q;}),d(0,Q,"enableVertexColor",function(){return this._enableVertexColor;},function(q){(this._enableVertexColor=q)?this._defineDatas.add(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR):this._defineDatas.remove(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR);}),d(0,Q,"albedoTexture",function(){return this._shaderValues.getTexture(m.ALBEDOTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._defineDatas.remove(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(m.ALBEDOTEXTURE,q);}),d(0,Q,"tilingOffsetY",function(){return this._MainTex_STY;},function(q){this._MainTex_STY=q;}),d(0,Q,"tilingOffsetZ",function(){return this._MainTex_STZ;},function(q){this._MainTex_STZ=q;}),d(0,Q,"blendSrc",function(){return this._shaderValues.getInt(m.BLEND_SRC);},function(q){this._shaderValues.setInt(m.BLEND_SRC,q);}),d(0,Q,"tilingOffsetW",function(){return this._MainTex_STW;},function(q){this._MainTex_STW=q;}),d(0,Q,"tilingOffset",function(){return this._shaderValues.getVector(m.TILINGOFFSET);},function(q){q&&(1!=q.x||1!=q.y||0!=q.z||0!=q.w)?this._defineDatas.add(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.UnlitMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(m.TILINGOFFSET,q);}),d(0,Q,"renderMode",null,function(q){switch(q){case 0:this.alphaTest=!1,this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 1:this.renderQueue=2450,this.alphaTest=!0,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=2,this.blend=1,this.blendSrc=770,this.blendDst=771,this.depthTest=513;break;default:throw new Error("UnlitMaterial : renderMode value error.");}}),d(0,Q,"depthWrite",function(){return this._shaderValues.getBool(m.DEPTH_WRITE);},function(q){this._shaderValues.setBool(m.DEPTH_WRITE,q);}),d(0,Q,"cull",function(){return this._shaderValues.getInt(m.CULL);},function(q){this._shaderValues.setInt(m.CULL,q);}),d(0,Q,"blend",function(){return this._shaderValues.getInt(m.BLEND);},function(q){this._shaderValues.setInt(m.BLEND,q);}),d(0,Q,"blendDst",function(){return this._shaderValues.getInt(m.BLEND_DST);},function(q){this._shaderValues.setInt(m.BLEND_DST,q);}),d(0,Q,"depthTest",function(){return this._shaderValues.getInt(m.DEPTH_TEST);},function(q){this._shaderValues.setInt(m.DEPTH_TEST,q);}),m.__init__=function(){m.SHADERDEFINE_ALBEDOTEXTURE=m.shaderDefines.registerDefine("ALBEDOTEXTURE"),m.SHADERDEFINE_TILINGOFFSET=m.shaderDefines.registerDefine("TILINGOFFSET"),m.SHADERDEFINE_ENABLEVERTEXCOLOR=m.shaderDefines.registerDefine("ENABLEVERTEXCOLOR");},m.RENDERMODE_OPAQUE=0,m.RENDERMODE_CUTOUT=1,m.RENDERMODE_TRANSPARENT=2,m.RENDERMODE_ADDTIVE=3,m.SHADERDEFINE_ALBEDOTEXTURE=0,m.SHADERDEFINE_TILINGOFFSET=0,m.SHADERDEFINE_ENABLEVERTEXCOLOR=0,y(m,["ALBEDOTEXTURE",function(){return this.ALBEDOTEXTURE=Bq.propertyNameToID("u_AlbedoTexture");},"ALBEDOCOLOR",function(){return this.ALBEDOCOLOR=Bq.propertyNameToID("u_AlbedoColor");},"TILINGOFFSET",function(){return this.TILINGOFFSET=Bq.propertyNameToID("u_TilingOffset");},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"defaultMaterial",function(){return this.defaultMaterial=new m();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),m;}(),Xm=function(a){function Q(){this._intensityColor=null,this._intensity=NaN,this._shadow=!1,this._shadowFarPlane=0,this._shadowMapSize=0,this._shadowMapCount=0,this._shadowMapPCFType=0,this._parallelSplitShadowMap=null,this._lightmapBakedType=0,this.color=null,Q.__super.call(this),this._intensity=1,this._intensityColor=new _q(),this.color=new _q(1,1,1),this._shadow=!1,this._shadowFarPlane=8,this._shadowMapSize=512,this._shadowMapCount=1,this._shadowMapPCFType=0,this._lightmapBakedType=Q.LIGHTMAPBAKEDTYPE_REALTIME;}
S(Q,"laya.d3.core.light.LightSprite",a);var q=Q.prototype;return q._parse=function(q,Q){a.prototype._parse.call(this,q,Q);var m=q.color;this.color.fromArray(m),this.intensity=q.intensity,this.lightmapBakedType=q.lightmapBakedType;},q._onActive=function(){laya.display.Node.prototype._onActive.call(this),this.lightmapBakedType!==Q.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._addLight(this);},q._onInActive=function(){laya.display.Node.prototype._onInActive.call(this),this.lightmapBakedType!==Q.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._removeLight(this);},q._prepareToScene=function(){return!1;},d(0,q,"lightmapBakedType",function(){return this._lightmapBakedType;},function(q){this._lightmapBakedType!==q&&(this._lightmapBakedType=q,this.activeInHierarchy&&(q!==Q.LIGHTMAPBAKEDTYPE_BAKED?this._scene._addLight(this):this._scene._removeLight(this)));}),d(0,q,"shadowPCFType",function(){return this._shadowMapPCFType;},function(q){this._shadowMapPCFType=q,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setPCFType(q);}),d(0,q,"intensity",function(){return this._intensity;},function(q){this._intensity=q;}),d(0,q,"shadow",function(){return this._shadow;},function(q){throw new Error("LightSprite: must override it.");}),d(0,q,"shadowDistance",function(){return this._shadowFarPlane;},function(q){this._shadowFarPlane=q,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setFarDistance(q);}),d(0,q,"shadowPSSMCount",function(){return this._shadowMapCount;},function(q){this._shadowMapCount=q,this._parallelSplitShadowMap&&(this._parallelSplitShadowMap.shadowMapCount=q);}),d(0,q,"shadowResolution",function(){return this._shadowMapSize;},function(q){this._shadowMapSize=q,this._parallelSplitShadowMap&&this._parallelSplitShadowMap.setShadowMapTextureSize(q);}),d(0,q,"diffuseColor",function(){return console.log("LightSprite: discard property,please use color property instead."),this.color;},function(q){console.log("LightSprite: discard property,please use color property instead."),this.color=q;}),Q.LIGHTMAPBAKEDTYPE_REALTIME=0,Q.LIGHTMAPBAKEDTYPE_MIXED=1,Q.LIGHTMAPBAKEDTYPE_BAKED=2,Q;}(Mm),qa=function(w){function D(q){this._terrainRes=null,this._lightmapScaleOffset=null,D.__super.call(this),this._lightmapScaleOffset=new rq(1,1,0,0),q&&(this._terrainRes=q,this.buildTerrain(q));}
S(D,"laya.d3.terrain.Terrain",w);var q=D.prototype;return q._parse=function(q,Q){w.prototype._parse.call(this,q,Q),this.terrainRes=uq.getRes(q.dataPath);var m=q.lightmapIndex;null!=m&&this.setLightmapIndex(m);var a=q.lightmapScaleOffset;a&&this.setLightmapScaleOffset(new rq(a[0],a[1],a[2],a[3]));},q.setLightmapIndex=function(q){for(var Q=0;Q<this._children.length;Q++){this._children[Q].terrainRender.lightmapIndex=q;}},q.setLightmapScaleOffset=function(q){if(q){q.cloneTo(this._lightmapScaleOffset);for(var Q=0;Q<this._children.length;Q++){this._children[Q].terrainRender.lightmapScaleOffset=this._lightmapScaleOffset;}}},q.disableLight=function(){for(var q=0,Q=this._children.length;q<Q;q++)
for(var m=this._children[q],a=0,w=m._render.sharedMaterials.length;a<w;a++){m._render.sharedMaterials[a].disableLight();}},q.buildTerrain=function(q){for(var Q=q._chunkNumX,m=q._chunkNumZ,a=q._heightData,w=0,e=0;e<m;e++)
for(var F=0;F<Q;F++){for(var W=new fa(F,e,q._gridSize,a._terrainHeightData,a._width,a._height,q._cameraCoordinateInverse),s=q._chunkInfos[w++],D=0;D<s.alphaMap.length;D++){var d=s.detailID[D].length,v=0<d?q._detailTextureInfos[s.detailID[D][0]].diffuseTexture:null,y=1<d?q._detailTextureInfos[s.detailID[D][1]].diffuseTexture:null,S=2<d?q._detailTextureInfos[s.detailID[D][2]].diffuseTexture:null,t=3<d?q._detailTextureInfos[s.detailID[D][3]].diffuseTexture:null,o=0<d?q._detailTextureInfos[s.detailID[D][0]].scale:null,b=1<d?q._detailTextureInfos[s.detailID[D][1]].scale:null,U=2<d?q._detailTextureInfos[s.detailID[D][2]].scale:null,J=3<d?q._detailTextureInfos[s.detailID[D][3]].scale:null;W.buildRenderElementAndMaterial(d,s.normalMap,s.alphaMap[D],v,y,S,t,q._materialInfo.ambientColor,q._materialInfo.diffuseColor,q._materialInfo.specularColor,o?o.x:1,o?o.y:1,b?b.x:1,b?b.y:1,U?U.x:1,U?U.y:1,J?J.x:1,J?J.y:1);}
W.terrainRender.receiveShadow=!0,W.terrainRender.lightmapScaleOffset=this._lightmapScaleOffset,this.addChild(W);}},q.width=function(){return this._terrainRes._chunkNumX*Wq.CHUNK_GRID_NUM*this._terrainRes._gridSize;},q.depth=function(){return this._terrainRes._chunkNumZ*Wq.CHUNK_GRID_NUM*this._terrainRes._gridSize;},q.getHeightXZ=function(q,Q){if(!this._terrainRes)return NaN;if(q-=this.transform.position.x,Q-=this.transform.position.z,D.__VECTOR3__||(D.__VECTOR3__=new _q()),D.__VECTOR3__.x=q,D.__VECTOR3__.y=0,D.__VECTOR3__.z=Q,_q.transformV3ToV3(D.__VECTOR3__,Wq.__ADAPT_MATRIX_INV__,D.__VECTOR3__),q=D.__VECTOR3__.x,Q=D.__VECTOR3__.z,q<0||q>this.width()||Q<0||Q>this.depth())return NaN;var m=this._terrainRes._gridSize,a=parseInt(""+q/m),w=parseInt(""+Q/m),e=q-a*m,F=Q-w*m,W=NaN,s=this._terrainRes._heightData;return m<e+F?(W=s._terrainHeightData[(w+1-1)*s._width+a+1])+(s._terrainHeightData[(w+1-1)*s._width+a]-W)*((m-e)/m)+(s._terrainHeightData[(w-1)*s._width+a+1]-W)*((m-F)/m):(W=s._terrainHeightData[Math.max(0,w-1)*s._width+a])+(s._terrainHeightData[Math.min(s._width*s._height-1,(w+1-1)*s._width+a)]-W)*(F/m)+(s._terrainHeightData[Math.min(s._width*s._height-1,Math.max(0,w-1)*s._width+a+1)]-W)*(e/m);},d(0,q,"terrainRes",null,function(q){q&&(this._terrainRes=q,this.buildTerrain(q));}),D.load=function(q){o.loader.create(q,null,null,"TERRAIN",null,null,1,!1);},D.RENDER_LINE_MODEL=!1,D.LOD_TOLERANCE_VALUE=4,D.LOD_DISTANCE_FACTOR=2,D.__VECTOR3__=null,D;}(Mm),Qa=function(q){function m(){this._color=null,m.__super.call(this),this.setShaderName("Trail"),this._color=new rq(1,1,1,1),this._shaderValues.setVector(m.TINTCOLOR,new rq(1,1,1,1)),this.renderMode=0;}
S(m,"laya.d3.core.trail.TrailMaterial",Ym);var Q=m.prototype;return d(0,Q,"_TintColorB",function(){return this._color.z;},function(q){this._color.z=q,this.color=this._color;}),d(0,Q,"_MainTex_STZ",function(){return this._shaderValues.getVector(m.TILINGOFFSET).z;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.z=q,this.tilingOffset=Q;}),d(0,Q,"texture",function(){return this._shaderValues.getTexture(m.MAINTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_MAINTEXTURE):this._defineDatas.remove(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(m.MAINTEXTURE,q);}),d(0,Q,"_TintColorR",function(){return this._color.x;},function(q){this._color.x=q,this.color=this._color;}),d(0,Q,"_MainTex_STW",function(){return this._shaderValues.getVector(m.TILINGOFFSET).w;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.w=q,this.tilingOffset=Q;}),d(0,Q,"_TintColorG",function(){return this._color.y;},function(q){this._color.y=q,this.color=this._color;}),d(0,Q,"_TintColorA",function(){return this._color.w;},function(q){this._color.w=q,this.color=this._color;}),d(0,Q,"_MainTex_STY",function(){return this._shaderValues.getVector(m.TILINGOFFSET).y;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.y=q,this.tilingOffset=Q;}),d(0,Q,"renderMode",null,function(q){switch(q){case 1:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=0,this.blend=1,this.blendSrc=770,this.blendDst=1,this.depthTest=513,this._defineDatas.add(m.SHADERDEFINE_ADDTIVEFOG);break;case 0:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=0,this.blend=1,this.blendSrc=770,this.blendDst=771,this.depthTest=513,this._defineDatas.remove(m.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("TrailMaterial : renderMode value error.");}}),d(0,Q,"_MainTex_STX",function(){return this._shaderValues.getVector(m.TILINGOFFSET).x;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.x=q,this.tilingOffset=Q;}),d(0,Q,"colorR",function(){return this._TintColorR;},function(q){this._TintColorR=q;}),d(0,Q,"colorG",function(){return this._TintColorG;},function(q){this._TintColorG=q;}),d(0,Q,"colorB",function(){return this._TintColorB;},function(q){this._TintColorB=q;}),d(0,Q,"colorA",function(){return this._TintColorA;},function(q){this._TintColorA=q;}),d(0,Q,"blend",function(){return this._shaderValues.getInt(m.BLEND);},function(q){this._shaderValues.setInt(m.BLEND,q);}),d(0,Q,"color",function(){return this._shaderValues.getVector(m.TINTCOLOR);},function(q){this._shaderValues.setVector(m.TINTCOLOR,q);}),d(0,Q,"tilingOffsetX",function(){return this._MainTex_STX;},function(q){this._MainTex_STX=q;}),d(0,Q,"tilingOffsetY",function(){return this._MainTex_STY;},function(q){this._MainTex_STY=q;}),d(0,Q,"tilingOffsetZ",function(){return this._MainTex_STZ;},function(q){this._MainTex_STZ=q;}),d(0,Q,"blendSrc",function(){return this._shaderValues.getInt(m.BLEND_SRC);},function(q){this._shaderValues.setInt(m.BLEND_SRC,q);}),d(0,Q,"tilingOffsetW",function(){return this._MainTex_STW;},function(q){this._MainTex_STW=q;}),d(0,Q,"tilingOffset",function(){return this._shaderValues.getVector(m.TILINGOFFSET);},function(q){q&&(1!=q.x||1!=q.y||0!=q.z||0!=q.w)?this._defineDatas.add(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.trail.TrailMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(m.TILINGOFFSET,q);}),d(0,Q,"depthWrite",function(){return this._shaderValues.getBool(m.DEPTH_WRITE);},function(q){this._shaderValues.setBool(m.DEPTH_WRITE,q);}),d(0,Q,"cull",function(){return this._shaderValues.getInt(m.CULL);},function(q){this._shaderValues.setInt(m.CULL,q);}),d(0,Q,"blendDst",function(){return this._shaderValues.getInt(m.BLEND_DST);},function(q){this._shaderValues.setInt(m.BLEND_DST,q);}),d(0,Q,"depthTest",function(){return this._shaderValues.getInt(m.DEPTH_TEST);},function(q){this._shaderValues.setInt(m.DEPTH_TEST,q);}),m.__init__=function(){m.SHADERDEFINE_MAINTEXTURE=m.shaderDefines.registerDefine("MAINTEXTURE"),m.SHADERDEFINE_TILINGOFFSET=m.shaderDefines.registerDefine("TILINGOFFSET"),m.SHADERDEFINE_ADDTIVEFOG=m.shaderDefines.registerDefine("ADDTIVEFOG");},m.RENDERMODE_ALPHABLENDED=0,m.RENDERMODE_ADDTIVE=1,m.SHADERDEFINE_MAINTEXTURE=0,m.SHADERDEFINE_TILINGOFFSET=0,m.SHADERDEFINE_ADDTIVEFOG=0,y(m,["defaultMaterial",function(){return this.defaultMaterial=new m();},"MAINTEXTURE",function(){return this.MAINTEXTURE=Bq.propertyNameToID("u_MainTexture");},"TINTCOLOR",function(){return this.TINTCOLOR=Bq.propertyNameToID("u_MainColor");},"TILINGOFFSET",function(){return this.TILINGOFFSET=Bq.propertyNameToID("u_TilingOffset");},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),m;}(),ma=function(q){function Q(){this._sunDisk=0,Q.__super.call(this),this.setShaderName("SkyBoxProcedural"),this.sunDisk=1,this.sunSize=.04,this.sunSizeConvergence=5,this.atmosphereThickness=1,this.skyTint=new rq(.5,.5,.5,1),this.groundTint=new rq(.369,.349,.341,1),this.exposure=1.3;}
S(Q,"laya.d3.core.material.SkyProceduralMaterial",Ym);var m=Q.prototype;return d(0,m,"exposure",function(){return this._shaderValues.getNumber(Q.EXPOSURE);},function(q){q=Math.min(Math.max(0,q),8),this._shaderValues.setNumber(Q.EXPOSURE,q);}),d(0,m,"sunSize",function(){return this._shaderValues.getNumber(Q.SUNSIZE);},function(q){q=Math.min(Math.max(0,q),1),this._shaderValues.setNumber(Q.SUNSIZE,q);}),d(0,m,"sunDisk",function(){return this._sunDisk;},function(q){switch(q){case 1:this._defineDatas.remove(Q.SHADERDEFINE_SUN_SIMPLE),this._defineDatas.add(Q.SHADERDEFINE_SUN_HIGH_QUALITY);break;case 2:this._defineDatas.remove(Q.SHADERDEFINE_SUN_HIGH_QUALITY),this._defineDatas.add(Q.SHADERDEFINE_SUN_SIMPLE);break;case 0:this._defineDatas.remove(Q.SHADERDEFINE_SUN_HIGH_QUALITY),this._defineDatas.remove(Q.SHADERDEFINE_SUN_SIMPLE);break;default:throw"SkyBoxProceduralMaterial: unknown sun value.";}
this._sunDisk=q;}),d(0,m,"sunSizeConvergence",function(){return this._shaderValues.getNumber(Q.SUNSIZECONVERGENCE);},function(q){q=Math.min(Math.max(0,q),20),this._shaderValues.setNumber(Q.SUNSIZECONVERGENCE,q);}),d(0,m,"atmosphereThickness",function(){return this._shaderValues.getNumber(Q.ATMOSPHERETHICKNESS);},function(q){q=Math.min(Math.max(0,q),5),this._shaderValues.setNumber(Q.ATMOSPHERETHICKNESS,q);}),d(0,m,"groundTint",function(){return this._shaderValues.getVector(Q.GROUNDTINT);},function(q){this._shaderValues.setVector(Q.GROUNDTINT,q);}),d(0,m,"skyTint",function(){return this._shaderValues.getVector(Q.SKYTINT);},function(q){this._shaderValues.setVector(Q.SKYTINT,q);}),Q.__init__=function(){Q.SHADERDEFINE_SUN_HIGH_QUALITY=Q.shaderDefines.registerDefine("SUN_HIGH_QUALITY"),Q.SHADERDEFINE_SUN_SIMPLE=Q.shaderDefines.registerDefine("SUN_SIMPLE");},Q.SUN_NODE=0,Q.SUN_HIGH_QUALITY=1,Q.SUN_SIMPLE=2,Q.SHADERDEFINE_SUN_HIGH_QUALITY=0,Q.SHADERDEFINE_SUN_SIMPLE=0,y(Q,["SUNSIZE",function(){return this.SUNSIZE=Bq.propertyNameToID("u_SunSize");},"SUNSIZECONVERGENCE",function(){return this.SUNSIZECONVERGENCE=Bq.propertyNameToID("u_SunSizeConvergence");},"ATMOSPHERETHICKNESS",function(){return this.ATMOSPHERETHICKNESS=Bq.propertyNameToID("u_AtmosphereThickness");},"SKYTINT",function(){return this.SKYTINT=Bq.propertyNameToID("u_SkyTint");},"GROUNDTINT",function(){return this.GROUNDTINT=Bq.propertyNameToID("u_GroundTint");},"EXPOSURE",function(){return this.EXPOSURE=Bq.propertyNameToID("u_Exposure");},"defaultMaterial",function(){return this.defaultMaterial=new Q();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),Q;}(),aa=function(q){function Q(){Q.__super.call(this),this.setShaderName("LineShader"),this._shaderValues.setVector(Q.COLOR,new rq(1,1,1,1));}
S(Q,"laya.d3.core.pixelLine.PixelLineMaterial",Ym);var m=Q.prototype;return d(0,m,"blend",function(){return this._shaderValues.getInt(Q.BLEND);},function(q){this._shaderValues.setInt(Q.BLEND,q);}),d(0,m,"color",function(){return this._shaderValues.getVector(Q.COLOR);},function(q){this._shaderValues.setVector(Q.COLOR,q);}),d(0,m,"cull",function(){return this._shaderValues.getInt(Q.CULL);},function(q){this._shaderValues.setInt(Q.CULL,q);}),d(0,m,"depthWrite",function(){return this._shaderValues.getBool(Q.DEPTH_WRITE);},function(q){this._shaderValues.setBool(Q.DEPTH_WRITE,q);}),d(0,m,"blendSrc",function(){return this._shaderValues.getInt(Q.BLEND_SRC);},function(q){this._shaderValues.setInt(Q.BLEND_SRC,q);}),d(0,m,"blendDst",function(){return this._shaderValues.getInt(Q.BLEND_DST);},function(q){this._shaderValues.setInt(Q.BLEND_DST,q);}),d(0,m,"depthTest",function(){return this._shaderValues.getInt(Q.DEPTH_TEST);},function(q){this._shaderValues.setInt(Q.DEPTH_TEST,q);}),y(Q,["COLOR",function(){return this.COLOR=Bq.propertyNameToID("u_Color");},"defaultMaterial",function(){return this.defaultMaterial=new Q();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");}]),Q;}(),wa=function(e){function F(q,Q){F.__super.call(this),this._skyRenderer=new oQ(),this._forward=new _q(),this._up=new _q(),this.clearColor=new rq(100/255,149/255,237/255,1),void 0===q&&(q=.3),void 0===Q&&(Q=1e3),this._shaderValues=new Fq(null),this._fieldOfView=60,this._useUserProjectionMatrix=!1,this._orthographic=!1,this._orthographicVerticalSize=10,this.renderingOrder=0,this._nearPlane=q,this._farPlane=Q,this.cullingMask=2147483647,this.clearFlag=0,this.useOcclusionCulling=!0,this._calculateProjectionMatrix(),o.stage.on("resize",this,this._onScreenSizeChanged);}
S(F,"laya.d3.core.BaseCamera",e);var q=F.prototype;return q._sortCamerasByRenderingOrder=function(){if(this.displayedInStage)
for(var q=this.scene._cameraPool,Q=q.length-1,m=0;m<Q;m++)
if(q[m].renderingOrder>q[Q].renderingOrder){var a=q[m];q[m]=q[Q],q[Q]=a;}},q._calculateProjectionMatrix=function(){},q._onScreenSizeChanged=function(){this._calculateProjectionMatrix();},q._prepareCameraToRender=function(){this.transform.getForward(this._forward),this.transform.getUp(this._up);var q=this._shaderValues;q.setVector3(laya.d3.core.BaseCamera.CAMERAPOS,this.transform.position),q.setVector3(laya.d3.core.BaseCamera.CAMERADIRECTION,this._forward),q.setVector3(laya.d3.core.BaseCamera.CAMERAUP,this._up);},q._prepareCameraViewProject=function(q,Q,m,a){var w=this._shaderValues;w.setMatrix4x4(laya.d3.core.BaseCamera.VIEWMATRIX,q),w.setMatrix4x4(laya.d3.core.BaseCamera.PROJECTMATRIX,Q),w.setMatrix4x4(laya.d3.core.BaseCamera.VIEWPROJECTMATRIX,m),this.transform.worldMatrix.cloneTo(F._tempMatrix4x40),F._tempMatrix4x40.transpose(),kQ.multiply(Q,F._tempMatrix4x40,a),w.setMatrix4x4(laya.d3.core.BaseCamera.VPMATRIX_NO_TRANSLATE,a);},q.render=function(q,Q){},q.addLayer=function(q){this.cullingMask|=Math.pow(2,q);},q.removeLayer=function(q){this.cullingMask&=~Math.pow(2,q);},q.addAllLayers=function(){this.cullingMask=2147483647;},q.removeAllLayers=function(){this.cullingMask=0;},q.resetProjectionMatrix=function(){this._useUserProjectionMatrix=!1,this._calculateProjectionMatrix();},q._onActive=function(){this._scene._addCamera(this),laya.display.Node.prototype._onActive.call(this);},q._onInActive=function(){this._scene._removeCamera(this),laya.display.Node.prototype._onInActive.call(this);},q._parse=function(q,Q){e.prototype._parse.call(this,q,Q);var m=q.clearFlag;void 0!==m&&(this.clearFlag=m),this.orthographic=q.orthographic,this.fieldOfView=q.fieldOfView,this.nearPlane=q.nearPlane,this.farPlane=q.farPlane;var a=q.clearColor;this.clearColor=new rq(a[0],a[1],a[2],a[3]);var w=q.skyboxMaterial;w&&(this._skyRenderer.material=uq.getRes(w.path));},q.destroy=function(q){void 0===q&&(q=!0),this._skyRenderer.destroy(),this._skyRenderer=null,o.stage.off("resize",this,this._onScreenSizeChanged),e.prototype.destroy.call(this,q);},d(0,q,"renderingOrder",function(){return this._renderingOrder;},function(q){this._renderingOrder=q,this._sortCamerasByRenderingOrder();}),d(0,q,"skyRenderer",function(){return this._skyRenderer;}),d(0,q,"orthographic",function(){return this._orthographic;},function(q){this._orthographic=q,this._calculateProjectionMatrix();}),d(0,q,"fieldOfView",function(){return this._fieldOfView;},function(q){this._fieldOfView=q,this._calculateProjectionMatrix();}),d(0,q,"nearPlane",function(){return this._nearPlane;},function(q){this._nearPlane=q,this._calculateProjectionMatrix();}),d(0,q,"farPlane",function(){return this._farPlane;},function(q){this._farPlane=q,this._calculateProjectionMatrix();}),d(0,q,"orthographicVerticalSize",function(){return this._orthographicVerticalSize;},function(q){this._orthographicVerticalSize=q,this._calculateProjectionMatrix();}),F.RENDERINGTYPE_DEFERREDLIGHTING="DEFERREDLIGHTING",F.RENDERINGTYPE_FORWARDRENDERING="FORWARDRENDERING",F.CLEARFLAG_SOLIDCOLOR=0,F.CLEARFLAG_SKY=1,F.CLEARFLAG_DEPTHONLY=2,F.CLEARFLAG_NONE=3,y(F,["_tempMatrix4x40",function(){return this._tempMatrix4x40=new kQ();},"CAMERAPOS",function(){return this.CAMERAPOS=Bq.propertyNameToID("u_CameraPos");},"VIEWMATRIX",function(){return this.VIEWMATRIX=Bq.propertyNameToID("u_View");},"PROJECTMATRIX",function(){return this.PROJECTMATRIX=Bq.propertyNameToID("u_Projection");},"VIEWPROJECTMATRIX",function(){return this.VIEWPROJECTMATRIX=Bq.propertyNameToID("u_ViewProjection");},"VPMATRIX_NO_TRANSLATE",function(){return this.VPMATRIX_NO_TRANSLATE=Bq.propertyNameToID("u_MvpMatrix");},"CAMERADIRECTION",function(){return this.CAMERADIRECTION=Bq.propertyNameToID("u_CameraDirection");},"CAMERAUP",function(){return this.CAMERAUP=Bq.propertyNameToID("u_CameraUp");},"_invertYScaleMatrix",function(){return this._invertYScaleMatrix=new kQ(1,0,0,0,0,-1,0,0,0,0,1,0,0,0,0,1);},"_invertYProjectionMatrix",function(){return this._invertYProjectionMatrix=new kQ();},"_invertYProjectionViewMatrix",function(){return this._invertYProjectionViewMatrix=new kQ();}]),F;}(Mm),ea=function(m){function a(){this._albedoColor=null,this._emissionColor=null,a.__super.call(this),this.setShaderName("PBRStandard"),this._albedoColor=new rq(1,1,1,1),this._shaderValues.setVector(a.ALBEDOCOLOR,new rq(1,1,1,1)),this._emissionColor=new rq(0,0,0,0),this._shaderValues.setVector(a.EMISSIONCOLOR,new rq(0,0,0,0)),this._shaderValues.setNumber(a.METALLIC,0),this._shaderValues.setNumber(a.SMOOTHNESS,.5),this._shaderValues.setNumber(a.SMOOTHNESSSCALE,1),this._shaderValues.setNumber(a.SMOOTHNESSSOURCE,0),this._shaderValues.setNumber(a.OCCLUSIONSTRENGTH,1),this._shaderValues.setNumber(a.NORMALSCALE,1),this._shaderValues.setNumber(a.PARALLAXSCALE,.001),this._shaderValues.setBool(a.ENABLEEMISSION,!1),this._shaderValues.setBool(a.ENABLEREFLECT,!0),this._shaderValues.setNumber(Ym.ALPHATESTVALUE,.5),this._disablePublicDefineDatas.remove(gm.SHADERDEFINE_REFLECTMAP),this.renderMode=0;}
S(a,"laya.d3.core.material.PBRStandardMaterial",m);var q=a.prototype;return q.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;this._albedoColor.cloneTo(Q._albedoColor),this._emissionColor.cloneTo(Q._emissionColor);},d(0,q,"_Parallax",function(){return this._shaderValues.getNumber(a.PARALLAXSCALE);},function(q){this._shaderValues.setNumber(a.PARALLAXSCALE,q);}),d(0,q,"_ColorB",function(){return this._albedoColor.z;},function(q){this._albedoColor.z=q,this.albedoColor=this._albedoColor;}),d(0,q,"_ColorR",function(){return this._albedoColor.x;},function(q){this._albedoColor.x=q,this.albedoColor=this._albedoColor;}),d(0,q,"_ColorG",function(){return this._albedoColor.y;},function(q){this._albedoColor.y=q,this.albedoColor=this._albedoColor;}),d(0,q,"metallic",function(){return this._Metallic;},function(q){this._Metallic=Math.max(0,Math.min(1,q));}),d(0,q,"_GlossMapScale",function(){return this._shaderValues.getNumber(a.SMOOTHNESSSCALE);},function(q){this._shaderValues.setNumber(a.SMOOTHNESSSCALE,q);}),d(0,q,"_Glossiness",function(){return this._shaderValues.getNumber(a.SMOOTHNESS);},function(q){this._shaderValues.setNumber(a.SMOOTHNESS,q);}),d(0,q,"_ColorA",function(){return this._albedoColor.w;},function(q){this._albedoColor.w=q,this.albedoColor=this._albedoColor;}),d(0,q,"enableReflection",function(){return this._shaderValues.getBool(a.ENABLEREFLECT);},function(q){this._shaderValues.setBool(a.ENABLEREFLECT,!0),q?this._disablePublicDefineDatas.remove(gm.SHADERDEFINE_REFLECTMAP):this._disablePublicDefineDatas.add(gm.SHADERDEFINE_REFLECTMAP);}),d(0,q,"_Metallic",function(){return this._shaderValues.getNumber(a.METALLIC);},function(q){this._shaderValues.setNumber(a.METALLIC,q);}),d(0,q,"_BumpScale",function(){return this._shaderValues.getNumber(a.NORMALSCALE);},function(q){this._shaderValues.setNumber(a.NORMALSCALE,q);}),d(0,q,"_OcclusionStrength",function(){return this._shaderValues.getNumber(a.OCCLUSIONSTRENGTH);},function(q){this._shaderValues.setNumber(a.OCCLUSIONSTRENGTH,q);}),d(0,q,"_EmissionColorR",function(){return this._emissionColor.x;},function(q){this._emissionColor.x=q,this.emissionColor=this._emissionColor;}),d(0,q,"tilingOffset",function(){return this._shaderValues.getVector(a.TILINGOFFSET);},function(q){q&&(1!=q.x||1!=q.y||0!=q.z||0!=q.w)?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(a.TILINGOFFSET,q);}),d(0,q,"_EmissionColorG",function(){return this._emissionColor.y;},function(q){this._emissionColor.y=q,this.emissionColor=this._emissionColor;}),d(0,q,"blendSrc",function(){return this._shaderValues.getInt(a.BLEND_SRC);},function(q){this._shaderValues.setInt(a.BLEND_SRC,q);}),d(0,q,"tilingOffsetW",function(){return this._MainTex_STW;},function(q){this._MainTex_STW=q;}),d(0,q,"_EmissionColorB",function(){return this._emissionColor.z;},function(q){this._emissionColor.z=q,this.emissionColor=this._emissionColor;}),d(0,q,"_EmissionColorA",function(){return this._emissionColor.w;},function(q){this._emissionColor.w=q,this.emissionColor=this._emissionColor;}),d(0,q,"albedoColorA",function(){return this._ColorA;},function(q){this._ColorA=q;}),d(0,q,"_MainTex_STX",function(){return this._shaderValues.getVector(a.TILINGOFFSET).x;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.x=q,this.tilingOffset=Q;}),d(0,q,"_MainTex_STY",function(){return this._shaderValues.getVector(a.TILINGOFFSET).y;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.y=q,this.tilingOffset=Q;}),d(0,q,"_MainTex_STZ",function(){return this._shaderValues.getVector(a.TILINGOFFSET).z;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.z=q,this.tilingOffset=Q;}),d(0,q,"_Cutoff",function(){return this.alphaTestValue;},function(q){this.alphaTestValue=q;}),d(0,q,"_MainTex_STW",function(){return this._shaderValues.getVector(a.TILINGOFFSET).w;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.w=q,this.tilingOffset=Q;}),d(0,q,"albedoColorR",function(){return this._ColorR;},function(q){this._ColorR=q;}),d(0,q,"albedoColorG",function(){return this._ColorG;},function(q){this._ColorG=q;}),d(0,q,"albedoColorB",function(){return this._ColorB;},function(q){this._ColorB=q;}),d(0,q,"tilingOffsetX",function(){return this._MainTex_STX;},function(q){this._MainTex_STX=q;}),d(0,q,"albedoColor",function(){return this._albedoColor;},function(q){this._albedoColor=q,this._shaderValues.setVector(a.ALBEDOCOLOR,q);}),d(0,q,"albedoTexture",function(){return this._shaderValues.getTexture(a.ALBEDOTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(a.ALBEDOTEXTURE,q);}),d(0,q,"cull",function(){return this._shaderValues.getInt(a.CULL);},function(q){this._shaderValues.setInt(a.CULL,q);}),d(0,q,"parallaxTexture",function(){return this._shaderValues.getTexture(a.PARALLAXTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(a.PARALLAXTEXTURE,q);}),d(0,q,"normalTexture",function(){return this._shaderValues.getTexture(a.NORMALTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(a.NORMALTEXTURE,q);}),d(0,q,"emissionColor",function(){return this._shaderValues.getVector(a.EMISSIONCOLOR);},function(q){this._shaderValues.setVector(a.EMISSIONCOLOR,q);}),d(0,q,"parallaxTextureScale",function(){return this._Parallax;},function(q){this._Parallax=Math.max(.005,Math.min(.08,q));}),d(0,q,"normalTextureScale",function(){return this._BumpScale;},function(q){this._BumpScale=q;}),d(0,q,"tilingOffsetZ",function(){return this._MainTex_STZ;},function(q){this._MainTex_STZ=q;}),d(0,q,"occlusionTexture",function(){return this._shaderValues.getTexture(a.OCCLUSIONTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(a.OCCLUSIONTEXTURE,q);}),d(0,q,"occlusionTextureStrength",function(){return this._OcclusionStrength;},function(q){this._OcclusionStrength=Math.max(0,Math.min(1,q));}),d(0,q,"enableEmission",function(){return this._shaderValues.getBool(a.ENABLEEMISSION);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSION),this._shaderValues.setBool(a.ENABLEEMISSION,q);}),d(0,q,"metallicGlossTexture",function(){return this._shaderValues.getTexture(a.METALLICGLOSSTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_METALLICGLOSSTEXTURE),this._shaderValues.setTexture(a.METALLICGLOSSTEXTURE,q);}),d(0,q,"emissionColorA",function(){return this._EmissionColorA;},function(q){this._EmissionColorA=q;}),d(0,q,"smoothness",function(){return this._Glossiness;},function(q){this._Glossiness=Math.max(0,Math.min(1,q));}),d(0,q,"blendDst",function(){return this._shaderValues.getInt(a.BLEND_DST);},function(q){this._shaderValues.setInt(a.BLEND_DST,q);}),d(0,q,"smoothnessTextureScale",function(){return this._GlossMapScale;},function(q){this._GlossMapScale=Math.max(0,Math.min(1,q));}),d(0,q,"depthWrite",function(){return this._shaderValues.getBool(a.DEPTH_WRITE);},function(q){this._shaderValues.setBool(a.DEPTH_WRITE,q);}),d(0,q,"smoothnessSource",function(){return this._shaderValues.getInt(a.SMOOTHNESSSOURCE);},function(q){q?(this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(a.SMOOTHNESSSOURCE,1)):(this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(a.SMOOTHNESSSOURCE,0));}),d(0,q,"emissionColorR",function(){return this._EmissionColorR;},function(q){this._EmissionColorR=q;}),d(0,q,"emissionColorG",function(){return this._EmissionColorG;},function(q){this._EmissionColorG=q;}),d(0,q,"emissionColorB",function(){return this._EmissionColorB;},function(q){this._EmissionColorB=q;}),d(0,q,"emissionTexture",function(){return this._shaderValues.getTexture(a.EMISSIONTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRStandardMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(a.EMISSIONTEXTURE,q);}),d(0,q,"tilingOffsetY",function(){return this._MainTex_STY;},function(q){this._MainTex_STY=q;}),d(0,q,"renderMode",null,function(q){switch(q){case 0:this.alphaTest=!1,this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513,this._defineDatas.remove(a.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 1:this.renderQueue=2450,this.alphaTest=!0,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513,this._defineDatas.remove(a.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 2:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=2,this.blend=1,this.blendSrc=770,this.blendDst=771,this.depthTest=513,this._defineDatas.remove(a.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 3:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=2,this.blend=1,this.blendSrc=1,this.blendDst=771,this.depthTest=513,this._defineDatas.add(a.SHADERDEFINE_ALPHAPREMULTIPLY);break;default:throw new Error("PBRSpecularMaterial : renderMode value error.");}}),d(0,q,"blend",function(){return this._shaderValues.getInt(a.BLEND);},function(q){this._shaderValues.setInt(a.BLEND,q);}),d(0,q,"depthTest",function(){return this._shaderValues.getInt(a.DEPTH_TEST);},function(q){this._shaderValues.setInt(a.DEPTH_TEST,q);}),a.__init__=function(){a.SHADERDEFINE_ALBEDOTEXTURE=a.shaderDefines.registerDefine("ALBEDOTEXTURE"),a.SHADERDEFINE_METALLICGLOSSTEXTURE=a.shaderDefines.registerDefine("METALLICGLOSSTEXTURE"),a.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=a.shaderDefines.registerDefine("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA"),a.SHADERDEFINE_NORMALTEXTURE=a.shaderDefines.registerDefine("NORMALTEXTURE"),a.SHADERDEFINE_PARALLAXTEXTURE=a.shaderDefines.registerDefine("PARALLAXTEXTURE"),a.SHADERDEFINE_OCCLUSIONTEXTURE=a.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),a.SHADERDEFINE_EMISSION=a.shaderDefines.registerDefine("EMISSION"),a.SHADERDEFINE_EMISSIONTEXTURE=a.shaderDefines.registerDefine("EMISSIONTEXTURE"),a.SHADERDEFINE_REFLECTMAP=a.shaderDefines.registerDefine("REFLECTMAP"),a.SHADERDEFINE_TILINGOFFSET=a.shaderDefines.registerDefine("TILINGOFFSET"),a.SHADERDEFINE_ALPHAPREMULTIPLY=a.shaderDefines.registerDefine("ALPHAPREMULTIPLY");},a.SmoothnessSource_MetallicGlossTexture_Alpha=0,a.SmoothnessSource_AlbedoTexture_Alpha=1,a.RENDERMODE_OPAQUE=0,a.RENDERMODE_CUTOUT=1,a.RENDERMODE_FADE=2,a.RENDERMODE_TRANSPARENT=3,a.SHADERDEFINE_ALBEDOTEXTURE=0,a.SHADERDEFINE_NORMALTEXTURE=0,a.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=0,a.SHADERDEFINE_METALLICGLOSSTEXTURE=0,a.SHADERDEFINE_OCCLUSIONTEXTURE=0,a.SHADERDEFINE_PARALLAXTEXTURE=0,a.SHADERDEFINE_EMISSION=0,a.SHADERDEFINE_EMISSIONTEXTURE=0,a.SHADERDEFINE_REFLECTMAP=0,a.SHADERDEFINE_TILINGOFFSET=0,a.SHADERDEFINE_ALPHAPREMULTIPLY=0,a.SMOOTHNESSSOURCE=-1,a.ENABLEEMISSION=-1,a.ENABLEREFLECT=-1,y(a,["ALBEDOTEXTURE",function(){return this.ALBEDOTEXTURE=Bq.propertyNameToID("u_AlbedoTexture");},"METALLICGLOSSTEXTURE",function(){return this.METALLICGLOSSTEXTURE=Bq.propertyNameToID("u_MetallicGlossTexture");},"NORMALTEXTURE",function(){return this.NORMALTEXTURE=Bq.propertyNameToID("u_NormalTexture");},"PARALLAXTEXTURE",function(){return this.PARALLAXTEXTURE=Bq.propertyNameToID("u_ParallaxTexture");},"OCCLUSIONTEXTURE",function(){return this.OCCLUSIONTEXTURE=Bq.propertyNameToID("u_OcclusionTexture");},"EMISSIONTEXTURE",function(){return this.EMISSIONTEXTURE=Bq.propertyNameToID("u_EmissionTexture");},"ALBEDOCOLOR",function(){return this.ALBEDOCOLOR=Bq.propertyNameToID("u_AlbedoColor");},"EMISSIONCOLOR",function(){return this.EMISSIONCOLOR=Bq.propertyNameToID("u_EmissionColor");},"METALLIC",function(){return this.METALLIC=Bq.propertyNameToID("u_metallic");},"SMOOTHNESS",function(){return this.SMOOTHNESS=Bq.propertyNameToID("u_smoothness");},"SMOOTHNESSSCALE",function(){return this.SMOOTHNESSSCALE=Bq.propertyNameToID("u_smoothnessScale");},"OCCLUSIONSTRENGTH",function(){return this.OCCLUSIONSTRENGTH=Bq.propertyNameToID("u_occlusionStrength");},"NORMALSCALE",function(){return this.NORMALSCALE=Bq.propertyNameToID("u_normalScale");},"PARALLAXSCALE",function(){return this.PARALLAXSCALE=Bq.propertyNameToID("u_parallaxScale");},"TILINGOFFSET",function(){return this.TILINGOFFSET=Bq.propertyNameToID("u_TilingOffset");},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"defaultMaterial",function(){return this.defaultMaterial=new a();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),a;}(Ym),Fa=function(q){function m(){m.__super.call(this),this.setShaderName("PARTICLESHURIKEN"),this._color=new rq(1,1,1,1),this.renderMode=0;}
S(m,"laya.d3.core.particleShuriKen.ShurikenParticleMaterial",Ym);var Q=m.prototype;return d(0,Q,"_TintColorB",function(){return this._color.z;},function(q){this._color.z=q,this.color=this._color;}),d(0,Q,"_MainTex_STZ",function(){return this._shaderValues.getVector(m.TILINGOFFSET).z;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.z=q,this.tilingOffset=Q;}),d(0,Q,"texture",function(){return this._shaderValues.getTexture(m.DIFFUSETEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP):this._defineDatas.remove(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(m.DIFFUSETEXTURE,q);}),d(0,Q,"_TintColorR",function(){return this._color.x;},function(q){this._color.x=q,this.color=this._color;}),d(0,Q,"_MainTex_STW",function(){return this._shaderValues.getVector(m.TILINGOFFSET).w;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.w=q,this.tilingOffset=Q;}),d(0,Q,"_TintColorG",function(){return this._color.y;},function(q){this._color.y=q,this.color=this._color;}),d(0,Q,"_TintColorA",function(){return this._color.w;},function(q){this._color.w=q,this.color=this._color;}),d(0,Q,"_MainTex_STY",function(){return this._shaderValues.getVector(m.TILINGOFFSET).y;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.y=q,this.tilingOffset=Q;}),d(0,Q,"renderMode",null,function(q){switch(q){case 1:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.blendSrc=770,this.blendDst=1,this.alphaTest=!1,this._defineDatas.add(m.SHADERDEFINE_ADDTIVEFOG);break;case 0:this.renderQueue=3e3,this.depthWrite=!1,this.cull=0,this.blend=1,this.blendSrc=770,this.blendDst=771,this.alphaTest=!1,this._defineDatas.remove(m.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("ShurikenParticleMaterial : renderMode value error.");}}),d(0,Q,"_MainTex_STX",function(){return this._shaderValues.getVector(m.TILINGOFFSET).x;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.x=q,this.tilingOffset=Q;}),d(0,Q,"colorR",function(){return this._TintColorR;},function(q){this._TintColorR=q;}),d(0,Q,"colorG",function(){return this._TintColorG;},function(q){this._TintColorG=q;}),d(0,Q,"colorB",function(){return this._TintColorB;},function(q){this._TintColorB=q;}),d(0,Q,"colorA",function(){return this._TintColorA;},function(q){this._TintColorA=q;}),d(0,Q,"blend",function(){return this._shaderValues.getInt(m.BLEND);},function(q){this._shaderValues.setInt(m.BLEND,q);}),d(0,Q,"color",function(){return this._shaderValues.getVector(m.TINTCOLOR);},function(q){q?this._defineDatas.add(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR):this._defineDatas.remove(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TINTCOLOR),this._shaderValues.setVector(m.TINTCOLOR,q);}),d(0,Q,"tilingOffsetX",function(){return this._MainTex_STX;},function(q){this._MainTex_STX=q;}),d(0,Q,"tilingOffsetY",function(){return this._MainTex_STY;},function(q){this._MainTex_STY=q;}),d(0,Q,"tilingOffsetZ",function(){return this._MainTex_STZ;},function(q){this._MainTex_STZ=q;}),d(0,Q,"blendSrc",function(){return this._shaderValues.getInt(m.BLEND_SRC);},function(q){this._shaderValues.setInt(m.BLEND_SRC,q);}),d(0,Q,"tilingOffsetW",function(){return this._MainTex_STW;},function(q){this._MainTex_STW=q;}),d(0,Q,"tilingOffset",function(){return this._shaderValues.getVector(m.TILINGOFFSET);},function(q){q&&(1!=q.x||1!=q.y||0!=q.z||0!=q.w)?this._defineDatas.add(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.particleShuriKen.ShurikenParticleMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(m.TILINGOFFSET,q);}),d(0,Q,"depthWrite",function(){return this._shaderValues.getBool(m.DEPTH_WRITE);},function(q){this._shaderValues.setBool(m.DEPTH_WRITE,q);}),d(0,Q,"cull",function(){return this._shaderValues.getInt(m.CULL);},function(q){this._shaderValues.setInt(m.CULL,q);}),d(0,Q,"blendDst",function(){return this._shaderValues.getInt(m.BLEND_DST);},function(q){this._shaderValues.setInt(m.BLEND_DST,q);}),d(0,Q,"depthTest",function(){return this._shaderValues.getInt(m.DEPTH_TEST);},function(q){this._shaderValues.setInt(m.DEPTH_TEST,q);}),m.__init__=function(){m.SHADERDEFINE_DIFFUSEMAP=m.shaderDefines.registerDefine("DIFFUSEMAP"),m.SHADERDEFINE_TINTCOLOR=m.shaderDefines.registerDefine("TINTCOLOR"),m.SHADERDEFINE_ADDTIVEFOG=m.shaderDefines.registerDefine("ADDTIVEFOG"),m.SHADERDEFINE_TILINGOFFSET=m.shaderDefines.registerDefine("TILINGOFFSET");},m.RENDERMODE_ALPHABLENDED=0,m.RENDERMODE_ADDTIVE=1,m.SHADERDEFINE_DIFFUSEMAP=0,m.SHADERDEFINE_TINTCOLOR=0,m.SHADERDEFINE_TILINGOFFSET=0,m.SHADERDEFINE_ADDTIVEFOG=0,y(m,["DIFFUSETEXTURE",function(){return this.DIFFUSETEXTURE=Bq.propertyNameToID("u_texture");},"TINTCOLOR",function(){return this.TINTCOLOR=Bq.propertyNameToID("u_Tintcolor");},"TILINGOFFSET",function(){return this.TILINGOFFSET=Bq.propertyNameToID("u_TilingOffset");},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"defaultMaterial",function(){return this.defaultMaterial=new m();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),m;}(),Wa=function(q){function m(){this._color=null,m.__super.call(this),this.setShaderName("Effect"),this._color=new rq(1,1,1,1),this._shaderValues.setVector(m.TINTCOLOR,new rq(1,1,1,1)),this.renderMode=0;}
S(m,"laya.d3.core.material.EffectMaterial",Ym);var Q=m.prototype;return d(0,Q,"_TintColorB",function(){return this._color.z;},function(q){this._color.z=q,this.color=this._color;}),d(0,Q,"_MainTex_STZ",function(){return this._shaderValues.getVector(m.TILINGOFFSET).z;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.z=q,this.tilingOffset=Q;}),d(0,Q,"texture",function(){return this._shaderValues.getTexture(m.MAINTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.EffectMaterial.SHADERDEFINE_MAINTEXTURE):this._defineDatas.remove(laya.d3.core.material.EffectMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(m.MAINTEXTURE,q);}),d(0,Q,"_TintColorR",function(){return this._color.x;},function(q){this._color.x=q,this.color=this._color;}),d(0,Q,"_MainTex_STW",function(){return this._shaderValues.getVector(m.TILINGOFFSET).w;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.w=q,this.tilingOffset=Q;}),d(0,Q,"_TintColorG",function(){return this._color.y;},function(q){this._color.y=q,this.color=this._color;}),d(0,Q,"_TintColorA",function(){return this._color.w;},function(q){this._color.w=q,this.color=this._color;}),d(0,Q,"_MainTex_STY",function(){return this._shaderValues.getVector(m.TILINGOFFSET).y;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.y=q,this.tilingOffset=Q;}),d(0,Q,"renderMode",null,function(q){switch(q){case 0:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=0,this.blend=1,this.blendSrc=770,this.blendDst=1,this.depthTest=513,this._defineDatas.add(m.SHADERDEFINE_ADDTIVEFOG);break;case 1:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=0,this.blend=1,this.blendSrc=770,this.blendDst=771,this.depthTest=513,this._defineDatas.remove(m.SHADERDEFINE_ADDTIVEFOG);break;default:throw new Error("MeshEffectMaterial : renderMode value error.");}}),d(0,Q,"_MainTex_STX",function(){return this._shaderValues.getVector(m.TILINGOFFSET).x;},function(q){var Q=this._shaderValues.getVector(m.TILINGOFFSET);Q.x=q,this.tilingOffset=Q;}),d(0,Q,"colorR",function(){return this._TintColorR;},function(q){this._TintColorR=q;}),d(0,Q,"colorG",function(){return this._TintColorG;},function(q){this._TintColorG=q;}),d(0,Q,"colorB",function(){return this._TintColorB;},function(q){this._TintColorB=q;}),d(0,Q,"colorA",function(){return this._TintColorA;},function(q){this._TintColorA=q;}),d(0,Q,"blend",function(){return this._shaderValues.getInt(m.BLEND);},function(q){this._shaderValues.setInt(m.BLEND,q);}),d(0,Q,"color",function(){return this._shaderValues.getVector(m.TINTCOLOR);},function(q){this._shaderValues.setVector(m.TINTCOLOR,q);}),d(0,Q,"tilingOffsetX",function(){return this._MainTex_STX;},function(q){this._MainTex_STX=q;}),d(0,Q,"tilingOffsetY",function(){return this._MainTex_STY;},function(q){this._MainTex_STY=q;}),d(0,Q,"tilingOffsetZ",function(){return this._MainTex_STZ;},function(q){this._MainTex_STZ=q;}),d(0,Q,"blendSrc",function(){return this._shaderValues.getInt(m.BLEND_SRC);},function(q){this._shaderValues.setInt(m.BLEND_SRC,q);}),d(0,Q,"tilingOffsetW",function(){return this._MainTex_STW;},function(q){this._MainTex_STW=q;}),d(0,Q,"tilingOffset",function(){return this._shaderValues.getVector(m.TILINGOFFSET);},function(q){q&&(1!=q.x||1!=q.y||0!=q.z||0!=q.w)?this._defineDatas.add(laya.d3.core.material.EffectMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.EffectMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(m.TILINGOFFSET,q);}),d(0,Q,"depthWrite",function(){return this._shaderValues.getBool(m.DEPTH_WRITE);},function(q){this._shaderValues.setBool(m.DEPTH_WRITE,q);}),d(0,Q,"cull",function(){return this._shaderValues.getInt(m.CULL);},function(q){this._shaderValues.setInt(m.CULL,q);}),d(0,Q,"blendDst",function(){return this._shaderValues.getInt(m.BLEND_DST);},function(q){this._shaderValues.setInt(m.BLEND_DST,q);}),d(0,Q,"depthTest",function(){return this._shaderValues.getInt(m.DEPTH_TEST);},function(q){this._shaderValues.setInt(m.DEPTH_TEST,q);}),m.__init__=function(){m.SHADERDEFINE_MAINTEXTURE=m.shaderDefines.registerDefine("MAINTEXTURE"),m.SHADERDEFINE_TILINGOFFSET=m.shaderDefines.registerDefine("TILINGOFFSET"),m.SHADERDEFINE_ADDTIVEFOG=m.shaderDefines.registerDefine("ADDTIVEFOG");},m.RENDERMODE_ADDTIVE=0,m.RENDERMODE_ALPHABLENDED=1,m.SHADERDEFINE_MAINTEXTURE=0,m.SHADERDEFINE_TILINGOFFSET=0,m.SHADERDEFINE_ADDTIVEFOG=0,y(m,["defaultMaterial",function(){return this.defaultMaterial=new m();},"MAINTEXTURE",function(){return this.MAINTEXTURE=Bq.propertyNameToID("u_AlbedoTexture");},"TINTCOLOR",function(){return this.TINTCOLOR=Bq.propertyNameToID("u_AlbedoColor");},"TILINGOFFSET",function(){return this.TILINGOFFSET=Bq.propertyNameToID("u_TilingOffset");},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),m;}(),sa=function(q){function Q(){Q.__super.call(this),this.setShaderName("WaterPrimary"),this._shaderValues.setVector(Q.HORIZONCOLOR,new rq(.172,.463,.435,0)),this._shaderValues.setNumber(Q.WAVESCALE,.15),this._shaderValues.setVector(Q.WAVESPEED,new rq(19,9,-16,-7));}
S(Q,"laya.d3.core.material.WaterPrimaryMaterial",Ym);var m=Q.prototype;return d(0,m,"waveSpeed",function(){return this._shaderValues.getVector(Q.WAVESPEED);},function(q){this._shaderValues.setVector(Q.WAVESPEED,q);}),d(0,m,"horizonColor",function(){return this._shaderValues.getVector(Q.HORIZONCOLOR);},function(q){this._shaderValues.setVector(Q.HORIZONCOLOR,q);}),d(0,m,"mainTexture",function(){return this._shaderValues.getTexture(Q.MAINTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE):this._defineDatas.remove(laya.d3.core.material.WaterPrimaryMaterial.SHADERDEFINE_MAINTEXTURE),this._shaderValues.setTexture(Q.MAINTEXTURE,q);}),d(0,m,"normalTexture",function(){return this._shaderValues.getTexture(Q.NORMALTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE):this._defineDatas.remove(laya.d3.core.material.WaterPrimaryMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(Q.NORMALTEXTURE,q);}),d(0,m,"waveScale",function(){return this._shaderValues.getNumber(Q.WAVESCALE);},function(q){this._shaderValues.setNumber(Q.WAVESCALE,q);}),Q.__init__=function(){Q.SHADERDEFINE_MAINTEXTURE=Q.shaderDefines.registerDefine("MAINTEXTURE"),Q.SHADERDEFINE_NORMALTEXTURE=Q.shaderDefines.registerDefine("NORMALTEXTURE");},Q.SHADERDEFINE_MAINTEXTURE=0,Q.SHADERDEFINE_NORMALTEXTURE=0,y(Q,["HORIZONCOLOR",function(){return this.HORIZONCOLOR=Bq.propertyNameToID("u_HorizonColor");},"MAINTEXTURE",function(){return this.MAINTEXTURE=Bq.propertyNameToID("u_MainTexture");},"NORMALTEXTURE",function(){return this.NORMALTEXTURE=Bq.propertyNameToID("u_NormalTexture");},"WAVESCALE",function(){return this.WAVESCALE=Bq.propertyNameToID("u_WaveScale");},"WAVESPEED",function(){return this.WAVESPEED=Bq.propertyNameToID("u_WaveSpeed");},"defaultMaterial",function(){return this.defaultMaterial=new Q();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),Q;}(),Da=function(q){function Q(){this._enableLighting=!0,Q.__super.call(this),this.setShaderName("ExtendTerrain"),this.renderMode=1;}
S(Q,"laya.d3.core.material.ExtendTerrainMaterial",Ym);var m=Q.prototype;return m._setDetailNum=function(q){switch(q){case 1:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 2:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 3:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 4:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5);break;case 5:this._defineDatas.add(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM5),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.ExtendTerrainMaterial.SHADERDEFINE_DETAIL_NUM4);}},d(0,m,"diffuseScaleOffset2",null,function(q){this._shaderValues.setVector(Q.DIFFUSESCALEOFFSET2,q);}),d(0,m,"splatAlphaTexture",function(){return this._shaderValues.getTexture(Q.SPLATALPHATEXTURE);},function(q){this._shaderValues.setTexture(Q.SPLATALPHATEXTURE,q);}),d(0,m,"diffuseScaleOffset3",null,function(q){this._shaderValues.setVector(Q.DIFFUSESCALEOFFSET3,q);}),d(0,m,"diffuseTexture1",null,function(q){this._shaderValues.setTexture(Q.DIFFUSETEXTURE1,q),this._setDetailNum(1);}),d(0,m,"renderMode",null,function(q){switch(q){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=2e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.blendSrc=770,this.blendDst=771,this.depthTest=515;break;default:throw new Error("ExtendTerrainMaterial:renderMode value error.");}}),d(0,m,"diffuseTexture2",function(){return this._shaderValues.getTexture(Q.DIFFUSETEXTURE2);},function(q){this._shaderValues.setTexture(Q.DIFFUSETEXTURE2,q),this._setDetailNum(2);}),d(0,m,"diffuseScaleOffset1",null,function(q){this._shaderValues.setVector(Q.DIFFUSESCALEOFFSET1,q);}),d(0,m,"diffuseTexture3",function(){return this._shaderValues.getTexture(Q.DIFFUSETEXTURE3);},function(q){this._shaderValues.setTexture(Q.DIFFUSETEXTURE3,q),this._setDetailNum(3);}),d(0,m,"diffuseTexture4",function(){return this._shaderValues.getTexture(Q.DIFFUSETEXTURE4);},function(q){this._shaderValues.setTexture(Q.DIFFUSETEXTURE4,q),this._setDetailNum(4);}),d(0,m,"diffuseTexture5",function(){return this._shaderValues.getTexture(Q.DIFFUSETEXTURE5);},function(q){this._shaderValues.setTexture(Q.DIFFUSETEXTURE5,q),this._setDetailNum(5);}),d(0,m,"diffuseScaleOffset4",null,function(q){this._shaderValues.setVector(Q.DIFFUSESCALEOFFSET4,q);}),d(0,m,"diffuseScaleOffset5",null,function(q){this._shaderValues.setVector(Q.DIFFUSESCALEOFFSET5,q);}),d(0,m,"blendSrc",function(){return this._shaderValues.getInt(Q.BLEND_SRC);},function(q){this._shaderValues.setInt(Q.BLEND_SRC,q);}),d(0,m,"enableLighting",function(){return this._enableLighting;},function(q){this._enableLighting!==q&&(q?this._disablePublicDefineDatas.remove(gm.SHADERDEFINE_POINTLIGHT|gm.SHADERDEFINE_SPOTLIGHT|gm.SHADERDEFINE_DIRECTIONLIGHT):this._disablePublicDefineDatas.add(gm.SHADERDEFINE_POINTLIGHT|gm.SHADERDEFINE_SPOTLIGHT|gm.SHADERDEFINE_DIRECTIONLIGHT),this._enableLighting=q);}),d(0,m,"depthWrite",function(){return this._shaderValues.getBool(Q.DEPTH_WRITE);},function(q){this._shaderValues.setBool(Q.DEPTH_WRITE,q);}),d(0,m,"cull",function(){return this._shaderValues.getInt(Q.CULL);},function(q){this._shaderValues.setInt(Q.CULL,q);}),d(0,m,"blend",function(){return this._shaderValues.getInt(Q.BLEND);},function(q){this._shaderValues.setInt(Q.BLEND,q);}),d(0,m,"blendDst",function(){return this._shaderValues.getInt(Q.BLEND_DST);},function(q){this._shaderValues.setInt(Q.BLEND_DST,q);}),d(0,m,"depthTest",function(){return this._shaderValues.getInt(Q.DEPTH_TEST);},function(q){this._shaderValues.setInt(Q.DEPTH_TEST,q);}),Q.__init__=function(){Q.SHADERDEFINE_DETAIL_NUM1=Q.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM1"),Q.SHADERDEFINE_DETAIL_NUM2=Q.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM2"),Q.SHADERDEFINE_DETAIL_NUM3=Q.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM3"),Q.SHADERDEFINE_DETAIL_NUM4=Q.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM4"),Q.SHADERDEFINE_DETAIL_NUM5=Q.shaderDefines.registerDefine("ExtendTerrain_DETAIL_NUM5");},Q.RENDERMODE_OPAQUE=1,Q.RENDERMODE_TRANSPARENT=2,Q.SHADERDEFINE_DETAIL_NUM1=0,Q.SHADERDEFINE_DETAIL_NUM2=0,Q.SHADERDEFINE_DETAIL_NUM3=0,Q.SHADERDEFINE_DETAIL_NUM4=0,Q.SHADERDEFINE_DETAIL_NUM5=0,y(Q,["SPLATALPHATEXTURE",function(){return this.SPLATALPHATEXTURE=Bq.propertyNameToID("u_SplatAlphaTexture");},"DIFFUSETEXTURE1",function(){return this.DIFFUSETEXTURE1=Bq.propertyNameToID("u_DiffuseTexture1");},"DIFFUSETEXTURE2",function(){return this.DIFFUSETEXTURE2=Bq.propertyNameToID("u_DiffuseTexture2");},"DIFFUSETEXTURE3",function(){return this.DIFFUSETEXTURE3=Bq.propertyNameToID("u_DiffuseTexture3");},"DIFFUSETEXTURE4",function(){return this.DIFFUSETEXTURE4=Bq.propertyNameToID("u_DiffuseTexture4");},"DIFFUSETEXTURE5",function(){return this.DIFFUSETEXTURE5=Bq.propertyNameToID("u_DiffuseTexture5");},"DIFFUSESCALEOFFSET1",function(){return this.DIFFUSESCALEOFFSET1=Bq.propertyNameToID("u_DiffuseScaleOffset1");},"DIFFUSESCALEOFFSET2",function(){return this.DIFFUSESCALEOFFSET2=Bq.propertyNameToID("u_DiffuseScaleOffset2");},"DIFFUSESCALEOFFSET3",function(){return this.DIFFUSESCALEOFFSET3=Bq.propertyNameToID("u_DiffuseScaleOffset3");},"DIFFUSESCALEOFFSET4",function(){return this.DIFFUSESCALEOFFSET4=Bq.propertyNameToID("u_DiffuseScaleOffset4");},"DIFFUSESCALEOFFSET5",function(){return this.DIFFUSESCALEOFFSET5=Bq.propertyNameToID("u_DiffuseScaleOffset5");},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),Q;}(),da=function(m){function a(){this._enableVertexColor=!1,a.__super.call(this),this.setShaderName("BLINNPHONG"),this._albedoIntensity=1,this._albedoColor=new rq(1,1,1,1);var q=this._shaderValues;q.setVector(a.ALBEDOCOLOR,new rq(1,1,1,1)),q.setVector(a.MATERIALSPECULAR,new rq(1,1,1,1)),q.setNumber(a.SHININESS,.078125),q.setNumber(Ym.ALPHATESTVALUE,.5),q.setVector(a.TILINGOFFSET,new rq(1,1,0,0)),this._enableLighting=!0,this.renderMode=0;}
S(a,"laya.d3.core.material.BlinnPhongMaterial",m);var q=a.prototype;return q.disableFog=function(){this._disablePublicDefineDatas.add(gm.SHADERDEFINE_FOG);},q.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;Q._enableLighting=this._enableLighting,Q._albedoIntensity=this._albedoIntensity,Q._enableVertexColor=this._enableVertexColor,this._albedoColor.cloneTo(Q._albedoColor);},d(0,q,"_SpecColorG",function(){return this._shaderValues.getVector(a.MATERIALSPECULAR).y;},function(q){this._shaderValues.getVector(a.MATERIALSPECULAR).y=q;}),d(0,q,"_ColorB",function(){return this._albedoColor.z;},function(q){this._albedoColor.z=q,this.albedoColor=this._albedoColor;}),d(0,q,"_ColorR",function(){return this._albedoColor.x;},function(q){this._albedoColor.x=q,this.albedoColor=this._albedoColor;}),d(0,q,"albedoColorA",function(){return this._ColorA;},function(q){this._ColorA=q;}),d(0,q,"_MainTex_STX",function(){return this._shaderValues.getVector(a.TILINGOFFSET).x;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.x=q,this.tilingOffset=Q;}),d(0,q,"_SpecColorB",function(){return this._shaderValues.getVector(a.MATERIALSPECULAR).z;},function(q){this._shaderValues.getVector(a.MATERIALSPECULAR).z=q;}),d(0,q,"renderMode",null,function(q){switch(q){case 0:this.alphaTest=!1,this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 1:this.renderQueue=2450,this.alphaTest=!0,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=2,this.blend=1,this.blendSrc=770,this.blendDst=771,this.depthTest=513;break;default:throw new Error("Material:renderMode value error.");}}),d(0,q,"_SpecColorR",function(){return this._shaderValues.getVector(a.MATERIALSPECULAR).x;},function(q){this._shaderValues.getVector(a.MATERIALSPECULAR).x=q;}),d(0,q,"_ColorG",function(){return this._albedoColor.y;},function(q){this._albedoColor.y=q,this.albedoColor=this._albedoColor;}),d(0,q,"_ColorA",function(){return this._albedoColor.w;},function(q){this._albedoColor.w=q,this.albedoColor=this._albedoColor;}),d(0,q,"specularColor",function(){return this._shaderValues.getVector(a.MATERIALSPECULAR);},function(q){this._shaderValues.setVector(a.MATERIALSPECULAR,q);}),d(0,q,"albedoColorB",function(){return this._ColorB;},function(q){this._ColorB=q;}),d(0,q,"_SpecColorA",function(){return this._shaderValues.getVector(a.MATERIALSPECULAR).w;},function(q){this._shaderValues.getVector(a.MATERIALSPECULAR).w=q;}),d(0,q,"_MainTex_STZ",function(){return this._shaderValues.getVector(a.TILINGOFFSET).z;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.z=q,this.tilingOffset=Q;}),d(0,q,"_AlbedoIntensity",function(){return this._albedoIntensity;},function(q){if(this._albedoIntensity!==q){var Q=this._shaderValues.getVector(a.ALBEDOCOLOR);rq.scale(this._albedoColor,q,Q),this._albedoIntensity=q,this._shaderValues.setVector(a.ALBEDOCOLOR,Q);}}),d(0,q,"specularColorA",function(){return this._SpecColorA;},function(q){this._SpecColorA=q;}),d(0,q,"_Shininess",function(){return this._shaderValues.getNumber(a.SHININESS);},function(q){q=Math.max(0,Math.min(1,q)),this._shaderValues.setNumber(a.SHININESS,q);}),d(0,q,"_MainTex_STY",function(){return this._shaderValues.getVector(a.TILINGOFFSET).y;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.y=q,this.tilingOffset=Q;}),d(0,q,"_Cutoff",function(){return this.alphaTestValue;},function(q){this.alphaTestValue=q;}),d(0,q,"_MainTex_STW",function(){return this._shaderValues.getVector(a.TILINGOFFSET).w;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.w=q,this.tilingOffset=Q;}),d(0,q,"albedoTexture",function(){return this._shaderValues.getTexture(a.ALBEDOTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_DIFFUSEMAP),this._shaderValues.setTexture(a.ALBEDOTEXTURE,q);}),d(0,q,"enableVertexColor",function(){return this._enableVertexColor;},function(q){(this._enableVertexColor=q)?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_ENABLEVERTEXCOLOR);}),d(0,q,"albedoColor",function(){return this._albedoColor;},function(q){var Q=this._shaderValues.getVector(a.ALBEDOCOLOR);rq.scale(q,this._albedoIntensity,Q),this._albedoColor=q,this._shaderValues.setVector(a.ALBEDOCOLOR,Q);}),d(0,q,"tilingOffsetX",function(){return this._MainTex_STX;},function(q){this._MainTex_STX=q;}),d(0,q,"tilingOffsetY",function(){return this._MainTex_STY;},function(q){this._MainTex_STY=q;}),d(0,q,"tilingOffsetZ",function(){return this._MainTex_STZ;},function(q){this._MainTex_STZ=q;}),d(0,q,"blendSrc",function(){return this._shaderValues.getInt(a.BLEND_SRC);},function(q){this._shaderValues.setInt(a.BLEND_SRC,q);}),d(0,q,"enableLighting",function(){return this._enableLighting;},function(q){this._enableLighting!==q&&(q?this._disablePublicDefineDatas.remove(gm.SHADERDEFINE_POINTLIGHT|gm.SHADERDEFINE_SPOTLIGHT|gm.SHADERDEFINE_DIRECTIONLIGHT):this._disablePublicDefineDatas.add(gm.SHADERDEFINE_POINTLIGHT|gm.SHADERDEFINE_SPOTLIGHT|gm.SHADERDEFINE_DIRECTIONLIGHT),this._enableLighting=q);}),d(0,q,"tilingOffsetW",function(){return this._MainTex_STW;},function(q){this._MainTex_STW=q;}),d(0,q,"tilingOffset",function(){return this._shaderValues.getVector(a.TILINGOFFSET);},function(q){q&&(1!=q.x||1!=q.y||0!=q.z||0!=q.w)?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(a.TILINGOFFSET,q);}),d(0,q,"albedoColorR",function(){return this._ColorR;},function(q){this._ColorR=q;}),d(0,q,"albedoColorG",function(){return this._ColorG;},function(q){this._ColorG=q;}),d(0,q,"albedoIntensity",function(){return this._albedoIntensity;},function(q){this._AlbedoIntensity=q;}),d(0,q,"specularColorR",function(){return this._SpecColorR;},function(q){this._SpecColorR=q;}),d(0,q,"specularColorG",function(){return this._SpecColorG;},function(q){this._SpecColorG=q;}),d(0,q,"specularColorB",function(){return this._SpecColorB;},function(q){this._SpecColorB=q;}),d(0,q,"blendDst",function(){return this._shaderValues.getInt(a.BLEND_DST);},function(q){this._shaderValues.setInt(a.BLEND_DST,q);}),d(0,q,"shininess",function(){return this._Shininess;},function(q){this._Shininess=q;}),d(0,q,"cull",function(){return this._shaderValues.getInt(a.CULL);},function(q){this._shaderValues.setInt(a.CULL,q);}),d(0,q,"normalTexture",function(){return this._shaderValues.getTexture(a.NORMALTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_NORMALMAP),this._shaderValues.setTexture(a.NORMALTEXTURE,q);}),d(0,q,"specularTexture",function(){return this._shaderValues.getTexture(a.SPECULARTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP):this._defineDatas.remove(laya.d3.core.material.BlinnPhongMaterial.SHADERDEFINE_SPECULARMAP),this._shaderValues.setTexture(a.SPECULARTEXTURE,q);}),d(0,q,"depthWrite",function(){return this._shaderValues.getBool(a.DEPTH_WRITE);},function(q){this._shaderValues.setBool(a.DEPTH_WRITE,q);}),d(0,q,"blend",function(){return this._shaderValues.getInt(a.BLEND);},function(q){this._shaderValues.setInt(a.BLEND,q);}),d(0,q,"depthTest",function(){return this._shaderValues.getInt(a.DEPTH_TEST);},function(q){this._shaderValues.setInt(a.DEPTH_TEST,q);}),a.__init__=function(){a.SHADERDEFINE_DIFFUSEMAP=a.shaderDefines.registerDefine("DIFFUSEMAP"),a.SHADERDEFINE_NORMALMAP=a.shaderDefines.registerDefine("NORMALMAP"),a.SHADERDEFINE_SPECULARMAP=a.shaderDefines.registerDefine("SPECULARMAP"),a.SHADERDEFINE_TILINGOFFSET=a.shaderDefines.registerDefine("TILINGOFFSET"),a.SHADERDEFINE_ENABLEVERTEXCOLOR=a.shaderDefines.registerDefine("ENABLEVERTEXCOLOR");},a.SPECULARSOURCE_DIFFUSEMAPALPHA=0,a.SPECULARSOURCE_SPECULARMAP=0,a.RENDERMODE_OPAQUE=0,a.RENDERMODE_CUTOUT=1,a.RENDERMODE_TRANSPARENT=2,a.SHADERDEFINE_DIFFUSEMAP=0,a.SHADERDEFINE_NORMALMAP=0,a.SHADERDEFINE_SPECULARMAP=0,a.SHADERDEFINE_TILINGOFFSET=0,a.SHADERDEFINE_ENABLEVERTEXCOLOR=0,y(a,["ALBEDOTEXTURE",function(){return this.ALBEDOTEXTURE=Bq.propertyNameToID("u_DiffuseTexture");},"NORMALTEXTURE",function(){return this.NORMALTEXTURE=Bq.propertyNameToID("u_NormalTexture");},"SPECULARTEXTURE",function(){return this.SPECULARTEXTURE=Bq.propertyNameToID("u_SpecularTexture");},"ALBEDOCOLOR",function(){return this.ALBEDOCOLOR=Bq.propertyNameToID("u_DiffuseColor");},"MATERIALSPECULAR",function(){return this.MATERIALSPECULAR=Bq.propertyNameToID("u_MaterialSpecular");},"SHININESS",function(){return this.SHININESS=Bq.propertyNameToID("u_Shininess");},"TILINGOFFSET",function(){return this.TILINGOFFSET=Bq.propertyNameToID("u_TilingOffset");},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"defaultMaterial",function(){return this.defaultMaterial=new a();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),a;}(Ym),va=function(Q){function m(){this._diffuseScale1=null,this._diffuseScale2=null,this._diffuseScale3=null,this._diffuseScale4=null,m.__super.call(this),this.setShaderName("Terrain"),this.renderMode=1,this._diffuseScale1=new Zq(),this._diffuseScale2=new Zq(),this._diffuseScale3=new Zq(),this._diffuseScale4=new Zq(),this.ambientColor=new _q(.6,.6,.6),this.diffuseColor=new _q(1,1,1),this.specularColor=new rq(.2,.2,.2,32);}
S(m,"laya.d3.core.material.TerrainMaterial",Q);var q=m.prototype;return q.setDiffuseScale1=function(q,Q){this._diffuseScale1.x=q,this._diffuseScale1.y=Q,this._shaderValues.setVector2(6,this._diffuseScale1);},q.setDiffuseScale2=function(q,Q){this._diffuseScale2.x=q,this._diffuseScale2.y=Q,this._shaderValues.setVector2(7,this._diffuseScale2);},q.setDiffuseScale3=function(q,Q){this._diffuseScale3.x=q,this._diffuseScale3.y=Q,this._shaderValues.setVector2(8,this._diffuseScale3);},q.setDiffuseScale4=function(q,Q){this._diffuseScale4.x=q,this._diffuseScale4.y=Q,this._shaderValues.setVector2(9,this._diffuseScale4);},q.setDetailNum=function(q){switch(q){case 1:this._defineDatas.add(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 2:this._defineDatas.add(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 3:this._defineDatas.add(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4);break;case 4:this._defineDatas.add(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM4),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM1),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM2),this._defineDatas.remove(laya.d3.core.material.TerrainMaterial.SHADERDEFINE_DETAIL_NUM3);}},q.disableLight=function(){this._disablePublicDefineDatas.add(gm.SHADERDEFINE_POINTLIGHT|gm.SHADERDEFINE_SPOTLIGHT|gm.SHADERDEFINE_DIRECTIONLIGHT);},q.setShaderName=function(q){Q.prototype.setShaderName.call(this,q);},d(0,q,"renderMode",null,function(q){switch(q){case 1:this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513;break;case 2:this.renderQueue=2e3,this.depthWrite=!1,this.cull=2,this.blend=1,this.blendSrc=770,this.blendDst=771,this.depthTest=515;break;default:throw new Error("TerrainMaterial:renderMode value error.");}}),d(0,q,"diffuseTexture2",function(){return this._shaderValues.getTexture(3);},function(q){this._shaderValues.setTexture(3,q);}),d(0,q,"ambientColor",function(){return this._shaderValues.getVector(10);},function(q){this._shaderValues.setVector3(10,q);}),d(0,q,"diffuseTexture4",function(){return this._shaderValues.getTexture(5);},function(q){this._shaderValues.setTexture(5,q);}),d(0,q,"diffuseColor",function(){return this._shaderValues.getVector(11);},function(q){this._shaderValues.setVector3(11,q);}),d(0,q,"diffuseTexture1",function(){return this._shaderValues.getTexture(2);},function(q){this._shaderValues.setTexture(2,q);}),d(0,q,"specularColor",function(){return this._shaderValues.getVector(12);},function(q){this._shaderValues.setVector(12,q);}),d(0,q,"diffuseTexture3",function(){return this._shaderValues.getTexture(4);},function(q){this._shaderValues.setTexture(4,q);}),d(0,q,"splatAlphaTexture",function(){return this._shaderValues.getTexture(0);},function(q){this._shaderValues.setTexture(0,q);}),d(0,q,"cull",function(){return this._shaderValues.getInt(m.CULL);},function(q){this._shaderValues.setInt(m.CULL,q);}),d(0,q,"normalTexture",function(){return this._shaderValues.getTexture(1);},function(q){this._shaderValues.setTexture(1,q);}),d(0,q,"depthWrite",function(){return this._shaderValues.getBool(m.DEPTH_WRITE);},function(q){this._shaderValues.setBool(m.DEPTH_WRITE,q);}),d(0,q,"blend",function(){return this._shaderValues.getInt(m.BLEND);},function(q){this._shaderValues.setInt(m.BLEND,q);}),d(0,q,"blendSrc",function(){return this._shaderValues.getInt(m.BLEND_SRC);},function(q){this._shaderValues.setInt(m.BLEND_SRC,q);}),d(0,q,"blendDst",function(){return this._shaderValues.getInt(m.BLEND_DST);},function(q){this._shaderValues.setInt(m.BLEND_DST,q);}),d(0,q,"depthTest",function(){return this._shaderValues.getInt(m.DEPTH_TEST);},function(q){this._shaderValues.setInt(m.DEPTH_TEST,q);}),m.__init__=function(){m.SHADERDEFINE_DETAIL_NUM1=m.shaderDefines.registerDefine("DETAIL_NUM1"),m.SHADERDEFINE_DETAIL_NUM2=m.shaderDefines.registerDefine("DETAIL_NUM2"),m.SHADERDEFINE_DETAIL_NUM4=m.shaderDefines.registerDefine("DETAIL_NUM4"),m.SHADERDEFINE_DETAIL_NUM3=m.shaderDefines.registerDefine("DETAIL_NUM3");},m.RENDERMODE_OPAQUE=1,m.RENDERMODE_TRANSPARENT=2,m.SPLATALPHATEXTURE=0,m.NORMALTEXTURE=1,m.DIFFUSETEXTURE1=2,m.DIFFUSETEXTURE2=3,m.DIFFUSETEXTURE3=4,m.DIFFUSETEXTURE4=5,m.DIFFUSESCALE1=6,m.DIFFUSESCALE2=7,m.DIFFUSESCALE3=8,m.DIFFUSESCALE4=9,m.MATERIALAMBIENT=10,m.MATERIALDIFFUSE=11,m.MATERIALSPECULAR=12,m.SHADERDEFINE_DETAIL_NUM1=0,m.SHADERDEFINE_DETAIL_NUM2=0,m.SHADERDEFINE_DETAIL_NUM3=0,m.SHADERDEFINE_DETAIL_NUM4=0,y(m,["CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"defaultMaterial",function(){return this.defaultMaterial=new m();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),m;}(Ym),ya=function(q){function Q(){Q.__super.call(this),this.setShaderName("SkyBox");}
S(Q,"laya.d3.core.material.SkyBoxMaterial",Ym);var m=Q.prototype;return d(0,m,"tintColor",function(){return this._shaderValues.getVector(Q.TINTCOLOR);},function(q){this._shaderValues.setVector(Q.TINTCOLOR,q);}),d(0,m,"exposure",function(){return this._shaderValues.getNumber(Q.EXPOSURE);},function(q){this._shaderValues.setNumber(Q.EXPOSURE,q);}),d(0,m,"rotation",function(){return this._shaderValues.getNumber(Q.ROTATION);},function(q){this._shaderValues.setNumber(Q.ROTATION,q);}),d(0,m,"textureCube",function(){return this._shaderValues.getTexture(Q.TEXTURECUBE);},function(q){this._shaderValues.setTexture(Q.TEXTURECUBE,q);}),y(Q,["TINTCOLOR",function(){return this.TINTCOLOR=Bq.propertyNameToID("u_TintColor");},"EXPOSURE",function(){return this.EXPOSURE=Bq.propertyNameToID("u_Exposure");},"ROTATION",function(){return this.ROTATION=Bq.propertyNameToID("u_Rotation");},"TEXTURECUBE",function(){return this.TEXTURECUBE=Bq.propertyNameToID("u_CubeTexture");},"defaultMaterial",function(){return this.defaultMaterial=new Q();}]),Q;}(),Sa=function(m){function a(){this._albedoColor=null,this._specularColor=null,this._emissionColor=null,a.__super.call(this),this.setShaderName("PBRSpecular"),this._albedoColor=new rq(1,1,1,1),this._shaderValues.setVector(a.ALBEDOCOLOR,new rq(1,1,1,1)),this._emissionColor=new rq(0,0,0,0),this._shaderValues.setVector(a.EMISSIONCOLOR,new rq(0,0,0,0)),this._specularColor=new rq(.2,.2,.2,.2),this._shaderValues.setVector(a.SPECULARCOLOR,new rq(.2,.2,.2,.2)),this._shaderValues.setNumber(a.SMOOTHNESS,.5),this._shaderValues.setNumber(a.SMOOTHNESSSCALE,1),this._shaderValues.setNumber(a.SMOOTHNESSSOURCE,0),this._shaderValues.setNumber(a.OCCLUSIONSTRENGTH,1),this._shaderValues.setNumber(a.NORMALSCALE,1),this._shaderValues.setNumber(a.PARALLAXSCALE,.001),this._shaderValues.setBool(a.ENABLEEMISSION,!1),this._shaderValues.setNumber(Ym.ALPHATESTVALUE,.5),this.renderMode=0;}
S(a,"laya.d3.core.material.PBRSpecularMaterial",m);var q=a.prototype;return q.cloneTo=function(q){m.prototype.cloneTo.call(this,q);var Q=q;this._albedoColor.cloneTo(Q._albedoColor),this._specularColor.cloneTo(Q._specularColor),this._emissionColor.cloneTo(Q._emissionColor);},d(0,q,"emissionTexture",function(){return this._shaderValues.getTexture(a.EMISSIONTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSIONTEXTURE),this._shaderValues.setTexture(a.EMISSIONTEXTURE,q);}),d(0,q,"_SpecColorG",function(){return this._specularColor.y;},function(q){this._specularColor.y=q,this.specularColor=this._specularColor;}),d(0,q,"_ColorB",function(){return this._albedoColor.z;},function(q){this._albedoColor.z=q,this.albedoColor=this._albedoColor;}),d(0,q,"_ColorR",function(){return this._albedoColor.x;},function(q){this._albedoColor.x=q,this.albedoColor=this._albedoColor;}),d(0,q,"albedoColorA",function(){return this._ColorA;},function(q){this._ColorA=q;}),d(0,q,"_MainTex_STX",function(){return this._shaderValues.getVector(a.TILINGOFFSET).x;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.x=q,this.tilingOffset=Q;}),d(0,q,"_SpecColorB",function(){return this._specularColor.z;},function(q){this._specularColor.z=q,this.specularColor=this._specularColor;}),d(0,q,"renderMode",null,function(q){switch(q){case 0:this.alphaTest=!1,this.renderQueue=2e3,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513,this._defineDatas.remove(a.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 1:this.renderQueue=2450,this.alphaTest=!0,this.depthWrite=!0,this.cull=2,this.blend=0,this.depthTest=513,this._defineDatas.remove(a.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 2:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=2,this.blend=1,this.blendSrc=770,this.blendDst=771,this.depthTest=513,this._defineDatas.remove(a.SHADERDEFINE_ALPHAPREMULTIPLY);break;case 3:this.renderQueue=3e3,this.alphaTest=!1,this.depthWrite=!1,this.cull=2,this.blend=1,this.blendSrc=1,this.blendDst=771,this.depthTest=513,this._defineDatas.add(a.SHADERDEFINE_ALPHAPREMULTIPLY);break;default:throw new Error("PBRSpecularMaterial : renderMode value error.");}}),d(0,q,"_SpecColorR",function(){return this._specularColor.x;},function(q){this._specularColor.x=q,this.specularColor=this._specularColor;}),d(0,q,"_ColorG",function(){return this._albedoColor.y;},function(q){this._albedoColor.y=q,this.albedoColor=this._albedoColor;}),d(0,q,"_Glossiness",function(){return this._shaderValues.getNumber(a.SMOOTHNESS);},function(q){this._shaderValues.setNumber(a.SMOOTHNESS,q);}),d(0,q,"_ColorA",function(){return this._albedoColor.w;},function(q){this._albedoColor.w=q,this.albedoColor=this._albedoColor;}),d(0,q,"specularColor",function(){return this._shaderValues.getVector(a.SPECULARCOLOR);},function(q){this._shaderValues.setVector(a.SPECULARCOLOR,q);}),d(0,q,"albedoColorB",function(){return this._ColorB;},function(q){this._ColorB=q;}),d(0,q,"_SpecColorA",function(){return this._specularColor.w;},function(q){this._specularColor.w=q,this.specularColor=this._specularColor;}),d(0,q,"_GlossMapScale",function(){return this._shaderValues.getNumber(a.SMOOTHNESSSCALE);},function(q){this._shaderValues.setNumber(a.SMOOTHNESSSCALE,q);}),d(0,q,"_BumpScale",function(){return this._shaderValues.getNumber(a.NORMALSCALE);},function(q){this._shaderValues.setNumber(a.NORMALSCALE,q);}),d(0,q,"_Parallax",function(){return this._shaderValues.getNumber(a.PARALLAXSCALE);},function(q){this._shaderValues.setNumber(a.PARALLAXSCALE,q);}),d(0,q,"_OcclusionStrength",function(){return this._shaderValues.getNumber(a.OCCLUSIONSTRENGTH);},function(q){this._shaderValues.setNumber(a.OCCLUSIONSTRENGTH,q);}),d(0,q,"_EmissionColorR",function(){return this._emissionColor.x;},function(q){this._emissionColor.x=q,this.emissionColor=this._emissionColor;}),d(0,q,"tilingOffset",function(){return this._shaderValues.getVector(a.TILINGOFFSET);},function(q){q&&(1!=q.x||1!=q.y||0!=q.z||0!=q.w)?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_TILINGOFFSET),this._shaderValues.setVector(a.TILINGOFFSET,q);}),d(0,q,"_EmissionColorG",function(){return this._emissionColor.y;},function(q){this._emissionColor.y=q,this.emissionColor=this._emissionColor;}),d(0,q,"blendSrc",function(){return this._shaderValues.getInt(a.BLEND_SRC);},function(q){this._shaderValues.setInt(a.BLEND_SRC,q);}),d(0,q,"tilingOffsetW",function(){return this._MainTex_STW;},function(q){this._MainTex_STW=q;}),d(0,q,"_EmissionColorB",function(){return this._emissionColor.z;},function(q){this._emissionColor.z=q,this.emissionColor=this._emissionColor;}),d(0,q,"_EmissionColorA",function(){return this._emissionColor.w;},function(q){this._emissionColor.w=q,this.emissionColor=this._emissionColor;}),d(0,q,"_MainTex_STY",function(){return this._shaderValues.getVector(a.TILINGOFFSET).y;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.y=q,this.tilingOffset=Q;}),d(0,q,"_MainTex_STZ",function(){return this._shaderValues.getVector(a.TILINGOFFSET).z;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.z=q,this.tilingOffset=Q;}),d(0,q,"_Cutoff",function(){return this.alphaTestValue;},function(q){this.alphaTestValue=q;}),d(0,q,"_MainTex_STW",function(){return this._shaderValues.getVector(a.TILINGOFFSET).w;},function(q){var Q=this._shaderValues.getVector(a.TILINGOFFSET);Q.w=q,this.tilingOffset=Q;}),d(0,q,"albedoColorR",function(){return this._ColorR;},function(q){this._ColorR=q;}),d(0,q,"albedoColorG",function(){return this._ColorG;},function(q){this._ColorG=q;}),d(0,q,"tilingOffsetX",function(){return this._MainTex_STX;},function(q){this._MainTex_STX=q;}),d(0,q,"albedoColor",function(){return this._albedoColor;},function(q){this._albedoColor=q,this._shaderValues.setVector(a.ALBEDOCOLOR,q);}),d(0,q,"albedoTexture",function(){return this._shaderValues.getTexture(a.ALBEDOTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_ALBEDOTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_ALBEDOTEXTURE),this._shaderValues.setTexture(a.ALBEDOTEXTURE,q);}),d(0,q,"cull",function(){return this._shaderValues.getInt(a.CULL);},function(q){this._shaderValues.setInt(a.CULL,q);}),d(0,q,"parallaxTexture",function(){return this._shaderValues.getTexture(a.PARALLAXTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_PARALLAXTEXTURE),this._shaderValues.setTexture(a.PARALLAXTEXTURE,q);}),d(0,q,"normalTexture",function(){return this._shaderValues.getTexture(a.NORMALTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_NORMALTEXTURE),this._shaderValues.setTexture(a.NORMALTEXTURE,q);}),d(0,q,"emissionColor",function(){return this._shaderValues.getVector(a.EMISSIONCOLOR);},function(q){this._shaderValues.setVector(a.EMISSIONCOLOR,q);}),d(0,q,"parallaxTextureScale",function(){return this._Parallax;},function(q){this._Parallax=Math.max(.005,Math.min(.08,q));}),d(0,q,"normalTextureScale",function(){return this._BumpScale;},function(q){this._BumpScale=q;}),d(0,q,"tilingOffsetZ",function(){return this._MainTex_STZ;},function(q){this._MainTex_STZ=q;}),d(0,q,"occlusionTexture",function(){return this._shaderValues.getTexture(a.OCCLUSIONTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_OCCLUSIONTEXTURE),this._shaderValues.setTexture(a.OCCLUSIONTEXTURE,q);}),d(0,q,"occlusionTextureStrength",function(){return this._OcclusionStrength;},function(q){this._OcclusionStrength=Math.max(0,Math.min(1,q));}),d(0,q,"specularTexture",function(){return this._shaderValues.getTexture(a.SPECULARTEXTURE);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SPECULARTEXTURE),this._shaderValues.setTexture(a.SPECULARTEXTURE,q);}),d(0,q,"specularColorR",function(){return this._SpecColorR;},function(q){this._SpecColorR=q;}),d(0,q,"smoothness",function(){return this._Glossiness;},function(q){this._Glossiness=Math.max(0,Math.min(1,q));}),d(0,q,"specularColorG",function(){return this._SpecColorG;},function(q){this._SpecColorG=q;}),d(0,q,"specularColorB",function(){return this._SpecColorB;},function(q){this._SpecColorB=q;}),d(0,q,"specularColorA",function(){return this._SpecColorA;},function(q){this._SpecColorA=q;}),d(0,q,"blendDst",function(){return this._shaderValues.getInt(a.BLEND_DST);},function(q){this._shaderValues.setInt(a.BLEND_DST,q);}),d(0,q,"smoothnessTextureScale",function(){return this._GlossMapScale;},function(q){this._GlossMapScale=Math.max(0,Math.min(1,q));}),d(0,q,"depthWrite",function(){return this._shaderValues.getBool(a.DEPTH_WRITE);},function(q){this._shaderValues.setBool(a.DEPTH_WRITE,q);}),d(0,q,"smoothnessSource",function(){return this._shaderValues.getInt(a.SMOOTHNESSSOURCE);},function(q){q?(this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(a.SMOOTHNESSSOURCE,1)):(this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA),this._shaderValues.setInt(a.SMOOTHNESSSOURCE,0));}),d(0,q,"enableEmission",function(){return this._shaderValues.getBool(a.ENABLEEMISSION);},function(q){q?this._defineDatas.add(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION):this._defineDatas.remove(laya.d3.core.material.PBRSpecularMaterial.SHADERDEFINE_EMISSION),this._shaderValues.setBool(a.ENABLEEMISSION,q);}),d(0,q,"enableReflection",function(){return this._shaderValues.getBool(a.ENABLEREFLECT);},function(q){this._shaderValues.setBool(a.ENABLEREFLECT,!0),q?this._disablePublicDefineDatas.remove(gm.SHADERDEFINE_REFLECTMAP):this._disablePublicDefineDatas.add(gm.SHADERDEFINE_REFLECTMAP);}),d(0,q,"tilingOffsetY",function(){return this._MainTex_STY;},function(q){this._MainTex_STY=q;}),d(0,q,"blend",function(){return this._shaderValues.getInt(a.BLEND);},function(q){this._shaderValues.setInt(a.BLEND,q);}),d(0,q,"depthTest",function(){return this._shaderValues.getInt(a.DEPTH_TEST);},function(q){this._shaderValues.setInt(a.DEPTH_TEST,q);}),a.__init__=function(){a.SHADERDEFINE_ALBEDOTEXTURE=a.shaderDefines.registerDefine("ALBEDOTEXTURE"),a.SHADERDEFINE_SPECULARTEXTURE=a.shaderDefines.registerDefine("SPECULARTEXTURE"),a.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=a.shaderDefines.registerDefine("SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA"),a.SHADERDEFINE_NORMALTEXTURE=a.shaderDefines.registerDefine("NORMALTEXTURE"),a.SHADERDEFINE_PARALLAXTEXTURE=a.shaderDefines.registerDefine("PARALLAXTEXTURE"),a.SHADERDEFINE_OCCLUSIONTEXTURE=a.shaderDefines.registerDefine("OCCLUSIONTEXTURE"),a.SHADERDEFINE_EMISSION=a.shaderDefines.registerDefine("EMISSION"),a.SHADERDEFINE_EMISSIONTEXTURE=a.shaderDefines.registerDefine("EMISSIONTEXTURE"),a.SHADERDEFINE_TILINGOFFSET=a.shaderDefines.registerDefine("TILINGOFFSET"),a.SHADERDEFINE_ALPHAPREMULTIPLY=a.shaderDefines.registerDefine("ALPHAPREMULTIPLY");},a.SmoothnessSource_SpecularTexture_Alpha=0,a.SmoothnessSource_AlbedoTexture_Alpha=1,a.RENDERMODE_OPAQUE=0,a.RENDERMODE_CUTOUT=1,a.RENDERMODE_FADE=2,a.RENDERMODE_TRANSPARENT=3,a.SHADERDEFINE_ALBEDOTEXTURE=0,a.SHADERDEFINE_NORMALTEXTURE=0,a.SHADERDEFINE_SMOOTHNESSSOURCE_ALBEDOTEXTURE_ALPHA=0,a.SHADERDEFINE_SPECULARTEXTURE=0,a.SHADERDEFINE_OCCLUSIONTEXTURE=0,a.SHADERDEFINE_PARALLAXTEXTURE=0,a.SHADERDEFINE_EMISSION=0,a.SHADERDEFINE_EMISSIONTEXTURE=0,a.SHADERDEFINE_TILINGOFFSET=0,a.SHADERDEFINE_ALPHAPREMULTIPLY=0,a.SMOOTHNESSSOURCE=-1,a.ENABLEEMISSION=-1,a.ENABLEREFLECT=-1,y(a,["ALBEDOTEXTURE",function(){return this.ALBEDOTEXTURE=Bq.propertyNameToID("u_AlbedoTexture");},"SPECULARTEXTURE",function(){return this.SPECULARTEXTURE=Bq.propertyNameToID("u_SpecularTexture");},"NORMALTEXTURE",function(){return this.NORMALTEXTURE=Bq.propertyNameToID("u_NormalTexture");},"PARALLAXTEXTURE",function(){return this.PARALLAXTEXTURE=Bq.propertyNameToID("u_ParallaxTexture");},"OCCLUSIONTEXTURE",function(){return this.OCCLUSIONTEXTURE=Bq.propertyNameToID("u_OcclusionTexture");},"EMISSIONTEXTURE",function(){return this.EMISSIONTEXTURE=Bq.propertyNameToID("u_EmissionTexture");},"ALBEDOCOLOR",function(){return this.ALBEDOCOLOR=Bq.propertyNameToID("u_AlbedoColor");},"SPECULARCOLOR",function(){return this.SPECULARCOLOR=Bq.propertyNameToID("u_SpecularColor");},"EMISSIONCOLOR",function(){return this.EMISSIONCOLOR=Bq.propertyNameToID("u_EmissionColor");},"SMOOTHNESS",function(){return this.SMOOTHNESS=Bq.propertyNameToID("u_smoothness");},"SMOOTHNESSSCALE",function(){return this.SMOOTHNESSSCALE=Bq.propertyNameToID("u_smoothnessScale");},"OCCLUSIONSTRENGTH",function(){return this.OCCLUSIONSTRENGTH=Bq.propertyNameToID("u_occlusionStrength");},"NORMALSCALE",function(){return this.NORMALSCALE=Bq.propertyNameToID("u_normalScale");},"PARALLAXSCALE",function(){return this.PARALLAXSCALE=Bq.propertyNameToID("u_parallaxScale");},"TILINGOFFSET",function(){return this.TILINGOFFSET=Bq.propertyNameToID("u_TilingOffset");},"CULL",function(){return this.CULL=Bq.propertyNameToID("s_Cull");},"BLEND",function(){return this.BLEND=Bq.propertyNameToID("s_Blend");},"BLEND_SRC",function(){return this.BLEND_SRC=Bq.propertyNameToID("s_BlendSrc");},"BLEND_DST",function(){return this.BLEND_DST=Bq.propertyNameToID("s_BlendDst");},"DEPTH_TEST",function(){return this.DEPTH_TEST=Bq.propertyNameToID("s_DepthTest");},"DEPTH_WRITE",function(){return this.DEPTH_WRITE=Bq.propertyNameToID("s_DepthWrite");},"defaultMaterial",function(){return this.defaultMaterial=new a();},"shaderDefines",function(){return this.shaderDefines=new dq(Ym.shaderDefines);}]),a;}(Ym),ta=(function(w){function e(q,Q){this._isKinematic=!1,this._mass=1,this._angularDamping=0,this._linearDamping=0,this._overrideGravity=!1,this._detectCollisions=!0,this._gravity=new _q(0,-10,0),this._totalTorque=new _q(0,0,0),this._linearVelocity=new _q(),this._angularVelocity=new _q(),this._linearFactor=new _q(1,1,1),this._angularFactor=new _q(1,1,1),void 0===q&&(q=1),void 0===Q&&(Q=LQ.COLLISIONFILTERGROUP_ALLFILTER),e.__super.call(this,q,Q);}
S(e,"laya.d3.physics.Rigidbody3D",w);var q=e.prototype;q._updateMass=function(q){this._nativeColliderObject&&this._colliderShape&&(this._colliderShape._nativeShape.calculateLocalInertia(q,e._nativeInertia),this._nativeColliderObject.setMassProps(q,e._nativeInertia),this._nativeColliderObject.updateInertiaTensor());},q._delegateMotionStateGetWorldTransform=function(q){},q._delegateMotionStateSetWorldTransform=function(q){var Q=this._rigidbody;Q._simulation._updatedRigidbodies++;var m=R._physics3D,a=m.wrapPointer(q,m.btTransform);Q._updateTransformComponent(a);},q._delegateMotionStateGetWorldTransformNative=function(q,Q){},q._delegateMotionStateSetWorldTransformNative=function(q,Q){var m=q;m._simulation._updatedRigidbodies++;var a=R._physics3D,w=a.wrapPointer(Q,a.btTransform);m._updateTransformComponent(w);},q._onScaleChange=function(q){laya.d3.physics.PhysicsComponent.prototype._onScaleChange.call(this,q),this._updateMass(this._isKinematic?0:this._mass);},q._delegateMotionStateClear=function(){this._rigidbody=null;},q._onAdded=function(){var q=R._physics3D,Q=new q.LayaMotionState();null!=F.conch&&q.LayaMotionState.prototype.setRigidbody?(Q.setRigidbody(this),Q.setNativeGetWorldTransform(this._delegateMotionStateGetWorldTransformNative),Q.setNativeSetWorldTransform(this._delegateMotionStateSetWorldTransformNative)):(Q.getWorldTransform=this._delegateMotionStateGetWorldTransform,Q.setWorldTransform=this._delegateMotionStateSetWorldTransform),Q.clear=this._delegateMotionStateClear,(Q._rigidbody=this)._nativeMotionState=Q;var m=new q.btRigidBodyConstructionInfo(0,Q,null,e._nativeVector3Zero),a=new q.btRigidBody(m);a.setUserIndex(this.id),this._nativeColliderObject=a,w.prototype._onAdded.call(this),this.mass=this._mass,this.linearFactor=this._linearFactor,this.angularFactor=this._angularFactor,this.linearDamping=this._linearDamping,this.angularDamping=this._angularDamping,this.overrideGravity=this._overrideGravity,this.gravity=this._gravity,this.isKinematic=this._isKinematic,q.destroy(m);},q._onShapeChange=function(q){laya.d3.physics.PhysicsComponent.prototype._onShapeChange.call(this,q),this._isKinematic?this._updateMass(0):(this._nativeColliderObject.setCenterOfMassTransform(this._nativeColliderObject.getWorldTransform()),this._updateMass(this._mass));},q._parse=function(q){null!=q.friction&&(this.friction=q.friction),null!=q.rollingFriction&&(this.rollingFriction=q.rollingFriction),null!=q.restitution&&(this.restitution=q.restitution),null!=q.isTrigger&&(this.isTrigger=q.isTrigger),null!=q.mass&&(this.mass=q.mass),null!=q.isKinematic&&(this.isKinematic=q.isKinematic),null!=q.linearDamping&&(this.linearDamping=q.linearDamping),null!=q.angularDamping&&(this.angularDamping=q.angularDamping),null!=q.overrideGravity&&(this.overrideGravity=q.overrideGravity),q.gravity&&(this.gravity.fromArray(q.gravity),this.gravity=this.gravity),laya.d3.physics.PhysicsComponent.prototype._parse.call(this,q),this._parseShape(q.shapes);},q._onDestroy=function(){var q=R._physics3D;this._nativeMotionState.clear(),q.destroy(this._nativeMotionState),laya.d3.physics.PhysicsComponent.prototype._onDestroy.call(this),this._nativeMotionState=null,this._gravity=null,this._totalTorque=null,this._linearVelocity=null,this._angularVelocity=null,this._linearFactor=null,this._angularFactor=null;},q._addToSimulation=function(){this._simulation._addRigidBody(this,this._collisionGroup,this._detectCollisions?this._canCollideWith:0);},q._removeFromSimulation=function(){this._simulation._removeRigidBody(this);},q._cloneTo=function(q){w.prototype._cloneTo.call(this,q);var Q=q;Q.isKinematic=this._isKinematic,Q.mass=this._mass,Q.gravity=this._gravity,Q.angularDamping=this._angularDamping,Q.linearDamping=this._linearDamping,Q.overrideGravity=this._overrideGravity,Q.linearVelocity=this._linearVelocity,Q.angularVelocity=this._angularVelocity,Q.linearFactor=this._linearFactor,Q.angularFactor=this._angularFactor,Q.detectCollisions=this._detectCollisions;},q.applyForce=function(q,Q){if(null==this._nativeColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var m=e._nativeTempVector30;if(m.setValue(-q.x,q.y,q.z),Q){var a=e._nativeTempVector31;a.setValue(-Q.x,Q.y,Q.z),this._nativeColliderObject.applyForce(m,a);}else this._nativeColliderObject.applyCentralForce(m);},q.applyTorque=function(q){if(null==this._nativeColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var Q=e._nativeTempVector30;Q.setValue(-q.x,q.y,q.z),this._nativeColliderObject.applyTorque(Q);},q.applyImpulse=function(q,Q){if(null==this._nativeColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";e._nativeImpulse.setValue(-q.x,q.y,q.z),Q?(e._nativeImpulseOffset.setValue(-Q.x,Q.y,Q.z),this._nativeColliderObject.applyImpulse(e._nativeImpulse,e._nativeImpulseOffset)):this._nativeColliderObject.applyCentralImpulse(e._nativeImpulse);},q.applyTorqueImpulse=function(q){if(null==this._nativeColliderObject)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";var Q=e._nativeTempVector30;Q.setValue(-q.x,q.y,q.z),this._nativeColliderObject.applyTorqueImpulse(Q);},q.wakeUp=function(){this._nativeColliderObject&&this._nativeColliderObject.activate(!1);},q.clearForces=function(){var q=this._nativeColliderObject;if(null==q)throw"Attempted to call a Physics function that is avaliable only when the Entity has been already added to the Scene.";q.clearForces();var Q=e._nativeVector3Zero;q.setInterpolationAngularVelocity(Q),q.setLinearVelocity(Q),q.setInterpolationAngularVelocity(Q),q.setAngularVelocity(Q);},d(0,q,"angularDamping",function(){return this._angularDamping;},function(q){this._angularDamping=q,this._nativeColliderObject&&this._nativeColliderObject.setDamping(this._linearDamping,q);}),d(0,q,"mass",function(){return this._mass;},function(q){q=Math.max(q,1e-7),this._mass=q,this._isKinematic||this._updateMass(q);}),d(0,q,"linearDamping",function(){return this._linearDamping;},function(q){this._linearDamping=q,this._nativeColliderObject&&this._nativeColliderObject.setDamping(q,this._angularDamping);}),d(0,q,"isKinematic",function(){return this._isKinematic;},function(q){this._isKinematic=q;var Q=!!(this._simulation&&this._enabled&&this._colliderShape);Q&&this._removeFromSimulation();var m=this._nativeColliderObject,a=m.getCollisionFlags();q?(a|=2,m.setCollisionFlags(a),this._nativeColliderObject.forceActivationState(4),this._enableProcessCollisions=!1,this._updateMass(0)):(0<(2&a)&&(a^=2),m.setCollisionFlags(a),this._nativeColliderObject.setActivationState(1),this._enableProcessCollisions=!0,this._updateMass(this._mass));var w=e._nativeVector3Zero;m.setInterpolationLinearVelocity(w),m.setLinearVelocity(w),m.setInterpolationAngularVelocity(w),m.setAngularVelocity(w),Q&&this._addToSimulation();}),d(0,q,"gravity",function(){return this._gravity;},function(q){this._gravity=q,e._nativeGravity.setValue(-q.x,q.y,q.z),this._nativeColliderObject.setGravity(e._nativeGravity);}),d(0,q,"overrideGravity",function(){return this._overrideGravity;},function(q){if(this._overrideGravity=q,this._nativeColliderObject){var Q=this._nativeColliderObject.getFlags();q?0==(1&Q)&&this._nativeColliderObject.setFlags(1|Q):0<(1&Q)&&this._nativeColliderObject.setFlags(1^Q);}}),d(0,q,"totalForce",function(){return this._nativeColliderObject?this._nativeColliderObject.getTotalForce():null;}),d(0,q,"linearVelocity",function(){return this._nativeColliderObject&&Rq._convertToLayaVec3(this._nativeColliderObject.getLinearVelocity(),this._linearVelocity,!0),this._linearVelocity;},function(q){if(this._linearVelocity=q,this._nativeColliderObject){var Q=e._nativeTempVector30;Rq._convertToBulletVec3(q,Q,!0),this.isSleeping&&this.wakeUp(),this._nativeColliderObject.setLinearVelocity(Q);}}),d(0,q,"detectCollisions",function(){return this._detectCollisions;},function(q){this._detectCollisions!==q&&(this._detectCollisions=q,this._colliderShape&&this._enabled&&this._simulation&&(this._simulation._removeRigidBody(this),this._simulation._addRigidBody(this,this._collisionGroup,q?this._canCollideWith:0)));}),d(0,q,"linearFactor",function(){return this._nativeColliderObject?this._linearFactor:null;},function(q){if(this._linearFactor=q,this._nativeColliderObject){var Q=e._nativeTempVector30;Rq._convertToBulletVec3(q,Q,!1),this._nativeColliderObject.setLinearFactor(Q);}}),d(0,q,"angularFactor",function(){return this._nativeColliderObject?this._angularFactor:null;},function(q){if(this._angularFactor=q,this._nativeColliderObject){var Q=e._nativeTempVector30;Rq._convertToBulletVec3(q,Q,!1),this._nativeColliderObject.setAngularFactor(Q);}}),d(0,q,"angularVelocity",function(){return this._nativeColliderObject&&Rq._convertToLayaVec3(this._nativeColliderObject.getAngularVelocity(),this._angularVelocity,!0),this._angularVelocity;},function(q){if(this._angularVelocity=q,this._nativeColliderObject){var Q=e._nativeTempVector30;Rq._convertToBulletVec3(q,Q,!0),this.isSleeping&&this.wakeUp(),this._nativeColliderObject.setAngularVelocity(Q);}}),d(0,q,"totalTorque",function(){if(this._nativeColliderObject){var q=this._nativeColliderObject.getTotalTorque(),Q=this._totalTorque;Q.x=-q.x,Q.y=q.y,Q.z=q.z;}
return null;}),d(0,q,"isSleeping",function(){return!!this._nativeColliderObject&&2===this._nativeColliderObject.getActivationState();}),d(0,q,"sleepLinearVelocity",function(){return this._nativeColliderObject.getLinearSleepingThreshold();},function(q){this._nativeColliderObject.setSleepingThresholds(q,this._nativeColliderObject.getAngularSleepingThreshold());}),d(0,q,"sleepAngularVelocity",function(){return this._nativeColliderObject.getAngularSleepingThreshold();},function(q){this._nativeColliderObject.setSleepingThresholds(this._nativeColliderObject.getLinearSleepingThreshold(),q);}),e.TYPE_STATIC=0,e.TYPE_DYNAMIC=1,e.TYPE_KINEMATIC=2,e._BT_DISABLE_WORLD_GRAVITY=1,e._BT_ENABLE_GYROPSCOPIC_FORCE=2,y(e,["_nativeTempVector30",function(){return this._nativeTempVector30=new R._physics3D.btVector3(0,0,0);},"_nativeTempVector31",function(){return this._nativeTempVector31=new R._physics3D.btVector3(0,0,0);},"_nativeVector3Zero",function(){return this._nativeVector3Zero=new R._physics3D.btVector3(0,0,0);},"_nativeInertia",function(){return this._nativeInertia=new R._physics3D.btVector3(0,0,0);},"_nativeImpulse",function(){return this._nativeImpulse=new R._physics3D.btVector3(0,0,0);},"_nativeImpulseOffset",function(){return this._nativeImpulseOffset=new R._physics3D.btVector3(0,0,0);},"_nativeGravity",function(){return this._nativeGravity=new R._physics3D.btVector3(0,0,0);}]);}(im),function(m){function a(q,Q){void 0===q&&(q=1),void 0===Q&&(Q=LQ.COLLISIONFILTERGROUP_ALLFILTER),a.__super.call(this,q,Q);}
S(a,"laya.d3.physics.PhysicsCollider",m);var q=a.prototype;q._addToSimulation=function(){this._simulation._addPhysicsCollider(this,this._collisionGroup,this._canCollideWith);},q._removeFromSimulation=function(){this._simulation._removePhysicsCollider(this);},q._onTransformChanged=function(q){(q&=56)&&(this._transformFlag|=q,this._isValid()&&-1===this._inPhysicUpdateListIndex&&this._simulation._physicsUpdateList.add(this));},q._parse=function(q){null!=q.friction&&(this.friction=q.friction),null!=q.rollingFriction&&(this.rollingFriction=q.rollingFriction),null!=q.restitution&&(this.restitution=q.restitution),null!=q.isTrigger&&(this.isTrigger=q.isTrigger),laya.d3.physics.PhysicsComponent.prototype._parse.call(this,q),this._parseShape(q.shapes);},q._onAdded=function(){var q=new R._physics3D.btCollisionObject();q.setUserIndex(this.id),q.forceActivationState(5);var Q=q.getCollisionFlags();this.owner.isStatic?(0<(2&Q)&&(Q^=2),Q|=1):(0<(1&Q)&&(Q^=1),Q|=2),q.setCollisionFlags(Q),this._nativeColliderObject=q,m.prototype._onAdded.call(this);};}(im),function(W){function w(q){this._bones=[],this._skinnedDataLoopMarks=[],this._localBounds=new lQ(_q._ZERO,_q._ZERO),this._cacheAnimationNode=[],w.__super.call(this,q);}
S(w,"laya.d3.core.SkinnedMeshRenderer",W);var q=w.prototype;return q._computeSkinnedData=function(){if(this._cacheMesh&&this._cacheAvatar||this._cacheMesh&&this._cacheRootBone)
for(var q=this._cacheMesh._inverseBindPoses,Q=this._cacheMesh._bindPoseIndices,m=this._cacheMesh._skinDataPathMarks,a=0,w=this._cacheMesh.subMeshCount;a<w;a++)
for(var e=this._cacheMesh._getSubMesh(a)._boneIndicesList,F=this._skinnedData[a],W=0,s=e.length;W<s;W++){var D=e[W];M.supportWebGLPlusAnimation?this._computeSubSkinnedDataNative(this._cacheAnimator._animationNodeWorldMatrixs,this._cacheAnimationNodeIndices,this._cacheMesh._inverseBindPosesBuffer,D,Q,F[W]):this._computeSubSkinnedData(q,D,Q,F[W],m);}},q._computeSubSkinnedData=function(q,Q,m,a,w){for(var e=0,F=Q.length;e<F;e++){var W=Q[e];if(this._skinnedDataLoopMarks[W]===r.loopCount)
for(var s=w[W],D=this._skinnedData[s[0]][s[1]],d=16*s[2],v=16*e,y=0;y<16;y++)a[v+y]=D[d+y];else{if(this._cacheRootBone){var S=m[W];Rq._mulMatrixArray(this._bones[S].transform.worldMatrix.elements,q[S],a,16*e);}else Rq._mulMatrixArray(this._cacheAnimationNode[W].transform.getWorldMatrix(),q[m[W]],a,16*e);this._skinnedDataLoopMarks[W]=r.loopCount;}}},q._boundChange=function(){this._boundsChange=!0;},q._onMeshChange=function(q){W.prototype._onMeshChange.call(this,q);var Q=(this._cacheMesh=q).subMeshCount;this._skinnedData=N(Q),this._skinnedDataLoopMarks.length=q._bindPoseIndices.length;for(var m=0;m<Q;m++)
for(var a=q._getSubMesh(m)._boneIndicesList,w=a.length,e=this._skinnedData[m]=N(w),F=0;F<w;F++)e[F]=new Float32Array(16*a[F].length);this._bones||this._cacheAvatar&&q&&this._getCacheAnimationNodes();},q._setCacheAnimator=function(q){this._cacheAnimator=q,this._defineDatas.add(la.SHADERDEFINE_BONE),this._setRootNode();},q._calculateBoundingBox=function(){if(this._cacheRootBone)this._localBounds._tranform(this._cacheRootBone.transform.worldMatrix,this._bounds);else if(this._cacheAnimator&&this._rootBone){var q=w._tempMatrix4x4;Rq.matrix4x4MultiplyMFM(this._cacheAnimator.owner.transform.worldMatrix,this._cacheRootAnimationNode.transform.getWorldMatrix(),q),this._localBounds._tranform(q,this._bounds);}else W.prototype._calculateBoundingBox.call(this);if(M.supportWebGLPlusCulling){var Q=this._bounds.getMin(),m=this._bounds.getMax(),a=NQ._cullingBuffer;a[this._cullingBufferIndex+1]=Q.x,a[this._cullingBufferIndex+2]=Q.y,a[this._cullingBufferIndex+3]=Q.z,a[this._cullingBufferIndex+4]=m.x,a[this._cullingBufferIndex+5]=m.y,a[this._cullingBufferIndex+6]=m.z;}},q._changeRenderObjectsByMesh=function(q){var Q=q.subMeshCount;this._renderElements.length=Q;for(var m=0;m<Q;m++){var a=this._renderElements[m];if(!a){var w=this.sharedMaterials[m];(a=this._renderElements[m]=new Vq()).setTransform(this._owner._transform),a.render=this,a.material=w||da.defaultMaterial;}
a.setGeometry(q._getSubMesh(m));}},q._renderUpdate=function(q,Q){if(this._cacheAnimator)
if(this._computeSkinnedData(),this._cacheRootBone)this._shaderValues.setMatrix4x4(Mm.WORLDMATRIX,kQ.DEFAULT);else{var m=this._cacheAnimator.owner._transform;this._shaderValues.setMatrix4x4(Mm.WORLDMATRIX,m.worldMatrix);}
else this._shaderValues.setMatrix4x4(Mm.WORLDMATRIX,Q.worldMatrix);},q._renderUpdateWithCamera=function(q,Q){var m=q.projectionViewMatrix;if(this._cacheRootBone)this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,m);else{if(this._cacheAnimator){var a=this._cacheAnimator.owner._transform;kQ.multiply(m,a.worldMatrix,this._projectionViewWorldMatrix);}else kQ.multiply(m,Q.worldMatrix,this._projectionViewWorldMatrix);this._shaderValues.setMatrix4x4(Mm.MVPMATRIX,this._projectionViewWorldMatrix);}},q._destroy=function(){W.prototype._destroy.call(this),this._cacheRootBone?this._cacheRootBone.transform.off("transformchanged",this,this._boundChange):this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off("transformchanged",this,this._boundChange);},q._setRootBone=function(q){this._rootBone=q,this._setRootNode();},q._setRootNode=function(){var q;q=this._cacheAnimator&&this._rootBone&&this._cacheAvatar?this._cacheAnimator._avatarNodeMap[this._rootBone]:null,this._cacheRootAnimationNode!=q&&(this._boundChange(),this._cacheRootAnimationNode&&this._cacheRootAnimationNode.transform.off("transformchanged",this,this._boundChange),q&&q.transform.on("transformchanged",this,this._boundChange),this._cacheRootAnimationNode=q);},q._getCacheAnimationNodes=function(){var q=this._cacheMesh._boneNames,Q=this._cacheMesh._bindPoseIndices,m=Q.length;if(M.supportWebGLPlusAnimation){this._cacheAnimationNodeIndices=new Uint16Array(m);var a=this._cacheAnimator._avatarNodeMap;for(F=0;F<m;F++){var w=a[q[Q[F]]];this._cacheAnimationNodeIndices[F]=w._worldMatrixIndex;}}else{this._cacheAnimationNode.length=m;for(var e=this._cacheAnimator._avatarNodeMap,F=0;F<m;F++){var W=e[q[Q[F]]];this._cacheAnimationNode[F]=W;}}},q._setCacheAvatar=function(q){this._cacheAvatar!==q&&(this._cacheMesh?(this._cacheAvatar=q)&&(this._defineDatas.add(la.SHADERDEFINE_BONE),this._getCacheAnimationNodes()):this._cacheAvatar=q,this._setRootNode());},q._computeSubSkinnedDataNative=function(q,Q,m,a,w,e){J.instance.computeSubSkinnedData(q,Q,m,a,w,e);},d(0,q,"localBounds",function(){return this._localBounds;},function(q){this._localBounds=q;}),d(0,q,"rootBone",function(){return this._cacheRootBone;},function(q){this._cacheRootBone!=q&&(this._cacheRootBone&&this._cacheRootBone.transform.off("transformchanged",this,this._boundChange),q.transform.on("transformchanged",this,this._boundChange),this._cacheRootBone=q,this._boundChange());}),d(0,q,"bones",function(){return this._bones;}),d(0,q,"bounds",function(){return(this._boundsChange||this._cacheAvatar)&&(this._calculateBoundingBox(),this._boundsChange=!1),this._bounds;}),y(w,["_tempMatrix4x4",function(){return this._tempMatrix4x4=new kQ();}]),w;}(jm)),oa=function(q){function W(q,Q,m,a){void 0===m&&(m=0),void 0===a&&(a=0),W.__super.call(this,m,!1),this._glTextureType=3553,this._width=q,this._height=Q,this._depthStencilFormat=a,this._create(q,Q);}
S(W,"laya.d3.resource.RenderTexture",m);var Q=W.prototype;return Q._create=function(q,Q){var m=J.instance;this._frameBuffer=m.createFramebuffer(),E.bindTexture(m,this._glTextureType,this._glTexture);var a=this._getGLFormat();if(m.texImage2D(this._glTextureType,0,a,q,Q,0,a,5121,null),this._setGPUMemory(q*Q*4),m.bindFramebuffer(36160,this._frameBuffer),m.framebufferTexture2D(36160,36064,3553,this._glTexture,0),3!==this._depthStencilFormat)switch(this._depthStencilBuffer=m.createRenderbuffer(),m.bindRenderbuffer(36161,this._depthStencilBuffer),this._depthStencilFormat){case 0:m.renderbufferStorage(36161,33189,q,Q),m.framebufferRenderbuffer(36160,36096,36161,this._depthStencilBuffer);break;case 1:m.renderbufferStorage(36161,36168,q,Q),m.framebufferRenderbuffer(36160,36128,36161,this._depthStencilBuffer);break;case 2:m.renderbufferStorage(36161,34041,q,Q),m.framebufferRenderbuffer(36160,33306,36161,this._depthStencilBuffer);break;default:throw"RenderTexture: unkonw depth format.";}
m.bindFramebuffer(36160,null),m.bindRenderbuffer(36161,null),this._setWarpMode(10242,this._wrapModeU),this._setWarpMode(10243,this._wrapModeV),this._setFilterMode(this._filterMode),this._setAnisotropy(this._anisoLevel),this._readyed=!0,this._activeResource();},Q._start=function(){J.instance.bindFramebuffer(36160,this._frameBuffer),(W._currentActive=this)._readyed=!1;},Q._end=function(){J.instance.bindFramebuffer(36160,null),W._currentActive=null,this._readyed=!0;},Q.getData=function(q,Q,m,a,w){if(M.isConchApp&&2==conchConfig.threadMode)throw"native 2 thread mode use getDataAsync";var e=J.instance;return e.bindFramebuffer(36160,this._frameBuffer),36053===e.checkFramebufferStatus(36160)?(e.readPixels(q,Q,m,a,6408,5121,w),e.bindFramebuffer(36160,null),w):(e.bindFramebuffer(36160,null),null);},Q.getDataAsync=function(q,Q,m,a,w){var e=J.instance;e.bindFramebuffer(36160,this._frameBuffer),e.readPixelsAsync(q,Q,m,a,6408,5121,function(q){w(new Uint8Array(q));}),e.bindFramebuffer(36160,null);},Q._disposeResource=function(){if(this._frameBuffer){var q=J.instance;q.deleteTexture(this._glTexture),q.deleteFramebuffer(this._frameBuffer),q.deleteRenderbuffer(this._depthStencilBuffer),this._glTexture=null,this._frameBuffer=null,this._depthStencilBuffer=null,this._setGPUMemory(0);}},d(0,Q,"depthStencilFormat",function(){return this._depthStencilFormat;}),d(0,Q,"defaulteTexture",function(){return Y.grayTexture;}),d(1,W,"currentActive",function(){return W._currentActive;},laya.resource.BaseTexture._$SET_currentActive),W.getTemporary=function(q,Q,m,a,w){void 0===m&&(m=0),void 0===a&&(a=0),void 0===w&&(w=1);var e=W._temporaryMap[1e7*w+1e6*a+1e5*m+1e4*Q+q];if(!e||e&&0===e.length){var F=new W(q,Q,m,a);return F.filterMode=w,F;}
return e.pop();},W.setReleaseTemporary=function(q){var Q=1e7*q.filterMode+1e6*q.depthStencilFormat+1e5*q.format+1e4*q.height+q.width,m=W._temporaryMap[Q];m||(W._temporaryMap[Q]=m=[]),m.push(q);},W._temporaryMap={},W._currentActive=null,W;}(),ba=function(q){function w(q,Q){void 0===q&&(q=0),void 0===Q&&(Q=!1),w.__super.call(this,q,Q),this._glTextureType=34067;}
S(w,"laya.d3.resource.TextureCube",m);var Q=w.prototype;return Q.setSixSideImageSources=function(q,Q){void 0===Q&&(Q=!1);for(var m=0,a=0,w=0;w<6;w++){var e=q[w];if(!e)return void console.log("TextureCube: image Source can't be null.");var F=e.width,W=e.height;if(0<w&&m!==F)return void console.log("TextureCube: each side image's width and height must same.");if((m=F)!==(a=W))return void console.log("TextureCube: each side image's width and height must same.");}
this._width=m,this._height=a;var s=J.instance;E.bindTexture(s,this._glTextureType,this._glTexture);var D=this._getGLFormat();if(M.isConchApp){if(1==Q)
for(var d=0;d<6;d++)q[d].setPremultiplyAlpha(Q);s.texImage2D(34073,0,6408,6408,5121,q[0]),s.texImage2D(34074,0,6408,6408,5121,q[1]),s.texImage2D(34069,0,6408,6408,5121,q[2]),s.texImage2D(34070,0,6408,6408,5121,q[3]),s.texImage2D(34071,0,6408,6408,5121,q[4]),s.texImage2D(34072,0,6408,6408,5121,q[5]);}else Q&&s.pixelStorei(37441,!0),s.texImage2D(34073,0,D,D,5121,q[0]),s.texImage2D(34074,0,D,D,5121,q[1]),s.texImage2D(34069,0,D,D,5121,q[2]),s.texImage2D(34070,0,D,D,5121,q[3]),s.texImage2D(34071,0,D,D,5121,q[4]),s.texImage2D(34072,0,D,D,5121,q[5]),Q&&s.pixelStorei(37441,!1);this._mipmap&&this._isPot(m)&&this._isPot(a)?(s.generateMipmap(this._glTextureType),this._setGPUMemory(m*a*4*(1+1/3)*6)):this._setGPUMemory(m*a*4*6),this._setWarpMode(10242,this._wrapModeU),this._setWarpMode(10243,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource();},Q.setSixSidePixels=function(q,Q,m){if(q<=0||Q<=0)throw new Error("TextureCube:width or height must large than 0.");if(!m)throw new Error("TextureCube:pixels can't be null.");this._width=q,this._height=Q;var a=J.instance;E.bindTexture(a,this._glTextureType,this._glTexture);var w=this._getGLFormat();a.texImage2D(34073,0,w,q,Q,0,w,5121,m[0]),a.texImage2D(34074,0,w,q,Q,0,w,5121,m[1]),a.texImage2D(34069,0,w,q,Q,0,w,5121,m[2]),a.texImage2D(34070,0,w,q,Q,0,w,5121,m[3]),a.texImage2D(34071,0,w,q,Q,0,w,5121,m[4]),a.texImage2D(34072,0,w,q,Q,0,w,5121,m[5]),this._mipmap&&this._isPot(q)&&this._isPot(Q)?(a.generateMipmap(this._glTextureType),this._setGPUMemory(q*Q*4*(1+1/3)*6)):this._setGPUMemory(q*Q*4*6),this._setWarpMode(10242,this._wrapModeU),this._setWarpMode(10243,this._wrapModeV),this._setFilterMode(this._filterMode),this._readyed=!0,this._activeResource();},Q._recoverResource=function(){},d(0,Q,"defaulteTexture",function(){return w.grayTexture;}),w.__init__=function(){var q=new Uint8Array(3);q[0]=128,q[1]=128,q[2]=128,(w.grayTexture=new w(0,!1)).setSixSidePixels(1,1,[q,q,q,q,q,q]),w.grayTexture.lock=!0;},w._parse=function(q,Q,m){var a=m?new w(m[0],m[1]):new w();return a.setSixSideImageSources(q),a;},w.load=function(q,Q){o.loader.create(q,Q,null,"TEXTURECUBE");},w.grayTexture=null,w;}(),Ua=function(Q){function m(q,Q){m.__super.call(this,Q),this._meshFilter=new Xq(this),this._render=new jm(this),q&&(this._meshFilter.sharedMesh=q);}
S(m,"laya.d3.core.MeshSprite3D",Q);var q=m.prototype;return q._parse=function(q,Q){laya.d3.core.Sprite3D.prototype._parse.call(this,q,Q);var m=this.meshRenderer,a=q.lightmapIndex;null!=a&&(m.lightmapIndex=a);var w=q.lightmapScaleOffset;w&&(m.lightmapScaleOffset=new rq(w[0],w[1],w[2],w[3])),null!=q.meshPath&&(this.meshFilter.sharedMesh=uq.getRes(q.meshPath)),null!=q.enableRender&&(this.meshRenderer.enable=q.enableRender);var e=q.materials;if(e){var F=m.sharedMaterials,W=e.length;F.length=W;for(var s=0;s<W;s++)F[s]=uq.getRes(e[s].path);m.sharedMaterials=F;}},q._addToInitStaticBatchManager=function(){nm.instance._addBatchSprite(this);},q._cloneTo=function(q,Q,m){var a=q;a._meshFilter.sharedMesh=this._meshFilter.sharedMesh;var w=this._render,e=a._render;e.enable=w.enable,e.sharedMaterials=w.sharedMaterials,e.castShadow=w.castShadow;var F=w.lightmapScaleOffset;F&&(e.lightmapScaleOffset=F.clone()),e.lightmapIndex=w.lightmapIndex,e.receiveShadow=w.receiveShadow,e.sortingFudge=w.sortingFudge,laya.d3.core.Sprite3D.prototype._cloneTo.call(this,q,Q,m);},q.destroy=function(q){void 0===q&&(q=!0),this.destroyed||(Q.prototype.destroy.call(this,q),this._meshFilter.destroy());},d(0,q,"meshFilter",function(){return this._meshFilter;}),d(0,q,"meshRenderer",function(){return this._render;}),m.__init__=function(){m.SHADERDEFINE_UV0=m.shaderDefines.registerDefine("UV"),m.SHADERDEFINE_COLOR=m.shaderDefines.registerDefine("COLOR"),m.SHADERDEFINE_UV1=m.shaderDefines.registerDefine("UV1"),m.SHADERDEFINE_GPU_INSTANCE=m.shaderDefines.registerDefine("GPU_INSTANCE"),j._registerManager(nm.instance),I._registerManager(Wm.instance);},m.SHADERDEFINE_UV0=0,m.SHADERDEFINE_COLOR=0,m.SHADERDEFINE_UV1=0,m.SHADERDEFINE_GPU_INSTANCE=0,y(m,["shaderDefines",function(){return this.shaderDefines=new dq(Im.shaderDefines);}]),m;}(Im),Ja=function(m){function q(){this._direction=null,this._spotAngle=NaN,this._range=NaN,q.__super.call(this),this._spotAngle=30,this._range=10,this._direction=new _q();}
S(q,"laya.d3.core.light.SpotLight",m);var Q=q.prototype;return Q._onActive=function(){m.prototype._onActive.call(this),this._lightmapBakedType!==Xm.LIGHTMAPBAKEDTYPE_BAKED&&this.scene._defineDatas.add(gm.SHADERDEFINE_SPOTLIGHT);},Q._onInActive=function(){m.prototype._onInActive.call(this),this._lightmapBakedType!==Xm.LIGHTMAPBAKEDTYPE_BAKED&&this.scene._defineDatas.remove(gm.SHADERDEFINE_SPOTLIGHT);},Q._prepareToScene=function(){var q=this._scene;if(q.enableLight&&this.activeInHierarchy){q._defineDatas;var Q=q._shaderValues;return _q.scale(this.color,this._intensity,this._intensityColor),Q.setVector3(gm.SPOTLIGHTCOLOR,this._intensityColor),Q.setVector3(gm.SPOTLIGHTPOS,this.transform.position),this.transform.worldMatrix.getForward(this._direction),_q.normalize(this._direction,this._direction),Q.setVector3(gm.SPOTLIGHTDIRECTION,this._direction),Q.setNumber(gm.SPOTLIGHTRANGE,this.range),Q.setNumber(gm.SPOTLIGHTSPOTANGLE,this.spotAngle*Math.PI/180),!0;}
return!1;},Q._parse=function(q,Q){m.prototype._parse.call(this,q,Q),this.range=q.range,this.spotAngle=q.spotAngle;},d(0,Q,"spotAngle",function(){return this._spotAngle;},function(q){this._spotAngle=Math.max(Math.min(q,180),0);}),d(0,Q,"range",function(){return this._range;},function(q){this._range=q;}),y(q,["_tempMatrix0",function(){return this._tempMatrix0=new kQ();},"_tempMatrix1",function(){return this._tempMatrix1=new kQ();}]),q;}(Xm),Va=function(q){function Q(){this._direction=null,Q.__super.call(this),this._direction=new _q();}
S(Q,"laya.d3.core.light.DirectionLight",q);var m=Q.prototype;return m._initShadow=function(){if(this._shadow)this._parallelSplitShadowMap=new Nq(),this.scene.parallelSplitShadowMaps.push(this._parallelSplitShadowMap),this.transform.worldMatrix.getForward(this._direction),_q.normalize(this._direction,this._direction),this._parallelSplitShadowMap.setInfo(this.scene,this._shadowFarPlane,this._direction,this._shadowMapSize,this._shadowMapCount,this._shadowMapPCFType);else{var q=this._scene._defineDatas,Q=this.scene.parallelSplitShadowMaps;Q.splice(Q.indexOf(this._parallelSplitShadowMap),1),this._parallelSplitShadowMap.disposeAllRenderTarget(),this._parallelSplitShadowMap=null,q.remove(gm.SHADERDEFINE_SHADOW_PSSM1),q.remove(gm.SHADERDEFINE_SHADOW_PSSM2),q.remove(gm.SHADERDEFINE_SHADOW_PSSM3);}},m._onActive=function(){q.prototype._onActive.call(this),this._shadow&&this._initShadow(),this._lightmapBakedType!==Xm.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._defineDatas.add(gm.SHADERDEFINE_DIRECTIONLIGHT);},m._onInActive=function(){q.prototype._onInActive.call(this),this._lightmapBakedType!==Xm.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._defineDatas.remove(gm.SHADERDEFINE_DIRECTIONLIGHT);},m._prepareToScene=function(){var q=this._scene;if(q.enableLight&&this.activeInHierarchy){q._defineDatas;var Q=q._shaderValues;return _q.scale(this.color,this._intensity,this._intensityColor),Q.setVector3(gm.LIGHTDIRCOLOR,this._intensityColor),this.transform.worldMatrix.getForward(this._direction),_q.normalize(this._direction,this._direction),Q.setVector3(gm.LIGHTDIRECTION,this._direction),!0;}
return!1;},d(0,m,"shadow",q.prototype._$get_shadow,function(q){this._shadow!==q&&(this._shadow=q,this.scene&&this._initShadow());}),Q;}(Xm),na=function(Q){function q(){q.__super.call(this,this.name),this._render=new hm(this),this._geometryFilter=new qQ(this);}
S(q,"laya.d3.core.trail.TrailSprite3D",Q);var m=q.prototype;return m._parse=function(q,Q){laya.d3.core.Sprite3D.prototype._parse.call(this,q,Q);var m=this._render,a=this._geometryFilter,w=0,e=0,F=q.materials;if(F){var W=m.sharedMaterials,s=F.length;for(W.length=s,w=0;w<s;w++)W[w]=uq.getRes(F[w].path);m.sharedMaterials=W;}
a.time=q.time,a.minVertexDistance=q.minVertexDistance,a.widthMultiplier=q.widthMultiplier,a.textureMode=q.textureMode,null!=q.alignment&&(a.alignment=q.alignment);var D=[],d=q.widthCurve;for(w=0,e=d.length;w<e;w++){var v=new bm();v.time=d[w].time,v.inTangent=d[w].inTangent,v.outTangent=d[w].outTangent,v.value=d[w].value,D.push(v);}
a.widthCurve=D;var y=q.colorGradient,S=y.colorKeys,t=y.alphaKeys,o=new wq(S.length,t.length);for(o.mode=y.mode,w=0,e=S.length;w<e;w++){var b=S[w];o.addColorRGB(b.time,new tq(b.value[0],b.value[1],b.value[2],1));}
for(w=0,e=t.length;w<e;w++){var U=t[w];o.addColorAlpha(U.time,U.value);}
a.colorGradient=o;},m._onActive=function(){Q.prototype._onActive.call(this),this._transform.position.cloneTo(this._geometryFilter._lastPosition);},m._cloneTo=function(q,Q,m){laya.d3.core.Sprite3D.prototype._cloneTo.call(this,q,Q,m);var a,w=0,e=q,F=e.trailFilter;F.time=this.trailFilter.time,F.minVertexDistance=this.trailFilter.minVertexDistance,F.widthMultiplier=this.trailFilter.widthMultiplier,F.textureMode=this.trailFilter.textureMode;var W=this.trailFilter.widthCurve,s=[];for(w=0,a=W.length;w<a;w++){var D=new bm();W[w].cloneTo(D),s.push(D);}
F.widthCurve=s;var d=new wq(this.trailFilter.colorGradient.maxColorRGBKeysCount,this.trailFilter.colorGradient.maxColorAlphaKeysCount);this.trailFilter.colorGradient.cloneTo(d),F.colorGradient=d,e.trailRenderer.sharedMaterial=this.trailRenderer.sharedMaterial;},m.destroy=function(q){void 0===q&&(q=!0),this.destroyed||(Q.prototype.destroy.call(this,q),this._geometryFilter.destroy(),this._geometryFilter=null);},d(0,m,"trailFilter",function(){return this._geometryFilter;}),d(0,m,"trailRenderer",function(){return this._render;}),q.__init__=function(){q.SHADERDEFINE_GRADIENTMODE_BLEND=q.shaderDefines.registerDefine("GRADIENTMODE_BLEND");},q.SHADERDEFINE_GRADIENTMODE_BLEND=0,y(q,["CURTIME",function(){return this.CURTIME=Bq.propertyNameToID("u_CurTime");},"LIFETIME",function(){return this.LIFETIME=Bq.propertyNameToID("u_LifeTime");},"WIDTHCURVE",function(){return this.WIDTHCURVE=Bq.propertyNameToID("u_WidthCurve");},"WIDTHCURVEKEYLENGTH",function(){return this.WIDTHCURVEKEYLENGTH=Bq.propertyNameToID("u_WidthCurveKeyLength");},"GRADIENTCOLORKEY",function(){return this.GRADIENTCOLORKEY=Bq.propertyNameToID("u_GradientColorkey");},"GRADIENTALPHAKEY",function(){return this.GRADIENTALPHAKEY=Bq.propertyNameToID("u_GradientAlphakey");},"shaderDefines",function(){return this.shaderDefines=new dq(Im.shaderDefines);}]),q;}(Im),Oa=function(Q){function lq(){lq.__super.call(this,null),this._render=new zm(this),this._particleSystem=new Fm(this);var q=this._render._renderElements[0]=new Vq();q.setTransform(this._transform),q.render=this._render,q.setGeometry(this._particleSystem),q.material=Fa.defaultMaterial;}
S(lq,"laya.d3.core.particleShuriKen.ShuriKenParticle3D",Q);var q=lq.prototype;return q._initParticleVelocity=function(q){for(var Q=new zq(),m=q.velocitys,a=0,w=m.length;a<w;a++){var e=m[a];Q.add(e.key,e.value);}
return Q;},q._initParticleColor=function(q){var Q=new wq(4,4),m=q.alphas,a=0,w=0;for(a=0,w=m.length;a<w;a++){var e=m[a];3===a&&1!==e.key&&(e.key=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),Q.addColorAlpha(e.key,e.value);}
var F=q.rgbs;for(a=0,w=F.length;a<w;a++){var W=F[a],s=W.value;3===a&&1!==W.key&&(W.key=1,console.log("GradientDataColor warning:the forth key is  be force set to 1.")),Q.addColorRGB(W.key,new tq(s[0],s[1],s[2],1));}
return Q;},q._initParticleSize=function(q){for(var Q=new zq(),m=q.sizes,a=0,w=m.length;a<w;a++){var e=m[a];Q.add(e.key,e.value);}
return Q;},q._initParticleRotation=function(q){for(var Q=new zq(),m=q.angularVelocitys,a=0,w=m.length;a<w;a++){var e=m[a];Q.add(e.key,e.value/180*Math.PI);}
return Q;},q._initParticleFrame=function(q){for(var Q=new eQ(),m=q.frames,a=0,w=m.length;a<w;a++){var e=m[a];Q.add(e.key,e.value);}
return Q;},q._parse=function(q,Q){laya.d3.core.Sprite3D.prototype._parse.call(this,q,Q);var m,a=Math.PI/180,w=0,e=0,F=this.particleRenderer,W=q.material;W&&(m=uq.getRes(W.path)),F.sharedMaterial=m;var s=q.meshPath;s&&(F.mesh=uq.getRes(s)),F.renderMode=q.renderMode,F.stretchedBillboardCameraSpeedScale=q.stretchedBillboardCameraSpeedScale,F.stretchedBillboardSpeedScale=q.stretchedBillboardSpeedScale,F.stretchedBillboardLengthScale=q.stretchedBillboardLengthScale,F.sortingFudge=q.sortingFudge?q.sortingFudge:0;var D=this.particleSystem;D.isPerformanceMode=q.isPerformanceMode,D.duration=q.duration,D.looping=q.looping,D.prewarm=q.prewarm,D.startDelayType=q.startDelayType,D.startDelay=q.startDelay,D.startDelayMin=q.startDelayMin,D.startDelayMax=q.startDelayMax,D.startLifetimeType=q.startLifetimeType,D.startLifetimeConstant=q.startLifetimeConstant,D.startLifeTimeGradient=lq._initStartLife(q.startLifetimeGradient),D.startLifetimeConstantMin=q.startLifetimeConstantMin,D.startLifetimeConstantMax=q.startLifetimeConstantMax,D.startLifeTimeGradientMin=lq._initStartLife(q.startLifetimeGradientMin),D.startLifeTimeGradientMax=lq._initStartLife(q.startLifetimeGradientMax),D.startSpeedType=q.startSpeedType,D.startSpeedConstant=q.startSpeedConstant,D.startSpeedConstantMin=q.startSpeedConstantMin,D.startSpeedConstantMax=q.startSpeedConstantMax,D.threeDStartSize=q.threeDStartSize,D.startSizeType=q.startSizeType,D.startSizeConstant=q.startSizeConstant;var d=q.startSizeConstantSeparate,v=D.startSizeConstantSeparate;v.x=d[0],v.y=d[1],v.z=d[2],D.startSizeConstantMin=q.startSizeConstantMin,D.startSizeConstantMax=q.startSizeConstantMax;var y=q.startSizeConstantMinSeparate,S=D.startSizeConstantMinSeparate;S.x=y[0],S.y=y[1],S.z=y[2];var t=q.startSizeConstantMaxSeparate,o=D.startSizeConstantMaxSeparate;o.x=t[0],o.y=t[1],o.z=t[2],D.threeDStartRotation=q.threeDStartRotation,D.startRotationType=q.startRotationType,D.startRotationConstant=q.startRotationConstant*a;var b=q.startRotationConstantSeparate,U=D.startRotationConstantSeparate;U.x=b[0]*a,U.y=b[1]*a,U.z=b[2]*a,D.startRotationConstantMin=q.startRotationConstantMin*a,D.startRotationConstantMax=q.startRotationConstantMax*a;var J=q.startRotationConstantMinSeparate,V=D.startRotationConstantMinSeparate;V.x=J[0]*a,V.y=J[1]*a,V.z=J[2]*a;var n=q.startRotationConstantMaxSeparate,O=D.startRotationConstantMaxSeparate;O.x=n[0]*a,O.y=n[1]*a,O.z=n[2]*a,D.randomizeRotationDirection=q.randomizeRotationDirection,D.startColorType=q.startColorType;var C=q.startColorConstant,l=D.startColorConstant;l.x=C[0],l.y=C[1],l.z=C[2],l.w=C[3];var u=q.startColorConstantMin,f=D.startColorConstantMin;f.x=u[0],f.y=u[1],f.z=u[2],f.w=u[3];var p=q.startColorConstantMax,T=D.startColorConstantMax;T.x=p[0],T.y=p[1],T.z=p[2],T.w=p[3],D.gravityModifier=q.gravityModifier,D.simulationSpace=q.simulationSpace,D.scaleMode=q.scaleMode,D.playOnAwake=q.playOnAwake,D.maxParticles=q.maxParticles;var c=q.autoRandomSeed;null!=c&&(D.autoRandomSeed=c);var r=q.randomSeed;null!=r&&(D.randomSeed[0]=r);var _=q.emission,Z=D.emission;if(_){Z.emissionRate=_.emissionRate;var A=_.bursts;if(A)
for(w=0,e=A.length;w<e;w++){var E=A[w];Z.addBurst(new mQ(E.time,E.min,E.max));}
Z.enbale=_.enable;}else Z.enbale=!1;var B=q.shape;if(B){var N;switch(B.shapeType){case 0:var M;N=M=new Tm(),M.radius=B.sphereRadius,M.emitFromShell=B.sphereEmitFromShell,M.randomDirection=B.sphereRandomDirection;break;case 1:var Y;N=Y=new um(),Y.radius=B.hemiSphereRadius,Y.emitFromShell=B.hemiSphereEmitFromShell,Y.randomDirection=B.hemiSphereRandomDirection;break;case 2:var x;N=x=new XQ(),x.angle=B.coneAngle*a,x.radius=B.coneRadius,x.length=B.coneLength,x.emitType=B.coneEmitType,x.randomDirection=B.coneRandomDirection;break;case 3:var L;N=L=new Zm(),L.x=B.boxX,L.y=B.boxY,L.z=B.boxZ,L.randomDirection=B.boxRandomDirection;break;case 7:var G;N=G=new Qm(),G.radius=B.circleRadius,G.arc=B.circleArc*a,G.emitFromEdge=B.circleEmitFromEdge,G.randomDirection=B.circleRandomDirection;break;default:var K;N=K=new Qm(),K.radius=B.circleRadius,K.arc=B.circleArc*a,K.emitFromEdge=B.circleEmitFromEdge,K.randomDirection=B.circleRandomDirection;}
N.enable=B.enable,D.shape=N;}
var k=q.velocityOverLifetime;if(k){var R,z=k.velocity;switch(z.type){case 0:var i=z.constant;R=CQ.createByConstant(new _q(i[0],i[1],i[2]));break;case 1:R=CQ.createByGradient(this._initParticleVelocity(z.gradientX),this._initParticleVelocity(z.gradientY),this._initParticleVelocity(z.gradientZ));break;case 2:var $=z.constantMin,j=z.constantMax;R=CQ.createByRandomTwoConstant(new _q($[0],$[1],$[2]),new _q(j[0],j[1],j[2]));break;case 3:R=CQ.createByRandomTwoGradient(this._initParticleVelocity(z.gradientXMin),this._initParticleVelocity(z.gradientXMax),this._initParticleVelocity(z.gradientYMin),this._initParticleVelocity(z.gradientYMax),this._initParticleVelocity(z.gradientZMin),this._initParticleVelocity(z.gradientZMax));}
var h=new Aq(R);h.space=k.space,h.enbale=k.enable,D.velocityOverLifetime=h;}
var H=q.colorOverLifetime;if(H){var g,I=H.color;switch(I.type){case 0:var P=I.constant;g=Tq.createByConstant(new rq(P[0],P[1],P[2],P[3]));break;case 1:g=Tq.createByGradient(this._initParticleColor(I.gradient));break;case 2:var X=I.constantMin,qq=I.constantMax;g=Tq.createByRandomTwoConstant(new rq(X[0],X[1],X[2],X[3]),new rq(qq[0],qq[1],qq[2],qq[3]));break;case 3:g=Tq.createByRandomTwoGradient(this._initParticleColor(I.gradientMin),this._initParticleColor(I.gradientMax));}
var Qq=new fq(g);Qq.enbale=H.enable,D.colorOverLifetime=Qq;}
var mq=q.sizeOverLifetime;if(mq){var aq,wq=mq.size;switch(wq.type){case 0:aq=wq.separateAxes?JQ.createByGradientSeparate(this._initParticleSize(wq.gradientX),this._initParticleSize(wq.gradientY),this._initParticleSize(wq.gradientZ)):JQ.createByGradient(this._initParticleSize(wq.gradient));break;case 1:if(wq.separateAxes){var eq=wq.constantMinSeparate,Fq=wq.constantMaxSeparate;aq=JQ.createByRandomTwoConstantSeparate(new _q(eq[0],eq[1],eq[2]),new _q(Fq[0],Fq[1],Fq[2]));}else aq=JQ.createByRandomTwoConstant(wq.constantMin,wq.constantMax);break;case 2:aq=wq.separateAxes?JQ.createByRandomTwoGradientSeparate(this._initParticleSize(wq.gradientXMin),this._initParticleSize(wq.gradientYMin),this._initParticleSize(wq.gradientZMin),this._initParticleSize(wq.gradientXMax),this._initParticleSize(wq.gradientYMax),this._initParticleSize(wq.gradientZMax)):JQ.createByRandomTwoGradient(this._initParticleSize(wq.gradientMin),this._initParticleSize(wq.gradientMax));}
var Wq=new cq(aq);Wq.enbale=mq.enable,D.sizeOverLifetime=Wq;}
var sq=q.rotationOverLifetime;if(sq){var Dq,dq=sq.angularVelocity;switch(dq.type){case 0:if(dq.separateAxes){var vq=dq.constantSeparate;Dq=DQ.createByConstantSeparate(new _q(vq[0]*a,vq[1]*a,vq[2]*a));}else Dq=DQ.createByConstant(dq.constant*a);break;case 1:Dq=dq.separateAxes?DQ.createByGradientSeparate(this._initParticleRotation(dq.gradientX),this._initParticleRotation(dq.gradientY),this._initParticleRotation(dq.gradientZ)):DQ.createByGradient(this._initParticleRotation(dq.gradient));break;case 2:if(dq.separateAxes){var yq=dq.constantMinSeparate,Sq=dq.constantMaxSeparate;Dq=DQ.createByRandomTwoConstantSeparate(new _q(yq[0]*a,yq[1]*a,yq[2]*a),new _q(Sq[0]*a,Sq[1]*a,Sq[2]*a));}else Dq=DQ.createByRandomTwoConstant(dq.constantMin*a,dq.constantMax*a);break;case 3:dq.separateAxes||(Dq=DQ.createByRandomTwoGradient(this._initParticleRotation(dq.gradientMin),this._initParticleRotation(dq.gradientMax)));}
var tq=new AQ(Dq);tq.enbale=sq.enable,D.rotationOverLifetime=tq;}
var oq=q.textureSheetAnimation;if(oq){var bq,Uq=oq.frame;switch(Uq.type){case 0:bq=pq.createByConstant(Uq.constant);break;case 1:bq=pq.createByOverTime(this._initParticleFrame(Uq.overTime));break;case 2:bq=pq.createByRandomTwoConstant(Uq.constantMin,Uq.constantMax);break;case 3:bq=pq.createByRandomTwoOverTime(this._initParticleFrame(Uq.overTimeMin),this._initParticleFrame(Uq.overTimeMax));}
var Jq,Vq=oq.startFrame;switch(Vq.type){case 0:Jq=uQ.createByConstant(Vq.constant);break;case 1:Jq=uQ.createByRandomTwoConstant(Vq.constantMin,Vq.constantMax);}
var nq=new Eq(bq,Jq);nq.enable=oq.enable;var Oq=oq.tiles;nq.tiles=new Zq(Oq[0],Oq[1]),nq.type=oq.type,nq.randomRow=oq.randomRow;var Cq=oq.rowIndex;void 0!==Cq&&(nq.rowIndex=Cq),nq.cycles=oq.cycles,D.textureSheetAnimation=nq;}},q._activeHierarchy=function(q){laya.display.Node.prototype._activeHierarchy.call(this,q),this.particleSystem.playOnAwake&&this.particleSystem.play();},q._inActiveHierarchy=function(q){laya.display.Node.prototype._inActiveHierarchy.call(this,q),this.particleSystem.isAlive&&this.particleSystem.simulate(0,!0);},q._cloneTo=function(q,Q,m){var a=q,w=a._particleSystem;this._particleSystem.cloneTo(w);var e=a._render,F=this._render;e.sharedMaterials=F.sharedMaterials,e.enable=F.enable,e.renderMode=F.renderMode,e.mesh=F.mesh,e.stretchedBillboardCameraSpeedScale=F.stretchedBillboardCameraSpeedScale,e.stretchedBillboardSpeedScale=F.stretchedBillboardSpeedScale,e.stretchedBillboardLengthScale=F.stretchedBillboardLengthScale,e.sortingFudge=F.sortingFudge,laya.d3.core.Sprite3D.prototype._cloneTo.call(this,q,Q,m);},q.destroy=function(q){void 0===q&&(q=!0),this.destroyed||(Q.prototype.destroy.call(this,q),this._particleSystem.destroy(),this._particleSystem=null);},d(0,q,"particleSystem",function(){return this._particleSystem;}),d(0,q,"particleRenderer",function(){return this._render;}),lq.__init__=function(){lq.SHADERDEFINE_RENDERMODE_BILLBOARD=lq.shaderDefines.registerDefine("SPHERHBILLBOARD"),lq.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=lq.shaderDefines.registerDefine("STRETCHEDBILLBOARD"),lq.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=lq.shaderDefines.registerDefine("HORIZONTALBILLBOARD"),lq.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=lq.shaderDefines.registerDefine("VERTICALBILLBOARD"),lq.SHADERDEFINE_COLOROVERLIFETIME=lq.shaderDefines.registerDefine("COLOROVERLIFETIME"),lq.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=lq.shaderDefines.registerDefine("RANDOMCOLOROVERLIFETIME"),lq.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=lq.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECONSTANT"),lq.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=lq.shaderDefines.registerDefine("VELOCITYOVERLIFETIMECURVE"),lq.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=lq.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCONSTANT"),lq.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=lq.shaderDefines.registerDefine("VELOCITYOVERLIFETIMERANDOMCURVE"),lq.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=lq.shaderDefines.registerDefine("TEXTURESHEETANIMATIONCURVE"),lq.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=lq.shaderDefines.registerDefine("TEXTURESHEETANIMATIONRANDOMCURVE"),lq.SHADERDEFINE_ROTATIONOVERLIFETIME=lq.shaderDefines.registerDefine("ROTATIONOVERLIFETIME"),lq.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=lq.shaderDefines.registerDefine("ROTATIONOVERLIFETIMESEPERATE"),lq.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=lq.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECONSTANT"),lq.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=lq.shaderDefines.registerDefine("ROTATIONOVERLIFETIMECURVE"),lq.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=lq.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCONSTANTS"),lq.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=lq.shaderDefines.registerDefine("ROTATIONOVERLIFETIMERANDOMCURVES"),lq.SHADERDEFINE_SIZEOVERLIFETIMECURVE=lq.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVE"),lq.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=lq.shaderDefines.registerDefine("SIZEOVERLIFETIMECURVESEPERATE"),lq.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=lq.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVES"),lq.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=lq.shaderDefines.registerDefine("SIZEOVERLIFETIMERANDOMCURVESSEPERATE"),lq.SHADERDEFINE_RENDERMODE_MESH=lq.shaderDefines.registerDefine("RENDERMODE_MESH"),lq.SHADERDEFINE_SHAPE=lq.shaderDefines.registerDefine("SHAPE");},lq._initStartLife=function(q){for(var Q=new zq(),m=q.startLifetimes,a=0,w=m.length;a<w;a++){var e=m[a];Q.add(e.key,e.value);}
return Q;},lq.SHADERDEFINE_RENDERMODE_BILLBOARD=0,lq.SHADERDEFINE_RENDERMODE_STRETCHEDBILLBOARD=0,lq.SHADERDEFINE_RENDERMODE_HORIZONTALBILLBOARD=0,lq.SHADERDEFINE_RENDERMODE_VERTICALBILLBOARD=0,lq.SHADERDEFINE_COLOROVERLIFETIME=0,lq.SHADERDEFINE_RANDOMCOLOROVERLIFETIME=0,lq.SHADERDEFINE_VELOCITYOVERLIFETIMECONSTANT=0,lq.SHADERDEFINE_VELOCITYOVERLIFETIMECURVE=0,lq.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCONSTANT=0,lq.SHADERDEFINE_VELOCITYOVERLIFETIMERANDOMCURVE=0,lq.SHADERDEFINE_TEXTURESHEETANIMATIONCURVE=0,lq.SHADERDEFINE_TEXTURESHEETANIMATIONRANDOMCURVE=0,lq.SHADERDEFINE_ROTATIONOVERLIFETIME=0,lq.SHADERDEFINE_ROTATIONOVERLIFETIMESEPERATE=0,lq.SHADERDEFINE_ROTATIONOVERLIFETIMECONSTANT=0,lq.SHADERDEFINE_ROTATIONOVERLIFETIMECURVE=0,lq.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCONSTANTS=0,lq.SHADERDEFINE_ROTATIONOVERLIFETIMERANDOMCURVES=0,lq.SHADERDEFINE_SIZEOVERLIFETIMECURVE=0,lq.SHADERDEFINE_SIZEOVERLIFETIMECURVESEPERATE=0,lq.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVES=0,lq.SHADERDEFINE_SIZEOVERLIFETIMERANDOMCURVESSEPERATE=0,lq.SHADERDEFINE_RENDERMODE_MESH=0,lq.SHADERDEFINE_SHAPE=0,y(lq,["WORLDPOSITION",function(){return this.WORLDPOSITION=Bq.propertyNameToID("u_WorldPosition");},"WORLDROTATION",function(){return this.WORLDROTATION=Bq.propertyNameToID("u_WorldRotation");},"POSITIONSCALE",function(){return this.POSITIONSCALE=Bq.propertyNameToID("u_PositionScale");},"SIZESCALE",function(){return this.SIZESCALE=Bq.propertyNameToID("u_SizeScale");},"SCALINGMODE",function(){return this.SCALINGMODE=Bq.propertyNameToID("u_ScalingMode");},"GRAVITY",function(){return this.GRAVITY=Bq.propertyNameToID("u_Gravity");},"THREEDSTARTROTATION",function(){return this.THREEDSTARTROTATION=Bq.propertyNameToID("u_ThreeDStartRotation");},"STRETCHEDBILLBOARDLENGTHSCALE",function(){return this.STRETCHEDBILLBOARDLENGTHSCALE=Bq.propertyNameToID("u_StretchedBillboardLengthScale");},"STRETCHEDBILLBOARDSPEEDSCALE",function(){return this.STRETCHEDBILLBOARDSPEEDSCALE=Bq.propertyNameToID("u_StretchedBillboardSpeedScale");},"SIMULATIONSPACE",function(){return this.SIMULATIONSPACE=Bq.propertyNameToID("u_SimulationSpace");},"CURRENTTIME",function(){return this.CURRENTTIME=Bq.propertyNameToID("u_CurrentTime");},"VOLVELOCITYCONST",function(){return this.VOLVELOCITYCONST=Bq.propertyNameToID("u_VOLVelocityConst");},"VOLVELOCITYGRADIENTX",function(){return this.VOLVELOCITYGRADIENTX=Bq.propertyNameToID("u_VOLVelocityGradientX");},"VOLVELOCITYGRADIENTY",function(){return this.VOLVELOCITYGRADIENTY=Bq.propertyNameToID("u_VOLVelocityGradientY");},"VOLVELOCITYGRADIENTZ",function(){return this.VOLVELOCITYGRADIENTZ=Bq.propertyNameToID("u_VOLVelocityGradientZ");},"VOLVELOCITYCONSTMAX",function(){return this.VOLVELOCITYCONSTMAX=Bq.propertyNameToID("u_VOLVelocityConstMax");},"VOLVELOCITYGRADIENTXMAX",function(){return this.VOLVELOCITYGRADIENTXMAX=Bq.propertyNameToID("u_VOLVelocityGradientMaxX");},"VOLVELOCITYGRADIENTYMAX",function(){return this.VOLVELOCITYGRADIENTYMAX=Bq.propertyNameToID("u_VOLVelocityGradientMaxY");},"VOLVELOCITYGRADIENTZMAX",function(){return this.VOLVELOCITYGRADIENTZMAX=Bq.propertyNameToID("u_VOLVelocityGradientMaxZ");},"VOLSPACETYPE",function(){return this.VOLSPACETYPE=Bq.propertyNameToID("u_VOLSpaceType");},"COLOROVERLIFEGRADIENTALPHAS",function(){return this.COLOROVERLIFEGRADIENTALPHAS=Bq.propertyNameToID("u_ColorOverLifeGradientAlphas");},"COLOROVERLIFEGRADIENTCOLORS",function(){return this.COLOROVERLIFEGRADIENTCOLORS=Bq.propertyNameToID("u_ColorOverLifeGradientColors");},"MAXCOLOROVERLIFEGRADIENTALPHAS",function(){return this.MAXCOLOROVERLIFEGRADIENTALPHAS=Bq.propertyNameToID("u_MaxColorOverLifeGradientAlphas");},"MAXCOLOROVERLIFEGRADIENTCOLORS",function(){return this.MAXCOLOROVERLIFEGRADIENTCOLORS=Bq.propertyNameToID("u_MaxColorOverLifeGradientColors");},"SOLSIZEGRADIENT",function(){return this.SOLSIZEGRADIENT=Bq.propertyNameToID("u_SOLSizeGradient");},"SOLSIZEGRADIENTX",function(){return this.SOLSIZEGRADIENTX=Bq.propertyNameToID("u_SOLSizeGradientX");},"SOLSIZEGRADIENTY",function(){return this.SOLSIZEGRADIENTY=Bq.propertyNameToID("u_SOLSizeGradientY");},"SOLSizeGradientZ",function(){return this.SOLSizeGradientZ=Bq.propertyNameToID("u_SOLSizeGradientZ");},"SOLSizeGradientMax",function(){return this.SOLSizeGradientMax=Bq.propertyNameToID("u_SOLSizeGradientMax");},"SOLSIZEGRADIENTXMAX",function(){return this.SOLSIZEGRADIENTXMAX=Bq.propertyNameToID("u_SOLSizeGradientMaxX");},"SOLSIZEGRADIENTYMAX",function(){return this.SOLSIZEGRADIENTYMAX=Bq.propertyNameToID("u_SOLSizeGradientMaxY");},"SOLSizeGradientZMAX",function(){return this.SOLSizeGradientZMAX=Bq.propertyNameToID("u_SOLSizeGradientMaxZ");},"ROLANGULARVELOCITYCONST",function(){return this.ROLANGULARVELOCITYCONST=Bq.propertyNameToID("u_ROLAngularVelocityConst");},"ROLANGULARVELOCITYCONSTSEPRARATE",function(){return this.ROLANGULARVELOCITYCONSTSEPRARATE=Bq.propertyNameToID("u_ROLAngularVelocityConstSeprarate");},"ROLANGULARVELOCITYGRADIENT",function(){return this.ROLANGULARVELOCITYGRADIENT=Bq.propertyNameToID("u_ROLAngularVelocityGradient");},"ROLANGULARVELOCITYGRADIENTX",function(){return this.ROLANGULARVELOCITYGRADIENTX=Bq.propertyNameToID("u_ROLAngularVelocityGradientX");},"ROLANGULARVELOCITYGRADIENTY",function(){return this.ROLANGULARVELOCITYGRADIENTY=Bq.propertyNameToID("u_ROLAngularVelocityGradientY");},"ROLANGULARVELOCITYGRADIENTZ",function(){return this.ROLANGULARVELOCITYGRADIENTZ=Bq.propertyNameToID("u_ROLAngularVelocityGradientZ");},"ROLANGULARVELOCITYCONSTMAX",function(){return this.ROLANGULARVELOCITYCONSTMAX=Bq.propertyNameToID("u_ROLAngularVelocityConstMax");},"ROLANGULARVELOCITYCONSTMAXSEPRARATE",function(){return this.ROLANGULARVELOCITYCONSTMAXSEPRARATE=Bq.propertyNameToID("u_ROLAngularVelocityConstMaxSeprarate");},"ROLANGULARVELOCITYGRADIENTMAX",function(){return this.ROLANGULARVELOCITYGRADIENTMAX=Bq.propertyNameToID("u_ROLAngularVelocityGradientMax");},"ROLANGULARVELOCITYGRADIENTXMAX",function(){return this.ROLANGULARVELOCITYGRADIENTXMAX=Bq.propertyNameToID("u_ROLAngularVelocityGradientMaxX");},"ROLANGULARVELOCITYGRADIENTYMAX",function(){return this.ROLANGULARVELOCITYGRADIENTYMAX=Bq.propertyNameToID("u_ROLAngularVelocityGradientMaxY");},"ROLANGULARVELOCITYGRADIENTZMAX",function(){return this.ROLANGULARVELOCITYGRADIENTZMAX=Bq.propertyNameToID("u_ROLAngularVelocityGradientMaxZ");},"ROLANGULARVELOCITYGRADIENTWMAX",function(){return this.ROLANGULARVELOCITYGRADIENTWMAX=Bq.propertyNameToID("u_ROLAngularVelocityGradientMaxW");},"TEXTURESHEETANIMATIONCYCLES",function(){return this.TEXTURESHEETANIMATIONCYCLES=Bq.propertyNameToID("u_TSACycles");},"TEXTURESHEETANIMATIONSUBUVLENGTH",function(){return this.TEXTURESHEETANIMATIONSUBUVLENGTH=Bq.propertyNameToID("u_TSASubUVLength");},"TEXTURESHEETANIMATIONGRADIENTUVS",function(){return this.TEXTURESHEETANIMATIONGRADIENTUVS=Bq.propertyNameToID("u_TSAGradientUVs");},"TEXTURESHEETANIMATIONGRADIENTMAXUVS",function(){return this.TEXTURESHEETANIMATIONGRADIENTMAXUVS=Bq.propertyNameToID("u_TSAMaxGradientUVs");},"shaderDefines",function(){return this.shaderDefines=new dq(Im.shaderDefines);}]),lq;}(Im),Ca=function(q){function m(q,Q){this._geometryFilter=null,void 0===q&&(q=2),m.__super.call(this,Q),this._geometryFilter=new tm(this,q),this._render=new Hm(this),this._changeRenderObjects(this._render,0,aa.defaultMaterial);}
S(m,"laya.d3.core.pixelLine.PixelLineSprite3D",Im);var Q=m.prototype;return Q._changeRenderObjects=function(q,Q,m){var a=this._render._renderElements;m||(m=aa.defaultMaterial);var w=a[Q];w||(w=a[Q]=new Vq()),w.setTransform(this._transform),w.setGeometry(this._geometryFilter),w.render=this._render,w.material=m;},Q.addLine=function(q,Q,m,a){if(this._geometryFilter._lineCount===this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount has equal with maxLineCount.";this._geometryFilter._updateLineData(this._geometryFilter._lineCount++,q,Q,m,a);},Q.addLines=function(q){var Q=this._geometryFilter._lineCount,m=q.length;if(Q+m>this._geometryFilter._maxLineCount)throw"PixelLineSprite3D: lineCount plus lines count must less than maxLineCount.";this._geometryFilter._updateLineDatas(Q,q),this._geometryFilter._lineCount+=m;},Q.removeLine=function(q){if(!(q<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._removeLineData(q);},Q.setLine=function(q,Q,m,a,w){if(!(q<this._geometryFilter._lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._updateLineData(q,Q,m,a,w);},Q.getLine=function(q,Q){if(!(q<this.lineCount))throw"PixelLineSprite3D: index must less than lineCount.";this._geometryFilter._getLineData(q,Q);},Q.clear=function(){this._geometryFilter._lineCount=0;},d(0,Q,"maxLineCount",function(){return this._geometryFilter._maxLineCount;},function(q){this._geometryFilter._resizeLineData(q),this._geometryFilter._lineCount=Math.min(this._geometryFilter._lineCount,q);}),d(0,Q,"pixelLineRenderer",function(){return this._render;}),d(0,Q,"lineCount",function(){return this._geometryFilter._lineCount;},function(q){if(q>this.maxLineCount)throw"PixelLineSprite3D: lineCount can't large than maxLineCount";this._geometryFilter._lineCount=q;}),m;}(),la=function(Q){function t(q,Q){t.__super.call(this,Q),this._meshFilter=new Xq(this),this._render=new ta(this),q&&(this._meshFilter.sharedMesh=q);}
S(t,"laya.d3.core.SkinnedMeshSprite3D",Q);var q=t.prototype;return q._parse=function(q,Q){laya.d3.core.Sprite3D.prototype._parse.call(this,q,Q);var m=this.skinnedMeshRenderer,a=q.lightmapIndex;null!=a&&(m.lightmapIndex=a);var w,e=q.lightmapScaleOffset;if(e&&(m.lightmapScaleOffset=new rq(e[0],e[1],e[2],e[3])),w=q.meshPath){var F=uq.getRes(w);F&&(this.meshFilter.sharedMesh=F);}
var W=q.materials;if(W){var s=m.sharedMaterials,D=W.length;s.length=D;for(var d=0;d<D;d++)s[d]=uq.getRes(W[d].path);m.sharedMaterials=s;}
var v=q.boundBox,y=v.min,S=v.max;if(m.localBounds.setMin(new _q(y[0],y[1],y[2])),m.localBounds.setMax(new _q(S[0],S[1],S[2])),Q){var t=q.rootBone;m.rootBone=Q[t];var o,b=q.bones;for(d=0,o=b.length;d<o;d++)m.bones.push(Q[b[d]]);}else q.rootBone&&m._setRootBone(q.rootBone);},q._changeHierarchyAnimator=function(q){Q.prototype._changeHierarchyAnimator.call(this,q),this.skinnedMeshRenderer._setCacheAnimator(q);},q._changeAnimatorAvatar=function(q){this.skinnedMeshRenderer._setCacheAvatar(q);},q._cloneTo=function(q,Q,m){var a=q;a.meshFilter.sharedMesh=this.meshFilter.sharedMesh;var w=this._render,e=a._render;e.enable=w.enable,e.sharedMaterials=w.sharedMaterials,e.castShadow=w.castShadow;var F=w.lightmapScaleOffset;F&&(e.lightmapScaleOffset=F.clone()),e.receiveShadow=w.receiveShadow,e.sortingFudge=w.sortingFudge,e._rootBone=w._rootBone;var W=w.bones,s=e.bones,D=W.length;s.length=D;var d=w.rootBone;if(d){var v=Rq._getHierarchyPath(Q,d,t._tempArray0);e.rootBone=v?Rq._getNodeByHierarchyPath(m,v):d;}
for(var y=0;y<W.length;y++)v=Rq._getHierarchyPath(Q,W[y],t._tempArray0),s[y]=v?Rq._getNodeByHierarchyPath(m,v):W[y];var S=w.localBounds;S&&S.cloneTo(e.localBounds),laya.d3.core.Sprite3D.prototype._cloneTo.call(this,q,Q,m);},q.destroy=function(q){void 0===q&&(q=!0),this.destroyed||(Q.prototype.destroy.call(this,q),this._meshFilter.destroy());},d(0,q,"meshFilter",function(){return this._meshFilter;}),d(0,q,"skinnedMeshRenderer",function(){return this._render;}),t.__init__=function(){t.SHADERDEFINE_BONE=t.shaderDefines.registerDefine("BONE");},t._tempArray0=[],t.SHADERDEFINE_BONE=0,y(t,["BONES",function(){return this.BONES=Bq.propertyNameToID("u_Bones");},"shaderDefines",function(){return this.shaderDefines=new dq(Ua.shaderDefines);}]),t;}(Im),ua=function(m){function e(){this._range=NaN,this._lightMatrix=new kQ(),e.__super.call(this),this._range=6;}
S(e,"laya.d3.core.light.PointLight",m);var q=e.prototype;return q._onActive=function(){m.prototype._onActive.call(this),this._lightmapBakedType!==Xm.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._defineDatas.add(gm.SHADERDEFINE_POINTLIGHT);},q._onInActive=function(){m.prototype._onInActive.call(this),this._lightmapBakedType!==Xm.LIGHTMAPBAKEDTYPE_BAKED&&this._scene._defineDatas.remove(gm.SHADERDEFINE_POINTLIGHT);},q._prepareToScene=function(){var q=this._scene;if(q.enableLight&&this.activeInHierarchy){q._defineDatas;var Q=q._shaderValues;_q.scale(this.color,this._intensity,this._intensityColor),Q.setVector3(gm.POINTLIGHTCOLOR,this._intensityColor),Q.setVector3(gm.POINTLIGHTPOS,this.transform.position),Q.setNumber(gm.POINTLIGHTRANGE,this.range);var m=this._lightMatrix,a=m.elements;m.identity(),a[0]=a[5]=a[10]=1/this._range;var w=e._tempMatrix0;return this.transform.worldMatrix.invert(w),kQ.multiply(m,w,m),Q.setMatrix4x4(gm.POINTLIGHTMATRIX,m),!0;}
return!1;},q._parse=function(q,Q){m.prototype._parse.call(this,q,Q),this.range=q.range;},d(0,q,"range",function(){return this._range;},function(q){this._range=q;}),y(e,["_tempMatrix0",function(){return this._tempMatrix0=new kQ();}]),e;}(Xm),fa=function(Q){function s(q,Q,m,a,w,e,F,W){this._terrainFilter=null,s.__super.call(this,W),this._terrainFilter=new fm(this,q,Q,m,a,w,e,F),this._render=new $m(this);}
S(s,"laya.d3.terrain.TerrainChunk",Q);var q=s.prototype;return q.buildRenderElementAndMaterial=function(q,Q,m,a,w,e,F,W,s,D,d,v,y,S,t,o,b,U){void 0===d&&(d=1),void 0===v&&(v=1),void 0===y&&(y=1),void 0===S&&(S=1),void 0===t&&(t=1),void 0===o&&(o=1),void 0===b&&(b=1),void 0===U&&(U=1);var J=new va();s&&(J.diffuseColor=s),W&&(J.ambientColor=W),D&&(J.specularColor=D),J.splatAlphaTexture=uq.getRes(m),J.normalTexture=Q?uq.getRes(Q):null,J.diffuseTexture1=a?uq.getRes(a):null,J.diffuseTexture2=w?uq.getRes(w):null,J.diffuseTexture3=e?uq.getRes(e):null,J.diffuseTexture4=F?uq.getRes(F):null,J.setDiffuseScale1(d,v),J.setDiffuseScale2(y,S),J.setDiffuseScale3(t,o),J.setDiffuseScale4(b,U),J.setDetailNum(q),0!=this._render._renderElements.length&&(J.renderMode=2);var V=new Vq();V.setTransform(this._transform),V.render=this._render,V.setGeometry(this._terrainFilter),this._render._renderElements.push(V),this._render.sharedMaterial=J;},q._cloneTo=function(q,Q,m){console.log("Terrain Chunk can't clone");},q.destroy=function(q){void 0===q&&(q=!0),this.destroyed||(Q.prototype.destroy.call(this,q),this._terrainFilter.destroy(),this._terrainFilter=null);},d(0,q,"terrainFilter",function(){return this._terrainFilter;}),d(0,q,"terrainRender",function(){return this._render;}),s;}(Im),pa=function(a){function w(q,Q,m){this._updateViewMatrix=!0,this._offScreenRenderTexture=null,this._alwaysUseRenderTexture=!1,this._renderTexture=null,this._postProcess=null,this.enableRender=!0,this._screenShaderData=new Fq(),this._postProcessCommandBuffers=[],void 0===q&&(q=0),void 0===Q&&(Q=.3),void 0===m&&(m=1e3),this._viewMatrix=new kQ(),this._projectionMatrix=new kQ(),this._projectionViewMatrix=new kQ(),this._projectionViewMatrixNoTranslateScale=new kQ(),this._viewport=new TQ(0,0,0,0),this._normalizedViewport=new TQ(0,0,1,1),this._aspectRatio=q,this._boundFrustum=new EQ(kQ.DEFAULT),M.supportWebGLPlusCulling&&(this._boundFrustumBuffer=new Float32Array(24)),w.__super.call(this,Q,m),this.transform.on("transformchanged",this,this._onTransformChanged);}
S(w,"laya.d3.core.Camera",a);var q=w.prototype;return q._isLayerVisible=function(q){return 0!=(Math.pow(2,q)&this.cullingMask);},q._onTransformChanged=function(q){(q&=64)&&(this._updateViewMatrix=!0);},q._calculationViewport=function(q,Q,m){var a=q.x*Q,w=q.y*m,e=a+Math.max(q.width*Q,0),F=w+Math.max(q.height*m,0),W=Math.ceil(a),s=Math.ceil(w),D=Math.floor(e),d=Math.floor(F),v=.5<=W-a?Math.floor(a):W,y=.5<=s-w?Math.floor(w):s,S=.5<=e-D?Math.ceil(e):D,t=.5<=F-d?Math.ceil(F):d;this._viewport.x=v,this._viewport.y=y,this._viewport.width=S-v,this._viewport.height=t-y;},q._parse=function(q,Q){a.prototype._parse.call(this,q,Q);var m=q.viewport;this.normalizedViewport=new TQ(m[0],m[1],m[2],m[3]);},q._calculateProjectionMatrix=function(){if(!this._useUserProjectionMatrix)
if(this._orthographic){var q=this.orthographicVerticalSize*this.aspectRatio*.5,Q=.5*this.orthographicVerticalSize;kQ.createOrthoOffCenter(-q,q,-Q,Q,this.nearPlane,this.farPlane,this._projectionMatrix);}else kQ.createPerspective(3.1416*this.fieldOfView/180,this.aspectRatio,this.nearPlane,this.farPlane,this._projectionMatrix);},q._getCanvasHeight=function(){return this._offScreenRenderTexture?this._offScreenRenderTexture.height:H.clientHeight;},q._applyPostProcessCommandBuffers=function(){for(var q=0,Q=this._postProcessCommandBuffers.length;q<Q;q++)this._postProcessCommandBuffers[q]._apply();},q._needForceSetRenderTexture=function(){return this._alwaysUseRenderTexture&&!this._offScreenRenderTexture;},q.render=function(q,Q){if(this._scene){var m=this._needForceSetRenderTexture();m&&(this._renderTexture=oa.getTemporary(H.clientWidth,H.clientHeight,0,0,1));var a,w,e=J.instance,F=H._instance,W=F.scene=this._scene;if(W.parallelSplitShadowMaps[0]){Fq.setRuntimeValueMode(!1);var s=W.parallelSplitShadowMaps[0];s._calcAllLightCameraInfo(this),W._defineDatas.add(gm.SHADERDEFINE_CAST_SHADOW);for(var D=0,d=s.shadowMapCount;D<d;D++){var v=s.cameras[D];F.camera=v,F.projectionViewMatrix=v.projectionViewMatrix,NQ.renderObjectCulling(v,W,F,W._castShadowRenders);var y=s.cameras[D+1].renderTarget;y._start(),F.camera=v,F.viewport=v.viewport,v._prepareCameraToRender(),v._prepareCameraViewProject(v.viewMatrix,v.projectionMatrix,F.projectionViewMatrix,v._projectionViewMatrixNoTranslateScale),W._clear(e,F),W._opaqueQueue._render(F,!1),y._end();}
W._defineDatas.remove(gm.SHADERDEFINE_CAST_SHADOW),Fq.setRuntimeValueMode(!0);}
F.camera=this,W._preRenderScript(),a=F.viewMatrix=this.viewMatrix;var S=this._renderTexture;if(F.projectionViewMatrix=S?(S._start(),kQ.multiply(wa._invertYScaleMatrix,this._projectionMatrix,wa._invertYProjectionMatrix),kQ.multiply(wa._invertYScaleMatrix,this.projectionViewMatrix,wa._invertYProjectionViewMatrix),w=F.projectionMatrix=wa._invertYProjectionMatrix,wa._invertYProjectionViewMatrix):(w=F.projectionMatrix=this._projectionMatrix,this.projectionViewMatrix),F.viewport=this.viewport,this._prepareCameraToRender(),this._prepareCameraViewProject(a,w,F.projectionViewMatrix,this._projectionViewMatrixNoTranslateScale),W._preCulling(F,this),W._clear(e,F),W._renderScene(e,F,q,Q),W._postRenderScript(),S&&S._end(),this._postProcess&&this._postProcess._render(),m){var t=mm.create(this._renderTexture,null,sQ.screenShader,this._screenShaderData);t.run(),t.recover(),oa.setReleaseTemporary(this._renderTexture);}}},q.viewportPointToRay=function(q,Q){vQ.calculateCursorRay(q,this.viewport,this._projectionMatrix,this.viewMatrix,null,Q);},q.normalizedViewportPointToRay=function(q,Q){var m=w._tempVector20,a=this.viewport;m.x=q.x*a.width,m.y=q.y*a.height,vQ.calculateCursorRay(m,this.viewport,this._projectionMatrix,this.viewMatrix,null,Q);},q.worldToViewportPoint=function(q,Q){kQ.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.viewport.project(q,this._projectionViewMatrix,Q),Q.x=Q.x/o.stage.clientScaleX,Q.y=Q.y/o.stage.clientScaleY;},q.worldToNormalizedViewportPoint=function(q,Q){kQ.multiply(this._projectionMatrix,this._viewMatrix,this._projectionViewMatrix),this.normalizedViewport.project(q,this._projectionViewMatrix,Q),Q.x=Q.x/o.stage.clientScaleX,Q.y=Q.y/o.stage.clientScaleY;},q.convertScreenCoordToOrthographicCoord=function(q,Q){if(this._orthographic){var m=H.clientWidth,a=H.clientHeight,w=this.orthographicVerticalSize*this.aspectRatio/m,e=this.orthographicVerticalSize/a;return Q.x=(-m/2+q.x)*w,Q.y=(a/2-q.y)*e,Q.z=(this.nearPlane-this.farPlane)*(q.z+1)/2-this.nearPlane,_q.transformCoordinate(Q,this.transform.worldMatrix,Q),!0;}
return!1;},q.destroy=function(q){void 0===q&&(q=!0),this._offScreenRenderTexture=null,this.transform.off("transformchanged",this,this._onTransformChanged),a.prototype.destroy.call(this,q);},q.addCommandBuffer=function(q,Q){switch(q){case 0:this._postProcessCommandBuffers.push(Q);break;default:throw"Camera:unknown event.";}},q.removeCommandBuffer=function(q,Q){switch(q){case 0:var m=this._postProcessCommandBuffers.indexOf(Q);-
1!==m&&this._postProcessCommandBuffers.splice(m,1);break;default:throw"Camera:unknown event.";}},q.removeCommandBuffers=function(q){switch(q){case 0:this._postProcessCommandBuffers.length=0;break;default:throw"Camera:unknown event.";}},q.getRenderTexture=function(){return this._renderTexture;},d(0,q,"renderTarget",function(){return this._offScreenRenderTexture;},function(q){this._offScreenRenderTexture!==q&&(this._offScreenRenderTexture=q,this._renderTexture=q,this._calculateProjectionMatrix());}),d(0,q,"projectionViewMatrix",function(){return kQ.multiply(this.projectionMatrix,this.viewMatrix,this._projectionViewMatrix),this._projectionViewMatrix;}),d(0,q,"aspectRatio",function(){if(0!==this._aspectRatio)return this._aspectRatio;var q=this.viewport;return q.width/q.height;},function(q){if(q<0)throw new Error("Camera: the aspect ratio has to be a positive real number.");this._aspectRatio=q,this._calculateProjectionMatrix();}),d(0,q,"boundFrustum",function(){if(this._boundFrustum.matrix=this.projectionViewMatrix,M.supportWebGLPlusCulling){var q=this._boundFrustum.near,Q=this._boundFrustum.far,m=this._boundFrustum.left,a=this._boundFrustum.right,w=this._boundFrustum.top,e=this._boundFrustum.bottom,F=q.normal,W=Q.normal,s=m.normal,D=a.normal,d=w.normal,v=e.normal,y=this._boundFrustumBuffer;y[0]=F.x,y[1]=F.y,y[2]=F.z,y[3]=q.distance,y[4]=W.x,y[5]=W.y,y[6]=W.z,y[7]=Q.distance,y[8]=s.x,y[9]=s.y,y[10]=s.z,y[11]=m.distance,y[12]=D.x,y[13]=D.y,y[14]=D.z,y[15]=a.distance,y[16]=d.x,y[17]=d.y,y[18]=d.z,y[19]=w.distance,y[20]=v.x,y[21]=v.y,y[22]=v.z,y[23]=e.distance;}
return this._boundFrustum;}),d(0,q,"viewport",function(){return this._offScreenRenderTexture?this._calculationViewport(this._normalizedViewport,this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):this._calculationViewport(this._normalizedViewport,H.clientWidth,H.clientHeight),this._viewport;},function(q){var Q=0,m=0;m=this._offScreenRenderTexture?(Q=this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):(Q=H.clientWidth,H.clientHeight),this._normalizedViewport.x=q.x/Q,this._normalizedViewport.y=q.y/m,this._normalizedViewport.width=q.width/Q,this._normalizedViewport.height=q.height/m,this._calculationViewport(this._normalizedViewport,Q,m),this._calculateProjectionMatrix();}),d(0,q,"alwaysUseRenderTexture",function(){return this._alwaysUseRenderTexture;},function(q){this._alwaysUseRenderTexture=q;}),d(0,q,"normalizedViewport",function(){return this._normalizedViewport;},function(q){var Q=0,m=0;m=this._offScreenRenderTexture?(Q=this._offScreenRenderTexture.width,this._offScreenRenderTexture.height):(Q=H.clientWidth,H.clientHeight),this._normalizedViewport!==q&&q.cloneTo(this._normalizedViewport),this._calculationViewport(q,Q,m),this._calculateProjectionMatrix();}),d(0,q,"projectionMatrix",function(){return this._projectionMatrix;},function(q){this._projectionMatrix=q,this._useUserProjectionMatrix=!0;}),d(0,q,"viewMatrix",function(){if(this._updateViewMatrix){var q=this.transform.scale,Q=q.x,m=q.y,a=q.z,w=this._viewMatrix.elements;this.transform.worldMatrix.cloneTo(this._viewMatrix),w[0]/=Q,w[1]/=Q,w[2]/=Q,w[4]/=m,w[5]/=m,w[6]/=m,w[8]/=a,w[9]/=a,w[10]/=a,this._viewMatrix.invert(this._viewMatrix),this._updateViewMatrix=!1;}
return this._viewMatrix;}),d(0,q,"postProcess",function(){return this._postProcess;},function(q){this._postProcess=q,this.alwaysUseRenderTexture=!0;var Q=new sQ();this.addCommandBuffer(0,Q),q._init(this,Q);}),w.CAMERAEVENT_POSTPROCESS=0,w._updateMark=0,y(w,["_tempVector20",function(){return this._tempVector20=new Zq();}]),w;}(wa);!function(q){function V(q,Q,m){this._minX=NaN,this._minZ=NaN,this._cellSize=null,this._heightMap=null,V.__super.call(this,q,m),this._heightMap=Q,this._cellSize=new Zq();}
S(V,"laya.d3.core.MeshTerrainSprite3D",Ua);var Q=V.prototype;Q._disableRotation=function(){var q=this.transform.rotation;q.x=0,q.y=0,q.z=0,q.w=1,this.transform.rotation=q;},Q._getScaleX=function(){var q=this.transform.worldMatrix.elements,Q=q[0],m=q[1],a=q[2];return Math.sqrt(Q*Q+m*m+a*a);},Q._getScaleZ=function(){var q=this.transform.worldMatrix.elements,Q=q[8],m=q[9],a=q[10];return Math.sqrt(Q*Q+m*m+a*a);},Q._initCreateFromMesh=function(q,Q){this._heightMap=Kq.creatFromMesh(this.meshFilter.sharedMesh,q,Q,this._cellSize);var m=this.meshFilter.sharedMesh.bounds,a=m.getMin();m.getMax();this._minX=a.x,this._minZ=a.z;},Q._initCreateFromMeshHeightMap=function(q,Q,m){var a=this.meshFilter.sharedMesh.bounds;this._heightMap=Kq.createFromImage(q,Q,m),this._computeCellSize(a);var w=a.getMin();a.getMax();this._minX=w.x,this._minZ=w.z;},Q._computeCellSize=function(q){var Q=q.getMin(),m=q.getMax(),a=Q.x,w=Q.z,e=m.x-a,F=m.z-w;this._cellSize.x=e/(this._heightMap.width-1),this._cellSize.y=F/(this._heightMap.height-1);},Q._update=function(q){this._disableRotation();},Q.getHeight=function(q,Q){V._tempVector3.x=q,V._tempVector3.y=0,V._tempVector3.z=Q,this._disableRotation();var m=this.transform.worldMatrix;m.invert(V._tempMatrix4x4),_q.transformCoordinate(V._tempVector3,V._tempMatrix4x4,V._tempVector3),q=V._tempVector3.x,Q=V._tempVector3.z;var a=(q-this._minX)/this._cellSize.x,w=(Q-this._minZ)/this._cellSize.y,e=Math.floor(w),F=Math.floor(a),W=a-F,s=w-e,D=m.elements,d=D[4],v=D[5],y=D[6],S=Math.sqrt(d*d+v*v+y*y),t=D[13],o=this._heightMap.getHeight(e,F+1),b=this._heightMap.getHeight(e+1,F);if(isNaN(o)||isNaN(b))return NaN;if(W+s<=1){var U=this._heightMap.getHeight(e,F);return isNaN(U)?NaN:(U+W*(o-U)+s*(b-U))*S+t;}
var J=this._heightMap.getHeight(e+1,F+1);return isNaN(J)?NaN:(J+(1-W)*(b-J)+(1-s)*(o-J))*S+t;},d(0,Q,"minX",function(){var q=this.transform.worldMatrix.elements;return this._minX*this._getScaleX()+q[12];}),d(0,Q,"width",function(){return(this._heightMap.width-1)*this._cellSize.x*this._getScaleX();}),d(0,Q,"minZ",function(){var q=this.transform.worldMatrix.elements;return this._minZ*this._getScaleZ()+q[14];}),d(0,Q,"depth",function(){return(this._heightMap.height-1)*this._cellSize.y*this._getScaleZ();}),V.createFromMesh=function(q,Q,m,a){var w=new V(q,null,a);return w._initCreateFromMesh(Q,m),w;},V.createFromMeshAndHeightMap=function(q,Q,m,a,w){var e=new V(q,null,w);return e._initCreateFromMeshHeightMap(Q,m,a),e;},y(V,["_tempVector3",function(){return this._tempVector3=new _q();},"_tempMatrix4x4",function(){return this._tempMatrix4x4=new kQ();}]);}();}(window,document,Laya);